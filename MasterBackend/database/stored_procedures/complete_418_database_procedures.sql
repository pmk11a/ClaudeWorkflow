-- =====================================================
-- EXISTING STORED PROCEDURES FROM DATABASE
-- Extracted from: dbdapenka2
-- Date: 2025-08-21 11:40:23
-- Total Procedures: 416
-- =====================================================

-- =====================================================
-- KEY PROCEDURES (Most Important)
-- =====================================================

-- Procedure: Sp_Barang
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_Barang]
@Choice char, 
@KodeBrg varchar(25),
@Namabrg varchar(100)='',
@KodeGrp varchar(20)='',
@KodeSubGrp varchar(15)='',
@KodeSupp varchar(20)='',
@Sat1 varchar(5)='',
@Isi1 numeric(18,2)=0,
@Sat2 varchar(5)='',
@Isi2 numeric(18,2)=0,
@Sat3 varchar(5)='',
@Isi3 numeric(18,2)=0,
@Hrg1_1 numeric(18,2)=0,
@Hrg2_1 numeric(18,2)=0,
@Hrg3_1 numeric(18,2)=0,
@Hrg1_2 numeric(18,2)=0,
@Hrg2_2 numeric(18,2)=0,
@Hrg3_2 numeric(18,2)=0,
@Hrg1_3 numeric(18,2)=0,
@Hrg2_3 numeric(18,2)=0,
@Hrg3_3 numeric(18,2)=0,
@QntMin numeric(18,2)=0,
@QntMax numeric(18,2)=0,
@Keterangan varchar(50)='',
@IsAktif tinyint=0,
@NFix Bit=False,
@NamaBrg2 Varchar(100)='',
@tolerate numeric(5, 2) =0,
@Proses int = 0,
@IstakeIn BIt = 0,
@IsBarang tinyint=0,
@IsJasa Bit=0,
@KodeMerk Varchar(15)=NUll,
@KodeHDGrp Varchar(15)='' 

AS
begin tran
Declare @TglInput DateTime
set @TglInput=getdate()
Select @Tglinput
if @Choice='I'
begin
    insert into dbBarang(kodebrg, namabrg, kodegrp,kodeSubgrp, kodesupp, sat1, ISi1, sat2, isi2, sat3, isi3, IsAKtif,
		Hrg1_1, Hrg2_1, Hrg3_1, Hrg1_2, Hrg2_2, Hrg3_2, Hrg1_3, Hrg2_3, Hrg3_3, QntMin, QntMax, Keterangan,NFix,NamaBrg2,tolerate, Proses,IsTakeIn,
		IsBarang,IsJasa,KodeMerk,KodeHdGrp)
    values(@kodebrg, @namabrg, @kodegrp,@kodeSubgrp, @KodeSupp, @sat1, @ISi1, @Sat2, @Isi2, @Sat3, @Isi3, @IsAKtif,
		@Hrg1_1, @Hrg2_1, @Hrg3_1, @Hrg1_2, @Hrg2_2, @Hrg3_2, @Hrg1_3, @Hrg2_3, @Hrg3_3, @QntMin, @QntMax, @Keterangan,@NFix,@NamaBrg2,@tolerate, @Proses,@IstakeIn,
		@IsBarang,@IsJasa,@KodeMerk,@KodeHDGrp)
    if @@error <> 0 goto jikasalah 	 
end
if @Choice='U'
begin
    update dbBarang
    set namabrg=@Namabrg,KodeSubGrp=@KodeSubGrp,kodegrp=@Kodegrp, KodeSupp=@KodeSupp, 
	sat1=@Sat1, ISi1=@Isi1, Sat2=@Sat2, Isi2=@Isi2, Sat3=@Sat3, Isi3=@Isi3, IsAKtif=@isaktif,
	Hrg1_1=@Hrg1_1, Hrg2_1=@Hrg2_1, Hrg3_1=@Hrg3_1, Hrg1_2=@Hrg1_2, Hrg2_2=@Hrg2_2, Hrg3_2=@Hrg3_2, 
	Hrg1_3=@Hrg1_3, Hrg2_3=@Hrg2_3, Hrg3_3=@Hrg3_3, QntMin=@QntMin, QntMax=@QntMax, Keterangan=@Keterangan,NFix=@NFix,NamaBrg2=@NamaBrg2,tolerate=@tolerate, Proses = @Proses
	,IsTakeIn=@IstakeIn,KodeMerk=@KodeMerk,KodeHdGrp=@KodeHDGrp
    where KodeBrg=@KodeBrg
    if @@error <> 0 goto jikasalah
 
end
if @Choice='D'
begin
    Delete dbBarang where KodeBrg=@KodeBrg
    if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
        return






GO

-- Procedure: SP_CUSTSUPP
-- =====================================================

CREATE PROCEDURE [dbo].[SP_CUSTSUPP]
@Mode Char(1), 
@KodeCustSupp varchar(15)='',
@NamaCustSupp varchar(100)='',
@Usaha varchar(5)='',
@Alamat1 varchar(100)='',
@Alamat2 varchar(100)='',
@KodeKota varchar(100)='',
@KodePos varchar(7)='',
@Negara varchar(30)='',
@Telpon varchar(30)='',
@Fax varchar(30)='',
@Email varchar(40)='',
@NPWP varchar(30)='',
@Tanggal datetime=null,
@Plafon numeric(18,2)=0,
@Hari int=0,
@Berikat bit=0,
@OldKode varchar(15)='',
@Jenis tinyint=0,
@NamaPKP varchar(40)='',
@AlamatPkp1 varchar(100)='',
@AlamatPkp2 varchar(100)='',
@KotaPKP varchar(30)='',
@Sales varchar(20)='',
@KodeVls varchar(15),
@Perkiraan varchar(15),
@KodeTipe varchar(20),
@IsPpn bit=0,
@Kind Int,
@HariHutPiut Int,
@IsAktif tinyint,
@HargaKe tinyint=0

AS
begin tran
if @mode='I'
begin

  	insert into dbCustSupp(KodeCustSupp, NamaCustSupp, Usaha, Alamat1, Alamat2, Kota, KodePos, Negara,
            		Telpon, Fax, Email, NPWP, Tanggal, Plafon, Hari, Berikat, Jenis,
                         	NamaPKP, AlamatPkp1, Alamatpkp2, KotaPkp, Sales,Kodevls,Perkiraan, KodeTipe,isPpn,Kind,HariHutPiut,
                         	IsAktif, HargaKe)
  	values(@KodeCustSupp, @NamaCustSupp, @Usaha, @Alamat1, @Alamat2, @KodeKota, @KodePos, @Negara, 
		@Telpon, @Fax, @Email, @NPWP, @Tanggal, @Plafon, @Hari, @Berikat, @Jenis,
         		@NamaPKP, @AlamatPkp1, @Alamatpkp2, @KotaPkp, @Sales,@kodevls,@Perkiraan, @KodeTipe, 0,@Kind,@HariHutPiut,
         		@IsAktif, @HargaKe)

end
if @Mode='U'
begin
  	Update dbCustSupp set KodeCustSupp=@KodeCustSupp, NamaCustSupp=@NamaCustSupp, Usaha=@Usaha,
                        Alamat1=@Alamat1, Alamat2=@Alamat2, Kota=@KodeKota, KodePos=@KodePos, Telpon=@Telpon, Fax=@Fax,
                        Email=@Email, NPWP=@NPWP, Tanggal=@Tanggal, Plafon=@Plafon, Hari=@Hari,Kind=@Kind,HariHutPiut=@HariHutPiut,
                        Berikat=@Berikat, Jenis=@Jenis, Sales=@Sales,Negara=@Negara,
                        NamaPkp=@NamaPKP, AlamatPkp1=@AlamatPkp1, AlamatPkp2=@Alamatpkp2, KotaPkp=@KotaPkp,kodevls=@kodevls,
                        Perkiraan=@Perkiraan, KodeTipe=@KodeTipe,isPpn=0, IsAktif=@IsAktif, HargaKe=@HargaKe
  	where KodeCustSupp=@OldKode and Kind=@Kind
end
if @Mode='D'
begin
     	Delete dbCustSupp 
    	where KodeCustSupp=@OldKode and Kind=@Kind
end
if @@error <> 0 goto JikaSalah
commit tran
return
JikaSalah:  rollback tran
            return



GO

-- Procedure: sp_PO
-- =====================================================


CREATE Procedure [dbo].[sp_PO]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@TglJatuhTempo Datetime,
@KodeSupp varchar(15),
@Handling numeric(18,2),
@KodeExp varchar(20),
@Keterangan varchar(200),
@FakturSupp Varchar(20),
@KodeVls varchar(15),
@Kurs numeric(18,2),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@TipeDisc tinyint,
@Disc float,
@DiscRp numeric(18,2),
@Urut int,
@KodeBrg varchar(25),
@Qnt numeric(18,2),
@NoSat tinyint,
@Satuan varchar(5),
@Isi numeric(18,2),
@Harga numeric(18,4),
@DiscP numeric(18,2),
@DiscTot numeric(18,4),
@NoPPL Varchar(50),
@IsClose Bit,
@IsCloseD Bit,
@Catatan Varchar(500),
@IsExp Bit=False,
@Tolerate Numeric(5,2)=0,
@UrutPPL int=0, 
@Kodegdg varchar(15),
@Discpdet2 Numeric(18,2),
@Discpdet3 Numeric(18,2),
@Discpdet4 Numeric(18,2),
@Discpdet5 Numeric(18,2),
@FlagTipe Tinyint,
@NamaBrg Varchar(100),
@IsJasa Bit
As



Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbPOdet Where NoBukti=@NoBukti
  if not exists(select * from dbPO Where NoBukti=@NoBukti) 
  begin
    insert into dbPO (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling, KodeExp, KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp,IsClose,IsExp, kodegdg,FlagTipe)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @TglJatuhTempo, @KODESUPP, @Handling, @KodeExp, @KETERANGAN,
	@FakturSupp, @KODEVLS, @KURS, @PPN, @TIPEBAYAR, @HARI, @TipeDisc, @DISC, @DISCRP,@IsClose,@IsExp, @Kodegdg,@FlagTipe)
  end
  insert into dbPODET (NOBUKTI, URUT,  PPN, Disc, KODEBRG, QNT, NOSAT, ISI, SATUAN, HARGA, DISCP, DISCTOT,NoPPL,IsClose
						,Tolerate, UrutPPL,KURS,DiscP2,DiscP3,DiscP4,DiscP5,NamaBrg,Isjasa)
  values(@NOBUKTI, @URUT, @PPN, @Disc, @KODEBRG, @Qnt, @NOSAT, @ISI, @SATUAN, @Harga, @DISCP, @DISCTOT,@NoPPL,@IsCloseD,
   @Tolerate,@UrutPPL,@Kurs,@Discpdet2,@Discpdet3,@Discpdet4,@Discpdet5,@NamaBrg,@IsJasa)
end
if @Choice='U'
begin 
 if Exists (select NoBukti from DBPO where NOBUKTI=@NoBukti)-- and ISNULL(IsAut,0)=1) 
 Begin
  exec [sp_PORev] @NoBukti,0,@Urut,@Catatan,1
 end
  update dbPODET set IsClose=@IsCloseD, KodeBrg=@KODEBRG, Qnt=@QNT, NoSat=@NoSat, Isi=@Isi, Satuan=@Satuan, Harga=@HARGA, DiscP=@DiscP, DiscTot=@DiscTot,NoPPL=@NoPPL,Tolerate=@Tolerate,KURS=@Kurs ,
  DiscP2=@Discpdet2,DiscP3=@Discpdet3,DiscP4=@Discpdet4,DiscP5=@Discpdet5
  where NoBukti=@NoBukti and Urut=@Urut
end
if @Choice='D'
begin
 if Exists (select NoBukti from DBPO where NOBUKTI=@NoBukti )--and ISNULL(IsAut,0)=1) 
 Begin
  exec [sp_PORev] @NoBukti,0,@Urut,@Catatan,1
 end  
  delete dbPODET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbPODET where NoBukti=@NoBukti)
  begin
    delete dbPO where NoBukti=@NoBukti
    delete DBKirimDET where NoBukti=@NoBukti 
  end
end
--if Exists(select NoBukti from DBPODET where NOBUKTI=@NoBukti) 
 --Begin
   --Update DBPO Set NILAIDPP=(select Isnull(SUM(NDPP),0)NDPP from DBPODET where NOBUKTI=DBPO.NOBUKTI),
     --                NILAINET=(select Isnull(SUM(NNET),0)NNET from DBPODET where NOBUKTI=DBPO.NOBUKTI),
   --                  NILAIPPN=(select Isnull(SUM(NPPN),0)NPPN from DBPODET where NOBUKTI=DBPO.NOBUKTI)
   --where NOBUKTI=@NoBukti                  
 --End 
exec sp_RefreshOutPPL @NoPPL
if @@error<>0  goto jikasalah

Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: Sp_Beli
-- =====================================================
CREATE   Procedure [dbo].[Sp_Beli]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@TglJatuhTempo Datetime,
@KodeSupp varchar(15),
@KodeGdg varchar(15),
@Handling numeric(18,2),
@Keterangan varchar(200),
@FakturSupp Varchar(20),
@KodeVls varchar(15),
@Kurs numeric(18,2),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@TipeDisc tinyint,
@Disc float,
@DiscRp numeric(18,2),
@Urut int,
@KodeBrg varchar(25),
@Qnt numeric(18,2)=0,
@NoSat tinyint,
@Satuan varchar(5),
@Isi numeric(18,2),
@Harga numeric(18,4),
@DiscP numeric(18,2),
@DiscTot numeric(18,2)
/*@NoPO varchar(20)='',
@UrutPO int=0,
@DiscP2 numeric(18,2),
@DiscTot2 numeric(18,2),
@Pilih VarChar(1)='',
@Qnt2 Numeric(18,2)=0,
@QntReject Numeric(18,2)=0,
@Qnt2Reject Numeric(18,2)=0,
@XUbah Varchar(1)=''*/


As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbBelidet Where NoBukti=@NoBukti
  if not exists(select * from dbBeli Where NoBukti=@NoBukti) 
  begin
    insert into dbBeli (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling,  KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @TglJatuhTempo, @KODESUPP, @Handling, @KETERANGAN,
	@FakturSupp, @KODEVLS, @KURS, @PPN, @TIPEBAYAR, @HARI, @TipeDisc, @DISC, @DiscRp)
  end
  insert into dbBeliDET (NOBUKTI, URUT,  PPN, Disc, KODEBRG, Qnt, NOSAT, ISI, SATUAN, HARGA, DISCP, DISCTot, 
  KodeGdg )
  values(@NOBUKTI, @URUT, @PPN, @Disc, @KODEBRG, @Qnt, @NoSat, @Isi, @Satuan, @Harga, @DiscP, @DiscTOT, 
  @KodeGdg)
end
if @Choice='U'
begin
  update dbBeliDET set KodeBrg=@KODEBRG,  
  --QntTerima=Case when @XUbah='T' Then Case When @Pilih='I' Then Isnull(Qnt,0)+@QNT when @Pilih='U'Then @Qnt end else QntTerima end, 
  --NOSAT=@NoSat, ISI=@ISI, SATUAN=@Satuan, Harga=@HARGA, DiscP=@DiscP, DiscTot=@DiscTot,DiscP2=@DiscP2, KodeGdg=@KodeGdg,
  --Qnt2Terima=Case when @XUbah='T' Then Case When @Pilih='I' Then Isnull(Qnt,0)+@QNT2 when @Pilih='U'Then @Qnt2 end else Qnt2Terima end,
  --QntReject=Case when @XUbah='R' Then Case When @Pilih='I' Then Isnull(QntReject,0)+@QntReject when @Pilih='U'Then @QntReject end else QntReject end,
  --Qnt2Reject=Case when @XUbah='R' Then Case When @Pilih='I' Then Isnull(Qnt2Reject,0)+@Qnt2Reject when @Pilih='U'Then @Qnt2Reject end else Qnt2Reject end,
  QNT=(QntTerima-QntReject)--,Qnt2=(ISNULL(Qnt2Terima,0)-ISNULL(Qnt2Reject,0))
  where NoBukti=@NoBukti and Urut=@Urut
end
/*if @Choice='U'
begin 
 update dbBeliDET set  QNT=(QntTerima-QntReject),Qnt2=(ISNULL(Qnt2Terima,0)-ISNULL(Qnt2Reject,0))
 where NoBukti=@NoBukti and Urut=@Urut
end*/
if @Choice='D'
begin
  delete dbBeliDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbBeliDET where NoBukti=@NoBukti)
  begin
    delete dbBeli where NoBukti=@NoBukti
  end
end
if Exists(select NoBukti from DBBELIDET where NOBUKTI=@NoBukti) 
 Begin
   Update DBBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
                     NILAINET=(select SUM(NNET)NNET from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
                     NILAIPPN=(select SUM(NPPN)NPPN from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI)
   where NOBUKTI=@NoBukti                  
 End 
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return












GO

-- Procedure: SP_KOREKSI
-- =====================================================





CREATE  Procedure [dbo].[SP_KOREKSI]
@Choice Varchar(1),
@Nobukti Varchar(20),
@NoUrut varchar(10),
@Tanggal Datetime,
@Note varchar(200),
@Urut int,
@KodeBrg varchar(25),
@KodeGdg varchar(15),
@SaldoComp numeric(18,2),
@QntOpname numeric(18,2),
@Selisih numeric(18,2),
@QntDB numeric(18,2),
@QntCR numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2),
@Satuan varchar(5),
@Harga numeric(18,2),
@keterangan Varchar(100),
@Saldo2Comp numeric(18,2),
@Qnt2Opname numeric(18,2),
@Selisih2 numeric(18,2),
@Qnt2DB numeric(18,2),
@Qnt2CR numeric(18,2),
@isCek Bit,
@IsCek2 Bit


As

Begin tran
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBKOREKSIdet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1
  if not exists(select * from DBKOREKSI Where NoBukti=@NoBukti) 
  begin
    insert into DBKOREKSI (NOBUKTI, NOURUT, TANGGAL,KodeGdg,NOTE)
    values (@NOBUKTI, @NoUrut, @TANGGAL,@KodeGdg,@NOTE)
   			
  end
  insert into DBKOREKSIDET (NOBUKTI,URUT,KODEBRG,
                            SaldoComp,QntOpname,Selisih,QNTDB,QNTCR,Saldo2Comp,Qnt2Opname,Selisih2,QNT2DB,QNT2CR,HARGA, NoSat, Isi, Satuan,Keterangan,IsCek,IsCek2)
  values(@NOBUKTI,@URUT,@KODEBRG, 
         @SaldoComp,@QntOpname,@Selisih,@QNTDB,@QNTCR,@Saldo2Comp,@Qnt2Opname,@Selisih2,@QNT2DB,@QNT2CR,@HARGA, @NoSat, @Isi, @Satuan,@Keterangan,@isCek,@IsCek2)
end
if @choice='U'
begin
  update DBKOREKSIDET set Kodebrg=@KODEBRG, 
         SaldoComp=@SaldoComp,QntOpname=@QntOpname,Selisih=@Selisih,QntDb=@QNTDB,QntCR=@QNTCR,Harga=@HARGA,
         Saldo2Comp=@Saldo2Comp,Qnt2Opname=@Qnt2Opname,Selisih2=@Selisih2,Qnt2Db=@QNT2DB,Qnt2CR=@QNT2CR,
	NoSat=@NoSat, Isi=@Isi, Satuan=@Satuan,Keterangan=@Keterangan,IsCek=@isCek,IsCek2=@IsCek2
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete DBKOREKSIDET where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from DBKOREKSIDET where nobukti=@nobukti)
  begin
    delete DBKOREKSI where nobukti=@nobukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: sp_HutPiut
-- =====================================================

CREATE PROCEDURE [dbo].[sp_HutPiut]
@Choice varchar(1),
@NoFaktur varchar (30),
@NoRetur varchar (30),
@TipeTrans varchar (3),
@KodeCustSupp varchar (15),
@NoBukti varchar (30),
@NoMsk int,
@Urut int,
@Tanggal datetime,
@JatuhTempo datetime,
@Debet numeric (18,2),
@Kredit numeric (18,2),
@Valas varchar (15),
@Kurs numeric (18,4),
@KodeSales varchar (15),
@Tipe varchar (4),
@Perkiraan varchar (25),
@Catatan varchar (800),
@NoInvoice varchar(20),
@KodeVls_ varchar(20),
@Kurs_ numeric(18,2),
@KursBayar numeric(18,2),
@DebetD numeric (18,2),
@KreditD numeric (18,2),
@Bank varchar(20),
@noGiro Varchar(20),
@TglGiro DateTime,
@BuktiCair varchar(20),
@TipeBayar TinyInt,
@NilaiGiroD Numeric(18,2),
@NilaiGiroK Numeric(18,2),
@KBLB varchar(2), 
@Nourut Varchar(10)

AS

if @Choice='I'
begin
	select @Urut=Max(Urut) 
	from DBHUTPIUT 
	where KodeCustSupp=@KodeCustSupp and NoFaktur=@NoFaktur 
	set @Urut=isnull(@Urut,0)+1
	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
	NoBukti, NoMsk, Urut, 
	Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, DebetD, KreditD, 
	KodeSales, Tipe, Perkiraan, Catatan, NoInvoice, KodeVls_, Kurs_, KursBayar,TipeBayar,KBLB,Nourut)
	values (@NoFaktur, @NoRetur, @TipeTrans, @KodeCustSupp, 
	@NoBukti, @NoMsk, @Urut, 
	@Tanggal, @JatuhTempo, @Debet*@Kurs, @Kredit*@Kurs, @Valas, @Kurs, 
	case when @Valas='IDR' then @DebetD else @Debet end, 
	case when @Valas='IDR' then @KreditD else @Kredit end, 
	@KodeSales, @Tipe, @Perkiraan, @Catatan,
	@NoInvoice, @KodeVls_, @Kurs_, @KursBayar,@TipeBayar,@KBLB,@Nourut)
	/*
	if @TipeBayar=1  
	insert into DBGIRO (Bank, NoGiro, TglGiro, Debet, Kredit, DebetRp, KreditRp,KodeVls, Kurs, KeteranganCair, TglCair, BuktiCair,Tipe)
    values (@Bank, @NoGiro, @TglGiro, @Debet, @Kredit, @NilaiGiroD, @NilaiGiroK, @Valas, @Kurs, '', @Tanggal, @BuktiCair,@Tipe)
    */
end
if @choice='U'
begin
	update DBHUTPIUT 
	set Tanggal=@Tanggal, JatuhTempo=@JatuhTempo, Debet=@Debet*@Kurs, Kredit=@Kredit*@Kurs, Valas=@Valas, Kurs=@Kurs, 
	DebetD=case when @Valas='IDR' then 0 else @Debet end, KreditD=case when @Valas='IDR' then 0 else @Kredit end, 
	KodeSales=@KodeSales, Tipe=@Tipe, Catatan=@Catatan,TipeBayar=@TipeBayar
	where NoFaktur=@NoFaktur and NoRetur=@NoRetur and TipeTrans='L' and KodeCustSupp=@KodeCustSupp and NoBukti=@NoBukti
	and Perkiraan=@Perkiraan and NoMsk=@NoMsk and Urut=@Urut 
end
if @choice='D'
begin
	delete DBHUTPIUT 
	where NoFaktur=@NoFaktur and NoRetur=@NoRetur and TipeTrans='L' and KodeCustSupp=@KodeCustSupp and NoBukti=@NoBukti
	and Perkiraan=@Perkiraan and NoMsk=@NoMsk and Urut=@Urut
	if @TipeBayar=1 delete DBGIRO where NoGiro=@noGiro and BuktiCair=@BuktiCair
end





GO

-- Procedure: sp_AmbilNilaiPasar
-- =====================================================
Create Procedure [dbo].[sp_AmbilNilaiPasar]
@Bulan int,
@tahun int,
@devisi varchar (10)
as
delete xlsNilaiPasar 
insert into xlsNilaiPasar (Urut ,Perkiraan ,Tahun ,Bulan ,Keterangan,NilaiPerolehan,NilaiPasar)
select 
CAST(ROW_NUMBER() Over(PARTITION BY a.bulan Order by a.perkiraan) As int) Urut,
a.Perkiraan ,Tahun ,Bulan ,Keterangan ,Awal ,0 nilaipasar
from
DBINVESTASIDET a
left outer join DBINVESTASI b on b.Perkiraan =a.Perkiraan 
where Bulan =1 and Tahun =2024 and Akhir>0
GO

-- Procedure: Sp_HasilPrd
-- =====================================================
CREATE   Procedure [dbo].[Sp_HasilPrd]
@Choice varchar(1),
@NoBukti varchar(20)='',
@NoUrut varchar(10)='',
@Tanggal datetime='',
@KodeGdg varchar(15)='',
@Keterangan varchar(200)='',
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)=0,
@NoSat tinyint=0,
@Satuan varchar(5)='',
@Isi numeric(18,2)=0,
@NoSPK Varchar(50)='',
@KodePrs1 varchar(20)='',
@KodeMesin varchar(20)='',
@TanggalMsn datetime='',
@JamAwal datetime='',
@JamAkhir datetime=''

As
Begin tran
if @Choice='I'
begin
/*
  select @Urut=isnull(max(urut),0)+1 from dbHasilPrddet Where NoBukti=@NoBukti
  if not exists(select * from dbHasilPrd Where NoBukti=@NoBukti) 
  begin
    insert into dbHasilPrd (NOBUKTI, NOURUT, TANGGAL, KETERANGAN, NoSPK, KodePrs, KodeBrg, Qnt, NoSat, Satuan, Isi, KodeMesin, TanggalMesin, JamAwal, JamAkhir)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @KETERANGAN, @NoSPK, @KodePrs1, @KodeBrg, @Qnt, @NoSat, @Satuan, @Isi, @KodeMesin, @TanggalMsn, @JamAwal, @JamAkhir)
  end
  insert into dbHasilPrdDET (NOBUKTI, URUT,  KODEBRG, Qnt, NOSAT, ISI, SATUAN,KodeGdg,NoSPK, KodePrs)
  values(@NOBUKTI, @URUT, @KodeBrg2, @Qnt2, @NoSat2, @Isi2, @Satuan2, '','',@KodePrs2)
*/  
  insert into dbHasilPrd (NOBUKTI, NOURUT, TANGGAL, KETERANGAN, NoSPK, KodePrs, KodeBrg, Qnt, NoSat, Satuan, Isi, KodeMesin, TanggalMesin, JamAwal, JamAkhir)
  values (@NOBUKTI, @NOURUT, @TANGGAL, @KETERANGAN, @NoSPK, @KodePrs1, @KodeBrg, @Qnt, @NoSat, @Satuan, @Isi, @KodeMesin, @TanggalMsn, @JamAwal, @JamAkhir)

end
if @Choice='U'
begin
  update DBHASILPRD set KETERANGAN=@Keterangan, NoSPK=@NoSPK, KodePrs=@KodePrs1, KodeBrg=@KodeBrg, 
						Qnt=@Qnt, NoSat=@NoSat, Satuan=@Satuan, Isi=@Isi, 
						KodeMesin=@KodeMesin, TanggalMesin=@TanggalMsn, JamAwal=@JamAwal, JamAkhir=@JamAkhir
  where NOBUKTI = @NoBukti
  
  --update dbHasilPrdDET set KodeBrg=@KODEBRG, Qnt=@Qnt2, NOSAT=@NoSat2, ISI=@Isi2, SATUAN=@Satuan2,KodeGdg=@KodeGdg
  --where NoBukti=@NoBukti and Urut=@Urut
end
if @Choice='D'
begin
  --delete dbHasilPrdDET where NoBukti=@NoBukti and Urut=@Urut 
  --if not exists( select NoBukti from dbHasilPrdDET where NoBukti=@NoBukti)
  --begin
  --  delete dbHasilPrd where NoBukti=@NoBukti
  --end
  delete dbHasilPrd where NoBukti=@NoBukti
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return














GO

-- Procedure: sp_LapArusKas
-- =====================================================


CREATE PROCEDURE [dbo].[sp_LapArusKas]
--declare
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=3,@Tahun=2018;
AS
Set @Devisi=Case when @Devisi in ('-','') then '%' else @Devisi end;
  
With ArusKas (KodeAK,KodeSAK,bulan,tahun,devisi,Nilai) AS
(  
      select KodeAK,KodeSAK,Bulan,Tahun,Devisi  ,sum(Nilai) Nilai from (    
	    select --'A' Tanda,
	    a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,Devisi,JnsTransInvestasi ,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
     select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) 
        then  a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then 0 end) as Nilai,
		            kodecost,t.Devisi ,JnsTransInvestasi
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) 
		--and (a.Devisi like @Devisi) --and isnull(ispasang,0)=0--and (a.Perkiraan ='2901' or a.Lawan  ='2901' )
		and ((a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')) ) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK not in ('SAK05','SAK06')
	   and  devisi like @devisi and ISNULL (JnsTransInvestasi,0) <>1
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,devisi,JnsTransInvestasi-- ,a.Perkiraan
union all -- labarugi masuk aruskas karena sbn bln92024 karena jual SBN
 	    select --'A' Tanda,
	    --a.KodeAK,a.KodeSAK,
	    'AK01',	'SAK01',
	    b.Bulan,b.Tahun,Devisi,JnsTransInvestasi ,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
     select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) 
        then  a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then 0 end) 
		            
		            as Nilai,
		            kodecost,t.Devisi ,JnsTransInvestasi
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) 
		--and (a.Devisi like @Devisi) --and isnull(ispasang,0)=0--and (a.Perkiraan ='2901' or a.Lawan  ='2901' )
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and isnull(KodeSAK,'')='' --KodeSAK not in ('SAK05','SAK06')
	   and  devisi like @devisi and ISNULL (JnsTransInvestasi,0) =3 
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,devisi,JnsTransInvestasi 
union all -- labarugi masuk aruskas karena sbn bln32025 karena SBN Jatuh Tempo Lewat memorial
	 	    select --'A' Tanda,
	    --a.KodeAK,a.KodeSAK,
	    'AK01',	'SAK01',
	    b.Bulan,b.Tahun,Devisi,JnsTransInvestasi ,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
     select (case when (a.perkiraan in ('X')) 
        then  a.Lawan
	          when ((a.lawan in ('X'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in ('X')) and debet<>0 then debet*a.kurs
		     --when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then 0
		     when (((a.lawan in ('X'))))  and debet<>0 then 0
		     --when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then kredit*a.kurs 
		     end
	        	) -
	    (case when (a.perkiraan in ('X')) and debet<>0 then 0
		            --when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then Kredit*a.kurs
		            when (((a.lawan in ('X')))) and debet<>0 then Debet*a.kurs
		           --when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then 0 
		           end) 
		           -- Debet 
		            as Nilai,
		            kodecost,t.Devisi ,JnsTransInvestasi
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (month(t.tanggal)=3 and year(t.tanggal)=2025) 
		--and (a.Devisi like @Devisi) --and isnull(ispasang,0)=0--and (a.Perkiraan ='2901' or a.Lawan  ='2901' )
		and t.TipeTransHd ='BMM'
	   ) B on b.Perkiraan=a.Perkiraan
	   where /*b.Perkiraan is not null and isnull(KodeSAK,'')='' --KodeSAK not in ('SAK05','SAK06')
	   and  devisi like '01' and*/ ISNULL (JnsTransInvestasi,0) =3 
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,devisi,JnsTransInvestasi    


  -- hutang piutang inves
  
       union all
	    select --'B' Tanda,
	    'AK01','SAK05+',b.Bulan,b.Tahun,Devisi,0  ,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK06')
 	    group by Bulan ,Tahun ,Devisi,a.Keterangan --,a.Perkiraan 		
 	    
       union all
	    select --'C'Tanda,
	    'AK01','SAK05-',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode not in ('IVT'))) )
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan  --,b.Perkiraan 	 	           

       union all
	    select --'D'Tanda,
	    'AK01','SAK05-',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan not like '1103010' 
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan  --,b.Perkiraan 	 	           

       
      union all
	    select --'D1'Tanda,
	    'AK01','SAK05-',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
		    --or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
		)
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and (a.Perkiraan  like '1103010' or  (a.GroupPerkiraan  like '1101000' and IsNonLedger=0 and IsInvestasi =0)
 	    )
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan  	 	           

       union all
	    select --'D2'Tanda,
	    'AK01','SAK05+',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    ( -- (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and (a.Perkiraan  like '1103010'  or (a.GroupPerkiraan  like '1101000' and IsNonLedger=0 and IsInvestasi =0))
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan -- ,b.Perkiraan 	 	           


--tabungan	   	   Porto
	   union 
	   	/*   select --'F' Tanda,
	   	   'AK01','SAK05+',@bulan ,@Tahun ,@Devisi,0, SUM(-1*(sd-awalpasar))/* -1*SPI  */ from DBINVESTASIDET 
	   where Perkiraan like '1101000%' and Bulan=@bulan and Tahun =@Tahun 
	   --case when sum(SD)>sum(AwalPasar) then -1*sum(SD-AwalPasar ) else -1*sum(SD-AwalPasar ) end
	   having sum(SD)>sum(AwalPasar)   	     	           
	   union 
	   	   select --'F' Tanda,
	   	   'AK01','SAK05-',@bulan ,@Tahun ,@Devisi,0, SUM(-1*(sd-awalpasar))/* -1*SPI  */ from DBINVESTASIDET 
	   where Perkiraan like '1101000%' and Bulan=@bulan and Tahun =@Tahun  	     	           
       having sum(SD)<sum(AwalPasar)  */
	   	   select --'F' Tanda,SUM(-1*(sd-awalpasar))
	   	   'AK01','SAK05+',@bulan ,@Tahun ,@Devisi,0,
	   	    -1*(case when max(sd)=0 then  [dbo] .[ArusKasSDBank] ( @Bulan , @Tahun ) else sum(SD) end -sum(AwalPasar) ) /* -1*SPI  */ from DBINVESTASIDET 
	   where Perkiraan like '1101000%' and Bulan=@bulan and Tahun =@Tahun 
	   --case when sum(SD)>sum(AwalPasar) then -1*sum(SD-AwalPasar ) else -1*sum(SD-AwalPasar ) end
	   having --[dbo].[ArusKasSDBank] ( @Bulan , @Tahun )
	   case when max(sd)=0 then  [dbo] .[ArusKasSDBank] ( @Bulan , @Tahun ) else sum(SD) end
	   >sum(AwalPasar)   	     	           
	   union 
	   	   select --'F' Tanda,
	   	   'AK01','SAK05-',@bulan ,@Tahun ,@Devisi,0, 
	   	   -1*(case when max(sd)=0 then  [dbo] .[ArusKasSDBank] ( @Bulan , @Tahun ) else sum(SD) end -sum(AwalPasar) )/* -1*SPI  */ from DBINVESTASIDET 
	   where Perkiraan like '1101000%' and Bulan=@bulan and Tahun =@Tahun  	     	           
       having 
       case when max(sd)=0 then  [dbo] .[ArusKasSDBank] ( @Bulan , @Tahun ) else sum(SD) end<sum(AwalPasar)         

      union all
	    select --'G' Tanda,
	    'AK02',KodeSAK+'+',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
		    --or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
		)
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK09','SAK10','SAK11','SAK12') and b.Bulan is not null 
 	    /*and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan  like '1103010'*/ 
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan,a.KodeSAK  	 	           

       union all
	    select --'G1'Tanda,
	    'AK02',KodeSAK+'-',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    ( -- (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK09','SAK10','SAK11','SAK12') and b.Bulan is not null 
 	    /*and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan  like '1103010' */
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan,a.KodeSAK  -- ,b.Perkiraan 	 	           
---perpindahan investasi tabungan ke tabungan biaya
      union all
	    select --'H1'Tanda,
	    'AK01','SAK05-',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
		    --or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
		)
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		and a.JnsTransInvestasi=1
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where --KodeSAK in ('SAK05') and 
 	    b.Bulan is not null 
 	    and  	    -- (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    --and (a.Perkiraan  like '1103010' or  (a.GroupPerkiraan  like '1101000' and IsNonLedger=0 and IsInvestasi =0))
 	     (a.GroupPerkiraan  like '1101000' --and IsNonLedger=0 and IsInvestasi =0
 	    )
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan  	 	           

       union all
	    select --'H2'Tanda,
	    'AK01','SAK05+',b.Bulan,b.Tahun,Devisi,0,sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    ( -- (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		and JnsTransInvestasi =2
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where --KodeSAK in ('SAK05') and 
 	    b.Bulan is not null 
 	    and  	--     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	   -- and (a.Perkiraan  like '1103010'  or (a.GroupPerkiraan  like '1101000' and IsNonLedger=0 and IsInvestasi =0))
 	    (a.GroupPerkiraan  like '1101000' --and IsNonLedger=0 and IsInvestasi =0
 	    )
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan -- ,b.Perkiraan 	 	           

	) Z group by KodeAK,KodeSAK,Bulan,Tahun  ,devisi   

)

select a.KodeAK,a.KodeSAK,a.Tipe,a.Keterangan,a.Nomor,a.Urutan,sum(isnull(c.Nilai,0)) Nilai,
SUM(isnull(d.nilai,0)) NilaiLalu
 from DBArusKasKonfig a
 left outer join (select KodeAK,KodeSAK,Nilai from ArusKas where (bulan between @bulan and @akr) and tahun=@Tahun)
  c on c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK 
  --where devisi like @Devisi 
 left outer join dbo.TblLapArusKas(@bulan-1 ,@Tahun ,@Devisi )
 d on d.KodeAK=a.KodeAK and d.KodeSAK =a.KodeSAK
 group by a.KodeAK,a.KodeSAK,a.Tipe,a.Keterangan,a.Nomor,a.Urutan
 order by a.Nomor
 
GO

-- =====================================================
-- REQUESTED PROCEDURE: sp_AmbilNilaiPasar
-- =====================================================

-- Procedure: sp_AmbilNilaiPasar
Create Procedure [dbo].[sp_AmbilNilaiPasar]
@Bulan int,
@tahun int,
@devisi varchar (10)
as
delete xlsNilaiPasar 
insert into xlsNilaiPasar (Urut ,Perkiraan ,Tahun ,Bulan ,Keterangan,NilaiPerolehan,NilaiPasar)
select 
CAST(ROW_NUMBER() Over(PARTITION BY a.bulan Order by a.perkiraan) As int) Urut,
a.Perkiraan ,Tahun ,Bulan ,Keterangan ,Awal ,0 nilaipasar
from
DBINVESTASIDET a
left outer join DBINVESTASI b on b.Perkiraan =a.Perkiraan 
where Bulan =1 and Tahun =2024 and Akhir>0
GO

-- =====================================================
-- ALL OTHER PROCEDURES (418 total)
-- =====================================================

-- Procedure: CekLaporanKeuangan
-- Created: 2024-10-03 15:04:02.013 | Modified: 2024-10-24 13:36:21.513
-- =====================================================


CREATE Procedure [dbo].[CekLaporanKeuangan]
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
As
DROP TABLE #AsetNeto
DROP TABLE #PerubahanAsetNeto
DROP TABLE #Aruskas
IF object_id('TEMPDB.DBO.#AsetNeto') IS NOT NULL drop table #AsetNeto
IF object_id('TEMPDB.DBO.#PerubahanAsetNeto') IS NOT NULL drop table #PerubahanAsetNeto 
IF object_id('TEMPDB.DBO.#ArusKas') IS NOT NULL drop table #Aruskas

CREATE TABLE #AsetNeto
( GrupNeraca varchar(50),
  Grup varchar(50),
  Jumlah varchar(11),
  Keterangan varchar(1000),
  TIpe tinyint,
  DK tinyint,
  bulanini numeric(18,2),
  bulanLalu numeric(18,2),
  Devisi varchar (4),
  Perkiraan varchar(10),
  jmlbulanini numeric(18,2)
)

insert into #AsetNeto
 exec SP_LapAsetNeto '01',8,2024


CREATE TABLE #PerubahanAsetNeto
(
  NamaTipe varchar(500),
  DEltaNeto numeric(18,2),
  Keterangan varchar(500),
  Urutan varchar (10),
  TIPE tinyint,
  Nilai numeric(18,2),
  NetoblnIni numeric(18,2),
  Netoblnlalu numeric(18,2),
  NilaiblnLalu numeric(18,2),
  deltanetoblnlalu numeric(18,2)
)
insert into #PerubahanAsetNeto
exec  sp_LapPerubahanAset 8,8,2024,'01'
CREATE TABLE #Aruskas
( KodeAK varchar(50),
  KodeSAK varchar(50),
  Tipe tinyint,
  Keterangan varchar(1000),
  Nomor varchar(50),
  Urutan varchar(50),
  Nilia numeric(18,2),
  NilaiLalu numeric(18,2),

)

exec sp_LapArusKas 8,8,2024,'01'
select SUM(neto ),SUM(PAN ) from 
(
select SUM(ISNULL (bulanini,0))neto,0 PAN,0 AK from #AsetNeto
union all
select 0 neto ,sum(isnull(Deltaneto,0))+MAX(netoblnini) PAN,0 AK from #PerubahanAsetNeto
union all
select 0 neto ,0 PAN,SUM(Nilia ) AK from #Aruskas
) x
having (SUM(neto )-SUM(PAN )) >2




GO

-- Procedure: CetakDebetNote
-- Created: 2013-04-12 07:49:29.210 | Modified: 2015-04-21 08:56:55.470
-- =====================================================

CREATE Procedure [dbo].[CetakDebetNote]
@NoBukti varchar(20)
as
Select  c.KodeSupp,d.NamaCustSupp,d.Alamat1,Right(a.noBukti,4)NoUrut,a.Urut,a.NoBukti,c.tanggal,A.Keterangan,b.NoBukti NoInv,b.NDPP,b.NPPN,b.NNet,Nilai,
        a.kodeVls, a.Kurs, a.NilaiRp, b.NnetRp,f.NAMABRG,E.QNT
From  dbDebetNoteDet a
Left Outer Join dbDebetNote c On c.NoBukti=a.NoBukti
Left Outer Join (select a.NoBukti, SUM(c.NDPP) NDPP, SUM(c.NPPN) NPPN, SUM(c.NNet) NNet, SUM(c.NnetRp) NnetRp
                 from dbInvoiceDet a
                 Left Outer Join dbBeli b On a.NoBeli=b.noBukti
                 LEft Outer Join (Select NOBUKTI, SUM(NDPP) NDPP, SUM(NPPN) NPPN, SUM(NNET) NNet, SUM(NNETRp) NnetRp
                                  From DBBELIDET
                                  Group by NOBUKTI) C on C.NOBUKTI=B.NOBUKTI
                 Group by a.NoBukti )b On a.NoInv=b.NoBukti
Left Outer Join dbCustSupp d On d.KodeCustSupp=c.KodeSupp
Left OUter join DBBELIDET E on A.NoInv=E.NOBUKTI
left outer join DBBARANG f on E.KODEBRG=f.KODEBRG
where a.NoBukti=@NoBukti
order by a.NoBukti

GO

-- Procedure: cetakhasilproduksi
-- Created: 2013-04-23 13:17:14.997 | Modified: 2013-04-23 13:17:24.477
-- =====================================================
CREATE Procedure cetakhasilproduksi
--declare 
@NoBukti varchar(20)
--select @NoBukti='VSM/062009/00001/G01'
as
select	A.NOBUKTI, A.NOURUT, A.TANGGAL,A.KETERANGAN, B.URUT, B.KODEBRG, Br.NAMABRG, Br.NFix, B.QNT, B.NOSAT, B.SATUAN, B.ISI,
B.KodeGdg,NoSPK,c.Nama,Isnull(A.cetakke,0) + 1 CetakN
from DBHasilPrd A
left outer join DBHasilPrdDET B on B.NOBUKTI=A.NOBUKTI
left outer join DBBARANG Br on Br.KODEBRG=B.KODEBRG
left outer join dbGudang  c on c.KodeGdg=b.KodeGdg
where A.NoBukti=@NoBukti
order by B.Urut

GO

-- Procedure: CetakInspeksiGudang
-- Created: 2013-04-23 13:17:07.777 | Modified: 2013-04-23 17:35:09.770
-- =====================================================
CREATE Procedure [dbo].[CetakInspeksiGudang]
--declare 
@NoBukti varchar(20)
--select @NoBukti='VSM/062009/00001/G01'
as
select	A.NOBUKTI, A.NOURUT, A.TANGGAL, A.TglJatuhTempo, A.KODESUPP, Cs.NAMACUSTSUPP, 
A.HANDLING, A.KETERANGAN, A.FAKTURSUPP, A.KODEVLS, A.KURS, A.PPN, 
A.TIPEBAYAR, A.HARI, A.TipeDisc, A.DISC, A.DISCRP, A.ISCETAK, A.NilaiCetak, 
A.KodeExp, B.URUT, B.KODEBRG, Br.NAMABRG, Br.NFix, B.QNT, B.NOSAT, B.SATUAN, B.ISI, 
B.HARGA, B.DISCP, B.DISCTOT, B.BYANGKUT, B.HRGNETTO, B.NDISKON, B.SUBTOTAL, 
B.NDPP, B.NPPN, B.NNET, B.NoPO, B.UrutPO,PO.QNT QntPO, 
B.HPP, B.KodeGdg,
B.QntTerima,
case when isnull(B.UrutBeli,0)=0 then B.Qnt1Terima else null end Qnt1Terima,
case when isnull(B.UrutBeli,0)=0 then B.Qnt2Terima else null end Qnt2Terima,
B.QntReject,
case when isnull(B.UrutBeli,0)=0 then null else B.Qnt1Reject end Qnt1Reject,
case when isnull(B.UrutBeli,0)=0 then null else B.Qnt2Reject end Qnt2Reject,
Br.SAT1, Br.SAT2, isnull(B.UrutBeli,0) UrutBeli, B.KetReject,
case when isnull(B.UrutBeli,0)=0 then B.Satuan else '' end SatuanTerima,
case when isnull(B.UrutBeli,0)=0 then '' else B.Satuan end SatuanReject
from DBBELI A
left outer join DBBELIDET B on B.NOBUKTI=A.NOBUKTI
left outer join DBBARANG Br on Br.KODEBRG=B.KODEBRG
left outer join DBCUSTSUPP Cs on Cs.KODECUSTSUPP=A.KODESUPP
Left Outer join (Select NOBUKTI,URUT,QNT
                 from DBPODET) PO on PO.NOBUKTI=B.NoPO and PO.URUT=B.UrutPO
where A.NoBukti=@NoBukti and B.Qnt1Reject<>0
order by case when isnull(B.UrutBeli,0)=0 then B.Urut else B.UrutBeli end, B.Urut


GO

-- Procedure: CetakinvoicePembelian
-- Created: 2013-04-12 07:50:17.463 | Modified: 2013-04-12 10:34:28.470
-- =====================================================

CREATE procedure [dbo].[CetakinvoicePembelian]
@NoBukti varchar(30)
as
Select  c.KodeSupp,d.NamaCustSupp,d.Alamat1,Right(a.noBukti,4)NoUrut,a.Urut,a.NoBukti,c.tanggal,Keterangan,b.NoBukti NoBeli,NDPP,NPPN,NNET
,NoPO,c.NoFaktur,c.TglFaktur,c.KodeVls,c.Kurs,c.PPN,c.TipeBayar,c.Hari
From  dbInvoiceDet a
Left Outer Join dbInvoice c On c.NoBukti=a.NoBukti
Left Outer Join (select a.NoBukti,Sum(NDPP)NDPP,Sum(NPPN)NPPN,Sum(NNET)NNET
                 from dbBeli a
                 Left Outer Join dbBeliDet b On a.NoBukti=b.noBukti
                 Group by a.NoBukti)b On a.NoBeli=b.NoBukti
Left Outer Join dbCustSupp d On d.KodeCustSupp=c.KodeSupp
where a.NoBukti=@NoBukti
order by a.NoBukti

GO

-- Procedure: CetakInvoicePenjualan
-- Created: 2014-03-05 12:40:22.090 | Modified: 2015-03-12 17:34:01.340
-- =====================================================



CREATE procedure [dbo].[CetakInvoicePenjualan]
--declare 
@nobukti varchar(20)
as
--select @nobukti='SLX/INVC/1213/00002'
Select A.NoBukti, A.NoUrut, A.Tanggal, A.PPN, A.Valas, A.Kurs, A.KodeCustSupp, A.Consignee, A.NotifyParty, A.StuffingDate, 
       A.StuffingPlace, H.Nobukti ContractNo, A.PONo, h.HARI PaymentTerm, 
       A.DocCreditNo, A.PoL, A.PoD, A.NameOfVessel, A.Feeder_Vessel, A.Connect_Vessel, A.ShipOnBoardDate, A.Packing, 
       A.Others, A.IsCetak, A.IDUser, A.IsLokal, A.NoBL, A.NoteBeneficiary1, 
       A.NoteBeneficiary2, A.NoteBeneficiary3, A.ShipmentAdvice1, A.ShipmentAdvice2, A.ETADestination, A.ToShipmentAdvice2, A.NoPajak, A.TglFPJ, 
       A.Footnote, A.IssuingBank, A.MyID, 
       A.IsOtorisasi1, A.OtoUser1, A.TglOto1,
       A.IsOtorisasi2, A.OtoUser2, A.TglOto2, 
       A.IsOtorisasi3, A.OtoUser3, A.TglOto3, 
       A.IsOtorisasi4, A.OtoUser4, A.TglOto4, 
       
       A.IsOtorisasi5, A.OtoUser5, A.TglOto5,
       B.Kodebrg,B.Namabrg NamaBrgkom,
       Sum(Case when B.NOSAT=1 then B.QNT
            when B.NOSAT=2 then B.QNT2
            else 0
       end) Qty,
      (Case when B.NOSAT=1 then B.Sat_1
            when B.NOSAT=2 then B.Sat_2
            else ''
       end) Satuan,Sum(B.Qnt) Qnt, Sum(B.Qnt2) Qnt2, B.Sat_1,
       Case when B.SAT_2='' then B.SAT_1
            else B.SAT_2
       end  Sat_2,B.Nosat,B.Harga,
       Sum(B.NDPP) NDPP, Sum(B.NDPPRp) NDPPRp, Sum(B.NPPN) NPPN, Sum(B.NPPNRp) NPPnRp, Sum(B.NNET) Nnet, Sum(B.NNETRp) NnetRp,
       B.NOSPB ShippingMark, B.KetDetail, B.NetW, B.GrossW, B.Meas,
       E.Namabrg,       
       Case when C.USAHA<>'' then C.USAHA+'. ' else '' end+C.NAMACUSTSUPP NamaCustSupp,
       ltrim(C.ALAMAT1+case when ltrim(C.ALAMAT2)<>'' then char(13)+C.ALAMAT2 else '' end) Alamat,C.Kota,C.USAHA,'' NEGARA, C.TELPON, '' FAX, '' EMAIL,
       '' NoLC,
	   '' NoLCShip, '' Notify_PartyShip, '' PoLShip, 
	   '' PodShip, '' ConsigneeShip, 
	   '' Veeder_VesselShip, '' Voy_Veeder_VesselShip,
       '' Connect_VesselShip, '' Voy_Connect_VesselShip, 
	   '' ShipOnBoardShip, '' Stuffing_DateShip, 
	   '' Stuffing_PlaceShip,
	   '' Freight_TermShip, '' NotesShip,
	   Case when MONTH(A.tanggal)=1 then 'January'
	        when MONTH(A.tanggal)=2 then 'February'
	        when MONTH(A.tanggal)=3 then 'March'
	        when MONTH(A.tanggal)=4 then 'April'
	        when MONTH(A.tanggal)=5 then 'May'
	        when MONTH(A.tanggal)=6 then 'June'
	        when MONTH(A.tanggal)=7 then 'July'
	        when MONTH(A.tanggal)=8 then 'August'
	        when MONTH(A.tanggal)=9 then 'September'
	        when MONTH(A.tanggal)=10 then 'October'
	        when MONTH(A.tanggal)=11 then 'November'
	        when MONTH(A.tanggal)=12 then 'December'
	        else ''
	   end Bulan, '' Ukr_Kertas, '' Trade_Term,
        Case when MONTH(A.ShipOnBoardDate)=1 then 'January'
	        when MONTH(A.ShipOnBoardDate)=2 then 'February'
	        when MONTH(A.ShipOnBoardDate)=3 then 'March'
	        when MONTH(A.ShipOnBoardDate)=4 then 'April'
	        when MONTH(A.ShipOnBoardDate)=5 then 'May'
	        when MONTH(A.ShipOnBoardDate)=6 then 'June'
	        when MONTH(A.ShipOnBoardDate)=7 then 'July'
	        when MONTH(A.ShipOnBoardDate)=8 then 'August'
	        when MONTH(A.ShipOnBoardDate)=9 then 'September'
	        when MONTH(A.ShipOnBoardDate)=10 then 'October'
	        when MONTH(A.ShipOnBoardDate)=11 then 'November'
	        when MONTH(A.ShipOnBoardDate)=12 then 'December'
	        else ''
	   end BulanShipOnBoard,
        Case when MONTH(A.ETADestination)=1 then 'January'
	        when MONTH(A.ETADestination)=2 then 'February'
	        when MONTH(A.ETADestination)=3 then 'March'
	        when MONTH(A.ETADestination)=4 then 'April'
	        when MONTH(A.ETADestination)=5 then 'May'
	        when MONTH(A.ETADestination)=6 then 'June'
	        when MONTH(A.ETADestination)=7 then 'July'
	        when MONTH(A.ETADestination)=8 then 'August'
	        when MONTH(A.ETADestination)=9 then 'September'
	        when MONTH(A.ETADestination)=10 then 'October'
	        when MONTH(A.ETADestination)=11 then 'November'
	        when MONTH(A.ETADestination)=12 then 'December'
	        else ''
	   end BulanETADestination, B.Urut,Case when B.Nosat=1 then E.Isi2
            when B.Nosat=2 then E.Isi1 
            else 0
       end ISI,Dbo.Terbilang(m1.Tot) TerBIlang,H.TGLJATUHTEMPO,X.Nama NamaSls,B.DiscP,DiscP2,DiscP3,DiscP4,DiscP5,
       
       cast( case when discp <>0 then DiscP else 0 End as varchar(5))+'+'+ 
       cast( case when discp2 <>0 then DiscP2 else 0 End as varchar(5))+'+'+ 
       cast( case when discp3 <>0 then DiscP3 else 0 End as varchar(5))+'+'+
       cast( case when DiscP4 <>0 then DiscP4 else 0 End as varchar(5))+'+'+
       cast( case when DiscP5 <>0 then DiscP5 else 0 End as varchar(5)) 
       Diss,
       
       
       case when (cast( case when discp <>0 then DiscP else 0 End as varchar(5)))='0.00' then '' else    cast( case when discp <>0 then DiscP else 0 End as varchar(5)) + '+' End   + 
       case when (cast( case when DiscP2 <>0 then DiscP2 else 0 End as varchar(5)))='0.00' then '' else    cast( case when DiscP2 <>0 then DiscP2 else 0 End as varchar(5))+'+' End +  
       case when (cast( case when DiscP3 <>0 then DiscP3 else 0 End as varchar(5)))='0.00' then '' else    cast( case when DiscP3 <>0 then DiscP3 else 0 End as varchar(5))+'+'  End  + 
       case when (cast( case when DiscP4 <>0 then DiscP4 else 0 End as varchar(5)))='0.00' then '' else    cast( case when DiscP4 <>0 then DiscP4 else 0 End as varchar(5))+'+' End  + 
       case when (cast( case when DiscP5 <>0 then DiscP5 else 0 End as varchar(5)))='0.00' then '' else    cast( case when DiscP5 <>0 then DiscP5 else 0 End as varchar(5))+'+'  End  
       xx
       
       
       
       
from dbInvoicePL A
     left outer join dbInvoicePLDet b on b.NoBukti=A.NoBukti     
     left outer join DBBARANG E on E.KODEBRG=B.KodeBrg
     left Outer join (Select x.NoBukti, x.Urut, x.NoSPP
                      from dbSPBDet x
                      Group by x.NoBukti, x.Urut, x.NoSPP) F on F.NoBukti=B.NoSPB and F.Urut=B.UrutSPB
     left outer join (Select NoBukti, NoSO
                      from dbSPPDet x
                      Group by NoBukti, NoSO) G on G.NoBukti=f.NoSPP
     left Outer join DBSO H on H.NoBukti=G.NoSo
     --left outer join vwBrowsCustomer c on c.KODECUST=A.KodeCustSupp and c.Sales=H.KODESLS
     left outer join DBCUSTSUPP c on c.KODECUSTSUPP=A.KodeCustSupp
     LEFT Outer join (select SUM(NNETRp) Tot,Nobukti from dbInvoicePLDet 
						where NoBukti=@nobukti group by NoBukti) m1 on B.NoBukti = m1.NoBukti
	LEFT Outer Join dbKaryawan X on H.KODESLS=X.KeyNIK
     where A.NoBukti=@nobukti
Group by A.NoBukti, A.NoUrut, A.Tanggal, A.PPN, A.Valas, A.Kurs, A.KodeCustSupp, A.Consignee, A.NotifyParty, A.StuffingDate, 
       A.StuffingPlace, A.ContractNo, A.PONo, H.HARI, 
       A.DocCreditNo, A.PoL, A.PoD, A.NameOfVessel, A.Feeder_Vessel, A.Connect_Vessel, A.ShipOnBoardDate, A.Packing, 
       A.Others, A.IsCetak, A.IDUser, A.IsLokal, A.NoBL, A.NoteBeneficiary1, 
       A.NoteBeneficiary2, A.NoteBeneficiary3, A.ShipmentAdvice1, A.ShipmentAdvice2, A.ETADestination, A.ToShipmentAdvice2, A.NoPajak, A.TglFPJ, 
       A.Footnote, A.IssuingBank, A.MyID, 
       A.IsOtorisasi1, A.OtoUser1, A.TglOto1,
       A.IsOtorisasi2, A.OtoUser2, A.TglOto2, 
       A.IsOtorisasi3, A.OtoUser3, A.TglOto3, 
       A.IsOtorisasi4, A.OtoUser4, A.TglOto4, 
       A.IsOtorisasi5, A.OtoUser5, A.TglOto5,
       B.Kodebrg,B.Namabrg,B.NOSAT, B.SAT_1,B.NoSPB,
       B.SAT_2, B.Harga,m1.Tot,
       Case when B.Nosat=1 then E.ISI2
            when B.Nosat=2 then E.ISI1 
            else 0
       end,
       
       B.ShippingMark, B.KetDetail, B.NetW, B.GrossW, B.Meas,
       E.Namabrg,       
       Case when C.USAHA<>'' then C.USAHA+'. ' else '' end+C.NAMACUSTSUPP,
       C.Alamat1, C.ALAMAT2, C.Kota, C.USAHA, C.TELPON, C.KODEPOS, B.Urut,
      
	   Case when MONTH(A.tanggal)=1 then 'January'
	        when MONTH(A.tanggal)=2 then 'February'
	        when MONTH(A.tanggal)=3 then 'March'
	        when MONTH(A.tanggal)=4 then 'April'
	        when MONTH(A.tanggal)=5 then 'May'
	        when MONTH(A.tanggal)=6 then 'June'
	        when MONTH(A.tanggal)=7 then 'July'
	        when MONTH(A.tanggal)=8 then 'August'
	        when MONTH(A.tanggal)=9 then 'September'
	        when MONTH(A.tanggal)=10 then 'October'
	        when MONTH(A.tanggal)=11 then 'November'
	        when MONTH(A.tanggal)=12 then 'December'
	        else ''
	   end,
	   Case when MONTH(A.ShipOnBoardDate)=1 then 'January'
	        when MONTH(A.ShipOnBoardDate)=2 then 'February'
	        when MONTH(A.ShipOnBoardDate)=3 then 'March'
	        when MONTH(A.ShipOnBoardDate)=4 then 'April'
	        when MONTH(A.ShipOnBoardDate)=5 then 'May'
	        when MONTH(A.ShipOnBoardDate)=6 then 'June'
	        when MONTH(A.ShipOnBoardDate)=7 then 'July'
	        when MONTH(A.ShipOnBoardDate)=8 then 'August'
	        when MONTH(A.ShipOnBoardDate)=9 then 'September'
	        when MONTH(A.ShipOnBoardDate)=10 then 'October'
	        when MONTH(A.ShipOnBoardDate)=11 then 'November'
	        when MONTH(A.ShipOnBoardDate)=12 then 'December'
	        else ''
	   end,
         Case when MONTH(A.ETADestination)=1 then 'January'
	        when MONTH(A.ETADestination)=2 then 'February'
	        when MONTH(A.ETADestination)=3 then 'March'
	        when MONTH(A.ETADestination)=4 then 'April'
	        when MONTH(A.ETADestination)=5 then 'May'
	        when MONTH(A.ETADestination)=6 then 'June'
	        when MONTH(A.ETADestination)=7 then 'July'
	        when MONTH(A.ETADestination)=8 then 'August'
	        when MONTH(A.ETADestination)=9 then 'September'
	        when MONTH(A.ETADestination)=10 then 'October'
	        when MONTH(A.ETADestination)=11 then 'November'
	        when MONTH(A.ETADestination)=12 then 'December'
	        else ''
	   end, H.nobukti,H.TGLJATUHTEMPO,X.Nama,B.DiscP,DiscP2,DiscP3,DiscP4,DiscP5






GO

-- Procedure: cetakKreditNote
-- Created: 2013-04-12 07:54:36.850 | Modified: 2013-04-12 10:33:09.573
-- =====================================================

CREATE procedure [dbo].[cetakKreditNote]
@nobukti varchar(20)
as

Select  c.KodeSupp,d.NamaCustSupp,d.Alamat1,Right(a.noBukti,4)NoUrut,a.Urut,a.NoBukti,c.tanggal,Keterangan,b.NoBukti NoInv,NDPP,NPPN,NNET, NNETRp,Nilai,
        a.kodeVls, a.Kurs, a.NilaiRp
From  dbKreditNoteDet a
Left Outer Join dbKreditNote c On c.NoBukti=a.NoBukti
Left Outer Join (select a.NoBukti,Sum(NDPP)NDPP, Sum(NPPN) NPPN, Sum(NNET)NNET,Sum(NNETRp)NNETRp
                 from dbInvoicePLDet a
                 Group by a.NoBukti)b On a.NoInv=b.NoBukti
Left Outer Join dbCustSupp d On d.KodeCustSupp=c.KodeSupp
where a.NoBukti=@NoBukti
order by a.NoBukti
GO

-- Procedure: CetakLBMGudang
-- Created: 2013-04-23 17:35:45.660 | Modified: 2013-04-23 17:54:12.350
-- =====================================================
CREATE Procedure [dbo].[CetakLBMGudang]
--declare 
@NoBukti varchar(20)
--select @NoBukti='SJY/LPB/0113/0002'
as
select A.NOBUKTI, A.NOURUT, A.TANGGAL, A.TglJatuhTempo, A.KODESUPP, Cs.NAMACUSTSUPP, 
A.HANDLING, A.KETERANGAN, A.FAKTURSUPP, A.KODEVLS, A.KURS, A.PPN, 
A.TIPEBAYAR, A.HARI, A.TipeDisc, A.DISC, A.DISCRP, A.ISCETAK, A.NilaiCetak, 
A.KodeExp,  B.KODEBRG, Br.NAMABRG, Br.NFix, Sum(B.QNT) QNT, B.NOSAT, B.SATUAN, B.ISI, 
Sum(B.NDPP) NDPP, Sum(B.NPPN) NPPN, Sum(B.NNET) NNET, B.NoPO, B.UrutPO,PO.QNT QntPO, 
Max(B.HPP) HPP, B.KodeGdg,
SuM(B.QntTerima) QntTerima,
Sum(case when isnull(B.UrutBeli,0)=0 then B.Qnt1Terima else null end) Qnt1Terima,
Sum(case when isnull(B.UrutBeli,0)=0 then B.Qnt2Terima else null end) Qnt2Terima,
Sum(B.QntReject) QntReject,
Sum(case when isnull(B.UrutBeli,0)=0 then null else B.Qnt1Reject end) Qnt1Reject,
Sum(case when isnull(B.UrutBeli,0)=0 then null else B.Qnt2Reject end) Qnt2Reject,
Br.SAT1, Br.SAT2,-- isnull(B.UrutBeli,0) UrutBeli, B.KetReject,
Max(case when isnull(B.UrutBeli,0)=0 then B.Satuan else '' end) SatuanTerima,
Max(case when isnull(B.UrutBeli,0)=0 then '' else B.Satuan end) SatuanReject
from DBBELI A
left outer join DBBELIDET B on B.NOBUKTI=A.NOBUKTI
left outer join DBBARANG Br on Br.KODEBRG=B.KODEBRG
left outer join DBCUSTSUPP Cs on Cs.KODECUSTSUPP=A.KODESUPP
Left Outer join (Select NOBUKTI,URUT,QNT
                 from DBPODET) PO on PO.NOBUKTI=B.NoPO and PO.URUT=B.UrutPO
where A.NoBukti=@NoBukti 
Group by A.NOBUKTI, A.NOURUT, A.TANGGAL, A.TglJatuhTempo, A.KODESUPP, Cs.NAMACUSTSUPP, 
A.HANDLING, A.KETERANGAN, A.FAKTURSUPP, A.KODEVLS, A.KURS, A.PPN, 
A.TIPEBAYAR, A.HARI, A.TipeDisc, A.DISC, A.DISCRP, A.ISCETAK, A.NilaiCetak, 
A.KodeExp, B.KODEBRG, Br.NAMABRG, Br.NFix,B.NoPO, B.UrutPO,PO.QNT, B.KodeGdg,Br.SAT1, Br.SAT2,B.NOSAT, B.SATUAN, B.ISI--,B.KetReject,B.UrutBeli
--order by case when isnull(B.UrutBeli,0)=0 then B.Urut else B.UrutBeli end


GO

-- Procedure: CetakOpnameBahan
-- Created: 2013-04-12 07:55:25.137 | Modified: 2013-04-12 10:32:36.223
-- =====================================================


CREATE procedure [dbo].[CetakOpnameBahan]
@Nobukti varchar(20)
as
Select A.Nobukti, A.Tanggal, A.note, A.ISCetak, Urut, b.kodebrg, C.namaBrg, A.KodeGdg, D.Nama NamaGDG,
       b.SaldoComp, b.QntOpname, b.Selisih,
       b.Qntdb, B.QntCr, b.Harga, (b.qntdb-b.qntcr)*b.harga as Total,
       (b.qntdb)*b.harga  HrgAdi, (b.qntcr)*b.harga HrgAdo,
       C.Sat1 Satuan,C.Sat2 Satuan2,b.Saldo2Comp, b.Qnt2Opname, b.Selisih2,
       b.Qnt2db, B.Qnt2Cr,Iscek,Iscek2
From dbKoreksi A 
     left outer join dbKoreksiDet B on b.nobukti=a.nobukti 
     left outer join dbBarang C on c.kodebrg=b.kodebrg 
     left outer join dbGudang D on d.kodegdg=A.kodegdg
where A.NoBukti=@NoBukti
order by B.Urut
GO

-- Procedure: CetakPemakaianbahan
-- Created: 2013-04-12 07:56:12.950 | Modified: 2013-04-12 10:23:06.447
-- =====================================================

CREATE procedure [dbo].[CetakPemakaianbahan]
@Nobukti varchar(20)
as
Select 	A.NoBukti,A.Nourut,A.Tanggal,A.Kodegdg,A.NoBPPB,
 B.urut, B.Kodebrg,
 case when B.NoSat=1 then B.Qnt else B.Qnt2 end Qnt,
 B.Qnt Qnt1, B.Qnt2, B.Isi, B.Nosat, B.Sat, D.NamaBrg,
 D.Isi2, D.NFix, B.UrutSPK, B.NoSatSPK,
 Convert(Numeric(18,2),0) Stok, Convert(Numeric(18,2),0) QntBppB, Convert(Numeric(18,2),0) QntBP, Convert(Numeric(18,2),0) sisa,
 ISNULL(A.CetakKe,0)+1 CetakN
From dbPenyerahanBhn A
Left Outer join dbPenyerahanBhnDet B on B.NoBukti=a.NoBukti
Left Outer join dbBarang D on D.KodeBrg=B.Kodebrg
where	A.NoBukti=@NoBukti
order by B.Urut
GO

-- Procedure: CetakPenerimaanACC
-- Created: 2013-04-12 09:13:56.573 | Modified: 2013-04-12 10:32:04.817
-- =====================================================


CREATE Procedure [dbo].[CetakPenerimaanACC]
@NoBukti varchar(20)
as

Select 	A.NoBukti, A.NoUrut, A.Tanggal, A.TglJatuhTempo, A.KodeSupp, C.NamaCustSupp, C.Alamat1, C.Alamat2, C.Kota,
        C.Alamat1+Char(13)+C.Alamat2+Char(13)+C.kota Alamat,
	B.KodeGdg, F.Nama, A.Handling/*, A.KodeExp, G.NamaExp*/, A.Keterangan, A.FakturSupp,
	A.KodeVls, D.NamaVls, A.Kurs, A.PPN, A.TipeBayar, A.Hari, A.TipeDisc, A.Disc, A.DiscRp,
	B.Urut, B.KodeBrg, E.NamaBrg, B.Satuan, B.Qnt, B.NoSat, B.Isi, B.Harga, b.HrgNetto, B.DiscP, B.DiscTot,
	B.BYAngkut Beban,
	b.NoPO,b.UrutPO,
        H.TotDiskon, H.TotDPP, H.TotPPN, H.TotNet,
        Case when A.Kodevls='IDR' then B.SubTotalRp  else B.SubTotal end Total,
        Case when A.Kodevls='IDR' then I.TotDiskonRp  else I.TotDiskon end Diskon,
        Case when A.Kodevls='IDR' then I.TotDPPRp  else I.TotDPP end TotalDPP,
        Case when A.Kodevls='IDR' then I.TotPPnRp  else I.TotPPn end TotalPPn,
        Case when A.Kodevls='IDR' then I.TotNetRp  else I.TotNet end TotalNetto,
    Isnull(NilaiCetak,0)+1 NCetak
From dbBeli A
Left Outer join dbBeliDet B on B.NoBukti=a.NoBukti
Left Outer Join dbCustSupp C on c.KodeCustSupp=a.KodeSupp
Left Outer join dbValas D on D.KodeVls=A.KodeVls
Left Outer join dbBarang E on E.KodeBrg=B.KodeBrg
Left Outer Join dbGudang F on F.KodeGdg=B.KodeGdg
--Left Outer Join dbExpedisi G on G.KodeExp=A.KodeExp
Left Outer Join vwMasterBeli H on H.NoBukti=A.NoBukti
Left Outer Join vwRpDetBeli I on I.NoBukti=A.NoBukti
where	A.NoBukti=@NoBukti
GO

-- Procedure: CetakPenerimaangudang
-- Created: 2013-04-23 13:17:07.770 | Modified: 2013-04-23 16:46:03.177
-- =====================================================
CREATE Procedure [dbo].[CetakPenerimaangudang]
 @NoBukti varchar(20)
as

select	A.NOBUKTI, A.NOURUT, A.TANGGAL, A.TglJatuhTempo, A.KODESUPP, Cs.NAMACUSTSUPP, 
A.HANDLING, A.KETERANGAN, A.FAKTURSUPP, A.KODEVLS, A.KURS, A.PPN, 
A.TIPEBAYAR, A.HARI, A.TipeDisc, A.DISC, A.DISCRP, A.ISCETAK, A.NilaiCetak, 
A.KodeExp, B.URUT, B.KODEBRG, Br.NAMABRG, Br.NFix, B.QNT, B.NOSAT, B.SATUAN, B.ISI, 
B.HARGA, B.DISCP, B.DISCTOT, B.BYANGKUT, B.HRGNETTO, B.NDISKON, B.SUBTOTAL, 
B.NDPP, B.NPPN, B.NNET, B.NoPO, B.UrutPO, PO.QNT QntPO,
B.HPP, B.KodeGdg,
B.QntTerima, B.Qnt1Terima, B.Qnt2Terima,ISNULL(A.nilaiCetak,0) + 1 Ncetak
from DBBELI A
left outer join DBBELIDET B on B.NOBUKTI=A.NOBUKTI
left outer join DBBARANG Br on Br.KODEBRG=B.KODEBRG
left outer join DBCUSTSUPP Cs on Cs.KODECUSTSUPP=A.KODESUPP
Left Outer join (Select NOBUKTI,URUT,QNT
                 from DBPODET) PO on PO.NOBUKTI=B.NoPO and PO.URUT=B.UrutPO
where A.NoBukti=@NoBukti and isnull(B.UrutBeli,0)=0
order by B.Urut



GO

-- Procedure: CetakPenyerahanbarang
-- Created: 2013-04-12 09:15:10.930 | Modified: 2013-04-12 11:17:03.070
-- =====================================================

CREATE procedure [dbo].[CetakPenyerahanbarang]
@Nobukti varchar(20)
as
select	A.NOBUKTI, A.NOURUT, A.TANGGAL, A.KDDEP, Dp.NMDEP, A.KodeGdg, A.KodeGdgT, A.NoBPPB,
B.UrutBPPB, B.NoSatBPPB, B.URUT, B.KODEBRG, Br.NAMABRG, Br.NFix,
case when B.NoSat=1 then B.Qnt else B.Qnt2 end QNT,
B.Qnt Qnt1, B.NOSAT, B.SATUAN, B.ISI, B.Qnt2, B.Qnt2M, B.Qnt2P,
ISNULL(A.cetakke,0) + 1 cetakN
from DBBPPBT A
left outer join DBBPPBTDET B on B.NOBUKTI=A.NOBUKTI
left outer join DBBARANG Br on Br.KODEBRG=B.KODEBRG
left outer join DBDEPART Dp on Dp.KDDEP=A.KDDEP
where A.NOBUKTI=@NoBukti
order by B.Urut
GO

-- Procedure: CetakPerintahKirim
-- Created: 2013-04-12 09:15:34.507 | Modified: 2013-04-12 10:30:19.277
-- =====================================================

CREATE Procedure [dbo].[CetakPerintahKirim]
@nobukti varchar(20)
as
select a.NoBukti,a.NoSO NoSC,b.NoPesan,b.Tanggal,a.KodeBrg,d.NAMABRG namabrgdbbrg ,a.NamaBrg namabrgdbdet ,''Jns_Kertas,''Ukr_Kertas,
       c.NamaCust NAMACUSTSUPP,c.Alamat,'' ALAMAT1,''ALAMAT2,''ALAMATPKP1,'' ALAMATPKP2,c.kodekota Kota,
       case when a.NOSAT = 1 then a.SAT_1 else a.SAT_2 end satuan,
       case when a.NOSAT = 1 then a.QNT else a.QNT2 end QNT,
       b.TglKirim,'' ShippingMark,b.NoLC,b.Packing,b.Catatan, a.Urut
from 
dbSPPDet a 
left outer join dbSPP b on a.NoBukti = b.NoBukti
Left Outer Join vwOutSO_SPP E on E.Nobukti=a.NoSO and E.urut=a.UrutSO
Left Outer join DBSO G on G.Nobukti=A.NoSO
left outer join vwBrowsCustomer c on b.KodeCustSupp = c.KODECUST and c.Sales=G.KODESLS
left outer join DBBARANG d on a.KodeBrg = d.KODEBRG
where A.NoBukti=@nobukti

GO

-- Procedure: CetakpermintaanBahan
-- Created: 2013-04-12 09:15:53.927 | Modified: 2013-04-12 11:16:09.053
-- =====================================================

CREATE procedure [dbo].[CetakpermintaanBahan]
@Nobukti varchar(20)
as

select	A.NOBUKTI, A.NOURUT, A.TANGGAL, A.KDDEP, Dp.NMDEP, A.KodeGdg, A.KodeGdgT, 
B.URUT, B.KODEBRG, Br.NAMABRG, Br.NFix,
case when B.NoSat=1 then B.Qnt else B.Qnt2 end QNT,
B.Qnt Qnt1, B.NOSAT, B.SATUAN, B.ISI, B.Qnt2, B.Qnt2M, B.Qnt2P,
isnull(A.cetakke,0) + 1 CetakN
from DBBPPB A
left outer join DBBPPBDET B on B.NOBUKTI=A.NOBUKTI
left outer join DBBARANG Br on Br.KODEBRG=B.KODEBRG
left outer join DBDEPART Dp on Dp.KDDEP=A.KDDEP
where A.NOBUKTI=@NoBukti
order by B.Urut

GO

-- Procedure: CetakPR
-- Created: 2013-04-12 10:29:13.690 | Modified: 2013-04-12 10:29:13.690
-- =====================================================

CREATE Procedure [dbo].[CetakPR]
@NoBukti varchar(50)
as
--select 	@NoBukti=''
Select 	A.*,B.*, D.Namabrg, C.NMDep,D.KOdeBrg,A.cetakke + 1 CetakN
From dbPPL A
Left Outer join dbPPLDet B on B.NoBukti=a.NoBukti
Left Outer join dbBarang D on D.KodeBrg=B.Kodebrg
Left Outer join dbDepart C on C.KdDep=A.KDDep
where	A.NoBukti=@NoBukti
order by B.Urut
GO

-- Procedure: CetakProsesBuatSPB
-- Created: 2013-04-12 10:28:46.297 | Modified: 2013-04-12 10:28:46.297
-- =====================================================

Create Procedure [dbo].[CetakProsesBuatSPB]
@Nobukti varchar(300)
as
Select 	A.NoBukti, A.NOURUT, A.Tanggal, A.KodecustSupp KodeCUST, C.NamaCUST, C.Alamat, J.Alamat AlamatKirim, 
	B.KodeGdg, A.Catatan, 
	B.Urut, B.UrutSO, B.KodeBrg, H.NamaBrg, B.Qnt Qnt1, 
	Case when B.Nosat=1 then B.Qnt when B.Nosat=2 then B.Qnt2 else 0 End Qnt,
	Case when B.Nosat=1 then H.Sat1 when B.Nosat=2 then H.Sat2 else '' End  Satuan, 
 B.Qnt2, H.Sat2 SatuanRoll,  
	case when B.Qnt2=0 then B.Qnt else B.Qnt2 end QntTampil, 
	case when B.Qnt2=0 then H.Sat1 else H.Sat2 end SatuanTampil
From dbSPP A 
Left Outer join dbSPPDet B on B.NoBukti=a.NoBukti 
Left Outer join dbSO SO on SO.Nobukti=B.Noso
Left Outer Join vwBrowsCustomer C on c.KodeCust=a.KodeCustsupp and c.Sales=SO.Kodesls 
left outer join dbKaryawan F on F.KeyNik=SO.KodeSls 
Left Outer Join vwSatuanBrg H on H.KodeBrg=B.KodeBrg 
left outer join vwAlamatCust J on J.KodeCustSupp=A.KodeCustSupp and J.Nomor=A.NoAlamatKirim 
where A.NoBukti in (@Nobukti)
order by A.NoBukti, B.Urut 

GO

-- Procedure: CetakRevisiPO
-- Created: 2013-04-12 10:27:56.760 | Modified: 2013-04-12 10:27:56.760
-- =====================================================

Create Procedure [dbo].[CetakRevisiPO]
@NoBukti varchar(20)
As
--select 	@NoBukti='VSM/052009/00001/PO '
Select 	A.NoBukti, A.NoUrut, A.Tanggal, A.TglJatuhTempo, A.KodeSupp, C.NamaCustSupp, C.Alamat1, C.Alamat2, C.Kota,
        C.Alamat1+Char(13)+C.Alamat2+Char(13)+C.kota Alamat,
	A.Handling, A.Keterangan, A.FakturSupp,IsExp,J.Tanggal TglKirim,
	A.KodeVls, D.NamaVls, A.Kurs, A.PPN, A.TipeBayar, A.Hari, A.Disc,
	B.Urut, B.KodeBrg, E.NamaBrg, B.Satuan, B.Qnt, B.Nosat, B.Isi,
        B.Harga, B.DISCP, B.DISCTOT,NoPPL,A.IsClose,B.IsClose IsCloseD,
        case when A.Kurs=1 then 0.0 else B.SubTotal end TotalUSD,a.KodeExp,F.NamaExp,
	round(B.SubTotal*A.Kurs,2) TotalIDR, round(B.NDPP*A.Kurs,2) NDPP,
        round(B.NPPN*A.Kurs,2) NPPN,isnull(Tolerate,0) Tolerate,
	B.BYAngkut Beban,
	round(B.SubTotal*A.Kurs,2) + B.BYAngkut Total,
        H.TotDiskon, H.TotDPP, H.TotPPN, H.TotNet
From dbPO A
Left Outer join dbPODet B on B.NoBukti=a.NoBukti
Left Outer Join dbCustSupp C on c.KodeCustSupp=a.KodeSupp
Left Outer join dbValas D on D.KodeVls=A.KodeVls
Left Outer join dbBarang E on E.KodeBrg=B.KodeBrg
Left Outer join dbExpedisi F On F.KodeExp=A.KodeExp
Left Outer Join vwMasterPO H on H.NoBukti=A.NoBukti
Left Outer Join (select NoBukti,KodeBrg,Max(Tanggal)Tanggal from DBKirimDET group By NoBukti,KodeBrg) J On J.KodeBrg=B.KodeBrg and J.NoBukti=B.NoBukti
where	A.NoBukti=@NoBukti
order by B.Urut
GO

-- Procedure: CetakRPemakaianbahan
-- Created: 2013-04-12 10:27:13.177 | Modified: 2013-04-12 10:27:13.177
-- =====================================================

create procedure [dbo].[CetakRPemakaianbahan]
@Nobukti varchar(20)
as

Select 	d.Isi2,d.Nfix,A.NoBukti,A.Nourut,A.Tanggal,A.Kodegdg,A.NoPenyerahanBhn,B.urut,B.Kodebrg,B.Qnt,Qnt2,B.Isi,B.Nosat,B.Sat,D.NamaBrg,Convert(Numeric(18,2),0) Stok,Convert(Numeric(18,2),0) Stok2,Convert(Numeric(18,2),0) QntBP,Convert(Numeric(18,2),0) Qnt2BP
,Convert(Numeric(18,2),0) QntRBP,Convert(Numeric(18,2),0) Qnt2RBP,Convert(Numeric(18,2),0) sisa
From dbRPenyerahanBhn A
Left Outer join dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
Left Outer join dbBarang D on D.KodeBrg=B.Kodebrg
where	A.NoBukti=@NoBukti
order by B.Urut
GO

-- Procedure: CetakRpenjualaninvoice
-- Created: 2013-04-12 10:26:41.663 | Modified: 2013-04-12 10:26:41.663
-- =====================================================

Create procedure [dbo].[CetakRpenjualaninvoice]
@nobukti varchar(200)
as
Select A.NOBUKTI, A.TANGGAL, B.NamaBrg,'' Ukr_Kertas,0.00 GSM, A.NoSO, A.TglSO, A.NoLKP, A.TGLLKP,
       B.NoSPB,d.Tanggal TglSPB, A.KODECUSTSUPP, C.NamaCust NAMACUSTSUPP, null TglRencanaPenarikan, null TglPengesahan,
       F.NoBukti NoSPR, F.Tanggal TglSPR, B.URUT, 
       Case when B.Nosat=1 then B.QNT
            when B.Nosat=2 then B.QNT2
            else 0
       End QntRPJ,
       Case when B.Nosat=1 then B.SAT_1
            when B.Nosat=2 then B.SAT_2
            else ''
       End SatRPJ,
       Case when F.Nosat=1 then F.QNT
            when F.Nosat=2 then F.QNT2
            else 0
       End QntSPR,
       Case when F.Nosat=1 then F.SAT_1
            when F.Nosat=2 then F.SAT_2
            else ''
       End SatSPR
From DBRInvoicePL A
     left outer join DBRInvoicePLDET B on B.NOBUKTI=A.NOBUKTI        
     left outer join (Select x0.NoBukti, x0.Urut, z.Tanggal, z.NoBukti NoSPB, x1.KODESLS, x1.KODECUST
                      from dbInvoicePLDet x0
                           left outer join dbSPBDet y on y.NoBukti=x0.Nospb and y.Urut=x0.UrutSPB
                           left outer join dbSPB z on z.NoBukti=y.NoBukti
                           left outer join dbSPPDet x on x.NoBukti=y.NoSPP and x.Urut=y.UrutSPP
                           left Outer join DBSO x1 on x1.NOBUKTI=x.NoSO
                           ) d on d.NoBukti=B.NoInvoice and d.Urut=B.UrutInvoice --and d.NoSPB=B.NoSPB
     left outer join DBBARANG E on E.KODEBRG=B.KODEBRG
     left outer join (Select x.NoBukti,x.Tanggal, y.NoRPJ, y.UrutRPJ, y.QNT, y.QNT2, y.SAT_1, y.SAT_2, y.NOSAT
                      from dbSPBRJual x
                           left outer join dbSPBRJualDet y on y.NoBukti=x.NoBukti) F on F.NoRPJ=b.NOBUKTI and F.UrutRPJ=B.URUT
     left outer join vwBrowsCustomer C on C.KODECUST=A.KODECUSTSUPP and C.Sales=d.KODESLS
where A.NOBUKTI=@nobukti


GO

-- Procedure: CetakRSPB
-- Created: 2013-04-12 10:26:17.843 | Modified: 2013-04-12 10:26:17.843
-- =====================================================

Create procedure [dbo].[CetakRSPB]
@Nobukti varchar(20)
as
select A.NOBUKTI, A.NOURUT, A.TANGGAL, A.KODECUSTSUPP, 
       Case when D.USAHA<>'' then D.USAHA+'. ' else '' end+D.NamaCust NamaCustSupp, 
       D.Alamat, D.NamaKota Kota, '' NEGARA,
        A0.NoSPP, A.NoPolKend,
        A.Container, A.NoContainer, A.NoSeal,
        A.ISCETAK, A.IDUser,
        B.URUT, B.KODEBRG, C.Namabrg, '' Jns_Kertas,'' Ukr_Kertas, B.QNT, B.QNT2, B.SAT_1, B.SAT_2, B.NoSat, B.ISI,
        Ax.UrutSPP, E.NoSO,E.TglSO,E.NOPO NoPesanan, A1.NamaKirim, A1.AlamatKirim,
        (Select NOSPB from DBNOMOR) NODOK, B.Namabrg NamaBrgkom,
         case when B.NOSAT = 1 then b.SAT_1 else b.SAT_2 end as satuanas,
         case when B.NOSAT = 1 then B.QNT else b.QNT2 end as QNTAS,
        A.Catatan, b.NetW, b.GrossW, A0.sopir
From DBRSPB A
left outer join dbSPB A0 on a.NoSPB = a0.NoBukti
left outer join dbSPBDet ax on a0.NoBukti = ax.NoBukti
left outer join dbSPP A1 on A1.NoBukti=A0.NoSPP
Left Outer Join (Select Nobukti, NoSO from dbSPPDet Group by NoBukti,NoSO) A2 on A2.NoBukti=A1.nobukti
Left Outer Join DBRSPBDET B on B.NoBukti=A.NoBukti
Left Outer Join dbBarang c On C.KodeBrg=B.KodeBrg
Left Outer Join vwBrowsCustomer D On D.KodeCust=A.KodeCustSupp
Left Outer join (Select y.Nobukti NoSO,y.Tanggal TglSO, y.NoPesanan Nopo
                 from DBSO y
                 group by y.Nobukti,y.Tanggal, y.NoPesanan) E on E.NoSO=A2.NoSo
where A.NoBukti =@Nobukti



GO

-- Procedure: CetakRSPBLampiran
-- Created: 2013-04-12 10:25:44.043 | Modified: 2013-04-12 10:25:44.043
-- =====================================================

Create Procedure [dbo].[CetakRSPBLampiran] 
@Nobukti varchar(20)
as
Select Case when A.NOROLL<>'' then A.NOROLL+' ' else '' end+
       Case when A.NOPALLET<>'' then A.NOPALLET+' ' else '' end+ 
       Case when A.NOLOT<>'' then A.NOLOT+' ' else '' end       
        NoLot, 
       B.Namabrg NamaBrgKom, C.Jns_Kertas, C.Ukr_Kertas, C.GSM,
       A.Qnt,A.Qnt2, A.Sat_1, A.Sat_2, A.NetW, A.GrossW, A.Keterangan,
       B.NoBukti,B.Tanggal, B.NoPolKend, B.NoContainer, B.NoSeal, A.Urut, A.UrutSPB,
       Case when A.Nosat=1 then a.Qnt
            when a.Nosat=2 then a.Qnt2
            else 0
       end Qty,
       Case when A.Nosat=1 then a.Sat_1
            when a.Nosat=2 then a.Sat_2
            else ''
       end Satuan,
       (Select NoSPB from dbnomor) NODok
From dbSPBLampiran A
     left Outer join (Select y.NoBukti, Y.Tanggal, y.NoContainer, y.NoPolKend, y.NoSeal,
                             x.Urut, x.KodeBrg, x.Namabrg
                      from dbRSPBDet x
                           left Outer join dbSPB y on y.NoBukti=x.NoBukti
                      ) B on B.NoBukti=A.NoSPB and B.Urut=A.UrutSPB
     left Outer join (Select kodebrg, namabrg, SAT1, Sat2, '' Jns_Kertas, '' Ukr_Kertas, 0.00 GSM from DBBARANG) C on C.KODEBRG=B.KodeBrg




GO

-- Procedure: CetakSPK
-- Created: 2013-04-12 10:22:12.247 | Modified: 2013-04-12 10:22:12.247
-- =====================================================


Create procedure [dbo].[CetakSPK]
@Nobukti varchar(20)
as

Select 	B.urut,A.NoBukti, A.NoBatch, A.TglExpired, A.tanggal,Right(A.NoBukti,4) NoUrut,
A.KodeBrg BrgJ,A.Qnt QntJ,A.Nosat NosatJ, A.Isi IsiJ,A.Satuan SatJ,B.KodeBrg ,B.Qnt,B.Satuan,B.isi,B.Nosat,E.NamaBrg NamaBrgJ,D.NamaBrg,
isnull(A.Cetakke,0)+1 CetakN
From dbSPK A
Left Outer join dbSPKDet B on B.NoBukti=a.NoBukti
Left Outer join dbBarang E on E.KodeBrg=A.Kodebrg
Left Outer join dbBarang D on D.KodeBrg=B.Kodebrg
where	A.NoBukti=@NoBukti
order by B.Urut

GO

-- Procedure: Cetakspp
-- Created: 2013-04-12 10:25:04.810 | Modified: 2013-04-12 10:25:04.810
-- =====================================================


Create procedure [dbo].[Cetakspp]
@Nobukti varchar(30)
as

select A.NOBUKTI, A.NOURUT, A.TANGGAL, A.TglKirim, A.KODECUSTSUPP, D.namaCust NamaCustSupp, D.Alamat, D.kodekota Kota,
        A.NOSHIP, A.NOPESAN, B.ShippingMark,
        A.NoLC, A.Catatan,
        A.ISCETAK, A.IDUser,
        B.URUT, B.KODEBRG, C.NamaBrg,  B.QNT QNT1, B.QNT2, B.SAT_1, B.SAT_2, B.NoSat, B.ISI,
        B.KetDetail, B.UrutSO, B.NetW, b.GrossW, G.NOBUKTI NoSO, '' NOPO, B.Namabrg NamabrgKom, B.Mesurement,
        A.NamaKirim, A.Alamatkirim, Case when B.nosat=1 then B.Sat_1 when B.nosat=2 then B.Sat_2 else '' end Satuan,
        A.NoAlamatkirim, B.kodegdg,
        Case when B.nosat=1 then B.Qnt when B.nosat=2 then B.Qnt2 else 0 end Qnt,
        Isnull(A.Cetakke ,0) + 1 Ncetak
From DBSPP A
Left Outer Join DBSPPDET B on B.NoBukti=A.NoBukti
Left Outer join dbSO G on G.Nobukti=B.NoSO
Left Outer Join dbBarang c On C.KodeBrg=B.KodeBrg
Left Outer Join vwBrowsCustomer D On D.KodeCust=A.KodeCustSupp and D.Sales=G.KODESLS
Left Outer Join vwOutSO_SPP E on E.Nobukti=B.NoSO and E.urut=B.UrutSO
where a.NoBukti=@NoBukti
order By B.Urut

GO

-- Procedure: CetakTransfer
-- Created: 2013-07-11 16:31:12.610 | Modified: 2013-07-11 16:31:12.610
-- =====================================================
CREATE procedure [dbo].[CetakTransfer]
@Nobukti varchar(20)
as
Select A.Nobukti, A.Tanggal, A.NOTE, B.Urut, B.KODEBRG, C.NAMABRG, 
	B.GDGASAL, D1.Nama NamaGdgAsal, B.GDGTUJUAN, D2.NAMA NamaGdgTujuan,
	B.QNT QNT1, B.QNT2, B.SAT_1, B.SAT_2, C.SAT1 SATUAN1, C.SAT2 SATUAN2 
From DBTRANSFER A 
     left outer join DBTRANSFERDET B on B.NOBUKTI=A.NOBUKTI 
     left outer join dbBarang C on C.KODEBRG=B.KODEBRG 
     left outer join dbGudang D1 on D1.KODEGDG=B.GDGASAL
     left outer join DBGUDANG D2 on D2.KODEGDG=B.GDGTUJUAN
where A.NoBukti=@NoBukti
order by B.Urut

GO

-- Procedure: CetakTTInvoicePenjualan
-- Created: 2013-07-11 14:24:52.037 | Modified: 2015-03-13 14:55:46.100
-- =====================================================

CREATE procedure [dbo].[CetakTTInvoicePenjualan]
--declare 
@nobukti varchar(20)
as
--select @nobukti='SJY/INVC/0713/00005'
Select A.NoBukti, A.NoUrut, A.Tanggal, A.PPN, A.Valas, A.Kurs, A.KodeCustSupp, A.Consignee, A.NotifyParty, A.StuffingDate, 
       A.StuffingPlace, H.Nobukti ContractNo, A.PONo, h.HARI PaymentTerm, 
       A.DocCreditNo, A.PoL, A.PoD, A.NameOfVessel, A.Feeder_Vessel, A.Connect_Vessel, A.ShipOnBoardDate, A.Packing, 
       A.Others, A.IsCetak, A.IDUser, A.IsLokal, A.NoBL, A.NoteBeneficiary1, 
       A.NoteBeneficiary2, A.NoteBeneficiary3, A.ShipmentAdvice1, A.ShipmentAdvice2, A.ETADestination, A.ToShipmentAdvice2, A.NoPajak, A.TglFPJ, 
       A.Footnote, A.IssuingBank, A.MyID, 
       A.IsOtorisasi1, A.OtoUser1, A.TglOto1,
       A.IsOtorisasi2, A.OtoUser2, A.TglOto2, 
       A.IsOtorisasi3, A.OtoUser3, A.TglOto3, 
       A.IsOtorisasi4, A.OtoUser4, A.TglOto4, 
       
       A.IsOtorisasi5, A.OtoUser5, A.TglOto5,
       B.Kodebrg,B.Namabrg NamaBrgkom,
       Sum(Case when B.NOSAT=1 then B.QNT
            when B.NOSAT=2 then B.QNT2
            else 0
       end) Qty,
      (Case when B.NOSAT=1 then B.Sat_1
            when B.NOSAT=2 then B.Sat_2
            else ''
       end) Satuan,Sum(B.Qnt) Qnt, Sum(B.Qnt2) Qnt2, B.Sat_1,
       Case when B.SAT_2='' then B.SAT_1
            else B.SAT_2
       end  Sat_2,B.Nosat,B.Harga,
       Sum(B.NDPP) NDPP, Sum(B.NDPPRp) NDPPRp, Sum(B.NPPN) NPPN, Sum(B.NPPNRp) NPPnRp, Sum(B.NNET) Nnet, Sum(B.NNETRp) NnetRp,
       B.NOSPB ShippingMark, B.KetDetail, B.NetW, B.GrossW, B.Meas,
       E.Namabrg,       
       Case when C.USAHA<>'' then C.USAHA+'. ' else '' end+C.NAMACUSTSUPP NamaCustSupp,
       ltrim(C.ALAMAT1+case when ltrim(C.ALAMAT2)<>'' then char(13)+C.ALAMAT2 else '' end) Alamat,C.Kota,C.USAHA,'' NEGARA, C.TELPON, '' FAX, '' EMAIL,
       B.Urut,Case when B.Nosat=1 then E.Isi2
            when B.Nosat=2 then E.Isi1 
            else 0
       end ISI,Dbo.Terbilang(m1.Tot) TerBIlang,H.TGLJATUHTEMPO,X.Nama NamaSls,B.DiscP,DiscP2,DiscP3,DiscP4,DiscP5      
from dbInvoicePL A
     left outer join dbInvoicePLDet b on b.NoBukti=A.NoBukti     
     left outer join DBBARANG E on E.KODEBRG=B.KodeBrg
     left Outer join (Select x.NoBukti, x.Urut, x.NoSPP
                      from dbSPBDet x
                      Group by x.NoBukti, x.Urut, x.NoSPP) F on F.NoBukti=B.NoSPB and F.Urut=B.UrutSPB
     left outer join (Select NoBukti, NoSO
                      from dbSPPDet x
                      Group by NoBukti, NoSO) G on G.NoBukti=f.NoSPP
     left Outer join DBSO H on H.NoBukti=G.NoSo
     --left outer join vwBrowsCustomer c on c.KODECUST=A.KodeCustSupp and c.Sales=H.KODESLS
     left outer join DBCUSTSUPP c on c.KODECUSTSUPP=A.KodeCustSupp
     LEFT Outer join (select SUM(NNETRp) Tot,Nobukti from dbInvoicePLDet 
						where NoBukti=@nobukti group by NoBukti) m1 on B.NoBukti = m1.NoBukti
	LEFT Outer Join dbKaryawan X on H.KODESLS=X.KeyNIK
     where A.NoBukti=@nobukti
Group by A.NoBukti, A.NoUrut, A.Tanggal, A.PPN, A.Valas, A.Kurs, A.KodeCustSupp, A.Consignee, A.NotifyParty, A.StuffingDate, 
       A.StuffingPlace, A.ContractNo, A.PONo, H.HARI, 
       A.DocCreditNo, A.PoL, A.PoD, A.NameOfVessel, A.Feeder_Vessel, A.Connect_Vessel, A.ShipOnBoardDate, A.Packing, 
       A.Others, A.IsCetak, A.IDUser, A.IsLokal, A.NoBL, A.NoteBeneficiary1, 
       A.NoteBeneficiary2, A.NoteBeneficiary3, A.ShipmentAdvice1, A.ShipmentAdvice2, A.ETADestination, A.ToShipmentAdvice2, A.NoPajak, A.TglFPJ, 
       A.Footnote, A.IssuingBank, A.MyID, 
       A.IsOtorisasi1, A.OtoUser1, A.TglOto1,
       A.IsOtorisasi2, A.OtoUser2, A.TglOto2, 
       A.IsOtorisasi3, A.OtoUser3, A.TglOto3, 
       A.IsOtorisasi4, A.OtoUser4, A.TglOto4, 
       A.IsOtorisasi5, A.OtoUser5, A.TglOto5,
       B.Kodebrg,B.Namabrg,B.NOSAT, B.SAT_1,B.NoSPB,
       B.SAT_2, B.Harga,m1.Tot,
       Case when B.Nosat=1 then E.ISI2
            when B.Nosat=2 then E.ISI1 
            else 0
       end,
       
       B.ShippingMark, B.KetDetail, B.NetW, B.GrossW, B.Meas,
       E.Namabrg,       
       Case when C.USAHA<>'' then C.USAHA+'. ' else '' end+C.NAMACUSTSUPP,
       C.Alamat1, C.ALAMAT2, C.Kota, C.USAHA, C.TELPON, C.KODEPOS, B.Urut,
       H.nobukti,H.TGLJATUHTEMPO,X.Nama,B.DiscP,DiscP2,DiscP3,DiscP4,DiscP5






GO

-- Procedure: hapusdata
-- Created: 2014-05-13 08:28:36.897 | Modified: 2014-05-13 08:28:36.897
-- =====================================================

CREATE Procedure [dbo].[hapusdata]

as
delete dbbelidet
delete DBBELI
delete DBPODET
delete DBPO
delete DBPORevDET
delete DBPORev
delete DBPPLDET
delete DBPPL
delete DBRBELIDET
delete DBRBELI
delete DBBPPBDET
delete DBBPPB

delete dbInvoicePLDet
delete DBInvoicePL
delete dbSPBDet
delete dbSPB
delete DBRSPBDet
delete DBRSPB
delete dbSPPDet
delete dbSPP
delete DBSODET
delete DBSO
delete DBSORevisiDET
delete DBSORevisi
delete DBRInvoicePLDET
delete DBRInvoicePL

delete DBKreditNoteDET
delete DBKreditNote
delete DBDebetNoteDET
delete DBDebetNote

delete DBTRANSFERDET
delete DBTRANSFER
delete DBKOREKSIDET
delete DBKOREKSI
delete DBUBAHKEMASANDET
delete DBUBAHKEMASAN

delete DBPenyerahanBhnDET
delete DBPenyerahanBhn
delete DBRPenyerahanBhnDET
delete DBRPenyerahanBhn

delete DBHASILPRDDET
delete DBHASILPRD
delete DBSPKDET
delete DBSPKBJDET
delete DBSPK
delete DBBOMDET
delete DBBOM

delete dbTransaksi
delete DBTRANS
delete DBBON
delete DBHUTPIUT
delete DBGIRO
delete DBAKTIVADET
delete DBAKTIVA
delete DBLRHPP
delete DBNERACA

delete dbHPPProduksi
delete DBAREA
delete DBASM
delete DBAreaKotaPrd
delete DBCustAreaKota

delete DBGROUP
delete dbKaryawan
delete DBSALESCUSTOMER
delete DBSalesCustPrd
delete DBSUBJENIS
delete DBSUBJENISBRGJADI
delete DBSUBKATEGORI
delete DBSUBKATEGORIBRGJADI
delete DBSUBTIPETRANS
delete DBBAGIAN
delete DBDEPART
delete DBJABATAN
delete DBDATABARANG

delete DBSTOCKBRG
delete DBBARANGCUSTOMER
delete DBBARANGLOKASI
delete DBCUSTSUPP
delete DBBARANG
delete DBPERKIRAAN

delete DBPemakaiGdg
delete DBFLPASS where USERID<>'SA'
delete DBAKSESPERKIRAAN where USERID<>'SA'
delete DBFLMENUREPORT where USERID<>'SA'
delete DBflMENU where USERID<>'SA'
GO

-- Procedure: ProsesAktiva
-- Created: 2012-11-05 10:19:51.710 | Modified: 2023-03-28 13:01:24.813
-- =====================================================




CREATE Procedure [dbo].[ProsesAktiva]
@Bulan int,
@Tahun int,
@Devisi Varchar(15),
@UserID Varchar(15),
@Tanggal Datetime,
@KodeAktiva varchar(30),
@KodeBag varchar(15),
@Keterangan Varchar(8000),
@Susut numeric(18,2),
@Metode varchar(1),
@Akumulasi varchar(25),
@Biaya1 varchar(25),
@Persenbiaya1 numeric(18,2),
@Biaya2 varchar(25),
@Persenbiaya2 Numeric(18,2),
@Biaya3 varchar(25),
@Persenbiaya3 numeric(18,2),
@Biaya4 varchar(25),
@Persenbiaya4 Numeric(18,2),
@TipeAktiva tinyint,
@NoBukti varchar(30),
@Nourut varchar(5),
@TglPerolehan datetime
As
Declare @SaldoPerolehan Numeric(18,2),@SaldoPenyusutan numeric(18,2),
        @SaldoPerolehanD Numeric(18,2),@SaldoPenyusutanD numeric(18,2),
        @Penyusutan Numeric(18,2), @PenyusutanD Numeric(18,2),
        @nPenyusutan Numeric(18,2), @nPenyusutanD Numeric(18,2), @urut int,
        @Ket varchar(8000),@Ket2 varchar(8000)
        
--delete dbTransaksi where MONTH(Tanggal)=@bulan and YEAR(Tanggal)=@Tahun and KodeL='akm'        
update DBAKTIVADET set SD=0 where Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun
        
Select @SaldoPerolehan=Awal+(MD-MK), @SaldoPerolehanD=AwalD+(DMD-DMK),
       @SaldoPenyusutan=AwalSusut, @SaldoPenyusutanD=AwalSusutD
from DBAKTIVADET A
where A.Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun

if @TglPerolehan<=@Tanggal--convert(datetime, convert(varchar(2),@bulan)+'-15-'+convert(varchar(4),@tahun))
begin
  if @SaldoPerolehan-@SaldoPenyusutan<=1
  begin
  set @Penyusutan=0
  end
  else
  begin
	If @Metode='L'
	begin
	  Set @Penyusutan=(@SaldoPerolehan*(@Susut/100))/12  
	end
	else if @Metode='M'
	begin
	  Set @Penyusutan=((@SaldoPerolehan-@SaldoPenyusutan)*(@Susut/100))/12
	end
	else if @Metode='P'
	begin
	  Select @SaldoPenyusutan=Case when @Bulan=1 then ((@SaldoPerolehan-@SaldoPenyusutan)*(@Susut/100))/12
											 when A.SK=0 then (@SaldoPerolehan*(@Susut/100))/12
											 when A.SK<>0 then A.SK
											 else 0
									  end/*,
				@SaldoPenyusutanD=Case when @Bulan=1 then ((@SaldoPerolehanD-@SaldoPenyusutanD)*(@Susut/100))/12
											  when A.DSK=0 then (@SaldoPerolehanD*(@Susut/100))/12
											  when A.DSK<>0 then A.DSK
											  else 0
										end */                           
	                          
	  From DBAKTIVADET A         
	  where A.Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun                      
	end
	Set @Penyusutan=Case when @SaldoPerolehan-@SaldoPenyusutan<=1 then 0
								when @SaldoPerolehan-(@SaldoPenyusutan+@Penyusutan)<=1 then @SaldoPerolehan-@SaldoPenyusutan-1.0
								when @TipeAktiva=1 then @SaldoPerolehan
								else @Penyusutan
						 end
  end
 					  
	If @Penyusutan>1
	begin
	  set @Ket2='Akumulasi Penyusutan Aktiva Periode '+Case when @bulan<10 then '0' else '' end+Cast(@bulan as varchar(2))+'-'+Cast(@tahun as varchar(4))
	  if @Biaya2 in ('','-') and @Biaya3 in ('','-') and @Biaya4 in ('','-')
		  select @nPenyusutan=@Penyusutan--, @nPenyusutanD=@PenyusutanD
	  else
		  select @nPenyusutan=@Penyusutan*(@Persenbiaya1/100)
	  set @Ket='Akm. Pny. '+@Keterangan+' ('+@KodeAktiva+') pada : '+@Biaya1+' dgn Persentase : '+CAST(@Persenbiaya1 as varchar(50))+' %'
	  if @Biaya1 not in ('-','')
	  exec SP_Transaksi 'I', @NoBukti,@Nourut, @Tanggal,@Ket2,0,
								@Devisi, @Biaya1, @Akumulasi, @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
								'BJK','C','','',@urut,'',@kodeAktiva,'','AKM-','',@kodebag,'','AKM','',''
	                     
	  if @Biaya2 not in ('','-')
	  begin
		  set @Ket='Akm. Pny. '+@Keterangan+' ('+@KodeAktiva+') pada : '+@Biaya2+' dgn Persentase : '+CAST(@Persenbiaya2 as varchar(50))+' %'
		  Set @nPenyusutan=@Penyusutan*(@Persenbiaya2/100)
		  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,@Ket2,0,
								@Devisi, @Biaya2, @Akumulasi, @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
								'BJK','C','','',@urut,'',@kodeAktiva,'','AKM-','',@kodebag,'','AKM','',''
	  end
	  
	  if @Biaya3 not in ('','-')
	  begin
		  set @Ket='Akm. Pny. '+@Keterangan+' ('+@KodeAktiva+') pada : '+@Biaya3+' dgn Persentase : '+CAST(@Persenbiaya3 as varchar(50))+' %'
		  Set @nPenyusutan=@Penyusutan*(@Persenbiaya3/100)
		  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,@Ket2,0,
								@Devisi, @Biaya3, @Akumulasi, @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
								'BJK','C','','',@urut,'',@kodeAktiva,'','AKM-','',@kodebag,'','AKM','',''
	  end
	  
	  if @Biaya4 not in ('','-')
	  begin
		  set @Ket='Akm. Pny. '+@Keterangan+' ('+@KodeAktiva+') pada : '+@Biaya4+' dgn Persentase : '+CAST(@Persenbiaya4 as varchar(50))+' %'
		  Set @nPenyusutan=@Penyusutan*(@Persenbiaya4/100)
		  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,@Ket2,0,
								@Devisi, @Biaya4, @Akumulasi, @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
								'BJK','C','','',@urut,'',@kodeAktiva,'','AKM-','',@kodebag,'','AKM','',''
	  end
	end
	update DBAKTIVADET set SK=@Penyusutan where Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun  
	
end
           
Select @SaldoPerolehan=A.Akhir,@SaldoPerolehanD=A.AkhirD,@SaldoPenyusutan=A.AkhirSusut,@SaldoPenyusutanD=A.AkhirSusutD
from DBAKTIVADET A
where A.Perkiraan=@KodeAktiva and A.Devisi=@Devisi and A.Bulan=@Bulan and A.Tahun=@Tahun

update DBAKTIVADET set Awal=@SaldoPerolehan,AwalD=@SaldoPerolehanD,AwalSusut=@SaldoPenyusutan,AwalSusutD=@SaldoPenyusutanD
where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
                      Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
                      Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end
     
Insert into DBAKTIVADET(Perkiraan,Devisi,Bulan,Tahun,Awal,AwalD,AwalSusut,AwalSusutD,Valas,Kurs)
Select Perkiraan,Devisi,Case when @Bulan=12 then 1 else @Bulan+1 end, Case when @Bulan=12 then @Tahun+1 else @Tahun end,
      Akhir,AkhirD,AkhirSusut,AkhirSusutD,Valas,Kurs
from DBAKTIVADET    
where Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun and 
     not exists(Select Perkiraan 
                from DBAKTIVADET 
                where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
                      Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
                      Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end)



GO

-- Procedure: ProsesInvestasi
-- Created: 2024-01-15 23:52:53.673 | Modified: 2025-08-12 05:37:40.503
-- =====================================================

CREATE Procedure [dbo].[ProsesInvestasi]
@Bulan int,--1
@Tahun int,
@Devisi Varchar(15),
@UserID Varchar(15),
@Tanggal Datetime,
@KodeAktiva varchar(30),--6
@Keterangan Varchar(8000),
@Susut numeric(18,2),
@nomuka varchar(25),
@Akumulasi varchar(25)='23000000',
@NoBukti varchar(30),--11
@Nourut varchar(5),
@TglPerolehan datetime,
@Biaya varchar(25)='12060080'
As
Declare @SaldoPerolehan Numeric(18,2),@SaldoPenyusutan numeric(18,2),
        @SaldoPerolehanD Numeric(18,2),@SaldoPenyusutanD numeric(18,2),
        @Penyusutan Numeric(18,2), @PenyusutanD Numeric(18,2),
        @nPenyusutan Numeric(18,2), @nPenyusutanD Numeric(18,2), @urut int,
        @Ket varchar(8000),@Ket2 varchar(8000),@nAkhir Numeric(18,2),@perkiraan varchar(20),
        @nAkhirPasar Numeric(18,2),@Npasarbulanini Numeric(18,2)
--delete dbTransaksi where MONTH(Tanggal)=@bulan and YEAR(Tanggal)=@Tahun and KodeL='akm'        
--update DBAKTIVADET set SD=0 where Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun
/*
	declare CurHapus cursor for
	select Perkiraan,akhir  from DBINVESTASIDET a 
	where A.Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun and akhir>0
	Order by perkiraan
	open CurHapus
	Fetch Next from CurHapus into @KodeAktiva,@nAkhir
	while @@FETCH_STATUS=0
	begin
		Insert into DBINVESTASIDET(Perkiraan,Devisi,Bulan,Tahun,NilaiNominal,Awal,AwalPasar,sk,Valas,Kurs)
		Select Perkiraan,Devisi,Case when @Bulan=12 then 1 else @Bulan+1 end, Case when @Bulan=12 then @Tahun+1 else @Tahun end,
			  NilaiNominal,Awal,SD,akhirpasar   ,Valas,Kurs
		from DBINVESTASIDET   
		where Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun and 
			 not exists(Select Perkiraan 
						from DBINVESTASIDET
						where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
							  Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
							  Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end)	
	end
	close CurHapus
	Deallocate CurHapus	*/
select @nAkhir=akhir,@nPenyusutan=spi,@Npasarbulanini=SD,@nAkhirPasar=AkhirPasar 
from DBINVESTASIDET  where Perkiraan=@KodeAktiva and 
Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun --and Perkiraan like '11020000.%' 
--Perkiraan like '11010000.%' and 
--Perkiraan not like '11020000.%'
--delete dbtrans where NoBukti  ='TAS-SPI-00001-0123'
--if @nAkhir<>0--@nPenyusutan<>0--@nAkhir>0--convert(datetime, convert(varchar(2),@bulan)+'-15-'+convert(varchar(4),@tahun))
delete DBINVESTASIDET where Bulan =@Bulan and Tahun =@Tahun  
and Perkiraan in ( select Perkiraan from DBINVESTASIDET where Akhir =0 and Bulan =@Bulan-1 and Tahun =@Tahun and Perkiraan =@KodeAktiva   )
/*delete DBINVESTASIDET 
where Bulan =@bulan and Tahun =@tahun-- and a.Perkiraan ='1109010.00001'
and dbo.InvestasiSelesai(@KodeAktiva) is not null and 
CONVERT(DATE, CAST(@tahun  AS VARCHAR(4)) + '-' + RIGHT('0' + CAST(@bulan  AS VARCHAR(2)), 2) + '-01')>
dbo.InvestasiSelesai(@KodeAktiva)*/
DELETE FROM DBINVESTASIDET 
WHERE Bulan = @bulan 
AND Tahun = @tahun
AND Perkiraan = @KodeAktiva
AND dbo.InvestasiSelesai(@KodeAktiva) IS NOT NULL 
AND CONVERT(DATE, CAST(@tahun AS VARCHAR(4)) + '-' + 
    RIGHT('0' + CAST(@bulan AS VARCHAR(2)), 2) + '-01') > 
    dbo.InvestasiSelesai(@KodeAktiva)
if @nAkhir>1
begin
	Insert into DBINVESTASIDET(Perkiraan,Devisi,Bulan,Tahun,NilaiNominal,Awal,AwalPasar,sk,Valas,Kurs,Tipe )
	Select Perkiraan,Devisi,Case when @Bulan=12 then 1 else @Bulan+1 end, Case when @Bulan=12 then @Tahun+1 else @Tahun end,
		  NilaiNominal,case when MD<>0 then MD  else case when tipe =0 then sd else Awal end end awal,--case when MD<>0 then MD  else Awal end awal,
		  SD,akhirpasar   ,Valas,Kurs,Tipe 
	from DBINVESTASIDET   
	where Perkiraan=@KodeAktiva and Devisi=@Devisi and Bulan=@Bulan and Tahun=@Tahun and 
		 not exists(Select Perkiraan 
					from DBINVESTASIDET
					where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
						  Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
						  Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end) 
					  
Select @SaldoPerolehan=case when a.MD<>0 then A.MD else a.awal end
from DBINVESTASIDET A
where A.Perkiraan=@KodeAktiva and A.Devisi=@Devisi and A.Bulan=@Bulan and A.Tahun=@Tahun and MD <>0						  
						  
update DBINVESTASIDET set Awal =@SaldoPerolehan
where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
                      Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
                      Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end and MD <>0
                      
 update DBINVESTASIDET set AwalPasar=@Npasarbulanini,SK =@nAkhirPasar,
 --Awal=case when MD<>0 then MD  else case when tipe =0 then sd else Awal end end 
   Awal = (
        SELECT 
        CASE WHEN MD <> 0 and awal=0 THEN MD ELSE 
             CASE WHEN tipe = 0 THEN sd ELSE Awal+MD END 
        END
        FROM DBINVESTASIDET 
        WHERE Perkiraan = @KodeAktiva 
        AND Devisi = @Devisi 
        AND Bulan = @Bulan 
        AND Tahun = @Tahun
    )
 --tambahan untuk hapus investasi sudah se;esai
where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
                      Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
                      Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end                     
                     

/*
update DBINVESTASIDET set NilaiNominal=NilaiNominal,Awal=Awal,AwalPasar=SD,sk=AkhirPasar
where Perkiraan=@KodeAktiva and Devisi=@Devisi and 
                      Bulan=Case when @Bulan=12 then 1 else @Bulan+1 end and 
                      Tahun=Case when @Bulan=12 then @Tahun+1 else @Tahun end */

/*	  set @Ket='Selisih Penilaian Investasi. '+@Keterangan+' ('+@KodeAktiva+')  %'
if @nPenyusutan>0
			begin
				  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,'',0,
										@Devisi,@Biaya  , @Akumulasi  , @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
		  								'BJK','C','','',@urut,'',@kodeAktiva,'','AVT-','','','','AVT','',''
			end
			else
			begin
				  select @nPenyusutan=ABS(@nPenyusutan)
				  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,'',0,
										@Devisi, @Akumulasi ,@Biaya   , @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
		  								'BJK','C','','',@urut,'',@kodeAktiva,'','AVT-','','','','AVT','',''		  end	  	
	/*IF  @Npasarbulanini  >@nAkhir
	begin
	if @nPenyusutan>0
			begin
				  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,'',0,
										@Devisi,@Biaya  , @Akumulasi  , @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
		  								'BJK','C','','',@urut,'',@kodeAktiva,'','AVT-','','','','AVT','',''
			end
			else
			begin
				  select @nPenyusutan=ABS(@nPenyusutan)
				  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,'',0,
										@Devisi, @Akumulasi ,@Biaya   , @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
		  								'BJK','C','','',@urut,'',@kodeAktiva,'','AVT-','','','','AVT','',''		  end
	
	end	
	else
	begin
		if @nPenyusutan>0
			begin
				  select @nPenyusutan=ABS(@nPenyusutan)
				  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,'',0,
										@Devisi, @Akumulasi ,@Biaya  , @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
		  								'BJK','C','','',@urut,'',@kodeAktiva,'','AVT-','','','','AVT','',''	
			end
			else
			begin
				  select @nPenyusutan=ABS(@nPenyusutan)
				  exec SP_Transaksi  'I', @NoBukti,@Nourut, @Tanggal,'',0,
										@Devisi, @Biaya , @Akumulasi , @Ket, '', @nPenyusutan,0,'IDR',1,@nPenyusutan,0,
		  								'BJK','C','','',@urut,'',@kodeAktiva,'','AVT-','','','','AVT','',''		 
			end
	end*/
	*/
end
GO

-- Procedure: SP_AgingAnalysis_Final
-- Created: 2025-08-21 08:57:19.013 | Modified: 2025-08-21 08:57:19.013
-- =====================================================

    CREATE PROCEDURE SP_AgingAnalysis_Final
        @TanggalCutOff DATE = NULL,
        @KODECUST NVARCHAR(20) = NULL,
        @TIPETRANS NVARCHAR(10) = 'PIUTANG' -- Using TipeTrans not JENIS
    AS
    BEGIN
        SET NOCOUNT ON;
        
        IF @TanggalCutOff IS NULL
            SET @TanggalCutOff = GETDATE();
        
        SELECT 
            h.KodeCustSupp AS KODECUST,  -- Using exact column name KodeCustSupp
            cs.NAMACUSTSUPP AS NamaCustomer,
            h.NOBUKTI,
            h.TANGGAL,
            h.JatuhTempo AS TGLJATUHTEMPO,  -- Using exact column name JatuhTempo
            h.SALDO AS NilaiSaldo,
            DATEDIFF(DAY, h.JatuhTempo, @TanggalCutOff) AS HariTerlambat,
            CASE 
                WHEN DATEDIFF(DAY, h.JatuhTempo, @TanggalCutOff) <= 0 THEN h.SALDO
                ELSE 0
            END AS Belum_JatuhTempo,
            CASE 
                WHEN DATEDIFF(DAY, h.JatuhTempo, @TanggalCutOff) BETWEEN 1 AND 30 THEN h.SALDO
                ELSE 0
            END AS Aging_1_30,
            CASE 
                WHEN DATEDIFF(DAY, h.JatuhTempo, @TanggalCutOff) BETWEEN 31 AND 60 THEN h.SALDO
                ELSE 0
            END AS Aging_31_60,
            CASE 
                WHEN DATEDIFF(DAY, h.JatuhTempo, @TanggalCutOff) BETWEEN 61 AND 90 THEN h.SALDO
                ELSE 0
            END AS Aging_61_90,
            CASE 
                WHEN DATEDIFF(DAY, h.JatuhTempo, @TanggalCutOff) > 90 THEN h.SALDO
                ELSE 0
            END AS Aging_Lebih_90
        FROM DBHUTPIUT h
        INNER JOIN DBCUSTSUPP cs ON h.KodeCustSupp = cs.KODECUSTSUPP
        WHERE h.TipeTrans = @TIPETRANS  -- Using TipeTrans not JENIS
            AND h.SALDO > 0
            AND (@KODECUST IS NULL OR h.KodeCustSupp = @KODECUST)
        ORDER BY h.KodeCustSupp, h.TANGGAL;
    END
    
GO

-- Procedure: SP_AktivaDet
-- Created: 2010-12-15 10:54:08.860 | Modified: 2011-01-19 16:05:45.767
-- =====================================================
CREATE PROCEDURE [dbo].[SP_AktivaDet]
@Choice char(1),
@Divisi varchar(10),
@Perkiraan varchar(30),
@Bulan int,
@Tahun int,
@Valas varchar(15),
@kurs numeric(18,2),
@Awal numeric(18,2)=0,
@AwalSusut numeric(18,2)=0
AS
begin tran
if (@choice='I')
begin
  	insert into dbAktivadet (Devisi, Perkiraan, Bulan, Tahun, Valas,kurs,Awal, AwalSusut,Awald,AwalsusutD)
  	values (@Divisi, @Perkiraan, @Bulan, @Tahun, @valas,@kurs,@Awal*@kurs, @AwalSusut*@kurs,@Awal,@AwalSusut)
  	 
end
if (@choice='U')
begin
  IF NOT EXISTS(SELECT 'TRUE' FROM DBAKTIVADET WHERE DEVISI=@DIVISI AND PERKIRAAN=@PERKIRAAN AND BULAN=@Bulan AND TAHUN=@TAHUN)
  BEGIN
    insert into dbAktivadet (Devisi, Perkiraan, Bulan, Tahun, Valas,kurs,Awal, AwalSusut,Awald,AwalsusutD)
  	values (@Divisi, @Perkiraan, @Bulan, @Tahun, @valas,@kurs,@Awal*@kurs, @AwalSusut*@kurs,@Awal,@AwalSusut)
  END 
  ELSE
  BEGIN
    UPDATE DBAKTIVADET SET AWAL=@AWAL*@kurs, AWALSUSUT=@AWALSUSUT*@kurs,
                           AWALD=@AWAL, AWALSUSUTD=@AWALSUSUT,Valas=@Valas,Kurs=@kurs
    WHERE DEVISI=@DIVISI AND PERKIRAAN=@PERKIRAAN AND BULAN=@Bulan AND TAHUN=@TAHUN
    
  END
end
IF @@ERROR <> 0 GOTO JIKASALAH
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return
GO

-- Procedure: SP_AktivaTetap
-- Created: 2010-12-14 13:01:33.030 | Modified: 2023-03-24 14:16:09.607
-- =====================================================

CREATE PROCEDURE [dbo].[SP_AktivaTetap]
@Choice char(1),
@Devisi varchar(5)='',
@Perkiraan varchar(30)='',
@Keterangan varchar(50)='',                     
@Quantity Numeric(18,2)=0,
@Persen Numeric(18,2)=0,
@Tanggal datetime=null,
@Tipe varchar(1)='',
@Akumulasi varchar(15)='',
@Biaya varchar(15)='',
@NoMuka varchar(25)='',
@NoBelakang varchar(20)='',
@biaya2 varchar(15),
@persenbiaya1 numeric(18,2),
@persenbiaya2 numeric(18,2),
@biaya3 varchar(15)='',
@persenbiaya3 numeric(18,2)=0,
@biaya4 varchar(15)='',
@persenbiaya4 numeric(18,2)=0,
@TipeAktiva tinyint,
@Bagian varchar(15),
@NoBelakang2 varchar(20),
@IsHeader tinyint,
@NoAktivaHd varchar(30)

AS
begin tran
if @choice='I'
begin
  insert into dbAktiva (Devisi, Perkiraan, Keterangan, Quantity, Persen, Tanggal, Tipe, 
                        Akumulasi, Biaya, NoMuka, NoBelakang,biaya2,persenbiaya1,persenbiaya2,
                        biaya3,persenbiaya3,biaya4,persenbiaya4, TipeAktiva,Kodebag,NoBelakang2,kelompok,NoAktivaHd)
  values (@Devisi, @Perkiraan, @Keterangan, @Quantity, @Persen, @Tanggal, @Tipe, @Akumulasi, @Biaya, @NoMuka,
          @NoBelakang,@biaya2,@persenbiaya1,@persenbiaya2,@biaya3,@persenbiaya3,@biaya4,@persenbiaya4,@TipeAktiva,@Bagian,
          @NoBelakang2,@IsHeader,@NoAktivaHd)
  if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
 update dbAktiva set Keterangan=@Keterangan, Quantity=@Quantity, Persen=@Persen, Tanggal=@Tanggal, Tipe=@Tipe, Akumulasi=@Akumulasi, 
             Biaya=@Biaya,biaya2=@biaya2, persenbiaya1=@persenbiaya1,persenbiaya2=@persenbiaya2, biaya3=@biaya3, persenbiaya3=@persenbiaya3,
	biaya4=@biaya4, persenbiaya4=@persenbiaya4, TipeAktiva=@TipeAktiva,Kodebag=@Bagian,Devisi=@Devisi,
	NoBelakang2=@NoBelakang2, Kelompok=@IsHeader,NoAktivaHd=@NoAktivaHd
 where  Perkiraan=@Perkiraan
if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
 delete  dbAktiva where Devisi=@Devisi and Perkiraan=@Perkiraan
 delete  TempDBAKTIVA where Devisi=@Devisi and Perkiraan=@Perkiraan
 if not exists(Select 'True' from DBAKTIVA where Devisi=@Devisi and Perkiraan=@Perkiraan)
    Delete DBAKTIVADET where Devisi=@Devisi and Perkiraan=@Perkiraan
 if not exists(Select 'True' from TempDBAKTIVA where Devisi=@Devisi and Perkiraan=@Perkiraan)
    Delete TempDBAKTIVADET where Devisi=@Devisi and Perkiraan=@Perkiraan    
 if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return
GO

-- Procedure: sp_alterdiagram
-- Created: 2010-12-03 09:27:10.747 | Modified: 2010-12-03 09:27:10.747
-- =====================================================

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END
	
GO

-- Procedure: Sp_AmbilTunai
-- Created: 2013-08-30 14:12:16.243 | Modified: 2013-08-30 14:12:16.243
-- =====================================================



create Procedure [dbo].[Sp_AmbilTunai]
@Choice varchar(1),
@NoBukti varchar(20),
@Tanggal datetime,
@NoUrut varchar(5),
@NoBuktiPesan varchar(20),
@UserID varchar(15),
@Urut int
As
Begin tran
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBJUALTunaiDet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1

  if not exists(select * from DBJUALTunai Where NoBukti=@NoBukti) 
  begin
    insert into DBJUALTunai (NOBUKTI, NoUrut, TANGGAL, KODECUST, TglInput, UserID, Pemesan, IsOrder, DP, DiscMember, DiscHarian)
    --values (@NOBUKTI, @NoUrut, @TANGGAL, @KODECust, GETDATE(), @UserID, @Pemesan, @IsOrder)
    select @NoBukti, @NoUrut, @Tanggal, KODECUST, GETDATE(), @UserID, Pemesan, 0, ISNULL(BayarTunai,0) + ISNULL(BayarDebet,0) + ISNULL(BayarKredit,0) + ISNULL(BayarVoucher,0), DiscMember, DiscHarian 
    from dbPesanTunai
    where NOBUKTI = @NoBuktiPesan
   	if @@error<>0  goto jikasalah		
  end
  
  insert into DBJUALTunaiDET (NOBUKTI, URUT,  KodeBrg, QNT, HARGA, DISCP, NoSat, Satuan, Isi, Ctk,Diskon, TglBatal, Keterangan, IsSelesai, IsKirim)
 -- values(@NOBUKTI,@URUT, @KodeBrg, @QNT, @HARGA, @DiscP, @NoSat, @Satuan, @Isi, @Ctk,@Diskon, @TglBatal,@Keterangan, 0, 0)
  select @NoBukti, URUT, KodeBrg, QNT, HARGA, DISCP, NOSAT, SATUAN, ISI, Ctk, Diskon, TglBatal, Keterangan, 1, 1
  from dbPesanTunaiDet
  where NOBUKTI = @NoBuktiPesan
  if @@error<>0  goto jikasalah
end
/*
if @choice='U'
begin
  update DBJUALTunaiDET set Qnt=@QNT, Harga=@HARGA, DiscP=@DiscP, NoSat=@NoSat, 
                       Satuan=@Satuan, Isi=@Isi,Diskon=@Diskon, TglBatal=@TglBatal
  where nobukti=@nobukti and urut=@urut
end
*/
if @choice='D'
begin
  delete dbJualTunaiDet where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from DBJualTunaiDET where nobukti=@nobukti)
  begin
    delete DBJUALTunai where nobukti=@nobukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
        raiserror('Proses Input Data Gagal',16,1)
           Return


GO

-- Procedure: Sp_Area
-- Created: 2012-12-17 09:56:05.930 | Modified: 2012-12-17 09:56:05.930
-- =====================================================


Create PROCEDURE [dbo].[Sp_Area]
@Choice char(1),
@KodeArea Varchar(15),
@NamaArea Varchar(50)

AS
begin tran
if @choice='I'
begin
	insert into dbArea (KodeArea, NamaArea)
	values (@KodeArea, @NamaArea)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbArea set NamaArea=@NamaArea
             where KodeArea=@KodeArea
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbArea where KodeArea=@KodeArea
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_ASM
-- Created: 2014-02-13 11:36:53.850 | Modified: 2014-02-13 11:36:53.850
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_ASM]
@Choice char(1),
@Keynik Varchar(15),
@Area Varchar(40)



AS
begin tran
if @choice='I'
begin
  insert into DBASM (KeyNIK, Area)
  values (@Keynik,@Area)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
    update DBASM 
    set Area=@Area
    where KeyNIK=@Keynik
    if @@error <> 0
     goto jikasalah
end
if @choice='D'
begin
   delete DBASM 
   where KeyNIK=@Keynik
   
   if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_Bagian
-- Created: 2010-12-10 09:50:01.080 | Modified: 2011-12-22 09:53:42.103
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_Bagian]
@Choice char(1),
@KodeBag Varchar(15),
@NamaBag Varchar(100),
@Perkiraan Varchar(25),
@Biaya Varchar(25),
@BiayaJasaKom Varchar(25),
@BiayaJasaALat Varchar(25),
@OldKode varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbBagian (KodeBag, NamaBag, Perkiraan, Biaya, BiayaJasaKom, BiayaJasaAlat)
	values (@KodeBag, @NamaBag, @Perkiraan, @Biaya, @BiayaJasaKom, @BiayaJasaALat)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbBagian set NamaBag=@NamaBag, KodeBag=@KodeBag, Perkiraan=@Perkiraan, Biaya=@Biaya,
	                    BiayaJasaKom=@BiayaJasaKom, BiayaJasaAlat=@BiayaJasaALat
   where KodeBag=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbBagian where KodeBag=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_BarangJadi
-- Created: 2011-09-14 14:43:23.620 | Modified: 2011-11-07 21:09:01.993
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_BarangJadi]
@Choice char(1),
@KodeBrg Varchar(15),
@NamaBrg Varchar(100),
@Grup Varchar(50),
@SAT1 varchar (5),
@ISI1 numeric(18, 2),
@Sat2 varchar (5),
@Isi2 numeric(18, 2),
@QntMin numeric(18, 2),
@QntMax numeric(18, 2),
@kodegdg varchar(15),
@jns_Kertas varchar(50),
@ISAKTIF tinyint,
@GSM numeric(18,2),
@OldKode varchar(25),
@Ukr_Kertas varchar(50),
@HRGGROSIR numeric(18, 2),
@KodeKelompok [varchar] (15),
@KodeKategori [varchar] (15),
@KodeSubKategori [varchar] (15),
@KodeJnsBrg [varchar] (15),
@kodesubJnsBrg [varchar] (15)
AS

begin tran
if @choice='I'
begin
	insert into dbBarangJadi (KodeBrg, NamaBrg, Grup, SAT1,ISI1,Sat2,Isi2,HRGECER,ISAKTIF,QntMin,
                         QntMax, kodegdg, Jns_Kertas, Ukr_Kertas, GSM,
                         KodeKelompok,KodeKategori,KodeSubKategori,KodeJnsBrg,kodesubJnsBrg)
	values (@KodeBrg, @NamaBrg,@Grup,@SAT1,@ISI1,@Sat2,@Isi2,@HRGGROSIR,@ISAKTIF,
	        @QntMin,@QntMax,@Kodegdg, @jns_Kertas, @Ukr_Kertas, @GSM,
	        @KodeKelompok,@KodeKategori,@KodeSubKategori,@KodeJnsBrg,@kodesubJnsBrg)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBBARANGJADI set KodeBrg=@KodeBrg,NamaBrg=@NamaBrg,Grup=@Grup,
        SAT1=@SAT1,ISI1=@ISI1,Sat2=@Sat2,Isi2=@Isi2,HRGGROSIR=@HRGGROSIR,ISAKTIF=@ISAKTIF,
        QntMin=@QntMin,
        QntMax=@QntMax,
        Kodegdg=@Kodegdg, Jns_Kertas=@jns_Kertas, Ukr_Kertas=@Ukr_Kertas, GSM=@GSM,
        KodeKelompok=@KodeKelompok,KodeKategori=@KodeKategori,KodeSubKategori=@KodeSubKategori,KodeJnsBrg=@KodeJnsBrg,kodesubJnsBrg=@kodesubJnsBrg
        where KodeBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBBARANGJADI where KodeBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return






GO

-- Procedure: Sp_BatalMintaBrg
-- Created: 2011-05-05 15:07:52.930 | Modified: 2011-05-05 15:07:52.930
-- =====================================================










CREATE Procedure [dbo].[Sp_BatalMintaBrg]
@Choice varchar(1),
@Nobukti varchar(30),
@Nourut varchar(5),
@Tanggal datetime,
@NoBPPB varchar(30),
@urut int ,
@kodebrg varchar(25),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Isi numeric(18, 2),
@Qnt numeric(18, 2),
@Qnt2 numeric(18, 2),
@UrutBPPB int,
@Keterangan varchar(8000),
@Nosat tinyint,
@FlagMenu int,
@IsEmpty tinyint,
@IDUser varchar(15)

As

declare @NoBuktiBatalPPL varchar(30), @UrutBatalPPL int, @NoBuktiPPL varchar(30), @UrutPPL int
 
Begin tran
if @choice='I'
begin
  	select @urut=isnull(max(urut),0)+1 from DBBatalMintaBrgDet   Where NoBukti=@NoBukti
  	select @Urut=isnull(@Urut,1)
  	--if not exists(select * from DBBatalMintaBrg   Where NoBukti=@NoBukti) 
	if @IsEmpty=0
  	begin
    		insert into DBBatalMintaBrg  (Nobukti, Nourut, Tanggal, NoBPPB, FlagMenu, IDUser)
    		values (@Nobukti, @Nourut, @Tanggal, @NoBPPB, @FlagMenu, @IDUser)
			if @@error<>0  goto jikasalah
  	end
  	/*
  	select @NoBuktiBatalPPL=REPLACE(@NoBukti,'BBP/','BPL/')
	if @@error<>0  goto jikasalah
  	if (exists (select * from DBPPLDet Where NoPermintaan=@NoBPPB and UrutPermintaan=@UrutBPPB))
  		and (not exists(select * from DBBatalPPL Where NoBatalMintaBrg=@NoBukti))
	begin
		insert into DBBatalPPL  (Nobukti, Nourut, Tanggal, NoBatalMintaBrg, FlagMenu, IDUser)
    	values (@NoBuktiBatalPPL, @Nourut, @Tanggal, @NoBukti, @FlagMenu, @IDUser)
    	if @@error<>0  goto jikasalah
    end
    */
  	insert into DBBatalMintaBrgDet  (Nobukti, urut, kodebrg, Sat_1, Sat_2, Isi, Qnt, Qnt2, NoBPPB, UrutBPPB, Keterangan, Nosat)
  	values(@Nobukti, @urut, @kodebrg, @Sat_1, @Sat_2, @Isi, @Qnt, @Qnt2, @NoBPPB, @UrutBPPB, @Keterangan, @Nosat)
	if @@error<>0  goto jikasalah
	/*
	select @UrutBatalPPL=0
	Declare CurTrans Cursor for
		select NoBukti, Urut from DBPPLDET
		where NoPermintaan=@NoBPPB and UrutPermintaan=@UrutBPPB
		order by NoBukti, Urut
	Open CurTrans
    Fetch Next from CurTrans into @NoBuktiPPL, @UrutPPL
    While @@fetch_Status=0
    begin
		select @UrutBatalPPL=@UrutBatalPPL+1
		insert into DBBatalPPLDET  (Nobukti, urut, kodebrg, Sat_1, Sat_2, Isi, Qnt, Qnt2, 
		NoPPL, UrutPPL, Keterangan, Nosat, NoBatalMintaBrg, UrutBatalMintaBrg)
  		select @NoBuktiBatalPPL, (@urut*1000)+@UrutBatalPPL, @kodebrg, @Sat_1, @Sat_2, @Isi, @Qnt, @Qnt2, 
  		@NoBuktiPPL, @UrutPPL, @Keterangan, @Nosat, @NoBuktiBatalPPL, @Urut
  		from DBPPLDET
  		where NoBukti=@NoBuktiPPL and Urut=@UrutPPL
		if @@error<>0  goto jikasalah
		update DBBatalPPLDET set Qnt=A.Qnt, Qnt2=A.Qnt2
		from DBBatalPPLDET A0
		left outer join vwOutPPL A on A.Nobukti=A0.NoPPL and A.Urut=A0.UrutPPL
		left outer join vwBrowsOutPermintaanBrg B on B.Nobukti=A.NoPermintaan and B.urut=A.UrutPermintaan
		where A0.NoPPL=@NoBuktiPPL and A0.UrutPPL=@UrutPPL
		and B.Nobukti is null
		if @@error<>0  goto jikasalah
		Fetch Next from CurTrans into @NoBuktiPPL, @UrutPPL
	end
	CLOSE CurTrans
    DEALLOCATE CurTrans
    */
end
if @choice='U'
begin
  	update DBBatalMintaBrgDet  
	set 	kodebrg=@kodebrg, Sat_1=@Sat_1, Sat_2=@Sat_2, Isi=@Isi, Qnt=@Qnt, Qnt2=@Qnt2, 
		NoBPPB=@NoBPPB, UrutBPPB=@UrutBPPB , Keterangan=@Keterangan, Nosat=@Nosat
  	where Nobukti=@Nobukti and urut=@urut
	if @@error<>0  goto jikasalah
	/*
	select @UrutBatalPPL=0
	Declare CurTrans Cursor for
		select NoBukti, Urut from DBPPLDET
		where NoPermintaan=@NoBPPB and UrutPermintaan=@UrutBPPB
		order by NoBukti, Urut
	Open CurTrans
    Fetch Next from CurTrans into @NoBuktiPPL, @UrutPPL
    While @@fetch_Status=0
    begin
		delete DBBatalPPLDET where NoPPL=@NoBuktiPPL and UrutPPL=@UrutPPL
		if @@error<>0  goto jikasalah
		select @UrutBatalPPL=@UrutBatalPPL+1
		insert into DBBatalPPLDET  (Nobukti, urut, kodebrg, Sat_1, Sat_2, Isi, Qnt, Qnt2, 
		NoPPL, UrutPPL, Keterangan, Nosat, NoBatalMintaBrg, UrutBatalMintaBrg)
  		select @NoBuktiBatalPPL, (@urut*1000)+@UrutBatalPPL, @kodebrg, @Sat_1, @Sat_2, @Isi, @Qnt, @Qnt2, 
  		@NoBuktiPPL, @UrutPPL, @Keterangan, @Nosat, @NoBuktiBatalPPL, @Urut
  		from DBPPLDET
  		where NoBukti=@NoBuktiPPL and Urut=@UrutPPL
		if @@error<>0  goto jikasalah
		update DBBatalPPLDET set Qnt=A.Qnt, Qnt2=A.Qnt2
		from DBBatalPPLDET A0
		left outer join vwOutPPL A on A.Nobukti=A0.NoPPL and A.Urut=A0.UrutPPL
		left outer join vwBrowsOutPermintaanBrg B on B.Nobukti=A.NoPermintaan and B.urut=A.UrutPermintaan
		where A0.NoPPL=@NoBuktiPPL and A0.UrutPPL=@UrutPPL
		and B.Nobukti is null
		if @@error<>0  goto jikasalah
		Fetch Next from CurTrans into @NoBuktiPPL, @UrutPPL
	end
	CLOSE CurTrans
    DEALLOCATE CurTrans
    */
end
if @choice='D'
begin
  	delete DBBatalMintaBrgDet  where nobukti=@nobukti and  urut=@urut
	if @@error<>0  goto jikasalah 
	--delete DBBatalPPLDet  where NoBatalMintaBrg=@NoBukti and  urutBatalMintaBrg=@urut
	--if @@error<>0  goto jikasalah
  	if not exists( select nobukti from DBBatalMintaBrgDet  where nobukti=@nobukti)
  	begin
    		delete DBBatalMintaBrg   where nobukti=@nobukti
			if @@error<>0  goto jikasalah
			--delete DBBatalPPL   where NoBatalMintaBrg=@nobukti
			--if @@error<>0  goto jikasalah
  	end
end

update dbPermintaanBrgDet set QntBtl=ISNULL(B.Qnt,0), Qnt2Btl=ISNULL(B.Qnt2,0) 
from dbPermintaanBrgDet A
left outer join 
	(select NoBPPB, UrutBPPB, sum(Qnt) Qnt, sum(Qnt2) Qnt2 from dbBatalMintaBrgDet 
	where NoBPPB=@NoBPPB and UrutBPPB=@UrutBPPB
	group by NoBPPB, UrutBPPB
	) B on B.NoBPPB=A.NOBUKTI and B.UrutBPPB=A.Urut
where A.NOBUKTI=@NoBPPB and A.Urut=@UrutBPPB
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return











GO

-- Procedure: sp_BeliGudang
-- Created: 2013-02-21 15:21:31.137 | Modified: 2014-11-19 14:46:23.913
-- =====================================================

CREATE   Procedure [dbo].[sp_BeliGudang]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@KodeSupp varchar(15),
@KodeGdg varchar(15),
@NoPO varchar(20),
@Keterangan varchar(200),
@FakturSupp Varchar(20),
@Urut int,
@KodeBrg varchar(25),
@UrutPO int,
@QntTerima numeric(18,2),
@NoSat tinyint,
@Satuan varchar(5),
@Isi numeric(18,2),
@Qnt1Terima numeric(18,2),
@Qnt2Terima numeric(18,2),
@NamaBrg varchar(100),
@NoBatch Varchar(50)

As

declare @Harga numeric(18,2), @DiscP numeric(18,2), @DiscTot numeric(18,2)
declare @PPN int, @Disc float

begin tran

if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbBeliDet Where NoBukti=@NoBukti
  if @@error<>0  goto jikasalah
  if not exists(select * from dbBeli Where NoBukti=@NoBukti) 
  begin
    insert into dbBeli (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling,  KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp, NoPOHd, KodeGdgHd)
	select @NoBukti, @NoUrut, @Tanggal, @Tanggal+HARI, @KodeSupp, HANDLING, @Keterangan,
	@FakturSupp, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DISCRP, @NoPO, @KodeGdg
	from DBPO 
	where NOBUKTI=@NoPO
	if @@error<>0  goto jikasalah
  end
  
  select @PPN=PPN, @Disc=DISC from DBBELI where NOBUKTI=@NoBukti
  if @@error<>0  goto jikasalah
  
  Declare @Isjasa Bit
  select top 1 @Harga=HARGA, @DiscP=DISCP, @DiscTot=DISCTOT,@NamaBrg=Namabrg,@Isjasa=Isjasa
  from DBPODET
  where NOBUKTI=@NoPO and KODEBRG=@KodeBrg and NOSAT=@NoSat and urut=@UrutPO
  if @@error<>0  goto jikasalah
  
  select @Harga=ISNULL(@Harga,0), @DiscP=ISNULL(@DiscP,0), @DiscTot=ISNULL(@DiscTot,0)
  if @@error<>0  goto jikasalah
  
  insert into dbBeliDET (NOBUKTI, URUT, KODEBRG,NamaBrg, KodeGdg, PPN, DISC, 
  QNT, NOSAT, SATUAN, ISI, HARGA, DISCP, DISCTOT, BYANGKUT, 
  NoPO, UrutPO, HPP, QntTerima, Qnt1Terima, Qnt2Terima,Isjasa,Nobatch)
  values(@NOBUKTI, @URUT, @KODEBRG,@NamaBrg, @KodeGdg, @PPN, @Disc, 
  @QntTerima, @NoSat, @Satuan, @Isi, @Harga, @DiscP, @DiscTOT, 
  0.00, @NoPO, @UrutPO, 0, @QntTerima, @Qnt1Terima, @Qnt2Terima,@Isjasa,@NoBatch)
  if @@error<>0  goto jikasalah
end

if @Choice='U'
begin
  update dbBeliDET set KodeBrg=@KODEBRG,  QntTerima=@QntTerima, NOSAT=@NoSat, SATUAN=@Satuan, ISI=@Isi,
  Qnt1Terima=@Qnt1Terima, Qnt2Terima=@Qnt2Terima,
  QNT=@QntTerima-QntReject,NObatch=@NoBatch
  where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah
end

if @Choice='D'
begin
  delete dbBeliDET where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah 
  if not exists( select NoBukti from dbBeliDET where NoBukti=@NoBukti)
  begin
    delete dbBeli where NoBukti=@NoBukti
    if @@error<>0  goto jikasalah
  end
end
--if Exists(select NoBukti from DBBELIDET where NOBUKTI=@NoBukti) 
-- Begin
--   Update DBBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAINET=(select SUM(NNET)NNET from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAIPPN=(select SUM(NPPN)NPPN from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI)
--   where NOBUKTI=@NoBukti                  
-- End 
--if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: sp_BeliReject
-- Created: 2013-03-09 11:01:36.013 | Modified: 2014-07-18 09:49:15.463
-- =====================================================

CREATE   Procedure [dbo].[sp_BeliReject]
@Choice varchar(1),
@NoBukti varchar(20),
@Urut int,
@QntReject numeric(18,2),
@Qnt1Reject numeric(18,2),
@Qnt2Reject numeric(18,2),
@NoSatReject tinyint,
@SatuanReject varchar(10),
@IsiReject numeric(18,2),
@UrutBeli int,
@KetReject varchar(1000),
@Isjasa Bit

As

begin tran

if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbBeliDet Where NoBukti=@NoBukti
  if @@error<>0  goto jikasalah
  insert into dbBeliDET (NOBUKTI, URUT, KODEBRG,NamaBrg, KodeGdg, PPN, DISC, 
  QNT, NOSAT, SATUAN, ISI, HARGA, DISCP, DISCTOT, BYANGKUT, 
  NoPO, UrutPO, HPP, QntTerima, Qnt1Terima, Qnt2Terima,
  QntReject, Qnt1Reject, Qnt2Reject, UrutBeli, KetReject,ISjasa)
  select NoBukti, @Urut, KodeBrg,NamaBrg, KodeGdg, PPN, Disc,
  -1*@QntReject, @NoSatReject, @SatuanReject, @IsiReject, Harga, DiscP, DiscTot, 0 BYANGKUT,
  NoPO, UrutPO, HPP, 0 QntTerima, 0 Qnt1Terima, 0 Qnt2Terima,
  @QntReject, @Qnt1Reject, @Qnt2Reject, @UrutBeli, @KetReject,@Isjasa
  from DBBELIDET
  where NOBUKTI=@NoBukti and Urut=@UrutBeli 
  if @@error<>0  goto jikasalah
end

if @Choice='U'
begin
  update dbBeliDET set NoSat=@NoSatReject, SATUAN=@SatuanReject, QntReject=@QntReject, Qnt1Reject=@Qnt1Reject, Qnt2Reject=@Qnt2Reject,
	QNT=-1*@QntReject, KetReject=@KetReject
  where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah
end

if @Choice='D'
begin
  delete dbBeliDET where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah 
  if not exists( select NoBukti from dbBeliDET where NoBukti=@NoBukti)
  begin
    delete dbBeli where NoBukti=@NoBukti
    if @@error<>0  goto jikasalah
  end
end
--if Exists(select NoBukti from DBBELIDET where NOBUKTI=@NoBukti) 
-- Begin
--   Update DBBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAINET=(select SUM(NNET)NNET from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAIPPN=(select SUM(NPPN)NPPN from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI)
--   where NOBUKTI=@NoBukti                  
-- End 
--if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return





GO

-- Procedure: Sp_Biaya
-- Created: 2010-12-10 09:50:01.130 | Modified: 2013-04-23 13:20:37.760
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_Biaya]
@Choice char(1)='',
@KodeBiaya Varchar(15)='',
@Keterangan Varchar(100)='',
@OldKode varchar(15)='',
@Perkiraan varchar(15)=''
AS
begin tran
if @choice='I'
begin
	insert into dbBiaya (KodeBiaya, Keterangan,Perkiraan)
	values (@KodeBiaya, @Keterangan,@Perkiraan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbBiaya set Keterangan=@Keterangan ,KodeBiaya=@KodeBiaya, Perkiraan=@Perkiraan
             where KodeBiaya=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbBiaya where KodeBiaya=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_BiayaBeli
-- Created: 2011-02-11 15:41:00.163 | Modified: 2011-02-11 15:41:00.163
-- =====================================================

CREATE  Procedure Sp_BiayaBeli
@Choice varchar(1),
@NoBukti varchar (30),
@Urut int,
@Kodebiaya varchar (15),
@KODECUSTSUPP varchar (15),
@Qnt numeric (18,2),
@Harga numeric (18,2),
@Valas varchar (15),
@kurs numeric (18,2),
@PPn tinyint

As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbBiayaBeli Where NoBukti=@NoBukti
	insert into dbBiayaBeli (NoBukti, Urut, Kodebiaya, KODECUSTSUPP, Qnt, Harga, Valas, kurs, PPn)
	values (@NoBukti, @Urut, @Kodebiaya, @KODECUSTSUPP, @Qnt, @Harga, @Valas, @kurs, @PPn)
	if @@error<>0  goto jikasalah

end
if @Choice='U'
begin
	update	dbBiayaBeli
	set	 Kodebiaya=@Kodebiaya, KODECUSTSUPP=@KODECUSTSUPP, Qnt=@Qnt, Harga=@Harga, Valas=@Valas, kurs=@kurs, PPn=@PPn
  	where 	NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbBiayaBeli where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
	if (not exists( select NoBukti from dbBeliDET where NoBukti=@NoBukti)) and  (not exists( select NoBukti from dbBiayaBeli where NoBukti=@NoBukti))
  	begin
    		delete dbBELI where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: sp_BiayaPO
-- Created: 2011-02-11 15:41:00.497 | Modified: 2011-02-11 15:41:00.497
-- =====================================================

CREATE  Procedure sp_BiayaPO
@Choice varchar(1),
@NoBukti varchar (30),
@Urut int,
@Kodebiaya varchar (15),
@KODECUSTSUPP varchar (15),
@Qnt numeric (18,2),
@Harga numeric (18,2),
@Valas varchar (15),
@kurs numeric (18,2),
@PPn tinyint

As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbBiayaPO Where NoBukti=@NoBukti
	insert into DBBIAYAPO (NoBukti, Urut, Kodebiaya, KODECUSTSUPP, Qnt, Harga, Valas, kurs, PPn)
	values (@NoBukti, @Urut, @Kodebiaya, @KODECUSTSUPP, @Qnt, @Harga, @Valas, @kurs, @PPn)
	if @@error<>0  goto jikasalah

end
if @Choice='U'
begin
	update	dbBiayaPO
	set	 Kodebiaya=@Kodebiaya, KODECUSTSUPP=@KODECUSTSUPP, Qnt=@Qnt, Harga=@Harga, Valas=@Valas, kurs=@kurs, PPn=@PPn
  	where 	NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbBiayaPO where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
	if (not exists( select NoBukti from dbPODet where NoBukti=@NoBukti)) and (not exists( select NoBukti from dbBiayaPO where NoBukti=@NoBukti))
  	begin
    		delete dbPO where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
		delete dbNotePO where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: Sp_BiayaProses
-- Created: 2014-08-22 09:18:25.227 | Modified: 2014-08-22 09:53:30.507
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_BiayaProses]
@Choice char(1)='',
@KodePrs Varchar(15)='',
@Urut int=0,
@Perkiraan varchar(25)=''
AS
begin tran
if @choice='I'
begin
	insert into DBBiayaProses (KodePrs, Urut,Perkiraan)
	values (@KodePrs, @Urut,@Perkiraan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBBiayaProses set Perkiraan=@Perkiraan
             where KodePrs=@KodePrs and Urut = @Urut
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBBiayaProses where KodePrs=@KodePrs and Urut = @Urut
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_BiayaRBeli
-- Created: 2011-02-11 15:41:00.173 | Modified: 2011-02-11 15:41:00.173
-- =====================================================

CREATE  Procedure Sp_BiayaRBeli
@Choice varchar(1),
@NoBukti varchar (30),
@Urut int,
@Kodebiaya varchar (15),
@KODECUSTSUPP varchar (15),
@Qnt numeric (18,2),
@Harga numeric (18,2),
@Valas varchar (15),
@kurs numeric (18,2),
@PPn tinyint

As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbBiayaBeli Where NoBukti=@NoBukti
	insert into dbBiayaRBeli (NoBukti, Urut, Kodebiaya, KODECUSTSUPP, Qnt, Harga, Valas, kurs, PPn)
	values (@NoBukti, @Urut, @Kodebiaya, @KODECUSTSUPP, @Qnt, @Harga, @Valas, @kurs, @PPn)
	if @@error<>0  goto jikasalah

end
if @Choice='U'
begin
	update	dbBiayaRBeli
	set	 Kodebiaya=@Kodebiaya, KODECUSTSUPP=@KODECUSTSUPP, Qnt=@Qnt, Harga=@Harga, Valas=@Valas, kurs=@kurs, PPn=@PPn
  	where 	NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbBiayaRBeli where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
	if (not exists( select NoBukti from dbRBeliDET where NoBukti=@NoBukti)) and  (not exists( select NoBukti from dbBiayaRBeli where NoBukti=@NoBukti))
  	begin
    		delete dbRBELI where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: sp_BOM
-- Created: 2014-04-14 10:58:29.310 | Modified: 2014-08-22 15:04:50.873
-- =====================================================


CREATE   Procedure [dbo].[sp_BOM]
@Choice varchar(1),
@KodeBOM varchar (25),
@KodePrs varchar (20),
@Urut int,
@KodeBrg varchar (25),
@Qnt float,
@Numerator numeric(18,2),
@Denominator numeric(18,2),
@LossRatio numeric(18,2),
@PlaceCD varchar(20),
@NoSat int,
@Satuan varchar(10),
@Isi numeric(18,2)


As

Begin tran

if @Choice='I'
begin
	if @Denominator=0
	begin
		select @Qnt=0
	end else
	begin
		select @Qnt=CAST(@Numerator as float)/@Denominator
	end
		
	select @Urut=isnull(max(Urut),0)+1 from DBBOMDET Where KodeBOM=@KodeBOM and KodePrs = @KodePrs
	/*
	if not exists(select * from DBBOM Where KodeBOM=@KodeBOM) 
	begin
		insert into DBBOM (KodeBOM, KodeBrg, NoUrut, IsDefault, TglAwal, TglAkhir)
		values (@KodeBOM, @KodeBrgHd, @NoUrut, @IsDefault, @TglAwal, @TglAkhir)
		if @@error<>0  goto jikasalah
	end
	*/
	
	insert into DBBOMDET (KodeBOM, Urut, KodeBrg, Qnt, Numerator, Denominator, LossRatio, PlaceCD, NoSat, Satuan, Isi, KodePrs)
	values (@KodeBOM, @Urut, @KodeBrg, @Qnt, @Numerator, @Denominator, @LossRatio, @PlaceCD, @NoSat, @Satuan, @Isi, @KodePrs)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
	if @Denominator=0
	begin
		select @Qnt=0
	end else
	begin
		select @Qnt=CAST(@Numerator as float)/@Denominator
	end 
	update DBBOMDET set KodeBrg=@KodeBrg, Qnt=@Qnt,
	Numerator=@Numerator, Denominator=@Denominator, LossRatio=@LossRatio, PlaceCD=@PlaceCD
	where KodeBOM=@KodeBOM and Urut=@Urut and KodePrs = @KodePrs
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
	delete DBBOMDET where KodeBOM=@KodeBOM and Urut=@Urut and KodePrs = @KodePrs
	if @@error<>0  goto jikasalah 
	/*
	if not exists( select KodeBOM from DBBOMDET where KodeBOM=@KodeBOM)
	begin
		delete DBBOM where KodeBOM=@KodeBOM
		if @@error<>0  goto jikasalah
	end
	*/
end

Commit tran
Return
JikaSalah: Rollback tran
           Return






GO

-- Procedure: sp_BOMProses
-- Created: 2014-08-22 13:57:40.140 | Modified: 2014-08-22 13:57:40.140
-- =====================================================


create   Procedure [dbo].[sp_BOMProses]
@Choice varchar(1),
@KodeBOM varchar (25),
@KodeBrgHd varchar (25),
@NoUrut varchar (10),
@IsDefault bit,
@TglAwal datetime,
@TglAkhir datetime,
@Urut int,
@KodePrs varchar (20)


As

Begin tran

if @Choice='I'
begin
		
	select @Urut=isnull(max(Urut),0)+1 from DBBOMProses Where KodeBOM=@KodeBOM
	
	if not exists(select * from DBBOM Where KodeBOM=@KodeBOM) 
	begin
		insert into DBBOM (KodeBOM, KodeBrg, NoUrut, IsDefault, TglAwal, TglAkhir)
		values (@KodeBOM, @KodeBrgHd, @NoUrut, @IsDefault, @TglAwal, @TglAkhir)
		if @@error<>0  goto jikasalah
	end	
	
	insert into DBBOMProses (KodeBOM, Urut, KodePrs)
	values (@KodeBOM, @Urut, @KodePrs)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
/*
	if @Denominator=0
	begin
		select @Qnt=0
	end else
	begin
		select @Qnt=CAST(@Numerator as float)/@Denominator
	end 
	update DBBOMDET set KodeBrg=@KodeBrg, Qnt=@Qnt,
	Numerator=@Numerator, Denominator=@Denominator, LossRatio=@LossRatio, PlaceCD=@PlaceCD
	where KodeBOM=@KodeBOM and Urut=@Urut
*/
	select 1
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
	delete DBBOMProses where KodeBOM=@KodeBOM and Urut=@Urut
	if @@error<>0  goto jikasalah 
	if not exists( select KodeBOM from DBBOMProses where KodeBOM=@KodeBOM)
	begin
		delete DBBOM where KodeBOM=@KodeBOM
		if @@error<>0  goto jikasalah
	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return






GO

-- Procedure: sp_Bon
-- Created: 2012-10-20 09:23:43.067 | Modified: 2012-10-20 09:23:43.067
-- =====================================================
CREATE PROCEDURE [dbo].[sp_Bon]
@choice varchar(1),
@Devisi varchar(10),
@NoBukti varchar(20),
@Tanggal datetime,
@Penerima varchar(40),
@Keterangan varchar(40),
@Debet numeric(18,2),
@Kredit numeric(18,2),
@Perkiraan varchar(15),
@TglInput datetime,
@UserID varchar(10),
@Urut tinyint,
@KodeVls varchar(10),
@Kurs numeric(18,4),
@DebetD numeric(18,2),
@KreditD numeric(18,2)
AS

if @choice='I'
begin
	insert into dbbon(Devisi,NoBukti,Tanggal,Penerima,Debet,Kredit,Keterangan,TglInput,UserID,Perkiraan,Urut,
		KodeVls, Kurs, DebetD, KreditD)
	values (@Devisi,@NoBukti,@Tanggal,@Penerima,@Debet,@Kredit,@Keterangan,@TglInput,@UserID,@Perkiraan,@Urut,
		@KodeVls, @Kurs, @DebetD, @KreditD)
end
if @choice='U'
begin
	Update dbbon set Tanggal=@tanggal,Penerima=@penerima,Keterangan=@keterangan,Debet=@debet,Kredit=@kredit,TglInput=@tglInput,UserID=@userID,
		KodeVls=@KodeVls, Kurs=@Kurs, DebetD=@DebetD, KreditD=@KreditD
	where devisi=@devisi and nobukti=@nobukti and perkiraan=@perkiraan and urut=@urut
end
if @choice='D'
begin
	delete dbbon
	where devisi=@devisi and nobukti=@nobukti and perkiraan=@perkiraan and Urut=@Urut
end





GO

-- Procedure: Sp_BPPB
-- Created: 2013-02-25 10:33:17.287 | Modified: 2013-04-23 16:33:58.660
-- =====================================================
CREATE  Procedure [dbo].[Sp_BPPB]
@Choice varchar(1),
@NoBukti varchar(50),
@NoUrut varchar(10)='',
@Tanggal datetime=0,
@KdDep varchar(15)='',
@Urut int,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)=0,
@NoSat tinyint=0,
@Satuan varchar(5)='',
@Isi numeric(18,2)=0,
@KodeGdg Varchar(15)='',
@Qnt2 Numeric(18,2)=0,
@KodeGdgT Varchar(15)='',
@Pilihan Varchar(1)='',
@Qnt2M Numeric(18,2)=0,
@Qnt2P Numeric(18,2)=0
As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbBPPBdet Where NoBukti=@NoBukti
  if not exists(select * from dbBPPB Where NoBukti=@NoBukti) 
  begin
    insert into dbBPPB (NOBUKTI, NOURUT, TANGGAL, KDDEP, KodeGdg, KodeGdgT)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @KdDep,'',@KodeGdg)
  end
  insert into dbBPPBDET (NOBUKTI, URUT, KODEBRG, QNT, NOSAT, ISI, SATUAN, Qnt2, Qnt2M,Qnt2P)
  values(@NOBUKTI, @URUT, @KODEBRG, @Qnt, @NoSat, @Isi, @Satuan, @Qnt2, @Qnt2M,0.00)
end
if @Choice='U'
begin
  --Update dbBPPB set KodeGdgT=@KodeGdgT where NOBUKTI=@NoBukti 
  --update dbBPPBDET set KodeBrg=@KODEBRG, Qnt=case when @pilihan='M' Then @QNT else Qnt end, NOSAT=@NoSat, ISI=@ISI, SATUAN=@Satuan,Qnt2=Case when @pilihan='T' Then @Qnt2 else Qnt2 end
  --, Qnt2M=case when @pilihan='M' Then @QNT2M else Qnt2M end, Qnt2P=case when @pilihan='T' Then @Qnt2P else Qnt2P end
  --where NoBukti=@NoBukti and Urut=@Urut
  update dbBPPBDET set KodeBrg=@KODEBRG, Qnt=@Qnt, Qnt2=@Qnt2, NOSAT=@NoSat, ISI=@ISI, SATUAN=@Satuan
  where NoBukti=@NoBukti and Urut=@Urut
end
if @Choice='D'
begin
  delete dbBPPBDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbBPPBDET where NoBukti=@NoBukti)
  begin
    delete dbBPPB where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return





GO

-- Procedure: sp_BPPBT
-- Created: 2013-02-25 11:39:12.717 | Modified: 2013-04-23 16:34:03.910
-- =====================================================
CREATE  Procedure [dbo].[sp_BPPBT]
@Choice varchar(1),
@NoBukti varchar(50),
@NoUrut varchar(10)='',
@Tanggal datetime=0,
@KdDep varchar(15)='',
@Urut int,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)=0,
@NoSat tinyint=0,
@Satuan varchar(5)='',
@Isi numeric(18,2)=0,
@KodeGdg Varchar(15)='',
@Qnt2 Numeric(18,2)=0,
@NoBPPB Varchar(25)='',
@UrutBPPB int=0,
@NoSatBPPB tinyint=0,
@KodegdgT varchar(15)

As

Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbBPPBTdet Where NoBukti=@NoBukti
  if not exists(select * from dbBPPBT Where NoBukti=@NoBukti) 
  begin
    insert into dbBPPBT (NOBUKTI, NOURUT, TANGGAL, KDDEP, KodeGdg, NoBPPB,KodeGdgT)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @KdDep,@KodeGdg,@NoBPPB,@KodegdgT)
  end
  insert into dbBPPBTDET (NOBUKTI, URUT, NoBPPB, UrutBPPB, NoSatBPPB, KODEBRG, QNT, NOSAT, ISI, SATUAN, Qnt2, Qnt2M,Qnt2P)
  values(@NOBUKTI, @URUT, @NoBPPB, @UrutBPPB, @NoSatBPPB, @KODEBRG, @Qnt, @NoSat, @Isi, @Satuan, @Qnt2, 0.00, 0.00)
end
if @Choice='U'
begin
  --Update dbBPPB set KodeGdgT=@KodeGdgT where NOBUKTI=@NoBukti 
  --update dbBPPBDET set KodeBrg=@KODEBRG, Qnt=case when @pilihan='M' Then @QNT else Qnt end, NOSAT=@NoSat, ISI=@ISI, SATUAN=@Satuan,Qnt2=Case when @pilihan='T' Then @Qnt2 else Qnt2 end
  --, Qnt2M=case when @pilihan='M' Then @QNT2M else Qnt2M end, Qnt2P=case when @pilihan='T' Then @Qnt2P else Qnt2P end
  --where NoBukti=@NoBukti and Urut=@Urut
  update dbBPPBTDET set Qnt=@Qnt, Qnt2=@Qnt2, NOSAT=@NoSat, ISI=@ISI, SATUAN=@Satuan
  where NoBukti=@NoBukti and Urut=@Urut
end
if @Choice='D'
begin
  delete dbBPPBTDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbBPPBTDET where NoBukti=@NoBukti)
  begin
    delete dbBPPBT where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return









GO

-- Procedure: Sp_Budget
-- Created: 2015-05-22 19:12:06.827 | Modified: 2015-05-22 19:49:48.010
-- =====================================================
--select * from DBNERACA 

CREATE  Procedure [dbo].[Sp_Budget]
@Perkiraan varchar(10),
@budget numeric(18,2),
@Bulan int,
@tahun int
as
Begin Tran
if not exists (Select Perkiraan from dbneraca where Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun) 
begin
  insert into dbneraca(Perkiraan,Devisi,Bulan,Tahun,Budget)
  values(@Perkiraan,'01',@bulan,@tahun,@budget)
  if @@error>0 Goto salah
end
else
begin
  update dbneraca set Budget=@Budget
  where Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
  if @@error>0 Goto salah 
end
commit Tran
return
Salah: Rollback Tran
       Return


GO

-- Procedure: sp_CekArusKas
-- Created: 2025-08-10 18:00:07.807 | Modified: 2025-08-11 11:12:04.193
-- =====================================================
CREATE Procedure [dbo].[sp_CekArusKas] 
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
as

-- =====================================================
-- UNIFIED CASH FLOW DETAIL QUERY - MULTIPLE KODESAK VERSION
-- Support multiple KodeSAK dengan IN() operator
-- SQL Server 2008 Compatible
-- =====================================================

/*DECLARE @bulan int = 1              -- Bulan laporan
DECLARE @Tahun int = 2025           -- Tahun laporan  
DECLARE @Devisi VARCHAR(15) = '01'  -- Kode divisi*/
DECLARE @KodeSAK VARCHAR(500) = '%'  -- Multiple KodeSAK separated by comma

-- Handle divisi wildcard
SET @Devisi = CASE WHEN @Devisi IN ('-','') THEN '%' ELSE @Devisi END;

-- Create temporary table for KodeSAK filter
IF OBJECT_ID('tempdb..#TempKodeSAK') IS NOT NULL DROP TABLE #TempKodeSAK;

CREATE TABLE #TempKodeSAK (
    KodeSAK VARCHAR(10)
);

-- Parse comma-separated KodeSAK values
IF @KodeSAK <> '%' AND @KodeSAK <> ''
BEGIN
    -- Split comma-separated values (SQL 2008 compatible method)
    DECLARE @pos INT, @piece VARCHAR(10);
    SET @KodeSAK = LTRIM(RTRIM(@KodeSAK)) + ',';
    SET @pos = CHARINDEX(',', @KodeSAK, 1);
    
    WHILE (@pos > 0)
    BEGIN
        SET @piece = LTRIM(RTRIM(LEFT(@KodeSAK, @pos - 1)));
        IF @piece <> ''
        BEGIN
            INSERT INTO #TempKodeSAK (KodeSAK) VALUES (@piece);
        END
        SET @KodeSAK = STUFF(@KodeSAK, 1, @pos, '');
        SET @pos = CHARINDEX(',', @KodeSAK, 1);
    END
END
ELSE
BEGIN
    -- Insert wildcard for all SAK codes
    INSERT INTO #TempKodeSAK (KodeSAK) VALUES ('%');
END

-- =====================================================
-- MAIN UNIFIED QUERY - MULTIPLE KODESAK SUPPORT
-- =====================================================

-- SECTION 1: REGULAR INVESTMENT TRANSACTIONS (SAK01-SAK04, SAK07)
select x.*,b.NamaSubAK ketsak from
(
SELECT 
    'REGULAR_INVESTMENT' AS Kategori,
    t.NoBukti,
    t.Tanggal,
    t.Devisi,
    a.Perkiraan,
    ISNULL(p1.Keterangan, a.Perkiraan) AS NamaPerkiraan,
    a.Lawan,
    ISNULL(p2.Keterangan, a.Lawan) AS NamaLawan,
    a.Keterangan AS KetTransaksi,
    a.Debet,
    a.Kredit,
    a.Kurs,
    a.Debet * a.Kurs AS DebetIDR,
    a.Kredit * a.Kurs AS KreditIDR,
    
    -- Kalkulasi nilai arus kas
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Kredit > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs 
        ELSE 0
    END) -
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
             AND a.Kredit > 0 THEN 0 
        ELSE 0
    END) AS NilaiArusKas,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
        THEN ISNULL(p2.KodeAK, 'AK01')
        ELSE ISNULL(p1.KodeAK, 'AK01')
    END AS KodeAK,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
        THEN ISNULL(p2.KodeSAK, 'N/A')
        ELSE ISNULL(p1.KodeSAK, 'N/A')
    END AS KodeSAK,
    
    ISNULL(a.JnsTransInvestasi, 0) AS JnsTransInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
        THEN a.Perkiraan
        ELSE a.Lawan
    END AS AccountKasBankInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
        THEN ISNULL(p2.GroupPerkiraan, '')
        ELSE ISNULL(p1.GroupPerkiraan, '')
    END AS GroupPerkiraan,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
        THEN ISNULL(p2.IsNonLedger, 0)
        ELSE ISNULL(p1.IsNonLedger, 0)
    END AS IsNonLedger,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
        THEN ISNULL(p2.IsInvestasi, 0)
        ELSE ISNULL(p1.IsInvestasi, 0)
    END AS IsInvestasi,
    
    ISNULL(t.TipeTransHd, '') AS TipeTransHd

FROM dbTrans t 
LEFT OUTER JOIN dbtransaksi a ON t.NoBukti = a.NoBukti
LEFT OUTER JOIN DBPERKIRAAN p1 ON p1.Perkiraan = a.Perkiraan  
LEFT OUTER JOIN DBPERKIRAAN p2 ON p2.Perkiraan = a.Lawan     

WHERE MONTH(t.Tanggal) = @bulan 
    AND YEAR(t.Tanggal) = @Tahun
    AND t.Devisi LIKE @Devisi
    AND ISNULL(t.TipeTransHd, '') <> 'BMM'
    AND ISNULL(a.JnsTransInvestasi, 0) <> 1
    AND ((a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))) 
         OR (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))))
    AND (
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) IN ('SAK01','SAK02','SAK03','SAK04','SAK07')
    )
    AND (
        EXISTS (SELECT 1 FROM #TempKodeSAK WHERE KodeSAK = '%') OR
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK','IVT'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%')
    )

UNION ALL

-- SECTION 2: DEBT/RECEIVABLE TRANSACTIONS (SAK06)
SELECT 
    'DEBT_RECEIVABLE' AS Kategori,
    t.NoBukti,
    t.Tanggal,
    t.Devisi,
    a.Perkiraan,
    ISNULL(p1.Keterangan, a.Perkiraan) AS NamaPerkiraan,
    a.Lawan,
    ISNULL(p2.Keterangan, a.Lawan) AS NamaLawan,
    a.Keterangan AS KetTransaksi,
    a.Debet,
    a.Kredit,
    a.Kurs,
    a.Debet * a.Kurs AS DebetIDR,
    a.Kredit * a.Kurs AS KreditIDR,
    
    -- Kalkulasi nilai arus kas untuk SAK06
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs 
        ELSE 0
    END) -
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0 
        ELSE 0
    END) AS NilaiArusKas,
    
    'AK01' AS KodeAK,
    'SAK05+' AS KodeSAK,
    ISNULL(a.JnsTransInvestasi, 0) AS JnsTransInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN a.Perkiraan
        ELSE a.Lawan
    END AS AccountKasBankInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.GroupPerkiraan, '')
        ELSE ISNULL(p1.GroupPerkiraan, '')
    END AS GroupPerkiraan,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsNonLedger, 0)
        ELSE ISNULL(p1.IsNonLedger, 0)
    END AS IsNonLedger,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsInvestasi, 0)
        ELSE ISNULL(p1.IsInvestasi, 0)
    END AS IsInvestasi,
    
    ISNULL(t.TipeTransHd, '') AS TipeTransHd

FROM dbTrans t 
LEFT OUTER JOIN dbtransaksi a ON t.NoBukti = a.NoBukti
LEFT OUTER JOIN DBPERKIRAAN p1 ON p1.Perkiraan = a.Perkiraan
LEFT OUTER JOIN DBPERKIRAAN p2 ON p2.Perkiraan = a.Lawan

WHERE MONTH(t.Tanggal) = @bulan 
    AND YEAR(t.Tanggal) = @Tahun
    AND t.Devisi LIKE @Devisi
    AND ISNULL(t.TipeTransHd, '') <> 'BMM'
    AND ((a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
         OR (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))))
    AND (
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) = 'SAK06'
    )
    AND (
        EXISTS (SELECT 1 FROM #TempKodeSAK WHERE KodeSAK = '%') OR
        'SAK06' IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%')
    )

UNION ALL

-- SECTION 3: INVESTMENT PLACEMENT/DISPOSAL (SAK05)
SELECT 
    'INVESTMENT_PLACEMENT_DISPOSAL' AS Kategori,
    t.NoBukti,
    t.Tanggal,
    t.Devisi,
    a.Perkiraan,
    ISNULL(p1.Keterangan, a.Perkiraan) AS NamaPerkiraan,
    a.Lawan,
    ISNULL(p2.Keterangan, a.Lawan) AS NamaLawan,
    a.Keterangan AS KetTransaksi,
    a.Debet,
    a.Kredit,
    a.Kurs,
    a.Debet * a.Kurs AS DebetIDR,
    a.Kredit * a.Kurs AS KreditIDR,
    
    -- Kalkulasi nilai arus kas untuk SAK05
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs 
        ELSE 0
    END) -
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0 
        ELSE 0
    END) AS NilaiArusKas,
    
    'AK01' AS KodeAK,
    
    -- Classification logic untuk SAK05+/SAK05-
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
             AND a.Kredit > 0 THEN 'SAK05+'
        WHEN a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
             AND a.Debet > 0 THEN 'SAK05+'
        ELSE 'SAK05-'
    END AS KodeSAK,
    
    ISNULL(a.JnsTransInvestasi, 0) AS JnsTransInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN a.Perkiraan
        ELSE a.Lawan
    END AS AccountKasBankInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.GroupPerkiraan, '')
        ELSE ISNULL(p1.GroupPerkiraan, '')
    END AS GroupPerkiraan,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsNonLedger, 0)
        ELSE ISNULL(p1.IsNonLedger, 0)
    END AS IsNonLedger,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsInvestasi, 0)
        ELSE ISNULL(p1.IsInvestasi, 0)
    END AS IsInvestasi,
    
    ISNULL(t.TipeTransHd, '') AS TipeTransHd

FROM dbTrans t 
LEFT OUTER JOIN dbtransaksi a ON t.NoBukti = a.NoBukti
LEFT OUTER JOIN DBPERKIRAAN p1 ON p1.Perkiraan = a.Perkiraan
LEFT OUTER JOIN DBPERKIRAAN p2 ON p2.Perkiraan = a.Lawan

WHERE MONTH(t.Tanggal) = @bulan 
    AND YEAR(t.Tanggal) = @Tahun
    AND t.Devisi LIKE @Devisi
    AND ISNULL(t.TipeTransHd, '') <> 'BMM'
    AND ((a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
         OR (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))))
    AND (
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) = 'SAK05'
    )
    AND (
        EXISTS (SELECT 1 FROM #TempKodeSAK WHERE KodeSAK = '%') OR
        'SAK05' IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%') OR
        'SAK05+' IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%') OR
        'SAK05-' IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%')
    )

UNION ALL

-- SECTION 4: INVESTMENT TRANSFER TRANSACTIONS (JnsTransInvestasi = 1,2)
SELECT 
    'TRANSFER_INVESTASI_TABUNGAN' AS Kategori,
    t.NoBukti,
    t.Tanggal,
    t.Devisi,
    a.Perkiraan,
    ISNULL(p1.Keterangan, a.Perkiraan) AS NamaPerkiraan,
    a.Lawan,
    ISNULL(p2.Keterangan, a.Lawan) AS NamaLawan,
    a.Keterangan AS KetTransaksi,
    a.Debet,
    a.Kredit,
    a.Kurs,
    a.Debet * a.Kurs AS DebetIDR,
    a.Kredit * a.Kurs AS KreditIDR,
    
    -- Kalkulasi nilai arus kas untuk transfer investasi
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs 
        ELSE 0
    END) -
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0 
        ELSE 0
    END) AS NilaiArusKas,
    
    'AK01' AS KodeAK,
    CASE 
        WHEN ISNULL(a.JnsTransInvestasi, 0) = 1 THEN 'SAK05-'
        WHEN ISNULL(a.JnsTransInvestasi, 0) = 2 THEN 'SAK05+'
        ELSE 'SAK05?'
    END AS KodeSAK,
    ISNULL(a.JnsTransInvestasi, 0) AS JnsTransInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN a.Perkiraan
        ELSE a.Lawan
    END AS AccountKasBankInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.GroupPerkiraan, '')
        ELSE ISNULL(p1.GroupPerkiraan, '')
    END AS GroupPerkiraan,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsNonLedger, 0)
        ELSE ISNULL(p1.IsNonLedger, 0)
    END AS IsNonLedger,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsInvestasi, 0)
        ELSE ISNULL(p1.IsInvestasi, 0)
    END AS IsInvestasi,
    
    ISNULL(t.TipeTransHd, '') AS TipeTransHd

FROM dbTrans t 
LEFT OUTER JOIN dbtransaksi a ON t.NoBukti = a.NoBukti
LEFT OUTER JOIN DBPERKIRAAN p1 ON p1.Perkiraan = a.Perkiraan
LEFT OUTER JOIN DBPERKIRAAN p2 ON p2.Perkiraan = a.Lawan

WHERE MONTH(t.Tanggal) = @bulan 
    AND YEAR(t.Tanggal) = @Tahun
    AND t.Devisi LIKE @Devisi
    AND ISNULL(t.TipeTransHd, '') <> 'BMM'
    AND ISNULL(a.JnsTransInvestasi, 0) IN (1, 2)
    AND ((a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
         OR (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))))
    AND (
        EXISTS (SELECT 1 FROM #TempKodeSAK WHERE KodeSAK = '%') OR
        (CASE 
            WHEN ISNULL(a.JnsTransInvestasi, 0) = 1 THEN 'SAK05-'
            WHEN ISNULL(a.JnsTransInvestasi, 0) = 2 THEN 'SAK05+'
            ELSE 'SAK05?'
        END) IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%')
    )

UNION ALL

-- SECTION 5: OPERATIONAL TRANSACTIONS (SAK08-SAK15)
SELECT 
    'OPERATIONAL' AS Kategori,
    t.NoBukti,
    t.Tanggal,
    t.Devisi,
    a.Perkiraan,
    ISNULL(p1.Keterangan, a.Perkiraan) AS NamaPerkiraan,
    a.Lawan,
    ISNULL(p2.Keterangan, a.Lawan) AS NamaLawan,
    a.Keterangan AS KetTransaksi,
    a.Debet,
    a.Kredit,
    a.Kurs,
    a.Debet * a.Kurs AS DebetIDR,
    a.Kredit * a.Kurs AS KreditIDR,
    
    -- Kalkulasi nilai arus kas untuk operational
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs 
        ELSE 0
    END) -
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0 
        ELSE 0
    END) AS NilaiArusKas,
    
    'AK02' AS KodeAK,
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.KodeSAK, 'N/A')
        ELSE ISNULL(p1.KodeSAK, 'N/A')
    END AS KodeSAK,
    ISNULL(a.JnsTransInvestasi, 0) AS JnsTransInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN a.Perkiraan
        ELSE a.Lawan
    END AS AccountKasBankInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.GroupPerkiraan, '')
        ELSE ISNULL(p1.GroupPerkiraan, '')
    END AS GroupPerkiraan,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsNonLedger, 0)
        ELSE ISNULL(p1.IsNonLedger, 0)
    END AS IsNonLedger,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsInvestasi, 0)
        ELSE ISNULL(p1.IsInvestasi, 0)
    END AS IsInvestasi,
    
    ISNULL(t.TipeTransHd, '') AS TipeTransHd

FROM dbTrans t 
LEFT OUTER JOIN dbtransaksi a ON t.NoBukti = a.NoBukti
LEFT OUTER JOIN DBPERKIRAAN p1 ON p1.Perkiraan = a.Perkiraan
LEFT OUTER JOIN DBPERKIRAAN p2 ON p2.Perkiraan = a.Lawan

WHERE MONTH(t.Tanggal) = @bulan 
    AND YEAR(t.Tanggal) = @Tahun
    AND t.Devisi LIKE @Devisi
    AND ISNULL(t.TipeTransHd, '') <> 'BMM'
    AND ((a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
         OR (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))))
    AND (
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) IN ('SAK08','SAK09','SAK10','SAK11','SAK12','SAK13','SAK14','SAK15')
    )
    AND (
        EXISTS (SELECT 1 FROM #TempKodeSAK WHERE KodeSAK = '%') OR
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%')
    )

UNION ALL

-- SECTION 6: FUNDING TRANSACTIONS (SAK16-SAK22)
SELECT 
    'FUNDING' AS Kategori,
    t.NoBukti,
    t.Tanggal,
    t.Devisi,
    a.Perkiraan,
    ISNULL(p1.Keterangan, a.Perkiraan) AS NamaPerkiraan,
    a.Lawan,
    ISNULL(p2.Keterangan, a.Lawan) AS NamaLawan,
    a.Keterangan AS KetTransaksi,
    a.Debet,
    a.Kredit,
    a.Kurs,
    a.Debet * a.Kurs AS DebetIDR,
    a.Kredit * a.Kurs AS KreditIDR,
    
    -- Kalkulasi nilai arus kas untuk funding
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs 
        ELSE 0
    END) -
    (CASE 
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN 0
        WHEN (a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN a.Kredit * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Debet > 0 THEN a.Debet * a.Kurs
        WHEN (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
             AND a.Kredit > 0 THEN 0 
        ELSE 0
    END) AS NilaiArusKas,
    
    'AK03' AS KodeAK,
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.KodeSAK, 'N/A')
        ELSE ISNULL(p1.KodeSAK, 'N/A')
    END AS KodeSAK,
    ISNULL(a.JnsTransInvestasi, 0) AS JnsTransInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN a.Perkiraan
        ELSE a.Lawan
    END AS AccountKasBankInvestasi,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.GroupPerkiraan, '')
        ELSE ISNULL(p1.GroupPerkiraan, '')
    END AS GroupPerkiraan,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsNonLedger, 0)
        ELSE ISNULL(p1.IsNonLedger, 0)
    END AS IsNonLedger,
    
    CASE 
        WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
        THEN ISNULL(p2.IsInvestasi, 0)
        ELSE ISNULL(p1.IsInvestasi, 0)
    END AS IsInvestasi,
    
    ISNULL(t.TipeTransHd, '') AS TipeTransHd

FROM dbTrans t 
LEFT OUTER JOIN dbtransaksi a ON t.NoBukti = a.NoBukti
LEFT OUTER JOIN DBPERKIRAAN p1 ON p1.Perkiraan = a.Perkiraan
LEFT OUTER JOIN DBPERKIRAAN p2 ON p2.Perkiraan = a.Lawan

WHERE MONTH(t.Tanggal) = @bulan 
    AND YEAR(t.Tanggal) = @Tahun
    AND t.Devisi LIKE @Devisi
    AND ISNULL(t.TipeTransHd, '') <> 'BMM'
    AND ((a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))) 
         OR (a.Lawan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))))
    AND (
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) IN ('SAK16','SAK17','SAK18','SAK19','SAK20','SAK21','SAK22')
    )
    AND (
        EXISTS (SELECT 1 FROM #TempKodeSAK WHERE KodeSAK = '%') OR
        (CASE 
            WHEN a.Perkiraan IN (SELECT Perkiraan FROM DBPOSTHUTPIUT WHERE Kode IN ('KAS','BANK'))
            THEN ISNULL(p2.KodeSAK, '')
            ELSE ISNULL(p1.KodeSAK, '')
        END) IN (SELECT KodeSAK FROM #TempKodeSAK WHERE KodeSAK <> '%')
    )
) x
left outer join DBArusKasDet b on x.KodeSAK =b.KodeSubAK 
order by x.KodeSAK
-- Cleanup temp table
DROP TABLE #TempKodeSAK;
/*
-- =====================================================
-- PARAMETER INFO
-- =====================================================
PRINT '';
PRINT '=== QUERY EXECUTION INFO ===';
SELECT 
    'Unified Cash Flow Detail Query - Multiple KodeSAK Version' as QueryName,
    @bulan as Bulan,
    @Tahun as Tahun,
    @Devisi as Devisi,
    'Multiple KodeSAK supported with comma separation' as FilterKodeSAK,
    GETDATE() as ExecutedAt;

-- =====================================================
-- USAGE EXAMPLES:
-- ===================================================== */
/*
-- Example 1: Single KodeSAK
DECLARE @KodeSAK VARCHAR(500) = 'SAK01';

-- Example 2: Multiple KodeSAK
DECLARE @KodeSAK VARCHAR(500) = 'SAK01,SAK02,SAK05';

-- Example 3: All KodeSAK
DECLARE @KodeSAK VARCHAR(500) = '%';

-- Example 4: SAK05 variations
DECLARE @KodeSAK VARCHAR(500) = 'SAK05+,SAK05-';

-- Example 5: Mixed categories
DECLARE @KodeSAK VARCHAR(500) = 'SAK01,SAK06,SAK08,SAK16';
*/
GO

-- Procedure: Sp_CekPerlLR
-- Created: 2014-02-13 11:48:39.557 | Modified: 2014-09-24 14:58:55.427
-- =====================================================



CREATE Procedure [dbo].[Sp_CekPerlLR]
@Perkiraan1 varchar(25),
@Perkiraan2 varchar(25)
as
select Perkiraan,Keterangan from dbPerkiraan where  Kelompok >2 and 
Perkiraan not in ( 
				  select distinct(a.Perkiraan) from (
					select distinct(Perkiraan) Perkiraan from DBLRHPP
					union all
					select distinct(Perkiraan) Perkiraan 
					from DBPERKIRAAN where 
					left(Perkiraan,2)in(select distinct(LEFT(A.Perkiraan,2)) 
									from DBLRHPP A 
								   Left Outer Join DBPERKIRAAN B on A.Perkiraan = B.Perkiraan
								   Where B.Tipe=0
									) 
					and Tipe=1 and Kelompok>1
					
					Union All
					
					select distinct(A.Perkiraan) Perkiraan
					from DBPERKIRAAN A
					Left Outer join DBLRHPP B on A.Perkiraan=B.Perkiraan
					where A.Perkiraan like '%.%' 
					and left(A.Perkiraan,3) =B.Perkiraan
					)a
				)	

				
				
				



GO

-- Procedure: sp_CekProsesSelanjutnya
-- Created: 2014-11-19 13:21:26.377 | Modified: 2014-11-19 13:21:26.377
-- =====================================================


create   Procedure [dbo].[sp_CekProsesSelanjutnya]
@NamaTabel varchar(50),
@NoBukti varchar(30),
@Urut int

As

if @NamaTabel='DBPODET'
begin
	select A.NOBUKTI, A.TANGGAL
	from DBBELI A, DBBELIDET B
	where A.NOBUKTI=B.NOBUKTI and B.NoPO=@NoBukti and B.UrutPO=@Urut
end else
begin
	select A.NOBUKTI, A.TANGGAL
	from DBBELI A
	where A.NOBUKTI='XXX'
end

GO

-- Procedure: Sp_CekStockAkhir
-- Created: 2015-03-24 15:23:44.897 | Modified: 2015-03-24 15:23:44.897
-- =====================================================


Create Procedure [dbo].[Sp_CekStockAkhir] 
@Nosat integer,
@tanggal datetime,
@KOdegdg varchar(20),
@kodebrg Varchar(20)

--select @Nosat=1,@tanggal='08/29/2014',@KOdegdg='G002',@kodebrg='PKG.BX.0010' 
as
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
select A.KodeBrg, B.NamaBrg,
case when @Nosat=1 then B.Sat1 
	 when @nosat=2 then B.SAT2 
	 when @Nosat=3 then B.SAT3 end Sat1, 
	 A.KodeGdg, C.Nama NamaGdg, 
 	 A.SALDOQNT/case when @Nosat=1 then B.ISI1 
				when @nosat=2 then B.ISI2 when 
				@Nosat=3 then B.ISI3 end SALDOQNT 
from 
(
select 	KodeBrg, KodeGdg, sum(SaldoQnt) SaldoQnt 
from 
(  
select        KodeBrg, KodeGdg, QntAwal SaldoQnt 
from 	dbStockBrg 
where         Tahun=year(@Tanggal) and Bulan=MONTH(@tanggal)
and KodeGdg =@KOdegdg
union all 
select 	KodeBrg, KodeGdg, 
	SUM(QntDb)-SUM(QntCr) SaldoQnt

from 	vwKartuStock 
where 	year(Tanggal)=year(@tanggal) and month(tanggal)=month(@tanggal) and Tanggal<=@tanggal
and KodeGdg = Kodegdg  and Tipe not in ('AWL')
group by KodeBrg, KodeGdg
) X 
group by KodeBrg, KodeGdg 
) A
left outer join dbBarang B on B.KodeBrg=A.KodeBrg 
left outer join dbGudang C on C.KodeGdg=A.KodeGdg 
where  A.KODEBRG=@kodebrg and
A.KODEGDG=@KOdegdg
order by  A.KodeBrg, A.KodeGdg 

GO

-- Procedure: Sp_CetakPO
-- Created: 2013-05-13 12:11:46.957 | Modified: 2013-12-24 09:51:48.307
-- =====================================================

CREATE Procedure [dbo].[Sp_CetakPO]
@NoBukti varchar(30),@Tipe TinyInt
as
select F.*,D.NoPPL,E.TELPON,E.FAX,E.ContactP, A.KodeBrg,g.alamat as alamatkirim,
       --Case when @Tipe =1 Then B.NAMABRG else B.NamaBrg2 end NAMABRG,
       B.NAMABRG,
       A.Tanggal TglKrm,A.Qnt QntKrm,Isnull(D.HARGA,0) - Isnull(D.DISCTOT,0) HrgKrm,
       Isnull(D.harga,0)harga,Isnull(D.DiscTOt,0)DiscTot,Isnull(D.Subtotal,0)Subtotal,F.TotDpp,
       (D.harga - D.DISCTOT) * A.Qnt TotalDetKirim,
       A.Qnt*(D.harga - D.DISCTOT) Total,
       Dbo.terbilang(F.TotDpp + F.TotPPnRP-F.TotDiskon) terbilang, F.TotDpp + F.TotPPnRP-F.TotDiskon GrandTot,
E.Alamat1+Char(13)+E.Alamat2+Char(13)+E.kota Alamat,E.NamaCustSupp ,F.TotPPNRp,F.TotDiskon,
Isnull(D.SATUAN,(Select SATUAN from DBPODET where NOBUKTI=@NoBukti and KODEBRG=A.KodeBrg))Satuan, 
Case when C.TIPEBAYAR=0 Then 'TUNAI' else 'KREDIT' end Pembayaran,C.HARI,D.Disc Disc ,E.HARIHUTPIUT,E.HARI HariCust,
ISNULL(C.NilaiCetak,0)+1 Cetakke,C.KODEVLS,E.Att,C.KETERANGAN
from DBKirimDET A
Left Outer join DBBARANG B on A.KodeBrg = B.KODEBRG
Left outer join DBPO C on A.NoBukti = C.NOBUKTI
Left Outer join (select Nobukti,KOdebrg, SATUAN,NoPPL, 
                        Sum(Isnull(harga,0)) Harga, Sum(isnull(DISCP,0))Disc, 
                        Sum(isnull(Disctot,0)) Disctot, Sum(ISnull(Subtotal,0)) SubTotal,SUM(isnull(Qnt,0)) TotQnt 
                 from DBPODET 
                 Group By NOBUKTI,KodeBrg,SATUAN, NoPPL) D on A.NoBukti = D.NOBUKTI and A.KodeBrg = D.KODEBRG
Left Outer join DBCUSTSUPP E on C.KODESUPP = E.KODECUSTSUPP
Left Outer join VwMasterPO F on A.nobukti = F.Nobukti
Left outer join DBGUDANG G on g.KODEGDG =c.KodeGDG
where	A.NOBUKTI=@NoBukti and A.KodeBrg=D.KODEBRG
order by A.KodeBrg, A.Tanggal



GO

-- Procedure: Sp_CetakSO1
-- Created: 2012-12-20 15:40:05.530 | Modified: 2013-04-12 11:23:34.997
-- =====================================================
CREATE Procedure [dbo].[Sp_CetakSO1]
@NOBUKTI varchar(20)

As


Select 	A.NoBukti, A.NOURUT, A.Tanggal, A.TglJatuhTempo, A.KodeCUST, C.NamaCUST, C.Alamat,
        O.Alamat AlamatKirim,''KodeBrd,'' NamaBrd,'' kodeSize,''NamaWarna,
	A.Handling, A.KodeSls, F.Nama NamaSls, A.Keterangan, A.KodeVls, D.NamaVls, A.Kurs, A.PPN, 
	A.TipeBayar, A.Hari, A.TipeDisc, A.Disc, A.DiscRp, A.Catatan,
	B.Urut, B.KodeBrg, H.NamaBrg, B.Qnt, B.NoSat, B.Isi, H.Sat1 Satuan,
        B.Qnt2, H.Sat2 SatuanRoll, B.Harga, B.HrgNetto,
        B.DiscP1, B.DiscRp1, B.DiscTot,
        B.SubTotal TotalUSD, B.SubTotalRp TotalIDR, B.NDPPRp NDPP,
        B.NPPNRp NPPN, B.BYAngkut Beban, B.SubTotalRp + B.BYAngkut Total,
        I.TotSubTotal, I.TotDiskon, I.TotTotal, I.TotDPP, I.TotPPN, I.TotNet,
        I.TotSubTotalRp, I.TotDiskonRp, I.TotTotalRp, I.TotDPPRp, I.TotPPNRp, I.TotNetRp,
        A.KodeExp, M.NamaExp, '' KetDetail,isnull(A.Cetakke,0)+1 CetakN
From dbSO A
Left Outer join dbSODet B on B.NoBukti=a.NoBukti
Left Outer Join vwBrowsCustomer C on C.KodeCust=A.KodeCust
Left Outer join dbValas D on D.KodeVls=A.KodeVls
left outer join dbKaryawan F on F.KeyNIK=A.KodeSls
Left Outer Join vwSatuanBrg H on H.KodeBrg=B.KodeBrg
Left Outer Join vwRpDetSO I on I.NoBukti=A.NoBukti
Left Outer Join vwAlamatCust O on O.KODECUSTSUPP=A.KODECUST and O.NOMOR=A.NOAlamatKirim
left outer join dbExpedisi M on M.KodeExp=A.KodeExp
where	A.NoBukti=@NoBukti
order by B.Urut
GO

-- Procedure: SP_CheckStockAvailability
-- Created: 2025-08-21 08:09:41.843 | Modified: 2025-08-21 08:09:41.843
-- =====================================================

    CREATE PROCEDURE SP_CheckStockAvailability
        @KODEBRG NVARCHAR(20),
        @QtyRequired DECIMAL(15,2),
        @BULAN INT = NULL,
        @TAHUN INT = NULL
    AS
    BEGIN
        SET NOCOUNT ON;
        
        -- Set default bulan/tahun if not provided
        IF @BULAN IS NULL SET @BULAN = MONTH(GETDATE());
        IF @TAHUN IS NULL SET @TAHUN = YEAR(GETDATE());
        
        SELECT 
            b.KODEBRG,
            b.NAMABRG,
            ISNULL(s.SALDOQNT, 0) AS StockTersedia,
            @QtyRequired AS QtyDibutuhkan,
            CASE 
                WHEN ISNULL(s.SALDOQNT, 0) >= @QtyRequired THEN 'TERSEDIA'
                WHEN ISNULL(s.SALDOQNT, 0) > 0 THEN 'KURANG'
                ELSE 'KOSONG'
            END AS StatusKetersediaan,
            (ISNULL(s.SALDOQNT, 0) - @QtyRequired) AS Selisih,
            b.QntMin AS StockMinimum,
            CASE 
                WHEN (ISNULL(s.SALDOQNT, 0) - @QtyRequired) < b.QntMin THEN 'WARNING: Stock akan di bawah minimum'
                ELSE 'OK'
            END AS Peringatan
        FROM DBBARANG b
        LEFT JOIN DBSTOCKBRG s ON b.KODEBRG = s.KODEBRG 
            AND s.BULAN = @BULAN AND s.TAHUN = @TAHUN
        WHERE b.KODEBRG = @KODEBRG;
    END
    
GO

-- Procedure: SP_ClosePO
-- Created: 2025-08-21 08:09:41.670 | Modified: 2025-08-21 08:09:41.670
-- =====================================================

    CREATE PROCEDURE SP_ClosePO
        @NOBUKTI NVARCHAR(20),
        @UserClose NVARCHAR(50)
    AS
    BEGIN
        SET NOCOUNT ON;
        BEGIN TRANSACTION;
        
        BEGIN TRY
            -- Check if PO exists and not already closed
            IF NOT EXISTS (SELECT 1 FROM DBPO WHERE NOBUKTI = @NOBUKTI)
            BEGIN
                RAISERROR('PO not found', 16, 1);
                RETURN;
            END
            
            IF EXISTS (SELECT 1 FROM DBPO WHERE NOBUKTI = @NOBUKTI AND IsClose = 1)
            BEGIN
                RAISERROR('PO already closed', 16, 1);
                RETURN;
            END
            
            -- Close the PO
            UPDATE DBPO 
            SET IsClose = 1,
                TglBatal = GETDATE(),
                UserBatal = @UserClose
            WHERE NOBUKTI = @NOBUKTI;
            
            -- Close all PO details
            UPDATE DBPODET 
            SET IsClose = 1
            WHERE NOBUKTI = @NOBUKTI;
            
            COMMIT TRANSACTION;
            
            SELECT 'SUCCESS' AS Status, 'PO successfully closed' AS Message;
            
        END TRY
        BEGIN CATCH
            ROLLBACK TRANSACTION;
            
            SELECT 'ERROR' AS Status, ERROR_MESSAGE() AS Message;
        END CATCH
    END
    
GO

-- Procedure: Sp_Contact
-- Created: 2011-10-25 16:13:08.997 | Modified: 2011-10-25 16:13:08.997
-- =====================================================
Create Procedure [dbo].[Sp_Contact]
@Choice char,
@Title Varchar(15),
@FirstName varchar(20),
@MiddleName varchar(20),
@LastName Varchar(20),
@JobTitle Varchar(40),
@Phone1 varchar(40),
@Phone2 varchar(40),
@Phone3 varchar(40),
@Email varchar(40),
@Alamat ntext,
--@Photo Image,
@KodeSupp Varchar(15),
@OldKode int
As
Declare @ContactID int
Begin tran
  If @Choice='I' 
  begin
    Select @ContactId=Max(Isnull(Contactid,0)) From dbContact
    Set @ContactId=isnull(@ContactId,0)+1
    Insert into dbContact(ContactId,Title,FirstName,MiddleName,LastName,JobTitle,Phone1,Phone2,
                          Phone3,Email,Alamat,--Photo,
                          KODECUSTSUPP)
    Values(@ContactId,@Title,@FirstName,@MiddleName,@LastName,@JobTitle,@Phone1,@Phone2,
           @Phone3,@Email,@Alamat,--@Photo,
           @KodeSupp) 
  end
  else if @Choice='U' 
  begin
    Update dbContact Set FirstName=@Firstname,MiddleName=@Middlename,LastName=@LastName,JobTitle=@Jobtitle,
                         Phone1=@Phone1,Phone2=@Phone2,Phone3=@Phone3,Email=@Email,Alamat=@Alamat,
                         --Photo=@Photo,
                         Title=@Title
    where Contactid=@Oldkode and KODECUSTSUPP=@kodeSupp
  end
  else if @Choice='D'
  begin
    Delete From dbContact where Contactid=@OldKode and KODECUSTSUPP=@kodeSupp
  end
  if @@Error<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           raiserror('Proses Input Data Gagal',16,1)
           Return

GO

-- Procedure: sp_Cost
-- Created: 2014-11-10 09:10:06.790 | Modified: 2014-11-10 09:10:06.790
-- =====================================================

create PROCEDURE [dbo].[sp_Cost]
@Choice char(1),
@KodeCost Varchar(30),
@NamaCost Varchar(500)

AS
begin tran
if @choice='I'
begin
	insert into dbCost (KodeCost, NamaCost)
	values (@KodeCost, @NamaCost)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbCost set NamaCost=@NamaCost
             where KodeCost=@KodeCost
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBPERKCOST where KodeCost=@KodeCost
	if @@error <> 0 goto jikasalah
	delete  dbCost where KodeCost=@KodeCost
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return





GO

-- Procedure: SP_CostAnalysis
-- Created: 2025-08-21 08:54:48.847 | Modified: 2025-08-21 08:54:48.847
-- =====================================================

    CREATE PROCEDURE SP_CostAnalysis
        @KODEBRG NVARCHAR(20) = NULL,
        @KODEGRP NVARCHAR(10) = NULL,
        @TanggalAwal DATE,
        @TanggalAkhir DATE
    AS
    BEGIN
        SET NOCOUNT ON;
        
        SELECT 
            b.KODEBRG,
            b.NAMABRG,
            b.KODEGRP,
            -- Harga dari master barang
            b.Hrg1_1 AS HargaBeli_Master,
            b.Hrg2_1 AS HargaJual_Master,
            -- Harga rata-rata dari transaksi pembelian
            AVG(bd.HARGA) AS HargaBeli_Rata,
            MIN(bd.HARGA) AS HargaBeli_Min,
            MAX(bd.HARGA) AS HargaBeli_Max,
            -- Harga rata-rata dari transaksi penjualan  
            AVG(jd.HARGA) AS HargaJual_Rata,
            MIN(jd.HARGA) AS HargaJual_Min,
            MAX(jd.HARGA) AS HargaJual_Max,
            -- Analisis margin
            (AVG(jd.HARGA) - AVG(bd.HARGA)) AS Margin_Rata,
            CASE 
                WHEN AVG(bd.HARGA) > 0 THEN
                    ((AVG(jd.HARGA) - AVG(bd.HARGA)) / AVG(bd.HARGA)) * 100
                ELSE 0
            END AS Margin_Persen
        FROM DBBARANG b
        LEFT JOIN DBBELIDET bd ON b.KODEBRG = bd.KODEBRG
        LEFT JOIN DBBELI bl ON bd.NOBUKTI = bl.NOBUKTI 
            AND bl.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND bl.IsBatal = 0
        LEFT JOIN DBJUALDET jd ON b.KODEBRG = jd.KODEBRG
        LEFT JOIN DBJUAL jl ON jd.NOBUKTI = jl.NOBUKTI
            AND jl.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND jl.ISBATAL = 0
        WHERE b.ISAKTIF = 1
            AND (@KODEBRG IS NULL OR b.KODEBRG = @KODEBRG)
            AND (@KODEGRP IS NULL OR b.KODEGRP = @KODEGRP)
        GROUP BY b.KODEBRG, b.NAMABRG, b.KODEGRP, b.Hrg1_1, b.Hrg2_1
        HAVING AVG(bd.HARGA) IS NOT NULL OR AVG(jd.HARGA) IS NOT NULL
        ORDER BY b.KODEBRG;
    END
    
GO

-- Procedure: sp_creatediagram
-- Created: 2010-12-03 09:27:10.730 | Modified: 2010-12-03 09:27:10.730
-- =====================================================

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END
	
GO

-- Procedure: Sp_DebetNote
-- Created: 2012-12-27 14:35:55.303 | Modified: 2014-02-13 11:46:22.573
-- =====================================================

CREATE   Procedure [dbo].[Sp_DebetNote]
@Choice varchar(1),
@NoBukti varchar(20),
@Tanggal datetime,
@Keterangan varchar(100),
@Urut int,
@NoInv varchar(20),
@KodeSupp Varchar(15)='',
@Nilai Numeric(18,2),
@KodeVls Varchar(15),
@Kurs Numeric(18,2),
@NilaiRp Numeric(18,2),
@Nourut Varchar(5)

As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbDebetNoteDet Where NoBukti=@NoBukti
  if not exists(select * from dbDebetNote Where NoBukti=@NoBukti) 
  begin
    insert into dbDebetNote (NOBUKTI,NoUrut, TANGGAL, KodeSupp)
    values (@NOBUKTI,@Nourut, @TANGGAL, @KodeSupp)
  end
  insert into dbDebetNoteDET (NOBUKTI, URUT,Keterangan,NoInv,Nilai,KodeVLS, Kurs, NilaiRp)
  values(@NOBUKTI, @URUT,@Keterangan,@NoInv,@Nilai, @KodeVls, @Kurs, @NilaiRp)
end
if @Choice='U'
begin
  update dbDebetNoteDET set NoInv=@NoInv,Keterangan=@Keterangan,Nilai=@Nilai, KodeVLS=@KodeVls, Kurs=@Kurs, NilaiRp=@NilaiRp
  where NoBukti=@NoBukti and Urut=@Urut
end

if @Choice='D'
begin
  delete dbDebetNoteDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbDebetNoteDET where NoBukti=@NoBukti)
  begin
    delete dbDebetNote where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return





GO

-- Procedure: Sp_DEPART
-- Created: 2012-11-13 15:26:06.793 | Modified: 2012-11-26 14:53:13.633
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_DEPART]
@Choice char(1),
@KDDEP Varchar(15),
@NMDEP Varchar(40),
@OldKode varchar(15),
@PerkBiaya Varchar(25)
AS
begin tran
if @choice='I'
begin
	insert into dbDepart (KdDep, NmDep,PerkBiaya)
	values (@KDDEP, @NMDEP,@PerkBiaya)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbDepart set NmDep=@NmDep ,KdDep=@KDDEP,PerkBiaya=@PerkBiaya
             where KdDep=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbDepart where KdDep=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: SP_DEPOSITO
-- Created: 2011-03-03 13:27:53.877 | Modified: 2011-03-03 13:27:53.877
-- =====================================================


CREATE PROCEDURE [dbo].[SP_DEPOSITO]
@Choice char(1),
@Bank varchar(20),
@NoDEPOSITO varchar(20),
@Tanggal datetime,
@TglJatuhTempo datetime,
@KodeVls varchar(10),
@Kurs numeric(18,2),
@Jumlah Numeric(18,2),
@TglBuka datetime,
@BuktiBuka varchar(20),
@Keteranganbuka varchar(50),
@TglCair datetime,
@BuktiCair varchar(20),
@KeteranganCair varchar(50),
@Tipe varchar(2)
AS
begin tran
Declare @Debet numeric(18,2), @kredit Numeric(18,2),
        @DebetRp numeric(18,2), @kreditRp Numeric(18,2)
Set @Debet=@Jumlah
Set @kredit=0
Set @DebetRp=@Jumlah*@Kurs
Set @kreditRp=0
if @choice='I'
begin
  insert into DBDEPOSITO (Bank, NoDEPOSITO, Tanggal, TglJatuhTempo, Debet, Kredit, DebetRp, KreditRp, Keterangan, TglBuka, BuktiBuka, KodeVls, Kurs, KeteranganCair, TglCair, BuktiCair,Tipe)
  values (@Bank, @NoDEPOSITO, @Tanggal, @TgljatuhTempo, @Debet, @Kredit, @DebetRp, @kreditRp, @Keteranganbuka, @TglBuka, @BuktiBuka, @KodeVls, @Kurs, @KeteranganCair, @TglCair, @BuktiCair,@Tipe)
  if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
  update DBDEPOSITO set Tanggal=@TglJatuhTempo, Debet=@Debet, Kredit=@Kredit, Keterangan=@Keteranganbuka, 
                        TglBuka=@TglBuka, BuktiBuka=@BuktiBuka, KodeVls=@KodeVls, Kurs=@Kurs, 
                        KeteranganCair=@KeteranganCair, TglCair=@TglCair, BuktiCair=@BuktiCair
             where NoDEPOSITO=@NoDEPOSITO and bank=@bank
  if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
  if exists (select 'true' from DBDEPOSITO where noDEPOSITO=@noDEPOSITO and bank=@bank and tglcair is null and tipe=@Tipe)
 begin
  delete DBDEPOSITO 
  where NoDEPOSITO=@NoDEPOSITO and bank=@bank and Tipe=@Tipe
  -- if @@error <> 0 goto jikasalah
 end
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return



GO

-- Procedure: Sp_Devisi
-- Created: 2014-02-13 11:49:33.813 | Modified: 2014-02-13 11:49:33.813
-- =====================================================


Create PROCEDURE [dbo].[Sp_Devisi]
@Choice char(1),
@Devisi Varchar(15),
@Namadevisi Varchar(50)

AS
begin tran
if @choice='I'
begin
	insert into DBdevisi (Devisi, NamaDevisi)
	values (@Devisi, @Namadevisi)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBdevisi set NamaDevisi=@Namadevisi
             where Devisi=@Devisi
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBdevisi where Devisi=@Devisi
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return



GO

-- Procedure: Sp_DiskonHarian
-- Created: 2013-08-30 14:10:33.690 | Modified: 2013-08-30 14:10:33.690
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_DiskonHarian]
@Choice char(1),
@Hari int,
@Diskon numeric(18,2),
@Aktif bit,
@OldKode int
AS
begin tran
if @choice='I'
begin
	insert into dbDiskonHarian (Hari, Diskon, Aktif)
	values (@Hari, @Diskon, @Aktif)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbDiskonHarian set Diskon=@Diskon, Aktif=@Aktif
             where Hari=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbDiskonHarian where Hari=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: sp_dropdiagram
-- Created: 2010-12-03 09:27:10.747 | Modified: 2010-12-03 09:27:10.747
-- =====================================================

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END
	
GO

-- Procedure: Sp_Expedisi
-- Created: 2012-11-28 13:19:19.590 | Modified: 2012-11-28 13:19:19.590
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_Expedisi]
@Mode varchar(1), 
@KodeExp varchar(20),
@NamaExp varchar(40),
@Alamat1 varchar(100),
@Alamat2 varchar(100),
@Kota varchar(30),
@KodePos varchar(7),
@Telpon varchar(30),
@Hp varchar(30),
@Fax varchar(30),
@Email varchar(100),
@Contact varchar(50),
@Perkiraan varchar(15),
@Aktif int

AS

begin tran

if @Mode='I'
begin
    insert into dbExpedisi(KodeExp, NamaExp, Alamat1, Alamat2, Kota, KodePos, Telpon, HP, Fax, Email, 
		Contact, Perkiraan, Aktif)
    values(@KodeExp, @NamaExp, @Alamat1, @Alamat2, @Kota, @KodePos, @Telpon, @HP, @Fax, @Email, 
		@Contact, @Perkiraan, @Aktif)
   if @@error <> 0
     goto Salah
end
if @Mode='U'
begin
     update dbExpedisi
     set   NamaExp=@NamaExp, Alamat1=@Alamat1, Alamat2=@Alamat2, Kota=@Kota, KodePos=@KodePos, Telpon=@Telpon,
	HP=@HP, Fax=@Fax, Email=@Email, Contact=@Contact, Aktif=@Aktif
     where KodeExp=@KodeExp

     if @@error <> 0 
      goto Salah 
end
if @Mode='D'
begin
     Delete dbExpedisi 
     where KodeExp=@KodeExp
     
    if @@error <> 0 
     goto Salah
end


commit tran
--insert into dblog(tipe,userid,tglupdate,keterangan)
--values('dbekspedisi ','-',getdate(),@kodeeksped)
return

Salah:
        rollback tran
        return


GO

-- Procedure: sp_fakturpajak
-- Created: 2013-07-11 12:27:45.163 | Modified: 2013-07-11 12:27:45.163
-- =====================================================


CREATE procedure [dbo].[sp_fakturpajak]
@Nobukti varchar(30)
as
select 	D.NoBukti, D.NoBukti NoPNJ, C.KodeBrg, isnull(d.NoPajak,'') NOFPJ,
	case when year(D.TglFPJ)=1899 then null else D.TglFPJ end TglFPJ
	, N.NoSeri MySeri, D.Kurs, E.Usaha, F.KodeGrp,
	
	P.NAMAPKP NamaPKP, P.ALAMATPKP1+Char(13)+P.ALAMATPKP2+' '+Char(13)+P.KOTAPKP AlamatPKP,p.alamat2,
	P.NPWP NPWPPKP, P.TglPengukuhan TglPKP,
	D.KodeCustSupp, E.NAMACUSTSUPP , E.ALAMATPKP1+Char(13)+E.ALAMATPKP2+' '+E.KOTAPKP AlamatCust,
	E.NPWP NPWPCust,e.ALAMAT1 as alamatcustom,e.kota as kotacustom,
	C.KodeBrg, F.NamaBrg, C.Qnt*C.Harga Jumlah, 0 as UangMuka,
       	C.Qnt, C.SAT_1,C.SAT_2, C.NDpp, C.Nppn, C.Nnet, D.Valas,
       	case when C.Ppn in (0,1) then c.HrgNetto else c.HrgNetto/1.1 end Harga,
       	P.Kota, P.Direksi, P.Jabatan, '' KetNota,
	D.Nobukti+' Tanggal: '+convert(varchar(10), D.tanggal,105) +' Customer: '+E.NAMACUSTSUPP+'  <No. Faktur Pajak : '+
	N.NoSeri+'.'+substring(D.NoBukti,1,5)+'>' as GroupNobukti2,e.namapkp as namacustpkp,e.alamatpkp1 as alamatcustpkp,e.alamatpkp2 as alamatcustpkp2,e.kotapkp as kotacustpkp
	,case  when e.NPWP='' then e.NAMACUSTSUPP else e.NAMAPKP end as namax,
        case when e.NPWP='' then e.ALAMAT1 else e.ALAMATPKP1 end as alamat1x,
        case when e.NPWP='' then e.ALAMAT1 else e.ALAMATPKP2 end as alamat2x,
        case when e.NPWP='' then ko.NamaKota else e.KOTAPKP end as kotapkpx,
        c.NDPP + c.NPPN as Jum,c.HrgNetto,
     case when C.NOSAT=1 then f.SAT1 when C.NOSAT=2 then F.SAT2 end stn

from dbInvoicePLDet c 
left outer join DBINvoicePL d on c.NoBukti=d.NoBukti
left outer join DBCUSTSUPP e on D.KodeCustSupp=e.KODECUSTSUPP
left outer join dbBarang f on c.KodeBrg=f.KodeBrg
left outer join dbNomor n on 1=1
left outer join dbPerusahaan p on 1=1
left outer join dbkota ko on e.kota = ko.kodekota
where d.NoBukti=@NoBukti --and isnull(c.IsBonus,0)=0


GO

-- Procedure: Sp_FLpass
-- Created: 2010-12-10 13:27:24.523 | Modified: 2014-02-13 14:37:17.170
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_FLpass]
@Choice char(1),
@UserID varchar(15),
@UID varchar(20),
@Tingkat int,
@status int,
@Fullname varchar(50),
@kodebag varchar(15),
@kodejab varchar(15),
@KodeKasir varchar(3),
@Kodegdg Varchar(15)='',
@Keynik integer

AS
begin tran
if @choice='I'
begin
      	Insert into dbFlpass(UserID,UID,Tingkat,status,Fullname,kodeBag,kodejab, KodeKasir,Kodegdg,keynik)
      	values (@UserID,@UID,@Tingkat,@status,@Fullname,@kodebag,@kodejab, @KodeKasir,@Kodegdg,@Keynik)
 	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
      	update dbFlpass set UID=@uid,Tingkat=@tingkat,status=@status,fullname=@Fullname,
      	                    kodeBag=@kodebag,kodejab=@kodejab, KodeKasir=@KodeKasir,KodeGdg=@Kodegdg
      	where userid=@userid
 	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
      	delete dbFlpass 
      	where userid=@userid and UserID<>'SA'
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return




GO

-- Procedure: Sp_FP
-- Created: 2014-07-10 09:11:55.327 | Modified: 2014-11-07 09:13:07.517
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_FP]
@Choice char(1),
@Kode int,
@NoAwal int,
@NoAkhir int,
@NoSeri varchar(10)

AS
begin tran
if @choice='I'
begin
  insert into DBNomorFP (Kode, NoAwal, NoAkhir, NoSeri)
  values (@Kode, @NoAwal, @NoAkhir, @NoSeri)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
    update DBNomorFP 
    set NoAwal=@NoAwal, NoAkhir=@NoAkhir, NoSeri=@NoSeri 
    where Kode=@Kode
    if @@error <> 0
     goto jikasalah
end
if @choice='D'
begin
   delete DBNomorFP 
   where Kode=@Kode
   
   if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: SP_GenerateNomorUrut
-- Created: 2025-08-21 08:09:41.160 | Modified: 2025-08-21 08:09:41.160
-- =====================================================

    CREATE PROCEDURE SP_GenerateNomorUrut
        @TableName NVARCHAR(50),
        @Tahun INT,
        @Prefix NVARCHAR(10) = ''
    AS
    BEGIN
        SET NOCOUNT ON;
        
        DECLARE @SQL NVARCHAR(MAX);
        DECLARE @MaxNomor INT = 0;
        DECLARE @NewNomor INT;
        DECLARE @FormattedNomor NVARCHAR(20);
        
        -- Build dynamic SQL based on table
        SET @SQL = 'SELECT @MaxNomor = ISNULL(MAX(NOURUT), 0) FROM ' + @TableName + 
                   ' WHERE YEAR(TANGGAL) = @Tahun';
        
        -- Execute dynamic SQL
        EXEC sp_executesql @SQL, N'@MaxNomor INT OUTPUT, @Tahun INT', 
                          @MaxNomor OUTPUT, @Tahun;
        
        -- Generate new number
        SET @NewNomor = @MaxNomor + 1;
        
        -- Format number manually (instead of FORMAT function)
        DECLARE @PaddedNumber NVARCHAR(10);
        SET @PaddedNumber = RIGHT('0000' + CAST(@NewNomor AS NVARCHAR(10)), 4);
        SET @FormattedNomor = @Prefix + @PaddedNumber + '/' + CAST(@Tahun AS NVARCHAR(4));
        
        -- Return results
        SELECT 
            @NewNomor AS NoUrut,
            @FormattedNomor AS NomorLengkap,
            @Tahun AS Tahun;
    END
    
GO

-- Procedure: Sp_GenerateReportBukuTambahan
-- Created: 2011-03-17 11:34:16.787 | Modified: 2011-03-17 11:34:16.787
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_GenerateReportBukuTambahan]
@Bulan int,
@tahun int,
@TglAwal datetime,
@tglAkhir datetime,
@Awal varchar(25),
@Akhir varchar(25),
@jurnal varchar(2),
@Devisi varchar(15)
AS
 delete dbtempbkbesar
-- where devisi=@devisi
 Declare @Perkiraan varchar(25),@tipe varchar(2)
 Declare CurNeraca Cursor for
  select Perkiraan from dbperkiraan where perkiraan>=@awal and perkiraan<=@akhir and tipe=1
  order by perkiraan    
 Open CurNeraca
    Fetch Next from CurNeraca into @perkiraan
 While @@fetch_Status=0
 begin
  
  exec sp_GenerateSaldobukutambahan @bulan,@tahun,@perkiraan,@Jurnal,@devisi
  exec Sp_GenerateTransBukuTambahan @tglawal,@perkiraan,@jurnal,@devisi,@tglakhir
  Fetch Next from CurNeraca into @perkiraan
 end
     Close CurNeraca
     Deallocate CurNeraca


GO

-- Procedure: Sp_GenerateSaldoBukuTambahan
-- Created: 2011-03-17 11:34:16.723 | Modified: 2011-03-17 11:34:16.723
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_GenerateSaldoBukuTambahan]
@bln int,
@thn int,
@Perkiraan varchar(25),
@jurnal char,
@devisi varchar(15)
AS
declare @bulan int,@tahun int, @mtgl varchar(20), @mtgl1 datetime
select @mtgl=cast(@bln as varchar(2))+'/01/'+cast(@thn as varchar(4))
select @mtgl1=cast(@mtgl as datetime)-1
select @mtgl=cast(month(@mtgl1) as varchar(2))+'/'+cast(datepart(dd,@mtgl1) as varchar(2))+'/'+cast(year(@mtgl1) as varchar(4))
select @bulan=@bln
select @tahun=@thn
Set @devisi=Case when @devisi in ('-','') then '%' else @devisi end
  if @jurnal='T'
  begin
    insert into dbtempBkBesar(devisi,NoAcc,Tanggal,NoBukti,Keterangan,Perkiraan,Lawan,Debet,Kredit,saldoawal,saldo,bulan,tahun,DebetD,KreditD,SaldoAwalD) 
    select @devisi,A.Perkiraan, @mtgl as Tanggal,' Saldo Awal 'as no_bukti, '' as Ket,A.perkiraan as No, '' as lawan,
           0 as debet,0 as kredit,
           case when a.DK=0 then b.AwalDRp
                when A.DK=1 then b.AwalKRp
                else 0       
           end as Saldo,0,@bln,@thn,0,0,
           case when a.DK=0 then b.AwalD
                when A.DK=1 then b.AwalK
                else 0       
           end as SaldoD
    from dbPerkiraan A
         left outer join DBNERACA b on b.Perkiraan=A.Perkiraan
    where a.Perkiraan=@perkiraan and b.Bulan=@bulan and b.Tahun=@tahun and (b.Devisi like @devisi)
  end 
  else if @jurnal='Y'
  begin
    insert into dbtempBkBesar(devisi,NoAcc,Tanggal,NoBukti,Keterangan,Perkiraan,Lawan,Debet,Kredit,saldoawal,saldo,bulan,tahun,DebetD,KreditD,SaldoAwalD) 
    select @devisi,A.Perkiraan, @mtgl as Tanggal,' Saldo Awal 'as no_bukti, '' as Ket,A.perkiraan as No, '' as lawan,
           0 as debet,0 as kredit,
           case when a.DK=0 then b.AwalDRp
                when A.DK=1 then b.AwalKRp
                else 0       
           end as Saldo,0,@bln,@thn,0,0,
           case when a.DK=0 then b.AwalD
                when A.DK=1 then b.AwalK
                else 0       
           end as SaldoD
    from dbPerkiraan A
         left outer join DBNERACA b on b.Perkiraan=A.Perkiraan
    where a.Perkiraan=@perkiraan and b.Bulan=@bulan and b.Tahun=@tahun and (b.Devisi like @devisi)
 end



GO

-- Procedure: Sp_GenerateTransBukuTambahan
-- Created: 2011-03-17 11:34:16.753 | Modified: 2011-06-17 14:17:58.197
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_GenerateTransBukuTambahan]
@tglawal datetime,
@NoAccount varchar(25),
@Jurnal varchar(2),
@Devisi varchar(15),
@tglakhir datetime
AS 
Declare @nobukti varchar(25), @Perkiraan varchar(20), @Lawan varchar(20), @Keterangan varchar(500), @tanggal datetime,
 @debet numeric(18,2), @kredit numeric(18,2), @transaksi varchar(2), @Bulan int, @tahun int, @tipe varchar(2), @urut int,@tgl datetime,
 @debetd numeric(18,2), @kreditd numeric(18,2),@valas varchar(3),@Kurs numeric(18,2)
select @bulan=month(@tglawal)
select @tahun=year(@tglawal)
select @tgl=(select cast((cast(@bulan as varchar(2))+'/'+'01'+'/'+cast(@tahun as varchar(4))) as datetime))
Set @Devisi=case when @devisi in ('-','') then '%' else @Devisi end

  select @urut=1

  Declare CurTrans Cursor for
  select a.perkiraan,case when b.dk=0 then 'D' else 'K' end As Transaksi ,a.tanggal,a.nobukti,a.keterangan,a.lawan,
		Case when a.Perkiraan=@NoAccount then a.DebetRp else 0 end DebetRp, 
		Case when a.Lawan=@NoAccount then a.DebetRp else 0 end KreditRp, 
		case when a.Valas='IDR' then 0 else Case when a.Perkiraan=@NoAccount then a.Debet else 0 end end Debet, 
		case when a.Valas='IDR' then 0 else Case when a.Lawan=@NoAccount then a.Debet else 0 end end Kredit,
		a.valas,a.kurs
  from dbtransaksi a,dbperkiraan b
  where a.perkiraan=b.perkiraan and (a.perkiraan=@NoAccount or a.lawan=@noAccount) and 
        a.Tanggal>=@tgl and a.Tanggal<=@tglakhir and (a.devisi like @devisi)
        and ((a.NoBukti not like '%BJP%' and @Jurnal='T') or (a.NoBukti like '%' and @Jurnal='Y'))
  order by a.tanggal,a.nobukti

    Open CurTrans
    Fetch Next from CurTrans into @perkiraan,@transaksi,@tanggal,@nobukti,@keterangan,@lawan,@debet,@kredit,@debetd,@kreditd,@valas,@kurs
 While @@fetch_Status=0
 begin
  select @Tipe=case when dk=0 then 'D' else 'K' end from dbPerkiraan where perkiraan=@NoAccount
  --if @perkiraan=@NoAccount
  --begin
    insert into dbtempBkBesar(devisi,NoAcc,Transaksi,Tanggal,NoBukti,Keterangan,Perkiraan,Lawan,
    Debet,Kredit,saldo,saldoawal,bulan,tahun,urut,debetd,kreditd,valas,kurs)
    values(@devisi,@NoAccount,@tipe,@tanggal,@nobukti,@keterangan,@perkiraan,@lawan,
    @debet,@kredit,0,0,@bulan,@tahun,@urut,@debetd,@kreditd, @valas,@kurs)
  --end
  /*if @Lawan=@NoAccount
  begin
     insert into dbtempBkBesar(devisi,NoAcc,Transaksi,Tanggal,NoBukti,Keterangan,Perkiraan,Lawan,
     Debet,Kredit,saldo,saldoawal,bulan,tahun,urut,debetd,kreditd,valas,kurs)
     values(@devisi,@NoAccount,@tipe,@tanggal,@nobukti,@keterangan,@Lawan,@perkiraan,
     @kredit,@debet,0,0,@bulan,@tahun,@urut,@kreditd,@debetd,@valas,@kurs)
  end*/
  
  select @urut=@urut+1
  Fetch Next from CurTrans into @perkiraan,@transaksi,@tanggal,@nobukti,@keterangan,@lawan,@debet,@kredit,@debetd,@kreditd,@valas,@kurs
 end
     Close CurTrans
     Deallocate CurTrans





GO

-- Procedure: Sp_GetLabaBlnin
-- Created: 2011-06-01 10:54:37.453 | Modified: 2015-10-30 02:20:00.580
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_GetLabaBlnin]
@tahun int,@devisi varchar(10),@prosesRlHpp bit,@Bulan int
AS
Set @devisi=Case when @devisi='-' then '' else @devisi end
declare @mdevisi varchar(10),@nomor varchar(10),@perkiraan varchar(20),@keterangan varchar(50),@grup varchar(10),
@tipe varchar(1),@tanda varchar(1),@jumlah varchar(1),@totalA numeric(18,2),@totalb numeric(18,2),@totalc numeric(18,2),@totald numeric(18,2),
@tampil varchar(1),@persen varchar(1),@mtahun int
declare @S1 numeric(18,2),@S2 numeric(18,2),@S3 numeric(18,2),@S4 numeric(18,2)
declare @G1 numeric(18,2),@G2 numeric(18,2),@G3 numeric(18,2),@G4 numeric(18,2)
declare @T1 numeric(18,2),@T2 numeric(18,2),@T3 numeric(18,2),@T4 numeric(18,2)
declare @n1 numeric(18,2),@n2 numeric(18,2),@n3 numeric(18,2),@n4 numeric(18,2)
select @S1=0
select @S2=0
select @S3=0
select @S4=0
select @G1=0
select @G2=0
select @G3=0
select @G4=0
select @T1=0
select @T2=0
select @T3=0
select @T4=0
select @n1=0
select @n2=0
select @n3=0
select @n4=0
declare CurrLR cursor for
 select Devisi,Nomor,Perkiraan,Keterangan, Tipe, Tanda, Jumlah, Persen, TotalA,TotalB,TotalC,TotalD,Tahun,Tampil 
 from DBLRHPP where Bulan=@Bulan and tahun=@tahun and devisi=@devisi and Perkiraan<>'' and isLRHpp=@prosesRlHPP
 order by devisi,nomor
open CurrLR
Fetch Next from CurrLR into @mDevisi,@Nomor,@Perkiraan,@Keterangan, @Tipe, @Tanda, @Jumlah, @Persen, @TotalA,@TotalB,@TotalC,@TotalD,@mTahun,@Tampil
While @@fetch_Status=0
begin
  if @tanda='+' select @n1=isnull(@totalA,0) else select @n1=-1*isnull(@totalA,0) 
  if @tanda='+' select @n2=isnull(@totalb,0) else select @n2=-1*isnull(@totalb,0) 
  if @tanda='+' select @n3=isnull(@totalc,0) else select @n3=-1*isnull(@totalc,0)
  if @tanda='+' select @n4=isnull(@totald,0) else select @n4=-1*isnull(@totald,0) 
  
  if @jumlah=''   
  begin
   select @s1=@s1+@n1
   select @s2=@s2+@n2
   select @s3=@s3+@n3
   select @S4=@S4+@n4
   select @g1=@g1+@n1
   select @g2=@g2+@n2
   select @g3=@g3+@n3
   select @G4=@G4+@n4
   select @t1=@t1+@n1
   select @t2=@t2+@n2
   select @t3=@t3+@n3
   select @T4=@T4+@n4
  end
  else if @Jumlah='S'
  begin
   select @s1=0
   select @s2=0
   select @s3=0
   select @S4=0
  end else if @jumlah='G'
  begin
   select @s1=0
   select @s2=0
   select @s3=0  
   select @S4=0
   select @g1=0
   select @g2=0
   select @g3=0  
   select @G4=0
  end else if @jumlah='T'
  begin
   select @s1=0
   select @s2=0
   select @s3=0
   select @S4=0  
   select @g1=0
   select @g2=0
   select @g3=0
   select @G4=0  
  end
  Fetch Next from CurrLR into @mDevisi,@Nomor,@Perkiraan,@Keterangan, @Tipe, @Tanda, @Jumlah, @Persen, @TotalA,@TotalB,@TotalC,@TotalD,@mTahun,@Tampil
end
Close CurrLR
Deallocate CurrLR

select @s2 as nilai

GO

-- Procedure: SP_Giro
-- Created: 2010-12-20 15:31:32.477 | Modified: 2013-07-29 09:57:27.210
-- =====================================================


CREATE PROCEDURE [dbo].[SP_Giro]
@Choice char(1),
@Bank varchar(20),
@NoGiro varchar(20),
@TglGiro datetime,
@KodeVls varchar(10),
@Kurs numeric(18,2),
@Jumlah Numeric(18,2),
@TglBuka datetime,
@BuktiBuka varchar(20),
@Keteranganbuka varchar(50),
@TglCair datetime,
@BuktiCair varchar(20),
@KeteranganCair varchar(50),
@Tipe varchar(2),
@Kas varchar(25)
AS
begin tran
Declare @Debet numeric(18,2), @kredit Numeric(18,2),
        @DebetRp numeric(18,2), @kreditRp Numeric(18,2)
Set @Debet=Case when @tipe='PT' then Case when @KodeVls='IDR' then 0 else @Jumlah end else 0 end
Set @kredit=Case when @tipe='HT' then Case when @KodeVls='IDR' then 0 else @Jumlah end else 0 end
Set @DebetRp=Case when @tipe='PT' then @Jumlah*@Kurs else 0 end
Set @kreditRp=Case when @tipe='HT' then @Jumlah*@Kurs else 0 end
if @choice='I'
begin
  insert into DBGIRO (Bank, NoGiro, TglGiro, Debet, Kredit, DebetRp, KreditRp, Keterangan, TglBuka, BuktiBuka, KodeVls, Kurs, KeteranganCair, TglCair, BuktiCair,Tipe, Kas)
  values (@Bank, @NoGiro, @TglGiro, @Debet, @Kredit, @DebetRp, @kreditRp, @Keteranganbuka, @TglBuka, @BuktiBuka, @KodeVls, @Kurs, @KeteranganCair, @TglCair, @BuktiCair,@Tipe, @Kas)
  if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
  update DBGIRO set TglGiro=@TglGiro, Debet=@Debet, Kredit=@Kredit, Keterangan=@Keteranganbuka, TglBuka=@TglBuka, 
                                      BuktiBuka=@BuktiBuka, KodeVls=@KodeVls, Kurs=@Kurs, 
                    KeteranganCair=@KeteranganCair, TglCair=@TglCair,BuktiCair=@BuktiCair, Kas=@Kas
             where NoGiro=@NoGiro and bank=@bank
  if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
  if exists (select 'true' from DBGIRO where nogiro=@nogiro and bank=@bank and tglcair is null and tipe=@Tipe)
 begin
  delete DBGIRO 
  where NoGiro=@NoGiro and bank=@bank and Tipe=@Tipe
  -- if @@error <> 0 goto jikasalah
 end
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return



GO

-- Procedure: Sp_Group
-- Created: 2012-11-12 11:51:22.763 | Modified: 2012-11-12 11:51:22.763
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_Group]
@Choice char(1),
@KodeGrp Varchar(20),
@NamaGrp Varchar(50)
 AS
begin tran
if @choice='I'
begin
  insert into dbGroup (KodeGrp, Nama)
  values (@KodeGrp, @NamaGrp)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update dbGroup set Nama=@NamaGrp 
             where KodeGrp=@KodeGrp
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  dbGroup where KodeGrp=@KodeGrp
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_Gudang
-- Created: 2013-12-17 14:00:33.750 | Modified: 2014-07-14 16:02:00.100
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_Gudang]
@Choice char(1),
@KodeGdg Varchar(15),
@NamaGdg Varchar(40),
@IsProduksi bit,
@OldKode varchar(15),
@Alamat Varchar(100)='',
@IsTakeInOut bit=0,
@IsRusak bit =0

AS
begin tran
if @choice='I'
begin
  insert into dbGudang (KodeGdg, Nama, IsProduksi,Alamat,IstakeInOut,IsRusak)
  values (@KodeGdg, @NamaGdg, @IsProduksi,@Alamat,@IsTakeInOut,@IsRusak)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
    update dbGudang 
    set kodeGdg=@kodeGdg, Nama=@NamaGdg, IsProduksi=@IsProduksi,Alamat=@Alamat,IstakeinOut=@IsTakeInOut,IsRusak=@IsRusak
    where KodeGdg=@OldKode
    if @@error <> 0
     goto jikasalah
end
if @choice='D'
begin
   delete dbGudang 
   where KodeGdg=@OldKode
   
   if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: Sp_HasilPrdDetail
-- Created: 2014-09-08 13:24:11.410 | Modified: 2014-09-11 11:40:29.927
-- =====================================================

CREATE   Procedure [dbo].[Sp_HasilPrdDetail]
@Choice varchar(1),
@NoBukti varchar(20)='',
@Urut int=0,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)=0,
@NoSat tinyint=0,
@Satuan varchar(5)='',
@Isi numeric(18,2)=0,
@KodePrs varchar(20)='',
@NoUrut varchar(10)='',
@Tanggal Datetime,
@NoSPK varchar(30)='',
@KodePrsMaster varchar(20)=''

As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbHasilPrddet Where NoBukti=@NoBukti
  if not exists(select * from dbHasilPrd Where NoBukti=@NoBukti) 
  begin
    insert into dbHasilPrd (NOBUKTI, NOURUT, TANGGAL, NoSPK, KodePrs)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @NoSPK, @KodePrsMaster)
  end

  insert into dbHasilPrdDET (NOBUKTI, URUT,  Qnt, KodePrs)
  values(@NOBUKTI, @URUT, @Qnt, @KodePrs)

end
if @Choice='U'
begin
  update DBHASILPRDDET set Qnt = @Qnt, KodePrs = @KodePrs
  where NOBUKTI = @NoBukti and URUT = @Urut  
end
if @Choice='D'
begin
  delete dbHasilPrdDET where NoBukti=@NoBukti and Urut=@Urut 
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return














GO

-- Procedure: Sp_HasilPrdMesin
-- Created: 2014-09-11 13:42:24.663 | Modified: 2014-09-11 13:43:03.380
-- =====================================================

CREATE  Procedure [dbo].[Sp_HasilPrdMesin]
@Choice varchar(1),
@NoBukti varchar(20)='',
@Urut int=0,
@KodeMesin varchar(30)='',
@TanggalMesin Datetime=0,
@JamAwal Datetime=0,
@JamAkhir Datetime=0,
@Qnt numeric(18,2)=0,
@NoUrut varchar(10)='',
@Tanggal Datetime=0,
@NoSPK varchar(30)='',
@KodePrsMaster varchar(20)=''


As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from DBHASILPRDMSN Where NoBukti=@NoBukti
  if not exists(select nobukti from dbHasilPrd Where NoBukti=@NoBukti) 
  begin
    insert into dbHasilPrd (NOBUKTI, NOURUT, TANGGAL, NoSPK, KodePrs)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @NoSPK, @KodePrsMaster)
  end

  insert into DBHASILPRDMSN (NOBUKTI, URUT,  KodeMesin, TanggalMesin, JamAwal, JamAkhir, Qnt)
  values(@NOBUKTI, @URUT, @KodeMesin, @TanggalMesin, @JamAwal, @JamAkhir, @Qnt)

end
if @Choice='U'
begin
  select 1
end
if @Choice='D'
begin
  select 1
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return














GO

-- Procedure: Sp_HDGroup
-- Created: 2015-03-31 10:32:25.250 | Modified: 2015-03-31 11:15:08.537
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_HDGroup]
@Choice char(1),
@KodeHDGrp Varchar(15),
@NamaHDGrp Varchar(50),
@KodeGRP varchar(15)
 AS
begin tran
if @choice='I'
begin
  insert into dbHDGroup (KodeHDGrp, NamaHDGRP,KOdeGRp)
  values (@KodeHDGrp, @NamaHDGrp,@KodeGRP)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update dbHDGroup set NamaHDGRP=@NamaHDGrp ,KODEGRP=@KodeGRP
             where KodeHDGrp=@KodeHDGrp
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  dbHDGroup where KodeHDGrp=@KodeHDGrp
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return



GO

-- Procedure: Sp_HitungAsetNeto
-- Created: 2024-02-10 21:35:21.740 | Modified: 2024-08-10 04:41:26.243
-- =====================================================

CREATE Procedure [dbo].[Sp_HitungAsetNeto]

@devisi varchar(15),
@bulan int,
@tahun int
as
Declare @xDevisi varchar(15),@xPerkiraanNKA varchar(30),@xPerkiraanSKA varchar(30),@xPerkiraanSPI varchar(30),@xPerkiraan varchar(30),@xBulan int, @xtahun int,
@awalD numeric(18,2),@AwalDRp numeric(18,2),@AwalK numeric(18,2),@AwalKrp numeric(18,2),
@Valas varchar(15),@DK tinyint,@budget numeric(18,2),@asetneto numeric(18,2),@hsl1 numeric(18,2),@nilaiNKA numeric(18,2)
,@nilaiLiabilitas numeric(18,2)	,@nilaiSKA numeric(18,2),@nilaiSPI numeric(18,2)
	/*select @asetneto=SUM(AwalDRp ) from DBNERACA a
	left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan 
	where b.IsInvestasi =1 and b.IsNonLedger=1  and Bulan =@bulan and Tahun =@tahun */
    /*exec dbo.sp_HitungNilaiRl @perkiraanx,@tipe,@bulan,@tahun,@Devisix,@LR_HPP,@tanggal,@userid,
			 @hasil1 output,@hasil2 output,@hasil3 output,@jurnal output,
			 @hasil1Rp output,@hasil2Rp output,@hasil3Rp output,@jurnalRp output,@hasil4 output,@hasil4Rp output */	
	select @xPerkiraanNKA  =Perkiraan  from DBPOSTHUTPIUT where Kode ='NKA'
	select @xPerkiraanSKA  =Perkiraan  from DBPOSTHUTPIUT where Kode ='SKA'
	select @xPerkiraanSPI  =Perkiraan  from DBPOSTHUTPIUT where Kode ='SPI'	
	
	--update	DBNERACA set AwalK =0,AwalKRp =0,AwalD =0 where Perkiraan ='X' and 	Bulan =@bulan and Tahun =@tahun  
	update DBNERACA set Awald = 0 , AwaldRp =0  ,AwalK =0,AwalKRp  =0
		where --c.Kode ='SKA' and 
	Bulan =@bulan and Tahun =@tahun and Perkiraan =@xPerkiraanSKA			 
	exec sp_HitungNilaiAsetNeto @bulan, @tahun, @devisi ,@hsl1 output
	--select @asetneto=@asetneto+isnull(@hsl1,0)
	select @xPerkiraan =Perkiraan  from DBPOSTHUTPIUT where Kode ='ASN'
	
   if not Exists(Select 'True' From DBNERACA a
   left outer join DBPOSTHUTPIUT b on b.Perkiraan =a.Perkiraan 
   where Devisi=@devisi and a.Perkiraan=@xPerkiraan and
              Bulan=@bulan  and Tahun=@tahun and Kode ='ASN')
	Begin
	  Insert into DBNERACA(Perkiraan, Bulan, Tahun, Devisi,Valas)
	  Values (@xPerkiraan ,@bulan ,@tahun ,@devisi ,'IDR')
	End	
	
	Update DBNERACA set AwalD =@hsl1 , AwalDRp =@hsl1 
	from DBNERACA a
	left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan 
	left outer join DBPOSTHUTPIUT c on c.Perkiraan =a.Perkiraan 
	where c.Kode ='ASN' and Bulan =@bulan and Tahun =@tahun 
	

	
	update DBNERACA set AwalDRp= b.SPI  
		from DBNERACA a 
	left outer join 
	(select SUM(AkhirPasar ) SPI,Bulan ,Tahun  from DBINVESTASIDET where Bulan =@bulan  and Tahun =@tahun 
	group by Bulan , Tahun 
	)  b on b.Bulan=a.Bulan and b.Tahun =a.Tahun 
	left outer join DBPOSTHUTPIUT  c on c.Perkiraan =a.Perkiraan 
	where a.Perkiraan = @xPerkiraanSPI AND a.Bulan =@bulan  and A.Tahun =@tahun 
	
	select @nilaiNKA=AwalKRp  from DBNERACA 
	where Bulan =@bulan and Tahun =@tahun and Perkiraan =@xPerkiraanNKA
	
	select @nilaiLiabilitas = SUM(AkhirKRp )
	from DBNERACA a
	left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan  
	where Bulan =@bulan and Tahun =@tahun --and a.Perkiraan =@xPerkiraanSKA
	and left(Neraca,2)='P2' 
	
	select @nilaiSKA =@nilaiNKA-(@hsl1)--+@nilaiLiabilitas
	
	Update DBNERACA set --Awald = (@nilaiSKA) , 
	AwaldRp =(@nilaiSKA) 
	from DBNERACA a
	left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan 
	left outer join DBPOSTHUTPIUT c on c.Perkiraan =a.Perkiraan 
	where --c.Kode ='SKA' and 
	Bulan =@bulan and Tahun =@tahun and a.Perkiraan =@xPerkiraanSKA
GO

-- Procedure: sp_HitungNilaiAsetNeto
-- Created: 2024-02-13 06:13:02.007 | Modified: 2024-02-14 21:10:42.623
-- =====================================================


CREATE PROCEDURE [dbo].[sp_HitungNilaiAsetNeto] 
--@perkiraan varchar(15),
@bulan int,
@tahun int,
@devisi varchar(10),
@hasil1 numeric(18,2) output


AS
--if (@tipe='A')           -- //Saldo Awal
begin

 select @hasil1 =SUM(b.nilaibulanini )
        from dbPerkiraan a
       left outer join dbo.JumlahAsetNeto(@bulan ,@tahun ,@devisi) b on b.perkiraang=a.Perkiraan 
       where (Left(A.Neraca,2)<>'' or Left(A.Neraca,2) <>'  '  ) and Left(A.Neraca,2) <>'A2' and 
       Left(A.Neraca,2) <>'P1'
       
       and b.nilaibulanini is not null
 
end

 


GO

-- Procedure: sp_HitungNilaiRl
-- Created: 2011-06-22 13:53:41.803 | Modified: 2015-10-30 02:19:20.610
-- =====================================================


CREATE PROCEDURE [dbo].[sp_HitungNilaiRl] 
@perkiraan varchar(15),
@tipe varchar(3),
@bulan int,
@tahun int,
@devisi varchar(10),
@Rl_Hpp Bit,
@tanggal datetime,
@userid varchar(15),
@hasil1 numeric(18,2) output,
@hasil2 numeric(18,2) output,
@hasil3 numeric(18,2) output,
@jurnal numeric(18,2) output,
@hasil1Rp numeric(18,2) output,
@hasil2Rp numeric(18,2) output,
@hasil3Rp numeric(18,2) output,
@jurnalRp numeric(18,2) output,
@hasil4 numeric(18,2) output,
@hasil4Rp numeric(18,2) output

AS
if (@tipe='A')           -- //Saldo Awal
begin
 select @hasil1Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0)))
                           else 0
                      end),
        @hasil1=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @hasil2Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0)))
                           else 0
                      end),
        @hasil2=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @hasil3Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0)))
                           else 0
                      end),
        @hasil3=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=1 and N.tahun=@tahun and N.devisi like @devisi+'%'
 select @jurnal=0,@jurnalRp=0
end
if (@tipe='Z')           -- //Persediaan Akhir
begin
 select @hasil1Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))+(isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))+(isnull(N.RLDRp,0)-isnull(N.RLKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                           else 0
                      end),
        @hasil1=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))+(isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))+(isnull(N.RLD,0)-isnull(N.RLK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @hasil2Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))+(isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))+(isnull(N.RLDRp,0)-isnull(N.RLKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                           else 0
                      end),
        @hasil2=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))+(isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))+(isnull(N.RLD,0)-isnull(N.RLK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @hasil3Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))+(isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))+(isnull(N.RLDRp,0)-isnull(N.RLKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                           else 0
                      end),
        @hasil3=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))+(isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))+(isnull(N.RLD,0)-isnull(N.RLK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 select @jurnal=0,@jurnalRp=0 
end
if (@tipe='T')           -- //RLD
begin
 select @hasil1Rp=SUM(isnull(N.RLDRp,0)),
        @hasil1=SUM(isnull(N.RLD,0))
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @hasil2Rp=SUM(isnull(N.RLDRp,0)),
        @hasil2=SUM(isnull(N.RLD,0))
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @hasil3Rp=SUM(isnull(N.RLDRp,0)),
        @hasil3=SUM(isnull(N.RLD,0))
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan<=(@bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 
 select @jurnalRp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))+(isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))+(isnull(N.RLDRp,0)-isnull(N.RLKRp,0))) 
                           when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                           else 0
                      end),
        @jurnal=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))+(isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))+(isnull(N.RLD,0)-isnull(N.RLK,0))) 
                         when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                         else 0
                    end) 
 from dbPerkiraan P
      left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
 where p.Perkiraan=@perkiraan and N.bulan=(@bulan) and N.tahun=@tahun and N.devisi like @devisi+'%' 

 declare @xBulan int
 select @xBulan=@bulan-1
 
 if @xBulan=0
 begin
    select @hasil1=0,@hasil1Rp=0
 end
 else
 begin
  --print('Isi xBulan ')
  --Print(@xBulan)
  select @hasil1Rp=Sum(Case when P.DK=0 then ((isnull(N.AwalDRp,0)-isnull(N.AwalKRp,0))+(isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))+(isnull(N.RLDRp,0)-isnull(N.RLKRp,0))) 
                            when P.DK=1 then ((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                            else 0
                      end),
         @hasil1=Sum(Case when P.DK=0 then ((isnull(N.AwalD,0)-isnull(N.AwalK,0))+(isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))+(isnull(N.RLD,0)-isnull(N.RLK,0))) 
                          when P.DK=1 then ((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                          else 0
                     end) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@xBulan) and N.tahun=@tahun and N.devisi like @devisi+'%' 
 end
 --print(@hasil1)
 select @hasil2=@jurnal
 select @hasil3=@jurnal
end
if (@tipe='K')           -- //Saldo Akhir
begin
  select @hasil1Rp=Sum(((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                            ),
         @hasil1=Sum(((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @hasil2Rp=Sum(((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                         ),
         @hasil2=Sum(((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                         ) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @hasil3Rp=Sum(((isnull(N.AwalKRp,0)-isnull(N.AwalDRp,0))+(isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))+(isnull(N.RLKRp,0)-isnull(N.RLDRp,0)))
                            ),
         @hasil3=Sum(((isnull(N.AwalK,0)-isnull(N.AwalD,0))+(isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))+(isnull(N.RLK,0)-isnull(N.RLD,0)))
                        ) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 select @jurnal=0,@jurnalRp=0
end
if (@tipe='H')           -- //HPP
begin
  select @hasil1Rp=Sum(((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))-(isnull(N.RLDRp,0)))),
         @hasil1=Sum(((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))-(isnull(N.RLD,0))))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @hasil2Rp=Sum(((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))-(isnull(N.RLDRp,0)))
                            ),
         @hasil2=Sum(((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))-(isnull(N.RLD,0)))
                          )
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil3Rp=Sum(((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0))-(isnull(N.RLDRp,0)))),
         @hasil3=Sum(((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0))-(isnull(N.RLD,0))))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @jurnalRp=Sum((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))+(isnull(N.RLDRp,0))) ,
         @jurnal=Sum((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))+(isnull(N.RLD,0))) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
end
if (@tipe='M')and @Rl_Hpp=0           -- //Mutasi
begin
  select @hasil1Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0)))
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end) ,
         @hasil1=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end)
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'

  select @hasil2Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0)))
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end) ,
         @hasil2=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end)
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'

  select @hasil3Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0)))
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end) ,
         @hasil3=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end)
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @hasil4Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0)))
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end) ,
         @hasil4=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end)
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.tahun=(@tahun-1) and N.devisi like @devisi+'%'
  
  select @jurnalRp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))) 
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end),
         @jurnal=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 declare @trans int
 select @trans=(select P.DK from dbperkiraan P where P.perkiraan=@perkiraan)
end
if (@tipe='M')and @Rl_Hpp=1           -- //Mutasi
begin
  select @hasil1Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))) 
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end),
         @hasil1=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'

  select @hasil2Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))) 
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end),
         @hasil2=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'

  select @hasil3Rp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))) 
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end),
         @hasil3=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end)
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @jurnalRp=Sum(Case when P.DK=0 then ((isnull(N.MDRp,0)-isnull(N.MKRp,0))+(isnull(N.JPDRp,0)-isnull(N.JPKRp,0))) 
                            when P.DK=1 then ((isnull(N.MKRp,0)-isnull(N.MDRp,0))+(isnull(N.JPKRp,0)-isnull(N.JPDRp,0)))
                            else 0
                       end),
         @jurnal=Sum(Case when P.DK=0 then ((isnull(N.MD,0)-isnull(N.MK,0))+(isnull(N.JPD,0)-isnull(N.JPK,0))) 
                          when P.DK=1 then ((isnull(N.MK,0)-isnull(N.MD,0))+(isnull(N.JPK,0)-isnull(N.JPD,0)))
                          else 0
                     end) 
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 --declare @trans int
 select @trans=(select P.DK from dbperkiraan P where P.perkiraan=@perkiraan)
end
if (@tipe='1')           -- //MD
begin
  select @hasil1Rp=sum(isnull(N.MDRp,0)),
         @hasil1=sum(isnull(N.MD,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil2Rp=sum(isnull(N.MDRp,0)),
         @hasil2=sum(isnull(N.MD,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil3Rp=sum(isnull(N.MDRp,0)),
         @hasil3=sum(isnull(N.MD,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
 select @jurnal=0, @jurnalRp=0
end
if (@tipe='2')           -- //MK
begin
  select @hasil1Rp=sum(isnull(N.MKRp,0)),
         @hasil1=sum(isnull(N.MK,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil2Rp=sum(isnull(N.MKRp,0)),
         @hasil2=sum(isnull(N.MK,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil3Rp=sum(isnull(N.MKRp,0)),
         @hasil3=sum(isnull(N.MK,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @jurnal=0, @jurnalRp=0
end
if (@tipe='3')           -- //JPD
begin
  select @hasil1Rp=sum(isnull(N.JPDRp,0)),
         @hasil1=sum(isnull(N.JPD,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil2Rp=sum(isnull(N.JPDRp,0)),
         @hasil2=sum(isnull(N.JPD,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil3Rp=sum(isnull(N.JPDRp,0)),
         @hasil3=sum(isnull(N.JPD,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @jurnal=0, @jurnalRp=0
end
if (@tipe='4')           -- //JPK
begin
  select @hasil1Rp=sum(isnull(N.JPKRp,0)),
         @hasil1=sum(isnull(N.JPK,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan-1) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil2Rp=sum(isnull(N.JPKRp,0)),
         @hasil2=sum(isnull(N.JPK,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  
  select @hasil3Rp=sum(isnull(N.JPKRp,0)),
         @hasil3=sum(isnull(N.JPK,0))
  from dbPerkiraan P
       left outer join dbNeraca N on N.Perkiraan=p.Perkiraan
  where p.Perkiraan=@perkiraan and N.bulan<=(@Bulan) and N.tahun=@tahun and N.devisi like @devisi+'%'
  select @jurnal=0, @jurnalRp=0
end
declare @perkRl varchar(25),@perkHpp varchar(25),@perk1 varchar(25),@lawan1 varchar(25),@BhnBaku varchar(25),
        @brgJadi Varchar(25)        
Select @perkRl=Perkiraan from DBPOSTHUTPIUT where Kode='RLB'
select @perkHpp=Perkiraan from DBPOSTHUTPIUT where Kode='HPP'
declare @temptgl datetime
select @temptgl=getdate()
print @Hasil1
if isnull(@jurnal,0)<>0 or isnull(@jurnalRp,0)<>0
begin
 if (@tipe<>'T') and (@tipe<>'H') 
 begin
  if @trans=0
  begin
   if @Rl_Hpp=0 select @perk1=@perkRl    
   else select @perk1=@perkHpp
   select @lawan1=@perkiraan
  end
  else
  begin
   select @perk1=@perkiraan
   if @Rl_Hpp=0 select @lawan1=@perkRl    
   else select @lawan1=@perkHpp
  end 
 end
 else
 if (@tipe='T')
 begin
  if @Rl_Hpp=0 select @perk1=@perkRl    
  else select @perk1=@perkHpp
  select @lawan1=@perkiraan
 end
 else
 if (@tipe='H') and (@Rl_Hpp=0)
 begin
             select @perk1=@perkRL
             select @lawan1=@perkHPP
             select @jurnalRp=@jurnalRp*1
 end
 declare @keterangan varchar(500)
 --print 'LR/HPP : '+Cast(@prosesRlHpp as varchar(1))
  if @Rl_Hpp=0 
  select @keterangan='Jurnal Penutup'
 else
  select @keterangan='HPP Penutup' 
 declare @s varchar(7),@nobukti varchar(20),@prd varchar(8),@tipetrans varchar(3),
 @nourut int
 if @Rl_Hpp=0 
 begin
  select @s='00000' 
  select @tipetrans='R/L'  
 end
 else 
 begin
  select @s='00000' 
  select @tipetrans='HPP'
 end
 Select @nourut=MAX(Cast(nourut as int)) from dbTrans where LEFT(nobukti,3)=@tipetrans and 
 month(tanggal)=@bulan and year(tanggal)=@tahun
 Set @s=SUBSTRING(@s,1,LEN(@s)-LEN(Cast(isnull(@nourut,0)+1 as varchar(5))))+Cast(isnull(@nourut,0)+1 as varchar(5))
 if @bulan<10 
    select @prd='/0'+cast(@bulan as varchar(1))+Right(cast(@tahun as varchar(4)),2)
 else
    select @prd='/'+cast(@bulan as varchar(2))+Right(cast(@tahun as varchar(4)),2)
  if @Rl_Hpp=0 
     select @noBukti=@tipetrans+@prd+'/'+@s+'/TAS'
  else
     select @noBukti=@tipetrans+@prd+'/'+@s+'/TAS'
 --print(@jurnal)
 --print(@lawan1)
 --print(@devisi)
 --exec dbo.SP_Transaksi 'I',@Nobukti,@S,@tanggal,@Keterangan,0,@devisi,@Perk1,@Lawan1,@Keterangan,'',
 --@jurnalRp,0,'IDR',1,@jurnalRp,0,@tipetrans,'C','','',1,'','','','','','','','','',''
 
 exec dbo.SP_TransaksiKasBank 'I',@Nobukti,@S,@tanggal,@Keterangan,0,
                      @devisi,@Perk1,@Lawan1,@Keterangan,'',
                      @jurnalRp,0,'IDR',1,@jurnalRp,
                      0,@tipetrans,'C','','',
                      1,'','','','',
                      '','','','','','',
                      '','','','','T'
end

GO

-- Procedure: Sp_HitungUlang
-- Created: 2013-06-03 11:10:43.713 | Modified: 2013-06-03 11:10:43.713
-- =====================================================

CREATE Procedure [dbo].[Sp_HitungUlang]
@Tipe varchar(15),
@Bulan int,
@Tahun int,
@Kodebrg varchar(25),
@Kodegdg varchar(15),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2)

as
begin tran
  if not exists (Select Kodebrg 
                 from dbstockbrg 
                 where Kodebrg=@kodebrg and Kodegdg=@kodegdg
                 and Bulan=@bulan and tahun=@tahun)
  begin
    insert into dbstockbrg(Kodebrg,Bulan,Tahun,Kodegdg)
    Values(@Kodebrg,@bulan,@Tahun,@kodegdg)
  End
  
  if @Tipe='PBL'
  begin
    Update dbstockbrg set QNTPBL =QNTPBL+@Qnt, QNT2PBL=QNT2PBL+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='RPB'
  begin
    Update dbstockbrg set QNTRPB =QNTRPB+@Qnt, QNT2RPB=QNT2RPB+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='PNJ'
  begin
    Update dbstockbrg set QNTPNJ =QNTPNJ+@Qnt, QNT2PNJ=QNT2PNJ+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='RPJ'
  begin
    Update dbstockbrg set QNTRPJ=QNTRPJ+@Qnt, QNT2RPJ=QNT2RPJ+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='UKI'
  begin
    Update dbstockbrg set QNTUKI =QNTUKI+@Qnt, QNT2UKI=QNT2UKI+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='UKO'
  begin
    Update dbstockbrg set QNTUKO =QNTUKO+@Qnt, QNT2UKO=QNT2UKO+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='TRI' or @Tipe='PBI'
  begin
    Update dbstockbrg set QNTTRI =QNTTRI+@Qnt, QNT2TRI=QNT2TRI+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else
  if @Tipe='TRO' or @Tipe='PBO'
  begin
    Update dbstockbrg set QNTTRO =QNTTRO+@Qnt, QNT2TRO=QNT2TRO+@Qnt2     
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else 
  if @Tipe='ADI'
  begin
    Update dbstockbrg set QntADI=QntADI+@Qnt, Qnt2ADI=Qnt2ADI+@Qnt2          
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else 
  if @Tipe='ADO'
  begin
    Update dbstockbrg set QntADO=QntADO+@Qnt, Qnt2ADO=Qnt2ADO+@Qnt2
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else 
  if @Tipe='PMK'
  begin
    Update dbstockbrg set QntPMK=QntPMK+@Qnt, Qnt2PMK=Qnt2PMK+@Qnt2          
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else 
  if @Tipe='RPK'
  begin
    Update dbstockbrg set QntRPK=QntRPK+@Qnt, Qnt2RPK=Qnt2RPK+@Qnt2
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  else 
  if @Tipe='HP'
  begin
    Update dbstockbrg set QntHPrd=Isnull(QntHPrd,0)+@Qnt, Qnt2HPrd=Isnull(Qnt2HPrd,0)+@Qnt2
    where Kodebrg=@kodebrg and Kodegdg=@kodegdg and Bulan=@bulan and tahun=@tahun
  end
  
  if @@error<>0 goto JikaSalah
commit tran
return
jikaSalah: Rollback tran
           return









GO

-- Procedure: sp_HitungUlangAktiva
-- Created: 2014-05-13 10:09:45.177 | Modified: 2014-09-24 14:58:55.713
-- =====================================================


CREATE PROCEDURE [dbo].[sp_HitungUlangAktiva]
@Bulan int,
@Tahun int,
@Perkiraan varchar(20) 
AS

update DBAKTIVADET set dmk=0,MK=0,DMD=0,MD=0,DSD=0,SD=0,DSK=0,SK=0 where Perkiraan=@Perkiraan and Bulan=@Bulan and Tahun=@Tahun

update dbAktivadet set 
   MK=isnull((select sum(DebetRp) from dbTransaksi 
   where month(Tanggal)=@Bulan and year(Tanggal)=@Tahun and Devisi=DBAKTIVADET.Devisi 
   and ((StatusAktivaP='AKV-' and NoAktivaP=@Perkiraan) or (StatusAktivaL='AKV-' and NoAktivaL=@Perkiraan)) and DebetRp<>0),0),
   MD=isnull((select sum(DebetRp) from dbTransaksi
   where month(Tanggal)=@Bulan and year(Tanggal)=@Tahun and Devisi=DBAKTIVADET.Devisi 
   and ((StatusAktivaP='AKV+' and NoAktivaP=@Perkiraan) or (StatusAktivaL='AKV+' and NoAktivaL=@Perkiraan)) and DebetRp<>0),0),
   SD=isnull((select sum(DebetRp) from dbTransaksi
   where month(Tanggal)=@Bulan and year(Tanggal)=@Tahun and Devisi=DBAKTIVADET.Devisi 
   and ((StatusAktivaP='AKM+' and NoAktivaP=@Perkiraan) or (StatusAktivaL='AKM+' and NoAktivaL=@Perkiraan)) and DebetRp<>0),0),
   SK=isnull((select sum(DebetRp) from dbTransaksi
   where month(Tanggal)=@Bulan and year(Tanggal)=@Tahun and Devisi=DBAKTIVADET.Devisi 
   and ((StatusAktivaP='AKM-' and NoAktivaP=@Perkiraan) or (StatusAktivaL='AKM-' and NoAktivaL=@Perkiraan)) and DebetRp<>0),0)
where Perkiraan=@Perkiraan and Bulan=@Bulan and Tahun=@Tahun







GO

-- Procedure: sp_HitungUlangInvestasi
-- Created: 2024-02-10 15:02:23.353 | Modified: 2024-08-20 11:40:11.457
-- =====================================================


CREATE PROCEDURE [dbo].[sp_HitungUlangInvestasi] 
@devisi varchar(15),
@Perkiraan varchar(25),
@DKP tinyint=0,
@Lawan varchar(25)='',
@DKL tinyint='',
@Jumlah numeric(18,2),
@jumalhRp numeric(18,2),
@StatusAktivaP varchar(5)='',
@StatusAktivaL varchar(5)='',
@NoaktivaP varchar(30)='',
@NoAktivaL varchar(30)='',
@Tipetrans varchar(5)='',
@bulan int,
@tahun int,
@Valas varchar(15)
AS

update dbInvestasidet set 
   MK=isnull((select sum(DebetRp) from dbTransaksi 
   where month(Tanggal)=@Bulan and year(Tanggal)=@Tahun and Devisi=dbInvestasidet.Devisi 
   and (StatusAktivaL='IVT-' and NoAktivaL=@Perkiraan) and DebetRp<>0),0),
   MD=isnull((select sum(DebetRp) from dbTransaksi
   where month(Tanggal)=@Bulan and year(Tanggal)=@Tahun and Devisi=dbInvestasidet.Devisi 
   and (StatusAktivaP='IVT+' and NoAktivaP=@Perkiraan) and DebetRp<>0),0)
where Perkiraan=@Perkiraan and Bulan=@Bulan and Tahun=@Tahun

	Insert into DBINVESTASIDET(Perkiraan,Devisi,Bulan,Tahun,MD,MK,Valas,Kurs,Tipe,NilaiNominal,Awal ,AwalPasar )
	Select NoAktivaP,a.Devisi,month(Tanggal), YEAR(Tanggal),isnull(sum(DebetRp),0),0,Valas,Kurs
	,b.Tipe ,b.NilaiNominal ,0,0
	from dbTransaksi a  
	left outer join DBINVESTASI b on b.Perkiraan =a.NoAktivaP 
	where (StatusAktivaP='IVT+' and NoAktivaP=@Perkiraan) and (DebetRp<>0) and 
	      a.Devisi=@Devisi and month(Tanggal)=@Bulan and YEAR(Tanggal)=@Tahun and 
		 not exists(Select Perkiraan 
					from DBINVESTASIDET
					where Perkiraan=@Perkiraan and Bulan=@Bulan and Tahun=@Tahun) 
	     group by NoAktivaP,Tanggal,a.Devisi,Valas,Kurs,b.Tipe ,b.NilaiNominal,DebetRp 
					
	Insert into DBINVESTASIDET(Perkiraan,Devisi,Bulan,Tahun,MD,MK,Valas,Kurs,Tipe,NilaiNominal,Awal ,AwalPasar )
	Select NoAktivaL,a.Devisi,month(Tanggal), YEAR(Tanggal),0,isnull(sum(DebetRp),0),Valas,Kurs
	,b.Tipe ,b.NilaiNominal ,0,0
	from dbTransaksi  a
	left outer join DBINVESTASI b on b.Perkiraan =a.NoAktivaP 
	where (StatusAktivaL='IVT-' and NoAktivaL=@Perkiraan) and (DebetRp<>0) and 
	     a.Devisi=@Devisi and month(Tanggal)=@Bulan and YEAR(Tanggal)=@Tahun and 
		 not exists(Select Perkiraan 
					from DBINVESTASIDET
					where Perkiraan=@Perkiraan and Bulan=@Bulan and Tahun=@Tahun) 
	group by NoAktivaL,Tanggal,a.Devisi,Valas,Kurs,b.Tipe ,b.NilaiNominal,DebetRp


					
		


GO

-- Procedure: Sp_HitungUlangInvoice
-- Created: 2013-05-13 12:11:46.813 | Modified: 2013-05-13 12:11:46.813
-- =====================================================

Create Procedure [dbo].[Sp_HitungUlangInvoice]
--declare
@Tipe varchar(15),
@Bulan int,
@Tahun int,
@Kodebrg varchar(25),
@KodeCustSupp varchar(25),
@Kodegdg varchar(15),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@RpBln Numeric(18,2),
@KodeArea varchar(25),
@KodeKota varchar(25),
@KodeSLS int --varchar(25)
/*select @Tipe ='IPL',@Bulan=1, @Tahun =2013,@Kodebrg ='EXCG 001', @KodeCustSupp='A00001',@Kodegdg='',@Qnt=10, @Qnt2=0,@RpBln=3000000,
@KodeArea='BLI',@KodeKota='KT',@KodeSLS =1*/
as
declare @str varchar(8000),@str2 varchar(8000),@str3 varchar(1000)

begin tran
  if not exists (Select 'true' from DBCustAreaKota where KodeArea =@KodeArea and KodeCustSupp=@KodeCustSupp and KodeKota=@KodeKota and @Tahun =@Tahun)
  begin
    insert into DBCustAreaKota(KodeCustSupp,KodeArea,KodeKota,Tahun)
    Values(@KodeCustSupp,@KodeArea,@KodeKota,@Tahun)
  End
  if not exists (Select 'true' from DBSalesCustPrd where KodeBrg =@Kodebrg and KodeCustSupp=@KodeCustSupp and KodeSLS=@KodeSLS and @Tahun =@Tahun)
  begin
    insert into DBSalesCustPrd(KodeBrg,KodeCustSupp,KodeSLS,Tahun)
    Values(@Kodebrg,@KodeCustSupp,@KodeSLS,@Tahun)
  End
  if not exists (Select 'true' from DBAreaKotaPrd where KodeBrg =@Kodebrg and KodeKota=@KodeKota and KodeArea=@KodeArea and @Tahun =@Tahun)
  begin
    insert into DBAreaKotaPrd(KodeBrg,KodeArea,KodeKota,Tahun)
    Values(@Kodebrg,@KodeArea,@KodeKota,@Tahun)
  End
 if @Tipe='IPL'
  begin
    select @str='Update DBCustAreaKota set QntBln'+Convert(Varchar(5),@Bulan)+'=QntBln'+Convert(Varchar(5),@Bulan)+' + '+CONVERT(varchar(100), @qnt)+
    ', qnt2bln'+ CONVERT(varchar(5),@bulan)+' = '+ 'qnt2bln'+CONVERT(varchar(5),@bulan) +' + ' +CONVERT(varchar(100), @qnt2)+
    ', RpBln'+ CONVERT(varchar(5),@bulan)+' = '+'RpBln'+CONVERT(varchar(5),@bulan)+' + '+CONVERT(varchar(100), @RpBln)+       
    ' where KodeCustSupp='''+CONVERT(varchar(25),@kodecustsupp)+''' and Kodearea='''+convert(varchar(25),@kodearea)+''' 
    and kodekota='''+convert(varchar(25),@kodekota)+''' and tahun='+convert(varchar(4),@tahun)
   -- select @str ='select qntbln'+Convert(Varchar(5),@Bulan)+'=qntbln'+Convert(Varchar(5),@Bulan)+'+'+CONVERT(varchar(100), @qnt)+' from DBCustAreaKota'
    --print @str
    exec (@str)
    select @str2='Update DBSalesCustPrd set QntBln'+Convert(Varchar(5),@Bulan)+'=QntBln'+Convert(Varchar(5),@Bulan)+' + '+CONVERT(varchar(100), @qnt)+
    ', qnt2bln'+ CONVERT(varchar(5),@bulan)+' = '+ 'qnt2bln'+CONVERT(varchar(5),@bulan) +' + ' +CONVERT(varchar(100), @qnt2)+
    ', RpBln'+ CONVERT(varchar(5),@bulan)+' = '+'RpBln'+CONVERT(varchar(5),@bulan)+' + '+CONVERT(varchar(100), @RpBln)+       
    ' where KodeCustSupp='''+CONVERT(varchar(25),@kodecustsupp)+''' and Kodesls='''+convert(varchar(25),@kodesls)+''' 
    and kodebrg='''+convert(varchar(25),@Kodebrg)+''' and tahun='+convert(varchar(4),@tahun)    
    --print @str2
    exec (@str2)
    select @str3='Update DBAreaKotaPrd set QntBln'+Convert(Varchar(5),@Bulan)+'=QntBln'+Convert(Varchar(5),@Bulan)+' + '+CONVERT(varchar(100), @qnt)+
    ', qnt2bln'+ CONVERT(varchar(5),@bulan)+' = '+ 'qnt2bln'+CONVERT(varchar(5),@bulan) +' + ' +CONVERT(varchar(100), @qnt2)+
    ', RpBln'+ CONVERT(varchar(5),@bulan)+' = '+'RpBln'+CONVERT(varchar(5),@bulan)+' + '+CONVERT(varchar(100), @RpBln)+       
    ' where Kodearea='''+convert(varchar(25),@kodearea)+'''  and kodekota='''+convert(varchar(25),@kodekota)+'''
    and kodebrg='''+convert(varchar(25),@Kodebrg)+''' and tahun='+convert(varchar(4),@tahun)    
    exec (@str3)
    
  end
  
  else if @Tipe='RIPL'
  begin
    select @str='Update DBCustAreaKota set QntBln'+Convert(Varchar(5),@Bulan)+'=QntBln'+Convert(Varchar(5),@Bulan)+' - '+CONVERT(varchar(100), @qnt)+
    ', qnt2bln'+ CONVERT(varchar(5),@bulan)+' = '+ 'qnt2bln'+CONVERT(varchar(5),@bulan) +' - ' +CONVERT(varchar(100), @qnt2)+
    ', RpBln'+ CONVERT(varchar(5),@bulan)+' = '+'RpBln'+CONVERT(varchar(5),@bulan)+' - '+CONVERT(varchar(100), @RpBln)+       
    ' where KodeCustSupp='''+CONVERT(varchar(25),@kodecustsupp)+''' and Kodearea='''+convert(varchar(25),@kodearea)+''' 
    and kodekota='''+convert(varchar(25),@kodekota)+''' and tahun='+convert(varchar(4),@tahun)
   -- select @str ='select qntbln'+Convert(Varchar(5),@Bulan)+'=qntbln'+Convert(Varchar(5),@Bulan)+'+'+CONVERT(varchar(100), @qnt)+' from DBCustAreaKota'
    --print @str
    exec (@str)
    select @str2='Update DBSalesCustPrd set QntBln'+Convert(Varchar(5),@Bulan)+'=QntBln'+Convert(Varchar(5),@Bulan)+' - '+CONVERT(varchar(100), @qnt)+
    ', qnt2bln'+ CONVERT(varchar(5),@bulan)+' = '+ 'qnt2bln'+CONVERT(varchar(5),@bulan) +' - ' +CONVERT(varchar(100), @qnt2)+
    ', RpBln'+ CONVERT(varchar(5),@bulan)+' = '+'RpBln'+CONVERT(varchar(5),@bulan)+' - '+CONVERT(varchar(100), @RpBln)+       
    ' where KodeCustSupp='''+CONVERT(varchar(25),@kodecustsupp)+''' and Kodesls='''+convert(varchar(25),@kodesls)+''' 
    and kodebrg='''+convert(varchar(25),@Kodebrg)+''' and tahun='+convert(varchar(4),@tahun)    
    exec (@str2)
    select @str3='Update DBAreaKotaPrd set QntBln'+Convert(Varchar(5),@Bulan)+'=QntBln'+Convert(Varchar(5),@Bulan)+' - '+CONVERT(varchar(100), @qnt)+
    ', qnt2bln'+ CONVERT(varchar(5),@bulan)+' = '+ 'qnt2bln'+CONVERT(varchar(5),@bulan) +' - ' +CONVERT(varchar(100), @qnt2)+
    ', RpBln'+ CONVERT(varchar(5),@bulan)+' = '+'RpBln'+CONVERT(varchar(5),@bulan)+' - '+CONVERT(varchar(100), @RpBln)+       
    ' where Kodearea='''+convert(varchar(25),@kodearea)+'''  and kodekota='''+convert(varchar(25),@kodekota)+'''
    and kodebrg='''+convert(varchar(25),@kodebrg)+''' and tahun='+convert(varchar(4),@tahun)    
    exec (@str3)
   end
  if @@error<>0 goto JikaSalah
commit tran
return
jikaSalah: Rollback tran
           return





GO

-- Procedure: sp_HitungUlangNeracaInvestasi
-- Created: 2024-08-21 06:53:08.757 | Modified: 2024-08-21 06:53:08.757
-- =====================================================


Create PROCEDURE [dbo].[sp_HitungUlangNeracaInvestasi] 
@devisi varchar(15),
@Perkiraan varchar(25),
@DKP tinyint,
@Lawan varchar(25)='',
@DKL tinyint='',
@Jumlah numeric(18,2),
@jumalhRp numeric(18,2),
@StatusAktivaP varchar(5)='',
@StatusAktivaL varchar(5)='',
@NoaktivaP varchar(30)='',
@NoAktivaL varchar(30)='',
@Tipetrans varchar(5)='',
@bulan int,
@tahun int,
@Valas varchar(15)
AS
--Select @devisi='01',@bulan=1,@tahun=2011
Set nocount on


Insert Into DBNERACA (Perkiraan, Bulan, Tahun, Devisi,Valas)
Select Perkiraan, @bulan, @tahun, @devisi,Valas
from DBPERKIRAAN 
where Perkiraan=@Lawan and Tipe=1 and Perkiraan not in (Select Perkiraan 
                                                            from DBNERACA 
                                                            where Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
                                                                  and Devisi=@devisi)
/*union 
Select Perkiraan, @bulan, @tahun, @devisi,Valas
from DBPERKIRAAN 
where Perkiraan=@Lawan and Tipe=1 and Perkiraan not in (Select Perkiraan 
                                                            from DBNERACA 
                                                            where Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
                                                                  and Devisi=@devisi)
*/
--if @Tipetrans in ('BKK','BKM','BBM','BBK','BMM','PBL','PJL')
begin
  update DBNERACA set AwalD=AwalD+@Jumlah ,AwalDRp =AwalDRp+@jumalhRp --MD=MD+Case when @Valas<>'IDR' then @Jumlah else 0 end, MDRp=MDRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
/*  
  update DBNERACA set MK=MK+Case when @Valas<>'IDR' then @Jumlah else 0 end, MKRp=MKRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun */
end
   

set nocount off








GO

-- Procedure: sp_HitungUlangTransaksi
-- Created: 2011-06-22 13:48:04.040 | Modified: 2024-08-23 05:43:29.967
-- =====================================================

CREATE PROCEDURE [dbo].[sp_HitungUlangTransaksi] 
@devisi varchar(15),
@Perkiraan varchar(25),
@DKP tinyint,
@Lawan varchar(25)='',
@DKL tinyint='',
@Jumlah numeric(18,2),
@jumalhRp numeric(18,2),
@StatusAktivaP varchar(5)='',
@StatusAktivaL varchar(5)='',
@NoaktivaP varchar(30)='',
@NoAktivaL varchar(30)='',
@Tipetrans varchar(5)='',
@bulan int,
@tahun int,
@Valas varchar(15)
AS
--Select @devisi='01',@bulan=1,@tahun=2011
Set nocount on

Insert Into DBNERACA (Perkiraan, Bulan, Tahun, Devisi,Valas)
Select Perkiraan, @bulan, @tahun, @devisi,Valas
from DBPERKIRAAN 
where Perkiraan=@Perkiraan and Tipe=1 and Perkiraan not in (Select Perkiraan 
                                                            from DBNERACA 
                                                            where Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
                                                                  and Devisi=@devisi)
union 
Select Perkiraan, @bulan, @tahun, @devisi,Valas
from DBPERKIRAAN 
where Perkiraan=@Lawan and Tipe=1 and Perkiraan not in (Select Perkiraan 
                                                            from DBNERACA 
                                                            where Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
                                                                  and Devisi=@devisi)
 update DBNERACA set AwalKRp =isnull(b.AwalKRp,a.AwalKRp ) 
 from DBNERACA a
 left outer join DBNERACANKA b on b.Perkiraan =a.Perkiraan and b.Bulan =a.Bulan and a.Tahun =b.Tahun and
 a.Devisi =b.Devisi
 where a.Bulan =@bulan and a.Tahun =@tahun and a.Devisi =@Devisi  and a.Perkiraan in  
 (Select Perkiraan 
                                                            from DBPOSTHUTPIUT
                                                            where Kode ='NKA')                                                             

if @Tipetrans in ('BKK','BKM','BBM','BBK','BMM','PBL','PJL')
begin
  update DBNERACA set MD=MD+Case when @Valas<>'IDR' then @Jumlah else 0 end, MDRp=MDRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
  
  update DBNERACA set MK=MK+Case when @Valas<>'IDR' then @Jumlah else 0 end, MKRp=MKRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
end
else if @Tipetrans in ('BJK')
begin
  update DBNERACA set JPD=JPD+Case when @Valas<>'IDR' then @Jumlah else 0 end, JPDRp=JPDRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
  
  update DBNERACA set JPK=JPK+Case when @Valas<>'IDR' then @Jumlah else 0 end, JPKRp=JPKRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
end
else if @Tipetrans in ('R/L')
begin
  update DBNERACA set RLD=RLD+Case when @Valas<>'IDR' then @Jumlah else 0 end, RLDRp=RLDRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
  
  update DBNERACA set RLK=RLK+Case when @Valas<>'IDR' then @Jumlah else 0 end, RLKRp=RLKRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
end    

set nocount off






GO

-- Procedure: sp_HitungUlangTransaksiLama
-- Created: 2015-10-30 01:53:00.060 | Modified: 2015-10-30 01:53:00.060
-- =====================================================

CREATE PROCEDURE [dbo].[sp_HitungUlangTransaksiLama] 
@devisi varchar(15),
@Perkiraan varchar(25),
@DKP tinyint,
@Lawan varchar(25),
@DKL tinyint,
@Jumlah numeric(18,2),
@jumalhRp numeric(18,2),
@StatusAktivaP varchar(5),
@StatusAktivaL varchar(5),
@NoaktivaP varchar(30),
@NoAktivaL varchar(30),
@Tipetrans varchar(5),
@bulan int,
@tahun int,
@Valas varchar(15)
AS
--Select @devisi='01',@bulan=1,@tahun=2011
Set nocount on

Insert Into DBNERACALAMA (Perkiraan, Bulan, Tahun, Devisi,Valas)
Select Perkiraan, @bulan, @tahun, @devisi,Valas
from DBPERKIRAAN 
where Perkiraan=@Perkiraan and Tipe=1 and Perkiraan not in (Select Perkiraan 
                                                            from DBNERACALAMA 
                                                            where Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
                                                                  and Devisi=@devisi)
union 
Select Perkiraan, @bulan, @tahun, @devisi,Valas
from DBPERKIRAAN 
where Perkiraan=@Lawan and Tipe=1 and Perkiraan not in (Select Perkiraan 
                                                            from DBNERACALAMA 
                                                            where Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
                                                                  and Devisi=@devisi)

if @Tipetrans in ('BKK','BKM','BBM','BBK','BMM')
begin
  update DBNERACALAMA set MD=MD+Case when @Valas<>'IDR' then @Jumlah else 0 end, MDRp=MDRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Perkiraan and Bulan=@bulan and Tahun=@tahun
  
  update DBNERACALAMA set MK=MK+Case when @Valas<>'IDR' then @Jumlah else 0 end, MKRp=MKRp+@jumalhRp
  where Devisi=@devisi and Perkiraan=@Lawan and Bulan=@bulan and Tahun=@tahun
end
   

set nocount off

GO

-- Procedure: Sp_HPPJadi
-- Created: 2013-06-03 11:11:50.590 | Modified: 2013-06-03 11:11:50.590
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_HPPJadi]
@Choice char(1)='',
@Bulan Int='',
@Tahun Int='',
@KOdeBrg varchar(25)='',
@HPP Numeric(18,2)=0.00,
@OldBulan Int='',
@OldTahun Int='',
@OldKodeBrg varchar(25)=''
AS
begin tran
if @choice='I'
begin
	insert into dbHPPProduksi (Bulan, Tahun,KOdeBrg,HPPBrg)
	values (@Bulan, @Tahun,@KOdeBrg,@HPP)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbHPPProduksi set Bulan=@Bulan,Tahun=@Tahun,KodeBrg=@KOdeBrg,HPPBrg=@HPP
             where Bulan=@OldBulan and Tahun = @OldTahun and Kodebrg = @OldKOdeBrg 
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbHPPProduksi where Bulan=@OldBulan and Tahun = @OldTahun and Kodebrg = @OldKodeBrg 
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return





GO

-- Procedure: Sp_HutangAwal
-- Created: 2010-12-16 08:41:55.740 | Modified: 2011-02-11 09:39:52.037
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_HutangAwal]
@choice varchar(1),
@Nobukti varchar(20),
@tglBukti datetime,
@TglJatuhTempo datetime,
@Jumlah numeric(18,2),
@JumlahRp numeric(18,2),
@KodeSupp varchar(20),
@nofaktur varchar(20),
@tipetrans varchar(3),
@urut int,
@kurs numeric(18,2),
@valas varchar(3),
@Perkiraan varchar(25),
@Kredit numeric(18,2),
@KreditRp numeric(18,2)
AS
if @choice='I'
begin
	select @urut=Max(urut) 
	from dbHUTPIUT 
	where KodeCustSupp=@kodesupp and NoFaktur=@nobukti 
	set @urut =Case when @urut is null then 1 else @urut + 1 end
	insert into dbHUTPIUT(NoFaktur,Tanggal,JatuhTempo,KodeCustSupp,Debet,Kredit,
		                  DebetD,KreditD,TipeTrans,Tipe,Urut,NoMsk,Valas,Kurs,Perkiraan)
	values(@Nobukti,@tglBukti,@TglJatuhTempo,@KodeSupp,@JumlahRp,@KreditRp,
	       Case when @Valas='IDR' then 0 else @Jumlah end,
	       Case when @Valas='IDR' then 0 else @Kredit end,@tipetrans,'HT',
		   @urut,0,@valas,@kurs,@Perkiraan)
end
if @choice='U'
begin
 update dbHUTPIUT set  Debet=@JumlahRp,Kredit=@KreditRp,JatuhTempo=@tglJatuhTempo ,tanggal=@tglbukti,
                       DebetD=Case when @Valas='IDR' then 0 else @Jumlah end,
                       KreditD=Case when @Valas='IDR' then 0 else @Kredit end,Valas=@Valas,Kurs=@kurs
 where NoFaktur=@Nobukti and KodeCustSupp=@kodesupp and 
       tipetrans=@tipetrans and urut=@urut and Perkiraan=@Perkiraan and Tipe='HT'
end
if @choice='D'
begin
 delete dbHUTPIUT 
 where NoFaktur=@Nobukti and KodeCustSupp=@kodesupp and 
       tipetrans=@tipetrans and urut=@urut and Perkiraan=@Perkiraan and Tipe='HT'
end

GO

-- Procedure: Sp_InsertInvPL
-- Created: 2013-01-15 10:04:31.867 | Modified: 2013-01-15 10:47:27.110
-- =====================================================
CREATE Procedure [dbo].[Sp_InsertInvPL]
--Declare
@NoBukti varchar(30),
@NoUrut varchar(8),
@Tanggal datetime,
@NoSPB varchar(30),
@IDUser varchar(30)

As
--Select @NoSPB='SJY/SJ/0712/00002'
Begin tran
insert into dbInvoicePL (NoBukti, NoUrut, Tanggal,PPN, Valas, Kurs, NoSPP, KodeCustSupp, Consignee, NotifyParty, 
StuffingDate, StuffingPlace, ContractNo, PONo, PaymentTerm, DocCreditNo, PoL, PoD, NameOfVessel, ShipOnBoardDate, 
Packing, Others, IsCetak, IDUser, IsLokal) 
select @NoBukti, @NoUrut, @Tanggal,C.PPn,C.KODEVLS,C.Kurs,D.NoBukti NoSPP,C.Kodecust,'' Consignee,'' Notify_Party,
       null Stuffing_Date, '' Stuffing_Place, C.Nobukti NoSO, '' NOPO, '' Term_of_Payment,
       '' NoLC, '' Port_of_Loading, '' Port_of_Discharge, 
       '' NameOfVessel,
       null ShipOnBoard, '' Packing, '', 0, @IDUser, 0 IsLokal
From DBSPB A
     left Outer join (Select y.NoBukti, y.NoSPP
                      from dbSPBDet y
                      group by y.NoBukti, y.NoSPP) SPBDet on SPBDet.NoBukti=A.NoBukti
     left Outer join (Select x.NoBukti, x.Tanggal, y.NoSPB
                      from dbInvoicePL x
                           left Outer join dbInvoicePLDet y on y.NoBukti=x.NoBukti
                      group by x.NoBukti, x.Tanggal, y.NoSPB) B on B.NoSPB=A.NoBukti     
     left outer join (Select x.NoBukti, x.Tanggal, y.NoSO
                      from dbSPP x
                           left Outer join dbSPPDet y on y.NoBukti=x.NoBukti
                      Group by x.NoBukti, x.Tanggal, y.NoSO)D on D.NoBukti=A.NoSPP
left Outer join dbSO C On C.Nobukti=D.NoSO
where A.NoBukti=@NoSPB and B.NoSPB is null     

if @@error<>0  goto jikasalah

insert into dbInvoicePLDet (NoBukti, Urut, NoSPB, UrutSPB, KodeBrg, Namabrg, PPN, DISC, KURS, 
Qnt, Qnt2, Sat_1, Sat_2, NoSat, Isi, NetW, GrossW, Meas, Harga, DiscP, DiscRp, DiscTot, ShippingMark)
Select @NoBukti,A.Urut, A.Nobukti, A.Urut, A.Kodebrg, A.Namabrg, D.PPn, 0, D.Kurs,
       C.Qnt, C.Qnt2, A.Sat_1, A.Sat_2, A.Nosat, A.Isi, A.NetW, A.GrossW, 0 Mesurement, D.Harga, 0 DiscP, 0 DiscRp,
       0 DiscRp , '' ShippingMark
from dbSPBDet A
     Left Outer join dbInvoicePLDet B on B.NoSPB=A.Nobukti and B.UrutSPB=A.Urut
     Left Outer Join (Select x.NoSO,x.UrutSO, SUM(y.QNT) Qnt, SUM(y.qnt2) Qnt2,
                             sum(y.NetW) NetW, SUM(y.GrossW) GrossW, SUM(x.Mesurement) Mesurement,x.NoBukti, z.IsClose,x.Urut
                      from dbSPPDet x
                           left Outer Join dbSPBDet y on y.NoSPP=x.NoBukti and y.UrutSPP=x.Urut
                           left Outer join dbSPP z on z.NoBukti=x.NoBukti
                           /*Left Outer join (Select x.NoSPB, x.UrutSPB, sum(Qnt) QntRSPB, sum(Qnt2) Qnt2RSPB, 
                                                   SUM(x.NetW) NetWRSPB, SUM(x.GrossW) GrossWRSPB
                                            from DBRSPBDet x
                                            Group by  x.NoSPB, x.UrutSPB) z1 on z1.NoSPB=y.NoBukti and z1.UrutSPB=y.Urut*/
                      group by x.NoSo, x.UrutSo, x.NoBukti, z.IsClose, x.Urut) C on C.NoBukti=A.NoSPP and C.Urut=A.UrutSPP
     left Outer join (Select x.Nobukti,y.Urut, x.PPn, x.Kurs,y.Harga
                      from DBSO x
                           left Outer join DBSODET y on y.Nobukti=x.Nobukti) D on D.Nobukti=C.NoSO and D.Urut=c.UrutSO                                                 
where A.Nobukti=@NoSPB and B.NoBukti is null 
Order by A.Nobukti, A.Urut         
if @@error<>0  goto jikasalah

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: SP_InsertM1
-- Created: 2015-09-26 03:04:22.940 | Modified: 2016-03-19 18:35:17.287
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertM1]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='000.991'
;with saldoSatuDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from ( 
  select left (Perkiraan,1) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
 (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,1), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,Bulan,tahun)

Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan,@tahun
from DBNeracaBulanan A
     Left Outer join saldoSatuDigit B on b.Perkiraan=left(a.Perkiraan,1) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end


GO

-- Procedure: SP_InsertM2
-- Created: 2015-09-26 03:03:29.473 | Modified: 2016-03-19 18:35:31.650
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertM2]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='000.991'
;with saldoDuaDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (
  select left (Perkiraan,2) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
  (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,2),DK, Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan,@tahun
from DBNeracaBulanan A
     Left Outer join saldoDuaDigit B on b.Perkiraan=left(a.Perkiraan,2) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end

GO

-- Procedure: SP_InsertM3
-- Created: 2015-09-26 03:01:53.217 | Modified: 2016-03-19 18:35:45.297
-- =====================================================


CREATE PROCEDURE [dbo].[SP_InsertM3]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='000.991'
;with saldoTigaDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from ( 
  select left (Perkiraan,3) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
  (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,3), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan,@tahun
from DBNeracaBulanan A
     Left Outer join saldoTigaDigit B on b.Perkiraan=left(a.Perkiraan,3) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end


GO

-- Procedure: SP_InsertM6
-- Created: 2015-09-26 02:52:25.353 | Modified: 2016-03-19 18:35:56.783
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertM6]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with saldoEnamDigit as 
(
  select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,6) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
  (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,6), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBNeracaBulanan A
     Left Outer join saldoEnamDigit B on b.Perkiraan=left(a.Perkiraan,6) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0



GO

-- Procedure: SP_InsertM8
-- Created: 2016-02-16 08:37:44.443 | Modified: 2016-03-19 18:36:08.677
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertM8]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with saldoDelapanDigit as 
(
  select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,8) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
  (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,8), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBNeracaBulanan A
     Left Outer join saldoDelapanDigit B on b.Perkiraan=left(a.Perkiraan,8) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0



GO

-- Procedure: SP_InsertM8F
-- Created: 2016-02-16 08:38:13.097 | Modified: 2016-03-19 18:36:21.977
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertM8F]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with saldoEnamDigit as 
(
  select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,6) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
  (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,6), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBNeracaBulanan A
     Left Outer join saldoEnamDigit B on b.Perkiraan=left(a.Perkiraan,6) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and LEN(a.Perkiraan)=6
and LEFT (a.Perkiraan,6) in (select LEFT(Perkiraan,6) from DBPERKIRAAN where LEN(Perkiraan)=10) --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0



GO

-- Procedure: sp_InsertNilaiPasar
-- Created: 2024-01-11 21:21:10.263 | Modified: 2024-01-11 21:21:10.263
-- =====================================================
create Procedure [dbo].[sp_InsertNilaiPasar]
as
--use DbSPTA
declare @uruttrf int,@jmltrans	int,@register varchar(10), @urutbeli int,
@nospta varchar (50),@qnt int,@nilaitebu numeric(18,0),@premi numeric(18,0),@byta numeric(18,0),@bytrf numeric(18,0),
@periodeawal varchar(20),@periodeakhir varchar(20),@bulan int, @tahun int,
@tanggal varchar(20),@tglgiling varchar(20),@MBS int,@keterangan varchar(50),
@NilaiPerolehan float,@NilaiPasar float,@perkiraan varchar (50)
/*delete XlsBeli where uruttrf is null
insert into DBSUPPLIER (KODESUPP ,NAMASUPP )
select distinct Register,Kebun   from XlsBeli 
where Register not in (select KODESUPP from DBSUPPLIER) 
insert into dbcustomer (KODECUST ,NAMACUST  )
select distinct Register,Kebun   from XlsBeli 
where Register not in (select KODECUST  from DBCustomer)*/


	declare CurrHslPrd cursor for
		select Urut , COUNT(Urut )jmltrans,Tahun ,Bulan ,Perkiraan ,Keterangan ,NilaiPerolehan ,NilaiPasar  from xlsNilaiPasar 
		--where tanggal='2022-04-19'
				group by Urut,Tahun ,Bulan ,Perkiraan ,Keterangan ,NilaiPerolehan ,NilaiPasar

	open CurrHslPrd
	Fetch Next from CurrHslPrd into @uruttrf,@jmltrans,@Tahun,@bulan,@perkiraan,@keterangan,@nilaiperolehan,@nilaipasar
	  	while @@FETCH_STATUS=0
        	begin
				update DBINVESTASIDET set SD  =@NilaiPasar
				where Perkiraan =@perkiraan and Bulan =@bulan and Tahun =@tahun
            	
 				
             Fetch Next from CurrHslPrd into @uruttrf,@jmltrans,@Tahun,@bulan,@perkiraan,@keterangan,@nilaiperolehan,@nilaipasar
            end 
            	
	close CurrHslPrd
	Deallocate CurrHslPrd

GO

-- Procedure: sp_InsertOutstandingPO
-- Created: 2013-02-21 01:50:21.760 | Modified: 2014-11-19 13:13:36.063
-- =====================================================

CREATE Procedure [dbo].[sp_InsertOutstandingPO]
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@KodeGdg varchar(20),
@NoPO varchar(20),
@FakturSupp varchar(200),
@Keterangan Varchar(5000)

As

Begin tran

declare	@UrutMax int

--exec sp_RefreshOutPO @NoPO

--if @@error<>0  goto jikasalah

--select * from DBBELI
--select * from DBPO

insert into dbBeli (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, HANDLING, KodeExp, KETERANGAN, 
	FAKTURSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DISCRP, ISCETAK, NilaiCetak,Flagtipe,NoPOHd)	
select 	distinct @NoBukti, @NoUrut, @Tanggal, @Tanggal+A.Hari, A.KodeSupp, 0.00 Handling, '' KodeExp, @Keterangan, 
	@FakturSupp, A.KodeVls, A.Kurs, A.PPN, A.TipeBayar, A.Hari, A.TipeDisc, A.Disc, A.DiscRp, 0 IsCetak, 0 NilaiCetak,FlagTipe,@NoPO 
from 	dbPO A
where	A.NoBukti=@NoPO

if @@error<>0  goto jikasalah

insert into dbBeliDet (NOBUKTI, URUT, KODEBRG,NamaBrg, KodeGdg, PPN, DISC, QNT, 
	NOSAT, SATUAN, ISI, HARGA, DISCP, DISCTOT, BYANGKUT, NoPO, UrutPO, 
	QntTerima, Qnt1Terima, Qnt2Terima,KURS,DiscP2,DiscP3,DiscP4,DiscP5,IsJasa,NOBATCH)
select 	@NoBukti NoBukti, T.Urut, T.KodeBrg,T.NAMABRG, @KodeGdg, B.PPN, B.Disc, T.QntTerima Qnt,
	T.NoSat, T.Satuan, T.Isi, T.Harga, T.DiscP, T.DiscTot, 0.00 ByAngkut, T.NoBukti, T.Urut, 
	T.QntTerima, case when NOSAT=1 then T.QntTerima else T.QntTerima*Br.ISI2 end, 
	case when NOSAT=1 then T.QntTerima/case when Isnull(Br.Isi2,0)=0 Then 1 else Br.ISI2 end  else T.QntTerima end, b.KURS,
	DiscP2,DiscP3,DiscP4,DiscP5,T.IsJasa,Case when T.NOBATCH='' then '-' else T.Nobatch End NoBatch
from dbPO B
left outer join TempOutstandingPO T on T.NoBukti=B.NoBukti
left outer join DBBARANG Br on Br.KODEBRG=T.KODEBRG
where 	B.NoBukti=@NoPO and T.IsTerima=1 and T.QntTerima<>0
order by T.Urut

if @@error<>0  goto jikasalah

Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: SP_InsertR0
-- Created: 2015-10-02 08:33:00.353 | Modified: 2016-02-16 08:46:46.930
-- =====================================================





CREATE PROCEDURE [dbo].[SP_InsertR0]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =8 , @tahun =2015--,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end

insert TempRNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select '' GroupPerkiraan,'999.99' Perkiraan,'Jumlah Keseluruhan :' Keterangan,
case when SUM(AwalAsli)<0 then SUM(AwalAsli)*-1 else SUM(AwalAsli) end Awal,
case when SUM(AwalAsli)<0 then 'K' else '' end AwalK,
case when SUM(DebetAsli)<0 then SUM(DebetAsli)*-1 else SUM(DebetAsli) end Debet,
case when SUM(DebetAsli)<0 then 'K' else '' end DebetK,
case when SUM(KreditAsli)<0 then SUM(KreditAsli)*-1 else SUM(KreditAsli) end Kredit,
case when SUM(KreditAsli)<0 then 'K' else '' end KreditK,
case when SUM(AkhirAsli)<0 then SUM(AkhirAsli)*-1 else SUM(AkhirAsli) end Akhir,
case when SUM(AkhirAsli)<0 then 'K' else '' end AkhirK,
0,'',0,'R0','',@Bulan,@Tahun
from (
  select case when AwalK='K' then isnull(Awal,0)*-1 else isnull(Awal,0) end AwalAsli,
  debet DebetAsli,
  Kredit KreditAsli,
  case when AwalK='K' then isnull(Awal,0)*-1 else isnull(Awal,0) end+Debet-Kredit AkhirAsli
  from TempRNerBul where Tanda='R6'
) R


GO

-- Procedure: SP_InsertR10
-- Created: 2016-02-16 08:43:05.393 | Modified: 2016-03-19 18:37:18.557
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertR10]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with SaldoSepuluhDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,10) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
 (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,10), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi
 
)
insert TempRNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBRNeracaBulanan A
     Left Outer join SaldoSepuluhDigit B on b.Perkiraan=left(a.Perkiraan,10) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0



GO

-- Procedure: SP_InsertR6
-- Created: 2015-10-02 08:33:27.857 | Modified: 2016-03-19 18:36:34.630
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertR6]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with saldoEnamDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,6) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
 (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,6), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempRNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBRNeracaBulanan A
     Left Outer join saldoEnamDigit B on b.Perkiraan=left(a.Perkiraan,6) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0


GO

-- Procedure: SP_InsertR8
-- Created: 2015-10-02 08:33:50.640 | Modified: 2016-03-19 18:36:56.457
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InsertR8]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with SaldoDelapanDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,8) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
 (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,8), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi
 
)
insert TempRNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBRNeracaBulanan A
     Left Outer join SaldoDelapanDigit B on b.Perkiraan=left(a.Perkiraan,8) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0



GO

-- Procedure: SP_InsertR8F
-- Created: 2016-02-16 08:46:17.570 | Modified: 2016-03-19 18:37:07.643
-- =====================================================


CREATE PROCEDURE [dbo].[SP_InsertR8F]
--declare
@Perkiraan varchar(25),
@bulan int,
@tahun int
--@devisi varchar(10),
--@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015,@Perkiraan='100.01'
--select @Perkiraan=case when LEN(@Perkiraan)=4 then @Perkiraan+'00' else @Perkiraan end
;with saldoDelapanDigit as 
(
 select Perkiraan,sum(isnull(saldoawalGeneral,0)) saldoawalGeneral,sum(isnull(mdgeneral,0)) mdgeneral,sum(isnull(mkgeneral,0)) mkgeneral,
 sum(isnull(JPDGeneral,0)) JPDgeneral,sum(isnull(JPKGeneral,0)) JPKgeneral, sum(isnull(saldoakhirgeneral,0)) saldoakhirgeneral,
 sum(isnull(BudgetGeneral,0)) BudgetGeneral,Tahun,Bulan,Devisi from (  
  select left (Perkiraan,8) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,
 (case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)
    + case when a.DK=0 then SUM(a.MDRp) else SUM(a.MDRp)*-1 end 
    + case when a.DK=0 then sum(a.JPD) else sum(a.JPD)*-1 end 
    - case when a.DK=0 then SUM(a.MKRp ) else SUM(a.MKRp )*-1 end
    - case when a.DK=0 then SUM(a.JPK) else SUM(a.JPK)*-1 end  saldoakhirgeneral
  , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACALAMA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,8), DK,Tahun,Bulan,a.Devisi
 ) WY group by Perkiraan,Tahun,Bulan,Devisi

)
insert TempRNerBul (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,bulan,tahun)

select * from (
Select a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 then 'K' else '' end kSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 then 'K' else '' end kMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 then 'K' else '' end kMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 then 'K' else '' end kSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '' else '' end bintang,a.DK,a.Tanda,a.IsSubPerkiraan,@bulan bulan,@tahun tahun
from DBRNeracaBulanan A
     Left Outer join saldoDelapanDigit B on b.Perkiraan=left(a.Perkiraan,8) 
where B.Bulan=@bulan and B.Tahun=@tahun and a.Perkiraan=@Perkiraan --and B.Devisi like Case when @devisi='-' then '%' else @devisi end
) A where a.SaldoAwal<>0 or a.MD<>0 or a.MK<>0 or a.SaldoAkhir<>0



GO

-- Procedure: sp_InvBeli
-- Created: 2013-02-21 15:18:26.950 | Modified: 2014-01-13 15:51:50.057
-- =====================================================


CREATE   Procedure [dbo].[sp_InvBeli]
@Choice varchar(1),
@NoBukti varchar(20),
@Urut int,
@Harga numeric(18,2),
@DiscP numeric(18,2),
@DiscTot numeric(18,2),
@Discp2 Numeric(18,2),
@Discp3 Numeric(18,3),
@Discp4 Numeric(18,4),
@Discp5 Numeric(18,5)

As

begin tran

if @Choice='I'
begin
  select 1
end

if @Choice='U'
begin
  update dbBeliDET set HARGA=@Harga, DISCP=@DiscP, DISCTOT=@DiscTot,Discp2=@Discp2,Discp3=@Discp3,Discp4=@Discp4,@Discp5=@Discp5
  where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah
end

if @Choice='D'
begin
  select 1
end
--if Exists(select NoBukti from DBBELIDET where NOBUKTI=@NoBukti) 
-- Begin
--   Update DBBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAINET=(select SUM(NNET)NNET from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAIPPN=(select SUM(NPPN)NPPN from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI)
--   where NOBUKTI=@NoBukti                  
-- End 
--if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return
















GO

-- Procedure: SP_Investasi
-- Created: 2023-12-18 19:41:22.463 | Modified: 2024-08-05 20:21:37.617
-- =====================================================
CREATE PROCEDURE [dbo].[SP_Investasi]
@Choice char(1),
@Devisi varchar(5)='',
@Perkiraan varchar(30)='',
@Keterangan varchar(500)='',                     
@Quantity Numeric(18,4)=0,
@Persen Numeric(18,3)=0,
@TglPerolehan datetime=null,
@TglJatuhTempo datetime=null,
@Tipe varchar(1)='',
@Akumulasi varchar(15)='23000000',
@Biaya varchar(15)='12060080',
@NoMuka varchar(25)='',
@NoBelakang varchar(20)='',
@TipeAktiva tinyint,
@Bagian varchar(15),
@NoBelakang2 varchar(20),
@IsHeader tinyint,
@NoInvestasiHd varchar(30)='',
@Kelompok tinyint=0 ,
@GroupInvestasi varchar(15)='',
@TipeInvestasi tinyint=0,
@NilaiNominal numeric (18,2)=0
AS
begin tran
if @choice='I'
begin
  insert into dbInvestasi (Devisi,Perkiraan
           ,Keterangan,Quantity,Persen,TglPerolehan,TglJatuhTempo,Tipe,NoMuka
           ,NoBelakang,NoInvestasiHd,Kelompok,GroupInvestasi,TipeInvestasi,NilaiNominal,Akumulasi,Biaya )
  values (@Devisi,@Perkiraan,@Keterangan,@Quantity,@Persen,@TglPerolehan,@TglJatuhTempo,@Tipe,@NoMuka
           ,@NoBelakang,@NoInvestasiHd,@Kelompok,@GroupInvestasi,@TipeInvestasi,@NilaiNominal,@Akumulasi,@Biaya )
  if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
 update dbInvestasi set Keterangan=@Keterangan,Quantity=@Quantity,Persen=@Persen,TglPerolehan=@TglPerolehan,Tipe=@Tipe,
 NoMuka=@NoMuka,NoBelakang=@NoBelakang,NoInvestasiHd=@NoInvestasiHd,Kelompok=@Kelompok,GroupInvestasi=@GroupInvestasi,
 TipeInvestasi=@TipeInvestasi,TglJatuhTempo=@TglJatuhTempo,NilaiNominal=@NilaiNominal,Akumulasi =@Akumulasi,
 Biaya =@Biaya 
 where  Perkiraan=@Perkiraan
if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
 delete  DBINVESTASI where Devisi=@Devisi and Perkiraan=@Perkiraan
 --delete  TempDBAKTIVA where Devisi=@Devisi and Perkiraan=@Perkiraan
 if not exists(Select 'True' from DBINVESTASI where Devisi=@Devisi and Perkiraan=@Perkiraan)
    Delete DBINVESTASIDET where Devisi=@Devisi and Perkiraan=@Perkiraan
 /*if not exists(Select 'True' from TempDBAKTIVA where Devisi=@Devisi and Perkiraan=@Perkiraan)
    Delete TempDBAKTIVADET where Devisi=@Devisi and Perkiraan=@Perkiraan   */ 
 if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return
GO

-- Procedure: SP_InvestasiDet
-- Created: 2023-12-20 15:57:46.113 | Modified: 2025-07-24 15:31:19.223
-- =====================================================

CREATE PROCEDURE [dbo].[SP_InvestasiDet]
@Choice char(1),
@Divisi varchar(10),
@Perkiraan varchar(30),
@Bulan int,
@Tahun int,
@Valas varchar(15),
@kurs numeric(18,2),
@Awal numeric(18,2)=0,
@NilaiPasar numeric(18,2)=0,
@PersenJual numeric(18,2)=0,
@NilaiNominal numeric(18,2)=0,
@NAB float=0,
@UnitRskd float=0,
@tipe tinyint,
@Nilaipasarlalu numeric(18,2)=0,
@SPILalu numeric(18,2)=0
AS
begin tran
if (@choice='I')
begin
  	insert into dbInvestasidet (Devisi, Perkiraan, Bulan, Tahun, Valas,kurs,Awal,Awald,AwalPasar,
  	PersenJual,NilaiNominal,AwalPasarD,BungaRp,NAB,UnitRKSD,Tipe,SD,sk )
  	values (@Divisi, @Perkiraan, @Bulan, @Tahun, @valas,@kurs,@Awal*@kurs, @Awal,@Nilaipasarlalu,
  	@PersenJual,@NilaiNominal,0,0,@NAB ,@UnitRskd,@tipe,@NilaiPasar,@SPILalu  )
  	 
end
if (@choice='U')
begin
  IF NOT EXISTS(SELECT 'TRUE' FROM dbInvestasiDET WHERE DEVISI=@DIVISI AND PERKIRAAN=@PERKIRAAN AND BULAN=@Bulan AND TAHUN=@TAHUN)
  BEGIN
    insert into dbInvestasidet 
            (Devisi, Perkiraan,  Bulan, Tahun,   Valas, kurs, Awal,        awald,           AwalPasar,PersenJual ,
            NilaiNominal,AwalPasarD,BungaRp,nab,UnitRKSD,Tipe,SD,sk  )
  	values (@Divisi, @Perkiraan, @Bulan, @Tahun, @valas,@kurs, @Awal,@Awal*@kurs        ,@Nilaipasarlalu,@PersenJual,
  	@NilaiNominal,0,0,@nab,@UnitRskd,@tipe,@NilaiPasar,@SPILalu   )
  END 
  ELSE
  BEGIN
    UPDATE dbInvestasiDET SET AWAL=@AWAL*@kurs, AWALD=@AWAL, Valas=@Valas,Kurs=@kurs
                           ,--AwalPasar=@NilaiPasar,
                           SD =@NilaiPasar ,sk=@SPILalu,
                           PersenJual=@PersenJual,
                           NilaiNominal=@NilaiNominal,nab=@NAB,UnitRKSD=@UnitRskd ,Tipe=@tipe  ,AwalPasar =@Nilaipasarlalu 
    WHERE DEVISI=@DIVISI AND PERKIRAAN=@PERKIRAAN AND BULAN=@Bulan AND TAHUN=@TAHUN
    
  END
end
IF @@ERROR <> 0 GOTO JIKASALAH
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return

GO

-- Procedure: Sp_Invoice
-- Created: 2012-12-22 10:12:01.873 | Modified: 2013-01-21 10:14:29.027
-- =====================================================














CREATE   Procedure [dbo].[Sp_Invoice]
@Choice varchar(1),
@NoBukti varchar(20),
@Tanggal datetime,
@Keterangan varchar(100),
@Urut int,
@NoBeli varchar(20),
@KodeSupp Varchar(15)='',
@NoPO Varchar(20)='',
@NoFaktur Varchar(50)='',
@TglFaktur DateTime,
@KodeVls Varchar(15)='',
@Kurs Numeric(18,2)=0,
@PPN TinyInt=0,
@TipeBayar TinyInt=0,
@Hari Int=0
As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbInvoiceDet Where NoBukti=@NoBukti
  if not exists(select * from dbInvoice Where NoBukti=@NoBukti) 
  begin
    insert into dbInvoice (NOBUKTI, TANGGAL, KETERANGAN,KodeSupp,NoPO,NoFaktur,TglFaktur,KodeVls,Kurs,PPN,TipeBayar,Hari)
    values (@NOBUKTI, @TANGGAL, @KETERANGAN,@KodeSupp,@NoPO,@NoFaktur,@TglFaktur,@KodeVls,@Kurs,@PPN,@TipeBayar,@Hari)
  end
  insert into dbInvoiceDET (NOBUKTI, URUT,NoBeli)
  values(@NOBUKTI, @URUT,@NoBeli)
end
if @Choice='U'
begin
  update dbInvoiceDET set NoBeli=@NoBeli 
  where NoBukti=@NoBukti and Urut=@Urut
end

if @Choice='D'
begin
  delete dbInvoiceDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbInvoiceDET where NoBukti=@NoBukti)
  begin
    delete dbInvoice where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return














GO

-- Procedure: SP_InvoicePL
-- Created: 2014-02-19 10:28:05.203 | Modified: 2014-11-19 15:24:11.527
-- =====================================================

CREATE Procedure [dbo].[SP_InvoicePL]
@Choice varchar(1),
@nobukti varchar(30),
@nourut varchar(5),
@Tanggal datetime,
@NoSPB varchar(30),
@kodecustSupp varchar(15),
@Consignee varchar(8000),
@notifyParty varchar(8000),
@ContractNo Varchar(30),
@PoNo varchar(800),
@PaymentTerm varchar(8000),
@DocCreditNo varchar(50),
@PoL varchar(50),
@PoD varchar(50),
@NameOfVessel varchar(50),
@ShipOnBoardDate datetime,
@Packing varchar(8000),
@Others varchar(5000),
@IDUser varchar(15),
@Urut  int,
@UrutSPB Int,
@KodeBrg varchar(25),
@Ppn tinyint,
@Disc numeric(18,2),
@Kurs numeric(18,4),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@NoSat tinyint,
@isi numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2),
@harga numeric(18,4),
@DiscP numeric(18,2),
@DiscRp numeric(18,2),
@DiscTot numeric(18,2),
@ketDetail varchar(500),
@Valas varchar(15),
@IsLokal bit,
@NoBL varchar(50),
@NoteBeneficiary1 varchar(8000), 
@NoteBeneficiary2 varchar(8000), 
@NoteBeneficiary3 varchar(8000), 
@ShipmentAdvice1 varchar(8000), 
@ShipmentAdvice2 varchar(8000),
@ShippingMark Varchar(8000),
@meas numeric(18,2),
@ETADestination datetime,
@ToShipmentAdvice2 varchar(8000)='',
@FootNote varchar(8000)='',
@IssuingBank varchar(8000)='',
@Namabrg varchar(8000)='',
@NoSPP Varchar(30)='',
@TglSPP Datetime,
@NoSO Varchar(30)='',
@TglSO Datetime,
@Discp2 Numeric(18,2)=NULL,
@Discp3 Numeric(18,2)=NULL,
@Discp4 Numeric(18,2)=NULL,
@Discp5 Numeric(18,2)=NULL,
@Flagtipe tinyint,
@nobatch varchar(50)=''   
AS
begin Tran
if @Choice='I'
begin
  Select @urut=Max(Urut) from dbInvoicePLDet where nobukti=@nobukti
  Set @Urut=ISNULL(@urut,0)+1
  if not Exists(Select 'true' from dbInvoicePL where NoBukti=@nobukti)
  begin
    insert into dbInvoicePL(NoBukti,NoUrut,Tanggal,NoSPP,KodeCustSupp,Consignee,NotifyParty,ContractNo,PONo,
                            PaymentTerm,DocCreditNo,PoL,PoD,NameOfVessel,ShipOnBoardDate,Packing,Others,IDUser, 
                            Valas,Kurs,PPN,IsLokal, NoBL, NoteBeneficiary1, NoteBeneficiary2, NoteBeneficiary3,
                            ShipmentAdvice1, ShipmentAdvice2, ETADestination,ToShipmentAdvice2, IssuingBank,FlagTipe) 
    Values (@nobukti,@nourut,@Tanggal,@NoSpp,@KodeCustSupp,@Consignee,@notifyParty,@ContractNo,@PoNo,
            @PaymentTerm,@DocCreditNo,@PoL,@PoD,@NameOfVessel,@ShipOnBoardDate,@Packing,@Others,@IDUser, 
            @Valas,@Kurs,@PPN,@IsLokal, @NoBL, @NoteBeneficiary1, @NoteBeneficiary2, @NoteBeneficiary3,
            @ShipmentAdvice1, @ShipmentAdvice2, @ETADestination,@ToShipmentAdvice2, @IssuingBank,@Flagtipe)
  end
  Insert into dbInvoicePLDet(NoBukti, Urut, NoSPB, UrutSPB, KodeBrg, Namabrg, PPN, DISC, KURS, QNT, QNT2, SAT_1, SAT_2, 
                             NOSAT, ISI, NetW, GrossW, HARGA, DiscP, DiscRp, DISCTOT, KetDetail, ShippingMark, Meas,
                             Nospp, Tglspp, NoSO, TglSO, Pono,Discp2,Discp3,Discp4,Discp5,NoBatch)
  Values (@nobukti, @Urut, @NoSPB, @UrutSPB, @KodeBrg, @Namabrg, @Ppn, @Disc, @Kurs, @Qnt, @Qnt2, @Sat_1, @Sat_2, @NoSat, @isi, @NetW, @GrossW, @harga,
          @DiscP, @DiscRp, @DISCTOT,@ketDetail, @ShippingMark, @meas, @Nospp, @Tglspp, @NoSO, @TglSO, @PoNo,
          @Discp2,@Discp3,@Discp4,@Discp5,@nobatch)                                      
end
else if @Choice='U'
begin
 update dbInvoicePLDet set NoSPB=@NoSPB, UrutSPB=@UrutSPB, KodeBrg=@KodeBrg, PPN=@Ppn, DISC=@Disc, KURS=@Kurs, 
                           QNT=@Qnt, QNT2=@Qnt2, SAT_1=@Sat_1, SAT_2=@Sat_2, 
                           NOSAT=@NoSat, ISI=@isi, NetW=@NetW, GrossW=@GrossW, 
                           HARGA=@harga, DiscP=@DiscP, DiscRp=@DiscRp, DISCTOT=@DiscTot,KetDetail=@ketDetail, ShippingMark=@ShippingMark,
                           Meas=@meas, Namabrg=@Namabrg,Nospp=@NoSpp, Tglspp=@TglSPP, NoSO=@NoSO, TglSO=@TglSO, Pono=@PoNo
                           ,Discp2=@Discp2,Discp3=@Discp3,Discp4=@Discp4,Discp5=@Discp5
 where NoBukti=@nobukti and Urut=@Urut
end
else if @Choice='D'
begin
  delete dbInvoicePLDet where NoBukti=@nobukti and Urut=@Urut
  if not exists(select 'True' from dbInvoicePLDet where NoBukti=@nobukti)
     delete dbInvoicePL where NoBukti=@nobukti 
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return



GO

-- Procedure: SP_InvoicePLLampiran
-- Created: 2013-01-15 11:08:19.907 | Modified: 2013-01-15 11:08:19.907
-- =====================================================


CREATE Procedure [dbo].[SP_InvoicePLLampiran]
@Choice varchar(1),
@Nobukti varchar(30),
@urut int,
@Keterangan varchar(8000),
@kodeVls Varchar(15),
@Kurs numeric(18,2),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@Nosat tinyint,
@Sat_1 varchar(5),
@Sat_2 Varchar(5),
@Harga numeric(18,2)
as
begin tran
if @Choice='I'
begin
  Select @urut=urut from DBInvoicePLLampiran where Nobukti=@Nobukti
  Set @urut=ISNULL(@urut,0)+1
  insert into DBInvoicePLLampiran(Nobukti,Urut,Keterangan,KodeVls,Kurs,Qnt,Qnt2,Nosat,Sat_1,Sat_2, Harga)
  Values (@Nobukti,@urut,@Keterangan,@KodeVls, @Kurs,@Qnt,@Qnt2,@Nosat,@Sat_1,@Sat_2, @Harga)
end
else if @Choice='U'
begin
  update DBInvoicePLLampiran set Keterangan=@Keterangan, KodeVls=@KodeVls, Kurs=@Kurs,Qnt=@Qnt,Qnt2=@Qnt2,
                                 Nosat=@Nosat,Sat_1=@Sat_1,Sat_2=@Sat_2, Harga=@Harga
  where Nobukti=@Nobukti and Urut=@urut
end
else if @Choice='D'
begin
  delete from DBInvoicePLLampiran 
  where Nobukti=@Nobukti and Urut=@urut
end
if @@ERROR<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return 






GO

-- Procedure: SP_InvoiceRPJ
-- Created: 2014-03-05 12:40:22.123 | Modified: 2014-03-05 12:40:22.123
-- =====================================================

CREATE Procedure [dbo].[SP_InvoiceRPJ]
@Choice varchar(1),
@Nobukti varchar(30),
@NoUrut varchar(5),
@Tanggal datetime,
@Kodecustsupp varchar(15),
@NoInvoice varchar(50),
@TglInvoice Datetime,
@Kodevls varchar(15),
@Kurs numeric(18,2),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@Iduser varchar(15),
@Urut int,
@kodebrg varchar(25),
@NoRPJ varchar(30),
@urutRPJ int,
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2),
@Harga numeric(18,2),
@DiscP numeric(18,2),
@DiscRp numeric(18,2),
@DiscTot  numeric(18,2),
@Keterangan varchar(8000),
@Flagmenu tinyint,
@FlagTipe Tinyint,
@Discp2 NUmeric(18,2),
@Discp3 NUmeric(18,2),
@Discp4 NUmeric(18,2),
@Discp5 NUmeric(18,2)
as
begin Tran
if @Choice='I'
begin
  Select @urut=MAX(Urut) from DBINVOICERPJDet where NoBukti=@Nobukti
  Set @urut=ISNULL(@urut,0)+1
  if not Exists(Select 'True' From DBINVOICERPJ where NoBukti=@Nobukti) 
  begin
    insert into DBINVOICERPJ (NoBukti, NoUrut, Tanggal, TglJatuhTempo, KODECUSTSUPP, NoInvoice, TglInvoice, NORPJ, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, IDUser, IsFLag,Flagtipe) 
    Values(@Nobukti, @NoUrut, @Tanggal, @Tanggal+@Hari, @Kodecustsupp, @NoInvoice, @TglInvoice, @NoRPJ,@KODEVLS, @Kurs, @PPn, @TipeBayar, @Hari, @Iduser, @Flagmenu,@FlagTipe)  
  end
  Insert into DBINVOICERPJDet(NoBukti, Urut, Kodebrg, NOSPR, UrutSPR, Disc, PPn, Kurs, SAT_1, SAT_2, Qnt, Qnt2, Nosat, Isi, Harga, DiscP, DiscRp, DISCTOT, Keterangan,Discp2,Discp3,Discp4,Discp5)
  Values(@Nobukti, @Urut, @kodebrg, @NoRPJ, @urutRPJ, 0, @PPn, @Kurs, @Sat_1, @Sat_2, @Qnt, @qnt2, @Nosat, @Isi, @Harga, @DiscP, @DiscRp, @DiscTot, @Keterangan,@Discp2,@Discp3,@Discp4,@Discp5)
end
else if @Choice='U'
begin
  update DBINVOICERPJDet set Kodebrg=@kodebrg, NOSPR=@NoRPJ, UrutSPR=@urutRPJ, Disc=0, PPn=@PPn, 
                             Kurs=@Kurs, SAT_1=@Sat_1, SAT_2=@Sat_2, Qnt=@qnt, Qnt2=@qnt2, Nosat=@Nosat, 
                             Isi=@Isi, Harga=@Harga, DiscP=@DiscP, DiscRp=@DiscRp, DISCTOT=@DiscTot, Keterangan=@Keterangan
                             ,Discp2=@Discp2,Discp3=@Discp3,Discp4=@Discp4,Discp5=@Discp5
  where NoBukti=@Nobukti and Urut=@urut

end
else if @Choice='D'
begin
  Delete DBINVOICERPJDet where NoBukti=@Nobukti and Urut=@urut
  if not Exists(Select 'True' From DBINVOICERPJDet where NoBukti=@Nobukti) 
  begin
     Delete DBINVOICERPJ where NoBukti=@Nobukti 
  end
end


if @@ERROR<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return





GO

-- Procedure: sp_InvRBeli
-- Created: 2013-02-21 11:44:22.057 | Modified: 2023-05-21 20:06:15.980
-- =====================================================


CREATE   Procedure [dbo].[sp_InvRBeli]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@KodeSupp varchar(15),
@NoBeli varchar(20),
@Keterangan varchar(200),
@KodeVls varchar(15),
@Kurs numeric(18,2),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@Urut int,
@KodeBrg varchar(25),
@UrutPBL int,
@Qnt numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2),
@Satuan varchar(5),
@Harga numeric(18,2),
@DiscP numeric(18,2),
@DiscTot numeric(18,2)/*,
@Discp2 Numeric(18,2),
@Discp3 Numeric(18,3),
@Discp4 Numeric(18,4),
@Discp5 Numeric(18,5)*/

As

begin tran

if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbRBeliDet Where NoBukti=@NoBukti
  if @@error<>0  goto jikasalah
  if not exists(select * from dbRBeli Where NoBukti=@NoBukti) 
  begin
    insert into dbRBeli (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling,  KETERANGAN, 
	--FakturSUPP, 
	KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp, NoBeli, KodeGdg--,FlagTipe
	)
	select @NoBukti, @NoUrut, @Tanggal, @Tanggal+HARI, @KodeSupp, HANDLING, @Keterangan,
	--@FakturSupp, 
	KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DISCRP, @NoBeli,'-'--, @KodeGdg,@FlagTipe
	from DBBELI 
	where NOBUKTI=@NoBeli
	if @@error<>0  goto jikasalah
  insert into dbRBeliDET (NOBUKTI, URUT, KODEBRG, PPN, --DISC, 
  KURS, QNT, NOSAT, SATUAN, ISI, HARGA, DISCP, DISCTOT, BYANGKUT, 
  NOPBL, URUTPBL, HPP, Qnt1, Qnt2--,DiscP2,DiscP3,DiscP4,DiscP5,Isjasa,namaBrg,Nobatch
  )
  values(@NOBUKTI, @URUT, @KODEBRG, @PPN, --@Disc, 
  @Kurs,  @Qnt, @NoSat, @Satuan, @Isi, @Harga, @DiscP, @DiscTOT, 0.00,
  @NoBeli, @UrutPBL, 0,0,0--,--@Qnt1, 
  --@Qnt--,@Discp2,@Discp3,@Discp4,@Discp5,@Isjasa,@NamaBrg,@Nobatch
  )
  if @@error<>0  goto jikasalah	
  end  
end

if @Choice='U'
begin
  update dbRBeliDET set HARGA=@Harga, DISCP=@DiscP, DISCTOT=@DiscTot--,DiscP2=@Discp2,Discp3=@Discp3,Discp4=@Discp4,Discp5=@Discp5
  where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah
end

if @Choice='D'
begin
  --select 1
  delete dbRBeliDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbRBeliDET where NoBukti=@NoBukti)
  begin
    delete dbRBeli where NoBukti=@NoBukti
  end  
end
--if Exists(select NoBukti from DBBELIDET where NOBUKTI=@NoBukti) 
-- Begin
--   Update DBBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAINET=(select SUM(NNET)NNET from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAIPPN=(select SUM(NPPN)NPPN from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI)
--   where NOBUKTI=@NoBukti                  
-- End 
--if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return
















GO

-- Procedure: SP_IsiFPBaru
-- Created: 2014-07-10 09:40:05.507 | Modified: 2014-11-07 09:13:39.143
-- =====================================================


CREATE procedure [dbo].[SP_IsiFPBaru]

@MaxKodeFP int = 0,
@MaxNomor int = 0, 
@NoAwal int = 0, 
@NoAkhir int = 0,
@NoSeri varchar(10) = ''

as
select @MaxKodeFP = MAX(KodeFP), @NoAwal = B.NoAwal, @NoAkhir = B.NoAkhir, @NoSeri = B.NoSeri 
from DBInvoicePL A
left outer join DBNomorFP B on B.Kode = A.KodeFP
group by B.NoAwal, B.NoAkhir, B.NoSeri

select @MaxNomor = ISNULL(MAX(CAST(RIGHT(NoPajak,8) as Int)),0)+1 
from DBInvoicePL
where KodeFP = @MaxKodeFP

--select @MaxKodeFP, @MaxNomor, @NoAwal, @NoAkhir
/*
if @MaxNomor between @NoAwal and @NoAkhir
  begin
    select @MaxNomor Nomor, @MaxKodeFP KodeFP
  end 
else 
  begin
    update DBNomorFP set IsPenuh = 1 
    where Kode = @MaxKodeFP
    
    select NoAwal, @MaxKodeFP+1 KodeFP 
    from DBNomorFP
    where Kode = @MaxKodeFP+1
  end
*/
if @MaxKodeFP = 1 and
	(
	select count(Nopajak) 
	from dbinvoicepl 
	where KodeFP = 1 and NoPajak = ''
	group by NoPajak
	) > 0
	and
	(
		not exists
		(
		select (Nopajak) 
		from dbinvoicepl 
		where KodeFP = 1 and NoPajak <> ''
		group by NoPajak
		) 
	)-- = 0	
begin
		select NoAwal, @MaxKodeFP KodeFP, NoSeri 
		from DBNomorFP
		where Kode = @MaxKodeFP
end
else
begin
	if @MaxNomor between @NoAwal and @NoAkhir
	  begin
		select @MaxNomor Nomor, @MaxKodeFP KodeFP, @NoSeri NoSeri
	  end 
	else 
	  begin
		update DBNomorFP set IsPenuh = 1 
		where Kode = @MaxKodeFP
	    
		select NoAwal, @MaxKodeFP+1 KodeFP, NoSeri 
		from DBNomorFP
		where Kode = @MaxKodeFP+1
	  end
end


GO

-- Procedure: sp_IsPerkiraanIntoNeraca
-- Created: 2010-12-15 13:37:36.873 | Modified: 2010-12-15 13:37:36.873
-- =====================================================

CREATE PROCEDURE [dbo].[sp_IsPerkiraanIntoNeraca]
@Perkiraan varchar(15),
@Bulan int,
@tahun int
AS
insert into dbneraca(Perkiraan,bulan,tahun,devisi)
select @perkiraan,@bulan,@tahun,devisi
from dbdevisi 
where devisi not in (select devisi from dbneraca where perkiraan=@perkiraan and bulan=@bulan and tahun=@tahun)


GO

-- Procedure: SP_ItemMovement_Final
-- Created: 2025-08-21 08:57:19.210 | Modified: 2025-08-21 08:57:19.210
-- =====================================================

    CREATE PROCEDURE SP_ItemMovement_Final
        @KODEBRG NVARCHAR(20),
        @TanggalAwal DATE,
        @TanggalAkhir DATE
    AS
    BEGIN
        SET NOCOUNT ON;
        
        -- Purchase movements from DBBELI and DBBELIDET
        SELECT 
            'PEMBELIAN' AS JenisMovement,
            b.NOBUKTI,
            b.TANGGAL,
            bd.QNT AS Quantity,
            'IN' AS Direction,
            b.KODESUPP AS Partner,
            cs.NAMACUSTSUPP AS NamaPartner
        FROM DBBELI b
        INNER JOIN DBBELIDET bd ON b.NOBUKTI = bd.NOBUKTI
        INNER JOIN DBCUSTSUPP cs ON b.KODESUPP = cs.KODECUSTSUPP
        WHERE bd.KODEBRG = @KODEBRG
            AND b.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND b.IsBatal = 0
        
        UNION ALL
        
        -- Sales movements from DBJUAL and DBJUALDET
        SELECT 
            'PENJUALAN' AS JenisMovement,
            j.NOBUKTI,
            j.TANGGAL,
            jd.QNT AS Quantity,
            'OUT' AS Direction,
            j.KODECUST AS Partner,
            cs.NAMACUSTSUPP AS NamaPartner
        FROM DBJUAL j
        INNER JOIN DBJUALDET jd ON j.NOBUKTI = jd.NOBUKTI
        INNER JOIN DBCUSTSUPP cs ON j.KODECUST = cs.KODECUSTSUPP
        WHERE jd.KODEBRG = @KODEBRG
            AND j.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND j.ISBATAL = 0
        
        UNION ALL
        
        -- Transfer movements from DBTRANSFER and DBTRANSFERDET (if exists)
        SELECT 
            'TRANSFER' AS JenisMovement,
            t.NOBUKTI,
            t.TANGGAL,
            td.QNT AS Quantity,
            'TRANSFER' AS Direction,
            'TRANSFER' AS Partner,
            'Internal Transfer' AS NamaPartner
        FROM DBTRANSFER t
        INNER JOIN DBTRANSFERDET td ON t.NOBUKTI = td.NOBUKTI
        WHERE td.KODEBRG = @KODEBRG
            AND t.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
        
        ORDER BY TANGGAL, NOBUKTI;
    END
    
GO

-- Procedure: SP_ItemMovement_Fixed
-- Created: 2025-08-21 08:56:06.180 | Modified: 2025-08-21 08:56:06.180
-- =====================================================

    CREATE PROCEDURE SP_ItemMovement_Fixed
        @KODEBRG NVARCHAR(20),
        @TanggalAwal DATE,
        @TanggalAkhir DATE
    AS
    BEGIN
        SET NOCOUNT ON;
        
        -- Purchase movements from DBBELI and DBBELIDET
        SELECT 
            'PEMBELIAN' AS JenisMovement,
            b.NOBUKTI,
            b.TANGGAL,
            bd.QNT AS Quantity,
            'IN' AS Direction,
            b.KODESUPP AS Partner,
            cs.NAMACUSTSUPP AS NamaPartner
        FROM DBBELI b
        INNER JOIN DBBELIDET bd ON b.NOBUKTI = bd.NOBUKTI
        INNER JOIN DBCUSTSUPP cs ON b.KODESUPP = cs.KODECUSTSUPP
        WHERE bd.KODEBRG = @KODEBRG
            AND b.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND b.IsBatal = 0
        
        UNION ALL
        
        -- Sales movements from DBJUAL and DBJUALDET
        SELECT 
            'PENJUALAN' AS JenisMovement,
            j.NOBUKTI,
            j.TANGGAL,
            jd.QNT AS Quantity,
            'OUT' AS Direction,
            j.KODECUST AS Partner,
            cs.NAMACUSTSUPP AS NamaPartner
        FROM DBJUAL j
        INNER JOIN DBJUALDET jd ON j.NOBUKTI = jd.NOBUKTI
        INNER JOIN DBCUSTSUPP cs ON j.KODECUST = cs.KODECUSTSUPP
        WHERE jd.KODEBRG = @KODEBRG
            AND j.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND j.ISBATAL = 0
        
        ORDER BY TANGGAL, NOBUKTI;
    END
    
GO

-- Procedure: Sp_Jabatan
-- Created: 2010-12-10 09:50:01.147 | Modified: 2010-12-10 09:50:01.147
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_Jabatan]
@Choice char(1)='',
@KodeJab Varchar(15)='',
@NamaJab Varchar(100)='',
@OldKode varchar(15)=''
AS
begin tran
if @choice='I'
begin
	insert into dbJabatan (KodeJab, NamaJab)
	values (@KodeJab, @NamaJab)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbJabatan set NamaJab=@NamaJab,KodeJab=@KodeJab
             where KodeJab=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbJabatan where KodeJab=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_JadwalPRD
-- Created: 2014-07-25 14:01:49.607 | Modified: 2014-07-25 14:01:49.607
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_JadwalPRD]   
@Choice char(1)='',
@Nojadwal int=0,
@KodeMsn Varchar(15)='',
@Tanggal DateTime=0,
@Jamawal DateTime=0,
@JamAkhir dateTime=0,
@IsProduksi bit=0,
@Nospk varchar(15)='',
@Keterangan Varchar(50)='',
@QntSPK Numeric(18,2)=0,
@QntKerja Numeric(18,2)=0
AS
begin tran
if @choice='I'
begin
	insert into DbjadwalPRD (KodeMsn, TANGGAL,JAMAWAL,JAMAKHIR,ISPRODUKSI,NOSPK,KETERANGAN,QNTSPK,QNTKERJA)
	values (@KodeMsn,@Tanggal,@Jamawal,@JamAkhir,@IsProduksi,@Nospk,@Keterangan,@QntSPK,@QntKerja)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DbjadwalPRD set TANGGAL=@Tanggal,JAMAWAL=@Jamawal,JAMAKHIR=@JamAkhir,ISPRODUKSI=@IsProduksi,
				NOSPK=@Nospk,KETERANGAN=@Keterangan,QNTSPK=@QntSPK,QNTKERJA=@QntKerja
             where nojadwal=@Nojadwal
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DbjadwalPRD where nojadwal=@Nojadwal
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_JBAHAN
-- Created: 2012-11-13 09:19:42.380 | Modified: 2012-11-13 09:19:42.380
-- =====================================================


CREATE PROCEDURE Sp_JBAHAN
@Choice char(1),
@KdBHN Varchar(20),
@NamaBHN Varchar(50)
 AS
begin tran
if @choice='I'
begin
  insert into dbJBahan (KDBHN, NAMABHN)
  values (@KdBHN, @NamaBHN)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update dbJBahan set NAMABHN=@NamaBHN 
             where KDBHN=@KdBHN
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  dbJBahan where KDBHN=@KDBHN
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_JenisCust
-- Created: 2014-02-13 11:48:06.470 | Modified: 2014-02-13 11:48:06.470
-- =====================================================


create PROCEDURE [dbo].[Sp_JenisCust]
@Choice char(1),
@KodeJenis Varchar(15),
@NamaJenis Varchar(40)

AS
begin tran
if @choice='I'
begin
  insert into dbJenisCustSupp (Kodejenis, NamaJenis)
  values (@KodeJenis, @NamaJenis)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
    update DbJenisCustSupp 
    set Namajenis=@NamaJenis
    where Kodejenis=@KodeJenis
    if @@error <> 0
     goto jikasalah
end
if @choice='D'
begin
   delete DbjenisCustSupp 
   where KodeJenis=@KodeJenis
   
   if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_JenisInvestasi
-- Created: 2024-07-18 05:20:28.417 | Modified: 2024-07-18 05:20:28.417
-- =====================================================


Create PROCEDURE [dbo].[Sp_JenisInvestasi]
@Choice char(1),
@KodeGrp Varchar(20),
@NamaGrp Varchar(50)
 AS
begin tran
if @choice='I'
begin
  insert into dbjenis (KodeJnsBrg, Keterangan )
  values (@KodeGrp, @NamaGrp)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update dbJenis set Keterangan =@NamaGrp 
             where KodeJnsBrg=@KodeGrp
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  DBJENIS where KodeJnsBrg=@KodeGrp
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_JnsBarang
-- Created: 2010-12-17 13:00:21.527 | Modified: 2010-12-17 13:00:21.527
-- =====================================================
Create PROCEDURE [dbo].[Sp_JnsBarang]
@Choice char(1),
@KodeJnsBrg Varchar(15),
@Keterangan Varchar(100),
@OldKode varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbJenis (KodeJnsBrg, Keterangan)
	values (@KodeJnsBrg, @Keterangan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbJenis set Keterangan=@Keterangan ,KodeJnsBrg=@KodeJnsbrg
             where KodeJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbJenis where KodeJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_JnsBarangBrgJadi
-- Created: 2011-11-07 19:23:55.907 | Modified: 2011-11-07 19:23:55.907
-- =====================================================

Create PROCEDURE [dbo].[Sp_JnsBarangBrgJadi]
@Choice char(1),
@KodeJnsBrg Varchar(15),
@Keterangan Varchar(100),
@OldKode varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into DBJENISBRGJADI (KodeJnsBrg, Keterangan)
	values (@KodeJnsBrg, @Keterangan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBJENISBRGJADI set Keterangan=@Keterangan ,KodeJnsBrg=@KodeJnsbrg
             where KodeJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBJENISBRGJADI where KodeJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return



GO

-- Procedure: Sp_JnsPakai
-- Created: 2010-12-10 09:50:01.150 | Modified: 2010-12-10 09:50:01.150
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_JnsPakai]
@Choice char(1),
@KodeJnsPakai Varchar(15)='',
@Keterangan Varchar(100)='',
@OldKode varchar(15)=''
AS
begin tran
if @choice='I'
begin
	insert into dbJnsPakai (KodeJnsPakai, Keterangan)
	values (@KodeJnsPakai, @Keterangan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbJnsPakai set Keterangan=@Keterangan ,KodeJnsPakai=@KodeJnsPakai
             where KodeJnsPakai=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbJnsPakai where KodeJnsPakai=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_JnsTambahan
-- Created: 2013-07-22 11:23:24.977 | Modified: 2013-07-22 11:23:24.977
-- =====================================================




CREATE PROCEDURE [dbo].[Sp_JnsTambahan]
@Choice char(1),
@KodeJnsTambahan Varchar(20),
@NamaJnsTambahan Varchar(50)
 AS
begin tran
if @choice='I'
begin
  insert into dbJnsTambahan (KodeJnsTambahan, Nama)
  values (@KodeJnsTambahan, @NamaJnsTambahan)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update dbJnsTambahan set Nama=@NamaJnsTambahan 
             where KodeJnsTambahan=@KodeJnsTambahan
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  dbJnsTambahan where KodeJnsTambahan=@KodeJnsTambahan
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return



GO

-- Procedure: Sp_JualTunai
-- Created: 2013-07-25 09:23:11.497 | Modified: 2013-12-10 10:21:54.077
-- =====================================================




CREATE Procedure [dbo].[Sp_JualTunai]
@Choice varchar(1),
@NoBukti varchar(20),
@Tanggal datetime,
@KodeCust varchar(15),
@Urut int,
@KodeBrg varchar(25),
@Qnt numeric(18,2),
@Harga numeric(18,2),
@DiscP numeric(18,2),
@NoSat tinyint,
@Satuan varchar(10),
@Isi numeric(18,3),
@UserID varchar(15),
@Ctk int,
@DIskon numeric(18,2),
@TglBatal datetime,
@Keterangan Varchar(50),
@NoUrut varchar(5),
@Pemesan varchar(50),
@IsOrder bit,
@IsTakein Bit=0,
@IsTakeOut Bit=0,
@IsKoreksi TinyInt=0,
@TglInput DateTime=0,
@UserIdBatal Varchar(20)=''

As
Begin tran
if @choice='I'
begin
if @IsKoreksi<>1 
Begin
  select @urut=isnull(max(urut),0)+1 from DBJUALTunaiDet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1
end
  if not exists(select * from DBJUALTunai Where NoBukti=@NoBukti) 
  begin
    insert into DBJUALTunai (NOBUKTI, NoUrut, TANGGAL, KODECUST, TglInput, UserID, Pemesan, IsOrder)
    values (@NOBUKTI, @NoUrut, @TANGGAL, @KODECust, Case when @IsKoreksi=1 Then @TglInput else getdate()end , @UserID, @Pemesan, @IsOrder)
   	if @@error<>0  goto jikasalah		
  end
  
  insert into DBJUALTunaiDET (NOBUKTI, URUT,  KodeBrg, QNT, HARGA, DISCP, NoSat, Satuan, Isi, Ctk,Diskon, TglBatal, Keterangan, IsSelesai, IsKirim,TakeIn,TakeOut,UserIDBatal)
  values(@NOBUKTI,@URUT, @KodeBrg, @QNT, @HARGA, @DiscP, @NoSat, @Satuan, @Isi, @Ctk,@Diskon, case when @IsKoreksi=1 Then GetDate() else @TglBatal end,@Keterangan, 0, 0,@IsTakein,@IsTakeOut,@UserIDBatal)
  if @@error<>0  goto jikasalah
end
if @choice='U'
begin
  update DBJUALTunaiDET set Qnt=@QNT, Harga=@HARGA, DiscP=@DiscP, NoSat=@NoSat, 
                       Satuan=@Satuan, Isi=@Isi,Diskon=@Diskon, TglBatal=@TglBatal,TakeIn=@IsTakein,TakeOut=@IsTakeOut
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete dbJualTunaiDet where nobukti=@nobukti and  KodeBrg = @KodeBrg and Keterangan = @Keterangan 
  if not exists( select nobukti from DBJualTunaiDET where nobukti=@nobukti)
  begin
    delete DBJUALTunai where nobukti=@nobukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
        raiserror('Proses Input Data Gagal',16,1)
           Return



GO

-- Procedure: Sp_Kategori
-- Created: 2010-12-10 09:50:01.153 | Modified: 2011-12-22 10:51:52.820
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_Kategori]
@Choice char(1),
@KodeKategori Varchar(15)='',
@Keterangan Varchar(100)='',
@KodeGdg Varchar(15)='',
@OldKode varchar(15)=''
AS
begin tran
if @choice='I'
begin
	insert into dbKategori (KodeKategori, Keterangan, KodeGdg)
	values (@KodeKategori, @Keterangan, @KodeGdg)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbKategori set Keterangan=@Keterangan ,KodeKategori=@KodeKategori, KodeGdg=@KodeGdg
   where KodeKategori=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbKategori where KodeKategori=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_KategoriBrgJadi
-- Created: 2011-11-04 17:34:02.630 | Modified: 2011-11-04 17:34:02.630
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_KategoriBrgJadi]
@Choice char(1),
@KodeKategori Varchar(15)='',
@Keterangan Varchar(100)='',
@KodeGdg Varchar(15)='',
@Perkiraan Varchar(25)='',
@Biaya Varchar(25)='',
@OldKode varchar(15)=''
AS
begin tran
if @choice='I'
begin
	insert into dbKategoriBrgJadi (KodeKategori, Keterangan)
	values (@KodeKategori, @Keterangan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbKategoriBrgJadi set Keterangan=@Keterangan ,KodeKategori=@KodeKategori
   where KodeKategori=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbKategoriBrgJadi where KodeKategori=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_Kelompok
-- Created: 2010-12-10 09:50:01.160 | Modified: 2011-11-15 14:33:32.810
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_Kelompok]
@Choice char(1),
@KodeKelompok Varchar(15),
@Keterangan Varchar(100),
@Perkiraan Varchar(25),
@OldKode varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbKelompok (KodeKelompok, Keterangan, Perkiraan)
	values (@KodeKelompok, @Keterangan, @Perkiraan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbKelompok set Keterangan=@Keterangan ,KodeKelompok=@KodeKelompok, Perkiraan=@Perkiraan
             where KodeKelompok=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbKelompok where KodeKelompok=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: sp_Kendaraan
-- Created: 2014-11-10 09:14:58.987 | Modified: 2014-11-10 09:14:58.987
-- =====================================================




CREATE PROCEDURE [dbo].[sp_Kendaraan]
@Choice char(1),
@KODEKEND varchar (20),
@KODEJENISKEND varchar (20),
@NAMAKEND varchar (50),
@OldKode Varchar(20)='',
@IsAktif tinyint=1,
@KodeCost varchar(30)

AS
begin tran
if @choice='I'
begin
	insert into DBKENDARAAN (KODEKEND, KODEJENISKEND, NAMAKEND, IsAktif,KODECOST)
	--values (@KODEKEND, @KODEJENISKEND, @NAMAKEND, @IsAktif)
	values (@NAMAKEND, @KODEJENISKEND, @NAMAKEND, @IsAktif,@KodeCost)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBKENDARAAN set IsAktif=@IsAktif,KODECOST=@KodeCost
	-- KODEKEND=@KODEKEND,KODEJENISKEND=@KODEJENISKEND, NAMAKEND=@NAMAKEND
    where KODEKEND=@NAMAKEND
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBKENDARAAN where KODEKEND=@NAMAKEND
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return






GO

-- Procedure: sp_Kiriman
-- Created: 2012-12-03 11:34:30.263 | Modified: 2012-12-03 13:31:29.433
-- =====================================================






CREATE Procedure [dbo].[sp_Kiriman]
@Choice varchar(1),
@NoBukti varchar(20)='',
@KodeBrg varchar(25)='',
@Tanggal datetime=0,
@Qnt numeric(18,2)=0,
@OldTanggal datetime=0
As
Begin tran
if @Choice='I'
begin
   insert into [DBKirimDET] (NOBUKTI,KODEBRG, TANGGAL,Qnt)
   values (@NOBUKTI, @KODEBRG, @TANGGAL, @Qnt)
end
if @Choice='U'
begin 
  update [DBKirimDET] set Tanggal=@Tanggal, Qnt=@QNT
  where NoBukti=@NoBukti and KodeBrg=@KodeBrg and Tanggal=@OldTanggal
end
if @Choice='D'
begin
  delete [DBKirimDET] where NoBukti=@NoBukti and Kodebrg=@KodeBrg and Tanggal=@OldTanggal
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: Sp_Konsesi
-- Created: 2011-06-14 10:12:57.687 | Modified: 2011-06-14 10:12:57.687
-- =====================================================

CREATE  Procedure [dbo].[Sp_Konsesi]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@KODECUSTSUPP varchar (15),
@KODEGDG varchar(15),
@Valas varchar(15),
@Kurs numeric(18,2),
@PPN tinyint,
@TipeBayar tinyint,
@Disc numeric(18,2),
@DiscRp numeric(18,2),
@NOSPB varchar (30),
@TGLSPB datetime,
@NOPBL Varchar(30),
@NOPO varchar(30),
@URUT int ,
@KODEBRG varchar (25),
@QNT numeric(18, 2) ,
@QNT2 numeric(18, 2),
@SAT_1 varchar (5) ,
@SAT_2 varchar (5),
@ISI numeric(18, 2) ,
@Harga numeric(18,2),
@URUTPBL int, 
@UrutPO int, 
@Keterangan varchar (800) ,
@IDUser varchar(30),
@NoSat int,
@NOINS Varchar(30),
@UrutINS int
As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbKonsesiDet Where NoBukti=@NoBukti
  	if not exists(select * from dbKonsesi Where NoBukti=@NoBukti) 
  	begin
 		insert into dbKonsesi (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, NOPBL, NOPO, KODECUSTSUPP, 
		KODEGDG, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp, IDUser)
 		values (@NOBUKTI, @NoUrut, @TANGGAL, @Tanggal, @NOPBL, @NOPO, @KODECUSTSUPP, 
		@KODEGDG, @Valas, @Kurs, @PPN, @tipeBayar, 0, 0, 0, 0,  @IDUser)
		if @@error<>0  goto jikasalah
  	end
	insert into dbKonsesiDET (NOBUKTI, URUT, NoPBL, UrutPBL, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, Sat_1,Sat_2, Isi, Keterangan, NoIns,urutins, Harga,nosat)
	Values(@NOBUKTI, @URUT,  @NoPBL, @UrutPBL, @PPN, @Disc, @Kurs, @KODEBRG, @Qnt, @QNT2, @Sat_1,@Sat_2, @Isi, @Keterangan,  @NOINS,@UrutINS, @harga, @NoSat)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
  	update dbKonsesiDET set NOPBL=@NOPBL, UrutPBL=@UrutPBL, 
		KodeBrg=@KODEBRG, Qnt=@QNT, QNT2=@QNT2, NoSat=@NoSat, Sat_1=@Sat_1, Sat_2=@Sat_2, Isi=@Isi,
		Keterangan=@Keterangan, NOiNS=@NOINS,URUTINS=@UrutINS, harga=@harga
  	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
	delete dbKonsesiDET where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
	if (not exists( select NoBukti from dbKonsesiDET where NoBukti=@NoBukti)) 
	begin
 		delete dbKonsesi where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return






GO

-- Procedure: Sp_Kota
-- Created: 2012-12-17 09:57:07.443 | Modified: 2012-12-17 09:57:07.443
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_Kota]
@mode varchar(1), 
@kodeKota varchar(15),
@namaKota varchar(40),
@kodearea varchar(20)

AS

begin tran

if @mode='I'
begin
    	insert into dbKota (kodeKota, namaKota,kodearea)
    	values(@kodeKota, @namaKota,@kodearea)
   	if @@error <> 0
     	goto Salah
end
if @Mode='U'
begin
     	update dbKota
     	set   namaKota= @namaKota,Kodearea=@kodearea
     	where KodeKota=@KodeKota

     	if @@error <> 0 
      	goto Salah 
end
if @Mode='D'
begin
     	Delete dbKota
     	where KodeKota=@KodeKota
     
    	if @@error <> 0 
     	goto Salah
end


commit tran
return

Salah:
        rollback tran
        return

GO

-- Procedure: Sp_KreditNote
-- Created: 2013-02-21 14:58:49.110 | Modified: 2013-02-22 09:03:23.863
-- =====================================================
CREATE   Procedure [dbo].[Sp_KreditNote]
@Choice varchar(1),
@NoBukti varchar(20),
@Tanggal datetime,
@Keterangan varchar(100),
@Urut int,
@NoInv varchar(20),
@KodeSupp Varchar(15)='',
@Nilai Numeric(18,2),
@KodeVls Varchar(15),
@Kurs Numeric(18,2),
@NilaiRp Numeric(18,2)
As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbKreditNoteDet Where NoBukti=@NoBukti
  if not exists(select * from dbKreditNote Where NoBukti=@NoBukti) 
  begin
    insert into dbKreditNote (NOBUKTI, TANGGAL, KodeSupp)
    values (@NOBUKTI, @TANGGAL, @KodeSupp)
  end
  insert into dbKreditNoteDET (NOBUKTI, URUT,Keterangan,NoInv,Nilai, KodeVLS, Kurs, NilaiRp)
  values(@NOBUKTI, @URUT,@Keterangan,@NoInv,@Nilai,@KodeVls, @Kurs, @NilaiRp)
end
if @Choice='U'
begin
  update dbKreditNoteDET set NoInv=@NoInv,Keterangan=@Keterangan,Nilai=@Nilai, KodeVLS=@KodeVls,Kurs=@Kurs, NilaiRp=@NilaiRp
  where NoBukti=@NoBukti and Urut=@Urut
end

if @Choice='D'
begin
  delete dbKreditNoteDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbKreditNoteDET where NoBukti=@NoBukti)
  begin
    delete dbKreditNote where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return















GO

-- Procedure: sp_LapAktiva
-- Created: 2012-11-05 10:19:51.773 | Modified: 2014-05-13 10:13:37.187
-- =====================================================

CREATE  PROCEDURE [dbo].[sp_LapAktiva]
@bulan int,
@tahun int,
@Divisi varchar(20)
as
Select A.NoMuka GrpPerkiraan, A.GroupAktiva,A.perkiraan, A.Keterangan,C.Perkiraan,
		   A.Devisi, A.Tanggal, A.Quantity, A.Persen,
		   (B.Awal) Awal, (B.MD) MD, (B.MK) MK, (B.Akhir) Akhir, (B.AwalSusut) AwalSusut, 
		   (B.SD) SD, (B.SK) SK, (B.AkhirSusut) Akhirsusut, D.Keterangan NamaPerkiraan,
		   B.Akhir-B.Akhirsusut NilaiAK,A.Biaya, 
		   E.Keterangan NamaBiaya, A.Biaya2, F.Keterangan NamaBiaya2, A.PersenBiaya1, A.PersenBiaya2,
		   Case when A.Biaya not in ('','-') then (B.SK*A.PersenBiaya1)/100 else 0 end nBiayaSK,
		   Case when A.Biaya2 not in ('','-') then (B.SK*A.PersenBiaya2)/100 else 0 end nBiayaSK2,
		   Case when A.Biaya not in ('','-') then (B.SD*A.PersenBiaya1)/100 else 0 end nBiayaSD,
		   Case when A.Biaya2 not in ('','-') then (B.SK*A.PersenBiaya2)/100 else 0 end nBiayaSD2
	From DBAKTIVA A
		  left Outer join  DBAKTIVADET B on B.Perkiraan=A.Perkiraan and B.Devisi=A.Devisi
		  left Outer Join DBPOSTHUTPIUT C on C.Perkiraan=A.NoMuka and C.Kode='AKV'
		  left Outer Join DBPERKIRAAN D on D.Perkiraan=C.Perkiraan and D.Tipe=1
		  left Outer Join DBPERKIRAAN E on E.Perkiraan=A.Biaya and E.Tipe=1
		  left Outer Join DBPERKIRAAN F on F.Perkiraan=A.Biaya2 and F.Tipe=1
	where B.Bulan=@bulan and B.Tahun=@tahun and A.Devisi like @Divisi       
	order by A.Devisi,A.NoMuka, A.Perkiraan

GO

-- Procedure: sp_LapArusKasDetail
-- Created: 2024-04-01 11:46:52.513 | Modified: 2024-07-03 23:23:28.640
-- =====================================================

CREATE PROCEDURE [dbo].[sp_LapArusKasDetail]
--declare
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=3,@Tahun=2018;
AS
select KodeAK,KodeSAK,Keterangan ketsak,Bulan,Tahun,Devisi, Perkiraan,Keterangan,Urutan ,NULL nilai,'' nobukti,'' ketnobukti,Nilai  nilairekap,ketperkiraan 
from TblLapArusKasDetail(@bulan,@Tahun,'01')
union all
select b.KodeAK,b.KodeSAK,b.KetNeraca  ketsak,x.bulan,x.tahun ,x.devisi,x.Perkiraan,''keterangan,urutan  ,Debet  ,NoBukti ,ketnobukti 
,0  nilairekap  ,'' ketperkiraan
from
(
select KodeAK ,KodeSAK ,'' ketsak,
MONTH(Tanggal )bulan,YEAR (Tanggal )tahun,'01' devisi,
--Perkiraan, a.lawan,
     (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) 
        then  a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,
--case when  dbo.SaldoNormalPerkiraan(perkiraan)=0 then Debet else -1*Debet end 
10 urutan,Debet, NoBukti, Keterangan  ketnobukti
  from dbTransaksi a
where YEAR (Tanggal )=@Tahun  and MONTH (Tanggal )=@bulan 
and (Perkiraan in (select Perkiraan  from TblLapArusKasDetail(@bulan ,@Tahun ,'01'))
or Lawan in (select Perkiraan  from TblLapArusKasDetail(@bulan ,@Tahun ,'01')
))
and NoBukti not like 'm.%'  
)  x
left outer join DBPERKIRAAN b on b.Perkiraan =x.Perkiraan
left outer join DBArusKasDet c on c.KodeSubAK =b.KodeSAK 
order by kodesak,Perkiraan 
GO

-- Procedure: sp_LapArusKasPeriode
-- Created: 2023-03-08 16:42:29.393 | Modified: 2023-03-08 16:42:29.393
-- =====================================================


CREATE PROCEDURE [dbo].[sp_LapArusKasPeriode]
--declare
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=11,@Tahun=2019
AS
--declare @Devisi Varchar(15)
Set @Devisi=Case when @Devisi in ('-','') then '%' else @Devisi end;
  
With ArusKas (KodeAK,KodeSAK,bulan,tahun,Nilai) AS
(  
    select KodeAK,KodeSAK,Bulan,Tahun,sum(Nilai) Nilai from (    
	   select a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK<>'SAK08'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	   
	   union all
	   
       select 'AK01','SAK08-',b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end)*-1  as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK='SAK08'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	   
	   union all
	   
       select 'AK01','SAK08+',b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	)  as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK='SAK08' and a.Perkiraan<>'1561.1'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	   
	   union all
	   
       select 'AK01','SAK08-',b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	)  as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK='SAK08' and a.Perkiraan='1561.1'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	) Z group by KodeAK,KodeSAK,Bulan,Tahun   
)

select a.KodeAK,a.KodeSAK,a.Tipe,a.Keterangan,a.Nomor,a.Urutan,sum(isnull(b.Nilai,0)) NilaiLalu,sum(isnull(c.Nilai,0)) Nilai,sum(isnull(d.Nilai,0)) AKMNilai
 from DBArusKasKonfig a
 left outer join (select KodeAK,KodeSAK,Nilai from ArusKas where bulan=(@bulan-1) and tahun=@Tahun) b on b.KodeAK=a.KodeAK and b.KodeSAK=a.KodeSAK
 left outer join (select KodeAK,KodeSAK,Nilai from ArusKas where bulan=@bulan and tahun=@Tahun) c on c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK 
 left outer join (select KodeAK,KodeSAK,sum(Nilai) Nilai 
                  from ArusKas where bulan<=@bulan and tahun=@Tahun group by KodeAK,KodeSAK ) d on d.KodeAK=a.KodeAK and d.KodeSAK=a.KodeSAK 
 group by a.KodeAK,a.KodeSAK,a.Tipe,a.Keterangan,a.Nomor,a.Urutan
 order by Nomor


GO

-- Procedure: sp_LapArusKasRekap
-- Created: 2024-07-03 19:08:03.847 | Modified: 2024-10-08 16:05:03.610
-- =====================================================

CREATE PROCEDURE [dbo].[sp_LapArusKasRekap]
--declare
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=3,@Tahun=2018;
AS

--declare @bulan int=1,@akr int=1,@Tahun int=2024,@Devisi Varchar(15)='01'
--select @Devisi='01',@bulan=3,@Tahun=2018;
--AS
select * from
( 
    select a.KodeAK,a.KodeSAK,c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai 
	    from DBPERKIRAAN a
           left outer join 
       (
     select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) 
        then  a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then 0 end) as Nilai,
		            kodecost,t.Devisi ,JnsTransInvestasi
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) 
		--and (a.Devisi like @Devisi) --and isnull(ispasang,0)=0--and (a.Perkiraan ='2901' or a.Lawan  ='2901' )
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK
	   where b.Perkiraan is not null and A.KodeSAK not in ('SAK05','SAK06')
	   and  devisi like @devisi and ISNULL (JnsTransInvestasi,0) <>1
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,devisi,JnsTransInvestasi,C.Keterangan  ,a.Perkiraan,A.Keterangan ,Urutan 
union all
    select 'AK01',	'SAK01',c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai 
	    from DBPERKIRAAN a
           left outer join 
       (
     select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) 
        then  a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) and kredit<>0 then 0 end) as Nilai,
		            kodecost,t.Devisi ,JnsTransInvestasi
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) 
		--and (a.Devisi like @Devisi) --and isnull(ispasang,0)=0--and (a.Perkiraan ='2901' or a.Lawan  ='2901' )
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK','IVT')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK
	   where b.Perkiraan is not null and A.KodeSAK not in ('SAK05','SAK06')
	   and  devisi like @devisi and ISNULL (JnsTransInvestasi,0) =1
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,devisi,JnsTransInvestasi,C.Keterangan  ,a.Perkiraan,A.Keterangan ,Urutan 	   
       union all
           select 'AK01','SAK05+',c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai 
	    from DBPERKIRAAN a
           left outer join 
       (
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
	   left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK
 	    
 	    where a.KodeSAK in ('SAK06')
 	    group by Bulan ,Tahun ,Devisi,a.Keterangan ,a.Perkiraan ,c.Keterangan ,Urutan		
 	    
Union all
           select --'C'Tanda, 
           'AK01','SAK05+',c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai 

         from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK
 	    where a.KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode not in ('IVT'))) )
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan ,a.Perkiraan ,c.Keterangan,Urutan	 	           
       union all
	    select --'D'Tanda,
	    'AK01','SAK05-',c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK

 	    where a.KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan not like '1103010' 
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan ,c.Keterangan,Urutan  --,b.Perkiraan 	 	           
 	    
      union all
	    select --'D1'Tanda,
	    'AK01','SAK05-',c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
		    --or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
		)
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK
 	    where a.KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan  like '1103010' 
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan  ,c.Keterangan,Urutan 
       union all
	    select --'D2'Tanda,
	    'AK01','SAK05+',c.Keterangan ketsak,b.Bulan,b.Tahun,Devisi, a.Perkiraan,a.Keterangan,Urutan   
	    ,sum(cast (b.Nilai as numeric(18,0))) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    ( -- (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    left outer join DBArusKasKonfig c on  c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK
 	    where a.KodeSAK in ('SAK05') and b.Bulan is not null 
 	    and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan  like '1103010' 
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan,c.Keterangan,Urutan  -- ,b.Perkiraan 
	   union 
	   
	   	   select --'F' Tanda,
	   	   'AK01','SAK05+','' ketsak,@bulan ,@Tahun ,@Devisi,'','','', 
	   	   SUM(CAST (-1*(sd-awalpasar)as numeric (18,0)))/* -1*SPI  */ from DBINVESTASIDET 
	   where Perkiraan like '1101000%' and Bulan=@bulan and Tahun =@Tahun  	
	    having sum(SD)>sum(AwalPasar)   
	   
	   union 
	   
	   	   select --'F' Tanda,
	   	   'AK01','SAK05-','' ketsak,@bulan ,@Tahun ,@Devisi,'','','', 
	   	   SUM(CAST (-1*(sd-awalpasar)as numeric (18,0)))/* -1*SPI  */ from DBINVESTASIDET 
	   where Perkiraan like '1101000%' and Bulan=@bulan and Tahun =@Tahun  
	    having sum(SD)<sum(AwalPasar)   	   
	   
      union all
	    select --'G' Tanda,
	    'AK02',KodeSAK+'+','',b.Bulan,b.Tahun,Devisi,'','', '',
	    sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
		    --or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
		)
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK09','SAK10','SAK11','SAK12') and b.Bulan is not null 
 	    /*and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan  like '1103010'*/ 
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan,a.KodeSAK  	 	           

       union all
	    select --'G1'Tanda,
	    'AK02',KodeSAK+'-','',b.Bulan,b.Tahun,Devisi,'','','',
	    sum(b.Nilai) Nilai from DBPERKIRAAN a
 	    left outer join 
 	    ( 	    
select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) 
                    then  a.Lawan
	                when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then --'2901'
	          a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
		    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai,
		t.Devisi ,t.TipeTransHd
		     from dbTrans t 
		     left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		     where (month(t.tanggal)=@bulan and year(t.tanggal)=@tahun) and  
		    ( -- (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or 
		(a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) ))
		--and KODECOST <>'' 
		and tipetranshd <>'BMM' -- and a.NoBukti like '%41%'
		)
		 	    
 	    B on b.Perkiraan=a.Perkiraan
 	    where KodeSAK in ('SAK09','SAK10','SAK11','SAK12') and b.Bulan is not null 
 	    /*and  	     (  (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode  in ('IVT'))) )
 	    and a.Perkiraan  like '1103010' */
 	    group by Bulan ,Tahun ,Devisi ,a.Perkiraan,a.Keterangan,a.KodeSAK  -- ,b.Perkiraan 	 	           
 	           
 	    	 	           
 ) z	  where z.Bulan =@bulan and Tahun =@Tahun and z.Devisi =@Devisi  	 	           

order by z.KodeSAK 

GO

-- Procedure: sp_LapArusKasSaldoAwal
-- Created: 2023-03-08 16:43:11.603 | Modified: 2024-08-10 12:37:29.387
-- =====================================================


CREATE PROCEDURE [dbo].[sp_LapArusKasSaldoAwal]
--declare
@bulan int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=2,@Tahun=2018
AS

select sum(b.nilai) SALalu,sum(c.nilai) SAini,sum(d.nilai) AKMSA
from DBPERKIRAAN a
left outer join 
(select a.Perkiraan ,case when b.DK=0 then isnull(AwalDRp,0)
                                    else isnull(AwalKRp,0) end nilai
 from dbNeraca a
    left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
    where a.Bulan=@bulan-1 and a.Tahun=@Tahun 
    and b.Perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK') and ISNULL (IsInvestasi ,0)=0) and (devisi like @Devisi)
 ) b on b.Perkiraan=a.Perkiraan
 left outer join 
(select a.Perkiraan ,case when b.DK=0 then isnull(AwalDRp,0)
                                    else isnull(AwalKRp,0) end nilai
 from dbNeraca a
    left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
    where a.Bulan=@bulan and a.Tahun=@Tahun 
    and b.Perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK') and ISNULL (IsInvestasi ,0)=0) and (devisi like @Devisi)
 ) c on c.Perkiraan=a.Perkiraan
 left outer join 
(select a.Perkiraan ,sum(case when b.DK=0 then isnull(AwalDRp,0)
                                    else isnull(AwalKRp,0) end) nilai
 from dbNeraca a
    left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
    where a.Bulan=1 and a.Tahun=@Tahun 
    and b.Perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK') and ISNULL (IsInvestasi ,0)=0) and (devisi like @Devisi)
    group by a.Perkiraan
 ) d on d.Perkiraan=a.Perkiraan
 where a.Perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))
--select *
--from DBPERKIRAAN a
--  left outer join 
      
    
    --select * from DBNERACA where Bulan=2 and Tahun=2018


GO

-- Procedure: SP_LapAsetNeto
-- Created: 2024-01-23 21:06:50.757 | Modified: 2024-09-11 13:43:42.397
-- =====================================================
CREATE PROCEDURE [dbo].[SP_LapAsetNeto]
@divisi varchar(10),
@bulan int,
@tahun int
as

/*Set @divisi=Case when @divisi in ('-','') then '%' else @divisi end
Select Case when Left(A.Neraca,2)='A1' then 'AKTIVA LANCAR'
            when Left(A.Neraca,2)='A2' then 'AKTIVA TETAP'
            when Left(A.Neraca,2)='A3' then 'AKTIVA LAIN-LAIN' 
            when Left(A.Neraca,2)='P1' then 'KEWAJIBAN LANCAR'
            when Left(A.Neraca,2)='P2' then 'KEWAJIBAN TIDAK LANCAR'
            when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Grup, A.Keterangan, A.Perkiraan,
       a.Keterangan, A.Tipe, a.DK,
       Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end BulanIni, B.Devisi 
from dbPerkiraan a
     left outer join dbNeraca b on b.Perkiraan=a.Perkiraan
where b.Bulan=@bulan and b.Tahun=@tahun and Left(A.Neraca,2)<>'' and 
      B.Devisi like @divisi and 
      Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end<>0 
Order by Left(A.Neraca,2),A.Perkiraan*/
Set @divisi=Case when @divisi in ('-','') then '%' else @divisi end
/*select Grup ,Jumlah ,Keterangan ,Tipe ,DK ,max(BulanIni )bulanini,Devisi ,perkiraan 
,max(case when jumlah ='+' then BulanIni else -1*BulanIni  end )jmlbulanini
 from
(
Select Case when Left(A.Neraca,2)='A1' then 'INVESTASI'
            when Left(A.Neraca,2)='A2' then 'SELISIH NILAI KINI AKTUARIAL'
            when Left(A.Neraca,2)='A3' then 'ASET LANCAR DI LUAR INVESTASI' 
            when Left(A.Neraca,2)='A4' then 'ASET OPERASIONAL'
            when Left(A.Neraca,2)='A5' then 'ASET LAIN-LAIN'
            when Left(A.Neraca,2)='P1' then 'NILAI AKTUARIA'
            when Left(A.Neraca,2)='P2' then 'LIABILITAS DILUAR NILAI KINI AKTUARIA'
            --when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Grup, 
       Case when Left(A.Neraca,2)='A1' then '+'
            when Left(A.Neraca,2)='A2' then '+'
            when Left(A.Neraca,2)='A3' then '+' 
            when Left(A.Neraca,2)='A4' then '+'
            when Left(A.Neraca,2)='A5' then '+'
            when Left(A.Neraca,2)='P1' then '-'
            when Left(A.Neraca,2)='P2' then '-'
            --when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Jumlah,
       --A.Keterangan, --A.Perkiraan,
       d.Keterangan, A.Tipe, a.DK,
      /* Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end BulanIni*/
              Case when a.tipe=1 and A.kelompok=0 
              and case when c.perkiraan is null then ''  else c.perkiraan end=''
              then b.AkhirDRp-b.AkhirKRp else
       case when a.tipe=1 and a.kelompok<>0 and a.IsNonLedger =0 and case when c.perkiraan is null then ''  else c.perkiraan end='' 
       then b.AkhirKRp-b.AkhirDRp 
       else
       --null 
       c.Nilaipasar
       end
       end BulanIni
       , B.Devisi ,case when c.perkiraan is null then a.Perkiraan  else c.perkiraan  end perkiraan
       
       --,c.perkiraan ,a.Perkiraan 
from dbPerkiraan a
     left outer join dbNeraca b on b.Perkiraan=a.Perkiraan and Bulan=@bulan 
     and Tahun=@tahun and  B.Devisi like @divisi 
     left outer join ( 
     select NoMuka perkiraan, SUM(b.SD ) Nilaipasar from DBINVESTASI a 
     left outer join DBINVESTASIDET  b on b.Perkiraan   =a.Perkiraan 
     group by NoMuka 
     ) c on left(c.perkiraan,4) =left(a.Perkiraan,4)--c on c.perkiraan =a.Perkiraan 
     left outer join DBPERKIRAAN d on d.Perkiraan=
     case when c.perkiraan is null then a.Perkiraan  else c.perkiraan  end
      
where 
       Left(A.Neraca,2)<>'' and Left(A.Neraca,2) <>'A2' and Left(A.Neraca,2) <>'P1'
       --and Left(A.Neraca,2) <>'A4'
       and  (((b.AkhirDRp-b.AkhirKRp)<>0 and a.Tipe=1) or a.Tipe=0)
       --and a.IsNonLedger=0
)x
group by Grup ,Keterangan ,Tipe ,DK,Devisi ,perkiraan,Jumlah 
Order by --Left(A.Neraca,2),
x.Perkiraan
*/
 select case when Jumlah ='+' then 'Aset Tersedia' else 'Pasiva' end groupneraca,Grup ,Jumlah ,Keterangan ,Tipe ,DK ,
 max(BulanIni )bulanini, max(bulanlalu )bulanlalu,Devisi ,perkiraan 
,max(case when jumlah ='+' then BulanIni else -1*BulanIni  end )jmlbulanini
 from
(
Select Case when Left(A.Neraca,2)='A1' then 'INVESTASI'
            when Left(A.Neraca,2)='A2' then 'SELISIH NILAI KINI AKTUARIAL'
            when Left(A.Neraca,2)='A3' then 'ASET LANCAR DI LUAR INVESTASI' 
            when Left(A.Neraca,2)='A4' then 'ASET OPERASIONAL'
            when Left(A.Neraca,2)='A5' then 'ASET LAIN-LAIN'
            when Left(A.Neraca,2)='P1' then 'NILAI AKTUARIA'
            when Left(A.Neraca,2)='P2' then 'LIABILITAS DILUAR NILAI KINI AKTUARIA'
            --when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Grup, 
       Case when Left(A.Neraca,2)='A1' then '+'
            when Left(A.Neraca,2)='A2' then '+'
            when Left(A.Neraca,2)='A3' then '+' 
            when Left(A.Neraca,2)='A4' then '+'
            when Left(A.Neraca,2)='A5' then '+'
            when Left(A.Neraca,2)='P1' then '-'
            when Left(A.Neraca,2)='P2' then '-'
            --when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Jumlah, b.nilaibulanini bulanini,c.nilaibulanini bulanlalu,
       a.Keterangan, Tipe, DK,b.devisi,Perkiraan 
       from dbPerkiraan a
       left outer join dbo.JumlahAsetNeto(@bulan ,@tahun ,@divisi) b on b.perkiraang=a.Perkiraan
       left outer join dbo.JumlahAsetNeto(@bulan-1 ,@tahun ,@divisi) c on c.perkiraang=a.Perkiraan 
       where (Left(A.Neraca,2)<>'' or Left(A.Neraca,2) <>'  '  ) and Left(A.Neraca,2) <>'A2' 
       and Left(A.Neraca,2) <>'P1'
       )x
       where bulanini is not null --and
       group by Grup ,Keterangan ,Tipe ,DK,Devisi ,perkiraan,Jumlah 
Order by x.Perkiraan

GO

-- Procedure: Sp_LapBiaya
-- Created: 2011-03-03 13:17:48.853 | Modified: 2011-03-03 13:17:48.853
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_LapBiaya]
@devisi varchar(15),
@bulan int,
@tahun int,
@pkraw varchar(20),
@pkrak varchar(20)
as
if @devisi = '-'
begin
  select substring(a.Perkiraan,1,2)as Kira, a.perkiraan, a.keterangan, a.tipe,
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
  from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=(case  @Bulan when 1 then 12 else (@bulan-1) end) 
      and b.tahun=(case @bulan when 1 then @tahun-1 else @tahun end )),0) as BulanLalu,
 case when 
  isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
   from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun  ),0)<> 0 then
   ((isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
    from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=@Bulan and b.tahun=@tahun ),0)-
   isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
    from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun),0))
   /
   isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
    from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun),0))*100
 else 0 end as Persen,
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
 from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=@Bulan and b.tahun=@tahun ),0) as BulanKini,
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
  from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun  ),0)+
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
 from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=@Bulan and b.tahun=@tahun  ),0) as sdBulanini
  from dbperkiraan A
  where a.perkiraan>=@pkraw and a.perkiraan<=@pkrak
  order by a.perkiraan
end else
begin
  select substring(a.Perkiraan,1,2)as Kira, a.perkiraan, a.keterangan, a.tipe,
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
  from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=(case  @Bulan when 1 then 12 else (@bulan-1) end) 
      and b.tahun=(case @bulan when 1 then @tahun-1 else @tahun end )  and b.devisi=@devisi),0) as BulanLalu,
 case when 
  isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
   from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0)<> 0 then
   ((isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
    from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0)-
   isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
    from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0))
   /
   isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
    from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0))*100
 else 0 end as Persen,
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
 from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0) as BulanKini,
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
  from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan<@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0)+
 isnull((select sum(isnull(b.MDRp,0)-isnull(b.MKRp,0)+isnull(b.JPDRp,0)-isnull(b.JPKRp,0))
 from dbNeraca b where a.perkiraan=b.perkiraan and b.bulan=@Bulan and b.tahun=@tahun  and b.devisi=@devisi),0) as sdBulanini
  from dbperkiraan A
  where a.perkiraan>=@pkraw and a.perkiraan<=@pkrak
  order by a.perkiraan
end





GO

-- Procedure: Sp_LapBiayabulan
-- Created: 2012-11-05 10:19:51.650 | Modified: 2012-11-05 10:19:51.650
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_LapBiayabulan]
@devisi varchar(15),
@tahun int,
@pkraw varchar(20),
@pkrak varchar(20)
--select @devisi='01',@bulan=9,@tahun=2010,@pkraw=154,@pkrak=55
as
Select substring(a.Perkiraan,1,2)as Kira, a.perkiraan, a.keterangan, a.tipe,
       Sum(Case when B.Bulan=1 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Jan,
       Sum(Case when B.Bulan=2 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Feb,
       Sum(Case when B.Bulan=3 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Mar,
       Sum(Case when B.Bulan=4 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) April,
       Sum(Case when B.Bulan=5 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Mei,
       Sum(Case when B.Bulan=6 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Jun,
       Sum(Case when B.Bulan=7 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Jul,
       Sum(Case when B.Bulan=8 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Aug,
       Sum(Case when B.Bulan=9 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                         when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                         else 0
                                    end
                else 0 
           end) Sept,
       Sum(Case when B.Bulan=10 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                          when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                          else 0
                                     end
                else 0 
           end) Okt, 
       Sum(Case when B.Bulan=11 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                          when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                          else 0
                                     end
                else 0 
           end) Nov,
       Sum(Case when B.Bulan=12 then Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                                          when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                                          else 0
                                     end
                else 0 
           end) 'Des',
       Sum(Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                else 0
           end) 'Total'
From DBPERKIRAAN A
     left Outer join DBNERACA B on B.Perkiraan=A.Perkiraan
where (Devisi=@devisi Or Case when @devisi IN('','-') then 1 else 0 end=1)and b.Tahun=@tahun
Group by substring(a.Perkiraan,1,2), a.perkiraan, a.keterangan, a.tipe
Order by Perkiraan



GO

-- Procedure: Sp_LapBiayatahun
-- Created: 2012-11-05 10:19:51.667 | Modified: 2012-11-05 10:19:51.667
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_LapBiayatahun]
@devisi varchar(15),
@tahun int,
@pkraw varchar(20),
@pkrak varchar(20)

--select @devisi='-',@bulan=9,@tahun=2011,@pkraw=154,@pkrak=55
as

Declare @BiayaTahunLalu Table (Perkiraan varchar(50) Primary Key, Saldo numeric(18,2))
Insert @BiayaTahunLalu(Perkiraan,Saldo)
Select a.Perkiraan, 
       Sum(Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                else 0
           end) Saldo   
From DBPERKIRAAN a
     left Outer join DBNERACA b on b.Perkiraan=a.Perkiraan
where (Devisi=@devisi Or Case when @devisi IN('','-') then 1 else 2 end=1)and b.Tahun=@tahun-1
Group by a.Perkiraan

Declare @BiayaTahunIni Table (Perkiraan varchar(50) Primary Key, Saldo numeric(18,2))
Insert @BiayaTahunIni(Perkiraan,Saldo)
Select a.Perkiraan, 
       Sum(Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                else 0
           end) Saldo   
From DBPERKIRAAN a
     left Outer join DBNERACA b on b.Perkiraan=a.Perkiraan
where (Devisi=@devisi Or Case when @devisi IN('','-') then 1 else 2 end=1)and b.Tahun=@tahun
Group by a.Perkiraan

Declare @BiayaSdTahunIni Table (Perkiraan varchar(50) Primary Key, Saldo numeric(18,2))
Insert @BiayaSdTahunIni(Perkiraan,Saldo)
Select a.Perkiraan, 
       Sum(Case when a.DK=0 then isnull(b.MD,0)-isnull(b.MK,0)+ISNULL(b.JPD,0)-ISNULL(b.JPK,0)
                when a.DK=1 then isnull(b.MK,0)-isnull(b.MD,0)+ISNULL(b.JPK,0)-ISNULL(b.JPD,0)
                else 0
           end) Saldo   
From DBPERKIRAAN a
     left Outer join DBNERACA b on b.Perkiraan=a.Perkiraan
where (Devisi=@devisi Or Case when @devisi IN('','-') then 1 else 0 end=1)and b.Tahun<=@tahun
Group by a.Perkiraan

Select substring(a.Perkiraan,1,2)as Kira, a.perkiraan, a.keterangan, a.tipe,
       isnull(b.Saldo,0) TahunLalu,
       Case when isnull(c.Saldo,0)<>0 then isnull(b.Saldo,0)/isnull(c.Saldo,0) else 0 end*100 Persen,
       isnull(c.Saldo,0) TahunKini, isnull(d.Saldo,0) sdTahunIni
From DBPERKIRAAN a
     left Outer join @BiayaTahunLalu b on b.Perkiraan=a.Perkiraan
     left Outer join @BiayaTahunIni c on c.Perkiraan=a.Perkiraan
     left Outer join @BiayaSdTahunIni d on d.Perkiraan=a.Perkiraan
Order by a.Perkiraan



GO

-- Procedure: Sp_LapDeposito
-- Created: 2011-12-09 11:07:39.553 | Modified: 2011-12-09 11:10:48.067
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_LapDeposito]
@Masuk varchar(1)='',
@Divisi varchar(10)='',
@Perkiraan varchar(20)='',
@TglAw datetime=null,
@TglAk datetime=null
as
Set @Perkiraan=case when @Perkiraan in ('-','') then '%' else @Perkiraan end
if @Masuk='1'
begin
   select  a.Bank, a.NoDeposito, a.TglJatuhTempo,
           A.Debet,A.DebetRp, 
           A.Kredit,a.KreditRp,
           a.Keterangan, a.TglBuka, a.BuktiBuka,a.TglCair, a.BuktiCair,
           a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
   from DBDEPOSITO a
   where a.TglJatuhTempo>=@TglAw and a.TglJatuhTempo<=@TglAk and (a.Debet*a.Kurs)<>(a.Kredit*a.Kurs) and a.Tipe='PT' and a.Bank like @Perkiraan  
end else
if @Masuk='2'
begin 
    select  a.Bank, a.NoDeposito, a.TglJatuhTempo,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,  a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
            a.Kurs, a.Jumlah, A.Kodevls, @Masuk JenisLap
    from DBDEPOSITO a
    where a.Bank=@Perkiraan and (a.Tglcair is not null and (a.tglcair between @TglAw and @TglAk))
 
end
if @Masuk='3'
begin   
   select  a.Bank, a.NoDeposito, a.TglJatuhTempo,            
           A.Debet,A.DebetRp, 
           A.Kredit,a.KreditRp,
           a.Keterangan, a.TglBuka, a.BuktiBuka, 
           (case when a.Tglcair is null or tglcair>@TglAw then null else a.TglCair end)as TglCair,
           (case when a.Tglcair is null or tglcair>@TglAw then null else a.BuktiCair end)as BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
   from DBDEPOSITO a
   where  a.TglBuka between @TglAw and @tglAk and a.Tipe='PT' and a.Bank like @Perkiraan  
end else
if @Masuk='4'
begin 
    select  a.Bank, a.NoDeposito, a.TglJatuhTempo,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
    from DBDEPOSITO a
    where a.TglCair>@TglAw and a.TglCair<=@TglAk and a.Tipe='PT' and a.Bank like @Perkiraan  
 
end
if @Masuk='5'
begin
  Select a.TglBuka Tanggal,a.BuktiBuka Nobukti,b.Keterangan,a.Bank,'' NoAcc,a.NoDeposito,a.TglJatuhTempo,
         a.Debet,0 kredit,a.Debet Saldo,1 Urut, @Masuk JenisLap
  from DBDEPOSITO a
  left Outer join dbtransaksi b on b.nobukti=a.buktibuka and b.Urut=a.UrutBuktiBuka
  Where a.BuktiBuka<>'' and month(a.tglbuka)=Month(@TglAw) and year(a.tglBuka)=year(@tglaw) and a.debet<>0 and a.Tipe='PT' and a.Bank like @Perkiraan  
  union
  Select a.TglCair,a.BuktiCair,b.Keterangan,a.Bank,''NoAcc,a.NoDeposito,a.TglJatuhTempo,
         0 debet,a.Kredit,a.Kredit*-1 Saldo,2 urut, @Masuk JenisLap
  from DBDEPOSITO a
  left Outer join dbtransaksi b on b.nobukti=a.bukticair and b.Urut=a.UrutBuktiCair

  Where a.BuktiCair<>'' and month(a.tglCair)=Month(@Tglaw) and year(a.tglcair)=year(@tglaw) and a.kredit<>0 and a.Tipe='PT' and a.Bank like @Perkiraan  
  union
  Select null,'','Saldo awal','','','',null,0,0,Sum(debet) Saldo,0 urut, @Masuk JenisLap
  From DBDEPOSITO a 
  where (Month(Tglbuka)<Month(@tglaw) and year(tglBuka)<=year(@tglaw))and 
        ((Kredit=0)or (Month(TglCair)>=Month(@tglaw) and year(tglcair)>=year(@tglaw))) and a.Tipe='PT' and a.Bank like @Perkiraan  
  Order by urut,Tanggal,Nobukti
end



GO

-- Procedure: Sp_LapGiroHutang
-- Created: 2012-11-05 10:19:51.823 | Modified: 2012-11-05 10:19:51.823
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_LapGiroHutang]
@Masuk varchar(1),
@Divisi varchar(10),
@Perkiraan varchar(20),
@TglAw datetime,
@TglAk datetime
as

Set @Perkiraan=case when @Perkiraan in ('-','') then '%' else @Perkiraan end
if @masuk='1'
begin  
  select  a.Bank, a.NoGiro, a.TglGiro, 
          A.Debet,A.DebetRp, 
          A.Kredit,a.KreditRp,
          a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair, a.Kurs, a.Jumlah,
          a.Kodevls, @Masuk JenisLap
  from dbgiro a
  where (a.TglGiro between @TglAw and @TglAk) and  A.Tipe='HT' and a.Bank like @Perkiraan  
end else
if @masuk='2'
begin
  select a.Bank, a.NoGiro, a.TglGiro,A.Debet,A.DebetRp, 
          A.Kredit,a.KreditRp,
          a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair, a.Kurs, a.Jumlah,
          a.Kodevls, @Masuk JenisLap
  from dbgiro a
  where a.Bank like @Perkiraan and a.TglBuka>=@TglAw and a.TglBuka<=@TglAk and A.Tipe='HT' 
end
if @masuk='3'
begin
  select  a.Bank, a.NoGiro, a.TglGiro,
          A.Debet,A.DebetRp, 
          A.Kredit,a.KreditRp,
          a.Keterangan, a.TglBuka, a.BuktiBuka,
         a.TglCair,
         a.BuktiCair,
         a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
   from dbgiro a
   where (a.Tglcair is null or TglCair>@TglAk) and a.TglBuka<=@TglAk
  and a.bank like @Perkiraan  and A.Tipe='HT'
end else
if @masuk='4'
begin
  select  a.Bank, a.NoGiro, a.TglGiro, 
          A.Debet,A.DebetRp, 
          A.Kredit,a.KreditRp,
          a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
          a.Kurs, a.Jumlah, A.Kodevls, @Masuk JenisLap
  from dbgiro a
 
  where a.Bank like @Perkiraan and (a.TglCair between @TglAw and @TglAk) and A.Tipe='HT'   
end


GO

-- Procedure: sp_LapGiroPiutang
-- Created: 2012-11-05 10:19:51.837 | Modified: 2015-03-09 15:32:12.760
-- =====================================================


CREATE PROCEDURE [dbo].[sp_LapGiroPiutang]
@Masuk varchar(1),
@Divisi varchar(10),
@Perkiraan varchar(20),
@TglAw datetime,
@TglAk datetime,
@tolak integer,
@SelectSemua bit,
@KDreport Varchar(10),
@IdUser varchar(10)


as
declare @Periode varchar(8),@Periode1 varchar(8),@bulan int,@tahun int, @hari int
select @bulan  = Month(@Tglaw), @tahun  =year(@tglaw), @hari =day(@tglaw)
Set @Periode=CAST(@tahun as varchar(4))+
Case when @bulan<10 then '0' else '' end+CAST(@bulan as varchar(2))+Case when @hari<10 then '0' else '' end+CAST(@hari as varchar(2))
Set @Periode1=CAST(year(@tglak)as varchar(4))+
Case when month(@tglak)<10 then '0' else '' end+CAST(month(@tglak) as varchar(2))+Case when day(@tglak)<10 then '0' else '' end+CAST(day(@tglak) as varchar(2))


Set @Perkiraan=case when @Perkiraan in ('-','') then '%' else @Perkiraan end


IF @SelectSemua=1
begin

if @Masuk='1'
begin
	if @tolak=1
	   begin
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		where	a.Tipe='PT' and (a.TglGiro between @TglAw and @TglAk) and a.Kas like @Perkiraan  
	    and A.NoGiro like '%T'
	   end
	else if @tolak=2
	   begin
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		where	a.Tipe='PT' and (a.TglGiro between @TglAw and @TglAk) and a.Kas like @Perkiraan  
	    and A.NoGiro not like '%T'
	   end
	else if @tolak=3
	   begin
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		where	a.Tipe='PT' and (a.TglGiro between @TglAw and @TglAk) and a.Kas like @Perkiraan  
	   end
	
end else
if @Masuk='2'
begin
	if @tolak=1
	begin  
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		where	a.Tipe='PT' and a.TglCair is not null 
		and a.TglCair>=@TglAw and a.TglCair<=@TglAk and a.Kas like @Perkiraan 
		and A.NoGiro like '%T' 
	End	
	else if @tolak=2
	begin  
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		where	a.Tipe='PT' and a.TglCair is not null 
		and a.TglCair>=@TglAw and a.TglCair<=@TglAk and a.Kas like @Perkiraan 
		and A.NoGiro not like '%T' 
	End	
	else if @tolak=3
	begin  
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		where	a.Tipe='PT' and a.TglCair is not null 
		and a.TglCair>=@TglAw and a.TglCair<=@TglAk and a.Kas like @Perkiraan 
	End	
end
if @Masuk='3'
begin
	if @tolak=1
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
             a.Keterangan, a.TglBuka, a.BuktiBuka, 
            a.TglCair,
            a.BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
			from dbgiro a
			where  (a.TglBuka between @TglAw and @tglAk) and a.Tipe='PT' and a.Kas like @Perkiraan  
			and A.NoGiro like '%T' 
	   end
	else if @tolak=2
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
             a.Keterangan, a.TglBuka, a.BuktiBuka, 
            a.TglCair,
            a.BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
			from dbgiro a
			where  (a.TglBuka between @TglAw and @tglAk) and a.Tipe='PT' and a.Kas like @Perkiraan  
			and A.NoGiro not like '%T' 
	   end
	 else if @tolak=3
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
             a.Keterangan, a.TglBuka, a.BuktiBuka, 
            a.TglCair,
            a.BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
			from dbgiro a
			where  (a.TglBuka between @TglAw and @tglAk) and a.Tipe='PT' and a.Kas like @Perkiraan  
			
	   end
end else
if @Masuk='4'
begin 
	if @tolak=1
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
			from dbgiro a
			where A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) and a.Tipe='PT' and a.Kas like @Perkiraan  
			and A.NoGiro like '%T' 
		End
	else if @tolak=2
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
			from dbgiro a
			where A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) and a.Tipe='PT' and a.Kas like @Perkiraan  
			and A.NoGiro not like '%T' 
		End
	else if @tolak=3
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
			from dbgiro a
			where A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) and a.Tipe='PT' and a.Kas like @Perkiraan  
		End
 
end
if @Masuk='5'
begin
  Select a.TglBuka Tanggal,a.BuktiBuka Nobukti,b.Keterangan,a.Bank,'' NoAcc,a.NoGiro,a.TglGiro,
         a.DebetRp Debet,0 kredit,a.DebetRp Saldo,1 Urut, @Masuk JenisLap
  from dbgiro a
  left Outer join dbtransaksi b on b.nobukti=a.buktibuka and b.Urut=a.UrutBuktiBuka
  Where a.BuktiBuka<>'' and month(a.tglbuka)=Month(@TglAw) and year(a.tglBuka)=year(@tglaw) and a.DebetRp<>0 and a.Tipe='PT' and a.Bank like @Perkiraan  
  union all
  Select a.TglCair,a.BuktiCair,b.Keterangan,a.Bank,''NoAcc,a.NoGiro,a.TglGiro,
         0 debet, a.KreditRp Kredit, a.KreditRp*-1 Saldo,2 urut, @Masuk JenisLap
  from dbgiro a
  left Outer join dbtransaksi b on b.nobukti=a.bukticair and b.Urut=a.UrutBuktiCair
  Where a.BuktiCair<>'' and month(a.tglCair)=Month(@Tglaw) and year(a.tglcair)=year(@tglaw) and a.kreditRp<>0 and a.Tipe='PT' and a.Bank like @Perkiraan  
  union all
  Select null,'','Saldo awal','','','',null,0,0, Sum(debetRp) Saldo,0 urut, @Masuk JenisLap
  From dbgiro a 
  where (Month(Tglbuka)<Month(@tglaw) and year(tglBuka)<=year(@tglaw)) and 
        ((KreditRp=0) or (Month(TglCair)>=Month(@tglaw) and year(tglcair)>=year(@tglaw))) and a.Tipe='PT' and a.Bank like @Perkiraan  
  Order by urut,Tanggal,Nobukti
end

End
Else
Begin

 if @Masuk='1'
begin
	if @tolak=1
	   begin
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
		where	a.Tipe='PT' and (a.TglGiro between @TglAw and @TglAk) and a.Kas like @Perkiraan  
	    and A.NoGiro like '%T'
		and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	   end
	else if @tolak=2
	   begin
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
		where	a.Tipe='PT' and (a.TglGiro between @TglAw and @TglAk) and a.Kas like @Perkiraan  
	    and A.NoGiro not like '%T'
		and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	   end
	else if @tolak=3
	   begin
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
		where	a.Tipe='PT' and (a.TglGiro between @TglAw and @TglAk) and a.Kas like @Perkiraan  
		and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	   end
	
end else
if @Masuk='2'
begin
	if @tolak=1
	begin  
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
		where	a.Tipe='PT' and a.TglCair is not null 
		and a.TglCair>=@TglAw and a.TglCair<=@TglAk and a.Kas like @Perkiraan 
		and A.NoGiro like '%T'
		and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser)) 
	End	
	else if @tolak=2
	begin  
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
		where	a.Tipe='PT' and a.TglCair is not null 
		and a.TglCair>=@TglAw and a.TglCair<=@TglAk and a.Kas like @Perkiraan 
		and A.NoGiro not like '%T' 
		and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	End	
	else if @tolak=3
	begin  
		select  a.Bank, a.NoGiro, a.TglGiro,
		a.Debet, a.DebetRp, 
		a.Kredit, a.KreditRp,
		a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
		a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
		from	DBGIRO a
		Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
		where	a.Tipe='PT' and a.TglCair is not null 
		and a.TglCair>=@TglAw and a.TglCair<=@TglAk and a.Kas like @Perkiraan 
		and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	End	
end
if @Masuk='3'
begin
	if @tolak=1
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
             a.Keterangan, a.TglBuka, a.BuktiBuka, 
            a.TglCair,
            a.BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
			from dbgiro a
			Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
			where  (a.TglBuka between @TglAw and @tglAk) and a.Tipe='PT' and a.Kas like @Perkiraan  
			and A.NoGiro like '%T' 
			and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	   end
	else if @tolak=2
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
             a.Keterangan, a.TglBuka, a.BuktiBuka, 
            a.TglCair,
            a.BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
			from dbgiro a
			Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
			where  (a.TglBuka between @TglAw and @tglAk) and a.Tipe='PT' and a.Kas like @Perkiraan  
			and A.NoGiro not like '%T' 
			and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	   end
	 else if @tolak=3
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
             a.Keterangan, a.TglBuka, a.BuktiBuka, 
            a.TglCair,
            a.BuktiCair,
             a.Kurs, a.Jumlah, a.Kodevls, @Masuk JenisLap
			from dbgiro a
			Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
			where  (a.TglBuka between @TglAw and @tglAk) and a.Tipe='PT' and a.kas like @Perkiraan  
			and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
	   end
end else
if @Masuk='4'
begin 
	if @tolak=1
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
			from dbgiro a
			Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
			where A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) and a.Tipe='PT' and a.kas like @Perkiraan  
			and A.NoGiro like '%T' 
			and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
		End
	else if @tolak=2
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
			from dbgiro a
			Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
			where A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) and a.Tipe='PT' and a.kas like @Perkiraan  
			and A.NoGiro not like '%T'
			and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser)) 
		End
	else if @tolak=3
	   begin
			select  a.Bank, a.NoGiro, a.TglGiro,
            A.Debet,A.DebetRp, 
            A.Kredit,a.KreditRp,
               a.Keterangan, a.TglBuka, a.BuktiBuka, a.TglCair, a.BuktiCair,
               a.Kurs, a.Jumlah,a.Kodevls, @Masuk JenisLap
			from dbgiro a
			Left Outer Join dbTransaksi B on A.BuktiBuka=B.NoBukti and A.UrutBuktiBuka=B.Urut
			where A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) and a.Tipe='PT' and a.kas like @Perkiraan  
			and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
		End
 
end
if @Masuk='5'
begin
  Select a.TglBuka Tanggal,a.BuktiBuka Nobukti,b.Keterangan,a.Bank,'' NoAcc,a.NoGiro,a.TglGiro,
         a.DebetRp Debet,0 kredit,a.DebetRp Saldo,1 Urut, @Masuk JenisLap
  from dbgiro a
  left Outer join dbtransaksi b on b.nobukti=a.buktibuka and b.Urut=a.UrutBuktiBuka
  Where a.BuktiBuka<>'' and
  CAST(year(TglBuka) as varchar(4))+Case when month(TglBuka)<10 then '0' else '' end+CAST(month(TglBuka) as varchar(2))
  +Case when TglBuka<10 then '0' else '' end+CAST(day(TglBuka)  as varchar(2))  <=@periode1
   and TglBuka between @TglAw and @TglAk
		and a.DebetRp<>0
		 and a.Tipe='PT' and a.kas like @Perkiraan  
  and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser))
  union all
  Select a.TglCair,a.BuktiCair,b.Keterangan,a.Bank,''NoAcc,a.NoGiro,a.TglGiro,
         0 debet, a.KreditRp Kredit, a.KreditRp*-1 Saldo,2 urut, @Masuk JenisLap
  from dbgiro a
  left Outer join dbtransaksi b on b.nobukti=a.bukticair and b.Urut=a.UrutBuktiCair
  Where a.BuktiCair<>'' and 
  CAST(year(TglCair) as varchar(4))+Case when month(TglCair)<10 then '0' else '' end+CAST(month(TglCair) as varchar(2))
  +Case when TglCair<10 then '0' else '' end+CAST(day(TglCair)  as varchar(2))  <=@periode1
  and TglCair between @TglAw and @TglAk
		and a.kreditRp<>0 
		and a.Tipe='PT' and a.kas like @Perkiraan 
  and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser)) 
  union all
  Select null,'','Saldo awal','','','',null,0,0, Sum(A.debetRp) Saldo,0 urut, @Masuk JenisLap
  From dbgiro a 
  left Outer join dbtransaksi b on b.nobukti=a.bukticair and b.Urut=a.UrutBuktiCair
  --where CAST(year(TglBuka) as varchar(4))+Case when month(TglBuka)<10 then '0' else '' end+CAST(month(TglBuka) as varchar(2))
  --+Case when @hari<10 then '0' else '' end+CAST(@hari as varchar(2))
   --<@Periode
     where   CAST(year(TglBuka) as varchar(4))+Case when month(TglBuka)<10 then '0' else '' end+CAST(month(TglBuka) as varchar(2))
  +Case when TglBuka<10 then '0' else '' end+CAST(day(TglBuka)  as varchar(2))
  <@periode --and   (Month(Tglbuka)<Month(@tglaw) and year(tglBuka)<=year(@tglaw)) --and 
    --and    ((KreditRp=0) or (Month(TglCair)>=Month(@tglaw) and year(tglcair)>=year(@tglaw))) 
    and a.Tipe='PT' and a.kas like @Perkiraan 
  and (B.CustSuppL in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser) or B.CustSuppP in (select ID from DBCUSTOMIZE where Tipe=@KDreport and IDuser=@IdUser)) 
  Order by urut,Tanggal,Nobukti
 end
End



GO

-- Procedure: sp_LapInvestasi
-- Created: 2023-12-20 22:13:22.227 | Modified: 2024-01-01 21:12:34.260
-- =====================================================


CREATE  PROCEDURE [dbo].[sp_LapInvestasi]
@bulan int,
@tahun int,
@Divisi varchar(20)
as
Select A.NoMuka GrpPerkiraan, A.GroupInvestasi,A.perkiraan, A.Keterangan,C.Perkiraan,
		   A.Devisi, A.TglPerolehan,A.TglJatuhTempo, A.Quantity, A.Persen,
		   (B.Awal) Awal, (B.MD) MD, (B.MK) MK, (B.Akhir) Akhir, (B.AwalPasar) AwalSusut, 
		   (B.SD) SD, (B.SK) SK, (B.AkhirPasar) Akhirpasar, D.Keterangan NamaPerkiraan,
		   B.Akhir-B.AkhirPasar NilaiAK,AwalPasar,spi
	From DBINVESTASI A
		  left Outer join  DBINVESTASIDET B on B.Perkiraan=A.Perkiraan and B.Devisi=A.Devisi
		  left Outer Join DBPOSTHUTPIUT C on C.Perkiraan=A.NoMuka and C.Kode='IVT'
		  left Outer Join DBPERKIRAAN D on D.Perkiraan=C.Perkiraan and D.Tipe=1
	where B.Bulan=@bulan and B.Tahun=@tahun and A.Devisi like @Divisi       
	order by A.Devisi,A.NoMuka, A.Perkiraan

GO

-- Procedure: Sp_LapJurnal
-- Created: 2011-03-17 11:34:24.907 | Modified: 2011-12-08 22:35:34.730
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_LapJurnal]
@Tipe varchar(10),
@Divisi varchar(20),
@TglAw datetime,
@TglAk datetime
AS
Set @Divisi=Case when @Divisi in ('-','') then '%' else @Divisi end


	if @tipe='JP'
	begin       --Jurnal Penutup
	 select a.Devisi, a.Tanggal, a.NoBukti, a.Perkiraan, a.Lawan, Debet=(a.Debet*a.Kurs),
			  Kredit=(a.Kredit*a.Kurs), a.TipeTrans, a.Keterangan,
	 (case when exists(Select b.NoBukti from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)then
	 (select sum(b.Debet*b.Kurs)from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)else 0 end)as NDebet,
	 (case when exists(Select b.NoBukti from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)then
	 (select sum(b.Kredit*b.Kurs)from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)else 0 end)as NKredit
	 From dbTransaksi a
	 Where (a.TipeTrans='HPP' or a.tipetrans='LR')  and a.devisi=@divisi and a.Tanggal>=@TglAw and a.Tanggal<=@TglAk
	end 
	else
	begin
	 select a.Devisi, a.Tanggal, a.NoBukti, a.Perkiraan, a.Lawan, Debet=(a.Debet*a.Kurs),
			  Kredit=(a.Kredit*a.Kurs), a.TipeTrans, a.Keterangan,
	 (case when exists(Select b.NoBukti from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)then
	 (select sum(b.Debet*b.Kurs)from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)else 0 end)as NDebet,
	 (case when exists(Select b.NoBukti from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)then
	 (select sum(b.Kredit*b.Kurs)from dbTransaksi b where b.NoBukti=a.NoBukti and
	  b.TipeTrans=@Tipe and b.Tanggal>=@TglAw and b.Tanggal<=@TglAk group by b.NoBukti)else 0 end)as NKredit
	 From vwTransaksi a
	 Where a.TipeTrans=@Tipe and a.devisi like @divisi and a.Tanggal>=@TglAw and a.Tanggal<=@TglAk
	end	






GO

-- Procedure: sp_LapKasHarian
-- Created: 2012-11-05 10:19:51.850 | Modified: 2015-03-09 15:32:12.810
-- =====================================================



CREATE PROCEDURE [dbo].[sp_LapKasHarian]
@Perkiraan varchar(15)='',
@TglAw datetime=null,
@TglAk datetime=null,
@Divisi varchar(15)='',
@IdUser varchar(20),
@Tipe varchar(20)
As
Set @Divisi=Case when @Divisi in ('-','') then '%' else @Divisi end
if Not exists (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)  
begin
  select a.tanggal,a.nobukti,
         (case when a.perkiraan=@perkiraan then a.Lawan
	          when a.lawan=@perkiraan then a.Perkiraan
		end)lawan,
	    (case when  a.TPHC='C' and a.perkiraan=@perkiraan then  debet*a.kurs else 0 end) as Debet,
	    (case when  a.TPHC<>'C' and a.perkiraan=@perkiraan then  debet*a.kurs else 0 end) as Debet2,
	    (case when a.perkiraan=@perkiraan then debet*a.kurs else 0 end) as DebetRp,
	    (case when a.perkiraan=@perkiraan and a.valas<>'IDR' then debet else 0 end) as DebetD,
		 a.TipeTrans, a.Keterangan,
		(case when  a.TPHC='C' and a.lawan=@perkiraan then debet*a.kurs else 0 end) as kredit,                       
		(case when  a.TPHC<>'C' and a.Lawan=@perkiraan then  debet*a.kurs else 0 end) as kredit2, 
 	    (case when a.Lawan=@perkiraan then debet*a.Kurs else 0 end) as kreditRp,   
		(case when a.lawan=@perkiraan and a.valas<>'IDR' then debet else 0 end) as kreditD,
        a.Kurs, a.Valas, 0 Dolar, a.Devisi,a.Perkiraan,b.Keterangan NamaPerkiraan
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (t.tanggal between @tglaw and @tglAk) and (a.Devisi like @divisi)
		and (a.perkiraan=@perkiraan or a.lawan=@perkiraan )
		order by a.tanggal asc, t.NOURUT, t.Simbol, a.tipetrans desc, a.nobukti, a.Urut

End
else
begin
select a.tanggal,a.nobukti,
         (case when a.perkiraan=@perkiraan then a.Lawan
	          when a.lawan=@perkiraan then a.Perkiraan
		end)lawan,
	    (case when  a.TPHC='C' and a.perkiraan=@perkiraan then  debet*a.kurs else 0 end) as Debet,
	    (case when  a.TPHC<>'C' and a.perkiraan=@perkiraan then  debet*a.kurs else 0 end) as Debet2,
	    (case when a.perkiraan=@perkiraan then debet*a.kurs else 0 end) as DebetRp,
	    (case when a.perkiraan=@perkiraan and a.valas<>'IDR' then debet else 0 end) as DebetD,
		 a.TipeTrans, a.Keterangan,
		(case when  a.TPHC='C' and a.lawan=@perkiraan then debet*a.kurs else 0 end) as kredit,                       
		(case when  a.TPHC<>'C' and a.Lawan=@perkiraan then  debet*a.kurs else 0 end) as kredit2, 
 	    (case when a.Lawan=@perkiraan then debet*a.Kurs else 0 end) as kreditRp,   
		(case when a.lawan=@perkiraan and a.valas<>'IDR' then debet else 0 end) as kreditD,
        a.Kurs, a.Valas, 0 Dolar, a.Devisi,a.Perkiraan,b.Keterangan NamaPerkiraan
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where (t.tanggal between @tglaw and @tglAk) and (a.Devisi like @divisi)
		and (a.perkiraan=@perkiraan or a.lawan=@perkiraan )
	
		and
		(case when a.perkiraan=@perkiraan then a.Lawan
	          when a.lawan=@perkiraan then a.Perkiraan
		end) in (ISnull((select ID from DBCUSTOMIZE where Iduser=@IdUser and Tipe=@Tipe),'%%') )
		order by a.tanggal asc, t.NOURUT, t.Simbol, a.tipetrans desc, a.nobukti, a.Urut
End		



GO

-- Procedure: SP_LapNeracaPenunjang
-- Created: 2011-12-16 13:45:08.963 | Modified: 2024-10-03 11:29:47.847
-- =====================================================
CREATE PROCEDURE [dbo].[SP_LapNeracaPenunjang]
@divisi varchar(10),
@bulan int,
@tahun int
as
/*Set @divisi=Case when @divisi in ('-','') then '%' else @divisi end
Select Case when Left(A.Neraca,2)='A1' then 'AKTIVA LANCAR'
            when Left(A.Neraca,2)='A2' then 'AKTIVA TETAP'
            when Left(A.Neraca,2)='A3' then 'AKTIVA LAIN-LAIN' 
            when Left(A.Neraca,2)='P1' then 'KEWAJIBAN LANCAR'
            when Left(A.Neraca,2)='P2' then 'KEWAJIBAN TIDAK LANCAR'
            when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Grup, A.Keterangan, A.Perkiraan,
       a.Keterangan, A.Tipe, a.DK,
       Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end BulanIni, B.Devisi 
from dbPerkiraan a
     left outer join dbNeraca b on b.Perkiraan=a.Perkiraan
where b.Bulan=@bulan and b.Tahun=@tahun and Left(A.Neraca,2)<>'' and 
      B.Devisi like @divisi and 
      Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end<>0 
Order by Left(A.Neraca,2),A.Perkiraan*/
Set @divisi=Case when @divisi in ('-','') then '%' else @divisi end
Select Case when Left(A.Neraca,2)='A1' then 'INVESTASI'
            when Left(A.Neraca,2)='A2' then 'SELISIH NILAI KINI AKTUARIAL'
            when Left(A.Neraca,2)='A3' then 'ASET LANCAR DI LUAR INVESTASI' 
            when Left(A.Neraca,2)='A4' then 'ASET OPERASIONAL'
            when Left(A.Neraca,2)='A5' then 'ASET LAIN-LAIN'
            when Left(A.Neraca,2)='P1' then 'NILAI AKTUARIA'
            when Left(A.Neraca,2)='P2' then 'LIABILITAS DILUAR NILAI KINI AKTUARIA'
            --when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Grup, --A.Keterangan, 
       A.Perkiraan,
       a.Keterangan, A.Tipe, a.DK,
      /* Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end BulanIni*/
              Case when a.tipe=1 and A.kelompok=0 then b.AkhirDRp-b.AkhirKRp else
       case when a.tipe=1 and a.kelompok<>0 then b.AkhirKRp-b.AkhirDRp else
       null end
       end BulanIni,
            isnull((select SUM((a.AwalKRp-a.AwalDRp)+(a.MKRp-A.MDRp)+(a.JPKRp-A.JPDRp)+(a.RLKRp-A.RLDRp))
          from dbneraca A,dbperkiraan B
          where A.bulan=@bulan-1 and A.tahun=@tahun and A.perkiraan=B.perkiraan 
          --and substring(B.neraca,1,5)=substring(C.Neraca,1,5)
          )
          ,0) as bulanlalu

       , B.Devisi 
from dbPerkiraan a
     left outer join dbNeraca b on b.Perkiraan=a.Perkiraan and Bulan=@bulan and Tahun=@tahun and  B.Devisi like @divisi 
where /*b.Bulan=@bulan and b.Tahun=@tahun and Left(A.Neraca,2)<>'' and 
      B.Devisi like @divisi and 
      Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end<>0 */
       Left(A.Neraca,2)<>'' and Left(A.Neraca,2) <>'A2' and Left(A.Neraca,2) <>'P1'
       and  (((b.AkhirDRp-b.AkhirKRp)<>0 and Tipe=1) or Tipe=0)

Order by Left(A.Neraca,2),A.Perkiraan
GO

-- Procedure: SP_LapNeracaPenunjangTahunan
-- Created: 2015-10-30 02:28:39.890 | Modified: 2015-10-30 02:28:39.890
-- =====================================================
CREATE PROCEDURE [dbo].[SP_LapNeracaPenunjangTahunan]
@divisi varchar(10),
@bulan int,
@tahun int
as
Set @divisi=Case when @divisi in ('-','') then '%' else @divisi end
Select Case when Left(A.Neraca,2)='A1' then 'AKTIVA LANCAR'
            when Left(A.Neraca,2)='A2' then 'AKTIVA TETAP'
            when Left(A.Neraca,2)='A3' then 'AKTIVA LAIN-LAIN' 
            when Left(A.Neraca,2)='P1' then 'KEWAJIBAN LANCAR'
            when Left(A.Neraca,2)='P2' then 'KEWAJIBAN TIDAK LANCAR'
            when Left(A.Neraca,2)='P3' then 'MODAL SENDIRI' 
            else ''
       end Grup, A.Keterangan, A.Perkiraan,
       a.Keterangan, A.Tipe, a.DK,
       Case when A.DK=0 then sum(b.AkhirDRp)-sum(b.AkhirKRp) 
            when A.DK=1 then sum(b.AkhirKRp)-sum(b.AkhirDRp)
            else 0
       end BulanIni, B.Devisi 
from dbPerkiraan a
     left outer join dbNeraca b on b.Perkiraan=a.Perkiraan
where b.Tahun=@tahun and Left(A.Neraca,2)<>'' and 
      B.Devisi like @divisi and 
      Case when A.DK=0 then b.AkhirDRp-b.AkhirKRp 
            when A.DK=1 then b.AkhirKRp-b.AkhirDRp
            else 0
       end<>0 group by a.Neraca,a.Keterangan,a.Perkiraan,a.Tipe,a.DK,b.Devisi
Order by Left(A.Neraca,2),A.Perkiraan

GO

-- Procedure: SP_LaporanStock
-- Created: 2025-08-21 08:09:41.290 | Modified: 2025-08-21 08:09:41.290
-- =====================================================

    CREATE PROCEDURE SP_LaporanStock
        @KODEGDG NVARCHAR(10) = NULL,
        @KODEGRP NVARCHAR(10) = NULL,
        @BULAN INT,
        @TAHUN INT,
        @StockStatus NVARCHAR(20) = 'ALL'
    AS
    BEGIN
        SET NOCOUNT ON;
        
        SELECT 
            b.KODEBRG,
            b.NAMABRG,
            b.KODEGRP,
            b.KODESUPP,
            b.SAT1 AS SATUAN,
            ISNULL(s.SALDOQNT, 0) AS StockCurrent,
            b.QntMin AS StockMinimum,
            b.QntMax AS StockMaximum,
            s.KODEGDG,
            CASE 
                WHEN ISNULL(s.SALDOQNT, 0) = 0 THEN 'ZERO STOCK'
                WHEN ISNULL(s.SALDOQNT, 0) <= b.QntMin THEN 'LOW STOCK'
                WHEN ISNULL(s.SALDOQNT, 0) >= b.QntMax THEN 'OVER STOCK'
                ELSE 'NORMAL'
            END AS StockStatus,
            b.Hrg1_1 AS HargaBeli,
            b.Hrg2_1 AS HargaJual,
            (ISNULL(s.SALDOQNT, 0) * b.Hrg1_1) AS NilaiStock
        FROM DBBARANG b
        LEFT JOIN DBSTOCKBRG s ON b.KODEBRG = s.KODEBRG 
            AND s.BULAN = @BULAN AND s.TAHUN = @TAHUN
        WHERE b.ISAKTIF = 1
            AND (@KODEGDG IS NULL OR s.KODEGDG = @KODEGDG)
            AND (@KODEGRP IS NULL OR b.KODEGRP = @KODEGRP)
            AND (
                @StockStatus = 'ALL' OR
                (@StockStatus = 'LOW' AND ISNULL(s.SALDOQNT, 0) <= b.QntMin) OR
                (@StockStatus = 'ZERO' AND ISNULL(s.SALDOQNT, 0) = 0) OR
                (@StockStatus = 'NORMAL' AND ISNULL(s.SALDOQNT, 0) > b.QntMin AND ISNULL(s.SALDOQNT, 0) < b.QntMax)
            )
        ORDER BY b.KODEBRG;
    END
    
GO

-- Procedure: Sp_LapPenerimaanKeuangan
-- Created: 2014-11-20 15:20:50.727 | Modified: 2014-11-20 15:58:39.417
-- =====================================================

CREATE Procedure [dbo].[Sp_LapPenerimaanKeuangan]
--declare
@Devisi Varchar(15),@bulan int,@Tahun int
--select @Devisi='01',@bulan=9,@Tahun=2014
As

Select x.CustSuppL,x.NAMACUSTSUPP,Sum(x.Total) total,Sum(x.Tunai) tunai,Sum(x.KU) KU,Sum(x.Giro) Giro
from(
Select a.CustSuppL,b.NAMACUSTSUPP,
       Sum( a.DebetRp ) Total,
       Sum(Case when a.TPHC='C' then a.DebetRp else 0 end) Tunai,
       Sum(Case when a.TPHC='T' then a.DebetRp else 0 end) KU,
       Sum(Case when a.TPHC='P' then a.DebetRp else 0 end) Giro
from dbTransaksi a 
     left Outer join DBCUSTSUPP b on b.KODECUSTSUPP=a.CustSuppL or b.KODECUSTSUPP=a.CustSuppL
     left Outer join dbGiro c on c.BuktiCair=a.nobukti --and c.NoGiro=a.nogiro
where a.CustSuppL<>'' and month(a.Tanggal)=@Bulan and year(A.Tanggal)=@tahun
Group by a.CustSuppL,b.NAMACUSTSUPP
union 
select case when isnull(b.CustSuppL,'')='' /*and isnull(b.koderelasi,'')='' */ then b.CustSuppL
                         when isnull(b.CustSuppL,'')='' then ''/*isnull(b.koderelasi,'') */
                         else isnull(b.CustSuppL,'')
                    end  Kodecust,c.NAMACUSTSUPP,Sum(a.Kredit) Total,0,0,Sum(a.kredit) Giro
from DBGIRO a
     left Outer join dbtransaksi b on b.nobukti=a.Buktibuka /*and b.nogiro=a.nogiro and b.bank=a.bank */--and b.TglGiro=a.TglGiro
     left Outer join DBCUSTSUPP c on c.KODECUSTSUPP=b.CustSuppL /*or c.KodeCust=a.KodeCust or c.kodecust=b.koderelasi*/
where month(a.TglCair)=@bulan and year(a.TglCair)=@tahun
Group by c.NAMACUSTSUPP,B.CustSuppL /*,b.koderelasi,a.kodecust,b.kodecust*/) x
group by x.CustSuppL,x.NAMACUSTSUPP
Order by x.CustSuppL




/*
select * from DBSURYAJAWARA..dbTransaksi where CustSuppL<>'' or CustSuppP<>''
select * from DBwijaya..dbgiro
*/
GO

-- Procedure: sp_LapPerubahanAset
-- Created: 2023-12-13 12:43:08.050 | Modified: 2025-05-21 14:13:59.973
-- =====================================================

CREATE PROCEDURE [dbo].[sp_LapPerubahanAset]
--declare
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=3,@Tahun=2018;
AS
	
	Set @Devisi=Case when @Devisi in ('-','') then '%' else @Devisi end;
  /*
With PerubahanNetto (kodepan,nilaidebet,nilaikredit,deltaneto,deltanetoblnlalu,nilai) AS
	(
	select x.KodePAN ,max(nilaidebet)nilaidebet ,max(nilaikredit)nilaikredit ,
	sum(case when tipe=0 then nilai else -1*nilai end) deltanetto,
	sum(case when tipe=0 then nilai else -1*nilai end) deltanettoblnlalu
	,SUM(nilai)nilai  from 
	(
	select b.KodePAN,SUM (AkhirDRp )nilaidebet,SUM (AkhirKRp )nilaikredit ,
	
	sum (
	case when KodePAN ='PAN11' then dbo.JumlahPPIN (@bulan ,@Tahun )else 
	case when isnull(AkhirDRp,0)=0 then ISNULL(MKRp-MDRp,0)+ISNULL(JPKRp-JpDRp,0)    --isnull(AkhirKRp,0)--
	else isnull(MDRp-MKRp,0) +ISNULL(JPDRp -JPKRp,0 ) end --isnull(AkhirDRp,0)
	end
	)  
	nilai
	/*Keterangan, b.Perkiraan ,AwalDRp , AkhirKRp */  from DBNERACA a
	left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan 
	where Bulan =@bulan  and Tahun =@Tahun  and isnull(KodePAN,'')<>''
	group by b.KodePAN 
	)x
	left outer join DBPerubahanAsetKonfig y on y.KodePAN=x.KodePAN
	group by x.kodepan,y.tipe
	)

	select case when Tipe =0 then 'Penambahan' else  'Pengurangan' end NamaTipe,deltaneto,
	--sum(case when tipe=0 then nilai else -1*nilai end) deltanetto,
	a.Keterangan,Urutan,Tipe   ,b.nilai ,dbo.PANJumlahAsetNeto(@bulan,@Tahun,@Devisi) NetoBlnIni
	 ,dbo.PANJumlahAsetNeto(@bulan-1,@Tahun,@Devisi) NetoBlnLalu
	,c.nilai nilaiblnlalu,c.deltanetto deltanettoblnlalu
	from DBPerubahanAsetKonfig a
	left outer join PerubahanNetto b on b.kodepan=a.KodePAN 
	left outer join dbo.TblLapPerubahanAsetNeto(@bulan ,@Tahun ,@Devisi ) c on c.kodepan=a.KodePAN 
	--group by a.Keterangan ,nilai  ,Urutan 
 */
 /*
With PerubahanNetto (kodepan,nilaidebet,nilaikredit,deltaneto,deltanetoblnlalu,nilai,nilaisd) AS
	(
	select x.KodePAN ,max(nilaidebet)nilaidebet ,max(nilaikredit)nilaikredit ,
	sum(case when tipe=0 then nilai else -1*nilai end) deltanetto,
	sum(case when tipe=0 then nilai else -1*nilai end) deltanettoblnlalu
	,SUM(nilai)nilai, 
	sum (
	case when x.KodePAN ='PAN11' then dbo.JumlahPPIN (@bulan ,@Tahun )else 
	case when isnull(Akhirdebet,0)=0 then akhirkredit    --isnull(AkhirKRp,0)--
	else akhirkredit end --isnull(AkhirDRp,0)
	end
	)  nilaisd
	 from 
	(
	select b.KodePAN,SUM (AkhirDRp )nilaidebet,SUM (AkhirKRp )nilaikredit ,
	
	sum (
	case when KodePAN ='PAN11' then dbo.JumlahPPIN (@bulan ,@Tahun )else 
	case when isnull(AkhirDRp,0)=0 then ISNULL(MKRp-MDRp,0)+ISNULL(JPKRp-JpDRp,0)    --isnull(AkhirKRp,0)--
	else isnull(MDRp-MKRp,0) +ISNULL(JPDRp -JPKRp,0 ) end --isnull(AkhirDRp,0)
	end
	)  
	nilai
	
 from DBNERACA a
	left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan 
	where Bulan =@bulan  and Tahun =@Tahun  and isnull(KodePAN,'')<>''
	group by b.KodePAN 
	)x
	left outer join DBPerubahanAsetKonfig y on y.KodePAN=x.KodePAN
	left outer join dbo.TblLapPerubahanAsetNetoSD(@bulan ,@Tahun ,@Devisi ) d on d.kodepan=x.KodePAN 
	group by x.kodepan,y.tipe
	)

	select case when Tipe =0 then 'Penambahan' else  'Pengurangan' end NamaTipe,deltaneto,
	a.Keterangan,Urutan, a.Tipe  ,b.nilai ,dbo.PANJumlahAsetNeto(@bulan,@Tahun,@Devisi) NetoBlnIni
	 ,dbo.PANJumlahAsetNeto(@bulan-1,@Tahun,@Devisi) NetoBlnLalu
	,c.nilai nilaiblnlalu,c.deltanetto deltanettoblnlalu,nilaisd 
	from DBPerubahanAsetKonfig a
	left outer join PerubahanNetto b on b.kodepan=a.KodePAN 
	left outer join dbo.TblLapPerubahanAsetNeto(@bulan ,@Tahun ,@Devisi ) c on c.kodepan=a.KodePAN 
	--group by a.Keterangan ,nilai  ,Urutan  
 */
 With PerubahanNetto (kodepan,nilaidebet,nilaikredit,deltaneto,deltanetoblnlalu,nilai,nilaisd) AS (

 select y.KodePAN,y.nilaidebet ,y.nilaikredit  ,y.deltanetto,y.nilaidebet,y.nilai,
 --case when nilai=0 then nilaidebet else y.nilaisd end niiaisd
 isnull(x.nilaisda,0) +y.nilai 
  from
      (		

					select x.KodePAN ,max(nilaidebet)nilaidebet ,max(nilaikredit)nilaikredit ,
					sum(case when tipe=0 then nilai else -1*nilai end) deltanetto,
					sum(case when tipe=0 then nilai else -1*nilai end) deltanettoblnlalu
					,SUM(nilai)nilai, 
					sum (
					case when x.KodePAN ='PAN11' then 0--dbo.JumlahPPIN (@bulan ,@Tahun )
					else 
					case when isnull(Akhirdebet,0)=0 then akhirkredit    --isnull(AkhirKRp,0)--
					else akhirkredit end --isnull(AkhirDRp,0)
					end
					)  nilaisd
					 from 
					(
					select b.KodePAN,SUM (AkhirDRp )nilaidebet,SUM (AkhirKRp )nilaikredit ,
					
					sum (
					case when KodePAN ='PAN11' then dbo.JumlahPPIN (@bulan ,@Tahun )else 
					case when isnull(AkhirDRp,0)=0 then ISNULL(MKRp-MDRp,0)+ISNULL(JPKRp-JpDRp,0)    --isnull(AkhirKRp,0)--
					else isnull(MDRp-MKRp,0) +ISNULL(JPDRp -JPKRp,0 ) end --isnull(AkhirDRp,0)
					end
					)  
					nilai
					
				 from DBNERACA a
					left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan 
					where Bulan =@bulan  and Tahun =@Tahun  and isnull(KodePAN,'')<>''
					group by b.KodePAN 
					)x
					left outer join DBPerubahanAsetKonfig y on y.KodePAN=x.KodePAN
					left outer join dbo.TblLapPerubahanAsetNetoSD(@bulan ,@Tahun ,@Devisi ) d on d.kodepan=x.KodePAN 
					group by x.kodepan,y.tipe
) y
left outer join ( select b.KodePAN ,sum (
					case when b.KodePAN ='PAN11' then dbo.JumlahPPINSD(@bulan,@bulan -1 ,@Tahun)--+--dbo.JumlahPPIN (@bulan ,@Tahun )
					else 
					case when isnull(AkhirDRp,0)=0 then AkhirKRp    --isnull(AkhirKRp,0)--
					else AkhirdRp end --isnull(AkhirDRp,0)
					end)nilaisda
					from DBNERACA  a
					left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan 
					where Bulan =@bulan  and Tahun =@Tahun  and isnull(KodePAN,'')<>'' and KodePAN ='PAN11'
					group by b.KodePAN 
					union 
					select b.KodePAN ,sum (
					case when b.KodePAN ='PAN11' then dbo.JumlahPPINSD(@bulan,@bulan -1 ,@Tahun)--+--dbo.JumlahPPIN (@bulan ,@Tahun )
					else 
					case when isnull(AkhirDRp,0)=0 then AkhirKRp    --isnull(AkhirKRp,0)--
					else AkhirdRp end --isnull(AkhirDRp,0)
					end)nilaisda
					from DBNERACA  a
					left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan 
					where  Bulan between 1 and @bulan-1   and Tahun =@Tahun  and isnull(KodePAN,'')<>'' and KodePAN <>'PAN11'
					group by b.KodePAN 
					) x on x.KodePAN =y.KodePAN 
	)

	select case when Tipe =0 then 'Penambahan' else  'Pengurangan' end NamaTipe,deltaneto,
	a.Keterangan,Urutan, a.Tipe  ,case when b.nilai=0 then (b.nilaidebet)  else b.nilai  end nilai,b.nilai nilabulanini ,
	dbo.PANJumlahAsetNeto(@bulan,@Tahun,@Devisi) NetoBlnIni
	 ,dbo.PANJumlahAsetNeto(@bulan-1,@Tahun,@Devisi) NetoBlnLalu
	,c.nilai nilaiblnlalu,c.deltanetto deltanettoblnlalu,--- case when nilaisd =0 then deltaneto  +c.nilai  else nilaisd end +
	--case when b.nilai =0 then c.nilai  else 0 end 
	--c.deltanetto +deltaneto 
	--case when tipe =0 then (c.deltanetto + deltaneto) else abs(c.deltanetto + deltaneto) end  nilaisd 
	nilaisd 
	,c.deltanetto +deltaneto SDDelta
	from DBPerubahanAsetKonfig a
	left outer join PerubahanNetto b on b.kodepan=a.KodePAN 
	left outer join dbo.TblLapPerubahanAsetNeto(@bulan ,@Tahun ,@Devisi ) c on c.kodepan=a.KodePAN 
	--group by a.Keterangan ,nilai  ,Urutan  

GO

-- Procedure: sp_LapPerubahanModal
-- Created: 2023-05-23 03:55:03.837 | Modified: 2023-05-23 03:55:03.837
-- =====================================================



CREATE PROCEDURE [dbo].[sp_LapPerubahanModal]
--declare
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
--select @Devisi='01',@bulan=3,@Tahun=2018;
AS
Set @Devisi=Case when @Devisi in ('-','') then '%' else @Devisi end;
  
With ArusKas (KodeAK,KodeSAK,bulan,tahun,Nilai) AS
(  
    select KodeAK,KodeSAK,Bulan,Tahun,sum(Nilai) Nilai from (    
	   select a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	) -
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end) as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK<>'SAK08'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	   
	   union all
	   
       select 'AK01','SAK08-',b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then 0
		            when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then Kredit*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then Debet*a.kurs
		            when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and kredit<>0 then 0 end)*-1  as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK='SAK08'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	   
	   union all
	   
       select 'AK01','SAK08+',b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	)  as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK='SAK08' and a.Perkiraan<>'1561.1'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	   
	   union all
	   
       select 'AK01','SAK08-',b.Bulan,b.Tahun,sum(b.Nilai) Nilai from DBPERKIRAAN a
       left outer join 
       (
       select (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Lawan
	          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) then a.Perkiraan
		end) Perkiraan,month(t.tanggal) Bulan, year(t.tanggal) Tahun,
	    (case when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) and debet<>0 then debet*a.kurs
		          when (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and debet<>0 then 0
		          when (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')))  and kredit<>0 then kredit*a.kurs end
	        	)  as Nilai
		from dbTrans t 
               left outer join dbtransaksi a on t.NoBukti=a.NoBukti
		     left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
		     left outer join DBPERKIRAAN c on c.Perkiraan=a.Lawan	
		where --(month(t.tanggal)=@bulan and year(t.tanggal)=@Tahun) and 
		(a.Devisi like @Devisi)
		and (a.perkiraan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK'))) or (a.lawan in (select Perkiraan from DBPOSTHUTPIUT where Kode in ('KAS','BANK')) )
	   ) B on b.Perkiraan=a.Perkiraan
	   where b.Perkiraan is not null and KodeSAK='SAK08' and a.Perkiraan='1561.1'
	   group by a.KodeAK,a.KodeSAK,b.Bulan,b.Tahun
	) Z group by KodeAK,KodeSAK,Bulan,Tahun 

)

select a.KodeAK,a.KodeSAK,a.Tipe,a.Keterangan,a.Nomor,a.Urutan,sum(isnull(c.Nilai,0)) Nilai
 from DBArusKasKonfig a
 left outer join (select KodeAK,KodeSAK,Nilai from ArusKas where (bulan between @bulan and @akr) and tahun=@Tahun) c on c.KodeAK=a.KodeAK and c.KodeSAK=a.KodeSAK 
 group by a.KodeAK,a.KodeSAK,a.Tipe,a.Keterangan,a.Nomor,a.Urutan
 order by a.Nomor
 
 
 
 
 


GO

-- Procedure: Sp_LapPosisiBankKasHarian
-- Created: 2011-03-03 13:16:56.213 | Modified: 2011-03-03 16:34:38.720
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_LapPosisiBankKasHarian]
@Divisi varchar(15)='',
@Tanggal datetime=null
As

exec Sp_GenerateReportBukuTambahan 1, 2011, @Tanggal, @Tanggal, '','z','T',@Divisi 

select GroupPrk, KetGroupPrk, NoAcc, Keterangan, Valas, JumlahD, 
	case when JumlahD=0 then null else JumlahRp/JumlahD end Kurs, JumlahRp
from

(
select 'A' GroupPrk, 'BANK - GIRO/TAB' KetGroupPrk,
	A.NoAcc, B.Keterangan, B.Valas, SUM(A.SaldoAwalD+A.DebetD-A.KreditD) JumlahD,
	SUM(A.SaldoAwal+A.Debet-A.Kredit) JumlahRp 
from dbTempBkBesar A
left outer join DBPERKIRAAN B on B.Perkiraan=A.NoACC
where A.NoACC like '1112%'
group by A.NoAcc, B.Keterangan, B.Valas

union all
select 'B' GroupPrk, 'BANK - DEPOSITO' KetGroupPrk,
	A.NoAcc, B.Keterangan, B.Valas, SUM(A.SaldoAwalD+A.DebetD-A.KreditD) JumlahD,
	SUM(A.SaldoAwal+A.Debet-A.Kredit) JumlahRp 
from dbTempBkBesar A
left outer join DBPERKIRAAN B on B.Perkiraan=A.NoACC
where A.NoACC like '1113%'
group by A.NoAcc, B.Keterangan, B.Valas

union all
select 'C' GroupPrk, 'KAS' KetGroupPrk,
	A.NoAcc, B.Keterangan, B.Valas, SUM(A.SaldoAwalD+A.DebetD-A.KreditD) JumlahD,
	SUM(A.SaldoAwal+A.Debet-A.Kredit) JumlahRp 
from dbTempBkBesar A
left outer join DBPERKIRAAN B on B.Perkiraan=A.NoACC
where A.NoACC like '1111%'
group by A.NoAcc, B.Keterangan, B.Valas

union all
select 'D' GroupPrk, 'PIUTANG DAGANG' KetGroupPrk,
	A.NoAcc, B.Keterangan, B.Valas, SUM(A.SaldoAwalD+A.DebetD-A.KreditD) JumlahD,
	SUM(A.SaldoAwal+A.Debet-A.Kredit) JumlahRp 
from dbTempBkBesar A
left outer join DBPERKIRAAN B on B.Perkiraan=A.NoACC
where A.NoACC like '113%'
group by A.NoAcc, B.Keterangan, B.Valas
) X

where JumlahRp<>0 or JumlahD<>0

order by GroupPrk, NoAcc, Keterangan, Valas

	


GO

-- Procedure: Sp_LapPosisiBankKasHarianDet
-- Created: 2011-03-03 13:17:13.200 | Modified: 2011-03-03 13:17:13.200
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_LapPosisiBankKasHarianDet]
@Divisi varchar(15)='',
@Tanggal datetime=null,
@NoAcc varchar(20)
As

select A.*, B.*
from dbDeposito A
left outer join DBPERKIRAAN B on B.Perkiraan=A.Bank
where A.Bank=@NoAcc


	



GO

-- Procedure: Sp_LapRenBis
-- Created: 2024-10-24 16:23:28.907 | Modified: 2024-10-30 10:04:40.370
-- =====================================================

CREATE Procedure [dbo].[Sp_LapRenBis]
@bulan int,@akr int,@Tahun int,@Devisi Varchar(15)
As
truncate table temprenbis
IF object_id('TEMPDB.DBO.#AsetNeto') IS NOT NULL drop table #AsetNeto
IF object_id('TEMPDB.DBO.#Labarugi') IS NOT NULL drop table #Labarugi
IF object_id('TEMPDB.DBO.#PerubahanAsetNeto') IS NOT NULL drop table #PerubahanAsetNeto

CREATE TABLE #AsetNeto
( GrupNeraca varchar(50),
  Grup varchar(50),
  Jumlah varchar(11),
  Keterangan varchar(1000),
  TIpe tinyint,
  DK tinyint,
  bulanini numeric(18,2),
  bulanLalu numeric(18,2),
  Devisi varchar (4),
  Perkiraan varchar(10),
  jmlbulanini numeric(18,2)
)

INSERT INTO #AsetNeto EXEC SP_LapAsetNeto @devisi,@bulan,@tahun
insert into TempRenbis (Jenis,grup,Keterangan ,SeptemberTahunIni)
select 'AsetNeto',grup,Keterangan,bulanLalu+bulanini    from #AsetNeto --where Grup='Investasi'\\



CREATE TABLE #LabaRugi
( Keterangan varchar(500),
  Jumlah varchar(11),
  TotalA numeric(18,2),
  TotalB numeric(18,2),
  TotalC numeric(18,2),
  TotalD numeric(18,2),
  Tipe varchar (10),
  Tanda varchar (10),
  Persen varchar (10),
  P1 numeric(18,2),
  P2 numeric(18,2),
  P3 numeric(18,2),
  P4 numeric(18,2),
  islrhpp int,
  Devisi varchar (4),
  Bulan int,
  Tahun int,
  Perkiraan varchar(10),
  Nomor varchar(10),
  
)

INSERT INTO #LabaRugi exec sp_ReportLabaRugi @bulan,@tahun,@devisi,0,0,0,0,0
insert into TempRenbis (Jenis,Keterangan ,SeptemberTahunIni)
select 'LabaRugi',Keterangan,TotalC    from #LabaRugi where Jumlah <>''


CREATE TABLE #PerubahanAsetNeto
(
  NamaTipe varchar(500),
  DEltaNeto numeric(18,2),
  Keterangan varchar(500),
  Urutan varchar (10),
  TIPE tinyint,
  Nilai numeric(18,2),
  NetoblnIni numeric(18,2),
  Netoblnlalu numeric(18,2),
  NilaiblnLalu numeric(18,2),
  deltanetoblnlalu numeric(18,2)
)

INSERT INTO #PerubahanAsetNeto exec sp_LapPerubahanAset @bulan,@akr,@tahun,@devisi
insert into TempRenbis (Jenis,grup,Keterangan ,SeptemberTahunIni)
select 'PerubahanAsetNeto',namatipe,Keterangan,deltaneto+NetoblnIni     from #PerubahanAsetNeto 
select * from TempRenbis 

GO

-- Procedure: sp_LapSaldoAwal
-- Created: 2012-10-20 09:25:04.910 | Modified: 2014-11-20 22:12:06.497
-- =====================================================


CREATE PROCEDURE [dbo].[sp_LapSaldoAwal]
--declare
@Perkiraan varchar(25),
@TglAw datetime,
@TglAk datetime,
@Divisi varchar(15)
--select @Perkiraan='100S',@Divisi='01',@tglAw='10-01-2012',@tglak='10-31-2012'
As

declare @SaldoAwal numeric(18,2),@SaldoAwalBulan numeric(18,2),@SaldoAwalBulanBerjalan numeric(18,2),@dk tinyint
declare @SaldoAwalD numeric(18,2),@SaldoAwalBulanD numeric(18,2),@SaldoAwalBulanBerjalanD numeric(18,2), @SaldoGiro numeric(18,2)
declare @Mulai int, @SaldoGiroTolakan Numeric(18,2)

select @SaldoAwal=0,@SaldoAwalBulan=0,@SaldoAwalBulanBerjalan=0
select @SaldoAwalD=0,@SaldoAwalBulanD=0,@SaldoAwalBulanBerjalanD=0

Set @Divisi=Case when @Divisi in ('-','') then '%' else @Divisi end

    select @SaldoAwalBulan=sum(case when b.DK=0 then isnull(AwalDRp,0)
                                    else isnull(AwalKRp,0) 
                               end),
           @SaldoAwalBulanD=sum(case when b.DK=0 then isnull(Awald,0)
                                    else isnull(AwalK,0) 
                               end)
    from dbNeraca a
    left outer join DBPERKIRAAN b on b.Perkiraan=a.Perkiraan
    where a.Bulan=month(@tglAw) and a.Tahun=year(@tglAw) and a.Perkiraan=@Perkiraan and (devisi like @Divisi)
    group by a.Perkiraan  
  
    set @SaldoAwal=@SaldoAwalBulan
    set @SaldoAwalD=@SaldoAwalBulanD
    if day(@tglAw)<>1
    begin
      select @SaldoAwalBulanBerjalan=sum(case when a.Perkiraan=@Perkiraan then a.DebetRp       
                                              when a.Lawan=@Perkiraan then -a.DebetRp
                                              else 0              
                                         end),
             @SaldoAwalBulanBerjalanD=sum(case when a.Perkiraan=@Perkiraan then a.Debet       
                                              when a.Lawan=@Perkiraan then -a.Debet
                                              else 0              
                                         end) 
      from dbTransaksi a
      where a.Tanggal<@tglAw and  (a.Perkiraan=@Perkiraan or a.Lawan=@Perkiraan)
		and YEAR(a.Tanggal)=YEAR(@tglAw) and MONTH(a.Tanggal)=MONTH(@TglAw)
      set @SaldoAwal=@SaldoAwal+isnull(@SaldoAwalBulanBerjalan,0)
      set @SaldoAwalD=@SaldoAwalD+isnull(@SaldoAwalBulanBerjalanD,0)
    end
    Select @SaldoGiro=SUM(Case when NoGiro like '%T' then 0.00 else A.DebetRp end), 
           @SaldoGiroTolakan=SUM(Case when NoGiro like '%T' then A.DebetRp else 0.00 end)
    from DBGIRO A
    where A.Tipe='PT' and A.TglBuka<=@TglAk and (A.TglCair>@TglAk or a.TglCair is null) 
    and BuktiBuka not like '+%' --(giro gempol)
    select @SaldoAwal SaldoAwal, @SaldoAwalD SaldoAwalD, 
		(select sum(Debet-Kredit) from dbBon where Tanggal<=@TglAk and Devisi=@Divisi and Perkiraan=@Perkiraan and KodeVls='IDR') SaldoBon,
		(select sum(Debet-Kredit) from dbBon where Tanggal<=@TglAk and Devisi=@Divisi and Perkiraan=@Perkiraan and KodeVls='U$') SaldoBonD,
		(select sum(Debet-Kredit) from dbBon where Tanggal<=@TglAk and Devisi=@Divisi and Perkiraan=@Perkiraan and KodeVls='EUR') SaldoBonE, 
		(select sum(Debet-Kredit) from dbBon where Tanggal<=@TglAk and Devisi=@Divisi and Perkiraan=@Perkiraan and KodeVls='AUD') SaldoBonA,
		(select sum(Debet-Kredit) from dbBon where Tanggal<=@TglAk and Devisi=@Divisi and Perkiraan=@Perkiraan and KodeVls='DH') SaldoBonDH,
		@SaldoGiro SaldoGiro, @SaldoGiroTolakan SaldoGiroTolakan

Select * from DBBON

GO

-- Procedure: sp_LapSusutAktiva
-- Created: 2011-03-03 13:17:25.603 | Modified: 2011-03-03 13:17:25.603
-- =====================================================




CREATE  PROCEDURE [dbo].[sp_LapSusutAktiva]
@bulan int,
@tahun int,
@Divisi varchar(20)
as
if @Divisi<>'-'
begin
 select distinct left(a.Perkiraan,11) as GrpPerkiraan, a.Devisi, a.Perkiraan, a.Keterangan, a.Quantity, a.Persen, a.Tanggal, Kode=substring(a.Perkiraan,1,3), 
	NilaiAk_=((select sum(isnull(d.awal,0)+case when d.Bulan=1 then 0 else isnull(d.md,0)-isnull(d.mk,0) end) from dbaktivadet d 
   where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)-
   (select sum(isnull(d.awalsusut,0)+case when d.Bulan=1 then 0 else isnull(d.sk,0)-isnull(d.sd,0) end) from dbaktivadet d 
   where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)),
  awal=(select sum(isnull(d.awal,0)+case when d.Bulan=@Bulan then 0 else isnull(d.md,0)-isnull(d.mk,0) end) from dbaktivadet d 
                 where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),

  MD=isnull((select isnull(d.md,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  MK=isnull((select isnull(d.mk,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  akhir=(select sum(isnull(d.awal,0)+isnull(d.md,0)-isnull(d.mk,0)) from dbaktivadet d 
                 where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),
  AwalSusut=(select sum(isnull(d.awalsusut,0)+case when d.Bulan=@Bulan then 0 else isnull(d.sk,0)-isnull(d.sd,0) end) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),


  awalSusutJan=(select isnull(d.awalsusut,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan=1 and d.tahun=@tahun),
 
  SK=isnull((select isnull(d.sk,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  SD=isnull((select isnull(d.sd,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  AkhirSusut=(select sum(isnull(d.awalsusut,0)+isnull(d.sk,0)-isnull(d.sd,0)) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),
  SusutTahun=(select sum(isnull(d.sk,0)-isnull(d.sd,0)) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),

  NilaiAk=((select sum(isnull(d.awal,0)+isnull(d.md,0)-isnull(d.mk,0)) from dbaktivadet d 
   where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)-
   (select sum(isnull(d.awalsusut,0)+isnull(d.sk,0)-isnull(d.sd,0)) from dbaktivadet d 
   where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)),
   b.Keterangan NamaPerkiraan 
 from dbaktiva A 
      left outer join dbperkiraan b on b.perkiraan=left(a.Perkiraan,11)
 where a.Devisi=@Divisi and
  ((case when @bulan=1 then 
     (select isnull(d.awal,0) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan=@bulan and d.tahun=@tahun)
         else
    (select sum(isnull(d.awal,0)+isnull(d.md,0)-isnull(d.mk,0)) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<@bulan and d.tahun=@tahun)
            end)<> 0 or
  isnull((select isnull(d.md,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0)<> 0 or
  isnull((select isnull(d.mk,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0)<> 0)
 order by a.devisi,a.Perkiraan
end
if @Divisi='-'
begin
 select distinct left(a.Perkiraan,11) as GrpPerkiraan, a.Devisi, a.Perkiraan, a.Keterangan, a.Quantity, a.Persen, a.Tanggal, Kode=substring(a.Perkiraan,1,3), 
NilaiAk_=((select sum(isnull(d.awal,0)+case when d.Bulan=1 then 0 else isnull(d.md,0)-isnull(d.mk,0) end) from dbaktivadet d 
   where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)-
   (select sum(isnull(d.awalsusut,0)+case when d.Bulan=1 then 0 else isnull(d.sk,0)-isnull(d.sd,0) end) from dbaktivadet d 
   where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)),
  awal=(select sum(isnull(d.awal,0)+case when d.Bulan=@Bulan then 0 else isnull(d.md,0)-isnull(d.mk,0) end) from dbaktivadet d 
                 where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),
  MD=isnull((select sum(isnull(d.md,0)) from dbaktivadet d where d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  MK=isnull((select sum(isnull(d.mk,0)) from dbaktivadet d where d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  akhir=(select sum(isnull(d.awal,0)+isnull(d.md,0)-isnull(d.mk,0)) from dbaktivadet d 
                 where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),
  AwalSusut=(select sum(isnull(d.awalsusut,0)+case when d.Bulan=@Bulan then 0 else isnull(d.sk,0)-isnull(d.sd,0) end) from dbaktivadet d 
    where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),

  awalSusutJan=(select sum(isnull(d.awalsusut,0)) from dbaktivadet d where d.perkiraan=a.perkiraan and d.bulan=1 and d.tahun=@tahun),

  SK=isnull((select sum(isnull(d.sk,0)) from dbaktivadet d where d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  SD=isnull((select sum(isnull(d.sd,0)) from dbaktivadet d where d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0),
  AkhirSusut=(select sum(isnull(d.awalsusut,0)+isnull(d.sk,0)-isnull(d.sd,0)) from dbaktivadet d 
    where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),
  SusutTahun=(select sum(isnull(d.sk,0)-isnull(d.sd,0)) from dbaktivadet d 
    where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun),

  NilaiAk=((select sum(isnull(d.awal,0)+isnull(d.md,0)-isnull(d.mk,0)) from dbaktivadet d 
   where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)-
   (select sum(isnull(d.awalsusut,0)+isnull(d.sk,0)-isnull(d.sd,0)) from dbaktivadet d 
   where d.perkiraan=a.perkiraan and d.bulan<=@bulan and d.tahun=@tahun)),
   b.Keterangan NamaPerkiraan  
 from dbaktiva A
      left outer join dbperkiraan b on b.perkiraan=left(a.Perkiraan,11)
where ((case when @bulan=1 then 
     (select isnull(d.awal,0) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan=@bulan and d.tahun=@tahun)
         else
    (select sum(isnull(d.awal,0)+isnull(d.md,0)-isnull(d.mk,0)) from dbaktivadet d 
    where d.devisi=a.devisi and d.perkiraan=a.perkiraan and d.bulan<@bulan and d.tahun=@tahun)
            end)<> 0 or
  isnull((select isnull(d.md,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0)<> 0 or
  isnull((select isnull(d.mk,0) from dbaktivadet d where d.devisi=a.devisi and d.perkiraan=a.perkiraan and 
   d.bulan=@bulan and d.tahun=@tahun),0)<> 0)
 order by a.devisi,a.Perkiraan
end



GO

-- Procedure: SP_LokalInvoicePL
-- Created: 2011-09-29 11:43:33.437 | Modified: 2011-09-29 11:43:33.437
-- =====================================================


Create Procedure [dbo].[SP_LokalInvoicePL]
@Choice varchar(1),
@nobukti varchar(30),
@nourut varchar(5),
@Tanggal datetime,
@NoSpp varchar(30),
@kodecustSupp varchar(15),
@Consignee varchar(8000),
@notifyParty varchar(8000),
@ContractNo Varchar(30),
@PoNo varchar(50),
@PaymentTerm varchar(8000),
@DocCreditNo varchar(50),
@PoL varchar(50),
@PoD varchar(50),
@NameOfVessel varchar(50),
@ShipOnBoardDate datetime,
@Packing varchar(8000),
@Others varchar(5000),
@IDUser varchar(15),
@Urut  int,
@UrutSPP Int,
@KodeBrg varchar(25),
@Ppn tinyint,
@Disc numeric(18,2),
@Kurs numeric(18,4),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@NoSat tinyint,
@isi numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2),
@harga numeric(18,4),
@DiscP numeric(18,2),
@DiscRp numeric(18,2),
@DiscTot numeric(18,2),
@ketDetail varchar(500),
@Valas varchar(15),
@IsLokal bit 
AS
begin Tran
if @Choice='I'
begin
  Select @urut=Max(Urut) from dbLokalInvoicePLDet where nobukti=@nobukti
  Set @Urut=ISNULL(@urut,0)+1
  if not Exists(Select 'true' from dbLokalInvoicePL where NoBukti=@nobukti)
  begin
    insert into dbLokalInvoicePL(NoBukti,NoUrut,Tanggal,NoSPP,KodeCustSupp,Consignee,NotifyParty,ContractNo,PONo,PaymentTerm,DocCreditNo,PoL,PoD,NameOfVessel,ShipOnBoardDate,Packing,Others,IDUser, Valas,Kurs,PPN,IsLokal) 
    Values (@nobukti,@nourut,@Tanggal,@NoSpp,@KodeCustSupp,@Consignee,@notifyParty,@ContractNo,@PoNo,@PaymentTerm,@DocCreditNo,@PoL,@PoD,@NameOfVessel,@ShipOnBoardDate,@Packing,@Others,@IDUser, @Valas,@Kurs,@PPN,@IsLokal)
  end
  Insert into dbLokalInvoicePLDet(NoBukti, Urut, NoSPP, UrutSPP, KodeBrg, PPN, DISC, KURS, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, HARGA, DiscP, DiscRp, DISCTOT, KetDetail)
  Values (@nobukti, @Urut, @NoSpp, @UrutSPP, @KodeBrg, @Ppn, @Disc, @Kurs, @Qnt, @Qnt2, @Sat_1, @Sat_2, @NoSat, @isi, @NetW, @GrossW, @harga,
          @DiscP, @DiscRp, @DISCTOT,@ketDetail)                                      
end
else if @Choice='U'
begin
 update dbLokalInvoicePLDet set NoSPP=@NoSPP, UrutSPP=@UrutSPP, KodeBrg=@KodeBrg, PPN=@Ppn, DISC=@Disc, KURS=@Kurs, QNT=@Qnt, QNT2=@Qnt2, SAT_1=@Sat_1, SAT_2=@Sat_2, 
                           NOSAT=@NoSat, ISI=@isi, NetW=@NetW, GrossW=@GrossW, 
                           HARGA=@harga, DiscP=@DiscP, DiscRp=@DiscRp, DISCTOT=@DiscTot,KetDetail=@ketDetail

 where NoBukti=@nobukti and Urut=@Urut
end
else if @Choice='D'
begin
  delete dbLokalInvoicePLDet where NoBukti=@nobukti and Urut=@Urut
  if not exists(select 'True' from dbLokalInvoicePLDet where NoBukti=@nobukti)
     delete dbLokalInvoicePL where NoBukti=@nobukti 
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return





GO

-- Procedure: SP_LR
-- Created: 2011-02-07 13:22:22.127 | Modified: 2011-06-01 16:33:17.537
-- =====================================================
CREATE PROCEDURE [dbo].[SP_LR]
@Choice char(1),
@Devisi varchar(5)='',
@Nomor varchar(15)='',
@Perkiraan varchar(15)='',
@Keterangan varchar(50)='',                       
@Grup varchar(3)='',
@Tipe varchar(3)='',
@Tanda varchar(3)='',
@Jumlah varchar(3)='',
@Persen varchar(3)='',
@Tampil varchar(3)='',
@bulan int,
@Tahun int,
@isLRHpp bit
AS
begin tran
if @choice='I'
begin
 insert into dbLRHPP (Devisi, Nomor, Perkiraan, Keterangan, Grup, Tipe, Tanda, Jumlah, Persen, Tampil,bulan, Tahun,IsLRHPP)
 values (@Devisi, @Nomor, @Perkiraan, @Keterangan, @Grup, @Tipe, @Tanda, @Jumlah, @Persen, @Tampil, @bulan, @Tahun,@isLRHpp)
 if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
 update dbLRHPP set Perkiraan=@Perkiraan, Keterangan=@Keterangan, Grup=@Grup, Tipe=@Tipe, Tanda=@Tanda, Jumlah=@Jumlah, 
      Persen=@Persen, Tampil=@Tampil
 where Devisi=@Devisi and Nomor=@Nomor and bulan=@bulan and tahun=@Tahun and IsLRHPP=@isLRHpp
if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
 delete  dbLRHPP where Devisi=@Devisi and Nomor=@Nomor and bulan=@bulan and tahun=@Tahun
 if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return

GO

-- Procedure: Sp_MasterArusKas
-- Created: 2023-12-07 11:57:15.140 | Modified: 2023-12-07 11:57:15.140
-- =====================================================

Create PROCEDURE [dbo].[Sp_MasterArusKas]
@Choice char(1),
@KodeGrp Varchar(15),
@NamaGrp Varchar(50)
 AS
begin tran
if @choice='I'
begin
  insert into DBArusKas(KodeAK, NamaAK)
  values (@KodeGrp, @NamaGrp)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update DBArusKas set NamaAK=@NamaGrp 
             where KodeAK=@KodeGrp
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  DBArusKas where KodeAK=@KodeGrp
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_MasterLapArusKas
-- Created: 2023-12-07 11:56:52.500 | Modified: 2023-12-07 11:56:52.500
-- =====================================================

Create PROCEDURE [dbo].[Sp_MasterLapArusKas]
@Choice char(1),
@Nomor Varchar(25)='',
@Urutan Varchar(20)='',
@Keterangan Varchar(100)='',
@Tipe Int=0,
@KodeAK Varchar(15)='',
@KodeSAK Varchar(15)=''

 AS
begin tran
if @choice='I'
begin
  insert into DBArusKasKonfig(Nomor, Urutan, Keterangan,Tipe,KodeAK,KodeSAK)
  values (@Nomor, @Urutan,@Keterangan,@Tipe,@KodeAK,@KodeSAK)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update DBArusKasKonfig set Nomor=@Nomor, Urutan=@Urutan, Keterangan=@Keterangan,Tipe=@Tipe,KodeAK=@KodeAK,KodeSAK=@KodeSAK
             where nomor=@Nomor
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete DBArusKasKonfig where nomor=@Nomor
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_MasterLapPerubahanAset
-- Created: 2024-01-31 23:00:13.357 | Modified: 2024-01-31 23:00:13.357
-- =====================================================

create PROCEDURE [dbo].[Sp_MasterLapPerubahanAset]
@Choice char(1),
@Nomor Varchar(25)='',
@Urutan Varchar(20)='',
@Keterangan Varchar(100)='',
@Tipe Int=0,
@KodeAK Varchar(15)='',
@KodeSAK Varchar(15)=''

 AS
begin tran
if @choice='I'
begin
  insert into DBPerubahanAsetKonfig(Nomor, Urutan, Keterangan,Tipe,KodePAN,KodeSubPan)
  values (@Nomor, @Urutan,@Keterangan,@Tipe,@KodeAK,@KodeSAK)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update DBPerubahanAsetKonfig set Nomor=@Nomor, Urutan=@Urutan, Keterangan=@Keterangan,Tipe=@Tipe,KodePan=@KodeAK,KodeSubPan=@KodeSAK
             where nomor=@Nomor
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete DBPerubahanAsetKonfig where nomor=@Nomor
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_MasterPerubahanAset
-- Created: 2024-02-01 12:37:26.960 | Modified: 2024-02-01 12:37:26.960
-- =====================================================

Create PROCEDURE [dbo].[Sp_MasterPerubahanAset]
@Choice char(1),
@KodeGrp Varchar(15),
@NamaGrp Varchar(50)
 AS
begin tran
if @choice='I'
begin
  insert into DBPerubahanAset (KodePAN, NamaPAN )
  values (@KodeGrp, @NamaGrp)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
	update DBPerubahanAset set NamaPAN=@NamaGrp 
             where KodePAN =@KodeGrp
	if @@error <> 0 goto jikasalah
end
else
if @choice='D'
begin
	delete  DBPerubahanAset where KodePAN =@KodeGrp
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_MasterProses
-- Created: 2014-07-25 14:01:49.817 | Modified: 2014-07-25 14:01:49.817
-- =====================================================



Create PROCEDURE [dbo].[Sp_MasterProses]
@Choice char(1),
@KodePRs Varchar(15),
@Keterangan Varchar(40),
@Kodegdg Varchar(15)

AS
begin tran
if @choice='I'
begin
  insert into dbProses (KodePrs,Keterangan,KodeGdg)
  values (@KodePRs, @Keterangan, @Kodegdg)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
    update dbProses 
    set Keterangan=@Keterangan, KODEGDG=@Kodegdg
    where KodePrs=@KodePRs
    if @@error <> 0
     goto jikasalah
end
if @choice='D'
begin
   delete dbProses 
   where KodePrs=@KodePRs
   
   if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return





GO

-- Procedure: Sp_Menu
-- Created: 2011-08-04 08:51:54.687 | Modified: 2011-08-04 08:51:54.687
-- =====================================================

CREATE Procedure [dbo].[Sp_Menu]
@Choice varchar(1),
@Kodemenu varchar(25),
@Keterangan varchar(500),
@OL tinyint,
@L0 tinyint,
@ACCESS int,
@OldKode varchar(25)
As
begin tran
if @Choice='I'
begin
  Insert into dbmenu (kodeMenu,Keterangan,OL, L0, ACCESS)
  Values(@Kodemenu,@Keterangan,@OL, @L0, @ACCESS)
end if @Choice='U'
begin
  update dbmenu set kodemenu=@Kodemenu, Keterangan=@Keterangan, OL=@OL,
                    L0=@L0, ACCESS=@ACCESS 
  where kodemenu=@Kodemenu
end else if @Choice='D'
begin
  delete dbmenu 
  where kodemenu=@Kodemenu
end
if @@ERROR<>0 Goto JikaSalah
commit tran
Return
JikaSalah: Rollback Tran
           Return

GO

-- Procedure: Sp_MERK
-- Created: 2015-03-31 14:33:00.737 | Modified: 2015-03-31 14:33:00.737
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_MERK]
@Choice char(1),
@KODEMERK Varchar(15),
@NAMAMERK Varchar(40)
AS
begin tran
if @choice='I'
begin
	insert into DBMERK (KODEMERK, NAMAMERK)
	values (@KODEMERK, @NAMAMERK)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBMERK set NAMAMERK=@NAMAMERK
             where KODEMERK=@KODEMERK
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBMERK where KODEMERK=@KODEMERK
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: Sp_Mesin
-- Created: 2010-12-10 09:50:01.160 | Modified: 2014-07-25 14:02:20.370
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_Mesin]
@Choice char(1)='',
@KodeMsn Varchar(15)='',
@Ket Varchar(100)='',
@KodePrs varchar(15)='',
@Kapasitas Numeric(18,2)=0
AS
begin tran
if @choice='I'
begin
	insert into dbMesin (KodeMsn, Ket,KodePrs,Kapasitas)
	values (@KodeMsn, @Ket,@KodePrs,@Kapasitas)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbMesin set Ket=@Ket,KodePrs=@KodePrs,Kapasitas=@Kapasitas
             where KodeMsn=@KodeMsn
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbMesin where KodeMsn=@KodeMsn
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: sp_NerajaLajur
-- Created: 2011-03-17 11:44:10.153 | Modified: 2024-08-04 19:18:03.437
-- =====================================================


CREATE PROCEDURE [dbo].[sp_NerajaLajur] 
@Masuk varchar(1),
@Bulan int,
@Tahun int,
@Devisi varchar(10),
@IdUser varchar(15)
--select @masuk='D',@bulan=5,@tahun=2008,@iduser='sa',@devisi='01'
AS
 Set @Devisi=Case when @Devisi in ('-','') then '%' else @Devisi end 
 select A.Perkiraan,a.keterangan,
 case when a.DK=0 then b.AwalDRp 
      else 0
 end as SaldoAwD,
 case when a.DK=1 then b.AwalKRp 
      else 0
 end as SaldoAwk,
 MD=b.MDRp,
 MK=b.MKRp,
 JPD=b.JPDRp,
 JPK=b.JPKRp,
 RLD=b.RLDRp,
 RLK=b.RLKRp,
 case when a.DK=0 then b.AkhirDRp
      else 0
 end as SaldoAkD,
 case when a.DK=1 then b.AkhirKRp
      else 0
 end as SaldoAkK
 from dbPerkiraan A
      left outer join DBNERACA b on b.Perkiraan=A.Perkiraan
 where
 a.Perkiraan in (select perkiraan from dbAksesPerkiraan where userid=@IdUser) and 
 (b.AwalDRp<>0 or b.AwalKRp<>0 or b.MDRp<>0 or b.MKRp<>0 or b.JPDRp<>0 or b.JPKRp<>0 or b.RLDRp<>0 or b.RLKRp<>0 or
  b.AkhirDRp<>0 or b.AkhirKRp<>0) and b.Devisi like @Devisi
  and b.Bulan=@Bulan and b.Tahun=@Tahun and isnull(a.IsNonLedger,0)=0 --and IsInvestasi =0
  order by a.perkiraan


GO

-- Procedure: SP_OutstandingPO
-- Created: 2025-08-21 08:54:48.783 | Modified: 2025-08-21 08:54:48.783
-- =====================================================

    CREATE PROCEDURE SP_OutstandingPO
        @TanggalCutOff DATE = NULL,
        @KODESUPP NVARCHAR(20) = NULL
    AS
    BEGIN
        SET NOCOUNT ON;
        
        IF @TanggalCutOff IS NULL
            SET @TanggalCutOff = GETDATE();
        
        SELECT 
            p.NOBUKTI,
            p.TANGGAL,
            p.KODESUPP,
            cs.NAMACUSTSUPP AS NamaSupplier,
            pd.KODEBRG,
            b.NAMABRG,
            pd.QNT AS QtyOrder,
            ISNULL(pd.QntBatal, 0) AS QtyReceived,
            (pd.QNT - ISNULL(pd.QntBatal, 0)) AS QtyOutstanding,
            pd.HARGA,
            ((pd.QNT - ISNULL(pd.QntBatal, 0)) * pd.HARGA) AS NilaiOutstanding,
            DATEDIFF(DAY, p.TANGGAL, @TanggalCutOff) AS HariTunggu
        FROM DBPO p
        INNER JOIN DBPODET pd ON p.NOBUKTI = pd.NOBUKTI
        INNER JOIN DBCUSTSUPP cs ON p.KODESUPP = cs.KODECUSTSUPP
        INNER JOIN DBBARANG b ON pd.KODEBRG = b.KODEBRG
        WHERE p.IsClose = 0 
            AND p.IsBatal = 0
            AND (pd.QNT - ISNULL(pd.QntBatal, 0)) > 0
            AND (@KODESUPP IS NULL OR p.KODESUPP = @KODESUPP)
        ORDER BY p.TANGGAL, p.NOBUKTI, pd.URUT;
    END
    
GO

-- Procedure: Sp_PajakMasuk
-- Created: 2011-09-30 13:35:13.987 | Modified: 2011-09-30 13:35:13.987
-- =====================================================

CREATE Procedure [dbo].[Sp_PajakMasuk]
@Choice varchar(1),
@NoBukti varchar(50),
@Urut int,
@NoFPJ varchar(50),
@TglFpj datetime,
@nPPn numeric(18,2),
@TglLaporFpj datetime,
@TipePph int,
@NoPph varchar(50),
@TglPPh datetime,
@nPPh numeric(18,2),
@TglLaporPPh datetime,
@npwp varchar(50),
@NamaPKP varchar(100),
@AlamatPkp1 varchar(100),
@AlamatPkp2 varchar(100),
@kotaPKP varchar(100)
AS
begin Tran
if @Choice='I'
begin
  Select @Urut=Max(urut) from DBPajakMasuk where NoBukti=@NoBukti
  Set @Urut=ISNULL(@Urut,0)+1
  Insert into DBPajakMasuk ( NoBukti, Urut, NOFPJ, TGLFPJ, NPPn, TglLaporFPJ, TipePPh, NoPPh, TglPPh, 
                             nPPh, TglLaporPPh, NPWP, NamaPKP, AlamatPKP1, AlamatPKP2, KotaPKP)
  Values ( @NoBukti, @Urut, @NoFPJ, @TglFpj, @nPPn, @TglLaporFpj, @TipePph, @NoPph, @TglPPh, 
           @nPPh, @TglLaporPPh, @npwp, @NamaPKP, @AlamatPkp1, @AlamatPkp2, @kotaPKP)                             
end else if @Choice='U'
begin
  update DBPajakMasuk Set NOFPJ=@NoFPJ , TGLFPJ=@TglFpj, NPPn=@nPPn, TglLaporFPJ=@TglLaporFpj, 
                          TipePPh=@TipePph, NoPPh=@NoPph, TglPPh=@TglPPh, nPPh=@nPPh, 
                          TglLaporPPh=@TglLaporPPh, NPWP=@npwp, NamaPKP=@NamaPKP, 
                          AlamatPKP1=@AlamatPkp1, AlamatPKP2=@AlamatPkp2, KotaPKP=@kotaPKP
  where NoBukti=@NoBukti and Urut=@Urut
end else if @Choice='D'
begin
  Delete DBPajakMasuk
  where NoBukti=@NoBukti and Urut=@Urut
end
if @@ERROR<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return




GO

-- Procedure: sp_PBiaya
-- Created: 2013-03-09 10:59:35.180 | Modified: 2013-03-09 10:59:35.180
-- =====================================================
CREATE PROCEDURE [dbo].[sp_PBiaya]
@choice varchar(1),
@KodeBiaya varchar(15),
@Keterangan varchar(200),
@Nilai Numeric(18,2),
@KodeVls varchar(15),
@Kurs Numeric(18,2),
@NoBuktiInv Varchar(30),
@OldKode varchar(15)='',
@urut Integer=0

AS

if @choice='I'
begin
    select @urut=isnull(max(urut),0)+1 from dbPBiaya Where NoBuktiInv=@NoBuktiInv
    If @urut is null Set @urut=1
	insert into dbPBiaya(KodeBiaya,Keterangan,Nilai,KodeVls, Kurs,NoBuktiInv,Urut)
	values (@KodeBiaya,@Keterangan,@Nilai,@KodeVls, @Kurs,@NoBuktiInv,@urut)
end
if @choice='U'
begin
	Update dbPBiaya set KodeBiaya=@KodeBiaya,Keterangan=@Keterangan,Nilai=@Nilai,NoBuktiInv=@NoBuktiInv,
		                KodeVls=@KodeVls, Kurs=@Kurs
	where KodeBiaya=@OldKode and Urut=@urut
end
if @choice='D'
begin
	delete dbPBiaya
	where KodeBiaya=@OldKode and Urut=@urut
end








GO

-- Procedure: SP_PemakaianBhn
-- Created: 2011-11-21 09:59:45.440 | Modified: 2011-11-21 09:59:45.440
-- =====================================================


Create Procedure [dbo].[SP_PemakaianBhn]
@Choice Varchar(1),
@NoBukti Varchar(30),
@NoUrut varchar(10),
@Tanggal Datetime,
@KodeGdg varchar(15),
@Note varchar(200),
@Urut int,
@KodeBrg varchar(25),
@SaldoComp numeric(18,2),
@QntOpname numeric(18,2),
@Selisih numeric(18,2),
@QntDB numeric(18,2),
@QntCR numeric(18,2),
@SaldoComp2 numeric(18,2),
@QntOpname2 numeric(18,2),
@Selisih2 numeric(18,2),
@QntDB2 numeric(18,2),
@QntCR2 numeric(18,2),
@Harga numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@IDUser varchar(30)

As

Begin tran
if @choice='I'
begin
  	select @urut=isnull(max(urut),0)+1 from DBPemakaianBhndet Where NoBukti=@NoBukti
  	If @urut is null Set @urut=1
  	if not exists(select * from DBPemakaianBhn Where NoBukti=@NoBukti) 
  	begin
    		insert into DBPemakaianBhn (NOBUKTI, NOURUT, TANGGAL,KodeGdg,NOTE,IDUser)
    		values (@NOBUKTI, @NOURUT, @TANGGAL,@KodeGdg,@NOTE, @IDUser)
		if @@error<>0  goto jikasalah
  	end
  	insert into DBPemakaianBhnDET (NOBUKTI,URUT,KODEBRG, Nosat, Isi, Sat_1, Sat_2,
                            SaldoComp,QntOpname,Selisih,QNTDB,QNTCR, HARGA,SaldoComp2,QntOpname2,Selisih2,QNTDB2,QNTCR2)
  	values(@NOBUKTI,@URUT,@KODEBRG, @Nosat, @Isi, @Sat_1, @Sat_2, 
         		@SaldoComp,@QntOpname,@Selisih,@QNTDB,@QNTCR, @HARGA,@SaldoComp2,@QntOpname2,@Selisih2,@QNTDB2,@QNTCR2)
	if @@error<>0  goto jikasalah
end
if @choice='U'
begin
  	update DBPemakaianBhnDET set Kodebrg=@KODEBRG, Nosat=@NoSat, Isi=@Isi, Sat_1=@Sat_1, Sat_2=@Sat_2, 
         		SaldoComp=@SaldoComp,QntOpname=@QntOpname,Selisih=@Selisih,QntDb=@QNTDB,QntCR=@QNTCR, Harga=@HARGA,
		SaldoComp2=@SaldoComp2,QntOpname2=@QntOpname2,Selisih2=@Selisih2,QntDb2=@QNTDB2,QntCR2=@QNTCR2
  	where nobukti=@nobukti and urut=@urut
	if @@error<>0  goto jikasalah
end
if @choice='D'
begin
  	delete DBPemakaianBhnDET where nobukti=@nobukti and  urut=@urut 
	if @@error<>0  goto jikasalah
  	if not exists( select nobukti from DBPemakaianBhnDET where nobukti=@nobukti)
  	begin
    		delete DBPemakaianBhn where nobukti=@nobukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: sp_PembayaranPO
-- Created: 2012-12-03 14:57:34.557 | Modified: 2012-12-03 16:54:08.470
-- =====================================================






CREATE Procedure [dbo].[sp_PembayaranPO]
@Choice varchar(1),
@NoBukti varchar(20)='',
@Keterangan varchar(200)='',
@KodeVls varchar(15)='',
@DP Bit=False,
@Persentase numeric(5,2)=0,
@Nilai Numeric(18,2)=0,
@OldKet Varchar(200)=''
As
Begin tran
if @Choice='I'
begin
   insert into [DBPembayaranPO] (NOBUKTI,Keterangan, DP,Persentase,KodeVls,Nilai)
   values (@NOBUKTI, @Keterangan, @DP, @Persentase,@KodeVls,@Nilai)
end
if @Choice='U'
begin 
  update [DBPembayaranPO] set Keterangan=@Keterangan, DP=@DP,Persentase=@Persentase,KodeVls=@KodeVls,Nilai=@Nilai 
  where NoBukti=@NoBukti and Keterangan=@OldKet
end
if @Choice='D'
begin
  delete [DBPembayaranPO] where NoBukti=@NoBukti and Keterangan=@OldKet
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: sp_Pembelian
-- Created: 2012-06-07 15:00:46.327 | Modified: 2012-06-07 15:00:46.327
-- =====================================================
CREATE Procedure [dbo].[sp_Pembelian]
@Choice Varchar(1),
@NoBukti varchar(50),
@Urut int,
@Tanggal datetime,
@JatuhTempo datetime,
@KodeCustSupp varchar(25),
@PPn TinyInt,
@KodeTipe varchar(25),
@KodeSubTipe varchar(25),
@Qnt numeric(18,2),
@Harga numeric(18,2),
@NDPP numeric(18,2),
@NPPN numeric(18,2),
@NNET numeric(18,2),
@AccPersediaan varchar(25),
@AccPPN varchar(25),
@AccHutPiut varchar(25),
@IsExcel bit,
@KodeVls varchar(20),
@kurs numeric(18,2),
@NDPPD numeric(18,2),
@NPPND numeric(18,2),
@NNETD numeric(18,2)


as

begin tran

if @Choice='I'
begin
	insert into DBPembelian(NoBukti,Urut,Tanggal,JatuhTempo,KodeCustSupp,PPn,
		KodeTipe,KodeSubTipe,Qnt,Harga,NDPP,NPPN,NNet,
		KodeVls, Kurs, NDPPD, NPPND, NNetD,
		AccPersediaan,AccPPN,AccHutPiut,IsExcel)
	Values(@NoBukti,@Urut,@Tanggal,@JatuhTempo,@KodeCustSupp,@PPn,
		@KodeTipe,@KodeSubTipe,@Qnt,@Harga,@NDPP,@NPPN,@NNET,
		@KodeVls, @Kurs, @NDPPD, @NPPND, @NNetD,
		@AccPersediaan,@AccPPN,@AccHutPiut,@IsExcel)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
	update DBPembelian set Tanggal=@Tanggal, JatuhTempo=@JatuhTempo, KodeCustSupp=@KodeCustSupp,
	PPn=@PPn, KodeTipe=@KodeTipe, KodeSubTipe=@KodeSubTipe, Qnt=@Qnt, Harga=@Harga,
	NDPP=@NDPP, NPPN=@NPPN, NNET=@NNET, KodeVls=@KodeVls, Kurs=@Kurs, 
	NDPPD=@NDPPD, NPPND=@NPPND, NNetD=@NNetD,
	AccPersediaan=@AccPersediaan, AccPPN=@AccPPN, AccHutPiut=@AccHutPiut
	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
else if @Choice='D'
begin
	Delete DBPembelian where NoBukti=@Nobukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
Commit Tran
Return
JikaSalah: RollBack Tran
           Return



GO

-- Procedure: Sp_PenerimaanBrgJadi
-- Created: 2011-08-05 10:16:59.493 | Modified: 2011-09-28 16:03:17.170
-- =====================================================

CREATE Procedure [dbo].[Sp_PenerimaanBrgJadi]
@Choice varchar(1),
@NoBukti Varchar(30),
@Nourut varchar(5),
@Tanggal Datetime,
@Keterangan Varchar(500),
@Urut int,
@Kodebrg varchar(25),
@Qnt numeric(18,2),
@Qnt2 Numeric(18,2),
@Sat_1 Varchar(5),
@Sat_2 Varchar(5),
@Nosat int,
@Isi numeric(18,2),
@Kodegdg varchar(15),
@Shift Varchar(50),
@NoPenyerahan Varchar(50)
As
begin Tran
If @Choice='I'
begin
  Select @Urut=MAX(Urut) from dbPenerimaanBrgJadidet where nobukti=@NoBukti
  Set @Urut=ISNULL(@urut,0)+1
  If not Exists(Select 'True' From dbPenerimaanbrgjadi where nobukti=@NoBukti)
  begin
    Insert into dbPenerimaanbrgjadi(Nobukti,Nourut,Tanggal,Keterangan, Shift, NoPenyerahan)
    Values(@NoBukti, @Nourut, @Tanggal, @Keterangan, @Shift, @NoPenyerahan)
  end
  Insert into dbPenerimaanbrgjadidet (Nobukti, Urut, kodebrg, Qnt, Qnt2, Sat_1, Sat_2, Nosat, Isi, Kodegdg)
  Values(@NoBukti, @Urut, @Kodebrg, @Qnt, @Qnt2, @Sat_1, @Sat_2, @Nosat, @Isi, @Kodegdg)
end
else if @Choice='U'
begin
  update dbpenerimaanbrgjadidet set Kodebrg=@Kodebrg, Qnt=@Qnt, Qnt2=@Qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
                                    Nosat=@Nosat, Isi=@Isi, Kodegdg=@Kodegdg
  where nobukti=@NoBukti and Urut=@Urut
end else if @Choice='D'
begin
  delete dbpenerimaanbrgjadidet 
  where nobukti=@NoBukti and Urut=@Urut
  If not Exists(Select 'True' From dbPenerimaanbrgjadidet where nobukti=@NoBukti)
  delete dbpenerimaanbrgjadi
  where nobukti=@NoBukti 
end
if @@error<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return



GO

-- Procedure: sp_Penjualan
-- Created: 2012-06-07 15:01:21.763 | Modified: 2012-06-07 15:01:21.763
-- =====================================================
CREATE Procedure [dbo].[sp_Penjualan]
@Choice Varchar(1),
@NoBukti varchar(50),
@Urut int,
@Tanggal datetime,
@JatuhTempo datetime,
@KodeCustSupp varchar(25),
@PPn TinyInt,
@KodeTipe varchar(25),
@KodeSubTipe varchar(25),
@Qnt numeric(18,2),
@Harga numeric(18,2),
@NDPP numeric(18,2),
@NPPN numeric(18,2),
@NNET numeric(18,2),
@AccPersediaan varchar(25),
@AccPPN varchar(25),
@AccHutPiut varchar(25),
@IsExcel bit,
@KodeVls varchar(20),
@kurs numeric(18,2),
@NDPPD numeric(18,2),
@NPPND numeric(18,2),
@NNETD numeric(18,2)

as

begin tran

if @Choice='I'
begin
	insert into DBPenjualan(NoBukti,Urut,Tanggal,JatuhTempo,KodeCustSupp,PPn,
		KodeTipe,KodeSubTipe,Qnt,Harga,NDPP,NPPN,NNet,
		KodeVls, Kurs, NDPPD, NPPND, NNetD,
		AccPersediaan,AccPPN,AccHutPiut,IsExcel)
	Values(@NoBukti,@Urut,@Tanggal,@JatuhTempo,@KodeCustSupp,@PPn,
		@KodeTipe,@KodeSubTipe,@Qnt,@Harga,@NDPP,@NPPN,@NNET,
		@KodeVls, @Kurs, @NDPPD, @NPPND, @NNetD,
		@AccPersediaan,@AccPPN,@AccHutPiut,@IsExcel)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
	update DBPenjualan set Tanggal=@Tanggal, JatuhTempo=@JatuhTempo, KodeCustSupp=@KodeCustSupp,
	PPn=@PPn, KodeTipe=@KodeTipe, KodeSubTipe=@KodeSubTipe, Qnt=@Qnt, Harga=@Harga,
	NDPP=@NDPP, NPPN=@NPPN, NNET=@NNET, KodeVls=@KodeVls, Kurs=@Kurs, 
	NDPPD=@NDPPD, NPPND=@NPPND, NNetD=@NNetD,
	AccPersediaan=@AccPersediaan, AccPPN=@AccPPN, AccHutPiut=@AccHutPiut
	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
else if @Choice='D'
begin
	Delete DBPenjualan where NoBukti=@Nobukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
Commit Tran
Return
JikaSalah: RollBack Tran
           Return




GO

-- Procedure: sp_PenyerahanBhn
-- Created: 2014-04-21 13:16:17.577 | Modified: 2014-09-12 13:13:29.567
-- =====================================================


CREATE  Procedure [dbo].[sp_PenyerahanBhn]
@Choice varchar(1),
@NoBukti varchar(50),
@NoUrut varchar(10)='',
@Tanggal datetime='',
@Kodegdg varchar(15)='',
@Urut int=0,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)=0,
@NoSat tinyint=0,
@Sat varchar(5)='',
@Isi numeric(18,2)=0,
@NoBppB Varchar(50)='',
@Qnt2 numeric(18,2)=0,
@UrutSPK int=0,
@NoSatSPK tinyint=0,
@IsSampel bit=0,
@KodePrs varchar(30)=''

As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbPenyerahanBhndet Where NoBukti=@NoBukti
  if not exists(select * from dbPenyerahanBhn Where NoBukti=@NoBukti) 
  begin
    insert into dbPenyerahanBhn (NOBUKTI, NOURUT, TANGGAL,KODEGDG,NoBPPB, IsSampel, KodePrs)
    values (@NOBUKTI, @NOURUT, @TANGGAL,@KODEGDG,@NoBppB,@IsSampel, @KodePrs)
    
    ---- ISI SPK ----
	  --Print(@urut)
	  --insert into dbPenyerahanBhnDET (NOBUKTI, URUT, NoSPK, UrutSPK, NoSatSPK, kodebrg, Sat, Nosat, Isi, Qnt ,Qnt2)
	  --values(@NOBUKTI, @URUT, @NoBppB, @UrutSPK, @NoSatSPK, @kodebrg, @Sat, @Nosat, @Isi, @Qnt ,@Qnt2)
--	  select @NOBUKTI, @Urut, NOBUKTI, URUT, NOSAT, KODEBRG, SATUAN, NOSAT, ISI, QNT, QNT 
--	  from DBSPKDET 
		--select @NOBUKTI, @Urut,A.NOBUKTI, A.URUT, A.NOSAT, A.KODEBRG,
			--case when A.NoSat=1 then Br.Sat1 else Br.Sat2 end Satuan,
			--A.NOSAT,
			--case when A.NoSat=1 then Br.ISI1 else Br.ISI2 end ISI,
			--A.QntSisa, A.QntSisa
		--from vwOutSPK_Pakai A
		--left outer join DBSPK B on B.NOBUKTI=A.NoBukti
		--left outer join DBBARANG Br on Br.KODEBRG=A.KodeBrg
		--where A.QntSisa>0 and isotorisasi1=1
			--and A.NOBUKTI = @NoBppB
			insert into dbPenyerahanBhnDET (NOBUKTI, URUT, KODEBRG, QNT, NOSAT, ISI, SAT,Qnt2,
	  NoSPK, UrutSPK, NoSatSPK)
    values(@NOBUKTI, @URUT, @KODEBRG, @Qnt, @NoSat, @Isi, @Sat,@Qnt2,
	  @NoBppB, @UrutSPK, @NoSatSPK)		
  end
  else
  begin
    insert into dbPenyerahanBhnDET (NOBUKTI, URUT, KODEBRG, QNT, NOSAT, ISI, SAT,Qnt2,
	  NoSPK, UrutSPK, NoSatSPK)
    values(@NOBUKTI, @URUT, @KODEBRG, @Qnt, @NoSat, @Isi, @Sat,@Qnt2,
	  @NoBppB, @UrutSPK, @NoSatSPK)
  end
end
if @Choice='U'
begin
  update dbPenyerahanBhnDET 
  set Qnt=@QNT, NOSAT=@NoSat, ISI=@ISI, SAT=@Sat,Qnt2=@Qnt2
  where NoBukti=@NoBukti and Urut=@Urut and NoSPK = @NoBppB and UrutSPK = @UrutSPK
end
if @Choice='D'
begin
  delete dbPenyerahanBhnDET where NoBukti=@NoBukti and Urut=@Urut and NoSPK = @NoBppB and UrutSPK = @UrutSPK
  if not exists( select NoBukti from dbPenyerahanBhnDET where NoBukti=@NoBukti)
  begin
    delete dbPenyerahanBhn where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return










GO

-- Procedure: sp_PenyerahanBhnSample
-- Created: 2013-12-20 14:59:50.693 | Modified: 2015-03-25 11:45:41.663
-- =====================================================
CREATE  Procedure [dbo].[sp_PenyerahanBhnSample]
@Choice varchar(1),
@NoBukti varchar(50),
@NoUrut varchar(10)='',
@Tanggal datetime='',
@Kodegdg varchar(15)='',
@Urut int=0,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)=0,
@NoSat tinyint=0,
@Sat varchar(5)='',
@Isi numeric(18,2)=0,
@NoBppB Varchar(50)='',
@Qnt2 numeric(18,2)=0,
@UrutSPK int=0,
@NoSatSPK tinyint=0,
@IsSampel bit=0,
@IsBrg bit=0



As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbPenyerahanBhndet Where NoBukti=@NoBukti
  if not exists(select * from dbPenyerahanBhn Where NoBukti=@NoBukti) 
  begin
    insert into dbPenyerahanBhn (NOBUKTI, NOURUT, TANGGAL,KODEGDG,NoBPPB, IsSampel,ISBRG)
    values (@NOBUKTI, @NOURUT, @TANGGAL,@KODEGDG,@NoBppB,@IsSampel,@IsBrg)
  end
	insert into dbPenyerahanBhnDET (NOBUKTI, URUT, KODEBRG, QNT, NOSAT, ISI, SAT,Qnt2,
	  NoSPK, UrutSPK, NoSatSPK)
	values(@NOBUKTI, @URUT, @KODEBRG, @Qnt, @NoSat, @Isi, @Sat,@Qnt2,
	  @NoBppB, @UrutSPK, @NoSatSPK)
end
if @Choice='U'
begin
  update dbPenyerahanBhnDET 
  set Qnt=@QNT, NOSAT=@NoSat, ISI=@ISI, SAT=@Sat,Qnt2=@Qnt2
  where NoBukti=@NoBukti and Urut=@Urut and NoSPK = @NoBppB and UrutSPK = @UrutSPK
end
if @Choice='D'
begin
  delete dbPenyerahanBhnDET where NoBukti=@NoBukti and Urut=@Urut and NoSPK = @NoBppB and UrutSPK = @UrutSPK
  if not exists( select NoBukti from dbPenyerahanBhnDET where NoBukti=@NoBukti)
  begin
    delete dbPenyerahanBhn where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return








GO

-- Procedure: sp_PerkCost
-- Created: 2014-11-10 09:10:45.307 | Modified: 2014-11-10 09:10:45.307
-- =====================================================


create PROCEDURE [dbo].[sp_PerkCost]
@Choice char(1),
@KodeCost Varchar(30),
@Urut int,
@Perkiraan Varchar(30)

AS
begin tran
if @choice='I'
begin
	select @Urut=isnull(max(Urut),0)+1 from DBPERKCOST Where KodeCost=@KodeCost
	if @@error<>0  goto jikasalah
	insert into dbPerkCost (KodeCost, Urut, Perkiraan)
	values (@KodeCost, @Urut, @Perkiraan)
	if @@error <> 0 goto jikasalah
	
end
if @choice='U'
begin
	update DBPERKCOST set Perkiraan=@Perkiraan
    where KodeCost=@KodeCost and Urut=@Urut 
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBPERKCOST where KodeCost=@KodeCost and Urut=@Urut 
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return





GO

-- Procedure: Sp_PerkCustSupp
-- Created: 2012-01-28 09:58:58.060 | Modified: 2012-01-28 09:58:58.060
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_PerkCustSupp]
@Choice char(1),
@KodeCustSupp Varchar(15),
@Urut int,
@Perkiraan Varchar(25),
@OldKodeCustSupp varchar(15),
@OldMUrut Int
AS
begin tran
if @choice='I'
begin
   Select @Urut=urut from DBPERKCUSTSUPP where KodeCustSupp=@KodeCustSupp
   set @Urut=ISNULL(@urut,0)+1
	insert into dbPerkCustSupp (KodeCustSupp, Urut, Perkiraan)
	values (@KodeCustSupp, @Urut, @Perkiraan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbPerkCustSupp set KodeCustSupp=@KodeCustSupp,Perkiraan=@Perkiraan   
   where KodeCustSupp=@OldKodeCustSupp and Urut=@OldMUrut
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbPerkCustSupp where KodeCustSupp=@OldKodeCustSupp and Urut=@OldMUrut
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: SP_PERKIRAAN
-- Created: 2010-12-12 10:09:52.480 | Modified: 2024-03-07 14:30:28.707
-- =====================================================
CREATE PROCEDURE [dbo].[SP_PERKIRAAN]
@Choice char(1),
@Perkiraan Varchar(25)='',
@Keterangan Varchar(8000)='',
@Kelompok int=0,
@Tipe int=0,
@Valas Varchar(10)='',
@DK int=0,
@Neraca Varchar(25)='',
@simbol varchar(3),
@IsPPN bit=0,
@Lokasi tinyint,
@GroupPerkiraan Varchar(25)='',
@IsSubPerkiraan bit,--=0
@KodeAK varchar(15),
@KodeSAK varchar(15),
@KodePAN varchar(15),
@IsNonLedger bit,
@IsInvestasi bit
AS
begin tran
if @choice='I'
begin
 insert into dbPerkiraan (Perkiraan, Keterangan, Kelompok, Tipe, Valas, DK, Neraca,simbol, IsPPN, Lokasi,
             GroupPerkiraan,IsSubPerkiraan,ketneraca, KodeAK, KodeSAK,KOdePAN,IsNonLedger,IsInvestasi)
 values (@Perkiraan, @Keterangan, @Kelompok, @Tipe, @Valas, @DK, @Neraca,@simbol, @IsPPN, @Lokasi,@GroupPerkiraan ,
 @IsSubPerkiraan,@Keterangan, @KodeAK, @KodeSAK,@KodePAN,@IsNonLedger,@IsInvestasi )
 if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
 update dbPerkiraan set Keterangan=@Keterangan, Kelompok=@Kelompok, Tipe=@Tipe, Valas=@Valas, DK=@DK, Neraca=@Neraca, simbol=@simbol, IsPPN=@IsPPN,
                        Lokasi=@Lokasi,GroupPerkiraan=@GroupPerkiraan,IsSubPerkiraan=@IsSubPerkiraan,KetNeraca=@Keterangan, 
                        KodeAK=@KodeAK, KodeSAK=@KodeSAK,kodePAN=@KodePAN,IsNonLedger=@IsNonLedger,IsInvestasi=@IsInvestasi
 where Perkiraan=@Perkiraan
 if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
 delete  dbPerkiraan where Perkiraan=@Perkiraan
 if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return

GO

-- Procedure: Sp_PesanTunai
-- Created: 2013-08-30 14:11:57.150 | Modified: 2013-08-30 14:11:57.150
-- =====================================================



CREATE Procedure [dbo].[Sp_PesanTunai]
@Choice varchar(1),
@NoBukti varchar(20),
@Tanggal datetime,
@KodeCust varchar(15),
@Urut int,
@KodeBrg varchar(25),
@Qnt numeric(18,2),
@Harga numeric(18,2),
@DiscP numeric(18,2),
@NoSat tinyint,
@Satuan varchar(10),
@Isi numeric(18,3),
@UserID varchar(15),
@Ctk int,
@DIskon numeric(18,2),
@TglBatal datetime,
@Keterangan Varchar(50),
@NoUrut varchar(5),
@Pemesan varchar(50),
@IsOrder bit,
@Alamat varchar(50),
@Telepon varchar(20),
@TanggalAmbil datetime

As
Begin tran
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBPesanTunaiDet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1

  if not exists(select * from dbPesanTunai Where NoBukti=@NoBukti) 
  begin
    insert into dbPesanTunai (NOBUKTI, NoUrut, TANGGAL, KODECUST, TglInput, UserID, Pemesan, IsOrder, Alamat, Telepon, TanggalAmbil)
    values (@NOBUKTI, @NoUrut, @TANGGAL, @KODECust, getdate(), @UserID, @Pemesan, @IsOrder, @Alamat, @Telepon, @TanggalAmbil)
   	if @@error<>0  goto jikasalah		
  end
  
  insert into dbPesanTunaiDET (NOBUKTI, URUT,  KodeBrg, QNT, HARGA, DISCP, NoSat, Satuan, Isi, Ctk,Diskon, TglBatal, Keterangan, IsSelesai, IsKirim)
  values(@NOBUKTI,@URUT, @KodeBrg, @QNT, @HARGA, @DiscP, @NoSat, @Satuan, @Isi, @Ctk,@Diskon, @TglBatal,@Keterangan, 0, 0)
  if @@error<>0  goto jikasalah
end
if @choice='U'
begin
  update dbPesanTunaiDET set Qnt=@QNT, Harga=@HARGA, DiscP=@DiscP, NoSat=@NoSat, 
                       Satuan=@Satuan, Isi=@Isi,Diskon=@Diskon, TglBatal=@TglBatal
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete dbPesanTunaiDet where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from dbPesanTunaiDET where nobukti=@nobukti)
  begin
    delete dbPesanTunai where nobukti=@nobukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
        raiserror('Proses Input Data Gagal',16,1)
           Return


GO

-- Procedure: Sp_PindahSaldoNeraca
-- Created: 2011-06-22 13:48:04.040 | Modified: 2024-08-26 20:29:52.510
-- =====================================================

CREATE Procedure [dbo].[Sp_PindahSaldoNeraca]

@devisi varchar(15),
@Perkiraan varchar(25),
@bulan int,
@tahun int
as

update DBNERACA 
set  AwalDRp = case when a.DK=0 then 1 else 0 end ,
     AwalD =    case when a.DK=0 then 2 else 0 end ,
     AwalkRp =   case when a.DK=1 then dbo.SclHitungNilaiX(@bulan , @tahun ,'01') else 0 end ,
     AwalK = case when a.DK=1 then 4 else 0 end 
  from DBNERACA B
       left Outer join dbperkiraan A on a.perkiraan=b.perkiraan   
              
          where 
Bulan=@bulan--Case when @bulan=12 then 1 else @bulan+1 end 
and Tahun=@tahun --Case when @bulan=12 then @tahun+1 else @tahun end
and b.Perkiraan ='X' 

Declare @xDevisi varchar(15),@xPerkiraan varchar(30),@xBulan int, @xtahun int,
@awalD numeric(18,2),@AwalDRp numeric(18,2),@AwalK numeric(18,2),@AwalKrp numeric(18,2),
@Valas varchar(15),@DK tinyint,@budget numeric(18,2)
Declare Mydata Cursor For
Select B.Devisi, B.Perkiraan, Case when @bulan=12 then 1 else @bulan+1 end,
         Case when @bulan=12 then @tahun+1 else @tahun end,
         case when a.DK=0 then b.AkhirD
              else 0
         end as SaldoAkD,
         case when a.DK=0 then b.AkhirDRp
              else 0
         end as SaldoAkDRp,
         case when a.DK=1 then b.AkhirK
              else 0
         end as SaldoAkK,
         case when a.DK=1 then b.AkhirKRp
              else 0
         end as SaldoAkKRp,B.Valas,A.DK,b.budget
  from DBNERACA B
       left Outer join dbperkiraan A on a.perkiraan=b.perkiraan
  where b.Devisi like Case when @devisi IN('-','') then '%' else @devisi end and a.Perkiraan=@Perkiraan and
        b.Bulan=@bulan and b.Tahun=@tahun and isnull(a.IsNonLedger,0)=0
open mydata 
Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @Valas, @DK,@budget
While @@FETCH_STATUS=0
begin
   if not Exists(Select 'True' From DBNERACA where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
              Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end)
	Begin
	  Insert into DBNERACA(Devisi,Valas,Perkiraan,Bulan,Tahun,AwalD,AwalDRp,AwalK,AwalKRp,DK,Budget)
	  Values (@xDevisi,@Valas,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp,@DK,@budget)
	  Insert into DBNERACANKA (Devisi,Valas ,Perkiraan ,Bulan ,Tahun ,AwalKRp)
	  --values (@xDevisi,@Valas ,@xPerkiraan ,@xBulan ,@xtahun ,@AwalKrp)
	  select  @xDevisi,@Valas ,Perkiraan ,@xBulan ,@xtahun ,@AwalKrp
	  from DBPERKIRAAN  a where  a.Perkiraan in  
      (Select Perkiraan from DBPOSTHUTPIUT  where Kode ='NKA')                                                             

	End
	else
	begin
	  update DBNERACA set AwalD=@awalD,AwalDRp=@AwalDRp,AwalK=@AwalK,AwalKRp=@AwalKrp,Valas=@Valas,DK=@DK,Budget=@budget
	  where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
           Bulan=@xBulan and Tahun=@xtahun
         if not Exists(Select 'True' From DBNERACAnka where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
              Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end)
         Begin
				  Insert into DBNERACANKA (Devisi,Valas ,Perkiraan ,Bulan ,Tahun ,AwalKRp)
				  --values (@xDevisi,@Valas ,@xPerkiraan ,@xBulan ,@xtahun ,@AwalKrp)
				  select  @xDevisi,@Valas ,Perkiraan ,@xBulan ,@xtahun ,@AwalKrp
				  from DBPERKIRAAN  a where  a.Perkiraan in  
				  (Select Perkiraan from DBPOSTHUTPIUT  where Kode ='NKA')                                                             
         
         end
	end
	Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @Valas, @DK,@budget
end
close mydata
Deallocate Mydata

update DBNERACA 
set  AwalDRp = case when a.DK=0 then 0 else 0 end ,
     AwalD =    case when a.DK=0 then 0 else 0 end ,
     AwalkRp =   case when a.DK=1 then dbo.SclHitungNilaiX(Case when @bulan=12 then 1 else @bulan+1 end , Case when @bulan=12 then @tahun+1 else @tahun end ,'01') else 0 end ,
     AwalK = case when a.DK=1 then 0 else 0 end 
  from DBNERACA B
       left Outer join dbperkiraan A on a.perkiraan=b.perkiraan          
          
          where 
Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end
and b.Perkiraan ='X' 

update DBNERACA set AwalDRp  =0,AwalKRp=0
from DBNERACA a 
left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan 
where  Kelompok in (3,4) and --Bulan =@bulan and Tahun =@tahun
Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end
 

/*
Declare Mydata Cursor For
Select B.Devisi, B.Perkiraan, Case when @bulan=12 then 1 else @bulan+1 end,
         Case when @bulan=12 then @tahun+1 else @tahun end,
         case when a.DK=0 then b.AkhirD
              else 0
         end as SaldoAkD,
         case when a.DK=0 then b.AkhirDRp
              else 0
         end as SaldoAkDRp,
         case when a.DK=1 then b.AkhirK
              else 0
         end as SaldoAkK,
         case when a.DK=1 then b.AkhirKRp
              else 0
         end as SaldoAkKRp,B.Valas,A.DK,b.budget
  from DBNERACA B
       left Outer join dbperkiraan A on a.perkiraan=b.perkiraan
  where b.Devisi like Case when @devisi IN('-','') then '%' else @devisi end and a.Perkiraan=@Perkiraan and
        b.Bulan=@bulan and b.Tahun=@tahun and a.IsNonLedger=1
open mydata 
Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @Valas, @DK,@budget
While @@FETCH_STATUS=0
begin
   if not Exists(Select 'True' From DBNERACA where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
              Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end)
	Begin
	  Insert into DBNERACA(Devisi,Valas,Perkiraan,Bulan,Tahun,AwalDRp)
	  Values (@xDevisi,@Valas,@xPerkiraan,@xBulan,@xtahun,@AwalDRp)
	End
	else
	begin
	  update DBNERACA set AwalDRp=@AwalDRp
	  where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
           Bulan=@xBulan and Tahun=@xtahun
	end
	Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @DK,@budget
end
close mydata
Deallocate Mydata
*/

GO

-- Procedure: Sp_PindahSaldoNeracaInvestasi
-- Created: 2024-02-10 15:29:28.103 | Modified: 2024-02-10 21:06:59.897
-- =====================================================


CREATE Procedure [dbo].[Sp_PindahSaldoNeracaInvestasi]

@devisi varchar(15),
@Perkiraan varchar(25),
@bulan int,
@tahun int
as

Declare @xDevisi varchar(15),@xPerkiraan varchar(30),@xBulan int, @xtahun int,
@awalD numeric(18,2),@AwalDRp numeric(18,2),@AwalK numeric(18,2),@AwalKrp numeric(18,2),
@Valas varchar(15),@DK tinyint,@budget numeric(18,2),@AsetNeto numeric (18,2)
select @AsetNeto = SUM(AwalDRp ) from DBNERACA a
left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan 
where Bulan =@bulan and Tahun =@tahun



Declare Mydata Cursor For
Select B.Devisi, B.Perkiraan, Case when @bulan=12 then 1 else @bulan+1 end,
         Case when @bulan=12 then @tahun+1 else @tahun end,
         case when a.DK=0 then b.AkhirD
              else 0
         end as SaldoAkD,
         case when a.DK=0 then b.AkhirDRp
              else 0
         end as SaldoAkDRp,
         case when a.DK=1 then b.AkhirK
              else 0
         end as SaldoAkK,
         case when a.DK=1 then b.AkhirKRp
              else 0
         end as SaldoAkKRp,B.Valas,A.DK,b.budget
  from DBNERACA B
       left Outer join dbperkiraan A on a.perkiraan=b.perkiraan
  where b.Devisi like Case when @devisi IN('-','') then '%' else @devisi end and a.Perkiraan=@Perkiraan and
        b.Bulan=@bulan and b.Tahun=@tahun and a.IsNonLedger=1
open mydata 
Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @Valas, @DK,@budget
While @@FETCH_STATUS=0
begin
   if not Exists(Select 'True' From DBNERACA where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
              Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end)
	Begin
	  Insert into DBNERACA(Devisi,Valas,Perkiraan,Bulan,Tahun,AwalD,AwalDRp,AwalK,AwalKRp,DK,Budget)
	  Values (@xDevisi,@Valas,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp,@DK,@budget)
	End
	else
	begin
	  update DBNERACA set AwalD=@awalD,AwalDRp=@AwalDRp,AwalK=@AwalK,AwalKRp=@AwalKrp,Valas=@Valas,DK=@DK,Budget=@budget
	  where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
           Bulan=@xBulan and Tahun=@xtahun
	end
	Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @DK,@budget
end
close mydata
Deallocate Mydata






GO

-- Procedure: Sp_PindahSaldoNeracaLama
-- Created: 2015-10-30 01:53:58.170 | Modified: 2015-10-30 01:53:58.170
-- =====================================================


Create Procedure [dbo].[Sp_PindahSaldoNeracaLama]

@devisi varchar(15),
@Perkiraan varchar(25),
@bulan int,
@tahun int
as
Declare @xDevisi varchar(15),@xPerkiraan varchar(30),@xBulan int, @xtahun int,
@awalD numeric(18,2),@AwalDRp numeric(18,2),@AwalK numeric(18,2),@AwalKrp numeric(18,2),
@Valas varchar(15),@DK tinyint,@budget numeric(18,2)
Declare Mydata Cursor For
Select B.Devisi, B.Perkiraan, Case when @bulan=12 then 1 else @bulan+1 end,
         Case when @bulan=12 then @tahun+1 else @tahun end,
         case when a.DK=0 then b.AkhirD
              else 0
         end as SaldoAkD,
         case when a.DK=0 then b.AkhirDRp
              else 0
         end as SaldoAkDRp,
         case when a.DK=1 then b.AkhirK
              else 0
         end as SaldoAkK,
         case when a.DK=1 then b.AkhirKRp
              else 0
         end as SaldoAkKRp,B.Valas,A.DK,b.budget
  from DBNERACALAMA B
       left Outer join dbperkiraan A on a.perkiraan=b.perkiraan
  where b.Devisi like Case when @devisi IN('-','') then '%' else @devisi end and a.Perkiraan=@Perkiraan and
        b.Bulan=@bulan and b.Tahun=@tahun 
open mydata 
Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @Valas, @DK,@budget
While @@FETCH_STATUS=0
begin
   if not Exists(Select 'True' From DBNERACALAMA where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
              Bulan=Case when @bulan=12 then 1 else @bulan+1 end and Tahun=Case when @bulan=12 then @tahun+1 else @tahun end)
	Begin
	  Insert into DBNERACALAMA(Devisi,Valas,Perkiraan,Bulan,Tahun,AwalD,AwalDRp,AwalK,AwalKRp,DK,Budget)
	  Values (@xDevisi,@Valas,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp,@DK,@budget)
	End
	else
	begin
	  update DBNERACALAMA set AwalD=@awalD,AwalDRp=@AwalDRp,AwalK=@AwalK,AwalKRp=@AwalKrp,Valas=@Valas,DK=@DK,Budget=@budget
	  where Devisi=@xdevisi and Perkiraan=@xPerkiraan and
           Bulan=@xBulan and Tahun=@xtahun
	end
	Fetch next from Mydata Into @xDevisi,@xPerkiraan,@xBulan,@xtahun,@awalD,@AwalDRp,@AwalK,@AwalKrp, @DK,@budget
end
close mydata
Deallocate Mydata

GO

-- Procedure: Sp_PiutangAwal
-- Created: 2010-12-16 17:40:38.590 | Modified: 2011-02-11 10:29:58.020
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_PiutangAwal]
@choice varchar(1),
@Nobukti varchar(20),
@tglBukti datetime,
@TglJatuhTempo datetime,
@Jumlah numeric(18,2),
@JumlahRp numeric(18,2),
@KodeSupp varchar(20),
@nofaktur varchar(20),
@tipetrans varchar(3),
@urut int,
@kurs numeric(18,2),
@valas varchar(3),
@Perkiraan varchar(25),
@Kredit numeric(18,2),
@KreditRp numeric(18,2)
AS
if @choice='I'
begin
	select @urut=Max(urut) 
	from dbHUTPIUT 
	where KodeCustSupp=@kodesupp and NoFaktur=@nobukti 
	set @urut =Case when @urut is null then 1 else @urut + 1 end
	insert into dbHUTPIUT(NoFaktur,Tanggal,JatuhTempo,KodeCustSupp,Debet,Kredit,
		                  DebetD,KreditD,TipeTrans,Tipe,Urut,NoMsk,Valas,Kurs,Perkiraan)
	values(@Nobukti,@tglBukti,@TglJatuhTempo,@KodeSupp,@JumlahRp,@KreditRp,
	       Case when @Valas='IDR' then 0 else @Jumlah end,
	       Case when @Valas='IDR' then 0 else @Kredit end,@tipetrans,'PT',
		   @urut,0,@valas,@kurs,@Perkiraan)
end
if @choice='U'
begin
 update dbHUTPIUT set  debet=@JumlahRp,JatuhTempo=@tglJatuhTempo ,tanggal=@tglbukti,
                       DebetD=Case when @Valas='IDR' then 0 else @Jumlah end,Valas=@Valas,Kurs=@kurs,
                       Kredit=@KreditRp,
                       KreditD=Case when @Valas='IDR' then 0 else @Kredit end 
 where NoFaktur=@Nobukti and KodeCustSupp=@kodesupp and 
       tipetrans=@tipetrans and urut=@urut and Perkiraan=@Perkiraan and Tipe='PT'
end
if @choice='D'
begin
 delete dbHUTPIUT 
 where NoFaktur=@Nobukti and KodeCustSupp=@kodesupp and 
       tipetrans=@tipetrans and urut=@urut and Perkiraan=@Perkiraan and Tipe='PT'
end

GO

-- Procedure: Sp_POKirim
-- Created: 2011-06-09 10:41:59.847 | Modified: 2011-06-09 10:41:59.847
-- =====================================================

CREATE Procedure [dbo].[Sp_POKirim]
@Choice varchar(1),
@urut int,
@NoPO varchar(30),
@UrutPO int,
@Tglkirim Datetime,
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2)
As 
begin tran
if @Choice='I'
begin
  Select @urut=MAX(urut) from DBPOKIRIM where NoPO=@NoPO and UrutPO=@UrutPO
  Set @urut=ISNULL(@urut,0)+1
  Insert into DBPOKIRIM (urut, NoPO, UrutPO, TglKirim, Sat_1, Sat_2, Qnt, Qnt2, Nosat, Isi)
  values (@urut,@NoPO,@UrutPO,@Tglkirim,@Sat_1,@Sat_2, @qnt, @qnt2, @Nosat, @Isi)
end
else if @Choice='U'
begin
  update DBPOKIRIM set TglKirim=@Tglkirim, Qnt=@qnt, @qnt2=@qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
  Nosat=@Nosat, isi=@isi
  where urut=@urut and nopo=@NoPO and urutpo=@UrutPO
end
else if @Choice='D'
begin
  delete DBPOKIRIM where urut=@urut and nopo=@NoPO and urutpo=@UrutPO
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return



GO

-- Procedure: sp_PORev
-- Created: 2012-11-30 11:46:07.423 | Modified: 2014-07-18 09:49:44.857
-- =====================================================

CREATE Procedure [dbo].[sp_PORev]
@NoBukti varchar(20),
@RevisiKe Int,
@urut Int,
@Catatan Varchar(500),
@Urutan TinyInt

As
Begin tran
 if @Urutan =1				
 Begin
    select @RevisiKe=isnull(max(RevisiKe),0)+1 from dbPORev Where NoBukti=@NoBukti
    insert into dbPORev (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling, KodeExp, KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp,IsClose,RevisiKe,TanggalRev)
    Select NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling, KodeExp, KETERANGAN,
	FakturSupp, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DISCRP,IsClose,@RevisiKe,GETDATE()
	from dbPO where NOBUKTI=@NoBukti
  
    insert into dbPORevDET (NOBUKTI, URUT,  PPN, Disc, KODEBRG,NAMABRG, QNT, NOSAT, ISI, SATUAN, HARGA, DISCP, DISCTOT,NoPPL,IsClose,Catatan,DiscP2,DiscP3,DiscP4,DiscP5,revisike,Isjasa)
    select NOBUKTI, URUT, PPN, Disc, KODEBRG,NAMABRG, Qnt, NOSAT, ISI, SATUAN, Harga, DISCP, DISCTOT,NoPPL,IsClose,@Catatan ,DiscP2,DiscP3,DiscP4,DiscP5,@RevisiKe,Isjasa
    from DBPODET where NOBUKTI=@NoBukti and URUT=@urut
 end
else
 Begin
    select @RevisiKe=isnull(max(RevisiKe),0)+1 from dbPORev Where NoBukti=@NoBukti
    insert into dbPORev (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling, KodeExp, KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp,IsClose,RevisiKe,TanggalRev)
    Select NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling, KodeExp, KETERANGAN,
	FakturSupp, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DISCRP,IsClose,@RevisiKe,GETDATE()
	from dbPO where NOBUKTI=@NoBukti
	-------
	insert into dbPORevDET (NOBUKTI, URUT,  PPN, Disc, KODEBRG,NAMABRG, QNT, NOSAT, ISI, SATUAN, HARGA, DISCP, DISCTOT,NoPPL,IsClose,Catatan,DiscP2,DiscP3,DiscP4,DiscP5,revisike,IsJasa)
    select NOBUKTI, URUT, PPN, Disc, KODEBRG,NAMABRG, Qnt, NOSAT, ISI, SATUAN, Harga, DISCP, DISCTOT,NoPPL,IsClose,@Catatan,DiscP2,DiscP3,DiscP4,DiscP5,@RevisiKe,ISjasa 
    from DBPODET where NOBUKTI=@NoBukti
 end 
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: Sp_PostBiaya
-- Created: 2010-12-10 09:50:01.163 | Modified: 2011-12-22 11:44:27.140
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_PostBiaya]
@Choice char(1),
@KodeBag Varchar(15),
@KodeMesin Varchar(15),
@Perkiraan Varchar(25),
@BiayaJasa Varchar(25),
@OldKode varchar(15),
@OldKode2 varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbPostBiaya (KodeBag, KodeMesin, Perkiraan, BiayaJasa)
	values (@KodeBag, @KodeMesin, @Perkiraan, @BiayaJasa)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbPostBiaya set KodeMesin=@KodeMesin ,KodeBag=@KodeBag, Perkiraan=@Perkiraan, BiayaJasa=@BiayaJasa
   where KodeBag=@OldKode and KodeMesin=@OldKode2 
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbPostBiaya where KodeBag=@OldKode and KodeMesin=@OldKode2 
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: sp_PPL
-- Created: 2013-02-19 14:12:19.120 | Modified: 2015-04-02 14:44:18.790
-- =====================================================


CREATE  Procedure [dbo].[sp_PPL]
@Choice varchar(1),
@NoBukti varchar(50),
@NoUrut varchar(10)='',
@Tanggal datetime=0,
@Urut int,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)='',
@NoSat tinyint=0,
@Satuan varchar(5)='',
@Isi numeric(18,2)=0,
@Keterangan Varchar(500)='',
@IsClose Bit=False,
@IsClosed Bit=False,
@KDDep varchar(20),
@KetNama Varchar(100),
@Isjasa Bit,
@NOSO VARCHAR(25),
@URUTSO INT
As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbPPLdet Where NoBukti=@NoBukti
  if @@error<>0  goto jikasalah
  if not exists(select * from dbPPL Where NoBukti=@NoBukti) 
  begin
    insert into dbPPL (NOBUKTI, NOURUT, TANGGAL,IsClose, KDDep)
    values (@NOBUKTI, @NOURUT, @TANGGAL,@IsClose, @KDDep)
    if @@error<>0  goto jikasalah
  end
  insert into dbPPLDET (NOBUKTI, URUT, KODEBRG, QNT, NOSAT, ISI, SAT,Keterangan,IsClose,NamaBrg,Isjasa,NOSO,URUTSO)
  values(@NOBUKTI, @URUT, @KODEBRG, @Qnt, @NoSat, @Isi, @Satuan,@Keterangan,@IsClosed,@KetNama,@Isjasa,@NOSO,@URUTSO)
  if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
  update dbPPLDET set KodeBrg=@KODEBRG, Qnt=@QNT, NOSAT=@NoSat, ISI=@ISI, SAT=@Satuan,Keterangan=@Keterangan,IsClose=@IsClosed
  ,namaBrg=@KetNama,NOSO=@NOSO,URUTSO=@URUTSO
  where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  delete dbPPLDET where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah 
  if not exists( select NoBukti from dbPPLDET where NoBukti=@NoBukti)
  begin
    delete dbPPL where NoBukti=@NoBukti
    if @@error<>0  goto jikasalah
  end
end

exec sp_RefreshOutPPL @NoBukti
if @@error<>0  goto jikasalah

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: Sp_ProsesCashFlow
-- Created: 2014-11-20 15:20:59.680 | Modified: 2015-03-05 09:20:16.017
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_ProsesCashFlow]
--declare
@Divisi varchar(10),
@Bulan int,
@Tahun int,
@BulanB int,
@TahunB int,
@UserID varchar (30)

--select @Divisi='01',@Bulan=1,@Tahun=2015,@BulanB=1,@Tahun=2015,@UserID='sa'
as

declare @Periode1 varchar(10), @Periode2 varchar(10), @xBulan int

select @Periode1=cast(@Tahun as varchar(4))+right('0'+cast(@Bulan as varchar(2)),2)
select @Periode2=cast(@TahunB as varchar(4))+right('0'+cast(@BulanB as varchar(2)),2)

select a.Perkiraan, a.Perkiraan as Lawan, a.Keterangan,
     sum(isnull(bb.AwalDRp,0))as Kas,
     0 as Koreksi, 0 as Jumlah, 'SALDO AWAL'as Gol, '1' as Urut, @UserID as UserID, '01' devisi, '' KodeCS
from dbPerkiraan a
left outer join dbneraca b on (b.perkiraan=a.perkiraan and b.Devisi=@Divisi and
     b.Bulan=@Bulan and b.Tahun=@Tahun)
left outer join dbneraca bb on (bb.perkiraan=a.perkiraan and bb.Devisi=@Divisi and
     bb.Bulan=@Bulan and bb.Tahun=@Tahun)
--where a.FlagCashFlow='1'
where (a.Perkiraan in(select x.Perkiraan from dbposthutpiut x where  x.kode='KAS')) or
      (a.Perkiraan in(select x.Perkiraan from dbposthutpiut x where  x.kode='BANK'))
Group by a.Perkiraan, a.Keterangan
union

select a.Perkiraan, a.Lawan, b.Keterangan,
sum(isnull(a.Debet*a.Kurs,0)-isnull(a.Kredit*a.Kurs,0)) as Kas,
0 as Koreksi, 0 as Jumlah, 'PENERIMAAN'as Gol, '2' as Urut, @UserID as UserID,'01' as Devisi, '' KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan

where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
     (a.tipetrans='BKM' or a.tipetrans='BBM') and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KAS')) and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BANK'))
Group by a.Perkiraan, a.Lawan, b.Keterangan
/*
union
select a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan) Keterangan,
sum(case when p.NoBukti is null then isnull(a.Debet*a.Kurs,0) - isnull(a.Kredit*a.Kurs,0) else isnull(p.Kredit,isnull(h.Debet,0)) end) as Kas,
0 as Koreksi, 0 as Jumlah, 'PENERIMAAN'as Gol, '2' as Urut, @UserID as UserID,'01' as Devisi,
	isnull(isnull(h.KodeCustSupp,p.KodeCustSupp),'') KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan
left outer join dbhutpiut h on h.NoBukti=a.NoBukti 
left outer join dbCustSupp sp on sp.KodeCustSupp=h.KodecustSupp
left outer join dbhutpiut p on p.NoBukti=a.NoBukti 
left outer join dbCustSupp cs on cs.KODECUSTSUPP=p.KodeCustSupp

where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
     (a.tipetrans='BKM' or a.tipetrans='BBM') and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KAS')) and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BANK'))
	and (p.NoBukti is not null or h.NoBukti is not null)
Group by a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan), isnull(isnull(h.KodeCustSupp,p.KodeCustSupp),'')
union
*/
select a.Perkiraan, a.Lawan, b.Keterangan,
sum(isnull(a.Kredit*a.Kurs,0)-isnull(a.Debet*a.Kurs,0)) as Kas, 0 as Koreksi, 0 as Jumlah, 'PENGELUARAN'as Gol, 
'3' as Urut, @UserID as UserID, '01' as devisi, '' KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan

where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
      (a.tipetrans='BKK' or a.tipetrans='BBK') and
      (a.Perkiraan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KAS')) and
      (a.Perkiraan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BANK')) 
Group by a.Perkiraan, a.Lawan, b.Keterangan

union 
select a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan) Keterangan ,
sum(case when h.NoBukti is null then isnull(a.Kredit*a.Kurs,0)-isnull(a.Debet*a.Kurs,0) else isnull(h.Debet,p.Kredit) end) as Kas, 0 as Koreksi, 0 as Jumlah, 'PENGELUARAN'as Gol, 
'3' as Urut, @UserID as UserID, '01' as devisi, isnull(h.KodeCustSupp,isnull(p.KodeCustSupp,'')) KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan
left outer join dbHutpiut h on h.NoBukti=a.NoBukti 
left outer join DBCUSTSUPP sp on sp.KODECUSTSUPP=h.KodeCustSupp
left outer join DBHUTPIUT p on p.NoBukti=a.NoBukti 
left outer join DBCUSTSUPP cs on cs.KODECUSTSUPP=p.KodeCustSupp

where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
      (a.tipetrans='BKK' or a.tipetrans='BBK') and
      (a.Perkiraan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KAS')) and
      (a.Perkiraan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BANK')) 
	and (p.NoBukti is not null or h.NoBukti is not null)
Group by a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan), isnull(h.KodeCustSupp,isnull(p.KodeCustSupp,''))
union
select a.Perkiraan, a.Perkiraan as Lawan, a.Keterangan,
     sum(isnull(b.AwalDRp,0)+(isnull(b.MDRp,0)-isnull(b.MKRp,0))+
     (isnull(b.JPDRp,0)-isnull(b.JPKRp,0))+(isnull(b.RLDRp,0)-isnull(b.RLKRp,0))) as Kas,
     0 as Koreksi, 0 as Jumlah, 'SALDO AKHIR'as Gol, '4' as Urut, @UserID as UserID, '01' devisi, '' KodeCS
from dbPerkiraan a
left outer join dbneraca b on (b.perkiraan=a.perkiraan and b.Devisi=@Divisi and
     b.Bulan=@BulanB and b.Tahun=@TahunB)
--where a.FlagCashFlow='1'
where (a.Perkiraan in(select x.Perkiraan from dbposthutpiut x where  x.kode='KAS')) or
      (a.Perkiraan in(select x.Perkiraan from dbposthutpiut x where  x.kode='BANK'))
Group by a.Perkiraan, a.Keterangan


GO

-- Procedure: Sp_ProsesCashFlowold
-- Created: 2015-03-05 09:20:10.300 | Modified: 2015-03-05 09:20:10.300
-- =====================================================


create PROCEDURE [dbo].[Sp_ProsesCashFlowold]
--declare
@Divisi varchar(10),
@Bulan int,
@Tahun int,
@BulanB int,
@TahunB int,
@UserID varchar (30)

--select @Divisi='01',@Bulan=7,@Tahun=2014,@BulanB=8,@Tahun=2014,@UserID='sa'
as

declare @Periode1 varchar(10), @Periode2 varchar(10), @xBulan int

select @Periode1=cast(@Tahun as varchar(4))+right('0'+cast(@Bulan as varchar(2)),2)
select @Periode2=cast(@TahunB as varchar(4))+right('0'+cast(@BulanB as varchar(2)),2)

select a.Perkiraan, a.Perkiraan as Lawan, a.Keterangan,
     sum(isnull(bb.AwalDRp,0))as Kas,
     0 as Koreksi, 0 as Jumlah, 'SALDO AWAL'as Gol, '1' as Urut, @UserID as UserID, '01' devisi, '' KodeCS
from dbPerkiraan a
left outer join dbneraca b on (b.perkiraan=a.perkiraan and b.Devisi=@Divisi and
     b.Bulan=@Bulan and b.Tahun=@Tahun)
left outer join dbneraca bb on (bb.perkiraan=a.perkiraan and bb.Devisi=@Divisi and
     bb.Bulan=@Bulan and bb.Tahun=@Tahun)
where a.FlagCashFlow='1'
Group by a.Perkiraan, a.Keterangan
union

select a.Perkiraan, a.Lawan, b.Keterangan,
sum(isnull(a.Debet*a.Kurs,0)-isnull(a.Kredit*a.Kurs,0)) as Kas,
0 as Koreksi, 0 as Jumlah, 'PENERIMAAN'as Gol, '2' as Urut, @UserID as UserID,'01' as Devisi, '' KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan
where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
     (a.tipetrans='BKM' or a.tipetrans='BBM') and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KS')) and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BK'))
Group by a.Perkiraan, a.Lawan, b.Keterangan

union
select a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan) Keterangan,
sum(case when p.NoBukti is null then isnull(a.Debet*a.Kurs,0) - isnull(a.Kredit*a.Kurs,0) else isnull(p.Kredit,isnull(h.Debet,0)) end) as Kas,
0 as Koreksi, 0 as Jumlah, 'PENERIMAAN'as Gol, '2' as Urut, @UserID as UserID,'01' as Devisi,
	isnull(isnull(h.KodeCustSupp,p.KodeCustSupp),'') KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan
left outer join dbhutpiut h on h.NoBukti=a.NoBukti 
left outer join dbCustSupp sp on sp.KodeCustSupp=h.KodecustSupp
left outer join dbhutpiut p on p.NoBukti=a.NoBukti 
left outer join dbCustSupp cs on cs.KODECUSTSUPP=p.KodeCustSupp

where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
     (a.tipetrans='BKM' or a.tipetrans='BBM') and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KS')) and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BK'))
	and (p.NoBukti is not null or h.NoBukti is not null)
Group by a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan), isnull(isnull(h.KodeCustSupp,p.KodeCustSupp),'')
union

select a.Perkiraan, a.Lawan, b.Keterangan,
sum(isnull(a.Kredit*a.Kurs,0)-isnull(a.Debet*a.Kurs,0)) as Kas, 0 as Koreksi, 0 as Jumlah, 'PENGELUARAN'as Gol, 
'3' as Urut, @UserID as UserID, '01' as devisi, '' KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan
where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
      (a.tipetrans='BKK' or a.tipetrans='BBK') and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KS')) and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BK')) 
Group by a.Perkiraan, a.Lawan, b.Keterangan
union 
select a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan) Keterangan ,
sum(case when h.NoBukti is null then isnull(a.Kredit*a.Kurs,0)-isnull(a.Debet*a.Kurs,0) else isnull(h.Debet,p.Kredit) end) as Kas, 0 as Koreksi, 0 as Jumlah, 'PENGELUARAN'as Gol, 
'3' as Urut, @UserID as UserID, '01' as devisi, isnull(h.KodeCustSupp,isnull(p.KodeCustSupp,'')) KodeCS
from dbTransaksi a
left outer join dbPerkiraan b on a.Lawan=b.perkiraan
left outer join dbHutpiut h on h.NoBukti=a.NoBukti 
left outer join DBCUSTSUPP sp on sp.KODECUSTSUPP=h.KodeCustSupp
left outer join DBHUTPIUT p on p.NoBukti=a.NoBukti 
left outer join DBCUSTSUPP cs on cs.KODECUSTSUPP=p.KodeCustSupp
where (cast(year(A.Tanggal) as varchar(4))+right('0'+cast(month(A.Tanggal) as varchar(2)),2) between @Periode1 and @Periode2) and
      (a.tipetrans='BKK' or a.tipetrans='BBK') and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='KS')) and
      (a.Lawan not in(select x.Perkiraan from dbposthutpiut x where  x.kode='BK')) 
	and (p.NoBukti is not null or h.NoBukti is not null)
Group by a.Perkiraan, a.Lawan, isnull(isnull('    - '+sp.NAMACUSTSUPP,'    - '+cs.NAMACUSTSUPP),b.Keterangan), isnull(h.KodeCustSupp,isnull(p.KodeCustSupp,''))
union
select a.Perkiraan, a.Perkiraan as Lawan, a.Keterangan,
     sum(isnull(b.AwalDRp,0)+(isnull(b.MDRp,0)-isnull(b.MKRp,0))+
     (isnull(b.JPDRp,0)-isnull(b.JPKRp,0))+(isnull(b.RLDRp,0)-isnull(b.RLKRp,0))) as Kas,
     0 as Koreksi, 0 as Jumlah, 'SALDO AKHIR'as Gol, '4' as Urut, @UserID as UserID, '01' devisi, '' KodeCS
from dbPerkiraan a
left outer join dbneraca b on (b.perkiraan=a.perkiraan and b.Devisi=@Divisi and
     b.Bulan=@BulanB and b.Tahun=@TahunB)
where a.FlagCashFlow='1'
Group by a.Perkiraan, a.Keterangan



GO

-- Procedure: SP_ProsesLabaRugi
-- Created: 2013-06-10 13:00:42.323 | Modified: 2015-10-30 02:17:17.333
-- =====================================================






CREATE Procedure [dbo].[SP_ProsesLabaRugi]
@Bulan int,
@Tahun int,
@LR_HPP bit,
@Tanggal Datetime,
@Userid varchar(15),
@Devisi varchar(15)
AS
--Select @Bulan=1,@Tahun=2011,@LR_HPP=0,@Tanggal='01-31-2011',@Userid='SA'
begin Tran
	Declare @Nobuktix varchar(50),@urutx int,@Devisix varchar(15)
	declare CurHapus cursor for
	select nobukti,urut,devisi from dbtransaksi 
	where nobukti like Case when @LR_HPP=0 then 'R/L%' 
						         when @LR_HPP=1 then 'HPP%'
						         else ''
					       end and 
	      month(tanggal)=@bulan and year(tanggal)=@tahun and Devisi=@devisi and Tipetrans in ('R/L','HPP') 
	Order by Nobukti
	open CurHapus
	Fetch Next from CurHapus into @Nobuktix,@Urutx,@Devisix
	while @@FETCH_STATUS=0
	begin
		Delete dbTransaksi where NoBukti=@Nobuktix and Urut=@urutx and Devisi=@Devisix
		if not exists(Select 'True' from dbTransaksi where NoBukti=@Nobuktix and Devisi=@Devisix)
		   Delete dbTrans where NoBukti=@Nobuktix 
		Fetch Next from CurHapus into @Nobuktix,@Urutx,@Devisix
	end
	close CurHapus
	Deallocate CurHapus
	if @@ERROR<>0 Goto JikaSalah
	Declare @Perkiraan varchar(25),@Nomor varchar(25),
		 @Grup Varchar(50),@Tipe Varchar(3),
		 @Tanda varchar(3),@Persen varchar(3),
		 @JumLah varchar(3),@Tampil varchar(3)
	declare @detail int,@hasil1 numeric(18,2),@hasil2 numeric(18,2),@hasil3 numeric(18,2),@hasil4 numeric(18,2),@jurnal numeric(18,2)
	declare @hasil1Rp numeric(18,2),@hasil2Rp numeric(18,2),@hasil3Rp numeric(18,2),@hasil4Rp numeric(18,2),@jurnalRp numeric(18,2)
	declare @perkiraan1 varchar(15)
	declare @hsl1 numeric(18,2),@hsl2 numeric(18,2),@hsl3 numeric(18,2),@hsl4 numeric(18,2)
	declare @jumtotal1 numeric(18,2),@jumtotal2 numeric(18,2),@jumtotal3 numeric(18,2),@jumtotal4 numeric(18,2)
	declare @jumgroup1 numeric(18,2),@jumgroup2 numeric(18,2),@jumgroup3 numeric(18,2),@jumgroup4 numeric(18,2)
	declare @jumsubgroup1 numeric(18,2),@jumsubgroup2 numeric(18,2),@jumsubgroup3 numeric(18,2),@jumsubgroup4 numeric(18,2)
	select @jumtotal1=0
	select @jumtotal2=0
	select @jumtotal3=0
	select @jumtotal4=0
	select @jumgroup1=0
	select @jumgroup2=0
	select @jumgroup3=0
	select @jumgroup4=0
	select @jumsubgroup1=0
	select @jumsubgroup2=0
	select @jumsubgroup3=0	
	select @jumsubgroup4=0 
	Declare mydata Cursor For
		Select Bulan,Tahun,Devisi,Perkiraan,Nomor,Grup,Tipe,Tanda,Persen,JumLah,Tampil 
		from DBLRHPP 
		Where Bulan=@bulan and tahun=@tahun and IsLrHpp=@LR_HPP and Devisi=@devisi  and Tanda<>''
		order by Nomor 
	open mydata
	fetch next from mydata into @Bulan,@Tahun,@Devisix,@Perkiraan,@Nomor,@Grup,@Tipe,@Tanda,@Persen,@JumLah,@Tampil
	while @@FETCH_STATUS=0
	begin
	  Select @hsl1=0, @hsl2=0, @hsl3=0, @hsl4=0 
	  Update DBLRHPP  Set TotalA=@hsl1, TotalB=@hsl2,TotalC=@hsl3,TotalD=@hsl4 where Nomor=@Nomor and Perkiraan=@Perkiraan
	  and Bulan=@Bulan and Tahun=@Tahun and Devisi=@Devisix
	  Declare @Perkiraanx Varchar(25)
     if @Perkiraan<>''
     begin
       --select @detail=(select distinct p.Tipe from DBPERKIRAAN p where p.Perkiraan=@perkiraan)
       Declare MyPerkiraan cursor for
       select distinct P.perkiraan 
       from dbperkiraan P, dbneraca N 
       where P.perkiraan=@Perkiraan and --like (@perkiraan+'%') and --((P.Perkiraan like (@Perkiraan+'%') and @Detail=0 and P.Perkiraan<>@Perkiraan) or (P.perkiraan=@perkiraan and @Detail=1)) and  
       P.Perkiraan=N.Perkiraan and N.bulan=@bulan and N.tahun=@tahun and N.devisi =@devisix --like @devisix +'%'
             and P.Tipe=1
       Order by P.Perkiraan
       open MyPerkiraan
       Fetch next From MyPerkiraan into @Perkiraanx
       while @@FETCH_STATUS=0
       begin
          exec dbo.sp_HitungNilaiRl @perkiraanx,@tipe,@bulan,@tahun,@Devisix,@LR_HPP,@tanggal,@userid,
			 @hasil1 output,@hasil2 output,@hasil3 output,@jurnal output,
			 @hasil1Rp output,@hasil2Rp output,@hasil3Rp output,@jurnalRp output,@hasil4 output,@hasil4Rp output
			 select @hsl1=@hsl1+isnull(@hasil1Rp,0)
			 select @hsl2=@hsl2+isnull(@hasil2Rp,0)
			 select @hsl3=@hsl3+isnull(@hasil3Rp,0)
			 select @hsl4=@hsl4+isnull(@hasil4Rp,0)
         Fetch next From MyPerkiraan into @Perkiraanx
       end
       
       close MyPerkiraan
       Deallocate MyPerkiraan 
     end
     --Print(@hsl2)
     --Print (@Perkiraan)
       
     Update DBLRHPP set TotalA=@hsl1,TotalB=@hsl2,TotalC=@hsl3,TotalD=@hsl4
     where  Bulan=@Bulan and Tahun=@Tahun and Nomor=@Nomor and Perkiraan=@Perkiraan and IsLRHPP=@LR_HPP and Devisi=@devisix
      
     --------------
     Delete DBLRHPP where Bulan=(Case when @Bulan=12 Then 1 else @Bulan+1 end) and Tahun=Case When @Bulan=12 Then @Tahun+1 else @Tahun end
	 and Nomor=@Nomor and Perkiraan=@perkiraan  
	 Insert into DBLRHPP(Devisi,Bulan,Tahun,Nomor,Perkiraan,Keterangan,Grup,Tipe,Tanda,Persen,Tampil,TotalA,TotalB,TotalC,TotalD,IsLRHPP,Jumlah)
     Select Devisi,Case when @bulan=12 then 1 else Bulan+1 end,
     Case when @Bulan=12 then Tahun+1 else @Tahun end,
     Nomor,Perkiraan,Keterangan,Grup,Tipe,Tanda,Persen,Tampil,TotalA,TotalB,TotalC,TotalD,IsLRHPP,Jumlah
     from DBLRHPP  
     where Bulan=@Bulan and Tahun=@Tahun and Nomor=@Nomor and Perkiraan=@perkiraan and IsLRHPP=@LR_HPP 
     fetch next from mydata into @Bulan,@Tahun,@Devisix,@Perkiraan,@Nomor,@Grup,@Tipe,@Tanda,@Persen,@JumLah,@Tampil
	end
	
	close Mydata
	Deallocate Mydata
	  
	
Commit Tran
Return
JikaSalah: RollBack Tran
           Return



GO

-- Procedure: SP_ProsesNeracaBulanan
-- Created: 2015-09-26 03:10:59.363 | Modified: 2016-03-19 18:37:32.173
-- =====================================================
CREATE PROCEDURE [dbo].[SP_ProsesNeracaBulanan]
--declare
@Bulan int,
@Tahun int
--select @Bulan=2,@Tahun=2016
as

Delete TempNerBul
Delete DBNeracaBulanan where Tanda in ('M4','M6','M8H','M8','M8F')

insert DBNeracaBulanan (Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,Tanda)
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'M4' tanda 
from DBPERKIRAAN where LEN(Perkiraan)=4 and Perkiraan<>'X'
union all
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'M6' tanda
from DBPERKIRAAN where LEN(Perkiraan)=6 and Perkiraan<>'X' and 
LEFT (Perkiraan,6) not in (select LEFT(Perkiraan,6) from DBPERKIRAAN where LEN(Perkiraan)=10)
union all
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'M8H' tanda 
from DBPERKIRAAN where LEN(Perkiraan)=6 and Perkiraan<>'X' and 
LEFT (Perkiraan,6) in (select LEFT(Perkiraan,6) from DBPERKIRAAN where LEN(Perkiraan)=10)
union all
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'M8' tanda
from DBPERKIRAAN where LEN(Perkiraan)=8 and Perkiraan<>'X' and 
LEFT (Perkiraan,8) in (select LEFT(Perkiraan,8) from DBPERKIRAAN where LEN(Perkiraan)=10)
union all
select Perkiraan+'999','          Jumlah  '+Perkiraan+'    :',DK,GroupPerkiraan,'','M8F' 
from DBPERKIRAAN where LEN(Perkiraan)=6 and Perkiraan<>'X' and 
LEFT (Perkiraan,6) in (select LEFT(Perkiraan,6) from DBPERKIRAAN where LEN(Perkiraan)=10)


declare @Perkiraan varchar(25),@Tanda varchar(3)
Declare mydata Cursor For
  select perkiraan,tanda,@Bulan,@Tahun from DBNeracaBulanan order by perkiraan
open mydata
fetch next from mydata into @perkiraan,@tanda,@Bulan,@Tahun
while @@FETCH_STATUS=0
begin

if @Tanda='M8'
begin
  exec dbo.SP_InsertM8 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='M8F'
begin
  exec dbo.SP_InsertM8F @Perkiraan,@Bulan,@Tahun
end 
if @Tanda='M6'
begin
  exec dbo.SP_InsertM6 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='M4' or @Tanda='M8H'
begin
  insert TempNerBul 
  (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,Bulan,tahun)
  select GroupPerkiraan,Perkiraan,Keterangan,null,'',null,'', null,'', null,'',null,'',DK,Tanda,IsSubPerkiraan,@Bulan,@Tahun 
  from DBNeracaBulanan where Perkiraan=@Perkiraan
end
if @Tanda='M3'
begin
  exec dbo.SP_InsertM3 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='M2'
begin
  exec dbo.SP_InsertM2 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='M1'
begin
  exec dbo.SP_InsertM1 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='M0'
begin
  insert TempNerBul 
  (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,Bulan,tahun)
  select '','9999','Jumlah Keseluruhan :',0 Awal,'', sum(Debet) debet,'', sum(kredit) kredit,'', 0 akhir,'',0,'',0,'M0','',@Bulan,@Tahun from TempNerBul where Tanda in ('M6','M8')
end
Fetch next From mydata into @perkiraan,@tanda,@Bulan,@Tahun
end
       
close mydata
Deallocate mydata


GO

-- Procedure: sp_ProsesPostingBuktiTetap
-- Created: 2015-05-21 18:59:21.873 | Modified: 2023-03-23 16:18:35.093
-- =====================================================


CREATE Procedure [dbo].[sp_ProsesPostingBuktiTetap]
@BuktiTetap varchar(30),
@BuktiSementara varchar(30),
@TanggalTetap Datetime

as
Declare @Nomor int,@NoBaru int, @NoBukti varchar(20), @Periode varchar(10)
INSERT INTO [dbTrans]
           ([NoBukti],[NOURUT],[Tanggal],[Note],[Lampiran],[IsOtorisasi1],[OtoUser1] ,[TglOto1],[IsOtorisasi2],[OtoUser2],[TglOto2],
           [IsOtorisasi3],[OtoUser3],[TglOto3],[IsOtorisasi4],[OtoUser4],[TglOto4],[IsOtorisasi5],[OtoUser5],[TglOto5],[Simbol],
           [TipeTransHd],[PerkiraanHd],[FlagSimbol],[MaxOL],[NoJurnal],[NoUrutJurnal],[TglJurnal],[Flagtipe],[Jenis],[NoBuktiSem])
select @BuktiTetap,substring (@BuktiTetap,3,5),@TanggalTetap,[Note],[Lampiran],[IsOtorisasi1],[OtoUser1] ,[TglOto1],[IsOtorisasi2],[OtoUser2],[TglOto2],
           [IsOtorisasi3],[OtoUser3],[TglOto3],[IsOtorisasi4],[OtoUser4],[TglOto4],[IsOtorisasi5],[OtoUser5],[TglOto5],[Simbol],
           [TipeTransHd],[PerkiraanHd],[FlagSimbol],[MaxOL],[NoJurnal],[NoUrutJurnal],[TglJurnal],[Flagtipe],[Jenis],@BuktiSementara
from TempdbTrans where NoBukti=@BuktiSementara

INSERT INTO [dbTransaksi]
           ([NoBukti],[Tanggal],[Devisi],[Note],[Lampiran],[Perkiraan],[Lawan],[Keterangan],[Keterangan2],[Debet],[Kredit],[Valas],[Kurs]
           ,[DebetRp],[KreditRp],[TipeTrans],[TPHC],[CustSuppP],[CustSuppL],[Urut],[KodeP],[KodeL],[NoAktivaP],[NoAktivaL],[StatusAktivaP]
           ,[StatusAktivaL],[Nobon],[KodeBag],[StatusGiro],[FlagSimbol],[KODECOST],[KODESUBCOST])
select @BuktiTetap,@TanggalTetap,[Devisi],[Note],[Lampiran],[Perkiraan],[Lawan],[Keterangan],[Keterangan2],[Debet],[Kredit],[Valas],[Kurs]
           ,[DebetRp],[KreditRp],[TipeTrans],[TPHC],[CustSuppP],[CustSuppL],[Urut],[KodeP],[KodeL],[NoAktivaP],[NoAktivaL],[StatusAktivaP]
           ,[StatusAktivaL],[Nobon],[KodeBag],[StatusGiro],[FlagSimbol],[KODECOST],[KODESUBCOST]
from TempdbTransaksi where NoBukti=@BuktiSementara

insert into DBAKTIVA 
 ([Devisi],[Perkiraan],[Keterangan],[Quantity],[Persen] ,[Tanggal],[Tipe],[Kodebag],[Akumulasi],[NoMuka],[NoBelakang]
           ,[Biaya],[PersenBiaya1],[Biaya2],[PersenBiaya2],[biaya3],[persenbiaya3],[biaya4],[persenbiaya4]
           ,[TipeAktiva],[NoBelakang2],[NoAktivaHd],[Kelompok],[GroupAktiva],[NoBuktiSem])
select [Devisi],[Perkiraan],[Keterangan],[Quantity],[Persen] ,[Tanggal],[Tipe],[Kodebag],[Akumulasi],[NoMuka],[NoBelakang]
           ,[Biaya],[PersenBiaya1],[Biaya2],[PersenBiaya2],[biaya3],[persenbiaya3],[biaya4],[persenbiaya4]
           ,[TipeAktiva],[NoBelakang2],[NoAktivaHd],[Kelompok],[GroupAktiva],[NoBuktiSem]
           from TempDBAKTIVA
           where NoBuktisem=@BuktiSementara

           
INSERT INTO [DBHUTPIUT]
           ([NoFaktur],[NoRetur],[TipeTrans],[KodeCustSupp],[NoBukti],[NoMsk],[Urut],[Tanggal],[JatuhTempo],[Debet],[Kredit],[Valas],[Kurs]
           ,[DebetD],[KreditD],[KodeSales],[Tipe],[Perkiraan],[Catatan],[NOINVOICE],[TGLINVOICE],[NOPAJAK],[TGLFPJ],[KodeVls_],[Kurs_]
           ,[KursBayar],[FlagSimbol],[Tipebayar],[IsOtorisasi1],[OtoUser1],[TglOto1],[IsOtorisasi2],[OtoUser2],[TglOto2],[IsOtorisasi3]
           ,[OtoUser3],[TglOto3],[IsOtorisasi4],[OtoUser4],[TglOto4],[IsOtorisasi5],[OtoUser5],[TglOto5],[IsClose],[NoJurnal],[NoUrutJurnal]
           ,[TglJurnal],[MaxOL],[Nourut],[KBLB])
select [NoFaktur],[NoRetur],[TipeTrans],[KodeCustSupp],@BuktiTetap,[NoMsk],[Urut],@TanggalTetap,[JatuhTempo],[Debet],[Kredit],[Valas],[Kurs]
           ,[DebetD],[KreditD],[KodeSales],[Tipe],[Perkiraan],[Catatan],[NOINVOICE],[TGLINVOICE],[NOPAJAK],[TGLFPJ],[KodeVls_],[Kurs_]
           ,[KursBayar],[FlagSimbol],[Tipebayar],[IsOtorisasi1],[OtoUser1],[TglOto1],[IsOtorisasi2],[OtoUser2],[TglOto2],[IsOtorisasi3]
           ,[OtoUser3],[TglOto3],[IsOtorisasi4],[OtoUser4],[TglOto4],[IsOtorisasi5],[OtoUser5],[TglOto5],[IsClose],[NoJurnal],[NoUrutJurnal]
           ,[TglJurnal],[MaxOL],[Nourut],[KBLB]
from TempDBHUTPIUT where NoBukti=@BuktiSementara







GO

-- Procedure: sp_ProsesPostingHutPiut
-- Created: 2014-10-01 11:34:55.377 | Modified: 2014-10-01 11:34:55.377
-- =====================================================

CREATE Procedure [dbo].[sp_ProsesPostingHutPiut]
--declare
@JenisTrans varchar(15),
@NamaTabel varchar(30),
@Bulan int,
@Tahun int,
@NoBuktiTrans varchar(25),
@TipeProses int

as
--select @JenisTrans='',@NamaTabel='DBBELI',@Bulan=9,@Tahun=2014,@NoBuktiTrans='SLS/LPB/00002/0914',@TipeProses=1

if @JenisTrans=''
begin
	if @NamaTabel='DBBELI'
		select @JenisTrans='PBL'
	ELSE if @NamaTabel='DBINVOICE'
		select @JenisTrans='BPL'
	else if @NamaTabel='DBRBELI'
		select @JenisTrans='RPB'
	else if @NamaTabel='DBDEBETNOTE'
		select @JenisTrans='DN'
	else if @NamaTabel='DBINVOICEPL'
		select @JenisTrans='INVC'
	else if @NamaTabel='DBINVOICERPJ'
		select @JenisTrans='RPJ'
	else if @NamaTabel='DBKREDITNOTE'
		select @JenisTrans='KN'
	else
		select @JenisTrans=''
end

delete DBHUTPIUT where NOINVOICE=@JenisTrans and NOPAJAK=@NoBuktiTrans

if @TipeProses=1
begin

	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
	NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, 
	Valas, Kurs, DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, 
	NOINVOICE, TGLINVOICE, NOPAJAK, TGLFPJ, KodeVls_, Kurs_, 
	KursBayar, FlagSimbol)

	select  NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
	NoBukti,
	--NoJurnal, 
	NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, 
	Valas, Kurs, DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, 
	NOINVOICE, null TGLINVOICE, NoPajak, null TGLFPJ, KodeVls_, Kurs_, 
	Kurs KursBayar, '' FlagSimbol
	from vwPostHutPiut
	where NoInvoice=@JenisTrans 
	and NoPajak=@NoBuktiTrans 
	and IsOtorisasi=1
end


--select * from DBHUTPIUT








GO

-- Procedure: sp_ProsesPostingJurnalOto
-- Created: 2014-10-01 11:11:32.790 | Modified: 2014-10-02 13:45:01.600
-- =====================================================



CREATE Procedure [dbo].[sp_ProsesPostingJurnalOto]
@JenisTrans varchar(30),
@NamaTabel varchar(30),
@Bulan int,
@Tahun int,
@NoBukti varchar(25),
@TipeProses int

as

if @JenisTrans=''
begin
	if @NamaTabel='DBBELI'
		select @JenisTrans='BPL'
	/*if @NamaTabel='DBINVOICE'
		select @JenisTrans='BPL'*/
	else if @NamaTabel='DBRBELI'
		select @JenisTrans='RPB'
	else if @NamaTabel='DBDEBETNOTE'
		select @JenisTrans='DN'
	else if @NamaTabel='DBSPB'
		select @JenisTrans='SPB'
	else if @NamaTabel='DBRSPB'
		select @JenisTrans='RSPB'
	else if @NamaTabel='DBINVOICEPL'
		select @JenisTrans='INVC'
	else if @NamaTabel='DBSPBRJUAL'
		select @JenisTrans='SPR'
	else if @NamaTabel='DBINVOICERPJ'
		select @JenisTrans='RPJ'
	else if @NamaTabel='DBKREDITNOTE'
		select @JenisTrans='KN'
	else if @NamaTabel='DBPENYERAHANBHN'
		select @JenisTrans='BP'
	else if @NamaTabel='DBRPENYERAHANBHN'
		select @JenisTrans='RBP'
	else if @NamaTabel='DBUBAHKEMASAN'
		select @JenisTrans='KMS'
	else if @NamaTabel='DBPenyerahanBhn'
		select @JenisTrans='BP'	
	else if @NamaTabel='DBHasilPRD'
		select @JenisTrans='PRD'	
	else if @NamaTabel='DBTRANSFER'
		select @JenisTrans='TRF'
	else if @NamaTabel='DBKOREKSI'
		select @JenisTrans='OPNBHN'			
	else
		select @JenisTrans=''
end

delete DBJurnalOto where Jenis=@JenisTrans and NoBuktiTrans=@NoBukti

if @TipeProses=1
begin
	insert into DBJurnalOto (NoBukti, Tanggal, Devisi, Note, Lampiran, Urut, Perkiraan, Lawan, Keterangan, Keterangan2, 
	Debet, Kredit, Valas, Kurs, DebetRp, KreditRp, TipeTrans, TPHC, CustSuppP, CustSuppL, KodeP, KodeL, 
	NoAktivaP, NoAktivaL, StatusAktivaP, StatusAktivaL, NoBon, KodeBag, StatusGiro, Jenis, NoBuktiTrans)
	select NoBukti, Tanggal, Devisi, Note, Lampiran, Urut, Perkiraan, Lawan, Keterangan, Keterangan2, 
	Debet, Kredit, Valas, Kurs, DebetRp, KreditRp, TipeTrans, TPHC, CustSuppP, CustSuppL, KodeP, KodeL, 
	NoAktivaP, NoAktivaL, StatusAktivaP, StatusAktivaL, NoBon, KodeBag, StatusGiro, Jenis, NoBuktiTrans
	from vwPostJurnalOto
	where Jenis=@JenisTrans and NoBuktiTrans=@NoBukti
		and NOBUKTI<>'' 
end






GO

-- Procedure: SP_ProsesRNeracaBulanan
-- Created: 2015-10-02 08:34:12.613 | Modified: 2016-05-20 22:38:51.467
-- =====================================================

CREATE PROCEDURE [dbo].[SP_ProsesRNeracaBulanan]
--declare
@Bulan int,
@Tahun int
--select @Bulan=1,@Tahun=2015
as

Delete TempRNerBul
Delete DBRNeracaBulanan

insert DBRNeracaBulanan (Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,Tanda)
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,Tanda from ( 
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'R1' Tanda from DBPERKIRAAN where LEN(Perkiraan)=6 and IsSubPerkiraan=1
union all
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'R8' from DBPERKIRAAN where LEN(Perkiraan)=8 and IsSubPerkiraan=1 and
LEFT(Perkiraan,8) not in (select LEFT (Perkiraan,8) from DBPERKIRAAN where LEN(Perkiraan)=10)
union all
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'R8H' from DBPERKIRAAN where LEN(Perkiraan)=8 and IsSubPerkiraan=1 and
LEFT(Perkiraan,8) in (select LEFT (Perkiraan,8) from DBPERKIRAAN where LEN(Perkiraan)=10)
union all
select Perkiraan,Keterangan,DK,GroupPerkiraan,IsSubPerkiraan,'R10' from DBPERKIRAAN where LEN(Perkiraan)=10 and IsSubPerkiraan=1 
union all
select Perkiraan+'99','          Jumlah  '+Perkiraan+'    :',DK,GroupPerkiraan,IsSubPerkiraan,'R6' from DBPERKIRAAN where LEN(Perkiraan)=6 and IsSubPerkiraan=1
union all
select Perkiraan+'99','        Jumlah  '+Perkiraan+'    :',DK,GroupPerkiraan,IsSubPerkiraan,'R8F' from DBPERKIRAAN where LEN(Perkiraan)=8 and IsSubPerkiraan=1
and LEFT(Perkiraan,8) in (select LEFT (Perkiraan,8) from DBPERKIRAAN where LEN(Perkiraan)=10) 
union all
select '999.99','Jumlah Keseluruhan :',0,'',1,'R0'
) R order by R.Perkiraan



declare @Perkiraan varchar(25),@Tanda varchar(3)
Declare mydata Cursor For
  select perkiraan,tanda,@Bulan,@Tahun from DBRNeracaBulanan order by perkiraan
open mydata
fetch next from mydata into @perkiraan,@tanda,@Bulan,@Tahun
while @@FETCH_STATUS=0
begin
if @Tanda='R1' or @Tanda='R8H'
begin
  insert TempRNerBul 
  (GroupPerkiraan,Perkiraan,Keterangan,Awal,AwalK,Debet,DebetK,Kredit,KreditK,Akhir,AkhirK,Budget,Bintang,DK,Tanda,IsSubPerkiraan,Bulan,tahun)
  select GroupPerkiraan,Perkiraan,Keterangan,null,'',null,'', null,'', null,'',null,'',DK,Tanda,IsSubPerkiraan,@Bulan,@Tahun 
  from DBRNeracaBulanan where Perkiraan=@Perkiraan
end
if @Tanda='R10'
begin
  exec dbo.SP_InsertR10 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='R8'
begin
  exec dbo.SP_InsertR8 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='R6'
begin
  exec dbo.SP_InsertR6 @Perkiraan,@Bulan,@Tahun
end
if @Tanda='R8F'
begin
  exec dbo.SP_InsertR8F @Perkiraan,@Bulan,@Tahun
end
if @Tanda='R0'
begin
  exec dbo.SP_InsertR0 @Perkiraan,@Bulan,@Tahun
end

Fetch next From mydata into @perkiraan,@tanda,@Bulan,@Tahun
end
       
close mydata
Deallocate mydata

GO

-- Procedure: sp_ProsesTempStockBOM
-- Created: 2014-04-14 11:12:51.097 | Modified: 2014-04-14 11:12:51.097
-- =====================================================


CREATE Procedure [dbo].[sp_ProsesTempStockBOM]
@IDUser varchar(30), 
@KodeBrgJadi varchar(30), 
@KodeBOM varchar(30), 
@QntBrgJadi numeric(18,2),
@Tahun int,
@Bulan int,
@NoSPK varchar(25)

AS

exec sp_ProsesTempStockBOM_ @IDUser, @KodeBrgJadi, @KodeBOM, @QntBrgJadi, @Tahun, @Bulan, @NoSPK

delete TempStockBOM where IDUser=@IDUser

insert into TempStockBOM (IDUser, KodeBrg, KodeBOM, 
StrLevelBOM, IntLevelBOM, Urut1, Urut2, 
QntBOM_, QntBOMX, QntBOM, QntStockR, QntOutPO, QntOutPrd, QntOutSPK,
QntStock, QntSisaStock, QntProduksi, IsBarang)
select @IDUser IDUser, B.KodeBrg, B2.KodeBOM KodeBOM, 
	right('00000'+cast(B.Urut as varchar(5)),5) StrLevelBOM, 1 IntLevelBOM, 1 Urut1, B.Urut, 
	B.Qnt QntBOM_, @QntBrgJadi*B.Qnt QntBOMX, @QntBrgJadi*B.Qnt QntBOM,
	ISNULL(S.QntStockR,0) QntStockR, ISNULL(S.QntOutPO,0) QntOutPO, ISNULL(S.QntOutPrd,0) QntOutPrd, ISNULL(S.QntOutSPK,0) QntOutSPK, 
	ISNULL(S.QntStock,0) QntStock, ISNULL(S.QntStock,0)-@QntBrgJadi*B.Qnt QntSisaStock, 
	case when B2.KodeBOM IS null then null else 
			case when ISNULL(S.QntStock,0)-@QntBrgJadi*B.Qnt<0 then ABS(ISNULL(S.QntStock,0)-@QntBrgJadi*B.Qnt) else 0 end end QntProduksi, Brg.IsBarang
from dbBOM A
left outer join DBBOMDET B on B.KodeBOM=A.KodeBOM
left outer join DBBOM B2 on B2.KodeBrg=B.KodeBrg
left outer join DBBARANG Brg on Brg.KODEBRG=B.KodeBrg
left outer join TempStockBOM_ S on S.KodeBrg=B.KodeBrg
where A.KodeBrg=@KodeBrgJadi and A.KodeBOM=@KodeBOM
order by B.Urut

declare @xMaxIntLevelBOM int, @xIsLanjut bit

select @xMaxIntLevelBOM=MAX(IntLevelBOM) from TempStockBOM where IDUser=@IDUser

if not exists(select * from TempStockBOM where IDUser=@IDUser and IntLevelBOM=@xMaxIntLevelBOM and IsBarang<>1) 
begin
	select @xIsLanjut=0
end else
begin
	select @xIsLanjut=1
end
  
  
while @xIsLanjut=1
begin
	insert into TempStockBOM (IDUser, KodeBrg, KodeBOM, 
		StrLevelBOM, IntLevelBOM, Urut1, Urut2, 
		QntBOM_, QntBOMX, QntBOM, QntStockR, QntOutPO, QntOutPrd, QntOutSPK,
		QntStock, QntSisaStock, QntProduksi, IsBarang)
	select @IDUser IDUser, BD.KodeBrg, B2.KodeBOM, 
		A.StrLevelBOM+right('00000'+cast(BD.Urut as varchar(5)),5) StrLevelBOM, A.IntLevelBOM+1 IntLevelBOM, A.Urut2, BD.Urut, 
		BD.Qnt QntBOM_, A.QntBOM*BD.Qnt QntBOMX, A.QntBOM*BD.Qnt QntBOM, 
		ISNULL(S.QntStockR,0) QntStockR, ISNULL(S.QntOutPO,0) QntOutPO, ISNULL(S.QntOutPrd,0) QntOutPrd, ISNULL(S.QntOutSPK,0) QntOutSPK,
		ISNULL(S.QntStock,0) QntStock, ISNULL(S.QntStock,0)-A.QntBOM*BD.Qnt QntSisaStock, 
		case when B2.KodeBOM IS null then null else 
			case when ISNULL(S.QntStock,0)-A.QntBOM*BD.Qnt<0 then ABS(ISNULL(S.QntStock,0)-A.QntBOM*BD.Qnt) else 0 end end QntProduksi, Brg.IsBarang
	from TempStockBOM A
	left outer join DBBOM B on B.KODEBRG=A.KodeBrg
	left outer join DBBOMDET BD on BD.KodeBOM=B.KodeBOM
	left outer join DBBOM B2 on B2.KodeBrg=BD.KodeBrg
	left outer join dbBarang Brg on Brg.KodeBrg=BD.KodeBrg
	left outer join TempStockBOM_ S on S.KodeBrg=BD.KodeBrg
	where A.IDUser=@IDUser and A.IntLevelBOM=@xMaxIntLevelBOM
	and A.IsBarang<>1
	order by BD.Urut
	
	select @xMaxIntLevelBOM=MAX(IntLevelBOM) from TempStockBOM where IDUser=@IDUser
	
	if not exists(select * from TempStockBOM where IDUser=@IDUser and IntLevelBOM=@xMaxIntLevelBOM and IsBarang<>1) 
	begin
		select @xIsLanjut=0
	end else
	begin
		select @xIsLanjut=1
	end

end










GO

-- Procedure: sp_ProsesTempStockBOM_
-- Created: 2014-04-14 11:12:46.843 | Modified: 2014-04-14 11:12:46.843
-- =====================================================



CREATE Procedure [dbo].[sp_ProsesTempStockBOM_]
@IDUser varchar(30), 
@KodeBrgJadi varchar(30), 
@KodeBOM varchar(30), 
@QntBrgJadi numeric(18,2),
@Tahun int,
@Bulan int,
@NoSPK varchar(25)

AS

delete TempStockBOM_ where IDUser=@IDUser

insert into TempStockBOM_ (IDUser, KodeBrg, KodeBOM, 
StrLevelBOM, IntLevelBOM, Urut1, Urut2, IsBarang)
select @IDUser IDUser, B.KodeBrg, B2.KodeBOM KodeBOM, 
	right('00000'+cast(B.Urut as varchar(5)),5) StrLevelBOM, 1 IntLevelBOM, 1 Urut1, B.Urut, 
	Brg.IsBarang
from dbBOM A
left outer join DBBOMDET B on B.KodeBOM=A.KodeBOM
left outer join DBBOM B2 on B2.KodeBrg=B.KodeBrg
left outer join DBBARANG Brg on Brg.KODEBRG=B.KodeBrg
where A.KodeBrg=@KodeBrgJadi and A.KodeBOM=@KodeBOM
order by B.Urut

declare @xMaxIntLevelBOM int, @xIsLanjut bit

select @xMaxIntLevelBOM=MAX(IntLevelBOM) from TempStockBOM_ where IDUser=@IDUser

if not exists(select * from TempStockBOM_ where IDUser=@IDUser and IntLevelBOM=@xMaxIntLevelBOM and IsBarang<>1) 
begin
	select @xIsLanjut=0
end else
begin
	select @xIsLanjut=1
end
  
  
while @xIsLanjut=1
begin
	insert into TempStockBOM_ (IDUser, KodeBrg, KodeBOM, 
		StrLevelBOM, IntLevelBOM, Urut1, Urut2, IsBarang)
	select @IDUser IDUser, BD.KodeBrg, B2.KodeBOM, 
		A.StrLevelBOM+right('00000'+cast(BD.Urut as varchar(5)),5) StrLevelBOM, A.IntLevelBOM+1 IntLevelBOM, A.Urut2, BD.Urut, 
		Brg.IsBarang
	from TempStockBOM_ A
	left outer join DBBOM B on B.KODEBRG=A.KodeBrg
	left outer join DBBOMDET BD on BD.KodeBOM=B.KodeBOM
	left outer join DBBOM B2 on B2.KodeBrg=BD.KodeBrg
	left outer join dbBarang Brg on Brg.KodeBrg=BD.KodeBrg
	where A.IDUser=@IDUser and A.IntLevelBOM=@xMaxIntLevelBOM
	and A.IsBarang<>1
	order by BD.Urut
	
	select @xMaxIntLevelBOM=MAX(IntLevelBOM) from TempStockBOM_ where IDUser=@IDUser
	
	if not exists(select * from TempStockBOM_ where IDUser=@IDUser and IntLevelBOM=@xMaxIntLevelBOM and IsBarang<>1) 
	begin
		select @xIsLanjut=0
	end else
	begin
		select @xIsLanjut=1
	end

end

insert into TempStockBOM_ (IDUser, KodeBrg, QntStockR)
select distinct A.IDUser, A.KodeBrg, ISNULL(S.SaldoQnt,0)
from TempStockBOM_ A 
left outer join
	(select KODEBRG, SUM(SALDOQNT) SALDOQNT
	from DBSTOCKBRG
	where TAHUN=@Tahun and BULAN=@Bulan
	and KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	group by KODEBRG
	) S on S.KODEBRG=A.KodeBrg 
where IDUser=@IDUser

delete TempStockBOM_ where IDUser=@IDUser and QntStockR is null

update TempStockBOM_
set QntOutPO=ISNULL(S.QNT,0)
from TempStockBOM_ A 
left outer join
	(select KODEBRG, SUM(QNT) QNT from
	(select P.NOBUKTI, Q.URUT, Q.KODEBRG, Q.QNT*Q.ISI QNT 
	from DBPO P, DBPODET Q
	where P.NOBUKTI=Q.NOBUKTI
	and ((YEAR(P.TANGGAL)<@Tahun) or (YEAR(P.TANGGAL)=@Tahun and MONTH(P.TANGGAL)<=@Bulan))
	and Q.KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	union all
	select Q.NoPO NOBUKTI, Q.UrutPO URUT, Q.KODEBRG, -(isnull(Q.Qnt1Terima,0)-ISNULL(Q.Qnt1Reject,0)) QNT 
	from DBBELI P, DBBELIDET Q
	where P.NOBUKTI=Q.NOBUKTI
	and ((YEAR(P.TANGGAL)<@Tahun) or (YEAR(P.TANGGAL)=@Tahun and MONTH(P.TANGGAL)<=@Bulan))
	and Q.KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	) X group by KODEBRG
	) S on S.KODEBRG=A.KodeBrg 
where A.IDUser=@IDUser

update TempStockBOM_
set QntOutSPK=ISNULL(S.QNT,0)
from TempStockBOM_ A 
left outer join
	(select KODEBRG, SUM(QNT) QNT from
	(select P.NOBUKTI, Q.URUT, Q.KODEBRG, Q.QNT*Q.ISI QNT 
	from DBSPK P, DBSPKDET Q
	where P.NOBUKTI=Q.NOBUKTI
	and ((YEAR(P.TANGGAL)<@Tahun) or (YEAR(P.TANGGAL)=@Tahun and MONTH(P.TANGGAL)<=@Bulan))
	and Q.KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	and P.NOBUKTI<>@NoSPK
	union all
	select Q.NoSPK NOBUKTI, Q.UrutSPK URUT, Q.KODEBRG, -isnull(Q.Qnt,0) QNT 
	from DBPenyerahanBhn P, DBPenyerahanBhnDET Q
	where P.NOBUKTI=Q.NOBUKTI
	and ((YEAR(P.TANGGAL)<@Tahun) or (YEAR(P.TANGGAL)=@Tahun and MONTH(P.TANGGAL)<=@Bulan))
	and Q.KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	and Q.NoSPK<>@NoSPK
	) X group by KODEBRG
	) S on S.KODEBRG=A.KodeBrg 
where A.IDUser=@IDUser

update TempStockBOM_
set QntOutPrd=ISNULL(S.QNT,0)
from TempStockBOM_ A 
left outer join
	(select KODEBRG, SUM(QNT) QNT from
	(select P.NOBUKTI, Q.KODEBRG, Q.QNT*Q.ISI QNT 
	from DBSPK P, DBSPKDET Q
	where P.NOBUKTI=Q.NOBUKTI
	and ((YEAR(P.TANGGAL)<@Tahun) or (YEAR(P.TANGGAL)=@Tahun and MONTH(P.TANGGAL)<=@Bulan))
	and Q.KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	and P.NOBUKTI<>@NoSPK
	and Q.KodeBOMDet<>''
	union all
	select Q.NoSPK NOBUKTI, Q.KODEBRG, -isnull(Q.Qnt,0) QNT 
	from DBHASILPRD P, DBHASILPRDDET Q
	where P.NOBUKTI=Q.NOBUKTI
	and ((YEAR(P.TANGGAL)<@Tahun) or (YEAR(P.TANGGAL)=@Tahun and MONTH(P.TANGGAL)<=@Bulan))
	and Q.KODEBRG in (select KODEBRG from TempStockBOM_ where IDUser=@IDUser)
	and Q.NoSPK<>@NoSPK
	) X group by KODEBRG
	) S on S.KODEBRG=A.KodeBrg 
where A.IDUser=@IDUser

update TempStockBOM_
set QntStock=QntStockR+QntOutPO+QntOutPrd -QntOutSPK
where IDUser=@IDUser










GO

-- Procedure: sp_ProsesTempStockBOM2
-- Created: 2014-04-14 11:12:42.460 | Modified: 2014-04-14 11:12:42.460
-- =====================================================


CREATE Procedure [dbo].[sp_ProsesTempStockBOM2]
@IDUser varchar(30), 
@KodeBrgJadi varchar(30), 
@KodeBOM varchar(30), 
@QntBrgJadi numeric(18,2),
@Tahun int,
@Bulan int,
@StrLevelBOM varchar(20),
@NoSPK varchar(20)

AS

declare @xIntLevelBOM int, @xUrut int, @QntBOMX numeric(18,2)

select @xIntLevelBOM=IntLevelBOM, @xUrut=Urut2, @QntBOMX=QntBOMX from TempStockBOM where IDUser=@IDUser and StrLevelBOM=@StrLevelBOM

delete TempStockBOM2 where IDUser=@IDUser

insert into TempStockBOM2 (IDUser, KodeBrg, KodeBOM, 
StrLevelBOM, IntLevelBOM, Urut1, Urut2, 
QntBOM_, QntBOMX, QntBOM, QntStockR, QntOutPO, QntOutPrd, QntOutSPK, 
QntStock, QntSisaStock, QntProduksi, IsBarang)
select @IDUser IDUser, B.KodeBrg, B2.KodeBOM, 
	@StrLevelBOM+right('00000'+cast(B.Urut as varchar(5)),5) StrLevelBOM, 
	@xIntLevelBOM+1 IntLevelBOM, @xUrut Urut1, B.Urut,
	B.Qnt QntBOM_, @QntBOMX*B.Qnt QntBOMX, @QntBrgJadi*B.Qnt QntBOM, 
	ISNULL(S.QntStockR,0) QntStockR, ISNULL(S.QntOutPO,0) QntOutPO, ISNULL(S.QntOutPrd,0) QntOutPrd, ISNULL(S.QntOutSPK,0) QntOutSPK,
	ISNULL(S.QntStock,0) QntStock, ISNULL(S.QntStock,0)-@QntBrgJadi*B.Qnt QntSisaStock, 
	case when B2.KodeBOM IS null then null else 
			case when ISNULL(S.QntStock,0)-@QntBrgJadi*B.Qnt<0 then ABS(ISNULL(S.QntStock,0)-@QntBrgJadi*B.Qnt) else 0 end end QntProduksi, Brg.IsBarang
from dbBOM A
left outer join DBBOMDET B on B.KodeBOM=A.KodeBOM
left outer join DBBOM B2 on B2.KodeBrg=B.KodeBrg
left outer join DBBARANG Brg on Brg.KODEBRG=B.KodeBrg
left outer join TempStockBOM_ S on S.KodeBrg=B.KodeBrg
where A.KodeBrg=@KodeBrgJadi and A.KodeBOM=@KodeBOM
order by B.Urut

declare @xMaxIntLevelBOM int, @xIsLanjut bit

select @xMaxIntLevelBOM=MAX(IntLevelBOM) from TempStockBOM2 where IDUser=@IDUser

if not exists(select * from TempStockBOM2 where IDUser=@IDUser and IntLevelBOM=@xMaxIntLevelBOM and IsBarang<>1) 
begin
	select @xIsLanjut=0
end else
begin
	select @xIsLanjut=1
end
  
  
while @xIsLanjut=1
begin
	insert into TempStockBOM2 (IDUser, KodeBrg, KodeBOM, 
		StrLevelBOM, IntLevelBOM, Urut1, Urut2, 
		QntBOM_, QntBOMX, QntBOM, QntStockR, QntOutPO, QntOutPrd, QntOutSPK,
		QntStock, QntSisaStock, QntProduksi, IsBarang)
	select @IDUser IDUser, BD.KodeBrg, B2.KodeBOM, 
		A.StrLevelBOM+right('00000'+cast(BD.Urut as varchar(5)),5) StrLevelBOM, A.IntLevelBOM+1 IntLevelBOM, 
		A.Urut2, BD.Urut,
		BD.Qnt QntBOM_, A.QntBOM*BD.Qnt QntBOMX, A.QntBOM*BD.Qnt QntBOM, 
		ISNULL(S.QntStockR,0) QntStockR, ISNULL(S.QntOutPO,0) QntOutPO, ISNULL(S.QntOutPrd,0) QntOutPrd, ISNULL(S.QntOutSPK,0) QntOutSPK,
		ISNULL(S.QntStock,0) QntStock, ISNULL(S.QntStock,0)-A.QntBOM*BD.Qnt QntSisaStock, 
		case when B2.KodeBOM IS null then null else 
			case when ISNULL(S.QntStock,0)-A.QntBOM*BD.Qnt<0 then ABS(ISNULL(S.QntStock,0)-A.QntBOM*BD.Qnt) else 0 end end QntProduksi, Brg.IsBarang
	from TempStockBOM2 A
	left outer join DBBOM B on B.KODEBRG=A.KodeBrg
	left outer join DBBOMDET BD on BD.KodeBOM=B.KodeBOM
	left outer join DBBOM B2 on B2.KodeBrg=BD.KodeBrg
	left outer join dbBarang Brg on Brg.KodeBrg=BD.KodeBrg
	left outer join TempStockBOM_ S on S.KodeBrg=BD.KodeBrg
	where A.IDUser=@IDUser and A.IntLevelBOM=@xMaxIntLevelBOM
	and A.IsBarang<>1
	order by BD.Urut
	
	select @xMaxIntLevelBOM=MAX(IntLevelBOM) from TempStockBOM2 where IDUser=@IDUser
	
	if not exists(select * from TempStockBOM2 where IDUser=@IDUser and IntLevelBOM=@xMaxIntLevelBOM and IsBarang<>1) 
	begin
		select @xIsLanjut=0
	end else
	begin
		select @xIsLanjut=1
	end

end

delete TempStockBOM 
where StrLevelBOM like @StrLevelBOM+'%' and StrLevelBOM>@StrLevelBOM
and IDUser=@IDUser

insert into TempStockBOM
select * from TempStockBOM2 where IDUser=@IDUser

update TempStockBOM set QntProduksi=@QntBrgJadi, QntBOM=@QntBrgJadi
where StrLevelBOM=@StrLevelBOM and IDUser=@IDUser










GO

-- Procedure: SP_PurchaseAnalysis_Final
-- Created: 2025-08-21 08:57:18.987 | Modified: 2025-08-21 08:57:18.987
-- =====================================================

    CREATE PROCEDURE SP_PurchaseAnalysis_Final
        @TanggalAwal DATE,
        @TanggalAkhir DATE,
        @KODESUPP NVARCHAR(20) = NULL
    AS
    BEGIN
        SET NOCOUNT ON;
        
        SELECT 
            p.KODESUPP,
            cs.NAMACUSTSUPP AS NamaSupplier,
            COUNT(p.NOBUKTI) AS JumlahPO,
            SUM(pd.QNT * pd.HARGA) AS TotalDPP,
            SUM(pd.QNT * pd.HARGA * (CASE WHEN p.PPN = 1 THEN 0.11 ELSE 0 END)) AS TotalPPN,
            SUM(pd.QNT * pd.HARGA * (1 + CASE WHEN p.PPN = 1 THEN 0.11 ELSE 0 END)) AS TotalNet,
            AVG(pd.QNT * pd.HARGA) AS RataRataPO,
            COUNT(CASE WHEN p.IsClose = 1 THEN 1 END) AS POClosed,
            COUNT(CASE WHEN p.IsBatal = 1 THEN 1 END) AS POBatal,
            MIN(p.TANGGAL) AS POPertama,
            MAX(p.TANGGAL) AS POTerakhir
        FROM DBPO p
        INNER JOIN DBPODET pd ON p.NOBUKTI = pd.NOBUKTI
        INNER JOIN DBCUSTSUPP cs ON p.KODESUPP = cs.KODECUSTSUPP
        WHERE p.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND (@KODESUPP IS NULL OR p.KODESUPP = @KODESUPP)
        GROUP BY p.KODESUPP, cs.NAMACUSTSUPP
        ORDER BY SUM(pd.QNT * pd.HARGA) DESC;
    END
    
GO

-- Procedure: SP_Quotation
-- Created: 2011-08-19 08:47:46.933 | Modified: 2011-08-19 08:47:46.933
-- =====================================================


CREATE Procedure [dbo].[SP_Quotation]
@Choice varchar(1),
@NoBukti varchar(30),
@Nourut Varchar(5),
@Tanggal datetime,
@kodecustSupp varchar(15),
@Term_Of_Payment varchar(8000),
@Packing varchar(8000),
@Delivery varchar(8000),
@Price_Validity Datetime,
@Note_Quotation varchar(8000),
@ppn Tinyint,
@Valas varchar(15),
@Kurs numeric(18,4),
@kodebrg varchar(25),
@Namabrg varchar(200),
@urut int,
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Sat1 varchar(5),
@Sat2 varchar(5),
@isi numeric(18,2),
@nosat tinyint,
@Harga Numeric(18,4),
@NoCR varchar(30),
@urutCR int,
@IsLokal Bit
as
Begin Tran
  if (@choice='I') 
  begin
    Select @urut=MAX(urut) from dbQuotationDet where Nobukti=@NoBukti
    set @urut=ISNULL(@urut,0)+1
    if not exists(Select 'True' from dbQuotation where Nobukti=@NoBukti)
    begin
      insert into dbQuotation(Nobukti,NoUrut,Tanggal,KodecustSupp,PPN,Valas,
                              Term_of_Payment,Packing,Delivery,Price_Validity,Note_Quotation,Kurs, Islokal)
      values(@NoBukti,@Nourut,@Tanggal,@kodecustSupp,@ppn,@Valas,@Term_Of_Payment,@Packing,@Delivery,
             @Price_Validity,@Note_Quotation,@Kurs,@IsLokal)
    end
    insert into dbQuotationDet(Nobukti,Urut,NoCR,UrutCR,PPN,Kurs,KodeBrg,Sat_1,Sat_2,Isi,Nosat,
                               Qnt,Qnt2,Harga, Namabrg)
    Values(@NoBukti,@urut,@NoCR,@urutCR,@ppn,@Kurs,@kodebrg,@Sat1,@Sat2,@isi,@nosat,@qnt,@qnt2,@Harga, @Namabrg)                              
                            
  end
  else
  if (@choice='U')
  begin
	Update dbQuotationDet set KodeBrg=@kodebrg, NoCR=@NoCR, UrutCR=@urutCR,
	                          PPN=@ppn,Kurs=@Kurs,Sat_1=@Sat1,Sat_2=@Sat2,
	                          Qnt=@Qnt,Qnt2=@qnt2,Isi=@isi,Nosat=@nosat, 
	                          Harga=@Harga, Namabrg=@Namabrg
	where NoBukti=@NoBukti and Urut=@urut
  end
  else if (@choice='D')
  begin
	delete dbQuotationDet where NoBukti=@NoBukti and Urut=@urut
	if not exists(select 'True' from dbQuotationDet where Nobukti=@NoBukti)
	   delete dbQuotation where NoBukti=@NoBukti
  end
  if @@ERROR<>0 goto JikaSalah 

Commit Tran
Return
JikaSalah: Rollback Tran
           Return

select * from dbQuotationDet




GO

-- Procedure: Sp_QuotationKirim
-- Created: 2011-08-05 10:16:59.523 | Modified: 2011-08-05 10:32:44.467
-- =====================================================



CREATE Procedure [dbo].[Sp_QuotationKirim]
@Choice varchar(1),
@urut int,
@NoEnquiryDet varchar(30),
@UrutEnq int,
@Tglkirim Datetime,
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2),
@Keterangan varchar(200)

As 
begin tran
if @Choice='I'
begin
  Select @urut=MAX(urut) from DBQuotationKIRIM where NOQuo=@NoEnquiryDet and urutQuo=@UrutEnq
  Set @urut=ISNULL(@urut,0)+1
  Insert into DBQuotationKIRIM (urut, noQuo, urutQuo, TglKirim, Sat_1, Sat_2, Qnt, Qnt2, Nosat, Isi, Keterangan)
  values (@urut,@NoEnquiryDet,@UrutEnq,@Tglkirim,@Sat_1,@Sat_2, @qnt, @qnt2, @Nosat, @Isi, @Keterangan)
end
else if @Choice='U'
begin
  update DBQuotationKIRIM set TglKirim=@Tglkirim, Qnt=@qnt, qnt2=@qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
  Nosat=@Nosat, isi=@isi, Keterangan=@Keterangan
  where urut=@urut and NOQuo=@NoEnquiryDet and urutQuo=@UrutEnq
end
else if @Choice='D'
begin
  delete DBQuotationKIRIM where urut=@urut and NOQuo=@NoEnquiryDet and urutQuo=@UrutEnq
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return




GO

-- Procedure: Sp_RBeli
-- Created: 2013-12-17 14:00:33.767 | Modified: 2013-12-17 14:00:33.767
-- =====================================================



CREATE Procedure [dbo].[Sp_RBeli]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@TglJatuhTempo Datetime,
@KodeSupp varchar(15),
@NoBeli varchar(20),
@KodeGdg varchar(15),
@Handling numeric(18,2),
@KodeExp varchar(20),
@Keterangan varchar(200),
@FakturSupp Varchar(20),
@KodeVls varchar(15),
@Kurs numeric(18,2),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@TipeDisc tinyint,
@Disc float,
@DiscRp numeric(18,2),
@Urut int,
@KodeBrg varchar(25),
@Qnt numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2),
@Satuan varchar(5),
@Harga numeric(18,4),
@DiscP numeric(18,2),
@DiscTot numeric(18,2),
@UrutPBL int,
@Qnt2 numeric(18,2),
@Qnt1 Numeric(18,2)

As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbRBelidet Where NoBukti=@NoBukti
  if not exists(select * from dbRBeli Where NoBukti=@NoBukti) 
  begin
    insert into dbRBeli (NOBUKTI, NOURUT, TANGGAL,Kodegdg, TglJatuhTempo, KODESUPP, NoBeli, Handling, KodeExp, KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP)
    values (@NOBUKTI, @NOURUT, @TANGGAL,@KodeGdg, @TglJatuhTempo, @KODESUPP, @NoBeli, @Handling, @KodeExp, @KETERANGAN,
	@FakturSupp, 'IDR', @KURS, @PPN, @TIPEBAYAR, @HARI, @TIPEDISC, @DISC, @DISCRP)
  end
  insert into dbRBeliDET (NOBUKTI, URUT, PPN, Disc, KODEBRG, QNT, NoSat, Isi, Satuan, HARGA, DISCP, DISCTOT, UrutPBL,Qnt2, KURS,Qnt1)
  values(@NOBUKTI, @URUT, @PPN, @Disc, @KODEBRG, @Qnt, @NoSat, @Isi, @Satuan, @Harga, @DiscP, @DiscRp, @UrutPBL,@Qnt2, @Kurs,@Qnt1 )
end
if @Choice='U'
begin
  update dbRBeliDET set KodeBrg=@KODEBRG, Qnt=@QNT, NoSat=@NoSat, Isi=@Isi, Satuan=@Satuan, Harga=@HARGA, DiscP=@DiscP, DiscTot=@DiscTot, UrutPBL=@UrutPBL,Qnt2=@Qnt2,
  Qnt1=@Qnt1
  where NoBukti=@NoBukti and Urut=@Urut
end
if @Choice='D'
begin
  delete dbRBeliDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbRBeliDET where NoBukti=@NoBukti)
  begin
    delete dbRBeli where NoBukti=@NoBukti
  end
end
if Exists(select NoBukti from DBRBELIDET where NOBUKTI=@NoBukti) 
 Begin
   Update DBRBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBRBELIDET where NOBUKTI=DBRBELI.NOBUKTI),
                     NILAINET=(select SUM(NNET)NNET from DBRBELIDET where NOBUKTI=DBRBELI.NOBUKTI),
                     NILAIPPN=(select SUM(NPPN)NPPN from DBRBELIDET where NOBUKTI=DBRBELI.NOBUKTI)
   where NOBUKTI=@NoBukti                  
 End 

if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return






GO

-- Procedure: sp_RBeliGudang
-- Created: 2013-06-03 11:12:29.317 | Modified: 2014-11-19 15:09:30.687
-- =====================================================



CREATE   Procedure [dbo].[sp_RBeliGudang]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@KodeSupp varchar(15),
@KodeGdg varchar(15),
@NoBeli varchar(20),
@Keterangan varchar(200),
@FakturSupp Varchar(20),
@Urut int,
@KodeBrg varchar(25),
@UrutPBL int,
@Qnt numeric(18,2),
@NoSat tinyint,
@Satuan varchar(5),
@Isi numeric(18,2),
@Qnt1 numeric(18,2),
@Qnt2 numeric(18,2),
@FlagTipe Tinyint,
@Nobatch varchar(50)
as
declare @Harga numeric(18,2), @DiscP numeric(18,2), @DiscTot numeric(18,2)
declare @PPN int, @Disc float, @Kurs numeric(18,4),@Isjasa Bit,@NamaBrg Varchar(100)
Declare @Discp2 Numeric(18,2),@Discp3 Numeric(18,2),@Discp4 Numeric(18,2),@Discp5 Numeric(18,2)
begin tran

if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbRBeliDet Where NoBukti=@NoBukti
  if @@error<>0  goto jikasalah
  if not exists(select * from dbRBeli Where NoBukti=@NoBukti) 
  begin
    insert into dbRBeli (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODESUPP, Handling,  KETERANGAN, 
	FakturSUPP, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp, NoBeli, KodeGdg,FlagTipe)
	select @NoBukti, @NoUrut, @Tanggal, @Tanggal+HARI, @KodeSupp, HANDLING, @Keterangan,
	@FakturSupp, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DISCRP, @NoBeli, @KodeGdg,@FlagTipe
	from DBBELI 
	where NOBUKTI=@NoBeli
	if @@error<>0  goto jikasalah
  end
  
  select @PPN=PPN, @Disc=DISC, @Kurs=KURS from DBRBELI where NOBUKTI=@NoBukti
  if @@error<>0  goto jikasalah
  
  select top 1 @Harga=HARGA, @DiscP=DISCP, @DiscTot=DISCTOT,@Discp2=DiscP2,@Discp3=DiscP3,@Discp4=DiscP4,@Discp5=DiscP5 
  ,@Isjasa=ISjasa,@NamaBrg=NamaBrg
  from DBBELIDET
  where NOBUKTI=@NoBeli and Urut=@UrutPBL
  if @@error<>0  goto jikasalah
  
  select @Harga=ISNULL(@Harga,0), @DiscP=ISNULL(@DiscP,0), @DiscTot=ISNULL(@DiscTot,0)
  if @@error<>0  goto jikasalah
  
  insert into dbRBeliDET (NOBUKTI, URUT, KODEBRG, PPN, DISC, KURS, 
  QNT, NOSAT, SATUAN, ISI, HARGA, DISCP, DISCTOT, BYANGKUT, 
  NOPBL, URUTPBL, HPP, Qnt1, Qnt2,DiscP2,DiscP3,DiscP4,DiscP5,Isjasa,namaBrg,Nobatch)
  values(@NOBUKTI, @URUT, @KODEBRG, @PPN, @Disc, @Kurs,
  @Qnt, @NoSat, @Satuan, @Isi, @Harga, @DiscP, @DiscTOT, 0.00,
  @NoBeli, @UrutPBL, 0, @Qnt1, @Qnt,@Discp2,@Discp3,@Discp4,@Discp5,@Isjasa,@NamaBrg,@Nobatch)
  if @@error<>0  goto jikasalah
end

if @Choice='U'
begin
  update dbRBeliDET set KodeBrg=@KODEBRG,  Qnt=@Qnt, NOSAT=@NoSat, SATUAN=@Satuan, ISI=@Isi,
  Qnt1=@Qnt1, Qnt2=@Qnt2,Nobatch=@Nobatch
  where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah
end

if @Choice='D'
begin
  delete dbRBeliDET where NoBukti=@NoBukti and Urut=@Urut
  if @@error<>0  goto jikasalah 
  if not exists( select NoBukti from dbRBeliDET where NoBukti=@NoBukti)
  begin
    delete dbRBeli where NoBukti=@NoBukti
    if @@error<>0  goto jikasalah
  end
end
--if Exists(select NoBukti from DBBELIDET where NOBUKTI=@NoBukti) 
-- Begin
--   Update DBBELI Set NILAIDPP=(select SUM(NDPP)NDPP from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAINET=(select SUM(NNET)NNET from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI),
--                     NILAIPPN=(select SUM(NPPN)NPPN from DBBELIDET where NOBUKTI=DBBELI.NOBUKTI)
--   where NOBUKTI=@NoBukti                  
-- End 
--if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: sp_RefreshOutPPL
-- Created: 2013-02-20 08:36:46.013 | Modified: 2013-02-20 08:36:46.013
-- =====================================================
CREATE   Procedure [dbo].[sp_RefreshOutPPL]
@NoBukti varchar(20)

As

update 	dbPPLDet set QntPO=isnull(B.QntPO,0)
from	dbPPLDet A
left outer join
	(select NoPPL, UrutPPL, sum(Qnt) QntPO from dbPODet
	where NoPPL=@NoBukti
	group by NoPPL, UrutPPL
	) B on B.NoPPL=A.NoBukti and B.UrutPPL=A.Urut
where	A.NoBukti=@NoBukti





GO

-- Procedure: SP_RefreshQntBatalPO
-- Created: 2011-06-04 10:23:36.450 | Modified: 2011-06-14 10:46:42.660
-- =====================================================
CREATE Procedure [dbo].[SP_RefreshQntBatalPO]

as

update DBPODET set QntBtl=ISNULL(B.Qnt,0), Qnt2Btl=ISNULL(B.Qnt2,0) 
from dbPODet A
left outer join
	(select A.NOBUKTI, A.URUT 
	from DBPODET A
	left outer join DBBatalPODET B on B.NoPO=A.NOBUKTI and B.UrutPO=A.URUT
	group by A.NOBUKTI, A.URUT, A.QntBtl ,A.Qnt2Btl
	having ISNULL(A.QntBtl,0)<>SUM(isnull(B.Qnt,0)) or ISNULL(A.Qnt2Btl,0)<>SUM(isnull(B.Qnt2,0))
	) A0 on A0.NOBUKTI=A.NOBUKTI and A0.URUT=A.URUT
left outer join 
	(select NOPO, UrutPO, sum(Qnt) Qnt, sum(Qnt2) Qnt2 from dbBatalPODet 
	group by NoPO, UrutPO
	) B on B.NOPO=A.NOBUKTI and B.UrutPO=A.Urut
where A0.NOBUKTI is not null







GO

-- Procedure: SP_RefreshQntBatalPPL
-- Created: 2011-06-04 10:32:36.430 | Modified: 2011-06-04 10:32:36.430
-- =====================================================






CREATE Procedure [dbo].[SP_RefreshQntBatalPPL]

as

update DBPPLDET set QntBtl=ISNULL(B.Qnt,0), Qnt2Btl=ISNULL(B.Qnt2,0) 
from dbPPLDet A
left outer join
	(select A.NOBUKTI, A.URUT 
	from DBPPLDET A
	left outer join DBBatalPPLDET B on B.NoPPL=A.NOBUKTI and B.UrutPPL=A.URUT
	group by A.NOBUKTI, A.URUT, A.QntBtl ,A.Qnt2Btl
	having ISNULL(A.QntBtl,0)<>SUM(isnull(B.Qnt,0)) or ISNULL(A.Qnt2Btl,0)<>SUM(isnull(B.Qnt2,0))
	) A0 on A0.NOBUKTI=A.NOBUKTI and A0.URUT=A.URUT
left outer join 
	(select NOPPL, UrutPPL, sum(Qnt) Qnt, sum(Qnt2) Qnt2 from dbBatalPPLDet 
	group by NoPPL, UrutPPL
	) B on B.NOPPL=A.NOBUKTI and B.UrutPPL=A.Urut
where A0.NOBUKTI is not null




GO

-- Procedure: sp_RefreshTempOutstandingPO
-- Created: 2013-02-20 12:02:43.310 | Modified: 2014-11-19 13:36:18.790
-- =====================================================

CREATE   Procedure [dbo].[sp_RefreshTempOutstandingPO]
--Declare
@IDUser varchar(30),
@NoBukti varchar(20),
@Tahun int,
@Bulan int,
@FlagTipe int

As 
--select * from dbpo
--Select @NoBukti='SLX/PO/00001/1214',@IDUser='SA',@Tahun=2014,@Bulan=12

delete	TempOutstandingPO where IDUser=@IDUser or @NoBukti=@NoBukti

insert into TempOutstandingPO (IDUser, IsTerima, NOBUKTI, Tanggal, KeyNoBukti, 
	URUT, KODEBRG, KodeWarna, NAMABRG, QNT, NOSAT, SATUAN, ISI, 
	HARGA, DISCP, DISCTOT, QntSisa, CollyTerima, QntTerima,Discp2,Discp3,Discp4,Discp5,FlagTipe,KodeCustSupp,Isjasa,NObatch) 

select	@IDUser, cast(0 as bit) IsTerima, A.NoBukti, A.Tanggal, A.NoBukti+'-'+right('00000000'+cast(min(A.Urut) as varchar(8)),8) KeyNoBukti, 
	min(A.Urut) Urut,
	-- A.URUT,
	 A.KodeBrg, '' KodeWarna, Convert(Varchar(100),A.NamaBrg), sum(A.Qnt) Qnt, A.NoSat, 
	case when A.NOSAT=1 then Br.SAT1 when A.nosat=2 then Br.SAT2 when A.NOSAT=3 then Br.SAT3 end Satuan, 
	case when A.NOSAT=1 then 1  when A.nosat=2 then Br.ISI2 when A.Nosat=3 then Br.ISI3 end Isi, 
	max(A.Harga) Harga, DiscP, DiscTot, sum(A.QntOut) QntSisa, 0 CollyTerima, sum(A.QntOut) QntTerima,
	Discp2,Discp3,Discp4,Discp5,FlagTipe,A.KODESUPP,A.IsJasa,'' Nobatch

from (

select A.NoBukti, A.Tanggal, B.Urut, B.KODEBRG,B.NamaBrg, B.NOSAT, B.Qnt, B.Qnt+B.Tolerate-(Isnull(B.QntBatal,0)) QntOut, B.HARGA , B.DISCP, B.DISCTOT,
B.DiscP2,B.DiscP3,B.DiscP4,B.DiscP5,A.FlagTipe,A.KODESUPP,ISnull(B.ISjasa,0) Isjasa
from DBPO A, DBPODET B
where A.NOBUKTI=B.NOBUKTI and A.NOBUKTI=@NoBukti
union all
select A.NoBukti, A.Tanggal, 99999 Urut, B.KODEBRG,B.NamaBrg, B.NOSAT, 0.00 Qnt, -(B.Qnt) QntOut, 0.00 Harga, B.DISCP, B.DISCTOT,
B.DiscP2,B.DiscP3,B.DiscP4,B.DiscP5,A.FlagTipe,A.KODESUPP,ISnull(B.Isjasa,0) Isjasa
from DBPO A, DBBELIDET B
where A.NOBUKTI=B.NoPO and A.NOBUKTI=@NoBukti

) A
left outer join DBBARANG Br on Br.KODEBRG=A.KODEBRG 

group by A.NOBUKTI, A.TANGGAL, A.KODEBRG, A.NAMABRG, A.NOSAT, Br.SAT1, Br.SAT2,
 Br.ISI1, Br.ISI2, DISCP, DISCTOT,DiscP2,DiscP3,
DiscP4,DiscP5,A.FlagTipe,A.KODESUPP,A.ISjasa,Br.ISI3,br.SAT3--,A.URUT
having  sum(A.QntOut)>0



GO

-- Procedure: sp_RefSettingStdCost
-- Created: 2014-10-07 15:11:15.870 | Modified: 2014-10-07 15:11:15.870
-- =====================================================
CREATE        Procedure [dbo].[sp_RefSettingStdCost]
@KodeForm int,
@KodeSetting varchar(25)

as

-- Ambil Bahan Baku
if @KodeForm=10
begin
	insert into dbBahanStdCost (KodeSetting, KodeBrg, Harga)
	select @KodeSetting, A.KodeBrg, 0.00 
	from dbBarang A 
	left outer join dbBahanStdCost B on B.KodeBrg=A.KodeBrg and B.KodeSetting=@KodeSetting
	where B.KodeBrg is null
	and A.IsBarang=1 
end

-- Ambil Biaya Proses
if @KodeForm=30
begin
	
	insert into dbBiayaStdCost (KodeSetting, KodeBrg, Harga)
	select @KodeSetting, A.KodeBrg, 0.00 
	from dbBarang A 
	left outer join dbBiayaStdCost B on B.KodeBrg=A.KodeBrg and B.KodeSetting=@KodeSetting
	where B.KodeBrg is null
	and A.IsBarang=3 and isnull(A.IsJasa,0)=0 

end

-- Refresh Harga Pokok
if @KodeForm=90
begin
	
	--delete	dbHPProduksiStd where KodeSetting=@KodeSetting
	
	insert into dbHPProduksiStd (KodeSetting, KodeBrg, RpBahan, RpProses, HPP)
	select @KodeSetting, A.KodeBrg, 0.00, 0.00, 0.00 
	from dbBarang A 
	left outer join dbHPProduksiStd B on B.KodeBrg=A.KodeBrg and B.KodeSetting=@KodeSetting
	where B.KodeBrg is null
	and A.IsBarang=3 and isnull(A.IsJasa,0)=0 
	
	update dbHPProduksiStd
	set KodeBOM=ISNULL(B1.KodeBOM,'')
	from dbHPProduksiStd A
	left outer join
		(select KodeBrg, MIN(case when IsDefault=1 then '00' else '01' end+KodeBOM) MinKodeBOM
		from DBBOM
		group by KodeBrg
		) B on B.KodeBrg=A.KodeBrg
	left outer join DBBOM B1 on case when B1.IsDefault=1 then '00' else '01' end+B1.KodeBOM=B.MinKodeBOM and B1.KodeBrg=B.KodeBrg
	where A.KodeSetting=@KodeSetting
	
	update dbHPProduksiStd
	set RpBahan=ISNULL(Y.RpBahan,0)
	from dbHPProduksiStd X
	left outer join
		(select A.KodeBOM, sum(A.Numerator*B.Harga) RpBahan 
		from DBBOMDET A
		left outer join dbBahanStdCost B on B.KodeBrg=A.KodeBrg and B.KodeSetting=@KodeSetting
		group by A.KodeBOM
		) Y on Y.KodeBOM=X.kodeBOM
	where X.KodeSetting=@KodeSetting
	
	
	update dbHPProduksiStd 
	set RpProses=isnull(B.Harga,0)
	from dbHPProduksiStd A
	left outer join dbBiayaStdCost B on B.KodeSetting=A.KodeSetting and B.KodeBrg=A.KodeBrg
	where A.KodeSetting=@KodeSetting
	
	update dbHPProduksiStd 
	set HPP=isnull(RpBahan,0)+ISNULL(RpProses,0)
	where KodeSetting=@KodeSetting
	
	

end







GO

-- Procedure: sp_RegisterGiroHutang
-- Created: 2012-07-10 11:00:20.560 | Modified: 2012-10-15 15:12:25.720
-- =====================================================
CREATE Procedure [dbo].[sp_RegisterGiroHutang] 
@Perkiraan Varchar(20),
@Tanggal dateTime,
@Tanggal1 Datetime,
@Devisi varchar(20)
As
--Select @Perkiraan='111',@Tanggal='03-20-2008',@Devisi='01',@Tanggal1='03-20-2008'
Declare @bulan int,@tahun Int,@TglCair datetime,@TglBuka datetime
Select @Bulan=Month(@tanggal),@tahun=Year(@Tanggal)
Select @tahun=@tahun+Case when @bulan=12 then 1 else 0 end
Select @Tglcair=Cast(cast(@bulan as varchar(2))+'-01-'+cast(@tahun as varchar(4)) as datetime)
Select @tglBuka=dateadd(dd,0,cast(cast(@Bulan+1 as varchar(2))+'-01-'+cast(@tahun as varchar(4)) as datetime))

 delete dbtempbkbesar where devisi=@devisi
 Declare @xPerkiraan varchar(20),@tipe varchar(2)
 Declare CurNeraca Cursor for
  select Perkiraan from dbperkiraan where perkiraan=@Perkiraan and tipe=1
  order by perkiraan    
 Open CurNeraca
    Fetch Next from CurNeraca into @xperkiraan
 While @@fetch_Status=0
 begin
  exec sp_GenerateSaldobukutambahan @bulan,@tahun,@xperkiraan,'T',@devisi
  exec Sp_GenerateTransBukuTambahan @Tanggal,@xperkiraan,'T',@devisi,@Tanggal1
  Fetch Next from CurNeraca into @perkiraan
 end
     Close CurNeraca
     Deallocate CurNeraca


Select 1 urut,a.TglBuka,a.buktibuka,a.Keterangan,a.Nogiro,a.TglGiro,
       0 debet, a.KreditRp Kredit, a.KreditRp Jumlah, 0 Debet_1, 0 kredit_1, 0 Saldo
from DBGiro a
     left outer join dbtransaksi b on b.nobukti=a.buktibuka and b.Urut=a.UrutBuktiBuka
Where a.bank=@Perkiraan and (a.TglBuka between @Tanggal and @Tanggal1) and a.Tipe='HT'
union
Select 2,case when (a.bukticair like '%BBM%' and a.Tipe='HT') then a.TglCair else a.TglGiro end 'TglCair', a.bukticair,a.Keterangancair,a.Nogiro,Case when a.nogiro<>'' then a.TglGiro else null end 'TglGiro',
       a.KreditRp Debet, 0 , -a.KreditRp Jumlah,case when b.NoBukti <>'' then  b.KreditRp else 0 end Debet_1,a.KreditRp Kredit_1,(case when b.NoBukti <>'' then  b.KreditRp else 0 end) - a.KreditRp Saldo
from DBGiro a
     left outer join dbtransaksi b on b.nobukti=isnull(a.buktiBuka,'') and b.Urut=a.UrutBuktiBuka
where  a.bank=@Perkiraan and (a.TglGiro between @Tanggal and @Tanggal1) and a.Tipe='HT'
union
Select 3,a.Tanggal,a.Nobukti,a.Keterangan,null Nogiro,Case when b.nogiro<>'' then b.TglGiro else null end 'TglGiro',0,0,0,
       Case when a.Perkiraan=@Perkiraan then A.DebetRp else 0 end Debet_1, 
       case when a.Perkiraan=@Perkiraan then 0 else A.DebetRp end Kredit_1 ,
       Case when a.Perkiraan=@Perkiraan then a.DebetRp else -a.DebetRp end saldo
From dbTransaksi a
     left Outer join dbgiro B on B.Buktibuka=A.nobukti and B.urutBuktiBuka=A.urut and B.Tipe='HT'
where  (a.Tanggal between @Tanggal and @Tanggal1) and (a.Perkiraan=@Perkiraan or a.lawan=@Perkiraan)
     and A.NoBukti+Cast(a.Urut as varchar(5)) not in (Select x.BuktiBuka+Cast(x.UrutBuktiBuka as varchar(5)) from DBGIRO x where x.Tipe='HT' and (x.TglBuka between @Tanggal and @Tanggal1) and x.Bank=a.Lawan)
Union 
Select 0 urut,null,'Saldo Awal','Saldo Awal','',null,0,0,
       Isnull((Select sum(a.KreditRp)
               From DBGiro a 
               where (a.tglGiro>=@Tanggal) and a.TglBuka<@Tanggal and a.Bank=@perkiraan
       ),0),0,0,
       isnull(sum(case when b.transaksi='D' then b.Debet-b.kredit
                when b.transaksi='K' then b.Kredit-b.debet
                else b.Saldoawal 
           end),0)+Isnull((Select sum(a.KreditRp)
               From DBGiro a 
               where (a.tglGiro>=@Tanggal) and a.TglBuka<@Tanggal and a.Bank=@perkiraan
       ),0)
From dbTempbkBesar b
where b.tanggal<@Tanggal and b.noacc=@Perkiraan
order by TglBuka

GO

-- Procedure: SP_RekamLanjut
-- Created: 2011-07-07 12:44:16.887 | Modified: 2011-08-19 09:28:29.733
-- =====================================================


CREATE Procedure [dbo].[SP_RekamLanjut]
@choice varchar(1),
@nobukti varchar(30),
@Nourut varchar(5),
@Tanggal datetime,
@KodeCustSupp varchar(15),
@PPn tinyint,
@Valas varchar(15),
@kurs numeric(18,4),
@Kotatujuan varchar(50),
@Price_List numeric(18,2),
@FOB numeric(18,2),
@Franco numeric(18,2),
@KomisiP1 numeric(18,2),
@KomisiRp1 numeric(18,2),
@subtotal1 numeric(18,2),
@Ongkos_Laut numeric(18,2),
@Asuransi numeric(18,2),
@KomisiP2 numeric(18,2),
@KomisiRp2 numeric(18,2),
@subtotal2 numeric(18,2),
@GrandTotal numeric(18,2),
@HargaTawar numeric(18,2),
@IsKontrak bit,
@urut int,
@NoQuo varchar(30),
@UrutQuo int,
@KodeBrg varchar(25),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Isi numeric(18,2),
@Nosat tinyint,
@qnt numeric(18,2),
@qnt2 numeric(18,2),
@harga numeric(18,4),
@isLokal Bit,
@Namabrg varchar(200)
as
begin tran
if @choice='I'
begin
  Select @urut=Max(Urut) from dbRekamLanjutDet where Nobukti=@nobukti
  Set @urut=ISNULL(@urut,0)+1
  if not exists(select 'True' from dbRekamLanjut where Nobukti=@nobukti)
  begin
  insert into dbRekamLanjut(Nobukti,Nourut,Tanggal,KodeCustSupp,Valas,Kurs,KotaTujuan,isLokal)
  Values (@Nobukti,@Nourut,@Tanggal,@KodeCustSupp,@Valas,@kurs, @Kotatujuan,@isLokal)
  end
  insert into dbRekamLanjutDet(Nobukti,Urut,NoQuo,UrutQuo,PPn,Kodebrg,Sat_1,Sat_2,Isi,Nosat,Qnt,Qnt2,Harga,Kurs,
  PriceList,FOB,Franco,KomisiP1,komisiRp1, SubTotal1,Ongkos_Laut,Asuransi,KomisiP2,komisiRp2,SubTotal2,GrandTotal,HargaTawar,IsKontrak, Namabrg)
  values(@nobukti, @urut, @NoQuo, @UrutQuo, @PPn, @KodeBrg, @Sat_1, @Sat_2, @Isi, @Nosat, @qnt, @qnt2, @Harga, @kurs,
  @Price_List,@FOB,@Franco,@KomisiP1,@KomisiRp1,
                            @subtotal1,@Ongkos_Laut,@Asuransi,@KomisiP2,@KomisiRp2,@subtotal2,@GrandTotal,@HargaTawar,
                            @IsKontrak,@Namabrg)
end				
else if @choice='U'
begin
  update dbRekamLanjut set Tanggal=@Tanggal,KotaTujuan=@Kotatujuan,
                           islokal=@isLokal, Kurs=@kurs
  where Nobukti=@nobukti
  update dbRekamLanjutDet   set NoQuo=@NoQuo,UrutQuo=@UrutQuo,Kodebrg=@KodeBrg,PPn=@PPn,Sat_1=@Sat_1,Sat_2=@Sat_2,
                                Isi=@Isi,Nosat=@Nosat,Qnt=@qnt,Qnt2=@qnt2,
                                Harga=@harga,Kurs=@kurs,PriceList=@Price_List,FOB=@FOB, Franco=@Franco, KomisiP1=@KomisiP1,
                           komisiRp1=@KomisiRp1,KomisiP2=@KomisiP2,komisiRp2=@KomisiRp2,
                           SubTotal1=@subtotal1,SubTotal2=@subtotal2, GrandTotal=@GrandTotal,
                           Ongkos_Laut=@Ongkos_Laut, Asuransi=@Asuransi, HargaTawar=@HargaTawar,
                           IsKontrak=@IsKontrak, Namabrg=@Namabrg
  where Nobukti=@nobukti and Urut=@urut
end
else if @choice='D'
begin
  delete dbRekamLanjutDet where Nobukti=@nobukti and Urut=@urut
  if not exists(Select 'True' from dbRekamLanjutDet where Nobukti=@nobukti)
  begin
    delete dbRekamLanjut where Nobukti=@nobukti
  end
end
if @@ERROR<>0 goto JikaSalah
commit Tran
Return
JikaSalah: Rollback Tran
           Return


GO

-- Procedure: Sp_RekamLanjutKirim
-- Created: 2011-10-14 12:27:57.853 | Modified: 2011-10-14 12:27:57.853
-- =====================================================
CREATE Procedure [dbo].[Sp_RekamLanjutKirim]
@Choice varchar(1),
@urut int,
@NoEnquiryDet varchar(30),
@UrutEnq int,
@Tglkirim Datetime,
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2),
@Keterangan varchar(200)

As 
begin tran
if @Choice='I'
begin
  Select @urut=MAX(urut) from DBRekamLanjutKIRIM where NORKL=@NoEnquiryDet and urutRKL=@UrutEnq
  Set @urut=ISNULL(@urut,0)+1
  Insert into DBRekamLanjutKIRIM (urut, noRKL, urutRKL, TglKirim, Sat_1, Sat_2, Qnt, Qnt2, Nosat, Isi, Keterangan)
  values (@urut,@NoEnquiryDet,@UrutEnq,@Tglkirim,@Sat_1,@Sat_2, @qnt, @qnt2, @Nosat, @Isi, @Keterangan)
end
else if @Choice='U'
begin
  update DBRekamLanjutKIRIM set TglKirim=@Tglkirim, Qnt=@qnt, qnt2=@qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
  Nosat=@Nosat, isi=@isi, Keterangan=@Keterangan
  where urut=@urut and NORKL=@NoEnquiryDet and urutRKL=@UrutEnq
end
else if @Choice='D'
begin
  delete DBRekamLanjutKIRIM where urut=@urut and NORKL=@NoEnquiryDet and urutRKL=@UrutEnq
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return





GO

-- Procedure: SP_RekapPenjualan
-- Created: 2025-08-21 08:09:41.767 | Modified: 2025-08-21 08:09:41.767
-- =====================================================

    CREATE PROCEDURE SP_RekapPenjualan
        @TanggalAwal DATE,
        @TanggalAkhir DATE,
        @KODECUST NVARCHAR(20) = NULL
    AS
    BEGIN
        SET NOCOUNT ON;
        
        SELECT 
            j.KODECUST,
            cs.NAMACUSTSUPP AS NamaCustomer,
            COUNT(j.NOBUKTI) AS JumlahTransaksi,
            SUM(j.NILAIDPP) AS TotalDPP,
            SUM(j.NILAIPPN) AS TotalPPN,
            SUM(j.NILAINET) AS TotalNet,
            AVG(j.NILAINET) AS RataRataTransaksi,
            MIN(j.TANGGAL) AS TransaksiPertama,
            MAX(j.TANGGAL) AS TransaksiTerakhir
        FROM DBJUAL j
        INNER JOIN DBCUSTSUPP cs ON j.KODECUST = cs.KODECUSTSUPP
        WHERE j.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND j.ISBATAL = 0
            AND (@KODECUST IS NULL OR j.KODECUST = @KODECUST)
        GROUP BY j.KODECUST, cs.NAMACUSTSUPP
        ORDER BY SUM(j.NILAINET) DESC;
    END
    
GO

-- Procedure: sp_renamediagram
-- Created: 2010-12-03 09:27:10.733 | Modified: 2010-12-03 09:27:10.733
-- =====================================================

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END
	
GO

-- Procedure: Sp_reportAnalisaSales
-- Created: 2013-02-26 16:12:57.163 | Modified: 2013-02-26 16:29:21.140
-- =====================================================

CREATE Procedure Sp_reportAnalisaSales
--declare 
@bulan integer,@tahun integer
as
select A.KeyNIK,A.NIK,A.Nama,B.KodeCustSupp,C.KODECUST,C.Nobukti,C.tanggal,
Case when ceiling (cast(datepart(dd,C.Tanggal)as numeric(38,8))/7)=1 then 1 else 0 end Minggu1,
Case when ceiling (cast(datepart(dd,C.Tanggal)as numeric(38,8))/7)=2 then 1 else 0 end Minggu2,
Case when ceiling (cast(datepart(dd,C.Tanggal)as numeric(38,8))/7)=3 then 1 else 0 end Minggu3,
Case when ceiling (cast(datepart(dd,C.Tanggal)as numeric(38,8))/7)=4 then 1 else 0 end Minggu4,
Case when ceiling (cast(datepart(dd,C.Tanggal)as numeric(38,8))/7)=5 then 1 else 0 end Minggu5

from dbKaryawan A 
left outer join DBSALESCUSTOMER B on A.KeyNIK = B.KeyNik
left outer join (select Nobukti,Tanggal,Kodesls,KODECUST from DBSO where
				 month(TANGGAL)=@Bulan and YEAR(tanggal)=@tahun)C on B.KeyNik = C.kodesls
left outer join DBCUSTSUPP D on C.KODECUST =d.KODECUSTSUPP 
where c.Nobukti is not null
order by a.KeyNIK,B.KodeCustSupp,C.NOBUKTI
GO

-- Procedure: Sp_ReportBankharian
-- Created: 2014-11-20 15:21:24.047 | Modified: 2014-11-25 16:04:12.367
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportBankharian]
--declare 
@SaldoAwalRp numeric(18,2), 
@TglAw datetime, 
@TglAk datetime,
@Perkiraan Varchar(25) 

As

--select @TglAw='10/01/2014', @TglAk='10/31/2014',@Perkiraan='111'


select @SaldoAwalRp=sum(isnull(Y0.SaldoRp,0)+isnull(Y1.SaldoRp,0)) 
from dbPostHutPiut X 
left outer join dbPerkiraan X1 on X1.Perkiraan=X.Perkiraan 
left outer join 
( select Perkiraan, sum(case when DK=0 then AwalD else AwalK end) SaldoUS, 
  sum(case when DK=0 then AwalDRp else AwalKRp end) SaldoRp 
from dbNeraca where Tahun=year(@TglAw) and Bulan=1 
group by Perkiraan 
) Y0 on Y0.Perkiraan=X.Perkiraan 
left outer join 
( 
select case when C1.Perkiraan is null then B.Lawan else B.Perkiraan end Perkiraan, 
  sum(case when C1.Perkiraan is null then 0 else B.DebetRp end-
  case when C1.Perkiraan is null then B.DebetRp else 0 end) SaldoRp,
  sum((case when C1.Perkiraan is null then 0 else B.Debet end-
  case when C1.Perkiraan is null then B.Debet else 0 end)*
  case when B.Kurs=1 then 0 else 1 end) SaldoUS 
from dbTrans A
left outer join dbTransaksi B on B.NoBukti=A.NoBukti 
left outer join DBPOSTHUTPIUT C1 on C1.Perkiraan=B.Perkiraan and C1.Kode='BANK' 
left outer join DBPOSTHUTPIUT C2 on C2.Perkiraan=B.Lawan and C2.Kode='BANK' 
where year(A.Tanggal)=2014 and A.Tanggal<@TglAw
and A.Tanggal>='06/01/2012' 
and ((C1.Perkiraan is not null) or (C2.Perkiraan is not null)) 
group by case when C1.Perkiraan is null then B.Lawan else B.Perkiraan end 
) Y1 on Y1.Perkiraan=X.Perkiraan 
where X.Kode='BANK' 
/*
and (X1.lokasi  Like (Case when @Lokasi=0 then 0
                           when @Lokasi=1 then 1
                      end) or
(Case when @Lokasi=0 then 0 
      when @Lokasi=1 then 1 
      else 2                
 end)=2) 
 */                   
and X.Perkiraan=@Perkiraan
select @SaldoAwalRp=isnull(@SaldoAwalRp,0) 
select X.Perkiraan, X1.Keterangan, @SaldoAwalRp SaldoAwal, 
case when X1.Valas='IDR' then 0 else isnull(Y0.SaldoUS,0)+isnull(Y1.SaldoUS,0)+isnull(Y2.SaldoUS,0) end SaldoUS, 
isnull(Y0.SaldoRp,0)+isnull(Y1.SaldoRp,0)+isnull(Y2.SaldoRp,0)+isnull(Z.CHGB,0) SaldoRp, 
isnull(Z.CHGB,0) CHGB, 
isnull(Y0.SaldoRp,0)+isnull(Y1.SaldoRp,0)+isnull(Y2.SaldoRp,0) SaldoTotalRp 
from dbPostHutPiut X 
left outer join dbPerkiraan X1 on X1.Perkiraan=X.Perkiraan 
left outer join 
( select Perkiraan, sum(case when DK=0 then AwalD else AwalK end) SaldoUS, 
  sum(case when DK=0 then AwalDRp else AwalKRp end) SaldoRp 
from dbNeraca where Tahun=year(@TglAw) and Bulan=1 
group by Perkiraan 
) Y0 on Y0.Perkiraan=X.Perkiraan 
left outer join 
( 
select case when C1.Perkiraan is null then B.Lawan else B.Perkiraan end Perkiraan, 
  sum(case when C1.Perkiraan is null then 0 else B.DebetRp end-
  case when C1.Perkiraan is null then B.DebetRp else 0 end) SaldoRp,
  sum((case when C1.Perkiraan is null then 0 else B.Debet end-
  case when C1.Perkiraan is null then B.Debet else 0 end)*
  case when B.Kurs=1 then 0 else 1 end) SaldoUS 
from dbTrans A
left outer join dbTransaksi B on B.NoBukti=A.NoBukti 
left outer join DBPOSTHUTPIUT C1 on C1.Perkiraan=B.Perkiraan and C1.Kode='BANK' 
left outer join DBPOSTHUTPIUT C2 on C2.Perkiraan=B.Lawan and C2.Kode='BANK' 
where year(A.Tanggal)=2014 and A.Tanggal<@TglAw
and A.Tanggal>='06/01/2012' 
and ((C1.Perkiraan is not null) or (C2.Perkiraan is not null)) 
group by case when C1.Perkiraan is null then B.Lawan else B.Perkiraan end 
) Y1 on Y1.Perkiraan=X.Perkiraan 
left outer join 
(
select case when C1.Perkiraan is null then B.Lawan else B.Perkiraan end Perkiraan, 
  sum((case when C1.Perkiraan is null then 0 else B.Debet end- 
  case when C1.Perkiraan is null then B.Debet else 0 end)* 
  case when B.Kurs=1 then 0 else 1 end) SaldoUS, 
  sum(case when C1.Perkiraan is null then 0 else B.DebetRp end- 
  case when C1.Perkiraan is null then B.DebetRp else 0 end) SaldoRp 
from dbTrans A 
left outer join dbTransaksi B on B.NoBukti=A.NoBukti 
left outer join DBPOSTHUTPIUT C1 on C1.Perkiraan=B.Perkiraan and C1.Kode='BANK' 
left outer join DBPOSTHUTPIUT C2 on C2.Perkiraan=B.Lawan and C2.Kode='BANK' 
where A.Tanggal between @TglAw and @TglAk
and ((C1.Perkiraan is not null) or (C2.Perkiraan is not null)) 
group by case when C1.Perkiraan is null then B.Lawan else B.Perkiraan end 
) Y2 on Y2.Perkiraan=X.Perkiraan 
left outer join 
(
select Bank, sum(KreditRp) CHGB from dbGiro 
where Tipe='HT' and isnull(TglCair,dateadd(day,1,+@TglAk+1))>@TglAk 
and TglBuka<=@TglAk 
and TglGiro>@TglAk 
group by Bank 
) Z on Z.Bank=X.Perkiraan 
where X.Kode='BANK' 
/*
and (X1.lokasi  Like (Case when @Lokasi=0 then 0
                           when @Lokasi=1 then 1
                      end) or
(Case when @Lokasi=0 then 0 
      when @Lokasi=1 then 1 
      else 2                
 end)=2) */
                    
and X.Perkiraan=@Perkiraan
order by X.Perkiraan 

GO

-- Procedure: Sp_reportBeliAccDet
-- Created: 2013-06-03 13:01:44.220 | Modified: 2015-03-09 15:32:12.917
-- =====================================================



CREATE Procedure [dbo].[Sp_reportBeliAccDet] 
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt,
@Iduser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		  If @NeedOto=2
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2  and Needotorisasi=@NeedOto
			order by KodeBrg
		If @NeedOto=2
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2  
			order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  If @NeedOto=0 or @NeedOto=1
		     select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			 order by KodeCustSupp
		  If @NeedOto=2
		     select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
			 order by KodeCustSupp
		end 		
End
else
begin
If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		  If @NeedOto=2
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
			and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2  and Needotorisasi=@NeedOto
			and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by KodeBrg
		If @NeedOto=2
			select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2  
			and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  If @NeedOto=0 or @NeedOto=1
		     select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			 and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			 order by KodeCustSupp
		  If @NeedOto=2
		     select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
			 and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			 order by KodeCustSupp
		end
End



GO

-- Procedure: Sp_ReportBeliACCRek
-- Created: 2013-06-03 13:01:44.237 | Modified: 2013-06-24 11:36:32.777
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportBeliACCRek] 
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto smallInt

as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
    If @NeedOto=0 or @NeedOto=1
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            sum(b.NDPP) as NDPP,sum(b.NDPPRp) as NDPPRP,sum(b.NPPNRp) as NPPNRp,sum(B.nnetrp) as NNETRP
		From  dbBeli a 
		left outer join DBBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2 and
        Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@needOto
		group by a.NOBUKTI,a.TANGGAL,j.NAMACUSTSUPP,a.KODEVLS,a.KURS
		order by  a.NOBUKTI
	 If @NeedOto=2
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            sum(b.NDPP) as NDPP,sum(b.NDPPRp) as NDPPRP,sum(b.NPPNRp) as NPPNRp,sum(B.nnetrp) as NNETRP
		From  dbBeli a 
		left outer join DBBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2
		group by a.NOBUKTI,a.TANGGAL,j.NAMACUSTSUPP,a.KODEVLS,a.KURS
		order by  a.NOBUKTI
End
else if @Choice='S'
begin
	 If @NeedOto=0 or @NeedOto=1
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            sum(b.NDPP) as NDPP,sum(b.NDPPRp) as NDPPRP,sum(b.NPPNRp) as NPPNRp,sum(B.nnetrp) as NNETRP
		From  dbBeli a 
		left outer join DBBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2 and
        Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@needOto
		group by a.NOBUKTI,a.TANGGAL,j.NAMACUSTSUPP,a.KODEVLS,a.KURS
		order by  J.NAMACUSTSUPP,a.NOBUKTI
	  If @NeedOto=2
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
        sum(b.NDPP) as NDPP,sum(b.NDPPRp) as NDPPRP,sum(b.NPPNRp) as NPPNRp,sum(B.nnetrp) as NNETRP
		From  dbBeli a 
		left outer join DBBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2
		group by a.NOBUKTI,a.TANGGAL,j.NAMACUSTSUPP,a.KODEVLS,a.KURS
		order by  J.NAMACUSTSUPP,a.NOBUKTI
end
else if @Choice='B'
begin
	if @NeedOto=0 or @NeedOto=1
		Select 	h.NAMABRG,a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            sum(b.NDPP) as NDPP,sum(b.NDPPRp) as NDPPRP,sum(b.NPPNRp) as NPPNRp,sum(B.nnetrp) as NNETRP
		From  dbBeli a 
		left outer join DBBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg	
		Where a.TANGGAL between @tgl1 and @tgl2 and
        Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@needOto		
		group by h.NAMABRG,a.NOBUKTI,a.TANGGAL,j.NAMACUSTSUPP,a.KODEVLS,a.KURS
		order by h.namabrg
	if @NeedOto=2			
		Select 	h.NAMABRG,a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            sum(b.NDPP) as NDPP,sum(b.NDPPRp) as NDPPRP,sum(b.NPPNRp) as NPPNRp,sum(B.nnetrp) as NNETRP
		From  dbBeli a 
		left outer join DBBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg	
		Where a.TANGGAL between @tgl1 and @tgl2
		group by h.NAMABRG,a.NOBUKTI,a.TANGGAL,j.NAMACUSTSUPP,a.KODEVLS,a.KURS
		order by h.namabrg
end



GO

-- Procedure: Sp_reportBeliGudangdet
-- Created: 2013-06-03 13:01:44.247 | Modified: 2015-03-09 15:32:12.990
-- =====================================================



CREATE Procedure [dbo].[Sp_reportBeliGudangdet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@x int=0,
@IDuser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportBeliGudang 
		  where Tanggal between @tgl1 and @tgl2 and qnt>0 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and qnt>0  order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and qnt>0  order by KodeCustSupp
		end 
	else If @Ordr='G'
		begin
		  select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and qnt>0  order by KodeGDG
		end 		
End
else
begin
If @Ordr='N'
		begin
		  select * from VwReportBeliGudang 
		  where Tanggal between @tgl1 and @tgl2 and qnt>0 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and qnt>0  
		  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and qnt>0  
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end 
	else If @Ordr='G'
		begin
		  select * from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 and qnt>0  
		  and KodeGdg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeGDG
		end
end








GO

-- Procedure: Sp_ReportBeliGudangRek
-- Created: 2013-06-03 13:01:44.257 | Modified: 2013-06-03 13:01:44.257
-- =====================================================

Create Procedure [dbo].[Sp_ReportBeliGudangRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
Select 	A.NoBukti,A.TANGGAL,A.KODESUPP KodeCustSupp,I.NAMACUSTSUPP,
	 Sum(Isnull(B.Qnt,0)) Qnt,Sum(ISnull(B.Harga,0))Harga, Sum(Isnull(B.HrgNetto,0))HrgNetto,
        --Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscP2,0)) DiscP2,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(0) DiscP2,
        --Sum(Isnull(B.DiscTot2,0)) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(0) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(ISnull(B.SubTotal,0)) TotalUSD, Sum(ISnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(ISnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(ISnull(B.SubTotal,0)) + Sum(ISnull(B.BYAngkut,0)) Total
From dbBeliDet B 
Left Outer Join dbBeli A On A.NoBukti=b.NoBukti
Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
where A.tanggal between @tgl1 and @Tgl2
Group By A.NoBukti,A.TANGGAL,A.KODESUPP ,I.NAMACUSTSUPP
Order by A.NoBukti,A.TANGGAL,A.KODESUPP ,I.NAMACUSTSUPP
End

else if @Choice='S'
begin
Select A.KODESUPP KodeCustSupp,I.NAMACUSTSUPP,
	 Sum(Isnull(B.Qnt,0)) Qnt,Sum(ISnull(B.Harga,0))Harga, Sum(Isnull(B.HrgNetto,0))HrgNetto,
        --Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscP2,0)) DiscP2,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(0) DiscP2,
        --Sum(Isnull(B.DiscTot2,0)) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(0) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(ISnull(B.SubTotal,0)) TotalUSD, Sum(ISnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(ISnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(ISnull(B.SubTotal,0)) + Sum(ISnull(B.BYAngkut,0)) Total
From dbBeliDet B 
Left Outer Join dbBeli A On A.NoBukti=b.NoBukti
Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
where A.tanggal between @tgl1 and @Tgl2
Group By A.TANGGAL,A.KODESUPP ,I.NAMACUSTSUPP
Order By I.NAMACUSTSUPP,A.KODESUPP ,A.TANGGAL
end
else if @Choice='B'
begin
Select B.KodeBrg,H.NAMABRG,A.TANGGAL,
	 Sum(Isnull(B.Qnt,0)) Qnt,Sum(ISnull(B.Harga,0))Harga, Sum(Isnull(B.HrgNetto,0))HrgNetto,
        --Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscP2,0)) DiscP2,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(0) DiscP2,
        --Sum(Isnull(B.DiscTot2,0)) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(0) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(ISnull(B.SubTotal,0)) TotalUSD, Sum(ISnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(ISnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(ISnull(B.SubTotal,0)) + Sum(ISnull(B.BYAngkut,0)) Total
From dbBeliDet B 
Left Outer Join dbBeli A On A.NoBukti=b.NoBukti
Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
where A.tanggal between @tgl1 and @Tgl2
Group By B.KodeBrg,H.NAMABRG,A.TANGGAl
Order By B.KodeBrg,H.NAMABRG,A.TANGGAL
end




GO

-- Procedure: Sp_reportbelirejectDet
-- Created: 2013-06-03 13:01:44.270 | Modified: 2013-06-03 13:01:44.270
-- =====================================================



CREATE Procedure [dbo].[Sp_reportbelirejectDet]  
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select NoBukti,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,NamaBrg,sum(qnt) qnt,satuan,sum(qnt2) qnt2,satuan2,sum(qntreject) qntreject,sum(qnt2reject) qnt2reject,
		  SUM(isnull(qnt,0)-isnull(qntreject,0)) sisa,SUM(isnull(qnt2,0)-isnull(qnt2reject,0)) sisa2
		  from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
		  group by NoBukti,KodeBrg,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,namabrg,satuan,satuan2	
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select NoBukti,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,NamaBrg,sum(qnt) qnt,satuan,sum(qnt2) qnt2,satuan2,sum(qntreject) qntreject,sum(qnt2reject) qnt2reject,
		  SUM(isnull(qnt,0)-isnull(qntreject,0)) sisa,SUM(isnull(qnt2,0)-isnull(qnt2reject,0)) sisa2
		  from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
		  group by NoBukti,KodeBrg,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,namabrg,satuan,satuan2	
		  order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select kodecustsupp,NoBukti,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,NamaBrg,sum(qnt) qnt,satuan,sum(qnt2) qnt2,satuan2,sum(qntreject) qntreject,sum(qnt2reject) qnt2reject,
		  SUM(isnull(qnt,0)-isnull(qntreject,0)) sisa,SUM(isnull(qnt2,0)-isnull(qnt2reject,0)) sisa2
		  from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
		  group by KodeCustSupp,NoBukti,KodeBrg,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,namabrg,satuan,satuan2	
		  order by KodeCustSupp
		end 
	else If @Ordr='G'
		begin
		  select kodegdg,NoBukti,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,NamaBrg,sum(qnt) qnt,satuan,sum(qnt2) qnt2,satuan2,sum(qntreject) qntreject,sum(qnt2reject) qnt2reject,
		  SUM(isnull(qnt,0)-isnull(qntreject,0)) sisa,SUM(isnull(qnt2,0)-isnull(qnt2reject,0)) sisa2
		  from VwReportBeliGudang where Tanggal between @tgl1 and @tgl2 
		  group by kodegdg,NoBukti,KodeBrg,TANGGAL,NoPO,NAMACUSTSUPP,KodeBrg,namabrg,satuan,satuan2	
		  order by KodeGdg
		end 

End




GO

-- Procedure: Sp_ReportBeliRejectRek
-- Created: 2013-06-03 13:01:44.290 | Modified: 2013-06-03 13:01:44.290
-- =====================================================

Create Procedure [dbo].[Sp_ReportBeliRejectRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime

as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
	Select 	A.NoBukti,A.TANGGAL,A.KODESUPP KodeCustSupp,I.NAMACUSTSUPP,
	Sum(Isnull(B.Qnt,0)) Qnt,Sum(ISnull(B.Harga,0))Harga, Sum(Isnull(B.HrgNetto,0))HrgNetto,
        --Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscP2,0)) DiscP2,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(0) DiscP2,
        --Sum(Isnull(B.DiscTot2,0)) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(0) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(ISnull(B.SubTotal,0)) TotalUSD, Sum(ISnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(ISnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(ISnull(B.SubTotal,0)) + Sum(ISnull(B.BYAngkut,0)) Total
	From dbBeliDet B 
	Left Outer Join dbBeli A On A.NoBukti=b.NoBukti
	Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
	Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
	where A.tanggal between @tgl1 and @Tgl2
	Group By A.NoBukti,A.TANGGAL,A.KODESUPP ,I.NAMACUSTSUPP
	Order by A.NoBukti,A.TANGGAL,A.KODESUPP ,I.NAMACUSTSUPP
End
else if @Choice='S'
begin
	Select A.KODESUPP KodeCustSupp,I.NAMACUSTSUPP,
	 Sum(Isnull(B.Qnt,0)) Qnt,Sum(ISnull(B.Harga,0))Harga, Sum(Isnull(B.HrgNetto,0))HrgNetto,
        --Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscP2,0)) DiscP2,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(0) DiscP2,
        --Sum(Isnull(B.DiscTot2,0)) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(0) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(ISnull(B.SubTotal,0)) TotalUSD, Sum(ISnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(ISnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(ISnull(B.SubTotal,0)) + Sum(ISnull(B.BYAngkut,0)) Total
	From dbBeliDet B 
	Left Outer Join dbBeli A On A.NoBukti=b.NoBukti
	Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
	Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
	where A.tanggal between @tgl1 and @Tgl2
	Group By A.TANGGAL,A.KODESUPP ,I.NAMACUSTSUPP
	Order By I.NAMACUSTSUPP,A.KODESUPP ,A.TANGGAL
end
else if @Choice='B'
begin
	Select B.KodeBrg,H.NAMABRG,A.TANGGAL,
	Sum(Isnull(B.Qnt,0)) Qnt,Sum(ISnull(B.Harga,0))Harga, Sum(Isnull(B.HrgNetto,0))HrgNetto,
        --Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscP2,0)) DiscP2,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(ISnull(B.DiscTot,0)) DiscRp1, Sum(0) DiscP2,
        --Sum(Isnull(B.DiscTot2,0)) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(0) DiscRp2,sum(ISnull(B.DiscTot,0)) Disctot,
        Sum(ISnull(B.SubTotal,0)) TotalUSD, Sum(ISnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(ISnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(ISnull(B.SubTotal,0)) + Sum(ISnull(B.BYAngkut,0)) Total
	From dbBeliDet B 
	Left Outer Join dbBeli A On A.NoBukti=b.NoBukti
	Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
	Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
	where A.tanggal between @tgl1 and @Tgl2
	Group By B.KodeBrg,H.NAMABRG,A.TANGGAl
	Order By B.KodeBrg,H.NAMABRG,A.TANGGAL
end

GO

-- Procedure: sp_ReportBon
-- Created: 2011-12-09 11:34:41.210 | Modified: 2011-12-09 12:27:46.327
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportBon]
@devisi varchar(10),
@perkiraan varchar(15),
@tanggal datetime,
@Tanggal1 datetime
AS
Set @devisi=case when @devisi in ('-','') then '%' else @devisi end
select a.nobukti,a.tanggal,a.penerima,a.keterangan,a.debet,
          (select sum(b.kredit) from dbbon b where b.devisi=a.devisi and b.perkiraan=a.perkiraan and b.nobukti=a.nobukti and b.tanggal between @tanggal and @Tanggal1) as kredit, 
          (a.debet-(select sum(b.kredit) from dbbon b 
                         where b.devisi=a.devisi and b.perkiraan=a.perkiraan and b.nobukti=a.nobukti and b.tanggal between @tanggal and @Tanggal1)) as sld
from dbbon a
where (Select sum(b.debet-b.kredit) 
            from dbbon b
            where a.devisi=b.devisi and a.nobukti = b.nobukti and a.perkiraan=b.perkiraan and (b.tanggal between @tanggal and @Tanggal1)
            group by b.nobukti) <> 0
           and (a.tanggal between @tanggal and @Tanggal1) and (a.perkiraan=@perkiraan) and (a.devisi like @devisi) and a.debet<>0 
group by a.devisi,a.perkiraan,a.nobukti,a.tanggal,a.penerima,a.keterangan,a.debet
order by a.devisi,a.perkiraan,a.nobukti

GO

-- Procedure: Sp_reportBP
-- Created: 2013-06-03 14:24:28.263 | Modified: 2013-06-03 14:24:28.263
-- =====================================================



CREATE Procedure [dbo].[Sp_reportBP]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		 If @NeedOto=0 or @NeedOto=1
		  select * from VwreportBP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by NoBukti,Tanggal
		 If @NeedOto=2
		  select * from VwreportBP where Tanggal between @tgl1 and @tgl2 
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwreportBP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		   order by KodeBrg
		If @NeedOto=2
		  select * from VwreportBP where Tanggal between @tgl1 and @tgl2 
		   order by KodeBrg
		end 
End



GO

-- Procedure: Sp_ReportBPPBKeluarRek
-- Created: 2013-01-21 13:29:53.580 | Modified: 2013-01-21 13:29:53.580
-- =====================================================


Create Procedure [dbo].[Sp_ReportBPPBKeluarRek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
	Select 	A.NoBukti, A.Tanggal,Sum(ISnull(Qnt,0)) QMinta,Sum(ISnull(Qnt2,0)) QKirim
	From dbBPPB A
	Left Outer Join dbBPPBdet B On A.NoBukti=B.NoBukti
	Left Outer Join dbBarang D On B.Kodebrg=D.Kodebrg
	Left Outer Join dbDEPART C on c.KdDEP=a.KdDEP
	where A.TANGGAL between @Tgl1 and @Tgl2
	Group By A.NoBukti, A.Tanggal
	Order by A.NoBukti, A.Tanggal
End
else if @Choice='B'
begin
	Select B.KodeBrg,D.NamaBrg, A.Tanggal,Sum(ISnull(Qnt,0)) QMinta,Sum(ISnull(Qnt2,0)) QKirim
	From dbBPPB A
	Left Outer Join dbBPPBdet B On A.NoBukti=B.NoBukti
	Left Outer Join dbBarang D On B.Kodebrg=D.Kodebrg
	Left Outer Join dbDEPART C on c.KdDEP=a.KdDEP
	where A.TANGGAL between @Tgl1 and @Tgl2
	Group By B.KodeBrg,D.NamaBrg,A.TANGGAL
	Order by B.KodeBrg,D.NamaBrg,A.TANGGAL
End
GO

-- Procedure: Sp_reportBPrek
-- Created: 2013-06-03 14:25:48.483 | Modified: 2013-06-03 14:25:48.483
-- =====================================================

CREATE Procedure [dbo].[Sp_reportBPrek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 dateTime,
@NeedOto SmallInt
as
--Declare @Choice varchar(1),@Bulan Int,@Tahun Int
--Select @Choice='B',@Bulan=1,@Tahun=2012

If @Choice='N'
begin
  If @NeedOto=0 or @NeedOto=1
	Select 	A.NoBukti,A.tanggal,B.Sat,B.kodebrg,H.NAMABRG,
	Sum(Isnull(B.Qnt,0)) Qnt
	From dbPenyerahanBhn A
	Left Outer join  dbPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Where A.tanggal Between @Tgl1 And @Tgl2
	And Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@Needoto
	Group By A.Nobukti,A.tanggal,B.Sat,B.kodebrg,H.NAMABRG
	Order BY A.nobukti,A.tanggal,B.Sat,B.kodebrg,H.NAMABRG
else If @NeedOto=2
	Select 	A.NoBukti,A.tanggal,B.Sat,B.kodebrg,H.NAMABRG,
	Sum(Isnull(B.Qnt,0)) Qnt
	From dbPenyerahanBhn A
	Left Outer join  dbPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Where A.tanggal Between @Tgl1 And @Tgl2
	Group By A.Nobukti,A.tanggal,B.Sat,B.kodebrg,H.NAMABRG
	Order BY A.nobukti,A.tanggal,B.Sat,B.kodebrg,H.NAMABRG
End

If @Choice='B'
Begin
  If @NeedOto=0 Or @NeedOto=1
	Select 	B.KOdebrg,H.namaBrg,A.Tanggal,B.Sat, 
	Sum(Isnull(B.Qnt,0)) Qnt
	From dbPenyerahanBhn A
	Left Outer join  dbPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Where A.tanggal Between @Tgl1 And @Tgl2
	And Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@Needoto
	Group By B.kodebrg,H.namaBrg,A.tanggal,B.Sat
	Order BY B.kodebrg,H.namaBrg,A.Tanggal,B.Sat
If @NeedOto=2
	Select 	B.KOdebrg,H.namaBrg,A.Tanggal,B.Sat, 
	Sum(Isnull(B.Qnt,0)) Qnt
	From dbPenyerahanBhn A
	Left Outer join  dbPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Where A.tanggal Between @Tgl1 And @Tgl2
	Group By B.kodebrg,H.namaBrg,A.tanggal,B.Sat
	Order BY B.kodebrg,H.namaBrg,A.Tanggal,B.Sat
end



GO

-- Procedure: Sp_ReportBukuBesar
-- Created: 2015-06-06 13:55:13.083 | Modified: 2015-11-14 10:24:36.597
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportBukuBesar] 
@awal varchar(25),
@akhir varchar(25),
@tglawal datetime,
@tglakhir datetime,
@devisi varchar(15),
@IdUser varchar(15)
As
Declare @Mulai Datetime
--Select @awal='111110001',@akhir='111120003',@tglawal='07-01-2011',@tglakhir='07-31-2011',@devisi='01',@IdUser='SA'
set @akhir =@awal 
Select @Mulai=DATEADD(dd,-(DAY(@tglawal)-1),@tglawal);
With Transaksi (Nobukti,Tanggal, Note, Keterangan, Perkiraan, Lawan, DK, Debet, DebetRp, Valas, Kurs, Kredit, KreditRP, SaldoAkhir, SaldoAkhirD,
      Devisi, Nourut, NoACC, Nama, Urut) AS
(
Select 'SALDO AWAL' Nobukti,DATEADD(DD,-1,@tglawal) Tanggal,''Note, '' Keterangan, ''Perkiraan, '' Lawan, 
       A.DK, 0.00 Debet, 0.00 DebetRp, '', 1.00 Kurs, 0.00 Kredit, 0.00 KreditD,
       Case when B.DK=0 then A.AwalDRp 
            when B.DK=1 then A.AwalKRp
            else 0
       end SaldoAkhir,
       Case when B.DK=0 then A.AwalD
            when B.DK=1 then A.AwalK
            else 0
       end SaldoAkhirD, A.Devisi, '' NoUrut, B.Perkiraan NoACC, B.Keterangan Nama, 0 Urut
From DBNERACALAMA A
     Left Outer Join DBPERKIRAAN B on B.Perkiraan=A.Perkiraan
where (A.Perkiraan between @awal and @akhir) and A.Devisi like @devisi and A.Bulan=MONTH(@tglawal) and A.Tahun=YEAR(@tglawal)
union All
Select 'SALDO AWAL' Nobukti, DATEADD(DD,-1,@tglawal) Tanggal,''Note, '' Keterangan,
       ''Perkiraan,  '' Lawan,
       A.DK, 0.00 Debet, 0.00 DebetRp, '', 1.00 Kurs, 0.00 Kredit, 0.00 KreditD,
       SUM(Case when Datepart(DD,@tglawal)=1 then 0
                else
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan then B.DEBETRP
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan then -B.DEBETRP
            when A.DK=0 and B.LAWAN=A.Perkiraan then -B.DEBETRP
            when A.DK=1 and B.LAWAN=A.Perkiraan then B.DEBETRP
            else 0
       end end) SaldoAkhir,
       SUM(Case when Datepart(DD,@tglawal)=1 then 0
                else
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET 
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR' then -B.DEBET 
            when A.DK=0 and B.LAWAN=A.Perkiraan and b.VALAS<>'IDR' then -B.DEBET  
            when A.DK=1 and B.LAWAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET 
            else 0
       end end) SaldoAkhirD, B.Devisi, '' NoUrut, A.Perkiraan NoACC, A.Keterangan Nama, 0 Urut
From DBPERKIRAAN A
     left Outer join vwTransaksi B on (B.PERKIRAAN=A.Perkiraan or B.LAWAN=A.Perkiraan)
     and b.tipetrans in ('BKM','BBM','BBK','BKK','BMM')
where (B.Tanggal >=@Mulai and B.Tanggal<@tglawal) and B.Devisi like @devisi and (A.Perkiraan between @awal and @akhir) 
Group by A.Perkiraan, A.DK, B.DEVISI, A.Keterangan
union all
Select B.Nobukti, B.TANGGAL,B.NOTE, B.KETERANGAN,
       B.PERKIRAAN,  
       Case when B.PERKIRAAN=A.Perkiraan then B.LAWAN 
            when B.LAWAN=A.Perkiraan then B.PERKIRAAN
            else ''
       end LAWAN,
       A.DK, 
       Case when B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET  else 0 end Debet, 
       Case when B.PERKIRAAN=A.Perkiraan then B.DEBETRP else 0 end DebetRp, 
       B.VALAS, B.KURS, 
       Case when B.LAWAN=A.Perkiraan and b.VALAS<>'IDR'  then B.DEBET  else 0 end Kredit, 
       Case when B.LAWAN=A.Perkiraan then B.DEBETRP else 0 end KreditRp,
       (
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan then B.DEBETRP
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan then -B.DEBETRP
            when A.DK=0 and B.LAWAN=A.Perkiraan then -B.DEBETRP
            when A.DK=1 and B.LAWAN=A.Perkiraan then B.DEBETRP
            else 0
       end) SaldoAkhir,
       (
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan  and b.VALAS<>'IDR'then B.DEBET 
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR'  then -B.DEBET 
            when A.DK=0 and B.LAWAN=A.Perkiraan  and b.VALAS<>'IDR' then -B.DEBET 
            when A.DK=1 and B.LAWAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET 
            else 0
       end) SaldoAkhirD, B.Devisi, B.NOURUT, A.Perkiraan NoACC, A.Keterangan Nama, B.Urut
From DBPERKIRAAN A
     left Outer join vwTransaksi B on (B.PERKIRAAN=A.Perkiraan or B.LAWAN=A.Perkiraan)
     and b.tipetrans in ('BKM','BBM','BBK','BKK','BMM')
where (B.Tanggal between @tglawal and @tglakhir) and B.Devisi like @devisi and (A.Perkiraan between @awal and @akhir)
)

Select Nobukti,Tanggal, Note, Keterangan, Perkiraan, Lawan, DK, 
      Debet DebetD, DebetRp Debet, Valas, Kurs, Kredit kreditD, KreditRp kredit, 
      Sum(SaldoAkhir) SaldoAkhir, Sum(SaldoAkhirD) SaldoAkhirD,
       Devisi, Nourut, NoACC, Nama, urut
From Transaksi A
where (A.NoACC between @awal and @akhir) and (A.Tanggal between DATEADD(DD,-1,@Mulai) and @tglakhir)
Group by Nobukti,Tanggal, Note, Keterangan, Perkiraan, Lawan, DK, Debet, DebetRp, Valas, Kurs, Kredit, KreditRP,
         Devisi, Nourut, NoACC, Nama, Urut 
Having Sum(SaldoAkhir)<>0 Or Sum(SaldoAkhirD) <>0
Order by NoACC, Tanggal,NoUrut,Nobukti, Urut



GO

-- Procedure: Sp_ReportBukuTambahan
-- Created: 2012-11-05 10:19:51.637 | Modified: 2014-11-20 13:05:47.827
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportBukuTambahan] 
@awal varchar(25),
@akhir varchar(25),
@tglawal datetime,
@tglakhir datetime,
@devisi varchar(15),
@IdUser varchar(15)
As
Declare @Mulai Datetime
--Select @awal='111110001',@akhir='111120003',@tglawal='07-01-2011',@tglakhir='07-31-2011',@devisi='01',@IdUser='SA'
Select @Mulai=DATEADD(dd,-(DAY(@tglawal)-1),@tglawal);
With Transaksi (Nobukti,Tanggal, Note, Keterangan, Perkiraan, Lawan, DK, Debet, DebetRp, Valas, Kurs, Kredit, KreditRP, SaldoAkhir, SaldoAkhirD,
      Devisi, Nourut, NoACC, Nama, Urut) AS
(
Select 'SALDO AWAL' Nobukti,DATEADD(DD,-1,@tglawal) Tanggal,''Note, '' Keterangan, ''Perkiraan, '' Lawan, 
       A.DK, 0.00 Debet, 0.00 DebetRp, '', 1.00 Kurs, 0.00 Kredit, 0.00 KreditD,
       Case when B.DK=0 then A.AwalDRp 
            when B.DK=1 then A.AwalKRp
            else 0
       end SaldoAkhir,
       Case when B.DK=0 then A.AwalD
            when B.DK=1 then A.AwalK
            else 0
       end SaldoAkhirD, A.Devisi, '' NoUrut, B.Perkiraan NoACC, B.Keterangan Nama, 0 Urut
From DBNERACA A
     Left Outer Join DBPERKIRAAN B on B.Perkiraan=A.Perkiraan
where (A.Perkiraan between @awal and @akhir) and A.Devisi like @devisi and A.Bulan=MONTH(@tglawal) and A.Tahun=YEAR(@tglawal)
union All
Select 'SALDO AWAL' Nobukti, DATEADD(DD,-1,@tglawal) Tanggal,''Note, '' Keterangan,
       ''Perkiraan,  '' Lawan,
       A.DK, 0.00 Debet, 0.00 DebetRp, '', 1.00 Kurs, 0.00 Kredit, 0.00 KreditD,
       SUM(Case when Datepart(DD,@tglawal)=1 then 0
                else
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan then B.DEBETRP
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan then -B.DEBETRP
            when A.DK=0 and B.LAWAN=A.Perkiraan then -B.DEBETRP
            when A.DK=1 and B.LAWAN=A.Perkiraan then B.DEBETRP
            else 0
       end end) SaldoAkhir,
       SUM(Case when Datepart(DD,@tglawal)=1 then 0
                else
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET 
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR' then -B.DEBET 
            when A.DK=0 and B.LAWAN=A.Perkiraan and b.VALAS<>'IDR' then -B.DEBET  
            when A.DK=1 and B.LAWAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET 
            else 0
       end end) SaldoAkhirD, B.Devisi, '' NoUrut, A.Perkiraan NoACC, A.Keterangan Nama, 0 Urut
From DBPERKIRAAN A
     left Outer join vwTransaksi B on B.PERKIRAAN=A.Perkiraan or B.LAWAN=A.Perkiraan
where (B.Tanggal >=@Mulai and B.Tanggal<@tglawal) and B.Devisi like @devisi and (A.Perkiraan between @awal and @akhir) 
Group by A.Perkiraan, A.DK, B.DEVISI, A.Keterangan
union all
Select B.Nobukti, B.TANGGAL,B.NOTE, B.KETERANGAN,
       B.PERKIRAAN,  
       Case when B.PERKIRAAN=A.Perkiraan then B.LAWAN 
            when B.LAWAN=A.Perkiraan then B.PERKIRAAN
            else ''
       end LAWAN,
       A.DK, 
       Case when B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET  else 0 end Debet, 
       Case when B.PERKIRAAN=A.Perkiraan then B.DEBETRP else 0 end DebetRp, 
       B.VALAS, B.KURS, 
       Case when B.LAWAN=A.Perkiraan and b.VALAS<>'IDR'  then B.DEBET  else 0 end Kredit, 
       Case when B.LAWAN=A.Perkiraan then B.DEBETRP else 0 end KreditRp,
       (
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan then B.DEBETRP
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan then -B.DEBETRP
            when A.DK=0 and B.LAWAN=A.Perkiraan then -B.DEBETRP
            when A.DK=1 and B.LAWAN=A.Perkiraan then B.DEBETRP
            else 0
       end) SaldoAkhir,
       (
       Case when A.DK=0 and B.PERKIRAAN=A.Perkiraan  and b.VALAS<>'IDR'then B.DEBET 
            when A.DK=1 and B.PERKIRAAN=A.Perkiraan and b.VALAS<>'IDR'  then -B.DEBET 
            when A.DK=0 and B.LAWAN=A.Perkiraan  and b.VALAS<>'IDR' then -B.DEBET 
            when A.DK=1 and B.LAWAN=A.Perkiraan and b.VALAS<>'IDR' then B.DEBET 
            else 0
       end) SaldoAkhirD, B.Devisi, B.NOURUT, A.Perkiraan NoACC, A.Keterangan Nama, B.Urut
From DBPERKIRAAN A
     left Outer join vwTransaksi B on B.PERKIRAAN=A.Perkiraan or B.LAWAN=A.Perkiraan
where (B.Tanggal between @tglawal and @tglakhir) and B.Devisi like @devisi and (A.Perkiraan between @awal and @akhir))

Select Nobukti,Tanggal, Note, Keterangan, Perkiraan, Lawan, DK, 
      Debet DebetD, DebetRp Debet, Valas, Kurs, Kredit kreditD, KreditRp kredit, 
      Sum(SaldoAkhir) SaldoAkhir, Sum(SaldoAkhirD) SaldoAkhirD,
       Devisi, Nourut, NoACC, Nama, urut
From Transaksi A
where (A.NoACC between @awal and @akhir) and (A.Tanggal between DATEADD(DD,-1,@Mulai) and @tglakhir)
Group by Nobukti,Tanggal, Note, Keterangan, Perkiraan, Lawan, DK, Debet, DebetRp, Valas, Kurs, Kredit, KreditRP,
         Devisi, Nourut, NoACC, Nama, Urut 
Having Sum(SaldoAkhir)<>0 Or Sum(SaldoAkhirD) <>0
Order by NoACC, Tanggal,NoUrut,Nobukti, Urut




GO

-- Procedure: SP_ReportCashFlow
-- Created: 2014-11-20 15:20:43.490 | Modified: 2014-11-20 16:32:48.373
-- =====================================================
CREATE Procedure [dbo].[SP_ReportCashFlow]
@userid varchar(25)
as
select a.gol, a.lawan, case when a.KodeCS='' then sum(isnull(a.kas,0)) else null end as Kas,
case when a.KodeCS='' then (case when (exists (select isnull(b.kas,0)
                    from dbcashflow b
                    where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENERIMAAN'
		         group by b.Lawan, b.gol, b.userid, b.kas) and
            exists (select isnull(b.kas,0)
                    from dbcashflow b
                    where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENGELUARAN'
		         group by b.Lawan, b.gol, b.userid, b.kas)) then
           (case when (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENERIMAAN')>
                      (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENGELUARAN') then
                      (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENGELUARAN') else
                      (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENERIMAAN')
            end)
      else sum(0) end) else null end as Koreksi,
 case when a.KodeCS='' then (sum(isnull(a.kas,0))-
 (case when (exists (select isnull(b.kas,0)
                     from dbcashflow b
                     where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENERIMAAN'
		          group by b.Lawan, b.gol, b.userid, b.kas) and
             exists (select isnull(b.kas,0)
                     from dbcashflow b
                     where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENGELUARAN'
		          group by b.Lawan, b.gol, b.userid, b.kas)) then
           (case when (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENERIMAAN')>
                      (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENGELUARAN') then
                      (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENGELUARAN') else
                      (select sum(isnull(b.kas,0)) from dbcashflow b
                       where b.KodeCS='' and b.KodeCS=a.KodeCS and b.lawan=a.lawan and b.Userid=a.Userid and b.gol='PENERIMAAN')
            end)
  else 0 end)) else null end as Jumlah, case when a.KodeCs='' then null else sum(a.Kas) end DetKas, a.keterangan, a.Urut, a.Devisi
from dbcashflow a
where Userid=@userid and Perkiraan in (select perkiraan from dbAksesPerkiraan where userid=@userid)
and lawan in (select perkiraan from dbAksesPerkiraan where userid=@userid)
Group by a.gol, a.lawan, a.Keterangan, a.userid, a.Urut, a.Devisi, a.KodeCS
order by a.devisi, a.Urut, a.Gol, a.lawan, a.KodeCS

GO

-- Procedure: Sp_ReportCosting
-- Created: 2015-04-20 09:06:07.127 | Modified: 2015-04-20 09:06:07.127
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportCosting] 
@Tipe smallint=0,
@KodeCost varchar(20)='',
@KodeSubCost varchar(20)='',
@Bulan int=0,
@Tahun int=0
as
if @KodeCost = '-' set @KodeCost = '%%'
if @KodeSubCost = '-' set @KodeSubCost = '%%'
if @Tipe = 0
  begin	
	select KodePerk, KodeCost, KodeSubCost, NIK, Nama, SUM(Saldo) Saldo,KETERANGAN
	from VwCost
	where KodeCost = @KodeCost and KodeSubCost like @KodeSubCost and MONTH(Tanggal) = @Bulan and YEAR(Tanggal) = @Tahun
	group by KodePerk, KodeCost, KodeSubCost, NIK, Nama,KETERANGAN
  end
else
  begin
	select KodePerk, KodeCost, KodeSubCost, NIK, Nama, keterangan,
			ISNULL(case when MONTH(Tanggal)=1 then SUM(Saldo) end,0) Saldo1,
			ISNULL(case when MONTH(Tanggal)=2 then SUM(Saldo) end,0) Saldo2,
			ISNULL(case when MONTH(Tanggal)=3 then SUM(Saldo) end,0) Saldo3,
			ISNULL(case when MONTH(Tanggal)=4 then SUM(Saldo) end,0) Saldo4,
			ISNULL(case when MONTH(Tanggal)=5 then SUM(Saldo) end,0) Saldo5,
			ISNULL(case when MONTH(Tanggal)=6 then SUM(Saldo) end,0) Saldo6,
			ISNULL(case when MONTH(Tanggal)=7 then SUM(Saldo) end,0) Saldo7,
			ISNULL(case when MONTH(Tanggal)=8 then SUM(Saldo) end,0) Saldo8,
			ISNULL(case when MONTH(Tanggal)=9 then SUM(Saldo) end,0) Saldo9,
			ISNULL(case when MONTH(Tanggal)=10 then SUM(Saldo) end,0) Saldo10,
			ISNULL(case when MONTH(Tanggal)=11 then SUM(Saldo) end,0) Saldo11,
			ISNULL(case when MONTH(Tanggal)=12 then SUM(Saldo) end,0) Saldo12,
			ISNULL(case when MONTH(Tanggal)=1 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=2 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=3 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=4 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=5 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=6 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=7 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=8 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=9 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=10 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=11 then SUM(Saldo) end,0)+
			ISNULL(case when MONTH(Tanggal)=12 then SUM(Saldo) end,0) as TOTAL
	from VwCost
	where KodeCost = @KodeCost and KodeSubCost like @KodeSubCost and YEAR(Tanggal) = @Tahun	
	group by MONTH(Tanggal), KodePerk, KodeCost, KodeSubCost, NIK, Nama,KETERANGAN
  end



GO

-- Procedure: Sp_reportDebetnoteDet
-- Created: 2013-06-03 13:57:53.030 | Modified: 2013-06-03 13:57:53.030
-- =====================================================

CREATE Procedure [dbo].[Sp_reportDebetnoteDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto smallint
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
			If @NeedOto=0 or @NeedOto=1
				select * from VwreportDebetNotte where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by NoBukti,Tanggal
			If @NeedOto=2
				select * from VwreportDebetNotte where Tanggal between @tgl1 and @tgl2
				order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
			If @NeedOto=0 or @NeedOto=1
				select * from VwreportDebetNotte where Tanggal between @tgl1 and @tgl2  and NeedOtorisasi=@NeedOto
				--order by KodeBrg
			If @NeedOto=2
				select * from VwreportDebetNotte where Tanggal between @tgl1 and @tgl2 
				--order by KodeBrg
		end 
	else If @Ordr='S'
		begin
			If @NeedOto=0 or @NeedOto=1
				select * from VwreportDebetNotte where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by KodeCustSupp
			If @NeedOto=2
				select * from VwreportDebetNotte where Tanggal between @tgl1 and @tgl2 
				order by KodeCustSupp
		end 		
End

GO

-- Procedure: Sp_reporthasilPRDACCDet
-- Created: 2013-06-24 10:36:54.740 | Modified: 2013-06-24 10:37:43.780
-- =====================================================
CREATE Procedure [dbo].[Sp_reporthasilPRDACCDet] 
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportHasilPrdACC where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		  If @NeedOto=2
			select * from VwreportHasilPrdACC where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportHasilPrdACC where Tanggal between @tgl1 and @tgl2  and Needotorisasi=@NeedOto
			order by KodeBrg
		If @NeedOto=2
			select * from VwreportHasilPrdACC where Tanggal between @tgl1 and @tgl2  
			order by KodeBrg
		end 
End




GO

-- Procedure: Sp_reporthasilPRDDet
-- Created: 2013-06-10 10:56:01.130 | Modified: 2013-06-24 10:37:43.783
-- =====================================================


CREATE Procedure [dbo].[Sp_reporthasilPRDDet] 
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportHasilPrd where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		  If @NeedOto=2
			select * from VwreportHasilPrd where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportHasilPrd where Tanggal between @tgl1 and @tgl2  and Needotorisasi=@NeedOto
			order by KodeBrg
		If @NeedOto=2
			select * from VwreportHasilPrd where Tanggal between @tgl1 and @tgl2  
			order by KodeBrg
		end 
End




GO

-- Procedure: Sp_reportInvoicedet
-- Created: 2013-06-03 13:51:02.723 | Modified: 2015-03-09 15:32:12.883
-- =====================================================


CREATE Procedure [dbo].[Sp_reportInvoicedet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto smallInt,
@Iduser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			order by NoBukti,Tanggal
		If @NeedOto=2
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2  and NeedOtorisasi=@NeedOto
			order by KodeBrg
		  If @NeedOto=2
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2 
			order by KodeBrg
		end 
	else If @Ordr='S'
		begin
			If @NeedOto=0 or @NeedOto=1
				select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2  and NeedOtorisasi=@NeedOto
				order by KodeCustSupp
			If @NeedOto=2
				select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2  
				order by KodeCustSupp
		end 		
End
else
begin
If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		If @NeedOto=2
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2 
			and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2  and NeedOtorisasi=@NeedOto
			and kodebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by KodeBrg
		  If @NeedOto=2
			select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2 
			and kodebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by KodeBrg
		end 
	else If @Ordr='S'
		begin
			If @NeedOto=0 or @NeedOto=1
				select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2  and NeedOtorisasi=@NeedOto
				and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeCustSupp
			If @NeedOto=2
				select * from VwreportINVoice where Tanggal between @tgl1 and @tgl2  
				and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeCustSupp
		end 
End


GO

-- Procedure: Sp_ReportInvoicePenjualanDet
-- Created: 2013-06-03 14:13:20.860 | Modified: 2015-03-11 09:53:51.757
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportInvoicePenjualanDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint,
@IDuser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
If @Ordr='N'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
		  order by NoBukti,Tanggal
		else if @NeedOto=2
		 select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  order by NoBukti,Tanggal
		end
else If @Ordr='B'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
		  order by KodeBrg
		 else if @NeedOto=2
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  order by KodeBrg
		end
else If @Ordr='C'
		begin
		  if @NeedOto=0 or @NeedOto=1	
			select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
			order by KodeCustSupp
		  else if @NeedOto=2	
			select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2
			order by KodeCustSupp
		end 
else If @Ordr='S'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
		  order by KodeCustSupp
		 else if @NeedOto=2
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end
End
else
begin
If @Ordr='N'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
		  order by NoBukti,Tanggal
		else if @NeedOto=2
		 select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		 and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end
else If @Ordr='B'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
		  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		 else if @NeedOto=2
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end
else If @Ordr='C'
		begin
		  if @NeedOto=0 or @NeedOto=1	
			select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
			order by KodeCustSupp
		  else if @NeedOto=2	
			select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2
			and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
			order by KodeCustSupp
		end 
else If @Ordr='S'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
		  order by KodeCustSupp
		 else if @NeedOto=2
		  select * from VwreportinvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end
End





GO

-- Procedure: Sp_ReportInvoicePenjualanRek
-- Created: 2013-06-03 14:13:50.490 | Modified: 2013-06-03 14:13:50.490
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportInvoicePenjualanRek]  
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime,
@NeedOto SmallInt
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'
If @Choice='N'
Begin
	if @NeedOto=0 or @NeedOto=1
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		left outer join dbSPB X on B.NoSPB = X.NoBukti
		left outer join dbSPP y on y.NoBukti=x.NoSPP
		left outer join DBSO z on z.NOBUKTI=y.NoSHIP
		left outer join dbKaryawan p on p.KeyNIK=z.KODESLS
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas
		Order by B.NoBukti
	else if @NeedOto=2
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		left outer join dbSPB X on B.NoSPB = X.NoBukti
		left outer join dbSPP y on y.NoBukti=x.NoSPP
		left outer join DBSO z on z.NOBUKTI=y.NoSHIP
		left outer join dbKaryawan p on p.KeyNIK=z.KODESLS
		where A.Tanggal between @Tgl1 and @Tgl2 
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas
		Order by B.NoBukti
end
Else If @Choice='B'
Begin
	if @NeedOto=0 or @NeedOto=1
		select 	B.KodeBrg,C.NAMABRG,b.SAT_1,b.SAT_2,
		SUM(b.qnt) QNT,SUM(b.qnt2)QNT2,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP		
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By B.KodeBrg,C.NAMABRG,b.SAT_1,b.SAT_2
		order By B.KodeBrg
	else if @NeedOto=0 or @NeedOto=1
		select 	B.KodeBrg,C.NAMABRG,b.SAT_1,b.SAT_2,
		SUM(b.qnt) QNT,SUM(b.qnt2)QNT2,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP		
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2 
		Group By B.KodeBrg,C.NAMABRG,b.SAT_1,b.SAT_2
		order By B.KodeBrg
end
Else If @Choice='C'
Begin
	if @NeedOto=0 or @NeedOto=1
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		left outer join dbSPB X on B.NoSPB = X.NoBukti
		left outer join dbSPP y on y.NoBukti=x.NoSPP
		left outer join DBSO z on z.NOBUKTI=y.NoSHIP
		left outer join dbKaryawan p on p.KeyNIK=z.KODESLS
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas
		order By D.NAMACUSTSUPP,A.Tanggal
	else if @NeedOto=2
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		left outer join dbSPB X on B.NoSPB = X.NoBukti
		left outer join dbSPP y on y.NoBukti=x.NoSPP
		left outer join DBSO z on z.NOBUKTI=y.NoSHIP
		left outer join dbKaryawan p on p.KeyNIK=z.KODESLS
		where A.Tanggal between @Tgl1 and @Tgl2 
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas
		order By D.NAMACUSTSUPP,A.Tanggal
end
Else If @Choice='S'
Begin
	if @NeedOto=0 or @NeedOto=1
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		left outer join dbSPB X on B.NoSPB = X.NoBukti
		left outer join dbSPP y on y.NoBukti=x.NoSPP
		left outer join DBSO z on z.NOBUKTI=y.NoSHIP
		left outer join dbKaryawan p on p.KeyNIK=z.KODESLS
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas
		order By p.Nama,d.NAMACUSTSUPP,b.NoBukti
else if @NeedOto=2
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas,
		SUM(b.ndpp) NDPP,SUM(B.ndpprp) NDPPRP, sum(b.Nppnrp)NPPNRP,SUM(B.nnetrp)NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		left outer join dbSPB X on B.NoSPB = X.NoBukti
		left outer join dbSPP y on y.NoBukti=x.NoSPP
		left outer join DBSO z on z.NOBUKTI=y.NoSHIP
		left outer join dbKaryawan p on p.KeyNIK=z.KODESLS
		where A.Tanggal between @Tgl1 and @Tgl2
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,P.Nama,a.Kurs,a.Valas
		order By p.Nama,d.NAMACUSTSUPP,b.NoBukti
end


GO

-- Procedure: Sp_ReportInvoiceRek
-- Created: 2013-06-03 13:51:53.890 | Modified: 2013-06-03 13:51:53.890
-- =====================================================



CREATE procedure [dbo].[Sp_ReportInvoiceRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto Smallint
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='N'
if @Choice='N'
begin
	if @NeedOto=0 or @NeedOto=1
		Select  C.NoBukti ,C.TANGGAL,d.NAMACUSTSUPP,c.kurs,c.KodeVls,Sum(Isnull(NDPPvls,0)) NDPPVLS,Sum(Isnull(NDPP,0)) NDPP,Sum(isnull(NPPN,0)) NPPN,Sum(isnull(NNET,0)) NNET   
		From  dbInvoiceDet a
		Left Outer Join (select a.NoBukti,Sum(b.NDPP)NDPPvls,Sum(b.NDPPrp)NDPP,Sum(b.NPPNrp)NPPN,Sum(b.NNETrp)NNET from dbBeli a Left Outer Join dbBeliDet b On a.NoBukti=b.noBukti Group by a.NoBukti)b On a.NoBeli=b.NoBukti
		Left Outer join DBInvoice C on A.NOBUKTI = C.NOBUKTI 
		Left Outer Join dbCustSupp D On C.KodeSupp=D.KodeCustSupp
		where C.TANGGAL between @Tgl1 and @Tgl2 and
        Cast(Case when Case when c.IsOtorisasi1=1 then 1 else 0 end+
                      Case when c.IsOtorisasi2=1 then 1 else 0 end+
                      Case when c.IsOtorisasi3=1 then 1 else 0 end+
                      Case when c.IsOtorisasi4=1 then 1 else 0 end+
                      Case when c.IsOtorisasi5=1 then 1 else 0 end=c.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
		Group By C.NoBukti,C.TANGGAL,c.Kurs,c.KodeVls,d.NAMACUSTSUPP
		Order By Nobukti
	if @NeedOto=2
		Select  C.NoBukti ,C.TANGGAL,d.NAMACUSTSUPP,c.kurs,c.KodeVls,Sum(Isnull(NDPPvls,0)) NDPPVLS,Sum(Isnull(NDPP,0)) NDPP,Sum(isnull(NPPN,0)) NPPN,Sum(isnull(NNET,0)) NNET   
		From  dbInvoiceDet a
		Left Outer Join (select a.NoBukti,Sum(b.NDPP)NDPPvls,Sum(b.NDPPrp)NDPP,Sum(b.NPPNrp)NPPN,Sum(b.NNETrp)NNET from dbBeli a Left Outer Join dbBeliDet b On a.NoBukti=b.noBukti Group by a.NoBukti)b On a.NoBeli=b.NoBukti
		Left Outer join DBInvoice C on A.NOBUKTI = C.NOBUKTI 
		Left Outer Join dbCustSupp D On C.KodeSupp=D.KodeCustSupp
		where C.TANGGAL between @Tgl1 and @Tgl2 
		Group By C.NoBukti,C.TANGGAL,c.Kurs,c.KodeVls,d.NAMACUSTSUPP
		Order By Nobukti
end
else if @Choice='S'
begin
	if @NeedOto=0 or @NeedOto=1
		Select  c.kodesupp,C.NoBukti ,C.TANGGAL,d.NAMACUSTSUPP,c.kurs,c.KodeVls,Sum(Isnull(NDPPvls,0)) NDPPVLS,Sum(Isnull(NDPP,0)) NDPP,Sum(isnull(NPPN,0)) NPPN,Sum(isnull(NNET,0)) NNET   
		From  dbInvoiceDet a
		Left Outer Join (select a.NoBukti,Sum(b.NDPP)NDPPvls,Sum(b.NDPPrp)NDPP,Sum(b.NPPNrp)NPPN,Sum(b.NNETrp)NNET from dbBeli a Left Outer Join dbBeliDet b On a.NoBukti=b.noBukti Group by a.NoBukti)b On a.NoBeli=b.NoBukti
		Left Outer join DBInvoice C on A.NOBUKTI = C.NOBUKTI 
		Left Outer Join dbCustSupp D On C.KodeSupp=D.KodeCustSupp
		where C.TANGGAL between @Tgl1 and @Tgl2 and
        Cast(Case when Case when c.IsOtorisasi1=1 then 1 else 0 end+
                      Case when c.IsOtorisasi2=1 then 1 else 0 end+
                      Case when c.IsOtorisasi3=1 then 1 else 0 end+
                      Case when c.IsOtorisasi4=1 then 1 else 0 end+
                      Case when c.IsOtorisasi5=1 then 1 else 0 end=c.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
		Group By C.NoBukti,C.TANGGAL,c.Kurs,c.KodeVls,d.NAMACUSTSUPP,c.KodeSupp
		Order By C.KodeSupp
	if @NeedOto=2
		Select  c.kodesupp,C.NoBukti ,C.TANGGAL,d.NAMACUSTSUPP,c.kurs,c.KodeVls,Sum(Isnull(NDPPvls,0)) NDPPVLS,Sum(Isnull(NDPP,0)) NDPP,Sum(isnull(NPPN,0)) NPPN,Sum(isnull(NNET,0)) NNET   
		From  dbInvoiceDet a
		Left Outer Join (select a.NoBukti,Sum(b.NDPP)NDPPvls,Sum(b.NDPPrp)NDPP,Sum(b.NPPNrp)NPPN,Sum(b.NNETrp)NNET from dbBeli a Left Outer Join dbBeliDet b On a.NoBukti=b.noBukti Group by a.NoBukti)b On a.NoBeli=b.NoBukti
		Left Outer join DBInvoice C on A.NOBUKTI = C.NOBUKTI 
		Left Outer Join dbCustSupp D On C.KodeSupp=D.KodeCustSupp
		where C.TANGGAL between @Tgl1 and @Tgl2 
		Group By C.NoBukti,C.TANGGAL,c.Kurs,c.KodeVls,d.NAMACUSTSUPP,c.KodeSupp
		Order By C.KodeSupp
end



GO

-- Procedure: Sp_ReportKartuHutang
-- Created: 2012-10-25 12:54:23.150 | Modified: 2012-10-25 12:54:23.150
-- =====================================================

CREATE  PROCEDURE [dbo].[Sp_ReportKartuHutang]
@awal datetime,
@akhir datetime,
@kodesupp varchar(10),
@kodesupp1 varchar(10),
@devisi varchar(10),
@Urut int,
@Perkiraan varchar(20),
@rekap tinyint,
@KodeVls varchar(15)

AS
if @Rekap=0
begin
if @urut=0
begin
 	Select 	
 	   Dateadd(dd,-1,@Awal) Tanggal,'Saldo Awal' NoFaktur,''NoBukti,
		0 as kredit1,
		0 as debet1, 
		0 as kreditd1, 0 as debetd1,
		H.KODECUSTSUPP as kode, S.NAMACUSTSUPP as nama, S.Alamat1 Alamat,S.kota,
  		Sum(case when H.Kredit <> 0 then H.kredit
       	      when H.Debet <> 0 then H.debet*-1
  		end) as SaldoRp,
  		Sum(case	when H.KreditD <> 0 then H.KreditD
       			when H.DebetD <> 0 then H.DebetD*-1
  		end) as SaldoD,
		0 as Awal, 0 as AwalD,'' NoRetur,0 urut,0 as totBayar,''P, 1 as xurut,0 kurs,
		Sum(case when H.TipeTrans='J' then H.Kredit-H.Debet 
		         else 0 
		    end) SelisihKurs
 	from vwHutpiut H
 	left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 	where H.KodeCustSupp>=@kodesupp and H.KodeCustSupp<=@kodesupp1 
 	and H.Tanggal<@awal and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
	Group by H.KODECUSTSUPP ,S.NAMACUSTSUPP, s.Alamat1, S.kota
 	union all
 	Select H.Tanggal,H.NoFaktur,H.NoBukti,
 		--case when H.TipeTrans='J' then 0 else H.Debet end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else -H.Debet end end as debet1, 
		--DebetD as kreditd1,
        --H.KreditD as debetd1,
        case when H.NoRetur='' then DebetD else 0 end as kreditd1,
        case when H.NoRetur='' then H.KreditD else -H.DebetD end debetd1, 
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama, '' Alamat, S.kota,
  		case when H.Kredit <> 0 then H.kredit
       			when H.Debet <> 0 then H.debet*-1 end as SaldoRp,
  		case when H.KreditD <> 0 then H.KreditD
       			when H.DebetD <> 0 then H.DebetD*-1 end as SaldoD,
		H.Kredit as Awal, 0 as AwalD, NoRetur, h.urut, debet as totBayar,
		right(h.nofaktur,7),3 as xurut, h.kurs,
		case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP 
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and (H.Tanggal>=@awal and H.Tanggal<=@Akhir) and H.perkiraan=@perkiraan 
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	order by H.KODECUSTSUPP,xurut,tanggal,urut,NoFaktur,NoRetur
end
else if @urut=1
begin
 	Select Dateadd(dd,-1,@Awal) Tanggal,'Saldo Awal' NoFaktur,''NoBukti,
		0 as kredit1,
		0 as debet1, 
		0 as kreditd1, 0 as debetd1,
		H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama, S.Alamat1 Alamat,S.kota,
  		Sum(case when H.Kredit <> 0 then H.kredit
       	      when H.Debet <> 0 then H.debet*-1
  		end) as SaldoRp,
  		Sum(case	when H.KreditD <> 0 then H.KreditD
       			when H.DebetD <> 0 then H.DebetD*-1
  		end) as SaldoD,
		0 as Awal, 0 as AwalD,'' NoRetur,0 urut,0 as totBayar,''P, 1 as xurut,''H,0 kurs,
		Sum(case when H.TipeTrans='J' then H.Kredit-H.Debet 
		         else 0 
		    end) SelisihKurs
    from vwHutpiut H
 	left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 	where H.KodeCustSupp>=@kodesupp and H.KodeCustSupp<=@kodesupp1 
 	and H.Tanggal<@awal and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
	Group by H.KODECUSTSUPP , S.NAMACUSTSUPP, s.Alamat1,S.kota
 	union all
 	Select H.Tanggal,H.NoFaktur,H.NoBukti,
		--case when H.TipeTrans='J' then 0 else H.Debet end as kredit1,
		--case when H.TipeTrans='J' then 0 else H.Kredit end as debet1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else -H.Debet end end as debet1,  
		--H.DebetD as kreditd1,
        --H.KreditD as debetd1, 
        case when H.NoRetur='' then DebetD else 0 end as kreditd1,
        case when H.NoRetur='' then H.KreditD else -H.DebetD end debetd1,
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama, s.ALAMAT1 Alamat,S.kota,
  		case when H.Kredit <> 0 then H.kredit
       			when H.Debet <> 0 then H.debet*-1 end as SaldoRp,
  		case when H.KreditD <> 0 then H.kreditD
       			when H.DebetD <> 0 then H.debetD*-1
  		end as SaldoD,
		H.Kredit as Awal,0 as AwalD,NoRetur,h.urut,debet as totBayar,
		right(h.nofaktur,7)P,3 as xurut,right(h.nofaktur,4)H, h.Kurs,
		case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 	from vwHutpiut H
 	left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp 
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and (H.Tanggal>=@awal and H.Tanggal<=@Akhir) 
 	and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	order by H.KODECUSTSUPP,xurut,H,P,NoFaktur,tanggal,urut
end
end
else
begin
if @urut=0
begin
 	Select Dateadd(dd,-1,@Awal) as tanggal,'Saldo Awal' as NoFaktur,'AWL' as NoBukti,0 as kredit1,0 as debet1,0 as kreditd1,
        		0 as debetd1, H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  		sum(case when H.Kredit <> 0 then H.kredit
       		when H.Debet <> 0 then H.debet*-1
  		end) as saldoRp,
		sum(case when H.KreditD <> 0 then H.kreditD
       		when H.DebetD <> 0 then H.debetD*-1
  		end) as saldoD,0 as Awal,0 as AwalD,'' NoRetur,9999 as urut,0 as totBayar,'',2 as xurut, null kurs, null SelisihKurs
 	from vwHutpiut H
 	left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 	where H.KodeCustSupp>=@kodesupp and H.KodeCustSupp<=@kodesupp1 
 	and H.Tanggal<@awal and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	group by H.KODECUSTSUPP, s.NAMACUSTSUPP, S.kota
 	union all
 	Select H.Tanggal,H.NoFaktur,H.NoBukti,
		--case when H.TipeTrans='J' then 0 else H.Debet end as kredit1,
		--case when H.TipeTrans='J' then 0 else H.Kredit end as debet1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else -H.Debet end end as debet1,  
		--H.DebetD as kreditd1,
        --H.KreditD as debetd1, 
        case when H.NoRetur='' then DebetD else 0 end as kreditd1,
        case when H.NoRetur='' then H.KreditD else -H.DebetD end debetd1,
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  		case when H.Kredit <> 0 then H.kredit
       			when H.Debet <> 0 then H.debet*-1
  		end as SaldoRp,
  		case when H.KreditD <> 0 then H.kreditD
       		when H.DebetD <> 0 then H.debetD*-1
  		end as SaldoD,H.Kredit as Awal, H.KreditD as AwalD,NoRetur,h.urut,debet as totBayar,
		right(h.nofaktur,7),3 as xurut, h.kurs,
		case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 	from vwHutpiut H
 	left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and (H.Tanggal>=@awal and H.Tanggal<=@Akhir) and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	order by H.KODECUSTSUPP,xurut,tanggal,urut,NoFaktur,NoRetur
end
else if @urut=1
begin
	Select null as tanggal,'Saldo Awal' as NoFaktur,'AWL' as NoBukti,0 as kredit1,0 as debet1,0 as kreditd1,
        		0 as debetd1,H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  		sum(case when H.Kredit <> 0 then H.kredit
       		when H.Debet <> 0 then H.debet*-1
  		end) as saldoRp,
		sum(case when H.KreditD <> 0 then H.kreditD
       			when H.DebetD <> 0 then H.debetD*-1
  		end) as saldoD,0 as Awal,0 as AwalD,''NoRetur,9999 as urut,0 as totBayar,'',2 as xurut,'', null kurs, null SelisihKurs
	from vwHutpiut H
 	left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
	and H.perkiraan=@perkiraan and H.Tanggal<=@Awal
	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
	group by H.KODECUSTSUPP,s.NAMACUSTSUPP, S.kota
	having sum(kredit)-sum(debet)<>0

 	union all
 	Select H.Tanggal,H.NoFaktur Nofaktur,H.NoBukti,
		--case when H.TipeTrans='J' then 0 else H.Debet end as kredit1,
		--case when H.TipeTrans='J' then 0 else H.Kredit end as debet1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else -H.Debet end end as debet1,  
		--H.DebetD as kreditd1,
        --H.KreditD as debetd1,
        case when H.NoRetur='' then DebetD else 0 end as kreditd1,
        case when H.NoRetur='' then H.KreditD else -H.DebetD end debetd1, 
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  case when H.Kredit <> 0 then H.kredit
       when H.Debet <> 0 then H.debet*-1
  end as SaldoRp,
  case when H.KreditD <> 0 then H.kreditD
       when H.DebetD <> 0 then H.debetD*-1
  end as SaldoD,H.Kredit as Awal, H.KreditD as AwalD,NoRetur,h.urut,debet as totBayar,right(h.nofaktur,7),3 as xurut,right(h.nofaktur,4), h.kurs,
	case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 from vwHutpiut H
 left outer join  DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 and (H.Tanggal>=@awal and H.Tanggal<=@Akhir)
 and H.perkiraan=@perkiraan
 and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 order by H.KODECUSTSUPP,xurut,nofaktur,tanggal,urut
end
end








GO

-- Procedure: Sp_ReportKartuPiutang
-- Created: 2012-10-25 13:38:34.267 | Modified: 2012-10-25 13:38:34.267
-- =====================================================

CREATE  PROCEDURE [dbo].[Sp_ReportKartuPiutang]
@awal datetime,
@akhir datetime,
@kodesupp varchar(10),
@kodesupp1 varchar(10),
@devisi varchar(10),
@Urut int,
@Perkiraan varchar(20),
@rekap tinyint,
@KodeVls varchar(15)

AS
if @Rekap=0
begin
if @urut=0
begin
 	Select Dateadd(dd,-1,@Awal) Tanggal,'Saldo Awal'NoFaktur,''NoBukti,
		0 as kredit1,
		0 as debet1, 
		0 as kreditd1, 0 as debetd1,
		H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama, S.Alamat1 Alamat ,S.kota,
  		Sum(case 	when H.Debet <> 0 then H.Debet
       			when H.Kredit <> 0 then H.Kredit*-1
  		end) as SaldoRp,
  		Sum(case 	when H.DebetD <> 0 then H.DebetD
       			when H.KreditD <> 0 then H.KreditD*-1
  		end) as SaldoD,
		0 as Awal, 0 as AwalD,''NoRetur,0urut,0 as totBayar,''P, 1 as xurut,0 kurs,
		Sum(case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end) SelisihKurs
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp 
 	where H.KodeCustSupp>=@kodesupp and H.KodeCustSupp<=@kodesupp1
 	and H.Tanggal<@awal and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	Group by H.KODECUSTSUPP ,S.NAMACUSTSUPP , S.Alamat1, S.kota
 	union all
 	Select H.Tanggal,H.NoFaktur,H.NoBukti,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else -H.Kredit end end as debet1, 
		case when H.NoRetur='' then H.KreditD else 0 end as kreditd1,
        case when H.NoRetur='' then H.DebetD else -H.KreditD end debetd1, 
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama, s.Alamat1 Alamat, S.kota,
  		case when H.Debet <> 0 then H.Debet
       			when H.Kredit <> 0 then H.Kredit*-1 end as SaldoRp,
  		case when H.DebetD <> 0 then H.DebetD
       			when H.KreditD <> 0 then H.KreditD*-1 end as SaldoD,
		H.Kredit as Awal, 0 as AwalD, NoRetur, h.urut, H.Kredit as totBayar,
		right(h.nofaktur,7),3 as xurut, h.kurs,
		case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	 and (H.Tanggal>=@awal and H.Tanggal<=@Akhir)
 	 and H.perkiraan=@perkiraan
 	 and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	order by H.KODECUSTSUPP, xurut, tanggal,urut,NoFaktur,NoRetur
end
else if @urut=1
begin
 	Select 	Dateadd(dd,-1,@Awal) Tanggal,'Saldo Awal' NoFaktur,'' NoBukti, 
		0 as kredit1,
		0 as debet1, 
		0 as kreditd1,
      0 as debetd1, H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama, S.ALAMAT1 Alamat,S.kota,
  		Sum(case when H.Debet <> 0 then H.Debet
       			when H.Kredit <> 0 then H.Kredit*-1 end) as SaldoRp,
  		Sum(case when H.DebetD <> 0 then H.DebetD
       			when H.KreditD <> 0 then H.KreditD*-1 end) as SaldoD,
		0 as Awal,0 as AwalD,''NoRetur,0urut,0 as totBayar,
		''P, 1 as xurut,'' H, 0 kurs,
		Sum(case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end) SelisihKurs
 	from 	vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP 
 	where H.Tanggal<@awal and H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	Group by H.KODECUSTSUPP ,S.NAMACUSTSUPP , S.Alamat1, S.kota
 	union all
 	Select H.Tanggal, H.NoFaktur, H.NoBukti,
		--case when H.TipeTrans='J' then 0 else H.Kredit end as kredit1,
		--case when H.TipeTrans='J' then 0 else H.Debet end as debet1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else -H.Kredit end end as debet1,  
		--H.KreditD as kreditd1,
        --H.DebetD as debetd1,
        case when H.NoRetur='' then H.KreditD else 0 end as kreditd1,
        case when H.NoRetur='' then H.DebetD else -H.KreditD end debetd1,  
        H.KODECUSTSUPP as kode, S.NAMACUSTSUPP nama, s.ALAMAT1 Alamat,S.kota,
  		case when H.Debet <> 0 then H.Debet
       			when H.Kredit <> 0 then H.Kredit*-1 end as SaldoRp,
  		case when H.DebetD <> 0 then H.DebetD
       			when H.KreditD <> 0 then H.KreditD*-1
  		end as SaldoD,
		H.Debet as Awal, 0 as AwalD, NoRetur,h.urut, H.Kredit as totBayar,
		right(h.nofaktur,7),3 as xurut,right(h.nofaktur,4), h.Kurs,
		case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on (S.KODECUSTSUPP=H.KODECUSTSUPP) 
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and (H.Tanggal>=@awal and H.Tanggal<=@Akhir)
 	and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	order by h.KODECUSTSUPP,xurut,H,P,NoFaktur,tanggal,urut
end
end
else
begin
if @urut=0
begin
 	Select 	null as tanggal,'Saldo Awal' as NoFaktur,'AWL' as NoBukti,0 as kredit1,0 as debet1,0 as kreditd1,
        		0 as debetd1, H.KODECUSTSUPP Kode, S.NAMACUSTSUPP nama,'' alamat,S.kota,
  		sum(case when H.Debet <> 0 then H.Debet
       		when H.Kredit <> 0 then H.Kredit*-1
  		end) as saldoRp,
		sum(case when H.DebetD <> 0 then H.DebetD
       		when H.KreditD <> 0 then H.KreditD*-1
  		end) as saldoD,0 as Awal,0 as AwalD,'' NoRetur,9999 as urut,0 as totBayar,'',2 as xurut, null kurs, null SelisihKurs
 	from vwHutpiut  H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and H.perkiraan=@perkiraan and h.Tanggal<@Awal
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	group by H.KODECUSTSUPP,s.NAMACUSTSUPP, S.kota
 	union all
 	Select H.Tanggal,H.NoFaktur,H.NoBukti,
		--case when H.TipeTrans='J' then 0 else H.Kredit end as kredit1,
		--case when H.TipeTrans='J' then 0 else H.Debet end as debet1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else -H.Kredit end end as debet1,  
		--H.KreditD as kreditd1,
        --H.DebetD as debetd1, 
        case when H.NoRetur='' then H.KreditD else 0 end as kreditd1,
        case when H.NoRetur='' then H.DebetD else -H.KreditD end debetd1, 
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  		case when H.Debet <> 0 then H.Debet
       			when H.Kredit <> 0 then H.Kredit*-1
  		end as SaldoRp,
  		case when H.DebetD <> 0 then H.DebetD
       		when H.KreditD <> 0 then H.KreditD*-1
  		end as SaldoD, H.Debet as Awal, H.DebetD as AwalD, NoRetur,h.urut, H.Kredit as totBayar,
		right(h.nofaktur,7),3 as xurut, h.kurs,
		case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP 
 	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
 	and (H.Tanggal>=@awal and H.Tanggal<=@Akhir)
 	and H.perkiraan=@perkiraan
 	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 	order by H.KODECUSTSUPP,xurut,tanggal,urut,NoFaktur,NoRetur
end
else if @urut=1
begin
	Select null as tanggal,'Saldo Awal' as NoFaktur,'AWL' as NoBukti,0 as kredit1,0 as debet1,0 as kreditd1,
        		0 as debetd1, H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  		sum(case when H.Debet <> 0 then H.Debet
       		when H.Kredit <> 0 then H.Kredit*-1
  		end) as saldoRp,
		sum(case when H.DebetD <> 0 then H.DebetD
       			when H.KreditD <> 0 then H.KreditD*-1
  		end) as saldoD,0 as Awal,0 as AwalD,''NoRetur,9999 as urut,0 as totBayar,'',2 as xurut,'', null kurs, null SelisihKurs
	from vwHutpiut H
	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP
	where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
	and H.perkiraan=@perkiraan and H.Tanggal<=@Awal
	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
	group by H.KODECUSTSUPP,s.NAMACUSTSUPP, S.kota
	having sum(kredit)-sum(debet)<>0

 	union all
 	Select H.Tanggal,H.NoFaktur Nofaktur,H.NoBukti,
		--case when H.TipeTrans='J' then 0 else H.Kredit end as kredit1,
		--case when H.TipeTrans='J' then 0 else H.Debet end as debet1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Kredit else 0 end end as kredit1,
		case when H.TipeTrans='J' then 0 else case when H.NoRetur='' then H.Debet else -H.Kredit end end as debet1,  
		--H.KreditD as kreditd1,
        --H.DebetD as debetd1, 
        case when H.NoRetur='' then H.KreditD else 0 end as kreditd1,
        case when H.NoRetur='' then H.DebetD else -H.KreditD end debetd1, 
        H.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,'' alamat,S.kota,
  case when H.Debet <> 0 then H.Debet
       when H.Kredit <> 0 then H.Kredit*-1
  end as SaldoRp,
  case when H.DebetD <> 0 then H.DebetD
       when H.KreditD <> 0 then H.KreditD*-1
  end as SaldoD,H.Debet as Awal, H.DebetD as AwalD,NoRetur,h.urut,H.Kredit as totBayar,right(h.nofaktur,7),3 as xurut,right(h.nofaktur,4), h.kurs,
	case when H.TipeTrans='J' then H.Kredit-H.Debet else 0 end SelisihKurs
 from vwHUTPIUT H
 left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KODECUSTSUPP
 where H.KODECUSTSUPP>=@kodesupp and H.KODECUSTSUPP<=@kodesupp1 
	 and (H.Tanggal>=@awal and H.Tanggal<=@Akhir)
	 and H.perkiraan=@perkiraan
	 and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 order by H.KODECUSTSUPP,xurut,nofaktur,tanggal,urut
end
end








GO

-- Procedure: Sp_reportkartuStock
-- Created: 2013-06-03 10:47:34.573 | Modified: 2013-06-03 10:47:34.573
-- =====================================================


CREATE Procedure [dbo].[Sp_reportkartuStock]

@kodegdg varchar(15),
@Kodebrg varchar(15),
@bulan1 int,
@bulan2 int,
@tahun1 int,
@tahun2 int,
@periode1 varchar(6),
@periode2 varchar(6)
 as 
		/*Declare @kodegdg varchar(15),@Kodebrg varchar(15),@bulan1 int,@bulan2 int,@tahun1 int,@tahun2 int,
        @periode1 varchar(6),@periode2 varchar(6)
		Select @KodeGdg='G01' ,@KodeBrg='A-10109'
		select @Bulan1=10 ,@Tahun1=2012
		select @Bulan2=10 ,@Tahun2=2012
		Select @Periode1='201210'
		Select @Periode2='201210' */


/*Select 'AWL' Tipe, 'A0' Prioritas, X.KodeBrg, X.KodeGdg, sum(X.Qnt) Qnt, 
      sum(X.NilaiDPP) NilaiDPP, sum(X.NilaiPPN) NilaiPPN, sum(X.JumlahNetto) JumlahNetto, 
      0 QntDB, 0 HrgDebet, 0 QntCR, 0 HrgKredit, sum(X.QntSaldo) QntSaldo, 
      sum(HrgSaldo) HrgSaldo, max(X.Tanggal) Tanggal, @Bulan1 Bulan, @Tahun1 Tahun, 
      'Saldo Awal' NoBukti, '' Keterangan, 
      case when sum(X.QntSaldo)=0 then 0 else sum(X.HrgSaldo)/sum(X.QntSaldo) end * C.Isi1  HPP, C.NamaBrg
from 
(
select 'AWL' Tipe, 'A0' Prioritas, B.KodeBrg, B.KodeGdg, 
       B.QntAwal Qnt, B.HrgAwal NilaiDPP, 0 NilaiPPN, B.HrgAwal JumlahNetto,
       0 QntDB, 0 HrgDebet,
       0 QntCR, 0 HrgKredit,
       B.QntAwal QntSaldo,
       B.HrgAwal HrgSaldo,
       cast(@Periode1+'01' as Datetime) Tanggal,
       B.Bulan, B.Tahun, 'Saldo Awal' NoBukti, '' Keterangan,
       0 HPP
from dbStockBrg B Left Outer Join dbBarang C On c.KodeBrg=b.KodeBrg
Where B.Bulan=@bulan1 and B.Tahun=@Tahun1 and B.KodeGdg=@KodeGdg and B.KodeBrg=@KodeBrg*/



/*union all
Select A.Tipe, A.Prioritas, A.KodeBrg, A.KodeGdg, A.Qnt, A.NilaiDPP, A.NilaiPPN, A.JumlahNetto, 
      A.QntDB, A.HrgDebet, A.QntCR, A.HrgKredit, A.QntSaldo, A.HrgSaldo, A.Tanggal, A.Bulan, A.Tahun, 
      A.NoBukti, A.Keterangan, Case When '1'=1 Then A.HPP*B.Isi1 
When '1'=2 Then A.HPP*B.Isi2 
When '1'=3 Then A.HPP*B.Isi3 end HPP 
from  vwKartuStock A Left Outer Join dbBarang B On A.KodeBrg=B.KodeBrg
where A.Tahun=@Tahun1 and A.Bulan<@Bulan1 
      and A.KodeGdg=@KodeGdg and A.KodeBrg=@KodeBrg 
) X 
left outer join dbBarang C on C.KodeBrg=X.KodeBrg 
group by X.KodeBrg, X.KodeGdg, C.NamaBrg,C.Isi1 
union all*/
Select A.Tipe, A.Prioritas, A.KodeBrg, A.KodeGdg, A.Qnt Qnt, A.NilaiDPP, A.NilaiPPN, A.JumlahNetto, 
      A.QntDB QntDB, A.HrgDebet, 
      A.QntCR QntCR, A.HrgKredit, 
      A.QntSaldo QntSaldo, A.HrgSaldo, A.Tanggal, A.Bulan, A.Tahun, 
      A.NoBukti, A.Keterangan, Case When '1'=1 Then A.HPP*c.Isi1 
When '1'=2 Then A.HPP*c.Isi2 
When '1'=3 Then A.HPP*c.Isi3 end HPP 
, C.NamaBrg 
from  vwKartuStock A left Outer join dbBarang C on C.KodeBrg=A.KodeBrg
left outer join dbgroup D on c.kodegrp = d.kodegrp
where (Cast(year(A.Tanggal) as varchar(4))+right('0'+Cast(month(A.tanggal) as varchar(2)),2) between @Periode1 and @Periode2)
	and (A.Tipe<>'AWL' or (A.Tipe='AWL' and A.Bulan=@bulan1 and A.Tahun=@tahun1))
      and A.KodeGdg=@KodeGdg and A.KodeBrg=@KodeBrg 
Order by A.Tanggal, A.Prioritas, A.Nobukti, A.Urut






GO

-- Procedure: Sp_ReportLabaRugi
-- Created: 2011-06-01 10:51:48.943 | Modified: 2015-10-30 02:18:15.250
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_ReportLabaRugi]

@Bulan int,@tahun int,@devisi varchar(10),@prosesRlHpp bit,@jumlahA numeric(18,2),@jumlahB numeric(18,2),@jumlahC numeric(18,2),@jumlahD numeric(18,2)

AS

Set @devisi= Case when @devisi in ('-','') then '%' else @devisi end

   select case when jumlah<>'' then '    '+keterangan else Keterangan end keterangan
        ,jumlah,TotalA ,TotalB, TotalC,TotalD,tipe,tanda,Persen,
        case when @jumlahA<>0 then (TotalA/@jumlahA)*100 else 0 end P1,
        case when @jumlahB<>0 then (TotalB/@jumlahB)*100 else 0 end P2,
        case when @jumlahC<>0 then (TotalC/@jumlahC)*100 else 0 end P3,
        case when @jumlahD<>0 then (TotalD/@jumlahD)*100 else 0 end P4,
        IsLRHPP, Devisi,Bulan,Tahun,
        Perkiraan+Jumlah perkiraan, Nomor
   from DBLRHPP
   where bulan=@Bulan and tahun=@tahun and devisi Like @devisi and tampil='Y' and IsLRHPP=@prosesRlHpp 
   --and ISNULL(totala+TotalB+TotalC,0) <> case when Perkiraan='' and Jumlah='' then -1 else 0 end
   order by Nomor



GO

-- Procedure: Sp_ReportLaporanStock
-- Created: 2011-12-20 23:34:13.613 | Modified: 2011-12-20 23:34:13.613
-- =====================================================
Create Procedure dbo.Sp_ReportLaporanStock
@bulan int, @tahun int, @kodegdg varchar(15), @nosat int
as
--Select @bulan=1, @tahun=2011, @kodegdg='A', @nosat=1
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
Select a.bulan,a.tahun,a.kodegdg,a.kodebrg,       
       b.NAMABRG, c.NAMA Namagdg,
       b.KodeKelompok, d.Keterangan NamaKelompok, 
       b.KodeKategori, e.Keterangan NamaKategori, 
       b.KodeSubKategori, f.Keterangan NamaSubKategori, 
       b.KodeJnsBrg, g.Keterangan NamaJenis, 
       b.kodesubJnsBrg, h.Keterangan NamaSubjenis,
       Case when @nosat=1 then b.SAT1 else b.Sat2 end Satuan,
       Case when @nosat=1 then a.QNTAWAL else a.QNT2AWAL end QntAwal,
       Case when @nosat=1 then a.QNTBPPB else a.QNT2BPPB end QntBPPB,
       Case when @nosat=1 then a.QNTBatalBPPB else a.QNT2BatalBPPB end QntBatalBPPB,
       Case when @nosat=1 then a.QNTBPB else a.QNT2BPB end QntBPB,
       Case when @nosat=1 then a.QNTRBPB else a.QNT2RBPB end QntRBPB,
       Case when @nosat=1 then a.QNTPPL else a.QNT2PPL end QntPPL,
       Case when @nosat=1 then a.QNTBPL else a.QNT2BPL end QntBPL,
       Case when @nosat=1 then a.QNTSPRK else a.QNT2SPRK end QntSPRK,
       Case when @nosat=1 then a.QNTBSPRK else a.QNT2BSPRK end QntBSPRK,
       Case when @nosat=1 then a.QNTSPAT else a.QNT2SPAT end QntSPAT,
       Case when @nosat=1 then a.QNTPO else a.QNT2PO end QntPO,
       Case when @nosat=1 then a.QNTBPO else a.QNT2BPO end QntBPO,
       Case when @nosat=1 then a.QNTPBL else a.QNT2PBL end QntPBL,
       Case when @nosat=1 then a.QNTINS else a.QNT2INS end QntINS,
       Case when @nosat=1 then a.QNTKNS else a.QNT2KNS end QntKNS,
       Case when @nosat=1 then a.QNTRPB else a.QNT2RPB end QntRPB,
       Case when @nosat=1 then a.QNTPNJ else a.QNT2PNJ end QntPNJ,
       Case when @nosat=1 then a.QNTRPJ else a.QNT2RPJ end QntRPJ,
       Case when @nosat=1 then a.QNTPRJ else a.QNT2PRJ end QntPRJ,
       Case when @nosat=1 then a.QNTADI else a.QNT2ADI end QntADI,
       Case when @nosat=1 then a.QNTADO else a.QNT2ADO end QntADO,
       Case when @nosat=1 then a.QNTUKI else a.QNT2UKI end QntUKI,
       Case when @nosat=1 then a.QNTUKO else a.QNT2UKO end QntUKO,
       Case when @nosat=1 then a.QNTTRI else a.QNT2TRO end QntTRO,
       Case when @nosat=1 then a.QNTBHNIn else a.QNT2BHNIn end QntBHNIn,
       Case when @nosat=1 then a.QNTBHNOut else a.QNT2BHNOut end QntBHNOut,
       Case when @nosat=1 then a.QNTBHNIn else a.QNT2BHNIn end QntBHNIn,
       Case when @nosat=1 then a.QNTIN else a.QNT2IN end QntIN,
       Case when @nosat=1 then a.QNTOUT else a.QNT2OUT end QntOUT,
       Case when @nosat=1 then a.SALDOQNT else a.SALDOQNT2 end SaldoQnt,
       a.HRGAWAL,a.HRGBPPB,a.HRGBatalBPPB,a.HRGBPB,a.HRGRBPB,a.HRGPPL,a.HRGBPL,
       a.HRGSPRK,a.HRGBSPRK,a.HRGSPAT,a.HRGPO,a.HRGBPO,a.HRGPBL,a.HRGINS,a.HRGKNS,
       a.HRGRPB,a.HRGPNJ,a.HRGRPJ,a.HRGPRJ,a.HRGADI,a.HRGADO,a.HRGUKI,a.HRGUKO,
       a.HRGTRI,a.HRGTRO,a.HRGBHNIn,a.HRGBHNOut,a.HRGRATA,a.HRGPRO,
       a.SALDORP
from DBSTOCKBRG a
     left outer join DBBARANG b on b.KODEBRG=a.KODEBRG and b.Kodegdg=a.KODEGDG
     left outer join DBGUDANG c on c.KODEGDG=a.KODEGDG
     left outer join DBKELOMPOK d on d.KodeKelompok=b.KodeKelompok
     left outer join DBKATEGORI e on e.KodeKategori=b.KodeKategori
     left outer join DBSUBKATEGORI f on f.KodeSubKategori=b.KodeSubKategori and f.KodeKategori=b.KodeKategori
     left outer join DBJenis g on g.KodeJnsBrg=b.KodeJnsBrg
     left outer join DBSUBJENIS h on h.kodesubJnsBrg=b.kodesubJnsBrg and h.KodeJnsBrg=b.KodeJnsBrg
where a.BULAN=@bulan and a.TAHUN=@tahun and a.KODEGDG like @kodegdg
Order by b.KodeKelompok,b.KodeKategori,a.KODEBRG
GO

-- Procedure: Sp_ReportMutasi
-- Created: 2011-03-03 15:17:45.627 | Modified: 2015-05-23 10:00:02.787
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_ReportMutasi]
@bulan int,
@tahun int,
@devisi varchar(10),
@IdUser varchar(15)
AS
Select A.Perkiraan, A.Keterangan,B.MDRp MD,B.MKRp MK,  B.AkhirDRp SaldoDAkhir,
       B.JPD, B.JPDRp, B.JPK, B.JPKRp,
       B.AkhirKRp SaldoKAkhir, 
       Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0
       end  SaldoAwal,a.GroupPerkiraan, c.Keterangan namaperkiraan,b.Budget
from DBPERKIRAAN A
     Left Outer join DBNERACA B on B.Perkiraan=A.Perkiraan
     left outer join DBPERKIRAAN c on c.Perkiraan =a.GroupPerkiraan 
where B.Bulan=@bulan and B.Tahun=@tahun and B.Devisi like Case when @devisi='-' then '%' else @devisi end and c.IsSubPerkiraan=0
Order by A.Perkiraan

GO

-- Procedure: sp_ReportNeracaAktiva
-- Created: 2013-07-11 11:46:37.407 | Modified: 2024-08-07 14:52:49.167
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportNeracaAktiva] 
@devisi varchar(10),
@bulan int,
@tahun int
AS
Set @devisi=Case when @devisi in ('-','') then '%' else @devisi end
select (select P.KetNeraca from dbperkiraan P where P.perkiraan=C.perkiraan) as keterangan, substring(C.neraca,1,1) as grupAP1,
          substring(C.neraca,1,2) as grupAP2,
          isnull((select SUM((a.AwalDRp-a.AwalKRp)+(a.MDRp-a.MKRp)+(a.JPDRp-a.JPKRp)+(a.RLDRp-a.RLKRp))
          from dbneraca A,dbperkiraan B
          where A.bulan=@bulan and A.tahun=@tahun and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah1,
          
          isnull((select SUM((a.AwalDRp-a.AwalKRp)+(a.MDRp-a.MKRp)+(a.JPDRp-a.JPKRp)+(a.RLDRp-a.RLKRp))
          from dbneraca A,dbperkiraan B
          where A.bulan=@bulan-1 and A.tahun=@tahun and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah2

from dbperkiraan C
where len(C.neraca)=6 and substring(C.neraca,1,1)='A'  
order by C.neraca

GO

-- Procedure: sp_ReportNeracaAktivaTahunan
-- Created: 2015-10-30 02:27:50.470 | Modified: 2015-10-30 02:27:50.470
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportNeracaAktivaTahunan] 
@devisi varchar(10),
@bulan int,
@tahun int
AS
Set @devisi=Case when @devisi in ('-','') then '%' else @devisi end
select (select P.KetNeraca from dbperkiraan P where P.perkiraan=C.perkiraan) as keterangan, substring(C.neraca,1,1) as grupAP1,
          substring(C.neraca,1,2) as grupAP2,
          isnull((select SUM((a.AwalDRp-a.AwalKRp)+(a.MDRp-a.MKRp)+(a.JPDRp-a.JPKRp)+(a.RLDRp-a.RLKRp))
          from dbneraca A,dbperkiraan B
          where A.tahun=@tahun and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah1,
          
          isnull((select SUM((a.AwalDRp-a.AwalKRp)+(a.MDRp-a.MKRp)+(a.JPDRp-a.JPKRp)+(a.RLDRp-a.RLKRp))
          from dbneraca A,dbperkiraan B
          where A.tahun=@tahun-1 and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah2

from dbperkiraan C
where len(C.neraca)=6 and substring(C.neraca,1,1)='A'  
order by C.neraca

GO

-- Procedure: Sp_ReportNeracaBulanan
-- Created: 2015-06-06 13:55:47.373 | Modified: 2023-03-06 11:32:14.793
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_ReportNeracaBulanan]
@bulan int,
@tahun int,
@devisi varchar(10),
@IdUser varchar(15)
AS
--Select @bulan =2 , @tahun =2015, @devisi='01', @IdUser ='SA'
;with saldoEnamDigit as 
(
  select left (Perkiraan,6) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, 
                                           SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,(case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)+SUM(a.MDRp)+sum(a.JPD)-SUM(a.MKRp )-SUM(a.JPK) saldoakhirgeneral
                                           , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,6), DK,Tahun,Bulan,a.Devisi

),
 SaldoDuaDigit as 
(
  select left (Perkiraan,2) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalGeneral, SUM(a.MDRp) mdgeneral,
  SUM(a.MKRp )mkgeneral,sum(a.JPD) JPDGeneral, SUM(a.JPK) JPKGeneral,(case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp)end)+SUM(a.MDRp)+sum(a.JPD)-SUM(a.MKRp )-SUM(a.JPK) saldoakhirgeneral
                                           , sum(a.Budget) BudgetGeneral,a.Tahun,a.Bulan,a.Devisi
   from DBNERACA a where Tahun=@tahun  and Bulan =@bulan   --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,2), DK,Tahun,Bulan,a.Devisi
),
 saldobiaya as 
(
  select left (Perkiraan,1) Perkiraan,case when a.DK=0 then SUM(a.AwalDRp)-SUM(a.AwalKRp) 
                                           else SUM(a.AwalKRp)-SUM(a.AwalDRp) end saldoawalbiaya, SUM(a.MDRp) mdgeneralbiaya,
  SUM(a.MKRp )mkgeneralbiaya
   from DBNERACA a where Tahun=@tahun and Bulan =@bulan  --and
  --LEN(a.Perkiraan)<8
  group by  left (Perkiraan,1),DK

)
Select * from (
Select 'B' Urutan,a.GroupPerkiraan,a.Perkiraan, A.Keterangan,
       case when b.saldoawalGeneral<0 then b.saldoawalGeneral*-1 else b.saldoawalGeneral end SaldoAwal,
       case when b.saldoawalGeneral<0 or (a.DK=1 and b.saldoawalGeneral<>0) then 'K' else '' end kSaldoAwal,
       b.saldoawalGeneral AsliSaldoAwal,
       case when b.mdgeneral<0 then b.mdgeneral*-1 else b.mdgeneral end MD,
       case when b.mdgeneral<0 OR (a.DK=1 and b.mdgeneral<>0) then 'K' else '' end kMD,
       b.mdgeneral AsliMD,
       case when B.mkgeneral<0 then b.mkgeneral*-1 else b.mkgeneral end MK,
       case when b.mkgeneral<0 OR (a.DK=1 and b.mkgeneral<>0) then 'K' else '' end kMK,
       B.mkgeneral AsliMK,
       case when b.saldoakhirgeneral<0 then b.saldoakhirgeneral*-1 else b.saldoakhirgeneral end SaldoAkhir,
       case when b.saldoakhirgeneral<0 OR (a.DK=1 and b.saldoakhirgeneral<>0) then 'K' else '' end kSaldoAkhir,
       b.saldoakhirgeneral AsliSaldoAkhir,
       b.BudgetGeneral,case when a.IsSubPerkiraan=1 then '*' else '' end bintang,a.DK
from DBPERKIRAAN A
     Left Outer join saldoEnamDigit B on b.Perkiraan=a.Perkiraan 
where B.Bulan=@bulan and B.Tahun=@tahun and B.Devisi like Case when @devisi='-' then '%' else @devisi end
union all
select 'A' Urutan,GroupPerkiraan,Perkiraan,Keterangan,null SaldoAwal,'' kSaldoAwal,null AsliSaldoAwal,null MD,'' kMD,null AsliMD
,null MK,'' kMK,null AsliMK,null SaldoAkhir,''kSaldoAkhir,null AsliSaldoAkhir,null BudgetGeneral,''Bintang,'' DK 
from DBPERKIRAAN where LEN(Perkiraan)<=4
)X where x.Perkiraan<>'X'
Order by x.Perkiraan,X.Urutan

GO

-- Procedure: Sp_ReportNeracaBulanan1
-- Created: 2015-09-26 03:36:06.533 | Modified: 2016-03-19 18:37:45.077
-- =====================================================



CREATE PROCEDURE [dbo].[Sp_ReportNeracaBulanan1]
--declare
@bulan int,
@tahun int,
@devisi varchar(10),
@IdUser varchar(15)
AS
--Select @bulan =2 , @tahun =2016, @devisi='01', @IdUser ='SA'
delete TempNerBul where Tanda in ('M4','M3') 
and LEFT(Perkiraan,4) in (select LEFT(Perkiraan,4) from TempNerBul  group by LEFT(Perkiraan,4) having COUNT(LEFT(Perkiraan,4))=2)
delete TempNerBul where Tanda in ('M2') 
and LEFT(Perkiraan,2) in (select LEFT(Perkiraan,2) from TempNerBul  group by LEFT(Perkiraan,2) having COUNT(LEFT(Perkiraan,2))=2)
select case when Tanda in ('M6','M4','M8H','M8') then Perkiraan else '' end Perkiraan
           ,[Keterangan]
           ,[DK]
           ,[GroupPerkiraan]
           ,[IsSubPerkiraan]
           ,[Tanda]
           ,[Awal]
           ,[AwalK]
           ,[Debet]
           ,[DebetK]
           ,[Kredit]
           ,[KreditK]
           ,[Akhir]
           ,[AkhirK]
           ,[Bintang]
           ,[Budget] from TempNerBul where bulan=@bulan and tahun=@tahun


GO

-- Procedure: sp_ReportNeracaPasiva
-- Created: 2013-07-11 11:47:51.747 | Modified: 2015-10-30 02:25:49.813
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportNeracaPasiva] 
@devisi varchar(10),
@bulan int,
@tahun int
AS
Set @devisi=Case when @devisi in ('-','') then '%' else @devisi end
select (select P.KetNeraca from dbperkiraan P where P.perkiraan=C.perkiraan) as keterangan, substring(C.neraca,1,1) as grupAP1,
          substring(C.neraca,1,2) as grupAP2,
          isnull((select SUM((a.AwalKRp-A.AwalDRp)+(a.MKRp-A.MDRp)+(a.JPKRp-A.JPDRp)+(a.RLKRp-A.RLDRp))
          from dbneraca A,dbperkiraan B
          where A.bulan=@bulan and A.tahun=@tahun and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah1,
          
          isnull((select SUM((a.AwalKRp-A.AwalDRp)+(a.MKRp-A.MDRp)+(a.JPKRp-A.JPDRp)+(a.RLKRp-A.RLDRp))
          from dbneraca A,dbperkiraan B
          where A.bulan=@bulan-1 and A.tahun=@tahun and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah2

from dbperkiraan C
where len(C.neraca)=6 and substring(C.neraca,1,1)='P'  
order by C.neraca

GO

-- Procedure: sp_ReportNeracaPasivaTahunan
-- Created: 2015-10-30 02:26:51.843 | Modified: 2015-10-30 02:26:51.843
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportNeracaPasivaTahunan] 
@devisi varchar(10),
@bulan int,
@tahun int
AS
Set @devisi=Case when @devisi in ('-','') then '%' else @devisi end
select (select P.KetNeraca from dbperkiraan P where P.perkiraan=C.perkiraan) as keterangan, substring(C.neraca,1,1) as grupAP1,
          substring(C.neraca,1,2) as grupAP2,
          isnull((select SUM((a.AwalKRp-A.AwalDRp)+(a.MKRp-A.MDRp)+(a.JPKRp-A.JPDRp)+(a.RLKRp-A.RLDRp))
          from dbneraca A,dbperkiraan B
          where A.tahun=@tahun and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah1,
          
          isnull((select SUM((a.AwalKRp-A.AwalDRp)+(a.MKRp-A.MDRp)+(a.JPKRp-A.JPDRp)+(a.RLKRp-A.RLDRp))
          from dbneraca A,dbperkiraan B
          where A.tahun=@tahun-1 and A.perkiraan=B.perkiraan and substring(B.neraca,1,5)=substring(C.Neraca,1,5)),0) as jumlah2

from dbperkiraan C
where len(C.neraca)=6 and substring(C.neraca,1,1)='P'  
order by C.neraca

GO

-- Procedure: Sp_ReportOpnamebahan
-- Created: 2013-06-03 14:33:01.780 | Modified: 2015-03-09 15:32:12.600
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportOpnamebahan]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@Needoto Smallint,
@Iduser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		If @Needoto=0 or @Needoto=1
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2 And NeedOtoRisasi=@Needoto
		   order by NoBukti,TANGGAL
		If @Needoto=2
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2 
		   order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		If @Needoto=0 or @Needoto=1
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2 And NeedOtoRisasi=@Needoto
		  order by KodeBrg
		If @Needoto=2
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg
		end 
End
else
begin
If @Ordr='N'
		begin
		If @Needoto=0 or @Needoto=1
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2 And NeedOtoRisasi=@Needoto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)  
		  order by NoBukti,TANGGAL
		If @Needoto=2
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)  
		   order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		If @Needoto=0 or @Needoto=1
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2 And NeedOtoRisasi=@Needoto
		 and kodebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)  
		  order by KodeBrg
		If @Needoto=2
		  select * from VwreportOpnameBahan where Tanggal between @tgl1 and @tgl2
		 and kodebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)  
		  order by KodeBrg
		end 
End





GO

-- Procedure: Sp_ReportOpnameBarang
-- Created: 2013-06-03 14:34:25.937 | Modified: 2015-03-09 15:32:12.563
-- =====================================================




CREATE Procedure [dbo].[Sp_ReportOpnameBarang]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeeDoto SmallInt,
@Iduser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		 If @NeeDoto=0 Or @NeeDoto=1
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeeDoto
		  order by NoBukti,TANGGAL
		 If @NeeDoto=2
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 
		  order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		If @NeeDoto=0 Or @NeeDoto=1
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeeDoto
		  order by KodeBrg
		If @NeeDoto=2
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeeDoto
		  order by KodeBrg
		end 
End
else
begin
If @Ordr='N'
		begin
		 If @NeeDoto=0 Or @NeeDoto=1
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeeDoto
		  order by NoBukti,TANGGAL
		 If @NeeDoto=2
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 
		  order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		If @NeeDoto=0 Or @NeeDoto=1
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeeDoto
		  order by KodeBrg
		If @NeeDoto=2
		  select * from VwreportOPnamebarang where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeeDoto
		  order by KodeBrg
		end 
End




GO

-- Procedure: Sp_ReportOutSODet
-- Created: 2013-05-13 12:11:46.853 | Modified: 2013-05-13 12:11:46.853
-- =====================================================


Create Procedure [dbo].[Sp_ReportOutSODet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from vwreportoutSO where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from vwreportoutSO where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from vwreportoutSO where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End



GO

-- Procedure: Sp_ReportOutSORek
-- Created: 2013-05-13 12:11:46.843 | Modified: 2013-05-13 12:11:46.843
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportOutSORek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
	Select  A.Nobukti, P.Tanggal,P.KODECUST,C.NAMACUSTSUPP,P.NoPesanan,P.TGLJATUHTEMPO,P.TglKirim,
        sum(isnull(A.Qnt,0)) Qnt, sum(isnull(A.Qnt2,0)) Qnt2, sum(isnull(A.QntSPP,0))QntSpp, 
        sum(isnull(A.Qnt2SPP,0)) Qnt2Spp, sum(isnull(A.QntSisa,0)) QntSisa,  sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
	From    vwBrowsOutSO_SPP A
	Left Outer Join DBSO P on P.NoBukti=A.NoBukti
	Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCust and S.Sales=P.KODESLS
	Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
	Left outer join DBCUSTSUPP C on p.KODECUST = C.KODECUSTSUPP
	where A.islengkap=0 
	Group By A.nobukti,p.TANGGAL,P.KODECUST,C.NAMACUSTSUPP,P.NoPesanan,P.TGLJATUHTEMPO,P.TglKirim 
	order by A.NoBukti,p.TANGGAL,P.KODECUST,C.NAMACUSTSUPP 
end 
else if @Choice='B'
begin
	Select  A.KodeBrg,B.NAMABRG, P.Tanggal, 
        sum(isnull(A.Qnt,0)) Qnt, sum(isnull(A.Qnt2,0)) Qnt2, sum(isnull(A.QntSPP,0))QntSpp, 
        sum(isnull(A.Qnt2SPP,0)) Qnt2Spp, sum(isnull(A.QntSisa,0)) QntSisa,  sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
	From    vwBrowsOutSO_SPP A
	Left Outer Join DBSO P on P.NoBukti=A.NoBukti
	Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCust and S.Sales=P.KODESLS
	Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
	where A.islengkap=0 
	Group by A.KodeBrg,B.NAMABRG,P.TANGGAL
	order by A.KodeBrg,B.NAMABRG,P.TANGGAL
end
else if @Choice='C'
begin
	Select  p.KODECUST,C.NAMACUSTSUPP, P.Tanggal,
        sum(isnull(A.Qnt,0)) Qnt, sum(isnull(A.Qnt2,0)) Qnt2, sum(isnull(A.QntSPP,0))QntSpp, 
        sum(isnull(A.Qnt2SPP,0)) Qnt2Spp, sum(isnull(A.QntSisa,0)) QntSisa,  sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
	From    vwBrowsOutSO_SPP A
	Left Outer Join DBSO P on P.NoBukti=A.NoBukti
	Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCust and S.Sales=P.KODESLS
	Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
	Left Outer join DBCUSTSUPP C on p.KODECUST = C.KODECUSTSUPP
	where A.islengkap=0 
	Group by  p.KODECUST,C.NAMACUSTSUPP, P.Tanggal
	order by  p.KODECUST,C.NAMACUSTSUPP, P.Tanggal
end




GO

-- Procedure: Sp_ReportOUtSPBDet
-- Created: 2013-05-13 12:11:46.630 | Modified: 2015-03-11 09:53:51.773
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportOUtSPBDet] 
--declare
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@xx integer=1,
@IdUser Varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='F',@Ordr='N', @tgl1='01/01/2011',@tgl2='01/01/2015',@isiList='%%',@IdUser='SA',@Tipe='3033101' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwreportOutSPB where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwreportOutSPB where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwreportOutSPB where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 
End
else
begin
    If @Ordr='N'
		begin
		  select * from VwreportOutSPB where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@Tipe)
		  order by NoBukti,Tanggal
		end
	else If @Ordr='B'
		begin
		  select * from VwreportOutSPB where Tanggal between @tgl1 and @tgl2 
		  and KOdebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwreportOutSPB where Tanggal between @tgl1 and @tgl2 
		  and kodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end 
End



--lpo acc --gl--buku tambahan--perkiraan 40200 select * from Dbcustomize  SLX/SJ/00003/1114
--perode=2 =sje/bmm-spb/0215/0028 kok select ID from Dbcustomize Where Iduser='SA' and Tipe='3033101'

GO

-- Procedure: Sp_ReportOUtSPBRek
-- Created: 2013-05-13 12:11:46.620 | Modified: 2013-05-13 12:11:46.620
-- =====================================================

Create Procedure [dbo].[Sp_ReportOUtSPBRek] 
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
	 Select A.NoBukti,C.Tanggal,C.KodeCustSupp,D.NAMACUSTSUPP,
	 Sum(isnull(A.QNT,0))QNT,SUM(Isnull(A.QNT2,0)) Qnt2,
	 Sum(ISNULL(A.NetW,0)) NetW,SUM(Isnull(GrossW,0)) Grossw
	 from dbSPBDet A
     left outer join DBBARANG B on B.KODEBRG=A.Kodebrg
     Left Outer join dbSPB C on A.NoBukti = C.NoBukti
     Left Outer join DBCUSTSUPP D on c.KodeCustSupp = D.KODECUSTSUPP
     Group By A.NoBukti,C.Tanggal,C.KodeCustSupp,D.NAMACUSTSUPP
     order BY A.NoBukti,C.Tanggal
end     
If @Choice='B'
Begin
	 Select A.KodeBrg,B.NAMABRG,C.Tanggal,Sum(isnull(A.QNT,0))QNT,SUM(Isnull(A.QNT2,0)) Qnt2,
	 Sum(ISNULL(A.NetW,0)) NetW,SUM(Isnull(GrossW,0)) Grossw
	 from dbSPBDet A
     left outer join DBBARANG B on B.KODEBRG=A.Kodebrg
     Left Outer join dbSPB C on A.NoBukti = C.NoBukti
     Left Outer join DBCUSTSUPP D on c.KodeCustSupp = D.KODECUSTSUPP
     Group By A.KodeBrg,B.NAMABRG,C.Tanggal
     order BY A.KodeBrg,B.NAMABRG,C.Tanggal
end  
If @Choice='C'
Begin
	 Select C.KodeCustSupp,D.NAMACUSTSUPP,C.Tanggal,Sum(isnull(A.QNT,0))QNT,SUM(Isnull(A.QNT2,0)) Qnt2,
	 Sum(ISNULL(A.NetW,0)) NetW,SUM(Isnull(GrossW,0)) Grossw
	 from dbSPBDet A
     left outer join DBBARANG B on B.KODEBRG=A.Kodebrg
     Left Outer join dbSPB C on A.NoBukti = C.NoBukti
     Left Outer join DBCUSTSUPP D on c.KodeCustSupp = D.KODECUSTSUPP
     Group By C.KodeCustSupp,D.NAMACUSTSUPP,C.Tanggal
     order BY C.KodeCustSupp,D.NAMACUSTSUPP,C.Tanggal
end       
         



GO

-- Procedure: Sp_ReportOutSpk
-- Created: 2013-05-13 12:11:46.690 | Modified: 2013-05-13 12:11:46.690
-- =====================================================


Create Procedure [dbo].[Sp_ReportOutSpk]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwreportOUtSPK where Tanggal between @tgl1 and @tgl2 order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		  select * from VwreportOUtSPK where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
End

GO

-- Procedure: Sp_ReportOutSPPdet
-- Created: 2013-05-13 12:11:46.673 | Modified: 2015-03-11 09:53:51.837
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportOutSPPdet] 
--declare
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@xx int=1,
@IdUser Varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='F',@Ordr='N', @tgl1='01/01/2011',@tgl2='01/01/2015',@isiList='%%',@IdUser='SA',@Tipe='3032101' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportOutSPP where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportOutSPP where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportOutSPP where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
else
begin
	If @Ordr='N'
		begin
		  select * from VwReportOutSPP where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportOutSPP where Tanggal between @tgl1 and @tgl2 
		  and kodebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportOutSPP where Tanggal between @tgl1 and @tgl2 
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end 
End


GO

-- Procedure: Sp_ReportOutSppRek
-- Created: 2013-05-13 12:11:46.647 | Modified: 2013-05-13 12:11:46.647
-- =====================================================

Create Procedure [dbo].[Sp_ReportOutSppRek] 
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
		Select   A.Nobukti, P.Tanggal,P.KodeCustSupp,x.NAMACUSTSUPP,P.TglKirim,
        Case when A.NoSat=1 then sum(isnull(A.Qnt,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2,0))
             else 0
        end Qnt, sum(isnull(A.Qnt2,0)) Qnt2,
        Case when A.NoSat=1 then sum(isnull(A.QntSPB,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2SPB,0))
             else 0
        end QntSPB,sum(isnull(A.Qnt2SPB,0)) Qnt2SPB,
        Case when A.NoSat=1 then sum(isnull(A.QntSisa,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2Sisa,0))
             else 0
        end QntSisa, sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
		From    vwBrowsOutSPP A
		Left Outer Join dbSPP P on P.NoBukti=A.NoBukti
		left Outer join DBSO SO on SO.NOBUKTI=A.noso
		Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCustSupp and s.Sales=SO.KODESLS
		Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
		Left Outer Join DBCUSTSUPP x on So.KODECUST=x.KODECUSTSUPP
		where A.isclose=0 
		Group by A.Nobukti, P.Tanggal,A.NoSat,P.KodeCustSupp,x.NAMACUSTSUPP,P.TglKirim
		Order By A.Nobukti, P.Tanggal
End
else If @Choice='B'
begin
		Select   A.KodeBrg,B.NAMABRG, P.Tanggal,
        Case when A.NoSat=1 then sum(isnull(A.Qnt,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2,0))
             else 0
        end Qnt, sum(isnull(A.Qnt2,0)) Qnt2,
        Case when A.NoSat=1 then sum(isnull(A.QntSPB,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2SPB,0))
             else 0
        end QntSPB,sum(isnull(A.Qnt2SPB,0)) Qnt2SPB,
        Case when A.NoSat=1 then sum(isnull(A.QntSisa,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2Sisa,0))
             else 0
        end QntSisa, sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
		From    vwBrowsOutSPP A
		Left Outer Join dbSPP P on P.NoBukti=A.NoBukti
		left Outer join DBSO SO on SO.NOBUKTI=A.noso
		Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCustSupp and s.Sales=SO.KODESLS
		Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
		where A.isclose=0 
		Group by  A.KodeBrg,B.NAMABRG, P.Tanggal,A.NoSat
		Order By  A.KodeBrg,B.NAMABRG, P.Tanggal
End
else If @Choice='C'
begin
		Select  P.KodeCustSupp,S.namaCust NamaCustSupp, P.Tanggal,
        Case when A.NoSat=1 then sum(isnull(A.Qnt,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2,0))
             else 0
        end Qnt, sum(isnull(A.Qnt2,0)) Qnt2,
        Case when A.NoSat=1 then sum(isnull(A.QntSPB,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2SPB,0))
             else 0
        end QntSPB,sum(isnull(A.Qnt2SPB,0)) Qnt2SPB,
        Case when A.NoSat=1 then sum(isnull(A.QntSisa,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2Sisa,0))
             else 0
        end QntSisa, sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
		From    vwBrowsOutSPP A
		Left Outer Join dbSPP P on P.NoBukti=A.NoBukti
		left Outer join DBSO SO on SO.NOBUKTI=A.noso
		Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCustSupp and s.Sales=SO.KODESLS
		Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
		where A.isclose=0 
		Group by  P.KodeCustSupp,S.namaCust, P.Tanggal,A.NoSat
		Order By  P.KodeCustSupp,S.namaCust, P.Tanggal
End


GO

-- Procedure: Sp_reportOutStandingBPPBRek
-- Created: 2013-01-21 13:26:41.700 | Modified: 2013-01-21 13:26:41.700
-- =====================================================


Create Procedure [dbo].[Sp_reportOutStandingBPPBRek]
@Choice varchar(1),
@Tgl1 Datetime,
@tgl2 Datetime
as 

--Declare @Choice varchar (1),@tgl1 datetime,@tgl2 DateTime
--Select @Choice='N',@tgl1='10/10/2010',@tgl2='10/10/2013'  

if @Choice='N'
begin
	Select a.NoBukti,Tanggal,Sum(Isnull(Qnt,0)) Qnt,Sum(Isnull(Qnt2,0)) Qnt2
	From dbBPPB a Left Outer Join dbBPPBDet b On a.NoBukti=b.NoBukti
	left Outer Join dbBarang c On c.KodeBrg=b.KodeBrg
	where Qnt<>Qnt2 and TANGGAL between @tgl1 and @tgl2
	Group By a.NoBukti,Tanggal
	order By a.NoBukti,Tanggal
end
if @Choice='B'
begin
	Select b.KodeBrg,c.NamaBrg,Sum(Isnull(Qnt,0)) Qnt,Sum(Isnull(Qnt2,0)) Qnt2
	From dbBPPB a Left Outer Join dbBPPBDet b On a.NoBukti=b.NoBukti
	left Outer Join dbBarang c On c.KodeBrg=b.KodeBrg
	where Qnt<>Qnt2 and TANGGAL between @tgl1 and @tgl2
	Group By b.KodeBrg,c.NamaBrg
	order By b.KodeBrg,c.NamaBrg
end
GO

-- Procedure: Sp_reportoutStandingPOdet
-- Created: 2013-01-18 14:20:17.943 | Modified: 2013-01-18 14:20:17.943
-- =====================================================
Create Procedure Sp_reportoutStandingPOdet
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportOutStandingPO where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportOutStandingPO where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select * from VwReportOutStandingPO where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
GO

-- Procedure: Sp_ReportOutStandingPORek
-- Created: 2013-01-12 09:52:11.947 | Modified: 2013-01-12 09:52:11.947
-- =====================================================
Create Procedure [dbo].[Sp_ReportOutStandingPORek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
	Select 	A.NoBukti,I.TANGGAL,I.KODESUPP KOdeCustSupp,J.NAMACUSTSUPP,SUM(Isnull(A.QntPO,0)) QntPO,
	SUM(Isnull(A.QNTOS,0)) QNTOS,SUM(Isnull(A.QntBeliSat1,0)) QNTBeliSat1
	From vwOutstandingPO A
	Left Outer Join dbBarang H on H.KodeBrg=A.KodeBrg
	Left Outer Join DBPO I on A.NoBukti = I.NOBUKTI
	left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP
	where I.TANGGAL between @Tgl1 and @tgl2
	Group BY A.NoBukti,I.TANGGAL,I.KODESUPP,J.NAMACUSTSUPP
	Order By A.NoBukti,I.TANGGAL
End
else IF @Choice='S'
begin
	Select 	I.TANGGAL,I.KODESUPP KOdeCustSupp,J.NAMACUSTSUPP,SUM(Isnull(A.QntPO,0)) QntPO,
	SUM(Isnull(A.QNTOS,0)) QNTOS,SUM(Isnull(A.QntBeliSat1,0)) QNTBeliSat1
	From vwOutstandingPO A
	Left Outer Join dbBarang H on H.KodeBrg=A.KodeBrg
	Left Outer Join DBPO I on A.NoBukti = I.NOBUKTI
	left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP
	where I.TANGGAL between @Tgl1 and @tgl2
	Group BY I.TANGGAL,I.KODESUPP,J.NAMACUSTSUPP
	Order By I.KODESUPP,I.TANGGAL
end
else IF @Choice='B'
begin
	Select 	A.KodeBrg,H.NAMABRG,I.TANGGAL,SUM(Isnull(A.QntPO,0)) QntPO,
	SUM(Isnull(A.QNTOS,0)) QNTOS,SUM(Isnull(A.QntBeliSat1,0)) QNTBeliSat1
	From vwOutstandingPO A
	Left Outer Join dbBarang H on H.KodeBrg=A.KodeBrg
	Left Outer Join DBPO I on A.NoBukti = I.NOBUKTI
	left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP
	where I.TANGGAL between @Tgl1 and @tgl2
	Group BY A.KodeBrg,H.NAMABRG,I.TANGGAL
	Order By A.KodeBrg,H.NAMABRG,I.TANGGAL
end
GO

-- Procedure: Sp_reportoutStandingPR
-- Created: 2013-05-13 12:11:46.963 | Modified: 2015-03-11 09:53:51.663
-- =====================================================



CREATE Procedure [dbo].[Sp_reportoutStandingPR]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@x int=1,
@IDuser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from [vwOutPPL] order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from [vwOutPPL] order by KodeBrg
		end 
End
else
begin
If @Ordr='N'
		begin
		  select * from [vwOutPPL] 
		  where NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from [vwOutPPL] 
		  where Kodebrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end 
End



GO

-- Procedure: Sp_ReportOutStandingSoDet
-- Created: 2013-01-30 10:33:44.543 | Modified: 2015-03-11 09:53:51.920
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportOutStandingSoDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@xx int=0,
@Iduser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportOutStandingSO where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportOutStandingSO where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportOutStandingSO where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 
End
else
begin
   If @Ordr='N'
		begin
		  select * from VwReportOutStandingSO where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportOutStandingSO where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportOutStandingSO where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end 
End

GO

-- Procedure: Sp_reportOutStandingSORek
-- Created: 2013-01-12 09:52:35.337 | Modified: 2013-01-12 09:52:35.337
-- =====================================================

Create  Procedure [dbo].[Sp_reportOutStandingSORek]
@Choice varchar(1),
@Tgl1 datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@tgl1 Datetime,@Tgl2 DateTime
--select @Choice='n',@Tgl1='10/10/2011',@tgl2='01/29/2013'

IF @Choice='N'
begin 
	select  NoBukti,Tanggal, Sum(Isnull(QNT,0))Qnt, Sum(Isnull(QNT2,0)) Qnt2, Sum(Isnull(QntSJ,0))QntSj, 
	Sum(Isnull(Qnt2SJ,0)) Qnt2SJ, Sum(Isnull(QNT,0))-Sum(ISnull(QntSJ,0)) QntSisa, 
	Sum(Isnull(QNT2,0))-Sum(Isnull(QNT2SJ,0)) Qnt2Sisa
	from    vwSOBelumSuratJlnDet
	Where Tanggal between @tgl1 and @tgl2
	Group By NoBukti,tanggal
	Order By NoBukti,tanggal
End
else if @Choice ='S'
begin
	select  B.KOdeCust,C.NamaCustSupp,A.Tanggal, Sum(Isnull(A.QNT,0))Qnt, Sum(Isnull(A.QNT2,0)) Qnt2, Sum(Isnull(A.QntSJ,0))QntSj, 
	Sum(Isnull(A.Qnt2SJ,0)) Qnt2SJ, Sum(Isnull(A.QNT,0))-Sum(ISnull(A.QntSJ,0)) QntSisa, 
	Sum(Isnull(A.QNT2,0))-Sum(Isnull(A.QNT2SJ,0)) Qnt2Sisa
	from    vwSOBelumSuratJlnDet A 
	left outer join DbSO B on A.nobukti = B.nobukti
	Left Outer join DBCustSupp C on B.KodeCust=C.kodeCustSupp
	Where A.Tanggal between @tgl1 and @tgl2
	Group By  B.KOdeCust,C.NamaCustSupp,A.Tanggal
	Order By  B.KOdeCust,C.NamaCustSupp,A.Tanggal
end
else if @Choice='B'
begin
	select  A.kodebrg,A.NamaBrg,A.tanggal, Sum(Isnull(A.QNT,0))Qnt, Sum(Isnull(A.QNT2,0)) Qnt2, Sum(Isnull(A.QntSJ,0))QntSj, 
	Sum(Isnull(A.Qnt2SJ,0)) Qnt2SJ, Sum(Isnull(A.QNT,0))-Sum(ISnull(A.QntSJ,0)) QntSisa, 
	Sum(Isnull(A.QNT2,0))-Sum(Isnull(A.QNT2SJ,0)) Qnt2Sisa
	from    vwSOBelumSuratJlnDet A
	Where A.Tanggal between @tgl1 and @tgl2
	Group By  A.kodebrg,A.NamaBrg,A.tanggal
	Order By  A.kodebrg,A.NamaBrg,A.tanggal
End
--select * from dbSo
--select * from vwSatuanbrg
--Select * From vwSOBelumSuratJlnDet

GO

-- Procedure: SP_ReportOutStandingSPk
-- Created: 2013-01-07 10:13:03.940 | Modified: 2013-01-07 10:13:03.940
-- =====================================================

create procedure [dbo].[SP_ReportOutStandingSPk]
@Bulan integer,@tahun integer
as
select d.Sat1,a.Kodebrg,d.NAMABRG,Isnull(c.Qnt,0)Stok,Isnull(c.Qnt2,0)Stok2,Isnull(SUM(a.QNT*isi),0)QntBPPB,Isnull(b.Qnt,0)QntBP,Isnull(b.Qnt2,0)Qnt2BP,Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0)Sisa,isnull(e.Sisa,0)OSPPL,Isnull(f.sisa,0)OSPO,
(Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0))-Isnull(e.Sisa,0)-Isnull(f.sisa,0)- Isnull(c.Qnt,0)Xsisa from DBSPKDET a 
left Outer Join (select Kodebrg,SUM(Qnt)Qnt,SUM(Qnt2)Qnt2 from DBPenyerahanBhnDET group by kodebrg)b On b.kodebrg=a.KodeBrg 
left Outer Join (select Kodebrg,SUM(SALDOQNT)Qnt,SUM(SALDO2QNT)Qnt2 from DBSTOCKBRG where Bulan=@Bulan and Tahun=@Tahun group by kodebrg)c On c.kodebrg=a.KodeBrg
Left Outer join (select a.kodebrg,SUM(a.Qnt*isi)QntPPL,Isnull(b.Qnt,0) QntPO,SUM(a.Qnt*isi)-Isnull(b.Qnt,0)sisa from DBPPLDET a
                 Left Outer Join (select Kodebrg,SUM(Qnt*isi)Qnt from DBPODET group by Kodebrg)b On  a.kodebrg=b.KODEBRG
                 group by a.kodebrg,b.Qnt
                 having SUM(a.Qnt*isi)-Isnull(b.Qnt,0)<>0)e on e.KODEBRG=a.KODEBRG
Left Outer Join (select a.kodebrg,sum(a.Qnt*a.isi)QntPO,Isnull((b.Qnt),0)QntBeli,Sum(a.Qnt*isi)-(isnull((b.Qnt),0))as sisa from DBPODET a
                 left Outer Join (select Kodebrg,Isnull(Sum(Qnt),0)Qnt from DBBELIDET Group by KODEBRG)b On a.KODEBRG=b.KODEBRG
                 group by a.KodeBrg,b.Qnt
                 having SUM(a.Qnt*a.ISI)-(isnull((b.Qnt),0))<>0)f On f.KODEBRG=a.KODEBRG                 
Left Outer Join DBBARANG d On a.KODEBRG=d.kodebrg 
group by a.KodeBrg,b.Qnt,b.Qnt2,c.Qnt,c.Qnt2,d.NAMABRG,e.Sisa,f.sisa,d.Sat1
having (Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0))-Isnull(e.Sisa,0)-Isnull(f.sisa,0)-Isnull(c.Qnt,0) >0
GO

-- Procedure: Sp_reportOutStandingSPKRek
-- Created: 2013-01-12 09:52:59.853 | Modified: 2013-01-12 09:52:59.853
-- =====================================================
Create Procedure [dbo].[Sp_reportOutStandingSPKRek]
@Choice varchar(1),
@Bulan integer,
@Tahun Integer
as
--Declare @Choice varchar(1),@Bulan Int,@Tahun Int
--Select @Choice='B',@Bulan=1,@Tahun=2012

If @Choice='N'
begin
	select a.NOBUKTI BPPB,Sum(Isnull(c.Qnt,0))Stok,Isnull(SUM(a.QNT*isi),0)QntBPPB,Sum(Isnull(b.Qnt,0))QntBP,
	Isnull(b.Qnt,0)QntBP,Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0)Sisa,Isnull(c.Qnt,0)-(Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0))Xsisa 
	from DBSPKDET a 
	left Outer Join (select Kodebrg,SUM(Qnt*isi)Qnt from DBPenyerahanBhnDET group by kodebrg)b On b.kodebrg=a.KodeBrg 
	left Outer Join (select Kodebrg,SUM(SALDOQNT)Qnt from DBSTOCKBRG where Bulan=@Bulan and Tahun=@Tahun group by kodebrg )c On c.kodebrg=a.KodeBrg
	Left Outer Join DBBARANG d On a.KODEBRG=d.kodebrg   
	group by a.NOBUKTI,B.Qnt,C.Qnt--,a.KodeBrg,b.Qnt,c.Qnt,d.NAMABRG
	having Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0)<>0
        order by nobukti
End

If @Choice='B'
Begin
select a.Kodebrg ,D.namaBrg,Sum(Isnull(c.Qnt,0))Stok,Isnull(SUM(a.QNT*isi),0)QntBPPB,Sum(Isnull(b.Qnt,0))QntBP,
	Isnull(b.Qnt,0)QntBP,Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0)Sisa,Isnull(c.Qnt,0)-(Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0))Xsisa 
	from DBSPKDET a 
	left Outer Join (select Kodebrg,SUM(Qnt*isi)Qnt from DBPenyerahanBhnDET group by kodebrg)b On b.kodebrg=a.KodeBrg 
	left Outer Join (select Kodebrg,SUM(SALDOQNT)Qnt from DBSTOCKBRG where Bulan=@Bulan and Tahun=@Tahun group by kodebrg )c On c.kodebrg=a.KodeBrg
	Left Outer Join DBBARANG d On a.KODEBRG=d.kodebrg   
	group by a.Kodebrg,D.namaBrg,B.Qnt,C.Qnt--,a.KodeBrg,b.Qnt,c.Qnt,d.NAMABRG
	having Isnull(SUM(a.QNT*isi),0)-Isnull(b.Qnt,0)<>0
        order by A.Kodebrg,D.NamaBrg
end
GO

-- Procedure: Sp_ReportPelunasanHutang
-- Created: 2011-03-17 11:34:32.147 | Modified: 2011-05-25 09:12:14.010
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_ReportPelunasanHutang]
@tanggal1 datetime,
@tanggal2 datetime,
@awal varchar(15),
@akhir varchar(15),
@devisi varchar(10),
@tipe int,
@perkiraan varchar(20),
@KodeVls varchar(15)
AS
if @tipe=0 
begin
 Select S.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,S.kota,H.Tanggal,h.nofaktur,h.debet, h.debetd, h.catatan,h.nobukti,'' bank, '' nogiro, cast(null as datetime) tglgiro
 from DBCUSTSUPP S
 left outer join vwHutpiut H
        on (S.KODECUSTSUPP=H.KODECUSTSUPP and (H.Tanggal>=@tanggal1 and h.tanggal<=@tanggal2) )
 where s.KODECUSTSUPP>=@awal and s.KODECUSTSUPP<=@akhir and h.debet <> 0 and s.perkiraan=@perkiraan
--	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 order by s.KODECUSTSUPP,h.tanggal,h.nofaktur
end
else
begin
 Select S.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,S.kota,H.Tanggal,h.nofaktur,h.debet, h.debetd, h.catatan,h.nobukti, '' bank, '' nogiro, cast(null as datetime) tglgiro
 from DBCUSTSUPP S
 left outer join vwHutpiut H
        on (S.KODECUSTSUPP=H.KODECUSTSUPP and (H.Tanggal>=@tanggal1 and h.tanggal<=@tanggal2) )
 where s.KODECUSTSUPP>=@awal and s.KODECUSTSUPP<=@akhir and h.debet <> 0 and s.perkiraan=@perkiraan
--	and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 order by s.KODECUSTSUPP,right(h.nofaktur,4),right(h.nofaktur,7),nofaktur,h.tanggal
end




GO

-- Procedure: sp_ReportPelunasanPiutang
-- Created: 2012-05-02 14:30:26.233 | Modified: 2012-05-02 14:30:26.233
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportPelunasanPiutang]
@tanggal1 datetime,
@tanggal2 datetime,
@awal varchar(15),
@akhir varchar(15),
@devisi varchar(10),
@tipe int,
@perkiraan varchar(20),
@KodeVls varchar(15)
AS
if @tipe=0 
begin
	Select S.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,S.kota,H.Tanggal,h.nofaktur,h.Kredit debet, h.KreditD debetd, h.catatan,h.nobukti,'' bank, '' nogiro, cast(null as datetime) tglgiro
	from DBCUSTSUPP S
	left outer join vwHutpiut H
        on (S.KODECUSTSUPP=H.KODECUSTSUPP and (H.Tanggal>=@tanggal1 and h.tanggal<=@tanggal2) )
	where s.KODECUSTSUPP>=@awal and s.KODECUSTSUPP<=@akhir and (h.Kredit<>0 or H.KreditD<>0) and H.perkiraan=@perkiraan
	--and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 order by s.KODECUSTSUPP,h.tanggal,h.nofaktur
end
else
begin
 Select S.KODECUSTSUPP as kode,S.NAMACUSTSUPP as nama,S.kota,H.Tanggal,h.nofaktur,h.Kredit debet, h.KreditD debetd, h.catatan,h.nobukti, '' bank, '' nogiro, cast(null as datetime) tglgiro
 from DBCUSTSUPP S
 left outer join vwHutpiut H
        on (S.KODECUSTSUPP=H.KODECUSTSUPP and (H.Tanggal>=@tanggal1 and H.tanggal<=@tanggal2) )
 where s.KODECUSTSUPP>=@awal and s.KODECUSTSUPP<=@akhir and (h.Kredit<>0 or H.KreditD<>0) and H.perkiraan=@perkiraan
	--and ((H.Valas=@KodeVls and @KodeVls<>'IDR') or (H.Valas like '%' and @KodeVls='IDR'))
 order by s.KODECUSTSUPP,right(h.nofaktur,4),right(h.nofaktur,7),nofaktur,h.tanggal
end







GO

-- Procedure: Sp_reportPenerimaanAccDet
-- Created: 2013-01-18 14:24:56.790 | Modified: 2015-03-09 15:32:12.963
-- =====================================================

CREATE Procedure [dbo].[Sp_reportPenerimaanAccDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Int,
@Iduser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		   if @NeedOto=0 or @NeedOto=1	
			select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
			order by NoBukti
		  else if @NeedOto=2	
			select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2
			order by Nobukti
		end 
	else If @Ordr='B'
		begin
		  if @NeedOto=0 or @NeedOto=1	
			select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
			order by KodeBrg
		  else if @NeedOto=2	
			select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2
			order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  if @NeedOto=0 or @NeedOto=1	
			select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
			order by KodeCustSupp
		  else if @NeedOto=2	
			select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2
			order by KodeCustSupp
		end 		
End
else
begin
If @Ordr='N'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
		  order by NoBukti,Tanggal
		else if @NeedOto=2
		 select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 
		 and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  if @NeedOto=0 or @NeedOto=1
		  select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
		  order by KodeBrg,NamaBrg
		else if @NeedOto=2
		 select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 
		 and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg,NamaBrg
		end 
	else If @Ordr='S'
		begin
		  if @NeedOto=0 or @NeedOto=1
		  select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
		  order by KodeCustSupp,NAMACUSTSUPP
		else if @NeedOto=2
		 select * from VwReportPenerimaanACC where Tanggal between @tgl1 and @tgl2 
		 and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp,NAMACUSTSUPP
		end 
End

GO

-- Procedure: Sp_ReportPenerimaanACCRek
-- Created: 2013-01-12 09:53:27.303 | Modified: 2013-01-18 11:44:46.427
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportPenerimaanACCRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime

as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
	Select 	I.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP,I.KODEVLS,i.KURS,
        I.nilaipot*i.kurs disctot,I.nilaiDPP*i.kurs NDPP,I.nilaiPPN*I.kurs NPPN,I.NilaiNet*I.kurs TotalIDR,
    case when i.kurs=1 then 0 else i.nilaipot end as disctotusd,
    case when i.kurs=1 then 0 else i.nilaidpp end as Ndppusd,
    case when i.kurs=1 then 0 else i.nilaippn end as NPPNusd,
    case when i.kurs=1 then 0 else i.nilainet end as totalusd
    From  dbBeli I 
	Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
	Where I.TANGGAL between @tgl1 and @tgl2
	order by  I.NOBUKTI,I.TANGGAL
End
else if @Choice='S'
begin
	Select 	I.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP,i.KODEVLS,i.KURS,
        I.nilaipot*i.kurs disctot,I.nilaiDPP*i.kurs NDPP,I.nilaiPPN*I.kurs NPPN,I.NilaiNet*I.kurs TotalIDR,
        case when i.kurs=1 then 0 else i.nilaipot end as disctotusd,
        case when i.kurs=1 then 0 else i.nilaidpp end as Ndppusd,
        case when i.kurs=1 then 0 else i.nilaippn end as NPPNusd,
        case when i.kurs=1 then 0 else i.nilainet end as totalusd
    From  DBBELI I 
	Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
	where I.TANGGAL between @tgl1 and @tgl2
	order by  J.NAMACUSTSUPP,i.kodesupp,I.NOBUKTI
end
else if @Choice='B'
begin
	Select 	B.KodeBrg, H.NamaBrg,sum(B.QntTerima*B.isi) qnt,
        sum((B.NDISKON+B.DISCTOT)*i.kurs) Disctotal,
        sum((B.NDPP+B.NPPN)*i.kurs) TotalIDR, 
        sum(B.NDPP*i.kurs) NDPP,
        sum(B.NPPN*i.kurs) NPPN, 
        case when i.kurs=1 then 0 else sum(b.disctot) end as disctotusd,
        case when i.kurs=1 then 0 else sum(b.ndpp) end as Ndppusd,
        case when i.kurs=1 then 0 else sum(b.nppn) end as NPPNusd,
        case when i.kurs=1 then 0 else sum(b.subtotal) end as totalusd,
        I.kurs,I.KODEVLS
        From  DBBELIDET B 
        Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBBELI I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by  B.KodeBrg, H.NamaBrg,i.kurs,i.KODEVLS
		order by B.KodeBrg, H.NamaBrg
end

GO

-- Procedure: Sp_ReportPenjelasanLR
-- Created: 2015-10-30 02:24:33.490 | Modified: 2015-10-30 02:24:33.490
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_ReportPenjelasanLR]

@Bulan int,@tahun int,@devisi varchar(10)

AS

Set @devisi= Case when @devisi in ('-','') then '%' else @devisi end

select * from (
select Bulan,Tahun,Devisi,Perkiraan,Nomor,
case when Nomor='02.99' then 'Jumlah Pendapatan Perdagangan Dan Jasa' 
     when nomor ='04.17' then 'Persediaan awal Barang Jadi'
     when Nomor='05.99' then 'Jumlah Beban Langsung Perdagangan Dan Jasa'
     when Nomor='07.00' then 'BEBAN PEMASARAN DAN PENJUALAN'
     when Nomor='07.99' then 'Jumlah Beban Pemasaran Dan Penjualan'
     when Nomor='08.99' then 'Jumlah Biaya Non Operasional'
     when Nomor='10.99' then 'Jumlah Pendapatan (Beban) Lain-Lain'
     else Keterangan end Keterangan ,Grup,
TotalA,TotalB,TotalC,TotalD from DBLRHPP where IsLRHPP=0 and ((TotalA<>0) or (TotalB<>0) or (TotalC<>0) or (TotalD<>0))
union all
select @bulan,@tahun,@devisi,'','01.001','PENJUALAN','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','01.991','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','02.00','PENDAPATAN PERDAGANGAN DAN JASA','',
0,0,0,0 
union all
select @bulan,@tahun,@devisi,'','02.991','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','02.992','BEBAN POKOK PENJUALAN KOMPOS','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','02.993','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','02.993','Pemakaian Bahan Baku Dan Bahan Pembantu','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.031','Jumlah Pemakaian bahan Baku & Bahan Pembantu','',
SUM(ISNULL(TotalA,0)),SUM(ISNULL(TotalB,0)),SUM(ISNULL(TotalC,0)),SUM(ISNULL(TotalD,0)) 
from DBLRHPP where Bulan=@bulan and Tahun=@tahun and Perkiraan in ('500.01','500.02','500.03')
union all
select @bulan,@tahun,@devisi,'','04.032','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.033','Beban Tenaga Kerja Langsung
','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.081','Jumlah Beban Tenaga Kerja Langsung','',
SUM(ISNULL(TotalA,0)),SUM(ISNULL(TotalB,0)),SUM(ISNULL(TotalC,0)),SUM(ISNULL(TotalD,0)) 
from DBLRHPP where Bulan=@bulan and Tahun=@tahun and Perkiraan in ('501.03','501.04','501.05','501.06','501.07')
union all
select @bulan,@tahun,@devisi,'','04.082','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.083','Beban Overhead Pabrik','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.161','Jumlah Beban Overhead Pabrik','',
SUM(ISNULL(TotalA,0)),SUM(ISNULL(TotalB,0)),SUM(ISNULL(TotalC,0)),SUM(ISNULL(TotalD,0)) 
from DBLRHPP where Bulan=@bulan and Tahun=@tahun and Perkiraan in ('502.01','502.02','502.03','502.04','502.05','502.06','502.07','502.09')
union all
select @bulan,@tahun,@devisi,'','04.162','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.163','Beban Pokok Produksi','',
SUM(ISNULL(TotalA,0)),SUM(ISNULL(TotalB,0)),SUM(ISNULL(TotalC,0)),SUM(ISNULL(TotalD,0)) 
from DBLRHPP where Bulan=@bulan and Tahun=@tahun and 
Perkiraan in ('502.01','502.02','502.03','502.04','502.05','502.06','502.07','502.09','501.03','501.04','501.05','501.06','501.07','500.01','500.02','500.03')
union all
select @bulan,@tahun,@devisi,'','04.171','Barang Tersedia Untuk Dijual','',
SUM(ISNULL(TotalA,0)),SUM(ISNULL(TotalB,0)),SUM(ISNULL(TotalC,0)),SUM(ISNULL(TotalD,0)) 
from DBLRHPP where Bulan=@bulan and Tahun=@tahun and 
Perkiraan in ('500.04','502.01','502.02','502.03','502.04','502.05','502.06','502.07','502.09','501.03','501.04','501.05','501.06','501.07','500.01','500.02','500.03')
union all
select @bulan,@tahun,@devisi,'','04.172','Persediaan akhir Barang Jadi','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.173','Beban Pokok Penjualan Kompos','',
SUM(ISNULL(TotalA,0)),SUM(ISNULL(TotalB,0)),SUM(ISNULL(TotalC,0)),SUM(ISNULL(TotalD,0)) 
from DBLRHPP where Bulan=@bulan and Tahun=@tahun and 
Perkiraan in ('500.04','502.01','502.02','502.03','502.04','502.05','502.06','502.07','502.09','501.03','501.04','501.05','501.06','501.07','500.01','500.02','500.03')
union all
select @bulan,@tahun,@devisi,'','04.174','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','04.175','BEBAN LANGSUNG PERDAGANGAN DAN JASA','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','07.991','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','07.992','BEBAN ADMINISTRASI DAN UMUM','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','08.991','','',
0,0,0,0
union all
select @bulan,@tahun,@devisi,'','08.992','PENDAPATAN (BEBAN) LAIN-LAIN','',
0,0,0,0
) K 
where K.Bulan=@bulan and K.Tahun=@tahun  
and K.Nomor not in ('01.00','01.01','03.00','04.99','06.00','06.01','06.02','09.00','09.02','99.00') order by K.Nomor


GO

-- Procedure: Sp_reportpenyerahanbahanRek
-- Created: 2013-01-21 13:20:29.173 | Modified: 2013-01-21 13:20:29.173
-- =====================================================

Create Procedure [dbo].[Sp_reportpenyerahanbahanRek]
@Choice varchar(1),
@Tgl1 Datetime,
@tgl2 Datetime
as 
--Declare @Choice varchar (1),@tgl1 datetime,@tgl2 DateTime
--Select @Choice='B',@tgl1='10/10/2010',@tgl2='10/10/2013'  
if @Choice='N'
begin
	Select 	A.NoBukti,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
	From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	where A.TANGGAL between @tgl1 and @tgl2
	Group by A.NoBukti,A.TANGGAL,A.KodeGdg,A.KodeGdgT
end 
else if  @Choice='B'
begin
	Select B.KodeBrg, H.NamaBrg,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
	From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	where A.TANGGAL between @tgl1 and @tgl2
	Group by B.KodeBrg, H.NamaBrg,A.TANGGAL,A.KodeGdg,A.KodeGdgT
end
 
 

GO

-- Procedure: Sp_reportPermintaanBahan
-- Created: 2013-06-03 14:29:27.893 | Modified: 2013-06-03 14:29:27.893
-- =====================================================


CREATE Procedure [dbo].[Sp_reportPermintaanBahan]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		 If @NeedOto=0 Or @NeedOto=1
		  select * from VwreportPermintaanBahan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by NoBukti,TANGGAL
		 else If @NeedOto=2
		  select * from VwreportPermintaanBahan where Tanggal between @tgl1 and @tgl2
		  order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		 If @NeedOto=0 Or @NeedOto=1
		  select * from VwreportPermintaanBahan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeBrg
		 If @NeedOto=2
		  select * from VwreportPermintaanBahan where Tanggal between @tgl1 and @tgl2 
		  order by KodeBrg
		end 
	else If @Ordr='D'
		begin
		If @NeedOto=0 Or @NeedOto=1
		  select * from VwreportPermintaanBahan where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by kddep,NMDEP
		If @NeedOto=2
		  select * from VwreportPermintaanBahan where Tanggal between @tgl1 and @tgl2
		  order by kddep,NMDEP
		end 
End




GO

-- Procedure: Sp_reportPerMintaanBahanRek
-- Created: 2013-06-03 14:30:00.157 | Modified: 2013-06-03 14:30:00.157
-- =====================================================


CREATE Procedure [dbo].[Sp_reportPerMintaanBahanRek]
@Choice varchar(1),
@Tgl1 Datetime,
@tgl2 Datetime,
@NeedOto SmallInt
as 
--Declare @Choice varchar (1),@tgl1 datetime,@tgl2 DateTime
--Select @Choice='B',@tgl1='10/10/2010',@tgl2='10/10/2013'  
if @Choice='N'
begin
 If @NeedOto=0 or @NeedOto=1
	Select 	A.NoBukti,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
    From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	where A.TANGGAL between @tgl1 and @tgl2 and
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@NeedOto 
	Group by A.NoBukti,A.TANGGAL,A.KodeGdg,A.KodeGdgT
else If @NeedOto=2
	Select 	A.NoBukti,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
    From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	where A.TANGGAL between @tgl1 and @tgl2
	Group by A.NoBukti,A.TANGGAL,A.KodeGdg,A.KodeGdgT
end 
else if  @Choice='B'
begin
 If @NeedOto=0 Or @NeedOto=1
	Select B.KodeBrg, H.NamaBrg,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
	From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	where A.TANGGAL between @tgl1 and @tgl2
	and Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@NeedOto 
	Group by B.KodeBrg, H.NamaBrg,A.TANGGAL,A.KodeGdg,A.KodeGdgT
Else If @NeedOto=2
	Select B.KodeBrg, H.NamaBrg,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
	From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	where A.TANGGAL between @tgl1 and @tgl2
	Group by B.KodeBrg, H.NamaBrg,A.TANGGAL,A.KodeGdg,A.KodeGdgT
end
else if  @Choice='D'
begin
If @NeedOto=0 Or @NeedOto=1
	Select A.KDDEP, I.NMDEP,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
	From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Left Outer Join DBDEPART I on A.KDDEP = I.KDDEP
	where A.TANGGAL between @tgl1 and @tgl2 and
	 Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@NeedOto 
	Group by  A.KDDEP, I.NMDEP,A.TANGGAL,A.KodeGdg,A.KodeGdgT
Else If @NeedOto=2
	Select A.KDDEP, I.NMDEP,A.TANGGAL,A.KodeGdg,A.KodeGdgT,Sum(ISnull(B.Qnt,0)) Qnt,
	Sum(Isnull(B.Qnt2M,0)) Qnt2M ,Sum(Isnull(B.Qnt2P,0)) Qnt2P
	From dbBPPB A
	Left Outer join dbBPPBDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Left Outer Join DBDEPART I on A.KDDEP = I.KDDEP
	where A.TANGGAL between @tgl1 and @tgl2 
	Group by  A.KDDEP, I.NMDEP,A.TANGGAL,A.KodeGdg,A.KodeGdgT
end	
	

GO

-- Procedure: Sp_ReportPlInvoicedet
-- Created: 2013-01-30 16:08:51.850 | Modified: 2013-01-30 16:08:51.850
-- =====================================================
Create Procedure Sp_ReportPlInvoicedet
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwreportPLinvoice where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwreportPLinvoice where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwreportPLinvoice where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 
End



GO

-- Procedure: Sp_ReportPLInvoiceRek
-- Created: 2013-01-30 16:23:08.373 | Modified: 2013-02-01 13:58:15.387
-- =====================================================
CREATE Procedure [dbo].[Sp_ReportPLInvoiceRek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
		sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DiscP,0)) DiscP,sum(isnull(B.DiscRp,0)) DiscRp,sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
		Order by B.NoBukti,A.Tanggal
end
Else If @Choice='B'
Begin
		select 	B.KodeBrg,C.NAMABRG,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DiscP,0)) DiscP,sum(isnull(B.DiscRp,0)) DiscRp,sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		Group By B.KodeBrg,C.NAMABRG,A.Tanggal
		order By B.KodeBrg,C.NAMABRG,A.Tanggal
end
Else If @Choice='C'
Begin
		select 	A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DiscP,0)) DiscP,sum(isnull(B.DiscRp,0)) DiscRp,sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	dbInvoicePLDet B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		Group By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
		order By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
end
GO

-- Procedure: Sp_ReportPODet
-- Created: 2013-06-03 13:42:13.430 | Modified: 2015-03-11 09:53:51.647
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportPODet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint,
@IDuser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
		      select * from VwreportPO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		      order by NoBukti,Tanggal
		   if @NeedOto=2
			  select * from VwreportPO where Tanggal between @tgl1 and @tgl2 
		      order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  if @NeedOto=0 or @NeedOto=1
			  select * from VwreportPO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			  order by KodeBrg
		  if @NeedOto=2
			  select * from VwreportPO where Tanggal between @tgl1 and @tgl2 
			  order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  if @NeedOto=0 or @NeedOto=1
			 select * from VwreportPO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			 order by KodeCustSupp
		  if @NeedOto=2
			 select * from VwreportPO where Tanggal between @tgl1 and @tgl2 
			 order by KodeCustSupp
		end 		
End
else
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
		      select * from VwreportPO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		      and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		      order by NoBukti,Tanggal
		   if @NeedOto=2
			  select * from VwreportPO where Tanggal between @tgl1 and @tgl2 
			  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		      order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  if @NeedOto=0 or @NeedOto=1
			  select * from VwreportPO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			  order by KodeBrg
		  if @NeedOto=2
			  select * from VwreportPO where Tanggal between @tgl1 and @tgl2 
			  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			  order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  if @NeedOto=0 or @NeedOto=1
			 select * from VwreportPO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			 and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			 order by KodeCustSupp
		  if @NeedOto=2
			 select * from VwreportPO where Tanggal between @tgl1 and @tgl2 
			 and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			 order by KodeCustSupp
		end 
End

GO

-- Procedure: Sp_ReportPORek
-- Created: 2013-06-03 13:42:57.343 | Modified: 2013-06-03 13:42:57.343
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportPORek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto smallint
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='f'

If @Choice='N'
begin
	if @NeedOto=0 or @NeedOto=1
        Select 	I.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP,I.KODEVLS,i.KURS,
        sum(ISnull(K.NDPP*i.KURS,0)) NDPP,Sum (Isnull(K.NPPN*I.kurs,0)) NPPN,Sum(Isnull(K.NNET*I.kurs,0)) TotalIDR
        From  dbPO I 
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		Left Outer Join DBPODET K on I.NOBUKTI= K.NOBUKTI
		where I.TANGGAL between @tgl1 and @tgl2 and 
		Cast(Case when Case when I.IsOtorisasi1=1 then 1 else 0 end+
                      Case when I.IsOtorisasi2=1 then 1 else 0 end+
                      Case when I.IsOtorisasi3=1 then 1 else 0 end+
                      Case when I.IsOtorisasi4=1 then 1 else 0 end+
                      Case when I.IsOtorisasi5=1 then 1 else 0 end=I.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
       Group By I.NoBukti,I.TANGGAL,I.KODESUPP ,J.NAMACUSTSUPP,I.KODEVLS,i.KURS
	   order by  I.NOBUKTI,I.TANGGAL
	if @NeedOto=2 
        Select 	I.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP,I.KODEVLS,i.KURS,
        sum(ISnull(K.NDPP*i.KURS,0)) NDPP,Sum (Isnull(K.NPPN*I.kurs,0)) NPPN,Sum(Isnull(K.NNET*I.kurs,0)) TotalIDR
        From  dbPO I 
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		Left Outer Join DBPODET K on I.NOBUKTI= K.NOBUKTI
		where I.TANGGAL between @tgl1 and @tgl2 
		Group By I.NoBukti,I.TANGGAL,I.KODESUPP ,J.NAMACUSTSUPP,I.KODEVLS,i.KURS
		order by  I.NOBUKTI,I.TANGGAL 		
end
If @choice='S'
begin
	if @NeedOto=0 or @NeedOto=1
		Select 	I.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP,i.KODEVLS,i.KURS,
        sum(ISnull(K.NDPP*i.KURS,0)) NDPP,Sum (Isnull(K.NPPN*I.kurs,0)) NPPN,Sum(Isnull(K.NNET*I.kurs,0)) TotalIDR
        From  dbPO I 
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		Left Outer Join DBPODET K on I.NOBUKTI= K.NOBUKTI
		where I.TANGGAL between @tgl1 and @tgl2  and 
		Cast(Case when Case when I.IsOtorisasi1=1 then 1 else 0 end+
                      Case when I.IsOtorisasi2=1 then 1 else 0 end+
                      Case when I.IsOtorisasi3=1 then 1 else 0 end+
                      Case when I.IsOtorisasi4=1 then 1 else 0 end+
                      Case when I.IsOtorisasi5=1 then 1 else 0 end=I.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
        Group By I.NoBukti,I.TANGGAL,I.KODESUPP ,J.NAMACUSTSUPP,I.KODEVLS,i.KURS
		order by  J.NAMACUSTSUPP,i.kodesupp,I.NOBUKTI
	if @NeedOto=2
		Select 	I.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP,i.KODEVLS,i.KURS,
        sum(ISnull(K.NDPP*i.KURS,0)) NDPP,Sum (Isnull(K.NPPN*I.kurs,0)) NPPN,Sum(Isnull(K.NNET*I.kurs,0)) TotalIDR
        From  dbPO I 
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		Left Outer Join DBPODET K on I.NOBUKTI= K.NOBUKTI
		where I.TANGGAL between @tgl1 and @tgl2  
		Group By I.NoBukti,I.TANGGAL,I.KODESUPP ,J.NAMACUSTSUPP,I.KODEVLS,i.KURS
		order by  J.NAMACUSTSUPP,i.kodesupp,I.NOBUKTI
end

else if @Choice ='B'
begin
	if @NeedOto=0 or @NeedOto=1
		Select 	B.KodeBrg, H.NamaBrg,sum(B.Qnt*B.isi) qnt,
        sum((B.NDISKON+B.DISCTOT)*i.kurs) Disctotal,
        sum((B.NDPP+B.NPPN)*i.kurs) TotalIDR, 
        sum(B.NDPP*i.kurs) NDPP,
        sum(B.NPPN*i.kurs) NPPN, 
        case when i.kurs=1 then 0 else sum(b.disctot) end as disctotusd,
        case when i.kurs=1 then 0 else sum(b.ndpp) end as Ndppusd,
        case when i.kurs=1 then 0 else sum(b.nppn) end as NPPNusd,
        case when i.kurs=1 then 0 else sum(b.subtotal) end as totalusd,
        I.kurs,I.KODEVLS
        From  dbPODet B 
        Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2 and 
		Cast(Case when Case when I.IsOtorisasi1=1 then 1 else 0 end+
                      Case when I.IsOtorisasi2=1 then 1 else 0 end+
                      Case when I.IsOtorisasi3=1 then 1 else 0 end+
                      Case when I.IsOtorisasi4=1 then 1 else 0 end+
                      Case when I.IsOtorisasi5=1 then 1 else 0 end=I.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
		Group by  B.KodeBrg, H.NamaBrg,i.kurs,i.KODEVLS
		order by B.KodeBrg, H.NamaBrg
	if @NeedOto=2
		Select 	B.KodeBrg, H.NamaBrg,sum(B.Qnt*B.isi) qnt,
        sum((B.NDISKON+B.DISCTOT)*i.kurs) Disctotal,
        sum((B.NDPP+B.NPPN)*i.kurs) TotalIDR, 
        sum(B.NDPP*i.kurs) NDPP,
        sum(B.NPPN*i.kurs) NPPN, 
        case when i.kurs=1 then 0 else sum(b.disctot) end as disctotusd,
        case when i.kurs=1 then 0 else sum(b.ndpp) end as Ndppusd,
        case when i.kurs=1 then 0 else sum(b.nppn) end as NPPNusd,
        case when i.kurs=1 then 0 else sum(b.subtotal) end as totalusd,
        I.kurs,I.KODEVLS
        From  dbPODet B 
        Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by  B.KodeBrg, H.NamaBrg,i.kurs,i.KODEVLS
		order by B.KodeBrg, H.NamaBrg
end

GO

-- Procedure: Sp_ReportPurchasingReqDet
-- Created: 2013-06-03 13:35:21.097 | Modified: 2015-03-11 09:53:51.687
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportPurchasingReqDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto smallint,
@IDuser varchar(20),
@tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
				order by NoBukti,Tanggal
		  else if @NeedOto=2
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 
				order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  if @NeedOto=0 or @NeedOto=1
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by KodeBrg
		  else if @NeedOto=2  
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 
				order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  if @NeedOto=0 or @NeedOto=1
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by KodeCustSupp
		  else if @NeedOto=2
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 
				order by KodeCustSupp 
		end 		
End
else
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto 
				and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by NoBukti,Tanggal
		  else if @NeedOto=2
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 
				and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  if @NeedOto=0 or @NeedOto=1
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeBrg
		  else if @NeedOto=2  
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 
				and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  if @NeedOto=0 or @NeedOto=1
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeCustSupp
		  else if @NeedOto=2
				select * from VwReportPurchasingReq where Tanggal between @tgl1 and @tgl2 
				and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeCustSupp 
		end
End

GO

-- Procedure: Sp_reportRBeliGDGDet
-- Created: 2013-06-03 13:53:10.453 | Modified: 2015-03-09 15:32:12.847
-- =====================================================


CREATE Procedure [dbo].[Sp_reportRBeliGDGDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt,
@Iduser varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
			if @NeedOto=0 or @NeedOto=1
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by NoBukti,Tanggal
			if @NeedOto=2
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 
				order by NoBukti,Tanggal	
		end 
	else If @Ordr='B'
		begin
			if @NeedOto=0 or @NeedOto=1
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by KodeBrg
			if @NeedOto=2
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 
				order by KodeBrg
		end 
	else If @Ordr='S'
		begin
			if @NeedOto=0 or @NeedOto=1
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				order by KodeCustSupp
			if @NeedOto=2
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2
				order by KodeCustSupp
		end 		
End
else
begin
If @Ordr='N'
		begin
			if @NeedOto=0 or @NeedOto=1
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by NoBukti,Tanggal
			if @NeedOto=2
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 
				and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by NoBukti,Tanggal	
		end 
	else If @Ordr='B'
		begin
			if @NeedOto=0 or @NeedOto=1
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeBrg
			if @NeedOto=2
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 
				and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeBrg
		end 
	else If @Ordr='S'
		begin
			if @NeedOto=0 or @NeedOto=1
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
				and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeCustSupp
			if @NeedOto=2
				select * from VwReportRPembelianGDg where Tanggal between @tgl1 and @tgl2
				and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
				order by KodeCustSupp
		end 
End


GO

-- Procedure: Sp_reportRBPrek
-- Created: 2013-01-12 09:54:30.010 | Modified: 2013-01-12 09:54:30.010
-- =====================================================

Create Procedure [dbo].[Sp_reportRBPrek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 dateTime
as
--Declare @Choice varchar(1),@Bulan Int,@Tahun Int
--Select @Choice='B',@Bulan=1,@Tahun=2012

If @Choice='N'
begin
	Select 	A.NoBukti,A.tanggal, 
	Sum(Isnull(B.Qnt,0)) Qnt
	From dbRPenyerahanBhn A
	Left Outer join  dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Where A.tanggal Between @Tgl1 And @Tgl2
	Group By A.Nobukti,A.tanggal
	Order BY A.nobukti,A.tanggal
End

If @Choice='B'
Begin
	Select 	B.KOdebrg,H.namaBrg,A.Tanggal, 
	Sum(Isnull(B.Qnt,0)) Qnt
	From dbRPenyerahanBhn A
	Left Outer join  dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg
	Where A.tanggal Between @Tgl1 And @Tgl2
	Group By B.kodebrg,H.namaBrg,A.tanggal
	Order BY B.kodebrg,H.namaBrg,A.Tanggal
end





GO

-- Procedure: Sp_reportRevisiPOdet
-- Created: 2013-01-18 14:18:46.737 | Modified: 2015-03-11 09:53:51.573
-- =====================================================

CREATE Procedure [dbo].[Sp_reportRevisiPOdet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@x int=0,
@IDuser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportRevisiPO where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportRevisiPO where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select * from VwReportRevisiPO where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
else
begin
	If @Ordr='N'
		begin
		  select * from VwReportRevisiPO where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportRevisiPO where Tanggal between @tgl1 and @tgl2 
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select * from VwReportRevisiPO where Tanggal between @tgl1 and @tgl2
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
		  order by KodeCustSupp
		end 
End

GO

-- Procedure: Sp_ReportRevisiPOrek
-- Created: 2013-01-12 09:54:53.193 | Modified: 2013-01-12 09:54:53.193
-- =====================================================

Create Procedure [dbo].[Sp_ReportRevisiPOrek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='f'

If @Choice='N'
begin
        Select 	B.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP, 
	    Sum(isnull(B.Qnt,0)) Qnt, Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
        From  dbPODet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by B.NOBUKTI,I.TANGGAL,I.KODESUPP,J.NAMACUSTSUPP
		order by  B.NOBUKTI,I.TANGGAL
end
If @choice='S'
begin
		Select 	I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP, 
	    Sum(isnull(B.Qnt,0)) Qnt, Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
        From  dbPODet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by I.TANGGAL,I.KODESUPP,J.NAMACUSTSUPP
		Order By I.KODESUPP,J.NAMACUSTSUPP,I.TANGGAL
end

else if @Choice ='B'
begin
		Select  I.TANGGAL, B.KodeBrg, H.NamaBrg,
	    Sum(isnull(B.Qnt,0)) Qnt, Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
		From  dbPODet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by  B.KodeBrg, H.NamaBrg,I.TANGGAL
		order by B.KodeBrg, H.NamaBrg,I.TANGGAL
end

--exec Sp_ReportPORek 'N','01/01/2012','07/17/2013' where kodecustsupp='12'
GO

-- Procedure: Sp_ReportRevisirek
-- Created: 2013-01-12 09:55:16.670 | Modified: 2013-01-12 09:55:16.670
-- =====================================================

Create Procedure [dbo].[Sp_ReportRevisirek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='f'

If @Choice='N'
begin
        Select 	B.NoBukti,I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP, 
	    Sum(isnull(B.Qnt,0)) Qnt, Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
        From  dbPODet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by B.NOBUKTI,I.TANGGAL,I.KODESUPP,J.NAMACUSTSUPP
		order by  B.NOBUKTI,I.TANGGAL
end
If @choice='S'
begin
		Select 	I.TANGGAL,I.KODESUPP KodeCustSupp,J.NAMACUSTSUPP, 
	    Sum(isnull(B.Qnt,0)) Qnt, Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
        From  dbPODet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by I.TANGGAL,I.KODESUPP,J.NAMACUSTSUPP
		Order By I.KODESUPP,J.NAMACUSTSUPP,I.TANGGAL
end

else if @Choice ='B'
begin
		Select  I.TANGGAL, B.KodeBrg, H.NamaBrg,
	    Sum(isnull(B.Qnt,0)) Qnt, Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(ISnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
		From  dbPODet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg
		Left Outer join DBPO I on B.NOBUKTI = I.NOBUKTI
		Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
		where I.TANGGAL between @tgl1 and @tgl2
		Group by  B.KodeBrg, H.NamaBrg,I.TANGGAL
		order by B.KodeBrg, H.NamaBrg,I.TANGGAL
end

--exec Sp_ReportPORek 'N','01/01/2012','07/17/2013' where kodecustsupp='12'
GO

-- Procedure: Sp_ReportRincianNeracaBulanan
-- Created: 2015-05-23 09:16:19.013 | Modified: 2015-09-26 12:03:15.870
-- =====================================================
CREATE Procedure [dbo].[Sp_ReportRincianNeracaBulanan] 
--declare
@bulan int,
@tahun int,
@devisi varchar(10),
@IdUser varchar(15)
As
Declare @Mulai Datetime
--Select @awal='111110001',@akhir='111120003',@tglawal='07-01-2011',@tglakhir='07-31-2011',@devisi='01',@IdUser='SA'
--Select @Mulai=DATEADD(dd,-(DAY(@tglawal)-1),@tglawal);
--select @bulan=4,@tahun=2015,@devisi='01'
Select A.Perkiraan, A.Keterangan,
      B.MDRp MDAsli,
      case when B.MDRp<0 then B.MDRp*-1 else B.MDRp end MD,
      case when B.MDRp<0 then 'K' else '' end KMD,
      B.MKRp MKAsli,
      case when B.MKRp<0 then B.MKRp*-1 else B.MKRp end MK,
      case when B.MKRp<0 then 'K' else '' end KMK,
        B.AkhirDRp SaldoDAkhir,
       B.JPD, B.JPDRp, B.JPK, B.JPKRp,
       B.AkhirKRp SaldoKAkhir, 
       Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0 end SaldoAwalAsli,
       case when (
       Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0
       end)<0 then (
       Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0
       end)*-1 else (
       Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0
       end) end SaldoAwal,
       case when (
       Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0
       end)<0 then 'K' else '' end KSaldoAwal,
       (Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0 end)+B.MDRp+JPD-B.MKRp-B.JPK SaldoAkhirAsli,
       case when (
      (Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0 end)+B.MDRp+JPD-B.MKRp-B.JPK)<0 then
            (
      (Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0 end)+B.MDRp+JPD-B.MKRp-B.JPK)*-1 else 
            (
      (Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0 end)+B.MDRp+JPD-B.MKRp-B.JPK) end SaldoAkhir,
       case when (
      (Case when A.DK=0 then B.AwalDRp-B.AwalKRp 
            when A.DK=1 then B.AwalKRp-B.AwalDRp
            else 0 end)+B.MDRp+JPD-B.MKRp-B.JPK)<0 then
       'K' else '' end KSaldoAkhir,
        Budget,GroupPerkiraan,a.DK
from DBPERKIRAAN A
     Left Outer join DBNERACA B on B.Perkiraan=A.Perkiraan
where B.Bulan=@bulan and B.Tahun=@tahun and B.Devisi like Case when @devisi='-' then '%' else @devisi end
and a.IsSubPerkiraan=1
Order by A.Perkiraan

GO

-- Procedure: Sp_reportRInvoicedet
-- Created: 2013-01-18 14:58:18.257 | Modified: 2013-01-18 14:58:18.257
-- =====================================================
Create Procedure Sp_reportRInvoicedet
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwreportRINVoice where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwreportRINVoice where Tanggal between @tgl1 and @tgl2 --order by KodeBrg
		end 
	else If @Ordr='S'
		begin
		  select * from VwreportRINVoice where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
GO

-- Procedure: Sp_reportRInvoicePenjualanDet
-- Created: 2013-06-03 14:14:58.833 | Modified: 2013-06-03 14:14:58.833
-- =====================================================


CREATE Procedure [dbo].[Sp_reportRInvoicePenjualanDet]  
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
			select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		if @NeedOto=2
			select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  order by KodeBrg
		 if @NeedOto=2
		  select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  order by KodeCustSupp
		if @NeedOto=2
		  select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end
	else If @Ordr='S'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  order by KodeCustSupp
		 if @NeedOto=2
		  select * from VwReportRInvoicePenjualan where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end 	
		
End



GO

-- Procedure: Sp_ReportRInvoicePenjualanRek
-- Created: 2013-06-03 14:15:26.160 | Modified: 2013-06-03 14:15:26.160
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportRInvoicePenjualanRek] 
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime,
@Needoto SmallInt
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
	If @Needoto=0 or @Needoto=1
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
		sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
       sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
		Order by B.NoBukti,A.Tanggal
  else If @Needoto=2
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
		sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
       sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2       
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
		Order by B.NoBukti,A.Tanggal
end
Else If @Choice='B'
Begin
	If @Needoto=0 or @Needoto=1
		select 	B.KodeBrg,C.NAMABRG,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By B.KodeBrg,C.NAMABRG,A.Tanggal
		order By B.KodeBrg,C.NAMABRG,A.Tanggal
	else If @Needoto=2
		select 	B.KodeBrg,C.NAMABRG,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2
		Group By B.KodeBrg,C.NAMABRG,A.Tanggal
		order By B.KodeBrg,C.NAMABRG,A.Tanggal
end
Else If @Choice='C'
Begin
	If @Needoto=0 or @Needoto=1
		select 	A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
		order By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
	If @Needoto=2
		select 	A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2
		Group By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
		order By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
end

Else If @Choice='S'
Begin
	If @Needoto=0 or @Needoto=1
		select 	A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2 and       
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
		Case when A.IsOtorisasi2=1 then 1 else 0 end+
		Case when A.IsOtorisasi3=1 then 1 else 0 end+
		Case when A.IsOtorisasi4=1 then 1 else 0 end+
		Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
		else 1
		end As Bit)= @Needoto
		Group By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
		order By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
	If @Needoto=2
		select 	A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		where A.Tanggal between @Tgl1 and @Tgl2
		Group By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
		order By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
end






--select * from DBEXPEDISI

GO

-- Procedure: Sp_ReportRInvoiceRek
-- Created: 2013-01-18 15:26:36.640 | Modified: 2013-01-18 15:26:36.640
-- =====================================================

Create procedure [dbo].[Sp_ReportRInvoiceRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='S'
If @Choice='N'
Begin
		Select 	B.NoBukti,I.TANGGAL,SUM(ISNULL(B.Qnt,0)) Qnt,Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscTot,0)) Disctot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(Isnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) Nppn,Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
		From dbRBeliDet B
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg 
	Left Outer Join DBRBELI I on B.NOBUKTI = I.NOBUKTI
	Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
	group by B.NoBukti,I.TANGGAL
	Order by B.NoBukti,I.TANGGAL 
End
else If @Choice='B'
begin
Select 	B.Kodebrg,H.NAMABRG,i.TANGGAL,SUM(ISNULL(B.Qnt,0)) Qnt,Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscTot,0)) Disctot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(Isnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) Nppn,Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
	From dbRBeliDet B
	Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg 
	Left Outer Join DBRBELI I on B.NOBUKTI = I.NOBUKTI
	Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
	group by B.Kodebrg,H.NAMABRG,i.TANGGAL
	Order by B.Kodebrg,H.NAMABRG,i.TANGGAL
end
else If @Choice='S'
begin
Select i.KODESUPP,J.NAMACUSTSUPP,i.TANGGAL,SUM(ISNULL(B.Qnt,0)) Qnt,Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscTot,0)) Disctot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(Isnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) Nppn,Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
	From dbRBeliDet B
	Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg 
	Left Outer Join DBRBELI I on B.NOBUKTI = I.NOBUKTI
	Left Outer Join DBCUSTSUPP J on I.KODESUPP = J.KODECUSTSUPP 
	group by i.KODESUPP,J.NAMACUSTSUPP,i.TANGGAL
	Order by i.KODESUPP,J.NAMACUSTSUPP,i.TANGGAL
end
GO

-- Procedure: Sp_ReportRNeracaBulanan
-- Created: 2015-10-02 08:34:36.557 | Modified: 2016-02-16 08:47:53.550
-- =====================================================




CREATE PROCEDURE [dbo].[Sp_ReportRNeracaBulanan]
--declare
@bulan int,
@tahun int,
@devisi varchar(10),
@IdUser varchar(15)
AS
--Select @bulan =1 , @tahun =2015, @devisi='01', @IdUser ='SA'
delete TempRNerBul where Tanda in ('R10','R8','R6','R1') 
and LEFT(Perkiraan,6) in (select LEFT(Perkiraan,6) from TempNerBul  group by LEFT(Perkiraan,6) having COUNT(LEFT(Perkiraan,6))=2)
select case when Tanda in ('R10','R8','R8H','R1') then Perkiraan else '' end Perkiraan
           ,[Keterangan]
           ,[DK]
           ,[GroupPerkiraan]
           ,[IsSubPerkiraan]
           ,[Tanda]
           ,[Awal]
           ,[AwalK]
           ,[Debet]
           ,[DebetK]
           ,[Kredit]
           ,[KreditK]
           ,[Akhir]
           ,[AkhirK]
           ,[Bintang]
           ,[Budget] from TempRNerBul where bulan=@bulan and tahun=@tahun



GO

-- Procedure: Sp_reportRPembelianGDGRek
-- Created: 2013-06-03 13:54:42.027 | Modified: 2013-06-03 13:54:42.027
-- =====================================================



CREATE Procedure [dbo].[Sp_reportRPembelianGDGRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto SmallInt
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

if @Choice='N'
begin
	If @NeedOto=0 or @NeedOto=1
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            b.NDPP,b.NDPPRp,b.NPPNRp,B.nnetrp
		From  DBRBELI a 
		left outer join DBRBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2 and 
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
		order by  a.NOBUKTI,a.TANGGAL
	else If @NeedOto=2
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            b.NDPP,b.NDPPRp,b.NPPNRp,B.nnetrp
		From  DBRBELI a 
		left outer join DBRBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2 
		order by  a.NOBUKTI,a.TANGGAL
End

Else if @Choice='S'
begin
	If @NeedOto=0 or @NeedOto=1
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            b.NDPP,b.NDPPRp,b.NPPNRp,B.nnetrp
		From  DBRBELI a 
		left outer join DBRBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2 and 
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
		order by  J.NAMACUSTSUPP,a.kodesupp,a.NOBUKTI
	else If @NeedOto=2
		Select 	a.NoBukti,a.TANGGAL,J.NAMACUSTSUPP,a.KODEVLS,a.KURS,
            b.NDPP,b.NDPPRp,b.NPPNRp,B.nnetrp
		From  DBRBELI a 
		left outer join DBRBELIDET B on b.NOBUKTI=a.NOBUKTI
		Left Outer Join DBCUSTSUPP J on a.KODESUPP = J.KODECUSTSUPP 
		Where a.TANGGAL between @tgl1 and @tgl2 
		order by  J.NAMACUSTSUPP,a.kodesupp,a.NOBUKTI
End
Else If @Choice='B'
Begin
	If @NeedOto=0 or @NeedOto=1
		Select B.KODEBRG,H.NAMABRG,
		Sum(Isnull(B.Qnt,0)) QNT,Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(Isnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
		From dbRBeliDet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg 
		left Outer Join DBRBELI A on B.NOBUKTI=A.NOBUKTI
		Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
		Where a.TANGGAL between @tgl1 and @tgl2 and 
		Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit) =@NeedOto
		Group By B.KODEBRG,H.NAMABRG
		Order by B.KODEBRG,H.NAMABRG
	else If @NeedOto=2
		Select B.KODEBRG,H.NAMABRG,
		Sum(Isnull(B.Qnt,0)) QNT,Sum(Isnull(B.Harga,0)) Harga,
        Sum(Isnull(B.DiscP,0)) DiscP1, Sum(Isnull(B.DiscTot,0)) DiscRp1, Sum(Isnull(B.DiscTot,0)) DiscTot,
        Sum(Isnull(B.SubTotal,0)) TotalUSD, Sum(Isnull(B.SubTotal,0)) TotalIDR, Sum(Isnull(B.NDPP,0)) NDPP,
        Sum(Isnull(B.NPPN,0)) NPPN, Sum(Isnull(B.BYAngkut,0)) Beban, Sum(Isnull(B.SubTotal,0)) + Sum(Isnull(B.BYAngkut,0)) Total
		From dbRBeliDet B 
		Left Outer Join dbBarang H on H.KodeBrg=B.KodeBrg 
		left Outer Join DBRBELI A on B.NOBUKTI=A.NOBUKTI
		Left Outer Join DBCUSTSUPP I on A.KODESUPP = I.KODECUSTSUPP
		Where a.TANGGAL between @tgl1 and @tgl2 
		Group By B.KODEBRG,H.NAMABRG
		Order by B.KODEBRG,H.NAMABRG
	End



GO

-- Procedure: Sp_reportRPenyerahanBahan
-- Created: 2013-06-03 14:27:24.093 | Modified: 2013-06-03 14:27:24.093
-- =====================================================


CREATE Procedure [dbo].[Sp_reportRPenyerahanBahan]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportRPenyerahanBahan where Tanggal between @tgl1 and @tgl2 And NeEdOtorisasi=@NeedOto
		   order by NoBukti,Tanggal
		If @NeedOto=2
		  select * from VwReportRPenyerahanBahan where Tanggal between @tgl1 and @tgl2 
		   order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 Or @NeedOto=1
		  select * from VwReportRPenyerahanBahan where Tanggal between @tgl1 and @tgl2 And NeEdOtorisasi=@NeedOto
		  order by KodeBrg
		If @NeedOto=2
		  select * from VwReportRPenyerahanBahan where Tanggal between @tgl1 and @tgl2 
		  order by KodeBrg
		end 
End






GO

-- Procedure: Sp_reportRPenyerahanBahanRek
-- Created: 2013-06-03 14:28:01.643 | Modified: 2013-06-03 14:28:01.643
-- =====================================================



CREATE Procedure [dbo].[Sp_reportRPenyerahanBahanRek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 dateTime,
@NeedOto SmallInt
as
--Declare @Choice varchar(1),@Tgl1 datetime,@tgl2 Datetime
--Select @Choice='N',@Tgl1='01/01/2011',@tgl2='01/01/2013'

If @Choice='N'
begin	
 If @NeedOto=0 Or @NeedOto=1
	Select 	A.NoBukti,A.Tanggal,Sum(Isnull(B.Qnt,0)) Qnt,SUM(Isnull(B.Qnt2,0)) Qnt2
	From dbRPenyerahanBhn A
	Left Outer join  dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg  
	where A.Tanggal between @Tgl1 and @tgl2 And
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@NeedOto 
	Group By A.NoBukti,A.Tanggal
 else If @NeedOto=2
	Select 	A.NoBukti,A.Tanggal,Sum(Isnull(B.Qnt,0)) Qnt,SUM(Isnull(B.Qnt2,0)) Qnt2
	From dbRPenyerahanBhn A
	Left Outer join  dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg  
	where A.Tanggal between @Tgl1 and @tgl2  
	Group By A.NoBukti,A.Tanggal
End
else If @Choice='B'
begin
  If @NeedOto=0 Or @NeedOto=1
	Select 	B.kodebrg,H.NAMABRG,A.Tanggal,Sum(Isnull(B.Qnt,0)) Qnt,SUM(Isnull(B.Qnt2,0)) Qnt2
	From dbRPenyerahanBhn A
	Left Outer join  dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg  
	where A.Tanggal between @Tgl1 and @tgl2 And
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@NeedOto 
	
	Group By 	B.kodebrg,H.NAMABRG,A.Tanggal
 else If @NeedOto=2
	Select 	B.kodebrg,H.NAMABRG,A.Tanggal,Sum(Isnull(B.Qnt,0)) Qnt,SUM(Isnull(B.Qnt2,0)) Qnt2
	From dbRPenyerahanBhn A
	Left Outer join  dbRPenyerahanBhnDet B on B.NoBukti=a.NoBukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg  
	where A.Tanggal between @Tgl1 and @tgl2 
	Group By 	B.kodebrg,H.NAMABRG,A.Tanggal
end


GO

-- Procedure: Sp_reportRPLInvoiceDet
-- Created: 2013-02-01 14:25:59.003 | Modified: 2013-02-01 14:25:59.003
-- =====================================================

Create Procedure [dbo].[Sp_reportRPLInvoiceDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportRPLInvoice where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportRPLInvoice where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportRPLInvoice where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
GO

-- Procedure: Sp_ReportRPLInvoiceRek
-- Created: 2013-02-01 14:21:49.570 | Modified: 2013-02-01 14:21:49.570
-- =====================================================
Create Procedure [dbo].[Sp_ReportRPLInvoiceRek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
		select 	B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
		sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
       sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		Group By B.NoBukti,A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
		Order by B.NoBukti,A.Tanggal
end
Else If @Choice='B'
Begin
		select 	B.KodeBrg,C.NAMABRG,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		Group By B.KodeBrg,C.NAMABRG,A.Tanggal
		order By B.KodeBrg,C.NAMABRG,A.Tanggal
end
Else If @Choice='C'
Begin
		select 	A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal,sum(isnull(B.PPN,0))PPN,sum(isnull(B.DISC,0))Disc, 
		sum(isnull(B.KURS,0))Kurs, sum(isnull(B.QNT,0)) QNT, sum(isnull(B.QNT2,0))QNT2, 
		sum(isnull(B.NetW,0)) NetW,sum(isnull(B.GrossW,0))GrossW,
        sum(isnull(B.DISCTOT,0))Disctot, 
        sum(isnull(B.HRGNETTO,0)) HrgNetto, sum(isnull(B.NDISKON,0)) NDiskon, 
        sum(isnull(B.SUBTOTAL,0)) SubTotal, sum(isnull(B.NDPP,0)) NDPP,
        sum(isnull(B.NPPN,0)) NPPN,sum(isnull(B.NNET,0)) NNet,
        sum(isnull(B.SUBTOTALRp,0)) SubtotalRp, sum(isnull(B.NDPPRp,0)) NDPPRP, 
        sum(isnull(B.NPPNRp,0)) NPPNRP, sum(isnull(B.NNETRp,0)) NNETRP
		from	DBRInvoicePLDET B
		left outer join dbBarang C on C.KodeBrg=B.KodeBrg
		left outer join DBRInvoicePL A on B.NoBukti = A.NoBukti
		Left outer join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
		Group By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
		order By A.KodeCustSupp,D.NAMACUSTSUPP,A.Tanggal
end
GO

-- Procedure: sp_ReportSaldoHutang
-- Created: 2012-11-05 10:19:51.597 | Modified: 2012-11-05 10:19:51.597
-- =====================================================



CREATE   PROCEDURE [dbo].[sp_ReportSaldoHutang]
@Perkiraan varchar(20),
@Tanggal1 datetime,
@Tanggal2 datetime,
@Awal varchar(15),
@Akhir varchar(15),
@Devisi varchar(10),
@Tipe int,
@KodeVls varchar(15)
AS
if @tipe=0 
begin
	Select 	H.KodeCustSupp Kode, isnull(S.NAMACUSTSUPP,'') Nama, isnull(S.Kota,'') Kota,
		sum(case when H.Tanggal<@Tanggal1 then isnull(Kredit,0)-isnull(Debet,0) else 0 end) Awal,
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Kredit,0) else 0 end) Jumlah,
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Debet,0) else 0 end) Pelunasan,
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur<>'' then isnull(H.Debet,0) else 0 end) Retur,
		sum(isnull(Kredit,0)-isnull(Debet,0)) SaldoAkhir,
		sum(case when H.Tanggal<@Tanggal1 then isnull(Kreditd,0)-isnull(Debetd,0) else 0 end) AwalD,
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Kreditd,0) else 0 end) JumlahD,
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Debetd,0) else 0 end) PelunasanD,
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur<>'' then isnull(H.Debetd,0) else 0 end) ReturD,
		sum(isnull(Kreditd,0)-isnull(Debetd,0)) SaldoAkhirD
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 	where H.Tanggal<=@Tanggal2 and (H.KodeCustSupp between @awal and @akhir) and H.perkiraan=@perkiraan and H.Tipe='HT'
 	group by H.KodeCustSupp, S.NAMACUSTSUPP, S.kota
 	Having
 	   sum(case when H.Tanggal<@Tanggal1 then isnull(Kredit,0)-isnull(Debet,0) else 0 end)<>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Kredit,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Debet,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur<>'' then isnull(H.Debet,0) else 0 end) <>0 or
		sum(isnull(Kredit,0)-isnull(Debet,0)) <>0 or
		sum(case when H.Tanggal<@Tanggal1 then isnull(Kreditd,0)-isnull(Debetd,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Kreditd,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur='' then isnull(H.Debetd,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.tanggal<=@Tanggal2 and H.NoRetur<>'' then isnull(H.Debetd,0) else 0 end) <>0 or
		sum(isnull(Kreditd,0)-isnull(Debetd,0)) <>0 
end
else
begin

	Select 	H.KodeCustSupp Kode, isnull(S.NAMACUSTSUPP,'') Nama, isnull(S.Kota,'') Kota,
		sum(case when H.Tanggal<@Tanggal1 then isnull(Debet,0)-isnull(Kredit,0) else 0 end) Awal,
		sum(case when H.Tanggal>=@Tanggal1 then isnull(H.Debet,0) else 0 end) Jumlah,
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur='' then isnull(H.Kredit,0) else 0 end) Pelunasan,
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur<>'' then isnull(H.Kredit,0) else 0 end) Retur,
		sum(isnull(Debet,0)-isnull(Kredit,0)) SaldoAkhir,
		sum(case when H.Tanggal<@Tanggal1 then isnull(Debetd,0)-isnull(Kreditd,0) else 0 end) AwalD,
		sum(case when H.Tanggal>=@Tanggal1 then isnull(H.Debetd,0) else 0 end) JumlahD,
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur='' then isnull(H.Kreditd,0) else 0 end) PelunasanD,
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur<>'' then isnull(H.Kreditd,0) else 0 end) ReturD,
		sum(isnull(Debetd,0)-isnull(Kreditd,0)) SaldoAkhirD
 	from vwHutpiut H
 	left outer join DBCUSTSUPP S on S.KODECUSTSUPP=H.KodeCustSupp
 	where H.Tanggal<=@Tanggal2 and H.KodeCustSupp>=@awal and H.KodeCustSupp<=@akhir and H.perkiraan=@perkiraan and H.Tipe='PT'
 	group by H.KodeCustSupp, S.NAMACUSTSUPP, S.Kota
 	having sum(case when H.Tanggal<@Tanggal1 then isnull(Debet,0)-isnull(Kredit,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 then isnull(H.Debet,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur='' then isnull(H.Kredit,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur<>'' then isnull(H.Kredit,0) else 0 end) <>0 or
		sum(isnull(Debet,0)-isnull(Kredit,0)) <>0 or
		sum(case when H.Tanggal<@Tanggal1 then isnull(Debetd,0)-isnull(Kreditd,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 then isnull(H.Debetd,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur='' then isnull(H.Kreditd,0) else 0 end) <>0 or
		sum(case when H.Tanggal>=@Tanggal1 and H.NoRetur<>'' then isnull(H.Kreditd,0) else 0 end)<>0 or
		sum(isnull(Debetd,0)-isnull(Kreditd,0)) <>0
end







GO

-- Procedure: sp_ReportSisaHutang
-- Created: 2012-05-02 14:29:17.263 | Modified: 2012-05-02 14:29:17.263
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportSisaHutang] 
@tanggal datetime,
@awal varchar(15),
@akhir varchar(15),
@devisi varchar(10),
@tipe int,
@Perkiraan varchar(20),
@KodeVls varchar(15)
AS
if @tipe=0 
begin
 	select 	a.KodeCustSupp KodeSupp,b.NAMACUSTSUPP namasupp,'' alamat,
		max(case when a.Kredit<>0 then a.Tanggal else '01/01/1900' end) Tanggal, 
		max(a.JatuhTempo) as JatuhTempo,a.Nofaktur,sum(a.kredit) as Jumlah,sum(a.debet) as Terbayar,sum(a.kredit)-sum(a.debet) as sisa,
		sum(a.kreditD) as JumlahD,sum(a.debetD) as TerbayarD,sum(a.kreditD)-sum(a.debetD) as sisaD  
 	from vwHutpiut a
 	left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 	where  a.tanggal<=@tanggal
  		and a.perkiraan=@perkiraan 
		--and ((a.Valas=@KodeVls and @KodeVls<>'IDR') or (a.Valas like '%' and @KodeVls='IDR'))
		and (a.KodeCustSupp between @awal and @akhir)	
 	group by a.KodeCustSupp, a.Nofaktur,b.NAMACUSTSUPP
 	having (sum(a.kredit)-sum(a.debet)) <>0
 	order by a.KodeCustSupp, max(case when a.Kredit<>0 then a.Tanggal else '01/01/1900' end), a.nofaktur
end else
if @Tipe=1
begin
 select a.KodeCustSupp KodeSupp, b.NAMACUSTSUPP namasupp, '' alamat,
		max(case when a.Kredit<>0 then a.Tanggal else '01/01/1900' end) Tanggal, 
		max(a.JatuhTempo) as JatuhTempo,a.Nofaktur,sum(a.kredit) as Jumlah,sum(a.debet) as Terbayar,sum(a.kredit)-sum(a.debet) as sisa,
	sum(a.kreditD) as JumlahD,sum(a.debetD) as TerbayarD,sum(a.kreditD)-sum(a.debetD) as sisaD  
 from vwHutpiut a
 left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 where  a.tanggal<=@tanggal
  		and a.perkiraan=@perkiraan
	--and ((a.Valas=@KodeVls and @KodeVls<>'IDR') or (a.Valas like '%' and @KodeVls='IDR'))
	and (a.KodeCustSupp between @awal and @akhir)
 group by a.KodeCustSupp, a.Nofaktur, b.NAMACUSTSUPP
 having (sum(a.kredit)-sum(a.debet)) <>0
 order by a.KodeCustSupp,right(a.nofaktur,4),right(a.nofaktur,7),a.nofaktur, max(case when a.Kredit<>0 then a.Tanggal else '01/01/1900' end)
end else

if @tipe=2
begin
 	select 	'' kodesupp,'' namasupp, '' alamat,
		max(case when a.Kredit<>0 then a.Tanggal else '01/01/1900' end) Tanggal, 
		max(a.JatuhTempo) as JatuhTempo,a.Nofaktur,sum(a.kredit) as Jumlah,sum(a.debet) as Terbayar,sum(a.kredit)-sum(a.debet) as sisa,
		sum(a.kreditD) as JumlahD,sum(a.debetD) as TerbayarD,sum(a.kreditD)-sum(a.debetD) as sisaD  
 	from vwHutpiut a
 	left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 	where  a.tanggal<=@tanggal
  		and a.perkiraan=@perkiraan 
	--	and ((a.Valas=@KodeVls and @KodeVls<>'IDR') or (a.Valas like '%' and @KodeVls='IDR'))
 	group by a.Nofaktur-- ,b.namasupp,b.alamat
 	having (sum(a.kredit)-sum(a.debet)) <>0
 	order by max(case when a.Kredit<>0 then a.Tanggal else '01/01/1900' end), a.nofaktur
end





GO

-- Procedure: sp_ReportSisaPiutang
-- Created: 2012-05-02 14:30:45.780 | Modified: 2012-05-02 14:30:45.780
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ReportSisaPiutang] 
@tanggal datetime,
@awal varchar(15),
@akhir varchar(15),
@devisi varchar(10),
@tipe int,
@Perkiraan varchar(20),
@KodeVls varchar(15)
AS
if @tipe=0 
begin
 	select 	a.KodeCustSupp KodeCust,b.NAMACUSTSUPP NamaCust,'' alamat,
		max(case when a.Debet<>0 then a.Tanggal else '01/01/1900' end) Tanggal, 
		max(a.JatuhTempo) as JatuhTempo, a.Nofaktur, sum(a.Debet) as Jumlah, sum(a.Kredit) as Terbayar,sum(a.Debet)-sum(a.Kredit) as sisa,
		sum(a.DebetD) as JumlahD,sum(a.KreditD) as TerbayarD,sum(a.DebetD)-sum(a.KreditD) as sisaD  
 	from vwHutpiut a
 	left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 	where  a.tanggal<=@tanggal
  		and a.perkiraan=@perkiraan 
		--and ((a.Valas=@KodeVls and @KodeVls<>'IDR') or (a.Valas like '%' and @KodeVls='IDR'))
		and (a.KodeCustSupp between @awal and @akhir)	
 	group by a.KodeCustSupp, a.Nofaktur,b.NAMACUSTSUPP
 	having (sum(a.Debet)-sum(a.Kredit)) <>0
 	order by a.KodeCustSupp, max(case when a.Debet<>0 then a.Tanggal else '01/01/1900' end), a.nofaktur
end else
if @Tipe=1
begin
 select a.KodeCustSupp KodeCust, b.NAMACUSTSUPP NamaCust, '' alamat,
		max(case when a.Debet<>0 then a.Tanggal else '01/01/1900' end) Tanggal, 
		max(a.JatuhTempo) as JatuhTempo,a.Nofaktur,sum(a.Debet) as Jumlah,sum(a.Kredit) as Terbayar,sum(a.Debet)-sum(a.Kredit) as sisa,
	sum(a.DebetD) as JumlahD,sum(a.KreditD) as TerbayarD,sum(a.DebetD)-sum(a.KreditD) as sisaD  
 from vwHutpiut a
 left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 where  a.tanggal<=@tanggal
  		and a.perkiraan=@perkiraan
	--and ((a.Valas=@KodeVls and @KodeVls<>'IDR') or (a.Valas like '%' and @KodeVls='IDR'))
	and (a.KodeCustSupp between @awal and @akhir)
 group by a.KodeCustSupp, a.Nofaktur, b.NAMACUSTSUPP
 having (sum(a.Debet)-sum(a.Kredit)) <>0
 order by a.KodeCustSupp,right(a.nofaktur,4),right(a.nofaktur,7),a.nofaktur, max(case when a.Debet<>0 then a.Tanggal else '01/01/1900' end)
end else

if @tipe=2
begin
 	select 	'' KodeCust,'' NamaCust, '' alamat,
		max(case when a.Debet<>0 then a.Tanggal else '01/01/1900' end) Tanggal, 
		max(a.JatuhTempo) as JatuhTempo,a.Nofaktur,sum(a.Debet) as Jumlah,sum(a.Kredit) as Terbayar,sum(a.Debet)-sum(a.Kredit) as sisa,
		sum(a.DebetD) as JumlahD,sum(a.KreditD) as TerbayarD,sum(a.DebetD)-sum(a.KreditD) as sisaD  
 	from vwHutpiut a
 	left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 	where  a.tanggal<=@tanggal
  		and a.perkiraan=@perkiraan 
		--and ((a.Valas=@KodeVls and @KodeVls<>'IDR') or (a.Valas like '%' and @KodeVls='IDR'))
 	group by a.Nofaktur-- ,b.namasupp,b.alamat
 	having (sum(a.Debet)-sum(a.Kredit)) <>0
 	order by max(case when a.Debet<>0 then a.Tanggal else '01/01/1900' end), a.nofaktur
end







GO

-- Procedure: Sp_ReportSODet
-- Created: 2013-06-03 13:59:56.787 | Modified: 2015-03-11 09:53:51.897
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportSODet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto smallint=2,
@IDuser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @needoto=1
			select * from VwReportSO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			order by NoBukti,Tanggal
		if @NeedOto=2
			select * from VwReportSO where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		 if @NeedOto=0 or @needoto=1	
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  -- order by KodeBrg
		  if @NeedOto=2
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 
		end 
	else If @Ordr='C'
		begin
		if @NeedOto=0 or @needOto=1	
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KODECUSTSUPP
		if @NeedOto=2
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 
		  order by KODECUSTSUPP 
		end 		
End
if @SReport='F'
begin
If @Ordr='N'
		begin
		  if @NeedOto=0 or @needoto=1
			select * from VwReportSO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
			and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		if @NeedOto=2
			select * from VwReportSO where Tanggal between @tgl1 and @tgl2 
			and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		 if @NeedOto=0 or @needoto=1	
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		   order by KodeBrg
		  if @NeedOto=2
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 
		  and KodeBrg In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order By KodeBrg
		end 
	else If @Ordr='C'
		begin
		if @NeedOto=0 or @needOto=1	
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KODECUSTSUPP In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KODECUSTSUPP
		if @NeedOto=2
		  select * from VwReportSO where Tanggal between @tgl1 and @tgl2 
		  and KODECUSTSUPP In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KODECUSTSUPP 
		end 
End


GO

-- Procedure: Sp_reportSORek
-- Created: 2013-06-03 14:00:12.517 | Modified: 2013-06-03 14:00:12.517
-- =====================================================



CREATE  Procedure [dbo].[Sp_reportSORek]
@Choice varchar(1),
@Tgl1 datetime,
@Tgl2 Datetime,
@needOto SmallInt
as
--Declare @Choice varchar(1),@tgl1 Datetime,@Tgl2 DateTime
--select @Choice='B',@Tgl1='10/10/2011',@tgl2='01/29/2012'

IF @Choice='N'
begin 
  If @needOto=0 or @needoto=1
	Select 	A.NoBukti,A.tanggal, A.KodeCust,I.NamaCustSupp,a.KODEVLS,a.KURS,a.KODESLS,C.Nama,
        SUM(isnull(b.ndpp,0)) nDPP, Sum(Isnull(B.NDPPRp,0)) NDPPRp,
        Sum(Isnull(B.NPPNRp,0)) NPPNRP, Sum(Isnull(B.NNETRp,0)) NnetRp     
	From dbSO A
	Left Outer join dbSODet B on B.NoBukti=a.NoBukti
	Left Outer join DbCustSupp I on A.KodeCust=I.KodeCustSupp
	Left outer Join dbKaryawan C on c.KeyNIK=a.kodesls
	Where a.Tanggal between @tgl1 and @tgl2  and
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit) =@NeedOto
	Group By A.NoBukti,A.tanggal,a.KODECUST,i.NAMACUSTSUPP,a.KODEVLS,a.KURS,a.KODESLS,c.Nama
	Order By A.NoBukti,A.tanggal
 else if @needOto=2
    Select 	A.NoBukti,A.tanggal, A.KodeCust,I.NamaCustSupp,a.KODEVLS,a.KURS,a.KODESLS,C.Nama,
        SUM(isnull(b.ndpp,0)) nDPP, Sum(Isnull(B.NDPPRp,0)) NDPPRp,
        Sum(Isnull(B.NPPNRp,0)) NPPNRP, Sum(Isnull(B.NNETRp,0)) NnetRp     
	From dbSO A
	Left Outer join dbSODet B on B.NoBukti=a.NoBukti
	Left Outer join DbCustSupp I on A.KodeCust=I.KodeCustSupp
	Left outer Join dbKaryawan C on c.KeyNIK=a.kodesls
	Where a.Tanggal between @tgl1 and @tgl2 
	Group By A.NoBukti,A.tanggal,a.KODECUST,i.NAMACUSTSUPP,a.KODEVLS,a.KURS,a.KODESLS,c.Nama
	Order By A.NoBukti,A.tanggal
End
else if @Choice ='S'
begin
	If @needOto=0 or @needoto=1
	Select 	A.NoBukti,A.tanggal, A.KodeCust,I.NamaCustSupp,a.KODEVLS,a.KURS,a.KODESLS,C.Nama,
        SUM(isnull(b.ndpp,0)) nDPP, Sum(Isnull(B.NDPPRp,0)) NDPPRp,
        Sum(Isnull(B.NPPNRp,0)) NPPNRP, Sum(Isnull(B.NNETRp,0)) NnetRp
	From dbSO A
	Left Outer join dbSODet B on B.NoBukti=a.NoBukti
	Left Outer join DbCustSupp I on A.KodeCust=I.KodeCustSupp
	Left outer Join dbKaryawan C on c.KeyNIK=a.kodesls
	Where a.Tanggal between @tgl1 and @tgl2 and
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit) =@NeedOto
	Group By a.KODECUST,A.tanggal,A.NoBukti,i.NAMACUSTSUPP,a.KODEVLS,a.KURS,a.KODESLS,c.Nama
	Order By I.NamaCustSupp,A.NOBUKTI
else If @needOto=2
	Select 	A.NoBukti,A.tanggal, A.KodeCust,I.NamaCustSupp,a.KODEVLS,a.KURS,a.KODESLS,C.Nama,
        SUM(isnull(b.ndpp,0)) nDPP, Sum(Isnull(B.NDPPRp,0)) NDPPRp,
        Sum(Isnull(B.NPPNRp,0)) NPPNRP, Sum(Isnull(B.NNETRp,0)) NnetRp
	From dbSO A
	Left Outer join dbSODet B on B.NoBukti=a.NoBukti
	Left Outer join DbCustSupp I on A.KodeCust=I.KodeCustSupp
	Left outer Join dbKaryawan C on c.KeyNIK=a.kodesls
	Where a.Tanggal between @tgl1 and @tgl2 
	Group By a.KODECUST,A.tanggal,A.NoBukti,i.NAMACUSTSUPP,a.KODEVLS,a.KURS,a.KODESLS,c.Nama
	Order By I.NamaCustSupp,A.NOBUKTI
end
else if @Choice='B'
begin
If @needOto=0 or @needoto=1
    Select B.KODEBRG,h.namabrg,sum(isnull(b.QNT,0)) Qnt,sum(isnull(b.QNT2,0)) qnt2,h.SAT1,h.SAT2,
        SUM(isnull(b.ndpp,0)) nDPP, Sum(Isnull(B.NDPPRp,0)) NDPPRp,
        Sum(Isnull(B.NPPNRp,0)) NPPNRP, Sum(Isnull(B.NNETRp,0)) NnetRp
	From dbSO A
	Left Outer join dbSODet B on B.NoBukti=a.NoBukti
	Left outer join DBBARANG H on H.KODEBRG=b.KODEBRG
	Where a.Tanggal between @tgl1 and @tgl2 and
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit) =@NeedOto
	Group By B.kodeBrg,H.namaBrg,h.SAT1,h.SAT2
	Order By B.kodeBrg
If @needOto=2
    Select B.KODEBRG,h.namabrg,sum(isnull(b.QNT,0)) Qnt,sum(isnull(b.QNT2,0)) qnt2,h.SAT1,h.SAT2,
        SUM(isnull(b.ndpp,0)) nDPP, Sum(Isnull(B.NDPPRp,0)) NDPPRp,
        Sum(Isnull(B.NPPNRp,0)) NPPNRP, Sum(Isnull(B.NNETRp,0)) NnetRp
	From dbSO A
	Left Outer join dbSODet B on B.NoBukti=a.NoBukti
	Left outer join DBBARANG H on H.KODEBRG=b.KODEBRG
	Where a.Tanggal between @tgl1 and @tgl2
	Group By B.kodeBrg,H.namaBrg,h.SAT1,h.SAT2
	Order By B.kodeBrg
End


GO

-- Procedure: Sp_ReportSOxDet
-- Created: 2013-01-18 16:29:42.003 | Modified: 2013-01-30 13:22:28.820
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportSOxDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from vwreportSOx where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from vwreportSOx where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from vwreportSOx where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
GO

-- Procedure: Sp_ReportSoxRek
-- Created: 2013-01-30 11:07:36.067 | Modified: 2013-01-31 09:29:00.290
-- =====================================================
CREATE Procedure [dbo].[Sp_ReportSoxRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
	Select  A.Nobukti, P.Tanggal,P.KODECUST,C.NAMACUSTSUPP,P.NoPesanan,P.TGLJATUHTEMPO,P.TglKirim,
        sum(isnull(A.Qnt,0)) Qnt, sum(isnull(A.Qnt2,0)) Qnt2, sum(isnull(A.QntSPP,0))QntSpp, 
        sum(isnull(A.Qnt2SPP,0)) Qnt2Spp, sum(isnull(A.QntSisa,0)) QntSisa,  sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
	From    vwBrowsOutSO_SPP A
	Left Outer Join DBSO P on P.NoBukti=A.NoBukti
	Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCust and S.Sales=P.KODESLS
	Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
	Left outer join DBCUSTSUPP C on p.KODECUST = C.KODECUSTSUPP
	where A.islengkap=0 
	Group By A.nobukti,p.TANGGAL,P.KODECUST,C.NAMACUSTSUPP,P.NoPesanan,P.TGLJATUHTEMPO,P.TglKirim 
	order by A.NoBukti,p.TANGGAL,P.KODECUST,C.NAMACUSTSUPP 
end 
else if @Choice='B'
begin
	Select  A.KodeBrg,B.NAMABRG, P.Tanggal, 
        sum(isnull(A.Qnt,0)) Qnt, sum(isnull(A.Qnt2,0)) Qnt2, sum(isnull(A.QntSPP,0))QntSpp, 
        sum(isnull(A.Qnt2SPP,0)) Qnt2Spp, sum(isnull(A.QntSisa,0)) QntSisa,  sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
	From    vwBrowsOutSO_SPP A
	Left Outer Join DBSO P on P.NoBukti=A.NoBukti
	Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCust and S.Sales=P.KODESLS
	Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
	where A.islengkap=0 
	Group by A.KodeBrg,B.NAMABRG,P.TANGGAL
	order by A.KodeBrg,B.NAMABRG,P.TANGGAL
end
else if @Choice='C'
begin
	Select  p.KODECUST,C.NAMACUSTSUPP, P.Tanggal,
        sum(isnull(A.Qnt,0)) Qnt, sum(isnull(A.Qnt2,0)) Qnt2, sum(isnull(A.QntSPP,0))QntSpp, 
        sum(isnull(A.Qnt2SPP,0)) Qnt2Spp, sum(isnull(A.QntSisa,0)) QntSisa,  sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
	From    vwBrowsOutSO_SPP A
	Left Outer Join DBSO P on P.NoBukti=A.NoBukti
	Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCust and S.Sales=P.KODESLS
	Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
	Left Outer join DBCUSTSUPP C on p.KODECUST = C.KODECUSTSUPP
	where A.islengkap=0 
	Group by  p.KODECUST,C.NAMACUSTSUPP, P.Tanggal
	order by  p.KODECUST,C.NAMACUSTSUPP, P.Tanggal
end



GO

-- Procedure: Sp_ReportSPBACCDet
-- Created: 2013-06-24 10:36:54.877 | Modified: 2015-03-11 09:53:51.793
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportSPBACCDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt,
@IdUser Varchar(20),
@Tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by NoBukti,Tanggal
		If @NeedOto=2
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2
		  order by NoBukti,Tanggal 
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeBrg
		If @NeedOto=2
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg  
		end 
	else If @Ordr='C'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeCustSupp
		 If @NeedOto=2
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end 		
End
else
begin
   If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		If @NeedOto=2
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal 
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KODEBRG In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		If @NeedOto=2
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2
		  and KODEBRG In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg  
		end 
	else If @Ordr='C'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		 If @NeedOto=2
		  select * from VwReportSpBACC where Tanggal between @tgl1 and @tgl2 
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end
End




GO

-- Procedure: Sp_ReportSpbACCRek
-- Created: 2013-06-24 10:36:54.890 | Modified: 2013-06-24 10:37:43.807
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportSpbACCRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto Smallint
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
 If @NeedOto=0 or @NeedOto=1
	select 	B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	where A.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group By B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
	Order by B.NOBUKTI, A.Tanggal
ELSE If @NeedOto=2
	select 	B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	where A.Tanggal between @Tgl1 and @Tgl2 
	Group By B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
	Order by B.NOBUKTI, A.Tanggal
end
If @Choice='B'
begin
If @NeedOto=0 or @NeedOto=1
	select 	B.KodeBrg,E.NAMABRG ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.KODEBRG
	where A.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group By B.KodeBrg,E.NAMABRG ,A.Tanggal
	Order by B.KodeBrg,E.NAMABRG ,A.Tanggal
ELSE If @NeedOto=2
	select 	B.KodeBrg,E.NAMABRG ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.KODEBRG
	where A.Tanggal between @Tgl1 and @Tgl2 
	Group By B.KodeBrg,E.NAMABRG ,A.Tanggal
	Order by B.KodeBrg,E.NAMABRG ,A.Tanggal
end
If @Choice='C'
begin
 If @NeedOto=0 or @NeedOto=1
	select 	A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.NAMABRG
	where A.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group By A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
	Order by A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
else If @NeedOto=2
	select 	A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.NAMABRG
	where A.Tanggal between @Tgl1 and @Tgl2 
	Group By A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
	Order by A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
end

GO

-- Procedure: Sp_ReportSPBDet
-- Created: 2013-06-03 14:11:33.283 | Modified: 2015-03-11 09:53:51.817
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportSPBDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt,
@IdUser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by NoBukti,Tanggal
		If @NeedOto=2
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2
		  order by NoBukti,Tanggal 
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeBrg
		If @NeedOto=2
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg  
		end 
	else If @Ordr='C'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeCustSupp
		 If @NeedOto=2
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end 		
End
begin
If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@IdUser and Tipe=@Tipe)
		  order by NoBukti,Tanggal
		If @NeedOto=2
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2
		   and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal 
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		   and KODEBRG In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		If @NeedOto=2
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2
		   and KODEBRG In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg  
		end 
	else If @Ordr='C'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		   and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		 If @NeedOto=2
		  select * from VwReportSpB where Tanggal between @tgl1 and @tgl2 
		   and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end 
End





GO

-- Procedure: Sp_ReportSpbRek
-- Created: 2013-06-03 14:11:50.220 | Modified: 2013-06-03 14:11:50.220
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportSpbRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto Smallint
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
 If @NeedOto=0 or @NeedOto=1
	select 	B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	where A.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group By B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
	Order by B.NOBUKTI, A.Tanggal
ELSE If @NeedOto=2
	select 	B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	where A.Tanggal between @Tgl1 and @Tgl2 
	Group By B.NOBUKTI, A.Tanggal,A.KodeCustSupp,D.NAMACUSTSUPP
	Order by B.NOBUKTI, A.Tanggal
end
If @Choice='B'
begin
If @NeedOto=0 or @NeedOto=1
	select 	B.KodeBrg,E.NAMABRG ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.KODEBRG
	where A.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group By B.KodeBrg,E.NAMABRG ,A.Tanggal
	Order by B.KodeBrg,E.NAMABRG ,A.Tanggal
ELSE If @NeedOto=2
	select 	B.KodeBrg,E.NAMABRG ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.KODEBRG
	where A.Tanggal between @Tgl1 and @Tgl2 
	Group By B.KodeBrg,E.NAMABRG ,A.Tanggal
	Order by B.KodeBrg,E.NAMABRG ,A.Tanggal
end
If @Choice='C'
begin
 If @NeedOto=0 or @NeedOto=1
	select 	A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.NAMABRG
	where A.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
    Case when A.IsOtorisasi2=1 then 1 else 0 end+
    Case when A.IsOtorisasi3=1 then 1 else 0 end+
    Case when A.IsOtorisasi4=1 then 1 else 0 end+
    Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group By A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
	Order by A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
else If @NeedOto=2
	select 	A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal,
        Sum(isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2, Sum(isnull(B.NetW,0)) NetW, Sum(isnull(B.GrossW,0)) GrosW
	from	dbSPBDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPB A on B.NoBukti = A.NoBukti
	Left Outer Join DBCUSTSUPP D on A.KodeCustSupp = D.KODECUSTSUPP
	Left Outer join DBBARANG E on b.KodeBrg = E.NAMABRG
	where A.Tanggal between @Tgl1 and @Tgl2 
	Group By A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
	Order by A.KodeCustSupp,D.NAMACUSTSUPP ,A.Tanggal
end
--select * from dbSPBDet

GO

-- Procedure: Sp_reportSPBRJUALDet
-- Created: 2015-03-11 09:53:43.470 | Modified: 2015-03-11 09:53:51.710
-- =====================================================



CREATE Procedure [dbo].[Sp_reportSPBRJUALDet]  
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint,
@IDuser Varchar(20),
@tipe Varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
			select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		if @NeedOto=2
			select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  order by KodeBrg
		 if @NeedOto=2
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  order by KodeCustSupp
		if @NeedOto=2
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end
	else If @Ordr='S'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  order by KodeCustSupp
		 if @NeedOto=2
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end 	
		
End
else
begin
If @Ordr='N'
		begin
		  if @NeedOto=0 or @NeedOto=1
			select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			and NOBUKTI In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		if @NeedOto=2
			select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 
			and NOBUKTI In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  and KODEBRG In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg
		 if @NeedOto=2
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  and KODECUSTSUPP In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		if @NeedOto=2
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 
		  and KODECUSTSUPP In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end
	else If @Ordr='S'
		begin
		 if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
		  and KODECUSTSUPP In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		 if @NeedOto=2
		  select * from VwReportSPBRJual where Tanggal between @tgl1 and @tgl2 
		  and KODECUSTSUPP In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		end 	
		
End



GO

-- Procedure: Sp_ReportSPPBDet
-- Created: 2013-01-30 15:53:10.153 | Modified: 2013-01-30 15:57:21.980
-- =====================================================
CREATE Procedure [dbo].[Sp_ReportSPPBDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportSPpb where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportSPpb where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportSpPb where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 
End
GO

-- Procedure: Sp_ReportSPPBRek
-- Created: 2013-01-30 15:53:29.493 | Modified: 2013-02-01 13:20:16.460
-- =====================================================
CREATE Procedure [dbo].[Sp_ReportSPPBRek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='B',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
	 Select A.NoBukti,C.Tanggal,C.KodeCustSupp,D.NAMACUSTSUPP,
	 Sum(isnull(A.QNT,0))QNT,SUM(Isnull(A.QNT2,0)) Qnt2,
	 Sum(ISNULL(A.NetW,0)) NetW,SUM(Isnull(GrossW,0)) Grossw
	 from dbSPBDet A
     left outer join DBBARANG B on B.KODEBRG=A.Kodebrg
     Left Outer join dbSPB C on A.NoBukti = C.NoBukti
     Left Outer join DBCUSTSUPP D on c.KodeCustSupp = D.KODECUSTSUPP
     Group By A.NoBukti,C.Tanggal,C.KodeCustSupp,D.NAMACUSTSUPP
     order BY A.NoBukti,C.Tanggal
end     
If @Choice='B'
Begin
	 Select A.KodeBrg,B.NAMABRG,C.Tanggal,Sum(isnull(A.QNT,0))QNT,SUM(Isnull(A.QNT2,0)) Qnt2,
	 Sum(ISNULL(A.NetW,0)) NetW,SUM(Isnull(GrossW,0)) Grossw
	 from dbSPBDet A
     left outer join DBBARANG B on B.KODEBRG=A.Kodebrg
     Left Outer join dbSPB C on A.NoBukti = C.NoBukti
     Left Outer join DBCUSTSUPP D on c.KodeCustSupp = D.KODECUSTSUPP
     Group By A.KodeBrg,B.NAMABRG,C.Tanggal
     order BY A.KodeBrg,B.NAMABRG,C.Tanggal
end  
If @Choice='C'
Begin
	 Select C.KodeCustSupp,D.NAMACUSTSUPP,C.Tanggal,Sum(isnull(A.QNT,0))QNT,SUM(Isnull(A.QNT2,0)) Qnt2,
	 Sum(ISNULL(A.NetW,0)) NetW,SUM(Isnull(GrossW,0)) Grossw
	 from dbSPBDet A
     left outer join DBBARANG B on B.KODEBRG=A.Kodebrg
     Left Outer join dbSPB C on A.NoBukti = C.NoBukti
     Left Outer join DBCUSTSUPP D on c.KodeCustSupp = D.KODECUSTSUPP
     Group By C.KodeCustSupp,D.NAMACUSTSUPP,C.Tanggal
     order BY C.KodeCustSupp,D.NAMACUSTSUPP,C.Tanggal
end       
         


GO

-- Procedure: Sp_ReportSppDet
-- Created: 2013-06-03 14:08:37.403 | Modified: 2015-03-11 09:53:51.860
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportSppDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint,
@IDuser varchar(20),
@Tipe varchar(20)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by NoBukti,Tanggal
		else If @NeedOto=2
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 
		  order by NoBukti,Tanggal  
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeBrg,TglKirim
		else If @NeedOto=2
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2
		  order by KodeBrg,TglKirim
		end 
	else If @Ordr='C'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  order by KodeCustSupp
		If @NeedOto=2
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 
		  order by KodeCustSupp
		end 
End
else
begin
If @Ordr='N'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and NoBukti In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by NoBukti,Tanggal
		else If @NeedOto=2
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 
		  order by NoBukti,Tanggal  
		end 
	else If @Ordr='B'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KODEBRG In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg,TglKirim
		else If @NeedOto=2
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeBrg,TglKirim
		end 
	else If @Ordr='C'
		begin
		If @NeedOto=0 or @NeedOto=1
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2 and NeedOtorisasi=@NeedOto
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE)
		  order by KodeCustSupp
		If @NeedOto=2
		  select * from VwReportSPP where Tanggal between @tgl1 and @tgl2
		  and KodeCustSupp In (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@tIPE) 
		  order by KodeCustSupp
		end 
End



GO

-- Procedure: Sp_ReportSppRek
-- Created: 2013-06-03 14:08:54.287 | Modified: 2013-06-03 14:08:54.287
-- =====================================================

CREATE Procedure [dbo].[Sp_ReportSppRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime,
@NeedOto SmallInt
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
 if @NeedOto=0 or @NeedOto=1
	select 	B.NOBUKTI,D.Tanggal,D.TglKirim,Sum(Isnull(B.NetW,0)) NetW,SUM(isnull(B.GrossW,0)) GrosW,
        Sum(Isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2,D.KodeCustSupp,E.NAMACUSTSUPP
	from	dbSPPDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPP D on B.NoBukti = D.NoBukti
	Left Outer join DBCUSTSUPP E on D.KodeCustSupp = E.KODECUSTSUPP
	where D.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when D.IsOtorisasi1=1 then 1 else 0 end+
    Case when D.IsOtorisasi2=1 then 1 else 0 end+
    Case when D.IsOtorisasi3=1 then 1 else 0 end+
    Case when D.IsOtorisasi4=1 then 1 else 0 end+
    Case when D.IsOtorisasi5=1 then 1 else 0 end=D.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group by  B.NOBUKTI,D.Tanggal,D.TglKirim,D.KodeCustSupp,E.NAMACUSTSUPP
	Order by B.NOBUKTI,D.Tanggal
else if @NeedOto=2
	select 	B.NOBUKTI,D.Tanggal,D.TglKirim,Sum(Isnull(B.NetW,0)) NetW,SUM(isnull(B.GrossW,0)) GrosW,
        Sum(Isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2,D.KodeCustSupp,E.NAMACUSTSUPP
	from	dbSPPDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPP D on B.NoBukti = D.NoBukti
	Left Outer join DBCUSTSUPP E on D.KodeCustSupp = E.KODECUSTSUPP
	where D.Tanggal between @Tgl1 and @Tgl2
	Group by  B.NOBUKTI,D.Tanggal,D.TglKirim,D.KodeCustSupp,E.NAMACUSTSUPP
	Order by B.NOBUKTI,D.Tanggal
End 
else If @Choice='B'
begin
 If @NeedOto=0 or @NeedOto=1
	select B.KodeBrg,C.NAMABRG,D.Tanggal,
        Sum(Isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2
	from	dbSPPDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPP D on B.NoBukti = D.NoBukti
	Left Outer join DBCUSTSUPP E on D.KodeCustSupp = E.KODECUSTSUPP
	where D.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when D.IsOtorisasi1=1 then 1 else 0 end+
    Case when D.IsOtorisasi2=1 then 1 else 0 end+
    Case when D.IsOtorisasi3=1 then 1 else 0 end+
    Case when D.IsOtorisasi4=1 then 1 else 0 end+
    Case when D.IsOtorisasi5=1 then 1 else 0 end=D.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group by B.KodeBrg,C.NAMABRG,D.Tanggal
	Order by B.KodeBrg,C.NAMABRG,D.Tanggal
else If @NeedOto=2
	select B.KodeBrg,C.NAMABRG,D.Tanggal,
        Sum(Isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2
	from	dbSPPDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPP D on B.NoBukti = D.NoBukti
	Left Outer join DBCUSTSUPP E on D.KodeCustSupp = E.KODECUSTSUPP
	where D.Tanggal between @Tgl1 and @Tgl2 
	Group by B.KodeBrg,C.NAMABRG,D.Tanggal
	Order by B.KodeBrg,C.NAMABRG,D.Tanggal
End
else If @Choice='C'
begin
	If @NeedOto=0 or @NeedOto=1
	select D.KodeCustSupp,E.NAMACUSTSUPP,D.Tanggal,
        Sum(Isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2
	from	dbSPPDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPP D on B.NoBukti = D.NoBukti
	Left Outer join DBCUSTSUPP E on D.KodeCustSupp = E.KODECUSTSUPP
	where D.Tanggal between @Tgl1 and @Tgl2 and       
	Cast(Case when Case when D.IsOtorisasi1=1 then 1 else 0 end+
    Case when D.IsOtorisasi2=1 then 1 else 0 end+
    Case when D.IsOtorisasi3=1 then 1 else 0 end+
    Case when D.IsOtorisasi4=1 then 1 else 0 end+
    Case when D.IsOtorisasi5=1 then 1 else 0 end=D.MaxOL then 0
    else 1
    end As Bit)= @Needoto
	Group by D.KodeCustSupp,E.NAMACUSTSUPP,D.Tanggal
	Order by D.KodeCustSupp,E.NAMACUSTSUPP,D.Tanggal
else If @NeedOto=2
	select D.KodeCustSupp,E.NAMACUSTSUPP,D.Tanggal,
        Sum(Isnull(B.QNT,0)) Qnt, Sum(isnull(B.QNT2,0)) Qnt2
	from	dbSPPDet B
	left outer join dbBarang C on C.KodeBrg=B.KodeBrg
	Left Outer join dbSPP D on B.NoBukti = D.NoBukti
	Left Outer join DBCUSTSUPP E on D.KodeCustSupp = E.KODECUSTSUPP
	where D.Tanggal between @Tgl1 and @Tgl2 
	Group by D.KodeCustSupp,E.NAMACUSTSUPP,D.Tanggal
	Order by D.KodeCustSupp,E.NAMACUSTSUPP,D.Tanggal
End





GO

-- Procedure: Sp_ReportSPPxDet
-- Created: 2013-01-30 14:02:12.267 | Modified: 2013-01-30 14:02:12.267
-- =====================================================
create Procedure [dbo].[Sp_ReportSPPxDet]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportSppx where Tanggal between @tgl1 and @tgl2 order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportSppx where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
	else If @Ordr='C'
		begin
		  select * from VwReportSppx where Tanggal between @tgl1 and @tgl2 order by KodeCustSupp
		end 		
End
GO

-- Procedure: Sp_ReportSppxRek
-- Created: 2013-01-30 14:17:15.840 | Modified: 2013-02-01 10:17:09.737
-- =====================================================
CREATE Procedure [dbo].[Sp_ReportSppxRek]
@Choice Varchar (2),
@Tgl1 Datetime,
@Tgl2 Datetime
as
--Declare @Choice varchar(2),@Tgl1 Datetime,@tgl2 datetime
--select @Tgl1='01/01/2012',@tgl2='07/17/2013',@Choice='B'

If @Choice='N'
begin
		Select   A.Nobukti, P.Tanggal,P.KodeCustSupp,x.NAMACUSTSUPP,P.TglKirim,
        Case when A.NoSat=1 then sum(isnull(A.Qnt,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2,0))
             else 0
        end Qnt, sum(isnull(A.Qnt2,0)) Qnt2,
        Case when A.NoSat=1 then sum(isnull(A.QntSPB,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2SPB,0))
             else 0
        end QntSPB,sum(isnull(A.Qnt2SPB,0)) Qnt2SPB,
        Case when A.NoSat=1 then sum(isnull(A.QntSisa,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2Sisa,0))
             else 0
        end QntSisa, sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
		From    vwBrowsOutSPP A
		Left Outer Join dbSPP P on P.NoBukti=A.NoBukti
		left Outer join DBSO SO on SO.NOBUKTI=A.noso
		Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCustSupp and s.Sales=SO.KODESLS
		Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
		Left Outer Join DBCUSTSUPP x on So.KODECUST=x.KODECUSTSUPP
		where A.isclose=0 
		Group by A.Nobukti, P.Tanggal,A.NoSat,P.KodeCustSupp,x.NAMACUSTSUPP,P.TglKirim
		Order By A.Nobukti, P.Tanggal
End
else If @Choice='B'
begin
		Select   A.KodeBrg,B.NAMABRG, P.Tanggal,
        Case when A.NoSat=1 then sum(isnull(A.Qnt,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2,0))
             else 0
        end Qnt, sum(isnull(A.Qnt2,0)) Qnt2,
        Case when A.NoSat=1 then sum(isnull(A.QntSPB,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2SPB,0))
             else 0
        end QntSPB,sum(isnull(A.Qnt2SPB,0)) Qnt2SPB,
        Case when A.NoSat=1 then sum(isnull(A.QntSisa,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2Sisa,0))
             else 0
        end QntSisa, sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
		From    vwBrowsOutSPP A
		Left Outer Join dbSPP P on P.NoBukti=A.NoBukti
		left Outer join DBSO SO on SO.NOBUKTI=A.noso
		Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCustSupp and s.Sales=SO.KODESLS
		Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
		where A.isclose=0 
		Group by  A.KodeBrg,B.NAMABRG, P.Tanggal,A.NoSat
		Order By  A.KodeBrg,B.NAMABRG, P.Tanggal
End
else If @Choice='C'
begin
		Select  P.KodeCustSupp,S.namaCust NamaCustSupp, P.Tanggal,
        Case when A.NoSat=1 then sum(isnull(A.Qnt,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2,0))
             else 0
        end Qnt, sum(isnull(A.Qnt2,0)) Qnt2,
        Case when A.NoSat=1 then sum(isnull(A.QntSPB,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2SPB,0))
             else 0
        end QntSPB,sum(isnull(A.Qnt2SPB,0)) Qnt2SPB,
        Case when A.NoSat=1 then sum(isnull(A.QntSisa,0))
             when A.NoSat=2 then sum(isnull(A.Qnt2Sisa,0))
             else 0
        end QntSisa, sum(isnull(A.Qnt2Sisa,0)) Qnt2Sisa
		From    vwBrowsOutSPP A
		Left Outer Join dbSPP P on P.NoBukti=A.NoBukti
		left Outer join DBSO SO on SO.NOBUKTI=A.noso
		Left Outer Join vwBrowsCustomer S on S.KodeCust=P.KodeCustSupp and s.Sales=SO.KODESLS
		Left Outer Join dbBarang B on B.KodeBrg=A.KodeBrg
		where A.isclose=0 
		Group by  P.KodeCustSupp,S.namaCust, P.Tanggal,A.NoSat
		Order By  P.KodeCustSupp,S.namaCust, P.Tanggal
End

GO

-- Procedure: Sp_ReportSPRK
-- Created: 2013-06-03 14:18:11.583 | Modified: 2013-06-03 14:18:11.583
-- =====================================================



CREATE Procedure [dbo].[Sp_ReportSPRK]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto Smallint
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpRk where Tanggal between @tgl1 and @tgl2 And NeeDOtoRisasi=@NeedOto
		  order by NoBukti,Tanggal
		else if @NeedOto=2
		  select * from VwReportSpRk where Tanggal between @tgl1 and @tgl2
		  order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		if @NeedOto=0 or @NeedOto=1
		  select * from VwReportSpRk where Tanggal between @tgl1 and @tgl2 And NeeDOtoRisasi=@NeedOto
		  order by KodeBrg,NamaBrg
		else if @NeedOto=2
		  select * from VwReportSpRk where Tanggal between @tgl1 and @tgl2 
		  order by KodeBrg,NamaBrg
		end 
		
End

GO

-- Procedure: Sp_reportSPRKRek
-- Created: 2013-06-03 14:22:25.830 | Modified: 2013-06-03 14:22:25.830
-- =====================================================


CREATE  Procedure [dbo].[Sp_reportSPRKRek]
@Choice varchar(1),
@Tgl1 datetime,
@Tgl2 Datetime,
@Needoto SmallInt
as
--Declare @Choice varchar(1),@tgl1 Datetime,@Tgl2 DateTime
--select @Choice='B',@Tgl1='10/10/2011',@tgl2='01/29/2012'

If @Choice = 'N'
begin
 If @Needoto=0 or @Needoto=1
	Select 	A.Tanggal,B.NoBukti,B.SATUAN,B.KODEBRG,H.NAMABRG, 
	Sum(isnull(B.Qnt,0)) Qnt
	From dbSPKDet B 
	Left Outer Join DbSPK A on  B.nobukti = A.nobukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg 
	Where a.Tanggal between @tgl1 and @tgl2 
	 And Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@Needoto
	Group By 	A.Tanggal,B.NoBukti,B.SATUAN,B.KODEBRG,H.NAMABRG
	Order By 	B.NoBukti,A.Tanggal,B.Satuan,B.KODEBRG,H.NAMABRG
else If @Needoto=2
	Select 	A.Tanggal,B.NoBukti,B.SATUAN,B.KODEBRG,H.NAMABRG, 
	Sum(isnull(B.Qnt,0)) Qnt
	From dbSPKDet B 
	Left Outer Join DbSPK A on  B.nobukti = A.nobukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg 
	Where a.Tanggal between @tgl1 and @tgl2 
	Group By 	A.Tanggal,B.NoBukti,B.SATUAN,B.KODEBRG,H.NAMABRG
	Order By 	B.NoBukti,A.Tanggal,B.Satuan,B.KODEBRG,H.NAMABRG
end
else if  @Choice = 'B'
begin
If @Needoto=0 or @Needoto=1
	Select 	A.Tanggal, B.KodeBrg, H.NamaBrg,B.SATUAN,
	Sum(isnull(B.Qnt,0)) Qnt
	From dbSPKDet B 
	Left Outer Join DbSPK A on  B.nobukti = A.nobukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg 
	Where a.Tanggal between @tgl1 and @tgl2
	 And Cast(Case when Case when A.IsOtorisasi1=1 then 1 else 0 end+
                      Case when A.IsOtorisasi2=1 then 1 else 0 end+
                      Case when A.IsOtorisasi3=1 then 1 else 0 end+
                      Case when A.IsOtorisasi4=1 then 1 else 0 end+
                      Case when A.IsOtorisasi5=1 then 1 else 0 end=A.MaxOL then 0
                 else 1
            end As Bit)=@Needoto
	Group By 	A.Tanggal, B.KodeBrg, H.NamaBrg,B.SATUAN
	Order By 	 B.KodeBrg, H.NamaBrg,A.Tanggal,B.SATUAN 
else If @Needoto=2
	Select 	A.Tanggal, B.KodeBrg, H.NamaBrg,B.SATUAN,
	Sum(isnull(B.Qnt,0)) Qnt
	From dbSPKDet B 
	Left Outer Join DbSPK A on  B.nobukti = A.nobukti
	Left Outer join dbBarang H on H.KodeBrg=b.KodeBrg 
	Where a.Tanggal between @tgl1 and @tgl2
	Group By 	A.Tanggal, B.KodeBrg, H.NamaBrg,B.SATUAN
	Order By 	 B.KodeBrg, H.NamaBrg,A.Tanggal,B.SATUAN 
end



GO

-- Procedure: Sp_ReportStock
-- Created: 2011-12-20 23:39:59.120 | Modified: 2011-12-20 23:39:59.120
-- =====================================================
Create Procedure dbo.Sp_ReportStock
@bulan int, @tahun int, @kodegdg varchar(15), @nosat int
as
--Select @bulan=1, @tahun=2011, @kodegdg='A', @nosat=1
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
Select a.bulan,a.tahun,a.kodegdg,a.kodebrg,       
       b.NAMABRG, c.NAMA Namagdg,
       b.KodeKelompok, d.Keterangan NamaKelompok, 
       b.KodeKategori, e.Keterangan NamaKategori, 
       b.KodeSubKategori, f.Keterangan NamaSubKategori, 
       b.KodeJnsBrg, g.Keterangan NamaJenis, 
       b.kodesubJnsBrg, h.Keterangan NamaSubjenis,
       Case when @nosat=1 then b.SAT1 else b.Sat2 end Satuan,
       Case when @nosat=1 then a.QNTAWAL else a.QNT2AWAL end QntAwal,
       Case when @nosat=1 then a.QNTBPPB else a.QNT2BPPB end QntBPPB,
       Case when @nosat=1 then a.QNTBatalBPPB else a.QNT2BatalBPPB end QntBatalBPPB,
       Case when @nosat=1 then a.QNTBPB else a.QNT2BPB end QntBPB,
       Case when @nosat=1 then a.QNTRBPB else a.QNT2RBPB end QntRBPB,
       Case when @nosat=1 then a.QNTPPL else a.QNT2PPL end QntPPL,
       Case when @nosat=1 then a.QNTBPL else a.QNT2BPL end QntBPL,
       Case when @nosat=1 then a.QNTSPRK else a.QNT2SPRK end QntSPRK,
       Case when @nosat=1 then a.QNTBSPRK else a.QNT2BSPRK end QntBSPRK,
       Case when @nosat=1 then a.QNTSPAT else a.QNT2SPAT end QntSPAT,
       Case when @nosat=1 then a.QNTPO else a.QNT2PO end QntPO,
       Case when @nosat=1 then a.QNTBPO else a.QNT2BPO end QntBPO,
       Case when @nosat=1 then a.QNTPBL else a.QNT2PBL end QntPBL,
       Case when @nosat=1 then a.QNTINS else a.QNT2INS end QntINS,
       Case when @nosat=1 then a.QNTKNS else a.QNT2KNS end QntKNS,
       Case when @nosat=1 then a.QNTRPB else a.QNT2RPB end QntRPB,
       Case when @nosat=1 then a.QNTPNJ else a.QNT2PNJ end QntPNJ,
       Case when @nosat=1 then a.QNTRPJ else a.QNT2RPJ end QntRPJ,
       Case when @nosat=1 then a.QNTPRJ else a.QNT2PRJ end QntPRJ,
       Case when @nosat=1 then a.QNTADI else a.QNT2ADI end QntADI,
       Case when @nosat=1 then a.QNTADO else a.QNT2ADO end QntADO,
       Case when @nosat=1 then a.QNTUKI else a.QNT2UKI end QntUKI,
       Case when @nosat=1 then a.QNTUKO else a.QNT2UKO end QntUKO,
       Case when @nosat=1 then a.QNTTRI else a.QNT2TRO end QntTRO,
       Case when @nosat=1 then a.QNTBHNIn else a.QNT2BHNIn end QntBHNIn,
       Case when @nosat=1 then a.QNTBHNOut else a.QNT2BHNOut end QntBHNOut,
       Case when @nosat=1 then a.QNTBHNIn else a.QNT2BHNIn end QntBHNIn,
       Case when @nosat=1 then a.QNTIN else a.QNT2IN end QntIN,
       Case when @nosat=1 then a.QNTOUT else a.QNT2OUT end QntOUT,
       Case when @nosat=1 then a.SALDOQNT else a.SALDOQNT2 end SaldoQnt,
       a.HRGAWAL,a.HRGBPPB,a.HRGBatalBPPB,a.HRGBPB,a.HRGRBPB,a.HRGPPL,a.HRGBPL,
       a.HRGSPRK,a.HRGBSPRK,a.HRGSPAT,a.HRGPO,a.HRGBPO,a.HRGPBL,a.HRGINS,a.HRGKNS,
       a.HRGRPB,a.HRGPNJ,a.HRGRPJ,a.HRGPRJ,a.HRGADI,a.HRGADO,a.HRGUKI,a.HRGUKO,
       a.HRGTRI,a.HRGTRO,a.HRGBHNIn,a.HRGBHNOut,a.HRGRATA,a.HRGPRO,
       a.SALDORP
from DBSTOCKBRG a
     left outer join DBBARANG b on b.KODEBRG=a.KODEBRG and b.Kodegdg=a.KODEGDG
     left outer join DBGUDANG c on c.KODEGDG=a.KODEGDG
     left outer join DBKELOMPOK d on d.KodeKelompok=b.KodeKelompok
     left outer join DBKATEGORI e on e.KodeKategori=b.KodeKategori
     left outer join DBSUBKATEGORI f on f.KodeSubKategori=b.KodeSubKategori and f.KodeKategori=b.KodeKategori
     left outer join DBJenis g on g.KodeJnsBrg=b.KodeJnsBrg
     left outer join DBSUBJENIS h on h.kodesubJnsBrg=b.kodesubJnsBrg and h.KodeJnsBrg=b.KodeJnsBrg
where a.BULAN=@bulan and a.TAHUN=@tahun and a.KODEGDG like @kodegdg
Order by b.KodeKelompok,b.KodeKategori,a.KODEBRG
GO

-- Procedure: Sp_ReportStockAkhir
-- Created: 2013-04-23 13:18:53.350 | Modified: 2013-04-23 13:18:53.350
-- =====================================================

Create Procedure [dbo].[Sp_ReportStockAkhir]
--Declare 
@Nosat integer,
@tanggal datetime,
@KOdegdg varchar(20)

--select @Nosat=1,@tanggal='01/01/2014',@KOdegdg='' 
as
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
select A.KodeBrg, B.NamaBrg,
case when @Nosat=1 then B.Sat1 
	 when @nosat=2 then B.SAT2 
	 when @Nosat=3 then B.SAT3 end Sat1, 
	 A.KodeGdg, C.Nama NamaGdg, 
 	 A.SALDOQNT/case when @Nosat=1 then B.ISI1 
				when @nosat=2 then B.ISI2 when 
				@Nosat=3 then B.ISI3 end SALDOQNT 
from 
(
select 	KodeBrg, KodeGdg, sum(SaldoQnt) SaldoQnt 
from 
(  
select        KodeBrg, KodeGdg, QntAwal SaldoQnt 
from 	dbStockBrg 
where         Tahun=2013 and Bulan=1 
and KodeGdg like @KOdegdg
union all 
select 	KodeBrg, KodeGdg, 
	sum(case when Tipe in ('PBL','RPJ','ADI','TRI','UKI') then Qnt else 1*Qnt end) SaldoQnt 
from 	vwKartuStock 
where 	year(Tanggal)=2013 and Tanggal<=@tanggal
and KodeGdg like @kodegdg
group by KodeBrg, KodeGdg 
) X 
group by KodeBrg, KodeGdg 
) A
left outer join dbBarang B on B.KodeBrg=A.KodeBrg 
left outer join dbGudang C on C.KodeGdg=A.KodeGdg 
where A.SALDOQNT<>0
order by  A.KodeBrg, A.KodeGdg 


--select * from DBBARANG

GO

-- Procedure: Sp_ReportStockBrg
-- Created: 2011-12-20 23:40:11.647 | Modified: 2011-12-20 23:44:41.330
-- =====================================================
CREATE Procedure dbo.Sp_ReportStockBrg
@bulan int, @tahun int, @kodegdg varchar(15), @nosat int
as
--Select @bulan=1, @tahun=2011, @kodegdg='A', @nosat=1
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
Select a.bulan,a.tahun,a.kodegdg,a.kodebrg,       
       b.NAMABRG, c.NAMA Namagdg,
       b.KodeKelompok, d.Keterangan NamaKelompok, 
       b.KodeKategori, e.Keterangan NamaKategori, 
       b.KodeSubKategori, f.Keterangan NamaSubKategori, 
       b.KodeJnsBrg, g.Keterangan NamaJenis, 
       b.kodesubJnsBrg, h.Keterangan NamaSubjenis,
       Case when @nosat=1 then b.SAT1 else b.Sat2 end Satuan,
       Case when @nosat=1 then a.QNTAWAL else a.QNT2AWAL end QntAwal,
       Case when @nosat=1 then a.QNTBPPB else a.QNT2BPPB end QntBPPB,
       Case when @nosat=1 then a.QNTBatalBPPB else a.QNT2BatalBPPB end QntBatalBPPB,
       Case when @nosat=1 then a.QNTBPB else a.QNT2BPB end QntBPB,
       Case when @nosat=1 then a.QNTRBPB else a.QNT2RBPB end QntRBPB,
       Case when @nosat=1 then a.QNTPPL else a.QNT2PPL end QntPPL,
       Case when @nosat=1 then a.QNTBPL else a.QNT2BPL end QntBPL,
       Case when @nosat=1 then a.QNTSPRK else a.QNT2SPRK end QntSPRK,
       Case when @nosat=1 then a.QNTBSPRK else a.QNT2BSPRK end QntBSPRK,
       Case when @nosat=1 then a.QNTSPAT else a.QNT2SPAT end QntSPAT,
       Case when @nosat=1 then a.QNTPO else a.QNT2PO end QntPO,
       Case when @nosat=1 then a.QNTBPO else a.QNT2BPO end QntBPO,
       Case when @nosat=1 then a.QNTPBL else a.QNT2PBL end QntPBL,
       Case when @nosat=1 then a.QNTINS else a.QNT2INS end QntINS,
       Case when @nosat=1 then a.QNTKNS else a.QNT2KNS end QntKNS,
       Case when @nosat=1 then a.QNTRPB else a.QNT2RPB end QntRPB,
       Case when @nosat=1 then a.QNTPNJ else a.QNT2PNJ end QntPNJ,
       Case when @nosat=1 then a.QNTRPJ else a.QNT2RPJ end QntRPJ,
       Case when @nosat=1 then a.QNTPRJ else a.QNT2PRJ end QntPRJ,
       Case when @nosat=1 then a.QNTADI else a.QNT2ADI end QntADI,
       Case when @nosat=1 then a.QNTADO else a.QNT2ADO end QntADO,
       Case when @nosat=1 then a.QNTUKI else a.QNT2UKI end QntUKI,
       Case when @nosat=1 then a.QNTUKO else a.QNT2UKO end QntUKO,
       Case when @nosat=1 then a.QNTTRI else a.QNT2TRI end QntTRI,
       Case when @nosat=1 then a.QNTTRO else a.QNT2TRO end QntTRO,
       Case when @nosat=1 then a.QNTBHNIn else a.QNT2BHNIn end QntBHNIn,
       Case when @nosat=1 then a.QNTBHNOut else a.QNT2BHNOut end QntBHNOut,
       Case when @nosat=1 then a.QNTBHNIn else a.QNT2BHNIn end QntBHNIn,
       Case when @nosat=1 then a.QNTPRO else a.QNT2PRO end QntPRO,
       Case when @nosat=1 then a.QNTIN else a.QNT2IN end QntIN,
       Case when @nosat=1 then a.QNTOUT else a.QNT2OUT end QntOUT,
       Case when @nosat=1 then a.SALDOQNT else a.SALDOQNT2 end SaldoQnt,
       a.HRGAWAL,a.HRGBPPB,a.HRGBatalBPPB,a.HRGBPB,a.HRGRBPB,a.HRGPPL,a.HRGBPL,
       a.HRGSPRK,a.HRGBSPRK,a.HRGSPAT,a.HRGPO,a.HRGBPO,a.HRGPBL,a.HRGINS,a.HRGKNS,
       a.HRGRPB,a.HRGPNJ,a.HRGRPJ,a.HRGPRJ,a.HRGADI,a.HRGADO,a.HRGUKI,a.HRGUKO,
       a.HRGTRI,a.HRGTRO,a.HRGBHNIn,a.HRGBHNOut,a.HRGRATA,a.HRGPRO,
       a.SALDORP
from DBSTOCKBRG a
     left outer join DBBARANG b on b.KODEBRG=a.KODEBRG and b.Kodegdg=a.KODEGDG
     left outer join DBGUDANG c on c.KODEGDG=a.KODEGDG
     left outer join DBKELOMPOK d on d.KodeKelompok=b.KodeKelompok
     left outer join DBKATEGORI e on e.KodeKategori=b.KodeKategori
     left outer join DBSUBKATEGORI f on f.KodeSubKategori=b.KodeSubKategori and f.KodeKategori=b.KodeKategori
     left outer join DBJenis g on g.KodeJnsBrg=b.KodeJnsBrg
     left outer join DBSUBJENIS h on h.kodesubJnsBrg=b.kodesubJnsBrg and h.KodeJnsBrg=b.KodeJnsBrg
where a.BULAN=@bulan and a.TAHUN=@tahun and a.KODEGDG like @kodegdg
Order by b.KodeKelompok,b.KodeKategori,a.KODEBRG

select * from DBSTOCKBRG
GO

-- Procedure: Sp_ReportStockFisikGudang
-- Created: 2013-05-13 12:11:46.597 | Modified: 2013-05-13 12:11:46.597
-- =====================================================


Create procedure [dbo].[Sp_ReportStockFisikGudang]
--Declare 
@tanggal datetime,
@KOdegdg varchar(20)
--select @tanggal='12/01/2013',@KOdegdg='' 
as
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
select A.KodeGdg, C.Nama NamaGdg, B.KodeSupp, B.KodeGrp, A.KodeBrg, B.NamaBrg, 
  B.Sat3, B.Isi3, B.Sat2, B.Isi2, B.Sat1, B.Isi1, 
  A.SALDOQNT, cast(A.SALDOQNT as int)/cast(B.Isi3 as int) SALDO3QNT, 
  (cast(A.SALDOQNT as int) % cast(B.Isi3 as int))/cast(B.Isi2 as int) SALDO2QNT, 
  (cast(A.SALDOQNT as int) % cast(B.Isi2 as int)) SALDO1QNT 
from 
(
select 	KodeBrg, KodeGdg, sum(SaldoQnt) SaldoQnt 
from 
(  
select        KodeBrg, KodeGdg, QntAwal SaldoQnt 
from 	dbStockBrg 
where         Tahun=YEAR(@tanggal) and Bulan=1 and KODEGDG like @KOdegdg
union all 
select 	KodeBrg, KodeGdg, 
	sum(case when Tipe in ('PBL','RPJ','ADI','TRI','UKI') then Qnt else -1*Qnt end) SaldoQnt 
from 	vwKartuStock 
where 	year(Tanggal)=@tanggal and Tanggal<=@tanggal and KODEGDG like @KOdegdg
group by KodeBrg, KodeGdg 
) X 
group by KodeBrg, KodeGdg 
) A
left outer join dbBarang B on B.KodeBrg=A.KodeBrg 
left outer join dbGudang C on C.KodeGdg=A.KodeGdg 
Left Outer JOin DbGroup D on b.kodegrp = d.kodegrp
order by A.KodeGdg, B.KodeSupp, B.KodeGrp, A.KodeBrg


GO

-- Procedure: SP_ReportStockHarian
-- Created: 2013-01-30 09:15:09.763 | Modified: 2013-04-05 09:58:25.880
-- =====================================================


CREATE Procedure [dbo].[SP_ReportStockHarian]
@awal datetime,
@akhir datetime,
@gudang varchar(15),
@nosat integer
as
--declare @awal datetime,@akhir datetime,@gudang varchar(15),@nosat integer
--select @awal='07/01/2012',@akhir='07/31/2012',@nosat=1,@gudang='g001'
Set @Gudang=Case when @gudang in ('','-') then '%' else @gudang end

select A.KodeBrg, B.NamaBrg, Case when @nosat=1 Then B.Sat1 else B.SAT2 end Sat1, A.KodeGdg, C.Nama NamaGdg, 
  A.QNTAWAL   QntAwal, 
  A.QNTPBL   QNTPBL, 
  A.QNTRPB   QNTRPB, 
  A.QNTPNJ   QNTPNJ, 
  A.QNTRPJ   QNTRPJ, 
  A.QNTADI   QNTADI, 
  A.QNTADO   QNTADO, 
  A.QNTUKI   QNTUKI, 
  A.QNTUKO   QNTUKO, 
  A.QNTTRI   QNTTRI, 
  A.QNTTRO   QNTTRO, 
  A.SALDOQNT   SALDOQNT, 
  (A.QNTAWAL  ) +
  (A.QNTPBL  ) -
  (A.QNTRPB  ) AS TOTALSTOCK,
  (A.QNTPNJ  ) - 
  (A.QNTRPJ  ) AS SELLOUTNET,
  ((A.QNTAWAL  ) + 
  (A.QNTPBL  ) - 
  (A.QNTRPB  )) - 
  ((A.QNTPNJ  ) - 
  (A.QNTRPJ  )) AS FINALSTOCK
from 
(
select 	KodeBrg, KodeGdg, sum(QntAwal) QntAwal, sum(QntPBL) QntPBL, sum(QntRBP) QntRBP, 
	sum(QntPNJ) QntPNJ, sum(QntRPJ) QntRPJ, sum(QntADI) QntADI, sum(QntADO) QntADO, 
	sum(QntTRI) QntTRI, sum(QntTRO) QntTRO, sum(QntUKI) QntUKI, sum(QntUKO) QntUKO,SUM(QntBPSBIN)QntBPSBIN,SUM(QntBPSBOUT)QntBPSBOUT,
	sum(QntPB)QntPB,Sum(QntRPB)QntRPB, sum(SaldoQnt) SaldoQnt 
from 
(  
/*select        KodeBrg, KodeGdg, QntAwal, 0 QntPBL, 0 QntRPB, 0 QntPNJ, 0 QntRPJ, 
	0 QntADI, 0 QntADO, 0 QntTRI, 0 QntTRO, 0 QntUKI, 0 QntUKO, QntAwal SaldoQnt 
from 	dbStockBrg 
where  Tahun=year(@awal) and Bulan=MONTH(@awal) and KodeGdg=@gudang

union all 
select 	KodeBrg, KodeGdg, 
	sum(case when Tipe in ('PBL','RPJ','ADI','TRI','UKI','HP','BPSB IN') then Qnt else -1*Qnt end) QntAwal, 
	0 QntPBL, 0 QntRPB, 0 QntPNJ, 0 QntRPJ, 
	0 QntADI, 0 QntADO, 0 QntTRI, 0 QntTRO, 0 QntUKI, 0 QntUKO, 
	sum(case when Tipe in ('PBL','RPJ','ADI','TRI','UKI','BPSB OUT') then Qnt else -1*Qnt end) SaldoQnt 
from 	vwKartuStock 
where 	year(Tanggal)=2012 and Tanggal<@akhir and KodeGdg=@gudang
group by KodeBrg, KodeGdg 

union all */
select 	KodeBrg, KodeGdg, sum(case when Tipe='AWL' then Case when @nosat=1 Then QntSaldo else Qnt2Saldo end else 0 end) QntAwal, 
	sum(case when Tipe='BP' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntPBL, 
	sum(case when Tipe='RBP' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntRBP, 
	sum(case when Tipe='PNJ' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntPNJ, 
	sum(case when Tipe='RPJ' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntRPJ, 
	sum(case when Tipe='ADI' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntADI, 
	sum(case when Tipe='ADO' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntADO, 
	sum(case when Tipe='TRI' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntTRI, 
	sum(case when Tipe='TRO' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntTRO, 
	sum(case when Tipe='UKO' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntUKI, 
	sum(case when Tipe='UKI' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntUKO,
	sum(case when Tipe='HP' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntHP,
	sum(case when Tipe='BPSB IN' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntBPSBIN, 
	sum(case when Tipe='BPSB Out' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntBPSBOUT,
	sum(case when Tipe='PB' then Case when @Nosat=1 Then QntCr else Qnt2Cr end else 0 end) QntPB,
	sum(case when Tipe='RPB' then Case when @Nosat=1 Then QntDB else Qnt2DB end else 0 end) QntRPB,
	sum(case when Tipe in ('AWL','BP','RPJ','ADI','TRI','UKI','HP','BPSB IN','RPB') then Case when @Nosat=1 Then QntSaldo else Qnt2Saldo end
	         when Tipe in ('RBP','PNJ','ADO','TRO','UKO','BPSB Out','PB') Then  Case when @Nosat=1 Then QntSaldo else Qnt2Saldo end end) SaldoQnt 
from vwKartuStock  
where (Tanggal between @awal and @akhir) and KodeGdg=@gudang
group by KodeBrg, KodeGdg 
) X 
group by KodeBrg, KodeGdg 
) A
left outer join dbBarang B on B.KodeBrg=A.KodeBrg 
left outer join dbGudang C on C.KodeGdg=A.KodeGdg 
left outer join dbGroup D on D.KodeGrp=B.KodeGrp 
where (QNTAWAL<>0 or QNTPBL<>0 or QNTRPB<>0 or QNTPNJ<>0 or QNTRPJ<>0 or 
 QNTADI<>0 or QNTADO<>0 or QNTUKI<>0 or QNTUKO<>0 or QNTTRI<>0 or QNTTRO<>0 or SALDOQNT<>0 )
order by B.KodeGrp, A.KodeBrg, A.KodeGdg 

GO

-- Procedure: Sp_reportStockQtyRp
-- Created: 2013-07-11 17:39:20.767 | Modified: 2015-03-09 15:32:12.453
-- =====================================================

CREATE procedure [dbo].[Sp_reportStockQtyRp]
--Declare
@Bulan Integer,@Tahun Integer,@isi Integer,@Kodegdg Varchar(20), @KodeGrp varchar(20)
,@Sreport varchar(1),@IDuser varchar(20),@Tipe varchar(10),@IsMinus Bit
--select @bulan=5,@tahun=2013,@isi=1,@Kodegdg=''
as
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
if @SReport='T'
begin
If @isi=1
begin
   if @IsMinus=0
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi1 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi1 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi1 QNTRBP, a.HRGRPB HRGRBP,
	a.QNTPMK/a.Isi1 QNTPMK,   a.HRGPMK,  
	a.QntRPK/a.Isi1 QNTRPK, a.HRGRPK, 
	a.QNTRPB/a.Isi1 QNTRPB, a.HRGRPB, 
	a.QNTPNJ/a.Isi1 QNTPNJ, a.HRGPNJ, 
	a.QNTRPJ/a.Isi1 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi1 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi1 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi1 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi1 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi1 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi1 QNTTRO, a.HRGTRO,
	A.QntHPrd/a.ISI1 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi1 QNTIN, a.RPIN, 
	a.QNTOUT/a.Isi1 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi1 SALDOQNT, a.SALDORP,
	'1' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%' and a.SALDOQNT/a.Isi2 >0
	order by a.kodebrg,a.kodegdg
	
	if @IsMinus=1
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi1 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi1 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi1 QNTRBP, a.HRGRPB HRGRBP,
	a.QNTPMK/a.Isi1 QNTPMK,   a.HRGPMK,  
	a.QntRPK/a.Isi1 QNTRPK, a.HRGRPK, 
	a.QNTRPB/a.Isi1 QNTRPB, a.HRGRPB, 
	a.QNTPNJ/a.Isi1 QNTPNJ, a.HRGPNJ, 
	a.QNTRPJ/a.Isi1 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi1 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi1 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi1 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi1 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi1 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi1 QNTTRO, a.HRGTRO,
	A.QntHPrd/a.ISI1 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi1 QNTIN, a.RPIN, 
	a.QNTOUT/a.Isi1 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi1 SALDOQNT, a.SALDORP,
	'1' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%' and a.SALDOQNT/a.Isi2 <0
	order by a.kodebrg,a.kodegdg
	
end else 
If @isi=2
begin 
  if @IsMinus=0
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi2 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi2 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi2 QNTRBP, a.HRGRPB HRGRBP, 
	a.QNTPMK/a.Isi2 QNTPMK, a.HRGPMK, 
	a.QNTRPK/a.Isi2 QNTRPK, a.HRGRPK, 
	a.QNTPNJ/a.Isi2 QNTPNJ, a.HRGPNJ,		
	a.QNTRPJ/a.Isi2 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi2 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi2 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi2 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi2 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi2 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi2 QNTTRO, a.HRGTRO,	
	A.QntHPrd/a.ISI2 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi2 QNTIN, a.RPIN,  
	a.QNTOUT/a.Isi2 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi2 SALDOQNT, a.SALDORP,
	'2' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%' and a.SALDOQNT/a.Isi2 >0
	order by a.kodebrg,a.kodegdg
	if @IsMinus=1
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi2 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi2 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi2 QNTRBP, a.HRGRPB HRGRBP, 
	a.QNTPMK/a.Isi2 QNTPMK, a.HRGPMK, 
	a.QNTRPK/a.Isi2 QNTRPK, a.HRGRPK, 
	a.QNTPNJ/a.Isi2 QNTPNJ, a.HRGPNJ,		
	a.QNTRPJ/a.Isi2 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi2 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi2 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi2 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi2 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi2 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi2 QNTTRO, a.HRGTRO,	
	A.QntHPrd/a.ISI2 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi2 QNTIN, a.RPIN,  
	a.QNTOUT/a.Isi2 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi2 SALDOQNT, a.SALDORP,
	'2' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%' and a.SALDOQNT/a.Isi2 <0
	order by a.kodebrg,a.kodegdg
end else 
If @isi=3
begin
  select 1

end 

End

else
begin
If @isi=1
begin
  if @IsMinus=0
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi1 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi1 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi1 QNTRBP, a.HRGRPB HRGRBP,
	a.QNTPMK/a.Isi1 QNTPMK,   a.HRGPMK,  
	a.QntRPK/a.Isi1 QNTRPK, a.HRGRPK, 
	a.QNTRPB/a.Isi1 QNTRPB, a.HRGRPB, 
	a.QNTPNJ/a.Isi1 QNTPNJ, a.HRGPNJ, 
	a.QNTRPJ/a.Isi1 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi1 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi1 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi1 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi1 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi1 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi1 QNTTRO, a.HRGTRO,
	A.QntHPrd/a.ISI1 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi1 QNTIN, a.RPIN, 
	a.QNTOUT/a.Isi1 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi1 SALDOQNT, a.SALDORP,
	'1' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%'
	and a.KODEBRG in (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@Tipe)
	and a.SALDOQNT/a.Isi1 <0
	order by a.kodebrg,a.kodegdg
	
	if @IsMinus=1
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi1 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi1 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi1 QNTRBP, a.HRGRPB HRGRBP,
	a.QNTPMK/a.Isi1 QNTPMK,   a.HRGPMK,  
	a.QntRPK/a.Isi1 QNTRPK, a.HRGRPK, 
	a.QNTRPB/a.Isi1 QNTRPB, a.HRGRPB, 
	a.QNTPNJ/a.Isi1 QNTPNJ, a.HRGPNJ, 
	a.QNTRPJ/a.Isi1 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi1 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi1 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi1 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi1 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi1 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi1 QNTTRO, a.HRGTRO,
	A.QntHPrd/a.ISI1 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi1 QNTIN, a.RPIN, 
	a.QNTOUT/a.Isi1 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi1 SALDOQNT, a.SALDORP,
	'1' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%'
	and a.KODEBRG in (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@Tipe)
	and a.SALDOQNT/a.ISI1 <0
	order by a.kodebrg,a.kodegdg
	
	
	
end else 
If @isi=2
begin 
if @IsMinus=0
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi2 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi2 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi2 QNTRBP, a.HRGRPB HRGRBP, 
	a.QNTPMK/a.Isi2 QNTPMK, a.HRGPMK, 
	a.QNTRPK/a.Isi2 QNTRPK, a.HRGRPK, 
	a.QNTPNJ/a.Isi2 QNTPNJ, a.HRGPNJ, 
	a.QNTRPJ/a.Isi2 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi2 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi2 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi2 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi2 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi2 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi2 QNTTRO, a.HRGTRO,
	A.QntHPrd/a.ISI2 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi2 QNTIN, a.RPIN,  
	a.QNTOUT/a.Isi2 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi2 SALDOQNT, a.SALDORP,
	'2' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%'
	and a.KODEBRG in (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@Tipe)
	and a.SALDOQNT/a.ISI2 >0
	order by a.kodebrg,a.kodegdg
if @IsMinus=1
	Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
	Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
	end Satuan, 
	a.QNTAWAL/a.Isi2 QntAwal, a.HRGAWAL, 
	a.QNTPBL/a.Isi2 QNTPBL, a.HRGPBL,
	a.QntRPB/a.Isi2 QNTRBP, a.HRGRPB HRGRBP, 
	a.QNTPMK/a.Isi2 QNTPMK, a.HRGPMK, 
	a.QNTRPK/a.Isi2 QNTRPK, a.HRGRPK, 
	a.QNTPNJ/a.Isi2 QNTPNJ, a.HRGPNJ, 
	a.QNTRPJ/a.Isi2 QNTRPJ, a.HRGRPJ, 
	a.QNTADI/a.Isi2 QNTADI, a.HRGADI, 
	a.QNTADO/a.Isi2 QNTADO, a.HRGADO, 
	a.QNTUKI/a.Isi2 QNTUKI, a.HRGUKI, 
	a.QNTUKO/a.Isi2 QNTUKO, a.HRGUKO, 
	a.QNTTRI/a.Isi2 QNTTRI, a.HRGTRI, 
	a.QNTTRO/a.Isi2 QNTTRO, a.HRGTRO,
	A.QntHPrd/a.ISI2 QntHPrd, A.HRGHPrd, 
	a.HRGRATA, a.QNTIN/a.Isi2 QNTIN, a.RPIN,  
	a.QNTOUT/a.Isi2 QNTOUT, a.RPOUT, 
	a.SALDOQNT/a.Isi2 SALDOQNT, a.SALDORP,
	'2' 
	from vwReportStockBrg a
	Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
	and a.KodeGrp like @KodeGrp+'%'
	and a.KODEBRG in (select ID from Dbcustomize Where Iduser=@Iduser and Tipe=@Tipe)
	and a.SALDOQNT/a.ISI2 <0
	order by a.kodebrg,a.kodegdg
		
end else 
If @isi=3
begin
  select 1

end
End







GO

-- Procedure: sp_reportStockQtyRprek
-- Created: 2013-07-11 17:39:05.627 | Modified: 2013-07-11 17:39:05.627
-- =====================================================
CREATE procedure [dbo].[sp_reportStockQtyRprek]
--Declare
@Bulan Integer,
@Tahun Integer,
@isi Integer,
@Kodegdg Varchar(20),
@KodeGrp varchar(20)
--select @bulan=5,@tahun=2013,@isi=1,@Kodegdg=''
as
Set @kodegdg=Case when @kodegdg in ('','-') then '%' else @kodegdg end
If @isi=1
begin
  Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
  Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
  end Satuan, 
  a.QNTAWAL/a.Isi1 QntAwal, a.HRGAWAL, 
  (a.QNTPBL/a.Isi1)+(a.QNTRPJ/a.Isi1)+(a.QNTADI/a.Isi1)+(a.QNTTRI/a.Isi1)+(a.QNTRPK/a.Isi1) Qntmasuk,
  (a.HRGPBL + a.HRGRPJ +  a.HRGADI + a.HRGTRI + a.HRGRPK) HrgMasuk,
  (a.QNTPNJ/a.Isi1)+(a.QntRPB/a.Isi1)+(a.QNTADO/a.Isi1)+(a.QNTTRO/a.Isi1)+(a.QNTPMK/a.Isi1) QntKeluar, 
  (a.HRGPNJ+a.HRGRPB+a.HRGADO+a.HRGTRO+a.HRGPMK) HrgKeluar, 
  a.QNTUKI/a.Isi1 QNTUKI, a.HRGUKI, 
  a.QNTUKO/a.Isi1 QNTUKO, a.HRGUKO, 
  A.QntHPrd/a.Isi1 QntHPrd, A.HRGHPrd, 
  a.HRGRATA, a.QNTIN/a.Isi1 QNTIN, a.RPIN,  
  a.QNTOUT/a.Isi1 QNTOUT, a.RPOUT, 
  a.SALDOQNT/a.Isi1 SALDOQNT, a.SALDORP,
  '1' 
  from vwReportStockBrg a
  Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg
  and a.KodeGrp like @KodeGrp+'%'
  order by a.kodebrg,A.KODEGDG
end else 
If @isi=2
begin 
Select a.KODEGDG,A.KODEBRG,A.NAMABRG,
  Case when @isi=1 then A.SAT1
       when @isi=2 then A.SAT2
       when @isi=3 then ''
       else ''
  end Satuan, 
  a.QNTAWAL/a.Isi2 QntAwal, a.HRGAWAL, 
  (a.QNTPBL/a.Isi2)+(a.QNTRPJ/a.Isi2)+(a.QNTADI/a.Isi2)+(a.QNTTRI/a.Isi2)+(a.QNTRPK/a.Isi2) Qntmasuk,
  (a.HRGPBL + a.HRGRPJ +  a.HRGADI + a.HRGTRI + a.HRGRPK) HrgMasuk,
  (a.QNTPNJ/a.Isi2)+(a.QntRPB/a.Isi2)+(a.QNTADO/a.Isi2)+(a.QNTTRO/a.Isi2)+(a.QNTPMK/a.Isi2) QntKeluar, 
  (a.HRGPNJ+a.HRGRPB+a.HRGADO+a.HRGTRO+a.HRGPMK) HrgKeluar, 
  a.QNTUKI/a.Isi2 QNTUKI, a.HRGUKI, 
  a.QNTUKO/a.Isi2 QNTUKO, a.HRGUKO, 
  A.QntHPrd/a.ISI2 QntHPrd, A.HRGHPrd, 
  a.HRGRATA, a.QNTIN/a.Isi2 QNTIN, a.RPIN,  
  a.QNTOUT/a.Isi2 QNTOUT, a.RPOUT, 
  a.SALDOQNT/a.Isi2 SALDOQNT, a.SALDORP,
  '2' 
  from vwReportStockBrg a
  Where a.Bulan=@Bulan and a.Tahun=@Tahun and A.KODEGDG Like @Kodegdg 
  and a.KodeGrp like @KodeGrp+'%'
  order by a.kodebrg,A.KODEGDG
end else 
If @isi=3
begin
  select 1
end 





GO

-- Procedure: Sp_ReportTransferDet
-- Created: 2013-06-10 10:55:52.090 | Modified: 2015-03-09 15:32:12.660
-- =====================================================


CREATE Procedure [dbo].[Sp_ReportTransferDet] 
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@NeedOto SmallInt,
@userid varchar(15),
@Tipe varchar(15)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		  If @NeedOto=2
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2  and Needotorisasi=@NeedOto
			order by KodeBrg
		If @NeedOto=2
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2  
			order by KodeBrg
		end 
End
else
begin
If @Ordr='N'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2 and Needotorisasi=@NeedOto
			order by NoBukti,Tanggal
		  If @NeedOto=2
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2 
			order by NoBukti,Tanggal
		end 
	else If @Ordr='B'
		begin
		  If @NeedOto=0 or @NeedOto=1
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2  and Needotorisasi=@NeedOto
			order by KodeBrg
		If @NeedOto=2
			select * from Vwreporttransfer where Tanggal between @tgl1 and @tgl2  
			order by KodeBrg
			end 
End




GO

-- Procedure: Sp_reportUbahKemasanBahan
-- Created: 2013-04-23 13:19:09.237 | Modified: 2015-03-09 15:32:12.620
-- =====================================================



CREATE Procedure [dbo].[Sp_reportUbahKemasanBahan]
@SReport varchar(1),
@Ordr varchar(1),
@tgl1 datetime,
@tgl2 Datetime,
@isiList varchar(200),
@x int=1,
@userid varchar(15),
@Tipe varchar(15)
as
--Declare @SReport varchar(1),@Ordr varchar(1),@tgl1 datetime,@tgl2 Datetime,@isiList varchar(200)
--select @SReport='T',@Ordr='S', @tgl1='01/01/2011',@tgl2='01/01/2013',@isiList='%%' 

if @SReport='T'
begin
	If @Ordr='N'
		begin
		  select * from VwReportUbahKemasanBahan where Tanggal between @tgl1 and @tgl2 order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportUbahKemasanBahan where Tanggal between @tgl1 and @tgl2 order by KodeBrg
		end 
End
else
begin
If @Ordr='N'
		begin
		  select * from VwReportUbahKemasanBahan where Tanggal between @tgl1 and @tgl2 
		  and NOBUKTI in (select ID from DBCUSTOMIZE where IDuser=@userId and Tipe=@Tipe)
		  order by NoBukti,TANGGAL
		end 
	else If @Ordr='B'
		begin
		  select * from VwReportUbahKemasanBahan where Tanggal between @tgl1 and @tgl2 
		 and kodebrg in (select ID from DBCUSTOMIZE where IDuser=@userId and Tipe=@Tipe) 
		  order by KodeBrg
		end 
End



GO

-- Procedure: Sp_ReportUbahKemasanRek
-- Created: 2013-01-21 13:59:20.790 | Modified: 2013-01-21 13:59:20.790
-- =====================================================

Create Procedure [dbo].[Sp_ReportUbahKemasanRek]
@Choice varchar(1),
@Tgl1 DateTime,
@Tgl2 Datetime
as
--Declare @Choice varchar(1),@Tgl1 DateTime,@Tgl2 Datetime
--Select @Choice='N',@Tgl1='01/01/2011',@Tgl2='01/01/2013'

If @Choice='N'
Begin
  Select Nobukti,tanggal,SUM(Isnull(QntDB,0)) QntDB,SUM(Isnull(QntCr,0)) QntCr,
  SUM(Isnull(Harga,0)) Harga,SUM(Isnull(Total,0)) Total,SUM(Isnull(HrgAdi,0)) HrgADi,
  SUM(Isnull(HrgADO,0)) HrgAdo,SUM(Isnull(HPP,0)) HPP2,SUM(Isnull(HPP2,0)) HPP
   from VwReportUbahKemasanBahan
   where tanggal between @Tgl1 and @Tgl2
   group by Nobukti,tanggal
   Order by Nobukti,tanggal
end
else if @Choice='B'
begin
  Select kodebrg,namaBrg,tanggal,SUM(Isnull(QntDB,0)) QntDB,SUM(Isnull(QntCr,0)) QntCr,
  SUM(Isnull(Harga,0)) Harga,SUM(Isnull(Total,0)) Total,SUM(Isnull(HrgAdi,0)) HrgADi,
  SUM(Isnull(HrgADO,0)) HrgAdo,SUM(Isnull(HPP,0)) HPP2,SUM(Isnull(HPP2,0)) HPP
   from VwReportUbahKemasanBahan
   where tanggal between @Tgl1 and @Tgl2
   group by kodebrg,namaBrg,tanggal
   Order by kodebrg,namaBrg,tanggal
end
GO

-- Procedure: sp_ReportUmurHutang
-- Created: 2012-10-25 13:43:51.137 | Modified: 2012-10-25 13:43:51.137
-- =====================================================

CREATE PROCEDURE  [dbo].[sp_ReportUmurHutang]
@Tanggal datetime,
@Tipe int,
@Awal varchar(10),
@Akhir varchar(10),
@Devisi varchar(10),
@Perkiraan varchar(20),
@KodeVls varchar(15)
AS
if @tipe=0 /*Piutang*/
begin
  	select 	A.NoFaktur, A.KODECUSTSUPP as Kode, B.NAMACUSTSUPP as Nama, b.kota, min(A.Tanggal) as tanggal,
  		case when @KodeVls='IDR' then sum(isnull(A.Debet,0)) else sum(isnull(A.DebetD,0)) end as debet, 
		case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)) else  sum(isnull(A.KreditD,0)) end as kredit,
         		case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end as Saldo,
		datepart(dy,@tanggal-min(A.Tanggal)) As Umur,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 0) and (datepart(dy,@tanggal-min(A.Tanggal))<= 30) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo30,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 30) and (datepart(dy,@tanggal-min(A.Tanggal))<= 60) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo60,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 60) and (datepart(dy,@tanggal-min(A.Tanggal))<= 90) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo90,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 90) and (datepart(dy,@tanggal-min(A.Tanggal))<= 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo120,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo121
  	from vwHutPiut A
  	left outer join DBCUSTSUPP B on B.KODECUSTSUPP=A.KodeCustSupp
  	where A.Tanggal<=@Tanggal and A.KODECUSTSUPP>=@Awal and A.KODECUSTSUPP<=@Akhir and A.Perkiraan=@Perkiraan
	--	and ((@KodeVls='IDR' and (A.Valas='IDR' or A.TipeTrans='J')) or (@KodeVls<>'IDR' and A.Valas=@KodeVls))
  	group by A.NoFaktur, A.KODECUSTSUPP, B.NAMACUSTSUPP, B.Kota
  	having 	(sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) <>0 and @KodeVls='IDR') or (sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) <>0 and @KodeVls<>'IDR')
  	order by A.KODECUSTSUPP, min(A.Tanggal), A.NoFaktur
end else 
if @tipe=1
begin
  	select 	A.NoFaktur, A.KODECUSTSUPP as Kode, B.NAMACUSTSUPP as Nama, b.kota, min(A.Tanggal) as tanggal,
  		case when @KodeVls='IDR' then sum(isnull(A.Debet,0)) else sum(isnull(A.DebetD,0)) end as debet, 
		case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)) else  sum(isnull(A.KreditD,0)) end as kredit,
         		case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end as Saldo,
		datepart(dy,@tanggal-min(A.Tanggal)) As Umur,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 0) and (datepart(dy,@tanggal-min(A.Tanggal))<= 30) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo30,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 30) and (datepart(dy,@tanggal-min(A.Tanggal))<= 60) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo60,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 60) and (datepart(dy,@tanggal-min(A.Tanggal))<= 90) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo90,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 90) and (datepart(dy,@tanggal-min(A.Tanggal))<= 120) then
  			case when @KodeVls='IDR' then sum(isnull(kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) end
         		else 0 end as Saldo120,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) else sum(isnull(A.KreditD,0)-isnull(debetD,0)) end
         		else 0 end as Saldo121
  	from vwHutpiut A
  	left outer join DBCUSTSUPP B on B.KODECUSTSUPP=A.KodeCustSupp
  	where A.Tanggal<=@tanggal and A.KODECUSTSUPP>=@awal and A.KODECUSTSUPP<=@akhir and A.perkiraan=@perkiraan
		--and ((@KodeVls='IDR' and (A.Valas='IDR' or A.TipeTrans='J')) or (@KodeVls<>'IDR' and A.Valas=@KodeVls))
  	group by A.Nofaktur, A.KODECUSTSUPP, B.NAMACUSTSUPP, b.kota
  	having 	(sum(isnull(A.Kredit,0)-isnull(A.Debet,0)) <>0 and @KodeVls='IDR') or (sum(isnull(A.KreditD,0)-isnull(A.DebetD,0)) <>0 and @KodeVls<>'IDR')
  	order by A.KODECUSTSUPP, A.NoFaktur, min(A.Tanggal)
end





GO

-- Procedure: sp_ReportUmurPiutang
-- Created: 2012-10-25 13:44:29.157 | Modified: 2012-10-25 13:44:29.157
-- =====================================================
CREATE PROCEDURE  [dbo].[sp_ReportUmurPiutang]
@tanggal datetime,
@tipe int,
@awal varchar(10),
@akhir varchar(10),
@Devisi varchar(10),
@perkiraan varchar(20),
@KodeVls varchar(15)
AS
if @tipe=0 /*Piutang*/
begin
  	select 	A.NoFaktur, A.KODECUSTSUPP as Kode, B.NAMACUSTSUPP as Nama, b.kota, min(A.Tanggal) as tanggal,
  		case when @KodeVls='IDR' then sum(isnull(A.Debet,0)) else sum(isnull(A.DebetD,0)) end as debet, 
		case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)) else  sum(isnull(A.KreditD,0)) end as kredit,
         		case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end as Saldo,
		datepart(dy,@tanggal-min(A.Tanggal)) As Umur,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 0) and (datepart(dy,@tanggal-min(A.Tanggal))<= 30) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo30,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 30) and (datepart(dy,@tanggal-min(A.Tanggal))<= 60) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo60,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 60) and (datepart(dy,@tanggal-min(A.Tanggal))<= 90) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo90,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 90) and (datepart(dy,@tanggal-min(A.Tanggal))<= 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo120,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo121
  	from vwHutpiut A
  	left outer join DBCUSTSUPP B on B.KODECUSTSUPP=A.KodeCustSupp
  	where A.Tanggal<=@tanggal and A.KODECUSTSUPP>=@awal and A.KODECUSTSUPP<=@akhir and A.perkiraan=@perkiraan
		--and ((@KodeVls='IDR' and (A.Valas='IDR' or A.TipeTrans='J')) or (@KodeVls<>'IDR' and A.Valas=@KodeVls))
  	group by A.NoFaktur, A.KODECUSTSUPP, B.NAMACUSTSUPP, b.kota
  	having 	(sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) <>0 and @KodeVls='IDR') or (sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) <>0 and @KodeVls<>'IDR')
  	order by A.KODECUSTSUPP, min(A.Tanggal), A.NoFaktur
end else 
if @tipe=1
begin
  	select 	A.NoFaktur, A.KODECUSTSUPP as Kode, B.NAMACUSTSUPP as Nama, b.kota, min(A.Tanggal) as tanggal,
  		case when @KodeVls='IDR' then sum(isnull(A.Debet,0)) else sum(isnull(A.DebetD,0)) end as debet, 
		case when @KodeVls='IDR' then sum(isnull(A.Kredit,0)) else  sum(isnull(A.KreditD,0)) end as kredit,
         		case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end as Saldo,
		datepart(dy,@tanggal-min(A.Tanggal)) As Umur,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 0) and (datepart(dy,@tanggal-min(A.Tanggal))<= 30) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo30,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 30) and (datepart(dy,@tanggal-min(A.Tanggal))<= 60) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo60,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 60) and (datepart(dy,@tanggal-min(A.Tanggal))<= 90) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo90,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 90) and (datepart(dy,@tanggal-min(A.Tanggal))<= 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo120,
         		case when (datepart(dy,@tanggal-min(A.Tanggal))> 120) then
  			case when @KodeVls='IDR' then sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) else sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) end
         		else 0 end as Saldo121
  	from vwHutpiut A
  	left outer join DBCUSTSUPP B on B.KODECUSTSUPP=A.KodeCustSupp
  	where A.Tanggal<=@tanggal and A.KODECUSTSUPP>=@awal and A.KODECUSTSUPP<=@akhir and A.perkiraan=@perkiraan
		--and ((@KodeVls='IDR' and (A.Valas='IDR' or A.TipeTrans='J')) or (@KodeVls<>'IDR' and A.Valas=@KodeVls))
  	group by A.Nofaktur, A.KODECUSTSUPP, B.NAMACUSTSUPP, b.kota
  	having 	(sum(isnull(A.Debet,0)-isnull(A.Kredit,0)) <>0 and @KodeVls='IDR') or (sum(isnull(A.DebetD,0)-isnull(A.KreditD,0)) <>0 and @KodeVls<>'IDR')
  	order by A.KODECUSTSUPP, A.NoFaktur, min(A.Tanggal)
end







GO

-- Procedure: Sp_ReturPenyerahan
-- Created: 2011-10-13 12:59:31.803 | Modified: 2011-11-22 11:45:02.333
-- =====================================================
CREATE Procedure [dbo].[Sp_ReturPenyerahan]
@Choice varchar(1),
@Nobukti varchar(30),
@Nourut varchar(5),
@Tanggal datetime,
@Kodebag varchar(15),
@kodeBiaya varchar(15),
@SOP varchar(50),
@KodeMesin varchar(15),
@KodeJnsPakai varchar(15),
@JnsKertas varchar(50),
@urut int ,
@kodebrg varchar(25),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Isi numeric(18, 2),
@Qnt numeric(18, 2),
@Qnt2 numeric(18, 2),
@TglTiba datetime,
@NoPenyerahan varchar(30),
@UrutPenyerahan int,
@IsInspeksi bit,
@IDUser varchar(30),
@IsEmpty tinyint,
@Nosat tinyint,
@Flagmenu tinyint,
@KetDet varchar(5000),
@JnsPakai	tinyint,
@Perk_Investasi varchar(25),
@kodegdg varchar(15)

As
Begin tran
if @choice='I'
begin
  	select @urut=isnull(max(urut),0)+1 from DBRPenyerahanBrgDET   Where NoBukti=@NoBukti
  	select @Urut=isnull(@Urut,1) 
	if @IsEmpty=0
  	begin
    		insert into DBRPenyerahanBrg  (Nobukti, Nourut, Tanggal, NoPenyerahan, Kodebag, kodeBiaya, SOP, KodeMesin, 
    		                               KodeJnsPakai, JnsKertas, IDUser, Flagmenu, JnsPakai, Perk_Investasi, Kodegdg)
    		values (@Nobukti, @Nourut, @Tanggal, @NoPenyerahan, @Kodebag, @kodeBiaya, @SOP, @KodeMesin, 
    		        @KodeJnsPakai, @JnsKertas, @IDUser, @flagmenu, @JnsPakai, @Perk_Investasi, @kodegdg)
		if @@error<>0  goto jikasalah
  	end
  	insert into DBRPenyerahanBrgDET  (Nobukti, urut, kodebrg, Sat_1, Sat_2, Isi, Qnt, Qnt2, TglTiba, NoPenyerahan, UrutPenyerahan, IsInspeksi, Nosat, KetDet)
  	values(@Nobukti, @urut, @kodebrg, @Sat_1, @Sat_2, @Isi, @Qnt, @Qnt2, @TglTiba, @NoPenyerahan, @UrutPenyerahan, @IsInspeksi, @Nosat, @Ketdet)
	if @@error<>0  goto jikasalah
end
if @choice='U'
begin
  	update DBRPenyerahanBrgDET  set kodebrg=@kodebrg, Sat_1=@Sat_1, Sat_2=@Sat_2, Isi=@Isi, Qnt=@Qnt, Qnt2=@Qnt2, TglTiba=@TglTiba,
		NoPenyerahan=@NoPenyerahan, UrutPenyerahan=@UrutPenyerahan, IsInspeksi=@IsInspeksi, Nosat=@Nosat,
		KetDet=@KetDet
  	where Nobukti=@Nobukti and urut=@urut
	if @@error<>0  goto jikasalah
end
if @choice='D'
begin
  	delete DBRPenyerahanBrgDET  where nobukti=@nobukti and  urut=@urut
	if @@error<>0  goto jikasalah 
  	if not exists( select nobukti from DBRPenyerahanBrgDET  where nobukti=@nobukti)
  	begin
    		delete DBRPenyerahanBrg   where nobukti=@nobukti
		if @@error<>0  goto jikasalah
  	end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return







GO

-- Procedure: Sp_RevisiPO
-- Created: 2011-04-15 09:21:04.910 | Modified: 2011-09-15 17:17:18.587
-- =====================================================
CREATE Procedure [dbo].[Sp_RevisiPO]
@NoBukti varchar(30)

As
Begin tran

declare @RevisiKe int
declare @NoUrut varchar(10), @NoBuktiRev varchar(30)

select @NoUrut=NoUrut from DBPO where NOBUKTI=@NoBukti

select @RevisiKe=isnull(max(isnull(RevisiKe,0)),0) from DBRevPO Where NoBuktiLama=@NoBukti
select @RevisiKe=isnull(@RevisiKe,0)

if @RevisiKe=0
begin
	select @NoBuktiRev=@NoBukti
end else
begin
	select @NoBuktiRev=REPLACE(@NoBukti,@NoUrut,@NoUrut+'.R'+CAST(@RevisiKe as varchar(4)))
end

insert into DBRevPO (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODECUSTSUPP, RefInt, RefVen, 
  KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, 
  NILAIPOT, NILAIDPP, NILAIPPN, NILAINET, NILAIPOTRp, NILAIDPPRp, NILAIPPNRp, NILAINETRp, 
  ISCETAK, Tipe, IsLengkap, PPH, NOPO, Freight, Lain2, IDUser, NoBuktiLama, RevisiKe)
select @NoBuktiRev, NOURUT, TANGGAL, TglJatuhTempo, KODECUSTSUPP, RefInt, RefVen, 
  KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, 
  NILAIPOT, NILAIDPP, NILAIPPN, NILAINET, NILAIPOTRp, NILAIDPPRp, NILAIPPNRp, NILAINETRp, 
  ISCETAK, Tipe, IsLengkap, PPH, NOPO, Freight, Lain2, IDUser, NoBukti, @RevisiKe+1
from DBPO
where NOBUKTI=@NoBukti

if @@error<>0  goto jikasalah

insert into DBRevPODET (NOBUKTI, URUT, NoPPL, UrutPPL, KODEBRG, PPN, DISC, DISCRP, KURS, 
  QNT, QNT2, SAT_1, SAT_2, Nosat, ISI, Toleransi, HARGA, 
  DiscP1, DiscRp1, DiscP2, DiscRp2, DiscP3, DiscRp3, DiscP4, DiscRp4, DISCTOT, 
  NOPO, Catatan, UrutTrans)
select @NoBuktiRev, URUT, NoPPL, UrutPPL, KODEBRG, PPN, DISC, DISCRP, KURS, 
  QNT, QNT2, SAT_1, SAT_2, Nosat, ISI, Toleransi, HARGA, 
  DiscP1, DiscRp1, DiscP2, DiscRp2, DiscP3, DiscRp3, DiscP4, DiscRp4, DISCTOT, 
  NOPO, Catatan, UrutTrans
from DBPODET
where NOBUKTI=@NoBukti

if @@error<>0  goto jikasalah

insert into DBBIAYARevPO (NoBukti, Urut, Kodebiaya, KODECUSTSUPP, Qnt, Harga, Valas, kurs, PPn)
select @NoBuktiRev, Urut, Kodebiaya, KODECUSTSUPP, Qnt, Harga, Valas, kurs, PPn
from DBBIAYAPO
where NoBukti=@NoBukti

if @@error<>0  goto jikasalah

insert into DBNOTERevPO (NOBUKTI, SyaratPembayaran, PORT, SyaratPengiriman, Country, TglKirim, Catatan)
select @NoBuktiRev, SyaratPembayaran, PORT, SyaratPengiriman, Country, TglKirim, Catatan
from DBNOTEPO
where NOBUKTI=@NoBukti

if @@error<>0  goto jikasalah

update DBPO set RevisiKe=@RevisiKe+1, TanggalPO=GETDATE() where NOBUKTI=@NoBukti

if @@error<>0  goto jikasalah

Commit tran
Return
JikaSalah: Rollback tran
           Return








GO

-- Procedure: Sp_RInvoicePL
-- Created: 2013-01-15 14:00:27.867 | Modified: 2013-02-21 09:49:41.267
-- =====================================================

CREATE  Procedure [dbo].[Sp_RInvoicePL]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@Noinvoice varchar(30),
@TglInvoice datetime,
@IsLokal bit,
@KODECUSTSUPP varchar (15),
@Valas varchar(15),
@Kurs numeric(18,2),
@PPn int,
@NOSC varchar (30),
@TGLSC datetime,
@NOSPP varchar (30),
@TGLSPP datetime,
@NOSPB varchar (30),
@TGLSPB datetime,
@URUT int ,
@KODEBRG varchar (25),
@Namabrg varchar(800),
@Harga Numeric(18,2),
@QNT numeric(18, 2) ,
@QNT2 numeric(18, 2),
@SAT_1 varchar (5) ,
@SAT_2 varchar (5),
@ISI numeric(18, 2) ,
@NoSat int,
@URUTInvoice int, 
@Keterangan varchar (800) ,
@IDUser varchar(30),
@QntTukar numeric(18,2),
@Qnt2Tukar numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2),
@Mesurement numeric(18,2),
@NetWTukar numeric(18,2),
@GrossWTukar numeric(18,2),
@MesurementTukar numeric(18,2),
@Flagmenu tinyint,
@NOLKP varchar(50),
@TglLKP datetime,
@Disc Numeric(18,2),
@DiscRp numeric(18,2),
@DiscP1 numeric(18,2),
@DiscRp1 numeric(18,2),
@DiscTot numeric(18,2)
As
Begin tran
   if @Choice='I'
   begin
  	   select @Urut=isnull(max(urut),0)+1 from DBRInvoicePLDET Where NoBukti=@NoBukti
  	   if not exists(select * from DBRInvoicePL Where NoBukti=@NoBukti) 
  	   begin
	   Insert into DBRInvoicePL (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, NoInvoice, TglInvoice, NOSO, TglSO, NoSPP, TglSPP, NOSPB, TGLSPB,
						    KODECUSTSUPP, KODEVLS, KURS, PPN, IDUser, IsLokal, IsFLag, NOLKP, TGLLKP, DISC, DISCRP)
	   Values( @NOBUKTI, @NoUrut, @TANGGAL, @Tanggal, @Noinvoice, @TglInvoice, @NOSC, @TGLSC, @NoSPP, @TGLSPP, @NOSPB, @TGLSPB , @KODECUSTSUPP, 
				  @Valas, @Kurs, @PPn,  @IDUser, @IsLokal, @Flagmenu, @NOLKP, @TglLKP, @Disc, @DiscRp)
		if @@error<>0  goto jikasalah			
  	   end
	   INSERT INTO DBRINVOICEPLDET (NOBUKTI, URUT, NOINVOICE, URUTINVOICE, PPN, KURS, KODEBRG, NAMABRG, QNT, QNT2, NOSAT, SAT_1,SAT_2, ISI, 
							  KETERANGAN, HARGA, QNTTUKAR, QNT2TUKAR, NetW, GrossW, NetWTukar, GrossWTukar, Mesurement, MesurementTukar,
							  NoSPB, DiscP1, DiscRp1, DISC, DISCTOT)
	   VALUES(@NOBUKTI, @URUT, @NOINVOICE, @URUTINVOICE, @PPN, @KURS, @KODEBRG, @NAMABRG, @QNT, @QNT2, @NOSAT, @SAT_1, @SAT_2, @ISI,
			@KETERANGAN, @HARGA, @QNTTUKAR, @QNT2TUKAR, @NetW, @GrossW, @NetWTukar, @GrossWTukar, @Mesurement, @MesurementTukar,
			@NOSPB, @DiscP1, @DiscRp1, @Disc, @DiscTot)
	   IF @@ERROR<>0  GOTO JIKASALAH
   end
   if @Choice='U'
   begin
  	   update DBRInvoicePLDET set NoInvoice=@Noinvoice, UrutInvoice=@URUTInvoice, 
		   KodeBrg=@KODEBRG, NamaBrg=@Namabrg, Qnt=@QNT, QNT2=@QNT2, NoSat=@NoSat, Sat_1=@Sat_1, Sat_2=@Sat_2, Isi=@Isi,
		   Keterangan=@Keterangan, QNTTukar=@QntTukar, QNT2Tukar=@Qnt2Tukar,
		   NetW=@NetW, GrossW=@GrossW, NetWTukar=@NetWTukar, GrossWTukar=@GrossWTukar, mesurement=@Mesurement, 
		   MesurementTukar=@MesurementTukar, Nospb=@NOSPB, harga=@Harga,
             DiscP1=@DiscP1, DiscRp1=@DiscRp1, DISC=@Disc, DISCTOT=@DiscTot
  	   where NoBukti=@NoBukti and Urut=@Urut
	   if @@error<>0  goto jikasalah
   end
   if @Choice='D'
   begin
  	   delete DBRInvoicePLDET where NoBukti=@NoBukti and Urut=@Urut 
	   if @@error<>0  goto jikasalah
  	   if (not exists( select NoBukti from DBRInvoicePLDET where NoBukti=@NoBukti)) 
  	   begin
    		   delete DBRInvoicePL where NoBukti=@NoBukti
		   if @@error<>0  goto jikasalah
  	   end
   end

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: Sp_RJUAL
-- Created: 2011-12-05 10:54:37.663 | Modified: 2011-12-05 10:54:37.663
-- =====================================================

Create  Procedure [dbo].[Sp_RJUAL]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@KODECUSTSUPP varchar (15),
@KODEGDG varchar(15),
@NOSPB varchar (30),
@TGLSPB datetime,
@NOPNJ Varchar(30),
@NOSO varchar(30),
@URUT int ,
@KODEBRG varchar (25),
@QNT numeric(18, 2) ,
@QNT2 numeric(18, 2),
@SAT_1 varchar (5) ,
@SAT_2 varchar (5),
@ISI numeric(18, 2) ,
@URUTPNJ int, 
@UrutSO int, 
@Keterangan varchar (800) ,
@IDUser varchar(30),
@NoSat int,
@QntTukar numeric(18,2),
@Qnt2Tukar numeric(18,2)

As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from DBRJUALDET Where NoBukti=@NoBukti
  	if not exists(select * from DBRJUAL Where NoBukti=@NoBukti) 
  	begin
		if @NOPNJ='-'
		begin
    		insert into dbRJUAL (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, NOPNJ, NOSO, KODECUSTSUPP, 
			KODEGDG, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp, NOSPB , TGLSPB, IDUser)
    			values (@NOBUKTI, @NoUrut, @TANGGAL, @Tanggal, @NOPNJ, @NOSO, @KODECUSTSUPP, 
			@KODEGDG, 'IDR', 1, 0, 1, 0, 0, 0, 0, @NOSPB, @TGLSPB, @IDUser)
			if @@error<>0  goto jikasalah
		end else
		begin
			insert into dbRJUAL (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, NOPNJ, NOSO, KODECUSTSUPP, 
			KODEGDG, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TipeDisc, DISC, DiscRp, NOSPB , TGLSPB, IDUser)
    			select @NOBUKTI, @NoUrut, @TANGGAL, @Tanggal, @NOPNJ, @NOSO, @KODECUSTSUPP, 
			@KODEGDG, KodeVls, Kurs, PPN, TipeBayar, Hari, TipeDisc, Disc, DiscRp, @NOSPB, @TGLSPB, @IDUser
			from DBRJUAL
			where NoBukti=@NOPNJ
			if @@error<>0  goto jikasalah
		end
  	end

	if @NOPNJ='-'
	begin
  		insert into dbRJUALDET (NOBUKTI, URUT,  NOSO, UrutSO, NoPNJ, URUTPNJ, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, Sat_1,Sat_2, Isi, Nosat, Keterangan, QNTTukar, QNT2Tukar)
  		select 	@NOBUKTI, @URUT, @NoSO, @UrutSO, @NOPNJ, @UrutPnj, PPN, Disc, Kurs, @KODEBRG, @Qnt, @QNT2, @Sat_1,@Sat_2, @Isi, @NoSat,@Keterangan, @QntTukar, @Qnt2Tukar
		from	DBRJUAL
		where	NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
	end else
	begin
		insert into dbRJUALDETDET (NOBUKTI, URUT,  NOSO, UrutSO, NoPNJ, UrutPNJ, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, NoSat, Sat_1,Sat_2, Isi, Keterangan,
			Harga, DiscP1, DiscRp1, DiscTot, QntTukar, Qnt2Tukar)
  		select 	@NOBUKTI, @URUT, @NOSO, @UrutSO, @NOPNJ, @URUTPNJ, A.PPN, A.Disc, A.Kurs, @KODEBRG, @Qnt, @QNT2, @NoSat, @Sat_1,@Sat_2, @Isi, @Keterangan,
			B.Harga, B.DiscP1, B.DiscRp1, B.DiscTot, @QntTukar, @Qnt2Tukar
		from	dbRJUAL A
		left outer join DBRJUALDET B on B.NoBukti=A.NOPNJ and B.NoBukti=@NOPNJ and B.Urut=@URUTPNJ
		where	A.NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
	end

end
if @Choice='U'
begin
  	update DBRJUALDET set NOSO=@NOSO, URUTSO=@UrutSO, NOPNJ=@NOPNJ, URUTPNJ=@URUTPNJ, 
		KodeBrg=@KODEBRG, Qnt=@QNT, QNT2=@QNT2, NoSat=@NoSat, Sat_1=@Sat_1, Sat_2=@Sat_2, Isi=@Isi,
		Keterangan=@Keterangan, QNTTukar=@QntTukar, QNT2Tukar=@Qnt2Tukar
  	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete DBRJUALDET where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
  	if (not exists( select NoBukti from DBRJUALDET where NoBukti=@NoBukti)) 
  	begin
    		delete DBRJUAL where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return






GO

-- Procedure: sp_RPembelian
-- Created: 2012-06-07 15:01:42.437 | Modified: 2012-06-07 15:01:42.437
-- =====================================================
CREATE Procedure [dbo].[sp_RPembelian]
@Choice Varchar(1),
@NoBukti varchar(50),
@Urut int,
@Tanggal datetime,
@JatuhTempo datetime,
@KodeCustSupp varchar(25),
@PPn TinyInt,
@KodeTipe varchar(25),
@KodeSubTipe varchar(25),
@Qnt numeric(18,2),
@Harga numeric(18,2),
@NDPP numeric(18,2),
@NPPN numeric(18,2),
@NNET numeric(18,2),
@AccPersediaan varchar(25),
@AccPPN varchar(25),
@AccHutPiut varchar(25),
@IsExcel bit,
@KodeVls varchar(20),
@kurs numeric(18,2),
@NDPPD numeric(18,2),
@NPPND numeric(18,2),
@NNETD numeric(18,2),
@NoBukti_ varchar(50)

as

begin tran

if @Choice='I'
begin
	insert into DBRPembelian(NoBukti,Urut,Tanggal,JatuhTempo,KodeCustSupp,PPn,
		KodeTipe,KodeSubTipe,Qnt,Harga,NDPP,NPPN,NNet,
		KodeVls, Kurs, NDPPD, NPPND, NNetD,
		AccPersediaan,AccPPN,AccHutPiut,IsExcel, NoBukti_)
	Values(@NoBukti,@Urut,@Tanggal,@JatuhTempo,@KodeCustSupp,@PPn,
		@KodeTipe,@KodeSubTipe,@Qnt,@Harga,@NDPP,@NPPN,@NNET,
		@KodeVls, @Kurs, @NDPPD, @NPPND, @NNetD,
		@AccPersediaan,@AccPPN,@AccHutPiut,@IsExcel, @NoBukti_)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
	update DBRPembelian set Tanggal=@Tanggal, JatuhTempo=@JatuhTempo, KodeCustSupp=@KodeCustSupp,
	PPn=@PPn, KodeTipe=@KodeTipe, KodeSubTipe=@KodeSubTipe, Qnt=@Qnt, Harga=@Harga,
	NDPP=@NDPP, NPPN=@NPPN, NNET=@NNET, KodeVls=@KodeVls, Kurs=@Kurs, 
	NDPPD=@NDPPD, NPPND=@NPPND, NNetD=@NNetD,
	AccPersediaan=@AccPersediaan, AccPPN=@AccPPN, AccHutPiut=@AccHutPiut,
	NoBukti_=@NoBukti_
	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
else if @Choice='D'
begin
	Delete DBRPembelian where NoBukti=@Nobukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
Commit Tran
Return
JikaSalah: RollBack Tran
           Return





GO

-- Procedure: Sp_RPenerimaanBrgJadi
-- Created: 2011-08-05 10:16:59.540 | Modified: 2011-08-05 10:32:44.483
-- =====================================================

CREATE Procedure [dbo].[Sp_RPenerimaanBrgJadi]
@Choice varchar(1),
@NoBukti Varchar(30),
@Nourut varchar(5),
@Tanggal Datetime,
@Keterangan Varchar(500),
@Urut int,
@Kodebrg varchar(25),
@Qnt numeric(18,2),
@Qnt2 Numeric(18,2),
@Sat_1 Varchar(5),
@Sat_2 Varchar(5),
@Nosat int,
@Isi numeric(18,2),
@Kodegdg varchar(15),
@NoTerima varchar(30),
@UrutTerima int
As
begin Tran
If @Choice='I'
begin
  Select @Urut=MAX(Urut) from dbRPenerimaanBrgJadidet where nobukti=@NoBukti
  Set @Urut=ISNULL(@urut,0)+1
  If not Exists(Select 'True' From dbRPenerimaanBrgJadi where nobukti=@NoBukti)
  begin
    Insert into dbRPenerimaanBrgJadi(Nobukti,Nourut,Tanggal,Keterangan)
    Values(@NoBukti, @Nourut, @Tanggal, @Keterangan)
  end
  Insert into dbRPenerimaanBrgJadidet (Nobukti, Urut, kodebrg, Qnt, Qnt2, Sat_1, Sat_2, Nosat, Isi, Kodegdg, NoTerima, UrutTerima)
  Values(@NoBukti, @Urut, @Kodebrg, @Qnt, @Qnt2, @Sat_1, @Sat_2, @Nosat, @Isi, @Kodegdg, @NoTerima, @UrutTerima)
end
else if @Choice='U'
begin
  update dbRPenerimaanBrgJadidet set Kodebrg=@Kodebrg, Qnt=@Qnt, Qnt2=@Qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
                                    Nosat=@Nosat, Isi=@Isi, Kodegdg=@Kodegdg, NoTerima=@NoTerima, UrutTerima=@UrutTerima
  where nobukti=@NoBukti and Urut=@Urut
end else if @Choice='D'
begin
  delete dbRPenerimaanBrgJadidet 
  where nobukti=@NoBukti and Urut=@Urut
  If not Exists(Select 'True' From dbRPenerimaanBrgJadidet where nobukti=@NoBukti)
  delete dbRPenerimaanBrgJadi
  where nobukti=@NoBukti 
end
if @@error<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return



GO

-- Procedure: sp_RPenjualan
-- Created: 2012-06-07 15:02:08.030 | Modified: 2012-06-07 15:02:08.030
-- =====================================================
CREATE Procedure [dbo].[sp_RPenjualan]
@Choice Varchar(1),
@NoBukti varchar(50),
@Urut int,
@Tanggal datetime,
@JatuhTempo datetime,
@KodeCustSupp varchar(25),
@PPn TinyInt,
@KodeTipe varchar(25),
@KodeSubTipe varchar(25),
@Qnt numeric(18,2),
@Harga numeric(18,2),
@NDPP numeric(18,2),
@NPPN numeric(18,2),
@NNET numeric(18,2),
@AccPersediaan varchar(25),
@AccPPN varchar(25),
@AccHutPiut varchar(25),
@IsExcel bit,
@KodeVls varchar(20),
@kurs numeric(18,2),
@NDPPD numeric(18,2),
@NPPND numeric(18,2),
@NNETD numeric(18,2),
@NoBukti_ varchar(50)

as

begin tran

if @Choice='I'
begin
	insert into DBRPenjualan(NoBukti,Urut,Tanggal,JatuhTempo,KodeCustSupp,PPn,
		KodeTipe,KodeSubTipe,Qnt,Harga,NDPP,NPPN,NNet,
		KodeVls, Kurs, NDPPD, NPPND, NNetD,
		AccPersediaan,AccPPN,AccHutPiut,IsExcel, NoBukti_)
	Values(@NoBukti,@Urut,@Tanggal,@JatuhTempo,@KodeCustSupp,@PPn,
		@KodeTipe,@KodeSubTipe,@Qnt,@Harga,@NDPP,@NPPN,@NNET,
		@KodeVls, @Kurs, @NDPPD, @NPPND, @NNetD,
		@AccPersediaan,@AccPPN,@AccHutPiut,@IsExcel, @NoBukti_)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
	update DBRPenjualan set Tanggal=@Tanggal, JatuhTempo=@JatuhTempo, KodeCustSupp=@KodeCustSupp,
	PPn=@PPn, KodeTipe=@KodeTipe, KodeSubTipe=@KodeSubTipe, Qnt=@Qnt, Harga=@Harga,
	NDPP=@NDPP, NPPN=@NPPN, NNET=@NNET, KodeVls=@KodeVls, Kurs=@Kurs, 
	NDPPD=@NDPPD, NPPND=@NPPND, NNetD=@NNetD,
	AccPersediaan=@AccPersediaan, AccPPN=@AccPPN, AccHutPiut=@AccHutPiut,
	NoBukti_=@NoBukti_
	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
else if @Choice='D'
begin
	Delete DBRPenjualan where NoBukti=@Nobukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
Commit Tran
Return
JikaSalah: RollBack Tran
           Return






GO

-- Procedure: Sp_RPenyerahanBhn
-- Created: 2012-12-11 16:36:20.610 | Modified: 2013-06-24 14:29:29.420
-- =====================================================
CREATE  Procedure [dbo].[Sp_RPenyerahanBhn]
@Choice varchar(1),
@NoBukti varchar(50),
@NoUrut varchar(10)='',
@Tanggal datetime=0,
@Kodegdg varchar(15),
@Urut int,
@KodeBrg varchar(25)='',
@Qnt numeric(18,2)='',
@NoSat tinyint=0,
@Sat varchar(5)='',
@Isi numeric(18,2)=0,
@NoPenyerahanBhn Varchar(30),
@Qnt2 numeric(18,2)=0,
@UrutPenyerahanBHN int,
@IsSampel bit
As
Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(urut),0)+1 from dbRPenyerahanBhndet Where NoBukti=@NoBukti
  if not exists(select * from dbRPenyerahanBhn Where NoBukti=@NoBukti) 
  begin
    insert into dbRPenyerahanBhn (NOBUKTI, NOURUT, TANGGAL,KODEGDG,NoPenyerahanBhn, IsSampel)
    values (@NOBUKTI, @NOURUT, @TANGGAL,@KODEGDG,@NoPenyerahanBhn, @IsSampel)
  end
  insert into dbRPenyerahanBhnDET (NOBUKTI, URUT, KODEBRG, QNT, NOSAT, ISI, SAT,Qnt2, NoPenyerahanBhn, UrutPenyerahanBHN)
  values(@NOBUKTI, @URUT, @KODEBRG, @Qnt, @NoSat, @Isi, @Sat,@Qnt2, @NoPenyerahanBhn, @UrutPenyerahanBHN)
end
if @Choice='U'
begin
  update dbRPenyerahanBhnDET set KodeBrg=@KODEBRG, Qnt=@QNT, NOSAT=@NoSat, ISI=@ISI, SAT=@Sat,Qnt2=@Qnt2, NoPenyerahanBHN=@NoPenyerahanBhn, UrutPenyerahanBHN=@UrutPenyerahanBHN
  where NoBukti=@NoBukti and Urut=@Urut
end
if @Choice='D'
begin
  delete dbRPenyerahanBhnDET where NoBukti=@NoBukti and Urut=@Urut 
  if not exists( select NoBukti from dbRPenyerahanBhnDET where NoBukti=@NoBukti)
  begin
    delete dbRPenyerahanBhn where NoBukti=@NoBukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: sp_RSPB
-- Created: 2014-02-19 10:28:30.620 | Modified: 2014-02-19 10:28:30.620
-- =====================================================

Create Procedure [dbo].[sp_RSPB]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NoSPP varchar(30),
@KODECUSTSUPP varchar(15),
@NoPolKend varchar(50),
@Container varchar(50),
@NoContainer varchar(50),
@NoSeal varchar (500),
@Catatan varchar(4000),
@URUT int,
@UrutSPP int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@SAT_2 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@Flagmenu tinyint,
@FlagTipe Tinyint
As
Begin tran

if @Choice='I'
begin
   select @Urut=isnull(max(urut),0)+1 from dbRSPBDet Where NoBukti=@NoBukti
   if @IsEmpty=0 
   begin
   insert into dbRSPB (NoBukti, NoUrut, Tanggal, NoSPB, KodeCustSupp, NoPolKend, 
	    Container, NoContainer, NoSeal,Catatan, IDUser, IsFlag,Flagtipe)
   values (@NoBukti, @NoUrut, @Tanggal, @NoSPP, @KodeCustSupp, @NoPolKend, 
	    @Container, @NoContainer, @NoSeal, @Catatan, @IDUser, @Flagmenu,@FlagTipe)
   if @@error<>0  goto jikasalah
   end
	
   insert into dbRSPBDet (NoBukti, Urut, NoSPB, UrutSPB, KodeBrg, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, Namabrg)
   values (@NoBukti, @Urut, @NoSPP, @UrutSPP, @KodeBrg,  @QNT, @QNT2, @SAT_1, @SAT_2, @NOSAT, @ISI, @NetW, @GrossW, @Namabrg)
   if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
   update dbRSPBDET set KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, SAT_2=@SAT_2, NOSAT=@NOSAT, ISI=@ISI, Namabrg=@Namabrg,
				   NetW=@NetW, GrossW=@GrossW
   where NoBukti=@NoBukti and Urut=@Urut
   if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
   delete dbRSPBDET where NoBukti=@NoBukti and Urut=@Urut 
   if @@error<>0  goto jikasalah
   if not exists (select NoBukti from dbRSPBDET where NoBukti=@NoBukti)
   begin
     delete dbRSPB where NoBukti=@NoBukti
     if @@error<>0  goto jikasalah
   end
end
Update dbRSPB set KodeGdg=(select Kodegdg from dbSPBDet where NoBukti=@NoSPP)where NoBukti=@NoBukti
Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: SP_SalesContract
-- Created: 2011-07-07 12:44:16.903 | Modified: 2011-12-27 18:10:09.317
-- =====================================================

CREATE Procedure [dbo].[SP_SalesContract]
@Choice varchar(1),
@nobukti varchar(30),
@NoUrut varchar(5),
@Tanggal datetime,
@kodecustSupp varchar(15),
@Valas varchar(15),
@kurs numeric(18,4),
@Term_Of_Payment varchar(8000),
@ACC_NO varchar(50),
@Swift_Code varchar(50),
@Shipment_time varchar(8000),
@Last_Shipment_time varchar(8000),
@Packing varchar(8000),
@Consignee varchar(8000),
@notify_Party varchar(8000),
@Delivery varchar(8000),
@Port_of_Loading varchar(8000),
@Port_of_Discharge varchar(8000),
@TransShipment varchar(8000),
@Partial_Shipment varchar(8000),
@price_Validity datetime,
@Remarks varchar(8000),
@urut int,
@NoRekam varchar(30),
@UrutRekam int,
@kodebrg varchar(25),
@Ppn tinyint,
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Isi numeric(18,2),
@Nosat tinyint,
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@Harga numeric(18,4),
@IsLokal	bit,
@NoPO Varchar(50),
@TglPO datetime,
@ShippingMark varchar(8000),
@Namabrg varchar(200),
@Trade_Term varchar(200),
@isAgentFee bit,
@CustAgent varchar(15),
@IsMarketFee bit,
@CustMarket varchar(15) 
as
Begin Tran
if @Choice='I'
begin
  Select @urut=MAX(urut) from dbSalesContractDet where Nobukti=@nobukti
  Set @urut=ISNULL(@urut,0)+1
  if not exists(Select 'True' from dbSalesContract where Nobukti=@nobukti)
  begin
    insert into dbSalesContract(Nobukti, NoUrut, Tanggal, KodecustSupp, Valas, Kurs, Term_of_Payment, ACC_NO, Swift_Code, Shipment_Time, Last_Shipment_Time, Packing, Consignee, 
                      Notify_Party, Delivery, Port_of_Loading, Port_of_Discharge, TransShipment, Partial_Shipment, Price_Validity, Remarks,isLokal,NOPO, TglPO, 
                      trade_Term, IsAgentfee, CustAgent, IsMarketFee, CustMarket)
    Values(@Nobukti, @NoUrut, @Tanggal, @kodecustSupp, @Valas, @kurs, @Term_Of_Payment, @ACC_NO, @Swift_Code, @Shipment_time, @Last_Shipment_time, @Packing, @Consignee, 
                      @notify_Party, @Delivery, @Port_of_Loading, @Port_of_Discharge, @TransShipment, @Partial_Shipment, @price_Validity, @Remarks,@Islokal, @NoPO, @TglPo, 
                      @Trade_Term, @isAgentFee, @CustAgent, @IsMarketFee, @CustMarket)                      
  end
  insert into dbSalesContractDet(  Nobukti, Urut, NoRekam, UrutRekam, Kodebrg, PPn, Sat_1, Sat_2, Isi, Nosat, Qnt, Qnt2, Harga, Kurs,NamaBrg, Ship_Mark)
  Values(@nobukti, @Urut, @NoRekam, @UrutRekam, @kodebrg, @Ppn, @Sat_1, @Sat_2, @Isi, @Nosat, @Qnt, @Qnt2, @Harga, @kurs, @Namabrg, @ShippingMark)
end
else if @Choice='U'
begin
   
  update dbSalesContract set NOPO=@NoPO, Tglpo=@TglPO
  where Nobukti=@nobukti
   
  update dbSalesContractDet set Harga=@Harga, NamaBrg=@Namabrg, Ship_Mark=@ShippingMark
  where Nobukti=@nobukti and Urut=@urut
end
else if @Choice='D'
begin
  delete dbSalesContractDet
  where Nobukti=@nobukti and Urut=@urut
  if not exists(select 'True' from dbSalesContractDet where Nobukti=@nobukti)
  begin
    delete dbSalesContract where Nobukti=@nobukti
  end
end
if @@ERROR<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return



GO

-- Procedure: Sp_SalesContractKirim
-- Created: 2011-10-14 12:56:49.593 | Modified: 2011-10-14 12:56:49.593
-- =====================================================




CREATE Procedure [dbo].[Sp_SalesContractKirim]
@Choice varchar(1),
@urut int,
@NoEnquiryDet varchar(30),
@UrutEnq int,
@Tglkirim Datetime,
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2),
@Keterangan varchar(200)

As 
begin tran
if @Choice='I'
begin
  Select @urut=MAX(urut) from DBSalesContractKIRIM where NoSC=@NoEnquiryDet and urutSC=@UrutEnq
  Set @urut=ISNULL(@urut,0)+1
  Insert into DBSalesContractKIRIM (urut, NoSC, urutSC, TglKirim, Sat_1, Sat_2, Qnt, Qnt2, Nosat, Isi, Keterangan)
  values (@urut,@NoEnquiryDet,@UrutEnq,@Tglkirim,@Sat_1,@Sat_2, @qnt, @qnt2, @Nosat, @Isi, @Keterangan)
end
else if @Choice='U'
begin
  update DBSalesContractKIRIM set TglKirim=@Tglkirim, Qnt=@qnt, qnt2=@qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
  Nosat=@Nosat, isi=@isi, Keterangan=@Keterangan
  where urut=@urut and NoSC=@NoEnquiryDet and urutSC=@UrutEnq
end
else if @Choice='D'
begin
  delete DBSalesContractKIRIM where urut=@urut and NoSC=@NoEnquiryDet and urutSC=@UrutEnq
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return





GO

-- Procedure: SP_SalesPerformance_Final
-- Created: 2025-08-21 08:57:19.100 | Modified: 2025-08-21 08:57:19.100
-- =====================================================

    CREATE PROCEDURE SP_SalesPerformance_Final
        @TanggalAwal DATE,
        @TanggalAkhir DATE,
        @KODESLS INT = NULL  -- KODESLS is INT in DBJUAL not NVARCHAR
    AS
    BEGIN
        SET NOCOUNT ON;
        
        SELECT 
            j.KODESLS,
            k.Nama AS NamaSales,  -- Using exact column name 'Nama'
            COUNT(j.NOBUKTI) AS JumlahTransaksi,
            SUM(j.NILAIDPP) AS TotalDPP,   -- DBJUAL does have NILAIDPP
            SUM(j.NILAIPPN) AS TotalPPN,   -- DBJUAL does have NILAIPPN
            SUM(j.NILAINET) AS TotalNet,   -- DBJUAL does have NILAINET
            AVG(j.NILAINET) AS RataRataTransaksi,
            COUNT(DISTINCT j.KODECUST) AS JumlahCustomer,
            COUNT(CASE WHEN j.ISBATAL = 1 THEN 1 END) AS TransaksiBatal,
            (COUNT(j.NOBUKTI) - COUNT(CASE WHEN j.ISBATAL = 1 THEN 1 END)) AS TransaksiValid
        FROM DBJUAL j
        LEFT JOIN DBKARYAWAN k ON j.KODESLS = k.KeyNIK  -- Join on KeyNIK
        WHERE j.TANGGAL BETWEEN @TanggalAwal AND @TanggalAkhir
            AND (@KODESLS IS NULL OR j.KODESLS = @KODESLS)
        GROUP BY j.KODESLS, k.Nama
        ORDER BY SUM(j.NILAINET) DESC;
    END
    
GO

-- Procedure: Sp_Set
-- Created: 2010-12-18 11:33:06.660 | Modified: 2010-12-18 11:33:06.660
-- =====================================================


CREATE Procedure [dbo].[Sp_Set]
@Choice varchar(1),
@KodeSet varchar(25),
@Urut int,
@KodeBrg varchar(25),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2)
As

Begin tran
if @Choice='I'
begin
  select @Urut=isnull(max(Urut),0)+1 from dbSetDet Where KodeSet=@KodeSet
  if not exists(select * from dbSet Where KodeSet=@KodeSet) 
  begin
    insert into dbSet (KodeSet)
    values (@KodeSet)
  end
  insert into dbSetDet (KodeSet, Urut, KodeBrg, Qnt, Qnt2)
  values(@KodeSet, @Urut, @KodeBrg, @Qnt, @Qnt2)
end
if @Choice='U'
begin
  update dbSetDet set Qnt=@Qnt,KodeBrg=@KodeBrg, qnt2=@Qnt2
  where KodeSet=@KodeSet /*and KodeBrg=@KodeBrg*/ and Urut=@Urut
end
if @Choice='D'
begin
  delete dbSetDet where KodeSet=@KodeSet /*and KodeBrg=@KodeBrg*/ and Urut=@Urut
  if not exists( select KodeSet from dbSetDet where KodeSet=@KodeSet)
  begin
    delete dbSet where KodeSet=@KodeSet
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: SP_SetKursHarian
-- Created: 2014-02-13 11:47:28.297 | Modified: 2014-02-13 11:47:28.297
-- =====================================================

Create Procedure [dbo].[SP_SetKursHarian]
@Kodevls varchar(15),
@Tanggal datetime,
@kurs numeric(18,4)
As
if Not exists (Select 'True' from DBVALASDET where Kodevls=@Kodevls and Tanggal=@Tanggal)
begin
  insert into DBVALASDET (Kodevls,Tanggal,Kurs)
  Values(@Kodevls,@Tanggal,@kurs)
end
else
begin
  update DBVALASDET set Kurs=@kurs
  where Kodevls=@Kodevls and Tanggal=@Tanggal
end


GO

-- Procedure: Sp_SetSaldoAwal
-- Created: 2010-12-15 13:56:50.287 | Modified: 2024-11-01 15:04:04.530
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_SetSaldoAwal]
@Perkiraan varchar(15),
@Bulan Smallint,
@Tahun int,
@DebetRp Numeric(18,2),
@KreditRp Numeric(18,2),
@DebetD Numeric(18,2),
@KreditD Numeric(18,2),
@Devisi varchar(3),
@Valas varchar(15),
@Kurs numeric(18,2),
@RenBisDesThnIni numeric(18,2),
@RenbisJunYAD numeric(18,2),
@RenbisDesYAD numeric(18,2),
@PPINDesThnIni  numeric(18, 2) , 
@PPINJunYAD numeric(18, 2) ,
@PPINDesYAD numeric(18, 2) 


 
AS
begin tran
 update dbNeraca set AwalDRp=@debetRp,AwalKRp=@KreditRp,AwalD=@DebetD,AwalK=@KreditD,
                     valas=@Valas,kurs=@Kurs, RenBisDesThnIni=@RenBisDesThnIni, RenbisJunYAD=@RenBisDesThnIni
                     , RenbisDesYAD =@RenbisDesYAD ,
  PPINDesThnIni= @PPINDesThnIni ,PPINJunYAD=@PPINJunYAD,PPINDesYAD =@PPINDesYAD                  
 where Perkiraan=@Perkiraan And Bulan=@Bulan and Tahun=@Tahun and Devisi=@Devisi
 
 update DBNERACANKA set AwalKRp =@KreditRp
 --from DBNERACANKA a
 --left outer join DBPERKIRAAN b on b.Perkiraan =a.Perkiraan 
 where Perkiraan =@Perkiraan and Bulan =@Bulan and Tahun =@Tahun and Devisi=@Devisi
 and perkiraan in (Select Perkiraan from DBPOSTHUTPIUT  where Kode ='NKA')
 if @@error <> 0 goto jikasalah
commit tran
return
jikasalah:
 rollback tran
 raiserror('Proses Input Data Gagal',16,1)
 return 


GO

-- Procedure: Sp_Shipping
-- Created: 2011-08-19 08:47:46.950 | Modified: 2011-12-27 22:51:33.590
-- =====================================================
CREATE Procedure [dbo].[Sp_Shipping]
@Choice varchar(1),
@Nobukti varchar(30),
@NoUrut Varchar(5),
@Tanggal datetime,
@FaxNo varchar(50),
@To varchar(50),
@Attn varchar(50),
@CC varchar(50),
@NoSC varchar(30),
@Consignee varchar(8000),
@Notify_Party varchar(8000),
@Port_Of_Loading varchar(8000),
@Port_Of_Discharge varchar(8000),
@Veeder_Vessel varchar(8000),
@Connect_Vessel varchar(8000),
@Voy_Veeder_Vessel varchar(8000),
@Voy_Connect_Vessel varchar(8000),
@Stuffing_Date datetime,
@Stuffing_Place varchar(8000),
@Freight_Term varchar(8000),
@Urut int,
@UrutSC int,
@kodebrg varchar(25),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@isi numeric(18,2),
@nosat tinyint,
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@Party20 numeric(18,2),
@Party40 numeric(18,2),
@Party40HC Numeric(18,2),
@Notes varchar(7500),
@ShippingMark varchar(8000),
@Party20OT numeric(18,2),
@Party40OT numeric(18,2),
@Namabrg Varchar(200),
@RateParty20 numeric(18,2),
@RateParty40 numeric(18,2),
@RateParty40HC Numeric(18,2),
@RateParty20OT numeric(18,2),
@RateParty40OT numeric(18,2),
@ValasParty20 Varchar(15),
@ValasParty40 Varchar(15),
@ValasParty40HC Varchar(15),
@ValasParty20OT Varchar(15),
@ValasParty40OT Varchar(15),
@ShipOnBoard datetime,
@NetW numeric(18,2),
@GrossW numeric(18,2),
@Mesurement numeric(18,2),
@NoLC varchar(100)
AS
begin Tran
if @Choice='I' 
begin
  Select @Urut=MAX(Urut) from DBSHIPPINGDET where Nobukti=@Nobukti
  Set @Urut=ISNULL(@urut,0)+1
  if not exists(Select 'True' From DBSHIPPING where NoBukti=@Nobukti)
  begin
    Insert Into DBSHIPPING(NoBukti, NoUrut, Tanggal, FaxNo_, To_, Attn_, CC_, NoSC, Consignee, Notify_Party, Port_of_Loading, Port_of_Discharge, Veeder_Vessel, Connect_Vessel, 
                           Voy_Veeder_Vessel, Voy_Connect_Vessel, Stuffing_Date, Stuffing_Place, Freight_Term, Notes,  Party20, Party40, Party40HC, Party20OT, Party40OT,
                           RateParty20, RateParty40, RateParty40HC, RateParty20OT, RateParty40OT,
                           ValasParty20, ValasParty40, ValasParty40HC, ValasParty20OT, ValasParty40OT, ShipOnBoard, NoLC)
    Values(@Nobukti, @NoUrut, @Tanggal, @FaxNo, @To, @Attn, @CC, @NoSC, @Consignee, @Notify_Party, @Port_Of_Loading, @Port_Of_Discharge, @Veeder_Vessel, 
           @Connect_Vessel,@Voy_Veeder_Vessel, @Voy_Connect_Vessel, @Stuffing_Date, @Stuffing_Place, @Freight_Term, @Notes, 
           @Party20, @Party40, @Party40HC, @Party20OT, @Party40OT,
           @RateParty20, @RateParty40, @RateParty40HC, @RateParty20OT, @RateParty40OT,
           @ValasParty20, @ValasParty40, @ValasParty40HC, @ValasParty20OT, @ValasParty40OT, @ShipOnBoard, @NoLC)                           
  end
  Insert into DBSHIPPINGDET( Nobukti, Urut, NoSC, UrutSC, Kodebrg, Sat_1, Sat_2, Isi, Nosat, Qnt, Qnt2, Namabrg, ShippingMark, NetW, GrossW, Mesurement)                      
  Values(@Nobukti, @Urut, @NoSC, @UrutSC, @kodebrg, @Sat_1, @Sat_2, @isi, @Nosat, @Qnt, @Qnt2, @Namabrg, @ShippingMark, @NetW, @GrossW, @Mesurement)
end
else if @Choice='U' 
begin
  update DBSHIPPINGDET set  NoSC=@NoSC, UrutSC=@UrutSC, Kodebrg=@kodebrg, Sat_1=@Sat_1, Sat_2=@Sat_2, 
                            Isi=@isi, Nosat=@nosat, Qnt=@Qnt, Qnt2=@Qnt2, Namabrg=@Namabrg, ShippingMark=@ShippingMark,
                            NetW=@NetW, GrossW=@GrossW, Mesurement=@Mesurement
  where Nobukti=@Nobukti and Urut=@Urut
end if @Choice='D' 
begin
  delete DBSHIPPINGDET 
  where Nobukti=@Nobukti and Urut=@Urut
  if not exists(select 'True' from DBSHIPPINGDET  where Nobukti=@Nobukti)
  begin
    delete DBSHIPPING  where Nobukti=@Nobukti
  end 
end
if @@ERROR<>0 Goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
            Return




GO

-- Procedure: Sp_SO
-- Created: 2014-02-19 10:29:06.643 | Modified: 2014-02-19 10:29:06.643
-- =====================================================

Create Procedure [dbo].[Sp_SO]
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(10),
@Tanggal datetime,
@TglJatuhTempo Datetime,
@KodeCust varchar(15),
@NOSPB varchar(20),
@KodeSls varchar(15),
@NoAlamatKirim int,
@AlamatKirim varchar(2000),
@Keterangan varchar(200),
@Kodevls varchar(15),
@Kurs numeric(18,2),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@TipeDisc tinyint,
@Disc float,
@DiscRp numeric(18,4),
@Catatan varchar(2000),
@Urut int,
@UrutSPB int, 
@KodeBrg varchar(25),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2),
@Harga numeric(18,4),
@DiscP1 numeric(18,2)=0,
@DiscTot numeric(18,4)=0,
@KodeGdg varchar(15),
@KodeExp varchar(25),
@Qnt3 numeric(18,2),
@INSGdg varchar(15),
@INSBrg varchar(15),
@IsLengkap bit = 0,
@Userid varchar(15)='',
@TglInput datetime=null,
@Satuan varchar(5),
@NoPesanan varchar(15),
@TglKirim datetime,
@MasaBerlaku datetime,
@Discp2 Numeric(18,2),
@Discp3 Numeric(18,3),
@Discp4 Numeric(18,4),
@Discp5 Numeric(18,5),
@TipePPN Tinyint
As
Begin tran
Declare @jam datetime
  Set @jam=Getdate()
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBSOdet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1
  if not exists(select * from DBSO Where NoBukti=@NoBukti) 
  begin
    insert into DBSO (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODECUST, NOSPB, NoAlamatKirim, ALAMATKIRIM, KodeSls, 
	KETERANGAN, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, CATATAN, KODEGDG,KodeExp, 
	INSGdg, INSBrg,Jam, FLAGTIPE, IsLengkap, Userid, TglInput, NoPesanan, TglKirim, Masaberlaku,TipePPN)
    values (@NOBUKTI, @NOURUT, @TANGGAL, @TglJatuhTempo, @KODECust, @NOSPB, @NoAlamatKirim, @ALAMATKIRIM, @KodeSls, 
	@KETERANGAN, @KODEVLS, @KURS, @PPN, @TIPEBAYAR, @HARI, @TIPEDISC, @DISC, @DISCRP, @CATATAN, @KODEGDG,@KodeExp,
	@INSGdg, @INSBrg,@Jam, 'L', @IsLengkap,@Userid, GetDate(),@NoPesanan, @TglKirim, @MasaBerlaku,@TipePPN)
   			
  end
  insert into DBSODET (NOBUKTI, URUT, UrutSPB, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, QNT3, NOSAT, ISI, HARGA, DISCP1, DISCRP1, DISCTOT, SATUAN,
						DiscP2,DiscP3,DiscP4,DiscP5)
  values(@NOBUKTI,@URUT, @UrutSPB, @PPN, @Disc, @Kurs, @KODEBRG, @QNT, @QNT2, @Qnt3, @NOSAT, @ISI, @HARGA, @DiscP1, @DiscTot, @DiscTot,@Satuan,
		@Discp2,@Discp3,@Discp4,@Discp5)
end
if @choice='U'
begin
  update DBSO set Catatan=@Catatan where nobukti=@nobukti
  update DBSODET set kodebrg=@KODEBRG, UrutSPB=@UrutSPB, Qnt=@QNT, QNT2=@QNT2, QNT3=@QNT3, NOSAT=@NOSAT, Isi=@Isi, 
	Harga=@HARGA, DiscP1=@DiscP1, DiscRP1=@DiscTot, DiscTot=@DiscTot, SATUAN=@Satuan,
	DiscP2=@Discp2,DiscP3=@Discp3,DiscP4=@Discp4,DiscP5=@Discp5
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete DBSODET where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from DBSODET where nobukti=@nobukti)
  begin
    delete DBSO where nobukti=@nobukti
  end
end

--exec sp_RefreshOutSO @NoBukti

if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return



GO

-- Procedure: sp_Sopir
-- Created: 2014-11-10 09:12:20.920 | Modified: 2014-11-10 09:12:20.920
-- =====================================================


CREATE PROCEDURE [dbo].[sp_Sopir]
@Choice char(1),
@KodeSopir Varchar(30),
@NamaSopir Varchar(50),
@KodeSG varchar(30),
@IsAktif tinyint

AS
begin tran
if @choice='I'
begin
  insert into dbSopir (KodeSopir, NamaSopir, KodeSG, IsAktif)
  values (@KodeSopir, @NamaSopir, @KodeSG, @IsAktif)
  if @@error <> 0 goto jikasalah
end
else
if @choice='U'
begin
    update dbSopir
    set NamaSopir=@NamaSopir, KodeSG=@KodeSG, IsAktif=@IsAktif
    where KodeSopir=@KodeSopir
    if @@error <> 0
     goto jikasalah
end
if @choice='D'
begin
   delete dbSopir
   where KodeSopir=@KodeSopir
   
   if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return










GO

-- Procedure: sp_SORev
-- Created: 2014-02-13 11:45:49.410 | Modified: 2014-02-13 11:45:49.410
-- =====================================================

Create Procedure [dbo].[sp_SORev]

@NoBukti varchar(20),
@RevisiKe Int,
@urut Int,
@Catatan Varchar(500),
@Urutan TinyInt

As
Begin tran
 if @Urutan =1 
 Begin
    select @RevisiKe=isnull(max(RevisiKe),0)+1 from dbSORevisi Where NoBukti=@NoBukti
    insert into DBSOREVISI (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODECUST, NOSPB, NoAlamatKirim, ALAMATKIRIM, KodeSls, 
	KETERANGAN, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, CATATAN, KODEGDG,KodeExp, 
	INSGdg, INSBrg,Jam, FLAGTIPE, IsLengkap, Userid, TglInput, NoPesanan, TglKirim, Masaberlaku,RevisiKe,TglRevisi)
    Select NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODECUST, NOSPB, NoAlamatKirim, ALAMATKIRIM, KodeSls, 
	KETERANGAN, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, @Catatan, KODEGDG,KodeExp, 
	INSGdg, INSBrg,Jam, FLAGTIPE, IsLengkap, Userid, TglInput, NoPesanan, TglKirim, Masaberlaku,@RevisiKe,GETDATE()
	from DBSO where NOBUKTI=@NoBukti
  
    insert into DBSOREVISIDET (NOBUKTI, URUT, UrutSPB, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, QNT3, NOSAT, ISI, HARGA, DISCP1, DISCRP1, DISCTOT, SATUAN,RevisiKe)
    select NOBUKTI, URUT, UrutSPB, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, QNT3, NOSAT, ISI, HARGA, DISCP1, DISCRP1, DISCTOT, SATUAN,@RevisiKe
    from DBSODET where NOBUKTI=@NoBukti and URUT=@urut
 end
else
 Begin
    select @RevisiKe=isnull(max(RevisiKe),0)+1 from dbSORevisi Where NoBukti=@NoBukti
    
    insert into DBSOREVISI (NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODECUST, NOSPB, NoAlamatKirim, ALAMATKIRIM, KodeSls, 
	KETERANGAN, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, CATATAN, KODEGDG,KodeExp, 
	INSGdg, INSBrg,Jam, FLAGTIPE, IsLengkap, Userid, TglInput, NoPesanan, TglKirim, Masaberlaku,RevisiKe,TglRevisi)
    Select NOBUKTI, NOURUT, TANGGAL, TglJatuhTempo, KODECUST, NOSPB, NoAlamatKirim, ALAMATKIRIM, KodeSls, 
	KETERANGAN, KODEVLS, KURS, PPN, TIPEBAYAR, HARI, TIPEDISC, DISC, DISCRP, @Catatan, KODEGDG,KodeExp, 
	INSGdg, INSBrg,Jam, FLAGTIPE, IsLengkap, Userid, TglInput, NoPesanan, TglKirim, Masaberlaku,@RevisiKe,GETDATE()
	from DBSO where NOBUKTI=@NoBukti
	-------
	insert into DBSOREVISIDET (NOBUKTI, URUT, UrutSPB, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, QNT3, NOSAT, ISI, HARGA, DISCP1, DISCRP1, DISCTOT, SATUAN,RevisiKe)
    select NOBUKTI, URUT, UrutSPB, PPN, Disc, Kurs, KODEBRG, QNT, QNT2, QNT3, NOSAT, ISI, HARGA, DISCP1, DISCRP1, DISCTOT, SATUAN,@RevisiKe
    from DBSODET where NOBUKTI=@NoBukti
 end 
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: Sp_SPB
-- Created: 2014-02-19 10:28:50.430 | Modified: 2014-11-20 10:12:22.033
-- =====================================================

CREATE  Procedure [dbo].[Sp_SPB]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NoSPP varchar(30),
@KODECUSTSUPP varchar(15),
@NoPolKend varchar(50),
@Container varchar(50),
@NoContainer varchar(50),
@NoSeal varchar (500),
@Catatan varchar(4000),
@URUT int,
@UrutSPP int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@SAT_2 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@Sopir varchar(100),
@Kodegdg Varchar(15),
@KodeEXP  varchar(20),
@NoResi varchar(50),
@JumlahTagihan numeric(18,2),
@FlagTipe Tinyint,
@NoBatch varchar(50)=''
As
Begin tran

   if @Choice='I'
   begin
  	   select @Urut=isnull(max(urut),0)+1 from dbSPBDet Where NoBukti=@NoBukti
  	   if not exists(Select nobukti from dbSPB where NoBukti=@NOBUKTI)
  	   begin
    	   insert into dbSPB (NoBukti, NoUrut, Tanggal, NoSPP, KodeCustSupp, NoPolKend, 
    		    Container, NoContainer, NoSeal,Catatan, IDUser, Sopir, KodeExp, NoResi, JumlahTagihan,FlagTipe)
		   values (@NoBukti, @NoUrut, @Tanggal, @NoSPP, @KodeCustSupp, @NoPolKend, 
    		    @Container, @NoContainer, @NoSeal, @Catatan, @IDUser, @Sopir, @KodeExp, @NoResi, @JumlahTagihan,@FlagTipe)
		   if @@error<>0  goto jikasalah
  	   end
     	
  	   insert into dbSPBDet (NoBukti, Urut, NoSPP, UrutSPP, KodeBrg, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, Namabrg, KodeGdg,NObatch)
	   values (@NoBukti, @Urut, @NoSPP, @UrutSPP, @KodeBrg,  @QNT, @QNT2, @SAT_1, @SAT_2, @NOSAT, @ISI, @NetW, @GrossW, @Namabrg, @Kodegdg,@NoBatch)
	   if @@error<>0  goto jikasalah
   end
   if @Choice='U'
   begin
  	   update dbSPBDET set KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, SAT_2=@SAT_2, NOSAT=@NOSAT, ISI=@ISI, Namabrg=@Namabrg,
  					   NetW=@NetW, GrossW=@GrossW, KodeGdg=@Kodegdg
  	   where NoBukti=@NoBukti and Urut=@Urut
	   if @@error<>0  goto jikasalah
   end
   if @Choice='D'
   begin
  	   delete dbSPBDET where NoBukti=@NoBukti and Urut=@Urut 
	   if @@error<>0  goto jikasalah
  	   if not exists (select NoBukti from dbSPBDET where NoBukti=@NoBukti)
  	   begin
    	   delete dbSPB where NoBukti=@NoBukti
		   if @@error<>0  goto jikasalah
  	   end
   end


Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: Sp_SPBLampiran
-- Created: 2013-01-07 09:35:42.313 | Modified: 2013-01-07 09:35:42.313
-- =====================================================

CREATE Procedure [dbo].[Sp_SPBLampiran]
@Choice varchar(1),
@urut int,
@NoEnquiryDet varchar(30),
@UrutEnq int,
@noLot varchar(200),
@noPallet varchar(200),
@NoRoll varchar(200),
@NetW numeric(18,2),
@GrossW numeric(18,2),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2),
@Keterangan varchar(200)

As 
begin tran
if @Choice='I'
begin
  Select @urut=MAX(urut) from DBSPBLampiran where NoSPB=@NoEnquiryDet and UrutSPB=@UrutEnq
  Set @urut=ISNULL(@urut,0)+1
  Insert into DBSPBLampiran (urut, NoSPB, UrutSPB, NOLOT, NOPALLET, NOROLL, NetW, GrossW, Sat_1, Sat_2, Qnt, Qnt2, Nosat, Isi, Keterangan)
  values (@urut,@NoEnquiryDet,@UrutEnq,@noLot, @noPallet, @NoRoll,@NetW, @GrossW, @Sat_1, @Sat_2, @Qnt, @qnt2, @Nosat, @Isi, @Keterangan)
end
else if @Choice='U'
begin
  update DBSPBLampiran set NOLOT=@noLot, NOPALLET=@noPallet, NOROLL=@NoRoll, NetW=@NetW, GrossW=@GrossW, 
                           Qnt=@qnt, qnt2=@qnt2, Sat_1=@Sat_1, Sat_2=@Sat_2, 
                           Nosat=@Nosat, isi=@isi, Keterangan=@Keterangan
  where urut=@urut and NoSPB=@NoEnquiryDet and UrutSPB=@UrutEnq
end
else if @Choice='D'
begin
  delete DBSPBLampiran where urut=@urut and NoSPB=@NoEnquiryDet and UrutSPB=@UrutEnq
end
if @@ERROR<>0 goto JikaSalah
Commit Tran
Return
JikaSalah: Rollback Tran
           Return






GO

-- Procedure: Sp_SPBLokal
-- Created: 2011-09-21 10:12:22.137 | Modified: 2011-11-03 16:52:34.623
-- =====================================================

CREATE  Procedure [dbo].[Sp_SPBLokal]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NOSPP varchar(30),
@KODECUSTSUPP varchar(15),
@NoPolKend varchar(50),
@Container varchar(50),
@NoContainer varchar(50),
@NoSeal varchar (500),
@Catatan varchar(4000),
@URUT int,
@UrutSPP int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@SAT_2 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@IsEkstern bit,
@CustAngkutan varchar(15)
As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbSPBLokalDet Where NoBukti=@NoBukti
  	if @IsEmpty=0 
  	begin
    	insert into dbSPBLokal (NoBukti, NoUrut, Tanggal, NOSPP, KodeCustSupp, NoPolKend, 
    		 Container, NoContainer, NoSeal,Catatan, IDUser, IsEkstern, custAngkutan)
		values (@NoBukti, @NoUrut, @Tanggal, @NOSPP, @KodeCustSupp, @NoPolKend, 
    		 @Container, @NoContainer, @NoSeal, @Catatan, @IDUser, @IsEkstern, @CustAngkutan)
		if @@error<>0  goto jikasalah
  	end
  	
  	insert into dbSPBLokalDet (NoBukti, Urut, NOSPP, UrutSPP, KodeBrg, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, Namabrg)
	values (@NoBukti, @Urut, @NOSPP, @UrutSPP, @KodeBrg,  @QNT, @QNT2, @SAT_1, @SAT_2, @NOSAT, @ISI, @NetW, @GrossW, @Namabrg)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
  	update dbSPBLokalDET set KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, SAT_2=@SAT_2, NOSAT=@NOSAT, ISI=@ISI, Namabrg=@Namabrg,
  	                         NetW=@NetW, GrossW=@GrossW
  	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbSPBLokalDET where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
  	if not exists (select NoBukti from dbSPBLokalDET where NoBukti=@NoBukti)
  	begin
    	delete dbSPBLokal where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: Sp_SPBRJUAL
-- Created: 2013-05-13 12:11:46.773 | Modified: 2014-09-29 10:53:08.427
-- =====================================================
CREATE  Procedure [dbo].[Sp_SPBRJUAL]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NoRPJ varchar(30),
@KODECUSTSUPP varchar(15),
@NoPolKend varchar(50),
@Container varchar(50),
@NoContainer varchar(50),
@NoSeal varchar (500),
@Catatan varchar(4000),
@URUT int,
@UrutRPJ int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@SAT_2 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@Sopir varchar(100),
@Flagmenu tinyint,
@kodegdg varchar(15),
@FlagTipe tinyint
As
Begin tran
   if @Choice='I'
   begin
  	   select @Urut=isnull(max(urut),0)+1 from dbSPBRJUALDet Where NoBukti=@NoBukti
  	   if @IsEmpty=0 
  	   begin
    	   insert into dbSPBRJUAL (NoBukti, NoUrut, Tanggal, NoRPJ, KodeCustSupp, NoPolKend, 
    		    Container, NoContainer, NoSeal,Catatan, IDUser, Sopir, IsFlag,Flagtipe,KodeGDG)
		   values (@NoBukti, @NoUrut, @Tanggal, @NoRPJ, @KodeCustSupp, @NoPolKend, 
    		    @Container, @NoContainer, @NoSeal, @Catatan, @IDUser, @Sopir, @Flagmenu,@FlagTipe,@kodegdg)
		--   if @@error<>0  goto jikasalah
  	   end
     	
  	   insert into dbSPBRJUALDet (NoBukti, Urut, NoINV, UrutINV, KodeBrg, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, Namabrg, KodeGdg)
	   values (@NoBukti, @Urut, @NoRPJ, @UrutRPJ, @KodeBrg,  @QNT, @QNT2, @SAT_1, @SAT_2, @NOSAT, @ISI, @NetW, @GrossW, @Namabrg, @kodegdg)
	   --if @@error<>0  goto jikasalah
   end
   if @Choice='U'
   begin
  	   update dbSPBRJUALDET set KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, SAT_2=@SAT_2, NOSAT=@NOSAT, ISI=@ISI, Namabrg=@Namabrg,
  					   NetW=@NetW, GrossW=@GrossW, KodeGdg=@kodegdg
  	   where NoBukti=@NoBukti and Urut=@Urut
	   if @@error<>0  goto jikasalah
   end
   if @Choice='D'
   begin
  	   delete dbSPBRJUALDET where NoBukti=@NoBukti and Urut=@Urut 
	   if @@error<>0  goto jikasalah
  	   if not exists (select NoBukti from dbSPBRJUALDET where NoBukti=@NoBukti)
  	   begin
    	   delete dbSPBRJUAL where NoBukti=@NoBukti
             if @@error<>0  goto jikasalah
  	   end
   end

Commit tran
Return
JikaSalah: Rollback tran
           Return



GO

-- Procedure: Sp_SPengantar
-- Created: 2011-02-11 15:41:00.470 | Modified: 2011-02-11 15:41:00.470
-- =====================================================

CREATE Procedure Sp_SPengantar
@Choice varchar(1),
@NoBukti varchar(20),
@NoUrut varchar(5),
@Tanggal datetime,
@Urut int,
@NoInspek varchar(30),
@UrutInspek int,
@KodeBrg varchar(25),
@Qnt1 numeric(18,2),
@Qnt2 numeric(18,2),
@NoSP varchar(30),
@TglSP datetime,
@Keterangan varchar(4000),
@IDUser varchar(30),
@IsEmpty tinyint


As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbSPengantarDet Where NoBukti=@NoBukti
  	if not exists(select * from dbSPengantar Where NoBukti=@NoBukti) 
  	begin
    		insert into dbSPengantar (NoBukti, NoUrut, Tanggal, IDuser)
    		values (@NoBukti, @NoUrut, @Tanggal, @IDUser)
		if @@error<>0  goto jikasalah
  	end
  	insert into dbSPengantarDet (NoBukti, Urut, NoInspek, UrutInspek, KodeBrg, Qnt1, Qnt2, NoSP, TglSP, Keterangan)
  	values(@NoBukti, @Urut, @NoInspek, @UrutInspek, @KodeBrg, @Qnt1, @Qnt2, @NoSP, @TglSP, @Keterangan)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
  	update dbSPengantarDet set NoInspek=@NoInspek, UrutInspek=@UrutInspek, KodeBrg=@KodeBrg, Qnt1=@Qnt1, Qnt2=@Qnt2, 
                             NoSP=@NoSP, TglSP=@TglSP, Keterangan=@Keterangan
  	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbSPengantarDet where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
  	if not exists( select NoBukti from dbSPengantarDet where NoBukti=@NoBukti)
  	begin
    		delete dbSPengantar where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: sp_SPK
-- Created: 2014-04-14 11:07:41.747 | Modified: 2014-09-25 09:50:50.000
-- =====================================================



CREATE Procedure [dbo].[sp_SPK]
@Choice varchar(1),
@Nobukti varchar(30)='',
@Tanggal datetime=0,
@KodeBrgJ varchar(25)='',
@QntJ Numeric(18,2)=0,
@IsClose Bit=False,
@NosatJ TinyInt=1,
@SatJ Varchar(5) ='',
@IsiJ Numeric(18,2)=0,
@KodeBrg varchar(25)='',
@Urut int=0,
@Isi numeric(18, 2)=0,
@Qnt numeric(18, 2)=0,
@Nosat Tinyint=0,
@Satuan Varchar(5)='',
@NoUrut varchar(10)='',
@NoBatch varchar(30)='',
@TglExpired datetime=0,
@KodeBOM varchar(30)='',
@KodeBOMDet varchar(30),
@QntBOMX numeric(18,2),
@StrLevelBOM varchar(50),
@IntLevelBOM int,
@KodePrs varchar(50)=''

As
Begin tran
if @choice='I'
begin
  	select @urut=isnull(max(urut),0)+1 from dbSPKDet   Where NoBukti=@NoBukti
  	select @Urut=isnull(@Urut,1)
	if not exists(select * from dbSPK Where NoBukti=@NoBukti) 
  	begin
		insert into dbSPK (NoBukti, NoUrut, Tanggal, KodeBrg, Qnt, NoSat, Isi, Satuan, 
		IsCLose, NoBatch, TglExpired, KodeBOM)
		values (@NoBukti, @NoUrut, @Tanggal, @KodeBrgJ, @QntJ, @NoSatJ, @IsiJ, @SatJ, 
		0, @NoBatch, @TglExpired, @KodeBOM)
		if @@error<>0  goto jikasalah
  	end
	insert into dbSPKDet (NoBukti, Urut, KodeBrg, SATUAN, Isi, Qnt, nosat, 
	KodeBOMDet, QntBOMX, StrLevelBOM, IntLevelBOM, KodePrs)
	values (@NoBukti, @Urut, @KodeBrg, @Satuan, @Isi, @Qnt,  @Nosat, 
	@KodeBOMDet, @QntBOMX, @StrLevelBOM, @IntLevelBOM, @KodePrs)
	if @@error<>0  goto jikasalah
end
if @choice='U'
begin
  	update 	dbSPKDet 
	set	KodeBrg=@KodeBrg, Satuan=@Satuan, Isi=@Isi, Qnt=@Qnt, 
	    nosat=@Nosat
  	where 	NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @choice='D'
begin
  	delete dbSPKDet where nobukti=@nobukti and  urut=@urut
	if @@error<>0  goto jikasalah 
  
  	if not exists( select nobukti from dbSPKDet where nobukti=@nobukti) and not exists( select NOSPK from DBJADWALPRD where NOSPK=@nobukti)
  	begin
    		delete dbSPK where nobukti=@nobukti
		if @@error<>0  goto jikasalah
  	end
  	
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return













GO

-- Procedure: Sp_SPKBJ
-- Created: 2013-12-10 10:04:48.590 | Modified: 2013-12-10 10:04:48.590
-- =====================================================



Create Procedure [dbo].[Sp_SPKBJ]
@Choice varchar(1),
@Nobukti varchar(30)='',
@Tanggal datetime=0,
@KodeBrgJ varchar(25)='',
@QntJ Numeric(18,2)=0,
@IsClose Bit=False,
@NosatJ TinyInt=1,
@SatJ Varchar(5) ='',
@IsiJ Numeric(18,2)=0,
@Urut int=0,
@NoBatch varchar(30)='',
@TglExpired datetime=0,
@IsPesan bit = 0,
@NoUrut varchar(10)=''

As
Begin tran
if @choice='I' and @IsPesan = 0
begin
  	select @urut=isnull(max(urut),0)+1 from dbSPKBJDet   Where NoBukti=@NoBukti
  	select @Urut=isnull(@Urut,1)
	if not exists(select * from dbSPK Where NoBukti=@NoBukti) 
  	begin
		insert into dbSPK (NoBukti, NoUrut, Tanggal, IsCLose, NoBatch, TglExpired, IsPesan)
		values (@NoBukti, @NoUrut, @Tanggal, 0, @NoBatch, @TglExpired, @IsPesan)
		if @@error<>0  goto jikasalah
  	end
	insert into dbSPKBJDet (NoBukti, Urut, KodeBrg, SATUAN, Isi, Qnt, nosat)
	values (@NoBukti, @Urut, @KodeBrgJ, @SatJ, @IsiJ, @QntJ,  @NosatJ)
	if @@error<>0  goto jikasalah
end

if @choice='U'
begin
  	update 	dbSPKBJDet 
	set	KodeBrg=@KodeBrgJ, Satuan=@SatJ, Isi=@IsiJ, Qnt=@QntJ, 
	    nosat=@NosatJ
  	where 	NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end

if @choice='D' and @IsPesan = 0
begin
  	delete dbSPKBJDet where nobukti=@nobukti and  urut=@urut
	if @@error<>0  goto jikasalah 
  	if not exists( select nobukti from dbSPKBJDet where nobukti=@nobukti)
  	begin
    		delete dbSPK where nobukti=@nobukti
		if @@error<>0  goto jikasalah
  	end
end

if @choice='D' and @IsPesan = 1
begin
  	delete dbSPKDet where nobukti=@nobukti and  urut=@urut
	if @@error<>0  goto jikasalah 
  	if not exists( select nobukti from dbSPKDet where nobukti=@nobukti)
  	begin
    		delete dbSPK where nobukti=@nobukti
		if @@error<>0  goto jikasalah
  	end
  	
  
end

if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return









GO

-- Procedure: Sp_SPKOrder
-- Created: 2013-12-17 14:00:33.730 | Modified: 2013-12-17 14:00:33.730
-- =====================================================





CREATE Procedure [dbo].[Sp_SPKOrder]
@Choice varchar(1),
@Nobukti varchar(30)='',
@NoUrutSPK int = 0,
@NoUrut int = 0,
@NoBuktiOrder varchar(30)='',
@NoUrutOrder int = 0,
@Qty Numeric(18,2) 

As
Begin tran
if @choice='I'
begin
  	select @NoUrut=isnull(max(urut),0)+1 from DBSPKOrder   Where NoBukti=@NoBukti and URUTSPK = @NoUrutSPK
  	select @NoUrut=isnull(@NoUrut,1)

	insert into DBSPKOrder (NoBukti, UrutSPK, Urut, NoBuktiOrder, UrutOrder, Qty)
	values (@NoBukti, @NoUrutSPK, @NoUrut, @NoBuktiOrder, @NoUrutOrder, @Qty )
	
	if @@error<>0  goto jikasalah
end

if @choice='U'
begin
  	update 	DBSPKOrder 
	set	Qty = @Qty
  	where 	NoBukti=@NoBukti and UrutSPK=@NoUrutSPK and URUT = @NoUrut
	if @@error<>0  goto jikasalah
end

if @choice='D'
begin
  	delete DBSPKOrder
  	where 	NoBukti=@NoBukti and UrutSPK=@NoUrutSPK and URUT = @NoUrut
end

if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return











GO

-- Procedure: sp_SPKPrs
-- Created: 2014-08-26 11:25:50.403 | Modified: 2014-09-30 11:53:56.130
-- =====================================================





CREATE Procedure [dbo].[sp_SPKPrs]
@Choice varchar(1),
@Nobukti varchar(30)='',
@NoUrut varchar(10)='',
@Tanggal datetime=0,
@KodeBrgJ varchar(25)='',
@QntJ Numeric(18,2)=0,
@IsClose Bit=False,
@NosatJ TinyInt=1,
@SatJ Varchar(5) ='',
@IsiJ Numeric(18,2)=0,
@NoBatch varchar(30)='',
@TglExpired datetime=0,
@KodeBOM varchar(30)='',
@KodeMsn Varchar(15)='',
@TanggalPrs DateTime=0,
@Jamawal DateTime=0,
@JamAkhir dateTime=0,
@IsProduksi bit=0,
@Nospk varchar(50)='',
@Keterangan Varchar(50)='',
@QntSPK Numeric(18,2)=0,
@QntKerja Numeric(18,2)=0,
@Urut int = 0,
@KodePrs varchar(50)=''

As
Begin tran
if @choice='I'
begin
  	select @urut=isnull(max(urut),0)+1 from DBJADWALPRD   Where NOSPK=@NoBukti and KodePrs = @KodePrs
  	select @Urut=isnull(@Urut,1)
	if not exists(select * from dbSPK Where NoBukti=@NoBukti) 
  	begin
		insert into dbSPK (NoBukti, NoUrut, Tanggal, KodeBrg, Qnt, NoSat, Isi, Satuan, 
		IsCLose, NoBatch, TglExpired, KodeBOM)
		values (@NoBukti, @NoUrut, @Tanggal, @KodeBrgJ, @QntJ, @NoSatJ, @IsiJ, @SatJ, 
		0, @NoBatch, @TglExpired, @KodeBOM)
		if @@error<>0  goto jikasalah
  	end 
	insert into DbjadwalPRD (KodeMsn, TANGGAL,JAMAWAL,JAMAKHIR,NOSPK,KETERANGAN,QNTSPK,KodePrs,Urut)
	values (@KodeMsn,@TanggalPrs,@Jamawal,@JamAkhir,@Nospk,@Keterangan,@QntSPK,@KodePrs,@Urut)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
  update DBJADWALPRD set KETERANGAN = @Keterangan, TANGGAL = @TanggalPrs, 
						 JAMAWAL = @Jamawal, JAMAKHIR = @JamAkhir, QNTSPK = @QntSPK
  where NOSPK = @Nospk and KodePrs = @KodePrs and Urut = @Urut
end
if @choice='D'
begin
  delete DBJADWALPRD
  where NOSPK = @Nospk and KodePrs = @KodePrs and Urut = @Urut
  	if not exists( select nobukti from dbSPKDet where nobukti=@Nospk) and not exists( select NOSPK from DBJADWALPRD where NOSPK=@Nospk)
  	begin
    		delete dbSPK where nobukti=@Nospk
		if @@error<>0  goto jikasalah
  	end
  
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return















GO

-- Procedure: Sp_SPP
-- Created: 2014-02-19 10:28:58.610 | Modified: 2014-11-19 14:24:26.863
-- =====================================================

CREATE  Procedure [dbo].[Sp_SPP]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NoSHIP varchar(30),
@NoPesan varchar(30),
@KODECUSTSUPP varchar(15),
@TglKirim datetime,
@ShippingMark varchar (8000),
@NoLC varchar(50),
@Catatan varchar(4000),
@URUT int,
@UrutSHIP int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@SAT_2 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@KetDetail varchar(1000),
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@Mesurement numeric(18,2),
@noAlamatKirim int,
@NamaKirim varchar(50),
@Alamatkirim varchar(8000),
@Flagmenu tinyint,
@Kodegdg varchar(15),
@FlagTipe Tinyint,
@Nobatch Varchar(50)
As
Begin tran
   if @Choice='I'
   begin
  	   select @Urut=isnull(max(urut),0)+1 from dbSPPDet Where NoBukti=@NoBukti
  	   if not Exists(Select Nobukti from dbSPP where NoBukti=@NOBUKTI)
  	   begin
    	   insert into dbSPP (NoBukti, NoUrut, Tanggal, NoSHIP, NoPesan, KodeCustSupp, TglKirim, NoLC, Catatan, IDUser, NoAlamatKirim, NamaKirim, AlamatKirim, IsFlag,Flagtipe)
		   values (@NoBukti, @NoUrut, @Tanggal, @NoSHIP, @NoPesan, @KodeCustSupp, @TglKirim, @NoLC, @Catatan, @IDUser, @noAlamatKirim, @NamaKirim, @Alamatkirim, @Flagmenu,@FlagTipe)
		   if @@error<>0  goto jikasalah
  	   end
     	
  	   insert into dbSPPDet (NoBukti, Urut, NoSO, UrutSO, KodeBrg, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, KetDetail, NamaBrg,Mesurement, ShippingMark, kodegdg,Nobatch)
	   values (@NoBukti, @Urut, @NoSHIP, @UrutSHIP, @KodeBrg, @QNT, @QNT2, @SAT_1, @SAT_2, @NOSAT, @ISI, @NetW, @GrossW, @KetDetail, @Namabrg, @Mesurement, @ShippingMark, @Kodegdg,@Nobatch)
	   if @@error<>0  goto jikasalah
   end else
   if @Choice='U'
   begin
  	   update dbSPPDET set UrutSO=@UrutSHIP, KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, SAT_2=@SAT_2, NOSAT=@NOSAT, ISI=@ISI, 
  		   NetW=@NetW, GrossW=@GrossW, KetDetail=@KetDetail, NamaBrg=@Namabrg, NoSO=@NoSHIP,Mesurement=@Mesurement, ShippingMark=@ShippingMark,
             kodegdg=@Kodegdg 
  	   where NoBukti=@NoBukti and Urut=@Urut
	   if @@error<>0  goto jikasalah
   end else
   if @Choice='D'
   begin
  	   delete dbSPPDET where NoBukti=@NoBukti and Urut=@Urut 
	   if @@error<>0  goto jikasalah
  	   if not exists (select NoBukti from dbSPPDET where NoBukti=@NoBukti)
  	   begin
    	   delete dbSPP where NoBukti=@NoBukti
		   if @@error<>0  goto jikasalah
  	   end
   end



Commit tran
Return
JikaSalah: Rollback tran
           Return

GO

-- Procedure: Sp_SPPLOKAL
-- Created: 2011-09-30 14:02:22.277 | Modified: 2011-10-19 14:03:20.907
-- =====================================================


CREATE  Procedure [dbo].[Sp_SPPLOKAL]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NoSC varchar(30),
@NoPesan varchar(30),
@KODECUSTSUPP varchar(15),
@TglKirim datetime,
@SCpingMark varchar (500),
@NoLC varchar(50),
@Catatan varchar(4000),
@URUT int,
@UrutSC int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@SAT_2 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@KetDetail varchar(1000),
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@Mesurement numeric(18,2),
@noAlamatKirim int
As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbSPPLOKALDet Where NoBukti=@NoBukti
  	if @IsEmpty=0 
  	begin
    	insert into dbSPPLOKAL (NoBukti, NoUrut, Tanggal, NoSC, NoPesan, KodeCustSupp, TglKirim, 
    		ShippingMark, NoLC, Catatan, IDUser, NoAlamatKirim)
		values (@NoBukti, @NoUrut, @Tanggal, @NoSC, @NoPesan, @KodeCustSupp, @TglKirim, 
			@SCpingMark, @NoLC, @Catatan, @IDUser, @noAlamatKirim)
		if @@error<>0  goto jikasalah
  	end
  	
  	insert into dbSPPLOKALDet (NoBukti, Urut, NoSC, UrutSC, KodeBrg, QNT, QNT2, SAT_1, SAT_2, NOSAT, ISI, NetW, GrossW, KetDetail, NamaBrg,Mesurement)
	values (@NoBukti, @Urut, @NoSC, @UrutSC, @KodeBrg, @QNT, @QNT2, @SAT_1, @SAT_2, @NOSAT, @ISI, @NetW, @GrossW, @KetDetail, @Namabrg, @Mesurement )
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
  	update dbSPPLOKALDET set UrutSC=@UrutSC, KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, SAT_2=@SAT_2, NOSAT=@NOSAT, ISI=@ISI, 
  		NetW=@NetW, GrossW=@GrossW, KetDetail=@KetDetail, NamaBrg=@Namabrg, NoSC=@NoSC, Mesurement=@Mesurement 
  	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbSPPLOKALDET where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
  	if not exists (select NoBukti from dbSPPLOKALDET where NoBukti=@NoBukti)
  	begin
    	delete dbSPPLOKAL where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: Sp_SPRK
-- Created: 2011-02-11 15:41:00.467 | Modified: 2011-12-21 22:00:17.477
-- =====================================================


CREATE Procedure [dbo].[Sp_SPRK]
@Choice varchar(1),
@Nobukti varchar(30),
@Nourut varchar(5),
@Tanggal datetime,
@Kodebag varchar(15),
@kodeBiaya varchar(15),
@SOP varchar(50),
@KodeMesin varchar(15),
@urut int ,
@KodeGrp varchar(25),
@KodeBrg varchar(25),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Isi numeric(18, 2),
@Qnt numeric(18, 2),
@Qnt2 numeric(18, 2),
@Keterangan varchar(100),
@Catatan varchar(7500),
@IDUser varchar(30),
@Nosat Tinyint,
@IsInspeksi bit,
@JnsPakai int,
@Perk_Investasi varchar(25),
@kodegdg varchar(15)

As
Begin tran
if @choice='I'
begin
  	select @urut=isnull(max(urut),0)+1 from dbSPRKDet   Where NoBukti=@NoBukti
  	select @Urut=isnull(@Urut,1)
	if not exists(select * from dbSPRK Where NoBukti=@NoBukti) 
  	begin
		insert into dbSPRK (NoBukti, NoUrut, Tanggal, KodeBag, KodeBiaya, SOP, KodeMesin, IDUser, JnsPakai, Perk_Investasi, Kodegdg)
		values (@NoBukti, @NoUrut, @Tanggal, @KodeBag, @KodeBiaya, @SOP, @KodeMesin, @IDUser, @JnsPakai, @Perk_Investasi, @kodegdg)
		if @@error<>0  goto jikasalah
  	end
	insert into dbSPRKDet (NoBukti, Urut, KodeGrp, KodeBrg, Sat_1, Sat_2, Isi, Qnt, Qnt2, Keterangan, Catatan, nosat, IsInspeksi)
	values (@NoBukti, @Urut, @KodeGrp, @KodeBrg, @Sat_1, @Sat_2, @Isi, @Qnt, @Qnt2, @Keterangan, @Catatan, @Nosat, @IsInspeksi)
	if @@error<>0  goto jikasalah
end
if @choice='U'
begin
  	update 	dbSPRKDet 
	set	KodeGrp=@KodeGrp, KodeBrg=@KodeBrg, Sat_1=@Sat_1, Sat_2=@Sat_2, Isi=@Isi, Qnt=@Qnt, Qnt2=@Qnt2, 
	    Keterangan=@Keterangan, Catatan=@Catatan, nosat=@Nosat, IsInspeksi=@IsInspeksi
  	where 	NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @choice='D'
begin
  	delete dbSPRKDet where nobukti=@nobukti and  urut=@urut
	if @@error<>0  goto jikasalah 
  	if not exists( select nobukti from dbSPRKDet where nobukti=@nobukti)
  	begin
    		delete dbSPRK where nobukti=@nobukti
		if @@error<>0  goto jikasalah
  	end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: SP_StockMutation
-- Created: 2025-08-21 08:54:48.620 | Modified: 2025-08-21 08:54:48.620
-- =====================================================

    CREATE PROCEDURE SP_StockMutation
        @KODEBRG NVARCHAR(20) = NULL,
        @KODEGDG NVARCHAR(10) = NULL,
        @BULAN INT,
        @TAHUN INT
    AS
    BEGIN
        SET NOCOUNT ON;
        
        SELECT 
            s.KODEBRG,
            b.NAMABRG,
            s.KODEGDG,
            s.BULAN,
            s.TAHUN,
            ISNULL(s.QNTAWAL, 0) AS StockAwal,
            ISNULL(s.QNTPBL, 0) AS Pembelian,
            ISNULL(s.QNTRPB, 0) AS ReturPembelian,
            ISNULL(s.QNTPNJ, 0) AS Penjualan,
            ISNULL(s.QNTRPJ, 0) AS ReturPenjualan,
            ISNULL(s.QNTPRJ, 0) AS Produksi,
            ISNULL(s.QNTADI, 0) AS AdjustmentIn,
            ISNULL(s.QNTADO, 0) AS AdjustmentOut,
            ISNULL(s.QNTTRI, 0) AS TransferIn,
            ISNULL(s.QNTTRO, 0) AS TransferOut,
            ISNULL(s.QNTPMK, 0) AS Pemakaian,
            ISNULL(s.QNTRPK, 0) AS ReturPemakaian,
            ISNULL(s.SALDOQNT, 0) AS StockAkhir,
            ISNULL(s.SALDORP, 0) AS NilaiStock
        FROM DBSTOCKBRG s
        INNER JOIN DBBARANG b ON s.KODEBRG = b.KODEBRG
        WHERE s.BULAN = @BULAN AND s.TAHUN = @TAHUN
            AND (@KODEBRG IS NULL OR s.KODEBRG = @KODEBRG)
            AND (@KODEGDG IS NULL OR s.KODEGDG = @KODEGDG)
        ORDER BY s.KODEBRG, s.KODEGDG;
    END
    
GO

-- Procedure: Sp_SubJnsBarang
-- Created: 2010-12-17 13:21:01.163 | Modified: 2011-03-03 11:55:10.247
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_SubJnsBarang]
@Choice char(1),
@KodeSubJnsBrg Varchar(15),
@Keterangan Varchar(100),
@KodeJnsBrg Varchar(15),
@OldKode varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbSubJenis (KodeSubJnsBrg, Keterangan,KodeJnsBrg)
	values (@KodeSubJnsBrg, @Keterangan,@KodeJnsBrg)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbSubJenis set Keterangan=@Keterangan ,KodeJnsBrg=@KodeJnsbrg,KodeSubJnsBrg=@KodeSubJnsBrg
             where KodeSubJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbSubJenis where KodeSubJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: Sp_SubJnsBarangJadi
-- Created: 2011-11-07 19:23:56.030 | Modified: 2011-11-07 19:57:40.270
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_SubJnsBarangJadi]
@Choice char(1),
@KodeSubJnsBrg Varchar(15),
@Keterangan Varchar(100),
@OldKode varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into DBSubJENISBRGJADI (KodeSubJnsBrg, Keterangan)
	values (@KodeSubJnsBrg, @Keterangan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update DBSubJENISBRGJADI set Keterangan=@Keterangan ,KodeSubJnsBrg=@KodeSubJnsBrg
             where KodeSubJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  DBSubJENISBRGJADI where KodeSubJnsBrg=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_SubKategori
-- Created: 2010-12-10 09:50:01.167 | Modified: 2011-12-22 10:52:36.123
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_SubKategori]
@Choice char(1),
@KodeKategori Varchar(15),
@KodeSubKategori Varchar(15),
@Keterangan Varchar(100),
@Persediaan Varchar(25),
@OldKodeKateg varchar(15),
@OldKodeSubKateg varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbSubKategori (KodeKategori,KodeSubKategori,Keterangan, Persediaan)
	values (@KodeKategori,@KodeSubKategori,@Keterangan, @Persediaan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbSubKategori set KodeKategori=@KodeKategori,KodeSubKategori=@KodeSubKategori,Keterangan=@Keterangan, Persediaan=@Persediaan
             where KodeKategori=@OldKodeKateg and KodeSubKategori=@OldKodeSubKateg
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbSubKategori where KodeKategori=@OldKodeKateg and KodeSubKategori=@OldKodeSubKateg
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: Sp_SubKategoriBRGJADI
-- Created: 2011-11-07 19:23:56.057 | Modified: 2011-11-07 19:34:51.450
-- =====================================================


CREATE PROCEDURE [dbo].[Sp_SubKategoriBRGJADI]
@Choice char(1),
@KodeSubKategori Varchar(15),
@Keterangan Varchar(100),
@OldKodeSubKateg varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbSubKategoriBRGJADI (KodeSubKategori,Keterangan)
	values (@KodeSubKategori,@Keterangan)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbSubKategoriBRGJADI set KodeSubKategori=@KodeSubKategori,Keterangan=@Keterangan
             where  KodeSubKategori=@OldKodeSubKateg
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbSubKategoriBRGJADI where KodeSubKategori=@OldKodeSubKateg
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return



GO

-- Procedure: Sp_SubTipeTrans
-- Created: 2012-01-18 10:45:18.760 | Modified: 2012-01-18 10:45:18.760
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_SubTipeTrans]
@Choice char(1),
@KodeTipe Varchar(15),
@KodeSubTipe Varchar(15),
@Nama Varchar(100),
@Persediaan Varchar(25),
@Ppn Varchar(25),
@HutPiut Varchar(25),
@OldKodeKateg varchar(15),
@OldKodeSubKateg varchar(15)
AS
begin tran
if @choice='I'
begin
	insert into dbSubTipeTrans (KodeTipe,KodeSubTipe,Nama, Persediaan, PPn, HutPiut)
	values (@KodeTipe,@KodeSubTipe,@Nama, @Persediaan, @Ppn, @HutPiut)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbSubTipeTrans set KodeTipe=@KodeTipe,KodeSubTipe=@KodeSubTipe,Nama=@Nama, Persediaan=@Persediaan,
	                          PPn=@Ppn, HutPiut=@HutPiut    
             where KodeTipe=@OldKodeKateg and KodeSubTipe=@OldKodeSubKateg
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbSubTipeTrans where KodeTipe=@OldKodeKateg and KodeSubTipe=@OldKodeSubKateg
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return


GO

-- Procedure: SP_Supplier
-- Created: 2013-05-13 12:11:46.703 | Modified: 2014-09-13 09:51:25.963
-- =====================================================

CREATE PROCEDURE [dbo].[SP_Supplier]
@Mode Char(1), 
@KodeCustSupp varchar(15)='',
@NamaCustSupp varchar(100)='',
@Usaha varchar(5)='',
@Alamat1 varchar(100)='',
@Alamat2 varchar(100)='',
@KodeKota varchar(15)='',
@KodePos varchar(7)='',
@Negara varchar(30)='',
@Telpon varchar(30)='',
@Fax varchar(30)='',
@Email varchar(40)='',
@NPWP varchar(30)='',
@Tanggal datetime=null,
@Plafon numeric(18,2)=0,
@Hari int=0,
@Berikat bit=0,
@OldKode varchar(15)='',
@Jenis tinyint=0,
@NamaPKP varchar(40)='',
@AlamatPkp1 varchar(100)='',
@AlamatPkp2 varchar(100)='',
@KotaPKP varchar(30)='',
@Sales varchar(20)='',
@KodeVls varchar(15),
@Perkiraan varchar(15),
@KodeTipe varchar(20),
@IsPpn bit=0,
@Kind Int,
@HariHutPiut Int,
@ContactP	varchar(100),
@Alamat1ContP	varchar(100),
@Alamat2ContP	varchar(100),
@KotaContP	varchar(100),
@NegaraContP	varchar(30),
@TelpContP	varchar(100),
@FaxContP	varchar(100),
@EmailContP	varchar(100),
@KODEPOSContP	varchar(7),
@HPContP	varchar(100),
@SyaratPenerimaan	varchar(800),
@SyaratPembayaran	varchar(800),
@Agent	varchar(40),
@Alamat1A	varchar(100),
@Alamat2A	varchar(100),
@KotaA	varchar(100),
@NegaraA	varchar(30),
@ContactA	varchar(100),
@TelpA	varchar(100),
@FaxA	varchar(100),
@EmailA	varchar(100),
@KODEPOSA	varchar(7),
@HPA	varchar(100),
@EmailContA	varchar(100),
@IsAktif tinyint,
@PortOfLoading varchar(800),
@CountryOfOrigin varchar(800),
@IsKontrak tinyint,
@PPN TinyInt=0,
@HargaKe Tinyint=0,
@Att varchar(50),
@Bank varchar(100),
@NoACC varchar(1000),
@IsMember bit = 0,
@TanggalValid datetime,
@DiscMember numeric(18,2) = 0,
@AttPhone varchar(100) = '',
@JenisCustSupp varchar(15)



AS
begin tran
Declare @AlamatCust Varchar(8000)
Set @AlamatCust=@Alamat1+CHAR(13)+
                Case when @Alamat2<>'' then @Alamat2+CHAR(13)
                     else ''
                end+Case when @KodeKota<>'' then (Select NamaKota from DBKOTA where KodeKota=@KodeKota) else '' end
if @mode='I'
begin
  	insert into dbCustSupp(KodeCustSupp, NamaCustSupp, Usaha, Alamat1, Alamat2, Kota, KodePos, Negara,
  	                       Telpon, Fax, Email, NPWP, Tanggal, Plafon, Hari, Berikat, Jenis,
                           NamaPKP, AlamatPkp1, Alamatpkp2, KotaPkp, Sales,Kodevls,Perkiraan, 
                           KodeTipe,isPpn,Kind,HariHutPiut,ContactP,Alamat1ContP,Alamat2ContP,
                           KotaContP,NegaraContP,TelpContP,FaxContP,EmailContP,KODEPOSContP,HPContP,
                           SyaratPenerimaan,SyaratPembayaran,Agent,Alamat1A,Alamat2A,KotaA,NegaraA,
                           ContactA,TelpA,FaxA,EmailA,KODEPOSA,HPA,EmailContA,IsAktif,
                           PortOfLoading, CountryOfOrigin,IsKontrak,tglinput,PPN, HargaKe,Att,bank,NoAcc,
                           IsMember,TanggalValid,DiscMember,AttPhone,JenisCustSupp)
  	values(@KodeCustSupp, @NamaCustSupp, @Usaha, @Alamat1, @Alamat2, @KodeKota, @KodePos, @Negara, 
		   @Telpon, @Fax, @Email, @NPWP, @Tanggal, @Plafon, @Hari, @Berikat, @Jenis,
           @NamaPKP, @AlamatPkp1, @Alamatpkp2, @KotaPkp, @Sales,@kodevls,@Perkiraan, @KodeTipe, 0,@Kind,@HariHutPiut,
           @ContactP,@Alamat1ContP,@Alamat2ContP,@KotaContP,@NegaraContP,@TelpContP,@FaxContP,@EmailContP,
           @KODEPOSContP,@HPContP,@SyaratPenerimaan,@SyaratPembayaran,@Agent,@Alamat1A,@Alamat2A,@KotaA,@NegaraA,
           @ContactA,@TelpA,@FaxA,@EmailA,@KODEPOSA,@HPA,@EmailContA,@IsAktif,
           @PortOfLoading, @CountryOfOrigin,@IsKontrak,GETDATE(),@PPN, @HargaKe,@Att,@Bank,@NoACC,
           @IsMember,@TanggalValid,@DiscMember,@AttPhone,@JenisCustSupp)
    if not exists (Select * from DBALAMATCUST where KODECUSTSUPP=@KodeCustSupp)
    begin
       insert into DBALAMATCUST(Nomor,KODECUSTSUPP,Nama,Alamat,Telp,Fax)
       Values(0,@KodeCustSupp,@NamaCustSupp,@AlamatCust, @Telpon, @Fax)
    end

    if not exists (Select * from DBPERKCUSTSUPP where KODECUSTSUPP=@KodeCustSupp)
    begin
		insert into DBPERKCUSTSUPP (KODECUSTSUPP, Urut, Perkiraan)
		select @KodeCustSupp, CAST(ROW_NUMBER() Over(PARTITION BY @KodeCustSupp Order by Urut,Perkiraan) As int) URUT, Perkiraan
		from DBPOSTHUTPIUT 
		where (Kode= case when @Jenis = 1 then 'PT' else 'HT' end and IsUM = 0)
				or (Kode= case when @Jenis = 0 then 'PT' else 'HT' end  and IsUM = 1)
		if @@error<>0  goto jikasalah
	end
    
end
if @Mode='U'
begin
  	Update dbCustSupp set NamaCustSupp=@NamaCustSupp, Usaha=@Usaha, 
  	                      Alamat1=@Alamat1, Alamat2=@Alamat2, Kota=@KodeKota, KodePos=@KodePos, Negara=@Negara,
  	                      Telpon=@Telpon, Fax=@Fax, Email=@Email, NPWP=@NPWP, Tanggal=@Tanggal, Plafon=@Plafon, 
  	                      Hari=@Hari, Berikat=@Berikat, Jenis=@Jenis,
                          NamaPKP=@NamaPKP, AlamatPkp1=@AlamatPkp1, Alamatpkp2=@AlamatPkp2, 
                          KotaPkp=@KotaPKP, Sales=@Sales,Kodevls=@KodeVls,Perkiraan=@Perkiraan, 
                          KodeTipe=@KodeTipe,isPpn=@IsPpn,Kind=@Kind,HariHutPiut=@HariHutPiut,
                          ContactP=@ContactP,Alamat1ContP=Alamat1ContP,Alamat2ContP=@Alamat2ContP,
                          KotaContP=@KotaContP,NegaraContP=@NegaraContP,TelpContP=@TelpContP,
                          FaxContP=@FaxContP,EmailContP=@EmailContP,KODEPOSContP=@KODEPOSContP,HPContP=@HPContP,
                          SyaratPenerimaan=@SyaratPenerimaan,SyaratPembayaran=@SyaratPembayaran,Agent=@Agent,
                          Alamat1A=@Alamat1A,Alamat2A=@Alamat2A,KotaA=@KotaA,NegaraA=@NegaraA,
                          ContactA=@ContactA,TelpA=@TelpA,FaxA=@FaxA,EmailA=@EmailA,KODEPOSA=@KODEPOSA,
                          HPA=@HPA,EmailContA=@EmailContA,IsAktif=@IsAktif,
                          PortOfLoading=@PortOfLoading, CountryOfOrigin=@CountryOfOrigin,IsKontrak=@IsKontrak,PPN=@PPN, HargaKe=@HargaKe
  						  ,Att=@Att,bank=@Bank ,NoAcc =@NoACC
  						  ,IsMember=@IsMember,TanggalValid= @TanggalValid,DiscMember=@DiscMember,AttPhone=@AttPhone
  						  ,JenisCustSupp=@JenisCustSupp  						  
  	where KodeCustSupp=@OldKode --and Kind=@kind
  	if not exists (Select * from DBALAMATCUST where KODECUSTSUPP=@KodeCustSupp)
    begin
       insert into DBALAMATCUST(Nomor,KODECUSTSUPP,Nama,Alamat,Telp,Fax)
       Values(0,@KodeCustSupp,@NamaCustSupp,@AlamatCust, @Telpon, @Fax)
    end
    else
    Begin
     update DBALAMATCUST set Nama=@NamaCustSupp, Alamat=@AlamatCust, Telp=@Telpon, Fax=@Fax
     where KODECUSTSUPP=@OldKode and Nomor=0
    end
    if not exists (Select * from DBPERKCUSTSUPP where KODECUSTSUPP=@KodeCustSupp)
    begin
		insert into DBPERKCUSTSUPP (KODECUSTSUPP, Urut, Perkiraan)
		select @KodeCustSupp, CAST(ROW_NUMBER() Over(PARTITION BY @KodeCustSupp Order by Urut,Perkiraan) As int) URUT, Perkiraan
		from DBPOSTHUTPIUT 
		where (Kode= case when @Jenis = 1 then 'PT' else 'HT' end and IsUM = 0)
				or (Kode= case when @Jenis = 0 then 'PT' else 'HT' end  and IsUM = 1)
		if @@error<>0  goto jikasalah
	end
    
end
if @Mode='D'
begin
     Delete dbCustSupp 
    	where KodeCustSupp=@OldKode --and Kind=@kind
     delete DBPERKCUSTSUPP 
        where KodeCustSupp=@OldKode
end
if @@error <> 0 goto JikaSalah
commit tran
return
JikaSalah:  rollback tran
            return

GO

-- Procedure: Sp_TarifTenaker
-- Created: 2014-10-27 15:00:05.620 | Modified: 2014-10-27 15:33:05.597
-- =====================================================

CREATE PROCEDURE [dbo].[Sp_TarifTenaker]
@Choice char(1),
@KodeTarifTenaker Varchar(15),
@Ket Varchar(100)='',
--@KodePrs varchar(15)='',
@Tarif Numeric(18,2)=0
AS
begin tran
if @choice='I'
begin
	insert into dbTarifTenaker (KodeTarifTenaker, Ket,tarif)
	values (@KodeTarifTenaker, @Ket,@Tarif )
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbTarifTenaker set Ket=@Ket,Tarif=@Tarif
             where KodeTarifTenaker=@KodeTarifTenaker
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbTarifTenaker where KodeTarifTenaker=@KodeTarifTenaker
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return




GO

-- Procedure: sp_TempHutPiut
-- Created: 2012-06-07 15:02:58.280 | Modified: 2014-07-16 09:14:57.323
-- =====================================================


CREATE PROCEDURE [dbo].[sp_TempHutPiut]
@Choice varchar(1),
@NoFaktur varchar (30),
@NoRetur varchar (30),
@TipeTrans varchar (3),
@KodeCustSupp varchar (15),
@NoBukti varchar (30),
@NoMsk int,
@Urut int,
@Tanggal datetime,
@JatuhTempo datetime,
@Debet numeric (18,2),
@Kredit numeric (18,2),
@Valas varchar (15),
@Kurs numeric (18,4),
@KodeSales varchar (15),
@Tipe varchar (4),
@Perkiraan varchar (25),
@Catatan varchar (800),
@IDUser varchar (30),
@TipeDK varchar(1),
@NoInvoice varchar(20),
@Valas_ varchar(20),
@Kurs_ numeric(18,2),
@KursBayar numeric(18,2),
@DebetD numeric (18,2),
@KreditD numeric (18,2),
@FlagSimbol Varchar(2)=''

AS
Begin tran
if @Choice='I'
begin
	select @Urut=Max(Urut) 
	from DBTempHUTPIUT 
	where KodeCustSupp=@KodeCustSupp and NoFaktur=@NoFaktur 
	set @Urut=isnull(@Urut,0)+1
	insert into DBTempHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
	NoBukti, NoMsk, Urut, 
	Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, DebetD, KreditD, 
	KodeSales, Tipe, Perkiraan, Catatan, IDUser, StatusUID, TipeDK,
	NoInvoice, Valas_, Kurs_, KursBayar,FlagSimbol)
	values (@NoFaktur, @NoRetur, @TipeTrans, @KodeCustSupp, 
	@NoBukti, @NoMsk, @Urut, 
	@Tanggal, @JatuhTempo, @Debet*@Kurs, @Kredit*@Kurs, @Valas, @Kurs, 
	case when @Valas='IDR' then @DebetD else @Debet end, 
	case when @Valas='IDR' then @KreditD else @Kredit end, 
	@KodeSales, @Tipe, @Perkiraan, @Catatan, @IDUser, 'I', @TipeDK,
	@NoInvoice, @Valas_, @Kurs_, @KursBayar,@FlagSimbol)
	if @@error<>0  goto jikasalah
end
if @choice='U'
begin
	update DBTempHUTPIUT 
	set Tanggal=@Tanggal, JatuhTempo=@JatuhTempo, Debet=@Debet*@Kurs, Kredit=@Kredit*@Kurs, Valas=@Valas, Kurs=@Kurs, 
	DebetD=case when @Valas='IDR' then 0 else @Debet end, KreditD=case when @Valas='IDR' then 0 else @Kredit end, 
	KodeSales=@KodeSales, Tipe=@Tipe, Catatan=@Catatan, StatusUID='U'  
	where NoFaktur=@NoFaktur and NoRetur=@NoRetur and TipeTrans=@TipeTrans and KodeCustSupp=@KodeCustSupp and NoBukti=@NoBukti
	and Perkiraan=@Perkiraan and IDUser=@IDUser and NoMsk=@NoMsk and Urut=@Urut 
end
if @choice='D'
begin
	update DBTempHUTPIUT 
	set StatusUID='D'  
	where NoFaktur=@NoFaktur and NoRetur=@NoRetur and TipeTrans=@TipeTrans and KodeCustSupp=@KodeCustSupp and NoBukti=@NoBukti
	and Perkiraan=@Perkiraan and IDUser=@IDUser and NoMsk=@NoMsk and Urut=@Urut
end

if @@error<>0  goto jikasalah

Commit tran
Return
JikaSalah: Rollback tran
           Return





GO

-- Procedure: Sp_TIPETRANS
-- Created: 2012-01-17 15:50:08.297 | Modified: 2012-01-17 15:50:08.297
-- =====================================================
CREATE PROCEDURE [dbo].[Sp_TIPETRANS]
@Choice char(1),
@KodeTIPE Varchar(15)='',
@Keterangan Varchar(100)='',
@Tipe TinyInt,
@OldKode varchar(15)=''
AS
begin tran
if @choice='I'
begin
	insert into dbTipeTrans (KodeTipe, Nama, IsJasaBeliJual)
	values (@KodeTipe, @Keterangan, @Tipe)
	if @@error <> 0 goto jikasalah
end
if @choice='U'
begin
	update dbTipeTrans set Nama=@Keterangan ,KodeTipe=@KodeTipe, IsJasaBeliJual=@Tipe
   where KodeTipe=@OldKode
	if @@error <> 0 goto jikasalah
end
if @choice='D'
begin
	delete  dbTipeTrans where KodeTipe=@OldKode
	if @@error <> 0 goto jikasalah
end
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: sp_Transaksi
-- Created: 2012-05-02 14:26:35.793 | Modified: 2024-01-11 09:54:35.793
-- =====================================================
CREATE Procedure [dbo].[sp_Transaksi]
@Choice varchar(1),
@Nobukti Varchar(30),
@NoUrut Varchar(5),
@Tanggal datetime,
@Note Varchar(500),
@Lampiran TinyInt,
@Devisi varchar(20),
@Perkiraan varchar(25),
@Lawan Varchar(25),
@Keterangan Varchar(8000),
@Keterangan2 Varchar(8000),
@Debet numeric(18,2),
@Kredit Numeric(18,2),
@Valas Varchar(15),
@Kurs Numeric(18,2),
@DebetRp numeric(18,2),
@KreditRp Numeric(18,2),
@TipeTrans varchar(3),
@TPHC Varchar(1),
@CustSuppP varchar(15),
@CustSuppL Varchar(15),
@Urut Int,
@NoAktivaP varchar(30),
@NoAktivaL Varchar(30),
@StatusAktivaP varchar(5),
@StatusAktivaL Varchar(5),
@NoBon varchar(20),
@Kodebag varchar(15),
@KodeP varchar(15),
@KodeL varchar(15),
@Statusgiro varchar(2),
@Simbol varchar(10)

AS
Begin Tran
if @choice='I'
begin
	Select @Urut=MAX(urut) from dbTransaksi where NoBukti=@Nobukti
	Set @Urut=ISNULL(@urut,0)+1  
   	if not exists(select * from dbtrans Where NoBukti=@NoBukti) 
   	begin
     	  insert into dbTrans(NoBukti,NoUrut,tanggal,Note,Simbol, TipeTransHd)
     	  values (@NoBukti, @NoUrut, @tanggal,@Note,@Simbol,@TipeTrans)
     	  --if @@Error<>0 Goto JikaSalah
   	end
 	insert into dbtransaksi (NoBukti, Tanggal, Devisi, Note, Lampiran, Perkiraan, Lawan, 
 	                         Keterangan, Keterangan2, Debet, Kredit, Valas, Kurs, DebetRp, 
 	                         KreditRp, TipeTrans, TPHC, CustSuppP, CustSuppL, Urut, 
 	                         NoAktivaP, NoAktivaL, StatusAktivaP, StatusAktivaL, Nobon, 
 	                         KodeBag, KodeP, kodeL,StatusGiro,
 	                         FlagSimbol)
 	values (@NoBukti, @Tanggal, @Devisi, @Note, @Lampiran, @Perkiraan, @Lawan, 
 	        @Keterangan, @Keterangan2, @Debet, @Kredit, @Valas, @Kurs, @DebetRp, 
 	        @KreditRp, @TipeTrans, @TPHC, @CustSuppP, @CustSuppL, @Urut, @NoAktivaP, 
 	        @NoAktivaL, @StatusAktivaP, @StatusAktivaL, @Nobon, @KodeBag, @KodeP, @kodeL,@Statusgiro
 	        ,'')
 	--if @@Error<>0 Goto JikaSalah
 	        
 	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=@Urut and StatusUID in ('I','U')
	--if @@Error<>0 Goto JikaSalah
end
if @choice='U'
begin
 	Update dbtransaksi set Tanggal=@Tanggal, Devisi=@Devisi, Note=@Note, 
 	                       Lampiran=@Lampiran, Perkiraan=@Perkiraan, Lawan=@Lawan, 
 	                       Keterangan=@Keterangan, Keterangan2=@Keterangan2, 
 	                       Debet=@Debet, Kredit=@Kredit, Valas=@Valas, 
 	                       Kurs=@Kurs, DebetRp=@DebetRp, KreditRp=@KreditRp, 
 	                       TipeTrans=@TipeTrans, TPHC=@TPHC, CustSuppP=@CustSuppP, 
 	                       CustSuppL=@CustSuppL, Urut=@Urut, NoAktivaP=@NoAktivaP, 
 	                       NoAktivaL=@NoAktivaL, StatusAktivaP=@StatusAktivaP, 
 	                       StatusAktivaL=@StatusAktivaL, Nobon=@Nobon, Kodebag=@KodeBag,
 	                       KodeP=@KodeP, KodeL=@KodeL, StatusGiro=@Statusgiro 
 	where nobukti=@nobukti  and urut=@urut
 	--if @@Error<>0 Goto JikaSalah
 	delete DBHUTPIUT
 	from DBHUTPIUT A
 	left outer join DBTempHUTPIUT B on B.NoFaktur=A.NoFaktur and B.KodeCustSupp=A.KodeCustSupp and B.Perkiraan=A.Perkiraan
 		and B.NoBukti=A.NoBukti and B.NoMsk=A.NoMsk and B.Urut=A.Urut
 	where	B.NoBukti=@Nobukti and B.NoMsk=@Urut and B.StatusUID in ('D','U')
 	--if @@Error<>0 Goto JikaSalah
 	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=@Urut and StatusUID in ('I','U')
	--if @@Error<>0 Goto JikaSalah
end
if @choice='D'
begin
 	delete dbtransaksi where nobukti=@nobukti and urut=@urut
 	--if @@Error<>0 Goto JikaSalah
 	delete DBHUTPIUT where NoBukti=@Nobukti and NoMsk=@Urut
 	--if @@Error<>0 Goto JikaSalah
 	if not exists( select nobukti from dbtransaksi where nobukti=@nobukti)
 	begin
  		delete dbTrans where nobukti=@nobukti
  	--	if @@Error<>0 Goto JikaSalah 
 	end
end

Commit Tran
Return
JikaSalah: RollBack Tran
           Return






GO

-- Procedure: sp_TransaksiKasBank
-- Created: 2012-06-07 15:00:12.450 | Modified: 2024-07-29 09:44:39.540
-- =====================================================



CREATE Procedure [dbo].[sp_TransaksiKasBank]
@Choice varchar(1),
@Nobukti Varchar(30),
@NoUrut Varchar(5),
@Tanggal datetime,
@Note Varchar(500),
@Lampiran TinyInt,
@Devisi varchar(20),
@Perkiraan varchar(25),
@Lawan Varchar(25),
@Keterangan Varchar(8000),
@Keterangan2 Varchar(8000),
@Debet numeric(18,2),
@Kredit Numeric(18,2),
@Valas Varchar(15),
@Kurs Numeric(18,2),
@DebetRp numeric(18,2),
@KreditRp Numeric(18,2),
@TipeTrans varchar(3),
@TPHC Varchar(1),
@CustSuppP varchar(15),
@CustSuppL Varchar(15),
@Urut Int,
@NoAktivaP varchar(30),
@NoAktivaL Varchar(30),
@StatusAktivaP varchar(5),
@StatusAktivaL Varchar(5),
@NoBon varchar(20),
@Kodebag varchar(15),
@KodeP varchar(15),
@KodeL varchar(15),
@Statusgiro varchar(2),
@Simbol varchar(10),
@PerkiraanHd varchar(20),
@FlagSimbol Varchar(2)='',
@KodeCost varchar(30)='',
@KodeSubCost varchar(30)='',
@Jenis varchar(1),
@IsPasang tinyint =0,
@JnsTransInvestasi tinyint=0,
@Lot Numeric(18,2)=0,
@Harga Numeric(18,2)=0

AS

Begin Tran
Declare @UrutKB Int, @xBuktiSem Varchar(30),@Tahun int ,@Bulan int,@PerkiraanAktiva varchar(30)
select @Bulan=MONTH (@Tanggal ), @Tahun =YEAR (@Tanggal )
/*if @Jenis='S'
  begin
  if @choice='I'
  begin
   	Select @Urut=MAX(urut) from TempdbTransaksi where NoBukti=@Nobukti and FlagSimbol<>'KB'
	Set @Urut=ISNULL(@urut,0)+1  
	---
	Select @UrutKB=MAX(urut) from TempdbTransaksi where NoBukti=@Nobukti and FlagSimbol='KB'
	Set @UrutKB=ISNULL(@UrutKB,0)+1  
   	if not exists(select * from TempdbTrans Where NoBukti=@NoBukti) 
   	begin
     	  insert into TempdbTrans(NoBukti,NoUrut,tanggal,Note,Simbol, TipeTransHd, PerkiraanHd,Devisi)
     	  values (@NoBukti, @NoUrut, @tanggal,@Note,@Simbol,@TipeTrans,@PerkiraanHd,@Devisi)
     	  if @@Error<>0 Goto JikaSalah
   	end
 	insert into TempdbTransaksi (NoBukti, Tanggal, Devisi, Note, Lampiran, Perkiraan, Lawan, 
 	                         Keterangan, Keterangan2, Debet, Kredit, Valas, Kurs, DebetRp, 
 	                         KreditRp, TipeTrans, TPHC, CustSuppP, CustSuppL, Urut, 
 	                         NoAktivaP, NoAktivaL, StatusAktivaP, StatusAktivaL, Nobon, 
 	                         KodeBag, KodeP, kodeL,StatusGiro,FlagSimbol,
 	                         KodeCost, KodeSubCost,ispasang)
 	values (@NoBukti, @Tanggal, @Devisi, @Note, @Lampiran, @Perkiraan, @Lawan, 
 	        @Keterangan, @Keterangan2, @Debet, @Kredit, @Valas, @Kurs, @DebetRp, 
 	        @KreditRp, @TipeTrans, @TPHC, @CustSuppP, @CustSuppL, case when @FlagSimbol='KB' Then @UrutKB else @Urut end , @NoAktivaP, 
 	        @NoAktivaL, @StatusAktivaP, @StatusAktivaL, @Nobon, 
 	        @KodeBag, @KodeP, @kodeL,@Statusgiro,@FlagSimbol,
 	        @KodeCost, @KodeSubCost,@IsPasang )
 	if @@Error<>0 Goto JikaSalah
 	
	/*insert into TempdbAktivadet (Perkiraan,Bulan,Tahun,Devisi,MD,MK,DMD,DMK,SD,SK,DSD,DSK)
    Values(@NoAktivaP,month(@Tanggal),year(@Tanggal),@Devisi,
           Case when @StatusAktivaP='AKV+' then @DebetRp else 0 end,
           Case when @StatusAktivaP='AKV-' then @DebetRp else 0 end,
           Case when @StatusAktivaP='AKV+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
           Case when @StatusAktivaP='AKV-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
           Case when @StatusAktivaP='AKM-' then @DebetRp else 0 end,
           Case when @StatusAktivaP='AKM+' then @DebetRp else 0 end,
           Case when @StatusAktivaP='AKM-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
           Case when @StatusAktivaP='AKM+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end) 	
	if @@Error<>0 Goto JikaSalah */
	
		  if @StatusAktivaP in('AKV-','AKM-','AKV+','AKM+')
		  begin
			Update TempdbAktivadet set DMD=DMD+Case when @StatusAktivaP='AKV+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   MD=MD+Case when @StatusAktivaP='AKV+' then @DebetRp else 0 end,
								   DSK=DSK+Case when @StatusAktivaP='AKM+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   SK=SK+Case when @StatusAktivaP='AKM+' then @DebetRp else 0 end,
		                           
								   DMK=DMK+Case when @StatusAktivaP='AKV-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   MK=MK+Case when @StatusAktivaP='AKV-' then @DebetRp else 0 end,
								   DSD=DSD+Case when @StatusAktivaP='AKM-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   SD=SD+Case when @StatusAktivaP='AKM-' then @DebetRp else 0 end
			where Devisi=@Devisi and Perkiraan=@noAktivaP and Bulan=@bulan and tahun=@Tahun
		  end
		  if not Exists (Select 'True' 
						 from TempdbAktivadet
						 where Devisi=@Devisi and Perkiraan=@noAktivaP and Bulan=@bulan and tahun=@Tahun) and 
						 @NoAktivaP<>'' and @StatusAktivaP in('AKV-','AKM-','AKV+','AKM+')
		  begin
			insert into TempdbAktivadet (Perkiraan,Bulan,Tahun,Devisi,MD,MK,DMD,DMK,SD,SK,DSD,DSK)
			Values(@NoAktivaP,@bulan,@Tahun,@Devisi,
				   Case when @StatusAktivaP='AKV+' then @DebetRp else 0 end,
				   Case when @StatusAktivaP='AKV-' then @DebetRp else 0 end,
				   Case when @StatusAktivaP='AKV+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
				   Case when @StatusAktivaP='AKV-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
				   Case when @StatusAktivaP='AKM-' then @DebetRp else 0 end,
				   Case when @StatusAktivaP='AKM+' then @DebetRp else 0 end,
				   Case when @StatusAktivaP='AKM-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
				   Case when @StatusAktivaP='AKM+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end) 
				   --select 1
		  end
		  
		  
		  if @StatusAktivaL in('AKV-','AKM-','AKV+','AKM+')
		  begin
			Update TempdbAktivadet set DMD=DMD+Case when @StatusAktivaL='AKV+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   MD=MD+Case when @StatusAktivaL='AKV+' then @DebetRp else 0 end,
								   DSK=DSK+Case when @StatusAktivaL='AKM+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   SK=SK+Case when @StatusAktivaL='AKM+' then @DebetRp else 0 end,
		                           
								   DMK=DMK+Case when @StatusAktivaL='AKV-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   MK=MK+Case when @StatusAktivaL='AKV-' then @DebetRp else 0 end,
								   DSD=DSD+Case when @StatusAktivaL='AKM-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
								   SD=SD+Case when @StatusAktivaL='AKM-' then @DebetRp else 0 end
			where Devisi=@Devisi and Perkiraan=@noAktivaL and Bulan=@bulan and tahun=@Tahun
		  end
		  if not Exists (Select 'True' 
						 from TempdbAktivadet 
						 where Devisi=@Devisi and Perkiraan=@noAktivaL and Bulan=@bulan and tahun=@Tahun) and 
						 @NoAktivaL<>'' and @StatusAktivaL in('AKV-','AKM-','AKV+','AKM+')
		  begin
			insert into TempdbAktivadet (Perkiraan,Bulan,Tahun,Devisi,MD,MK,DMD,DMK,SD,SK,DSD,DSK)
			Values(@NoAktivaL,@Bulan,@Tahun,@Devisi,
				   Case when @StatusAktivaL='AKV+' then @DebetRp else 0 end,
				   Case when @StatusAktivaL='AKV-' then @DebetRp else 0 end,
				   Case when @StatusAktivaL='AKV+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
				   Case when @StatusAktivaL='AKV-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
				   Case when @StatusAktivaL='AKM-' then @DebetRp else 0 end,
				   Case when @StatusAktivaL='AKM+' then @DebetRp else 0 end,
				   Case when @StatusAktivaL='AKM-' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end,
				   Case when @StatusAktivaL='AKM+' then Case when @Valas<>'IDR' then @Debet else 0 end else 0 end)
				   --select 2
		  end		
 	        
 	insert into TempDBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
 		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
 		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NOINVOICE, KodeVls_, Kurs_,FlagSimbol)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NoInvoice, Valas_, Kurs_,FlagSimbol
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=case when @FlagSimbol='KB' Then @UrutKB else @Urut end and StatusUID in ('I','U')
	and FlagSimbol=@FlagSimbol
	if @@Error<>0 Goto JikaSalah
	

  end
  if @choice='U'
  begin
 	Update TempdbTransaksi set Tanggal=@Tanggal, Devisi=@Devisi, Note=@Note, 
 	                       Lampiran=@Lampiran, Perkiraan=@Perkiraan, Lawan=@Lawan, 
 	                       Keterangan=@Keterangan, Keterangan2=@Keterangan2, 
 	                       Debet=@Debet, Kredit=@Kredit, Valas=@Valas, 
 	                       Kurs=@Kurs, DebetRp=@DebetRp, KreditRp=@KreditRp, 
 	                       TipeTrans=@TipeTrans, TPHC=@TPHC, CustSuppP=@CustSuppP, 
 	                       CustSuppL=@CustSuppL, Urut=@Urut, NoAktivaP=@NoAktivaP, 
 	                       NoAktivaL=@NoAktivaL, StatusAktivaP=@StatusAktivaP, 
 	                       StatusAktivaL=@StatusAktivaL, Nobon=@Nobon, Kodebag=@KodeBag,
 	                       KodeP=@KodeP, KodeL=@KodeL, StatusGiro=@Statusgiro,FlagSimbol=@FlagSimbol,
 	                       KodeCost=@KodeCost, KodeSubCost=@KodeSubCost,ispasang=@IsPasang  
 	where nobukti=@nobukti  and urut=case when @FlagSimbol='KB' Then @UrutKB else @urut end
 	and FlagSimbol=@FlagSimbol
 	if @@Error<>0 Goto JikaSalah
 	
 	Update TempdbTransaksi set Keterangan=@Keterangan 
 	where nobukti=@nobukti  and urut=case when @FlagSimbol='KB' Then @UrutKB else @urut end
 	and @FlagSimbol=''
 	if @@Error<>0 Goto JikaSalah
 	
 	delete TempDBHUTPIUT
 	from TempDBHUTPIUT A
 	left outer join DBTempHUTPIUT B on B.NoFaktur=A.NoFaktur and B.KodeCustSupp=A.KodeCustSupp and B.Perkiraan=A.Perkiraan
 		and B.NoBukti=A.NoBukti and B.NoMsk=A.NoMsk and B.Urut=A.Urut
 	where	B.NoBukti=@Nobukti and B.NoMsk=@Urut and B.StatusUID in ('D','U')
 	and B.NoBukti is not null and B.FlagSimbol=@FlagSimbol
 	if @@Error<>0 Goto JikaSalah
 	
 	insert into TempDBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
 		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
 		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NOINVOICE, KodeVls_, Kurs_, FlagSimbol)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NoInvoice, Valas_, Kurs_, FlagSimbol
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=@Urut and StatusUID in ('I','U')
	and FlagSimbol=@FlagSimbol
	if @@Error<>0 Goto JikaSalah
  end
  if @choice='D'
  begin
 	delete TempdbTransaksi where nobukti=@nobukti and urut=@urut and (FlagSimbol=@FlagSimbol or @FlagSimbol='')
 	if @@Error<>0 Goto JikaSalah
 	delete TempDBHUTPIUT where NoBukti=@Nobukti and NoMsk=@Urut and (FlagSimbol=@FlagSimbol or @FlagSimbol='')
 	if @@Error<>0 Goto JikaSalah
 	if not exists( select nobukti from TempdbTransaksi where nobukti=@nobukti)
 	begin
  		delete TempdbTrans where nobukti=@nobukti
  		if @@Error<>0 Goto JikaSalah 
 	end
 	select * from TempDBAKTIVA where NoBuktiSem =@Nobukti 
  end
end*/
if @Jenis='T'
begin
  if @choice='I'
  begin
	Select @Urut=MAX(urut) from dbTransaksi where NoBukti=@Nobukti and FlagSimbol<>'KB'
	Set @Urut=ISNULL(@urut,0)+1  
	---
	Select @UrutKB=MAX(urut) from dbTransaksi where NoBukti=@Nobukti and FlagSimbol='KB'
	Set @UrutKB=ISNULL(@UrutKB,0)+1  
   	if not exists(select * from dbtrans Where NoBukti=@NoBukti) 
   	begin
     	  insert into dbTrans(NoBukti,NoUrut,tanggal,Note,Simbol, TipeTransHd, PerkiraanHd,Devisi)
     	  values (@NoBukti, @NoUrut, @tanggal,@Note,@Simbol,@TipeTrans,@PerkiraanHd,@Devisi)
     	  --if @@Error<>0 Goto JikaSalah
   	end
 	insert into dbtransaksi (NoBukti, Tanggal, Devisi, Note, Lampiran, Perkiraan, Lawan, 
 	                         Keterangan, Keterangan2, Debet, Kredit, Valas, Kurs, DebetRp, 
 	                         KreditRp, TipeTrans, TPHC, CustSuppP, CustSuppL, Urut, 
 	                         NoAktivaP, NoAktivaL, StatusAktivaP, StatusAktivaL, Nobon, 
 	                         KodeBag, KodeP, kodeL,StatusGiro,FlagSimbol,
 	                         KodeCost, KodeSubCost,ispasang,JnsTransInvestasi,Lot,Harga )
 	values (@NoBukti, @Tanggal, @Devisi, @Note, @Lampiran, @Perkiraan, @Lawan, 
 	        @Keterangan, @Keterangan2, @Debet, @Kredit, @Valas, @Kurs, @DebetRp, 
 	        @KreditRp, @TipeTrans, @TPHC, @CustSuppP, @CustSuppL, case when @FlagSimbol='KB' Then @UrutKB else @Urut end , @NoAktivaP, 
 	        @NoAktivaL, @StatusAktivaP, @StatusAktivaL, @Nobon, 
 	        @KodeBag, @KodeP, @kodeL,@Statusgiro,@FlagSimbol,
 	        @KodeCost, @KodeSubCost,@IsPasang,@JnsTransInvestasi,@Lot,@Harga )
 	--if @@Error<>0 Goto JikaSalah
 	        
 	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
 		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
 		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NOINVOICE, KodeVls_, Kurs_,FlagSimbol)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NoInvoice, Valas_, Kurs_,FlagSimbol
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=case when @FlagSimbol='KB' Then @UrutKB else @Urut end and StatusUID in ('I','U')
	and FlagSimbol=@FlagSimbol
	--if @@Error<>0 Goto JikaSalah
  end
  if @choice='U'
  begin
 	Update dbtransaksi set Tanggal=@Tanggal, Devisi=@Devisi, Note=@Note, 
 	                       Lampiran=@Lampiran, Perkiraan=@Perkiraan, Lawan=@Lawan, 
 	                       Keterangan=@Keterangan, Keterangan2=@Keterangan2, 
 	                       Debet=@Debet, Kredit=@Kredit, Valas=@Valas, 
 	                       Kurs=@Kurs, DebetRp=@DebetRp, KreditRp=@KreditRp, 
 	                       TipeTrans=@TipeTrans, TPHC=@TPHC, CustSuppP=@CustSuppP, 
 	                       CustSuppL=@CustSuppL, Urut=@Urut, NoAktivaP=@NoAktivaP, 
 	                       NoAktivaL=@NoAktivaL, StatusAktivaP=@StatusAktivaP, 
 	                       StatusAktivaL=@StatusAktivaL, Nobon=@Nobon, Kodebag=@KodeBag,
 	                       KodeP=@KodeP, KodeL=@KodeL, StatusGiro=@Statusgiro,FlagSimbol=@FlagSimbol,
 	                       KodeCost=@KodeCost, KodeSubCost=@KodeSubCost ,ispasang=@IsPasang,
 	                       JnsTransInvestasi=@JnsTransInvestasi,
 	                       Lot=@Lot ,Harga=@Harga  
 	where nobukti=@nobukti  and urut=case when @FlagSimbol='KB' Then @UrutKB else @urut end
 	and FlagSimbol=@FlagSimbol
 	if @@Error<>0 Goto JikaSalah
 	
 	Update dbtransaksi set Keterangan=@Keterangan 
 	where nobukti=@nobukti  and urut=case when @FlagSimbol='KB' Then @UrutKB else @urut end
 	and @FlagSimbol=''
 	if @@Error<>0 Goto JikaSalah
 	
 	delete DBHUTPIUT
 	from DBHUTPIUT A
 	left outer join DBTempHUTPIUT B on B.NoFaktur=A.NoFaktur and B.KodeCustSupp=A.KodeCustSupp and B.Perkiraan=A.Perkiraan
 		and B.NoBukti=A.NoBukti and B.NoMsk=A.NoMsk and B.Urut=A.Urut
 	where	B.NoBukti=@Nobukti and B.NoMsk=@Urut and B.StatusUID in ('D','U')
 	and B.NoBukti is not null and B.FlagSimbol=@FlagSimbol
 	if @@Error<>0 Goto JikaSalah
 	
 	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
 		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
 		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NOINVOICE, KodeVls_, Kurs_, FlagSimbol)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, 
		NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
		DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NoInvoice, Valas_, Kurs_, FlagSimbol
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=@Urut and StatusUID in ('I','U')
	and FlagSimbol=@FlagSimbol
	if @@Error<>0 Goto JikaSalah
  end
  if @choice='D'
  begin
	/*select @PerkiraanAktiva=Perkiraan  from DBAKTIVA where NoBuktiSem =@Nobukti 
	delete DBAKTIVA where NoBuktiSem =@Nobukti*/   
 	delete dbtransaksi where nobukti=@nobukti and urut=@urut and (FlagSimbol=@FlagSimbol or @FlagSimbol='')
 	if @@Error<>0 Goto JikaSalah
 	delete DBHUTPIUT where NoBukti=@Nobukti and NoMsk=@Urut and (FlagSimbol=@FlagSimbol or @FlagSimbol='')
 	if @@Error<>0 Goto JikaSalah
 	if not exists( select nobukti from dbtransaksi where nobukti=@nobukti)
 	begin
 	    /*select @xBuktiSem=NoBuktiSem from DBTRANS where NoBukti=@Nobukti
 	    update TempdbTrans set IsOtorisasi1=0,OtoUser1='',TglOto1=null,MaxOL=-1 where NoBukti=@xBuktiSem*/
  		delete dbTrans where nobukti=@nobukti
  		if @@Error<>0 Goto JikaSalah 
  		--@PerkiraanAktiva
 	end
  end
end

Commit Tran
Return
JikaSalah: RollBack Tran
           Return


------------------------------------------------------------------------------------------------------------------

--USE [TAS4]

GO

-- Procedure: sp_TransaksiMemorial
-- Created: 2014-07-15 10:51:45.487 | Modified: 2024-07-29 09:41:40.440
-- =====================================================


CREATE Procedure [dbo].[sp_TransaksiMemorial]
@Choice varchar(1),
@Nobukti Varchar(30),
@NoUrut Varchar(5),
@Tanggal datetime,
@Note Varchar(500),
@Lampiran TinyInt,
@Devisi varchar(20),
@Perkiraan varchar(25),
@Lawan Varchar(25),
@Keterangan Varchar(8000),
@Keterangan2 Varchar(8000),
@Debet numeric(18,2),
@Kredit Numeric(18,2),
@Valas Varchar(15),
@Kurs Numeric(18,2),
@DebetRp numeric(18,2),
@KreditRp Numeric(18,2),
@TipeTrans varchar(3),
@TPHC Varchar(1),
@CustSuppP varchar(15),
@CustSuppL Varchar(15),
@Urut Int,
@NoAktivaP varchar(30),
@NoAktivaL Varchar(30),
@StatusAktivaP varchar(5),
@StatusAktivaL Varchar(5),
@NoBon varchar(20),
@Kodebag varchar(15),
@KodeP varchar(15),
@KodeL varchar(15),
@Statusgiro varchar(2),
@Simbol varchar(10),
@DK varchar(10),
@Nomer int,
@KodeCost varchar(30)='',
@Ispasang tinyint =0,
@JnsTransInvestasi tinyint=0,
@Lot Numeric(18,2)=0,
@Harga Numeric(18,2)=0
AS
Begin Tran
if @choice='I'
begin
	Select @Urut=MAX(urut) from dbTransaksi where NoBukti=@Nobukti
	Set @Urut=ISNULL(@urut,0)+1  
   	if not exists(select * from dbtrans Where NoBukti=@NoBukti) 
   	begin
     	  insert into dbTrans(NoBukti,NoUrut,tanggal,Note,Simbol, TipeTransHd, Jenis,Devisi)
     	  values (@NoBukti, @NoUrut, @tanggal,@Note,@Simbol,@TipeTrans,0,@Devisi)
     	  if @@Error<>0 Goto JikaSalah
   	end
 	insert into dbtransaksi (NoBukti, Tanggal, Devisi, Note, Lampiran, Perkiraan, Lawan, 
 	                         Keterangan, Keterangan2, Debet, Kredit, Valas, Kurs, DebetRp, 
 	                         KreditRp, TipeTrans, TPHC, CustSuppP, CustSuppL, Urut, 
 	                         NoAktivaP, NoAktivaL, StatusAktivaP, StatusAktivaL, Nobon, 
 	                         KodeBag, KodeP, kodeL,StatusGiro,FlagSimbol,DK,Nomer,KodeCost,
 	                         ispasang,JnsTransInvestasi,Lot,Harga )
 	values (@NoBukti, @Tanggal, @Devisi, @Note, @Lampiran, @Perkiraan, @Lawan, 
 	        @Keterangan, @Keterangan2, @Debet, @Kredit, @Valas, @Kurs, @DebetRp, 
 	        @KreditRp, @TipeTrans, @TPHC, @CustSuppP, @CustSuppL, @Urut, @NoAktivaP, 
 	        @NoAktivaL, @StatusAktivaP, @StatusAktivaL, @Nobon, @KodeBag, @KodeP, @kodeL,@Statusgiro,'',
 	        @DK,@Nomer,@KodeCost,@Ispasang,@JnsTransInvestasi,@Lot,@Harga)
 	if @@Error<>0 Goto JikaSalah
 	        
 	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, NOPAJAK,
 	NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
 	DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NOINVOICE,
 	KodeVls_, Kurs_, KursBayar, FlagSimbol)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, '' NoPajak, 
	NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
	DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NoInvoice,
	Valas_, Kurs_, KursBayar, ''
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=@Urut and StatusUID in ('I','U')
	if @@Error<>0 Goto JikaSalah
end
if @choice='U'
begin
 	Update dbtransaksi set Tanggal=@Tanggal, Devisi=@Devisi, Note=@Note, 
 	                       Lampiran=@Lampiran, Perkiraan=@Perkiraan, Lawan=@Lawan, 
 	                       Keterangan=@Keterangan, Keterangan2=@Keterangan2, 
 	                       Debet=@Debet, Kredit=@Kredit, Valas=@Valas, 
 	                       Kurs=@Kurs, DebetRp=@DebetRp, KreditRp=@KreditRp, 
 	                       TipeTrans=@TipeTrans, TPHC=@TPHC, CustSuppP=@CustSuppP, 
 	                       CustSuppL=@CustSuppL, Urut=@Urut, NoAktivaP=@NoAktivaP, 
 	                       NoAktivaL=@NoAktivaL, StatusAktivaP=@StatusAktivaP, 
 	                       StatusAktivaL=@StatusAktivaL, Nobon=@Nobon, Kodebag=@KodeBag,
 	                       KodeP=@KodeP, KodeL=@KodeL, StatusGiro=@Statusgiro,
 	                       KodeCost =@KodeCost,ispasang=@Ispasang  
 	                       ,JnsTransInvestasi=@JnsTransInvestasi,
 	                       lot=@Lot,harga=@Harga
 	where nobukti=@nobukti  and urut=@urut
 	if @@Error<>0 Goto JikaSalah
 	delete DBHUTPIUT
 	from DBHUTPIUT A
 	left outer join DBTempHUTPIUT B on B.NoFaktur=A.NoFaktur and B.KodeCustSupp=A.KodeCustSupp and B.Perkiraan=A.Perkiraan
 		and B.NoBukti=A.NoBukti and B.NoMsk=A.NoMsk and B.Urut=A.Urut
 	where	B.NoBukti=@Nobukti and B.NoMsk=@Urut and B.StatusUID in ('D','U')
 	if @@Error<>0 Goto JikaSalah
 	insert into DBHUTPIUT (NoFaktur, NoRetur, TipeTrans, KodeCustSupp, NOPAJAK, 
 	NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
 	DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NOINVOICE,
 	KodeVls_, Kurs_, KursBayar, FlagSimbol)
	select NoFaktur, NoRetur, TipeTrans, KodeCustSupp, '' NoPajak,
	NoBukti, NoMsk, Urut, Tanggal, JatuhTempo, Debet, Kredit, Valas, Kurs, 
	DebetD, KreditD, KodeSales, Tipe, Perkiraan, Catatan, NoInvoice,
	Valas_, Kurs_, KursBayar, ''
	from DBTempHUTPIUT
	where NoBukti=@Nobukti and NoMsk=@Urut and StatusUID in ('I','U')
	if @@Error<>0 Goto JikaSalah
end
if @choice='D'
begin
 	delete dbtransaksi where nobukti=@nobukti and urut=@urut
 	if @@Error<>0 Goto JikaSalah
 	delete DBHUTPIUT where NoBukti=@Nobukti and NoMsk=@Urut
 	if @@Error<>0 Goto JikaSalah
 	if not exists( select nobukti from dbtransaksi where nobukti=@nobukti)
 	begin
  		delete dbTrans where nobukti=@nobukti
  		if @@Error<>0 Goto JikaSalah 
 	end
end

Commit Tran
Return
JikaSalah: RollBack Tran
           Return

GO

-- Procedure: SP_TRANSFER
-- Created: 2013-03-09 11:01:21.050 | Modified: 2013-03-09 11:01:21.050
-- =====================================================

CREATE Procedure [dbo].[SP_TRANSFER]
@Choice Varchar(1),
@Nobukti Varchar(20),
@NoUrut varchar(10),
@Tanggal Datetime,
@Note varchar(200),
@urut int,
@Kodebrg varchar(25),
@GdgAsal varchar(15),
@GdgTujuan varchar(15),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@QNt2 numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2),
@IDUSER varchar(15),
@NoPenyerahan varchar(100)
As
Begin tran
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBTRANSFERdet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1
  if not exists(select * from DBTRANSFER Where NoBukti=@NoBukti) 
  begin
    insert into DBTRANSFER (NOBUKTI, NOURUT, TANGGAL, NOTE, IDUSER, NoPenyerahan)
    values (@NOBUKTI,  @NOURUT, @TANGGAL, @NOTE, @IDUSER, @NoPenyerahan)
   			
  end
  insert into DBTRANSFERDET (NOBUKTI,URUT,KODEBRG,GdgAsal, GdgTujuan,Sat_1, Sat_2, QNT,QNT2, NOSAT, ISI)
  values(@NOBUKTI,@URUT,@KODEBRG,@GdgAsal, @GdgTujuan, @Sat_1, @Sat_2, @QNT, @QNT2, @NOSAT, @ISI)
end
if @choice='U'
begin
  update DBTRANSFERDET set Kodebrg=@KODEBRG,
                           Qnt=@QNT, QNT2=@QNT2, NOSAT=@NOSAT, ISI=@ISI,
                           GdgAsal=@GdgAsal, gdgTujuan= @GdgTujuan,sat_1= @Sat_1,Sat_2= @Sat_2 
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete DBTRANSFERDET where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from DBTRANSFERDET where nobukti=@nobukti)
  begin
    delete DBTRANSFER where nobukti=@nobukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return





GO

-- Procedure: SP_TRANSFERBRGJADI
-- Created: 2011-08-05 10:16:59.603 | Modified: 2011-08-05 10:32:44.610
-- =====================================================

CREATE Procedure [dbo].[SP_TRANSFERBRGJADI]
@Choice Varchar(1),
@Nobukti Varchar(20),
@NoUrut varchar(10),
@Tanggal Datetime,
@Note varchar(200),
@urut int,
@Kodebrg varchar(25),
@GdgAsal varchar(15),
@GdgTujuan varchar(15),
@Sat_1 varchar(5),
@Sat_2 varchar(5),
@Qnt numeric(18,2),
@QNt2 numeric(18,2),
@NoSat tinyint,
@Isi numeric(18,2)
As
Begin tran
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBTRANSFERBRGJADIdet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1
  if not exists(select * from DBTRANSFERBRGJADI Where NoBukti=@NoBukti) 
  begin
    insert into DBTRANSFERBRGJADI (NOBUKTI, NOURUT, TANGGAL, NOTE)
    values (@NOBUKTI,  @NOURUT, @TANGGAL, @NOTE)
   			
  end
  insert into DBTRANSFERBRGJADIDET (NOBUKTI,URUT,KODEBRG,GdgAsal, GdgTujuan,Sat_1, Sat_2, QNT,QNT2, NOSAT, ISI)
  values(@NOBUKTI,@URUT,@KODEBRG,@GdgAsal, @GdgTujuan, @Sat_1, @Sat_2, @QNT, @QNT2, @NOSAT, @ISI)
end
if @choice='U'
begin
  update DBTRANSFERBRGJADIDET set Kodebrg=@KODEBRG,
                           Qnt=@QNT, QNT2=@QNT2, NOSAT=@NOSAT, ISI=@ISI,
                           GdgAsal=@GdgAsal, gdgTujuan= @GdgTujuan,sat_1= @Sat_1,Sat_2= @Sat_2 
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete DBTRANSFERBRGJADIDET where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from DBTRANSFERBRGJADIDET where nobukti=@nobukti)
  begin
    delete DBTRANSFERBRGJADI where nobukti=@nobukti
  end
end
if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: sp_TransInvoiceBL
-- Created: 2014-11-19 10:49:14.017 | Modified: 2014-11-19 10:49:14.017
-- =====================================================

create Procedure [dbo].[sp_TransInvoiceBL]
@Choice varchar(1),
@NOBUKTI varchar (20),
@NOURUT varchar (10),
@TANGGAL datetime,
@KETERANGAN varchar (100),
@KodeSupp varchar (15),
@NoPO varchar (20),
@NoFaktur varchar (50),
@TglJatuhTempo datetime,
@KodeVls varchar (15),
@Kurs numeric (18,2),
@PPN tinyint,
@TipeBayar tinyint,
@Hari int,
@TipeDisc tinyint,
@DISC float,
@DISCRP numeric (18,2),
@IDUser varchar (30),
@KodeExp varchar (20),
@Flagtipe tinyint,
@TipePPN tinyint,
@URUT int,
@NoBeli varchar (20),
@KODEBRG varchar (25),
@KodeGdg varchar (15),
@QNT numeric (18,2),
@NOSAT tinyint,
@SATUAN varchar (5),
@SAT_1 varchar (5),
@SAT_2 varchar (5),
@ISI numeric (18,2),
@HARGA numeric (18,4),
@DISCP numeric (18,2),
@DISCTOT numeric (18,4),
@BYANGKUT numeric (18,2),
@UrutPO int,
@QntTerima numeric (18,2),
@Qnt1Terima numeric (18,2),
@Qnt2Terima numeric (18,2),
@UrutBeli int,
@KetReject varchar (1000),
@DiscP2 numeric (18,2),
@DiscP3 numeric (18,2),
@DiscP4 numeric (18,2),
@DiscP5 numeric (18,2),
@KetNamaBrg varchar (4000),
@TglInvoice DateTime,
@TglFakturPajak DateTime,
@TglBuktiPotong DateTime,
@NoInvoice varchar(50),
@NoFakturPajak Varchar(50),
@NoBuktiPotong Varchar

   
AS
begin Tran
if @Choice='I'
begin
  Select @Urut=Max(Urut) from dbInvoiceDet where NoBukti=@nobukti
  if @@error<>0  goto jikasalah
  Set @Urut=ISNULL(@urut,0)+1
  if not Exists(Select 'true' from dbInvoice where NoBukti=@nobukti)
  begin
	insert into DBInvoice (NOBUKTI, NOURUT, TANGGAL, KETERANGAN, KodeSupp, NoPO, NoFaktur, TglJatuhTempo, 
		KodeVls, Kurs, PPN, TipeBayar, Hari, TipeDisc, DISC, DISCRP, ISCETAK, NilaiCetak, IDUser, 
		IsBatal, UserBatal, KodeExp, cetakke, 
		Flagtipe, TipePPN,TglInvoice,TglFakturPajak,TglBuktiPotong,NoInvoice,NoFakturPajak,NoBuktiPotong)
	values (@NOBUKTI, @NOURUT, @TANGGAL, @KETERANGAN, @KodeSupp, @NoPO, @NoFaktur, @TglJatuhTempo, 
		@KodeVls, @Kurs, @PPN, @TipeBayar, @Hari, @TipeDisc, @DISC, @DISCRP, 0, 0, @IDUser, 
		0, '', @KodeExp, 0, @Flagtipe, @TipePPN,@TglInvoice,@TglFakturPajak,@TglBuktiPotong,@NoInvoice,@NoFakturPajak,
		@NoBuktiPotong)
    if @@error<>0  goto jikasalah
  end
  
  insert into DBInvoiceDET (NOBUKTI, URUT, NoBeli, KODEBRG, KodeGdg, 
		PPN, KURS, DISC, QNT, NOSAT, SATUAN, SAT_1, SAT_2, ISI, 
		HARGA, DISCP, DISCTOT, BYANGKUT, NoPO, UrutPO, 
		QntTerima, Qnt1Terima, Qnt2Terima, UrutBeli, 
		KetReject, DiscP2, DiscP3, DiscP4, DiscP5, NoSPJ, NamaBrg)
	values (@NOBUKTI, @URUT, @NoBeli, @KODEBRG, @KodeGdg, 
		@PPN, @KURS, @DISC, @QNT, @NOSAT, @SATUAN, @SAT_1, @SAT_2, @ISI, 
		@HARGA, @DISCP, @DISCTOT, @BYANGKUT, @NoPO, @UrutPO, 
		@QntTerima, @Qnt1Terima, @Qnt2Terima, @UrutBeli, 
		@KetReject, @DiscP2, @DiscP3, @DiscP4, @DiscP5, '', @KetNamaBrg)
          if @@error<>0  goto jikasalah                                      
end
else if @Choice='U'
begin
 update dbInvoiceDet set NoBeli=@NoBeli, KODEBRG=@KODEBRG, KodeGdg=@KodeGdg, 
 PPN=@PPN, KURS=@KURS, DISC=@DISC, QNT=@QNT, NOSAT=@NOSAT, SATUAN=@SATUAN, 
 SAT_1=@SAT_1, SAT_2=@SAT_2, ISI=@ISI, 
 HARGA=@HARGA, DISCP=@DISCP, DISCTOT=@DISCTOT, BYANGKUT=@BYANGKUT, NoPO=@NoPO, UrutPO=@UrutPO, 
 QntTerima=@QntTerima, Qnt1Terima=@Qnt1Terima, Qnt2Terima=@Qnt2Terima, 
 UrutBeli=@UrutBeli, KetReject=@KetReject, DiscP2=@DiscP2, DiscP3=@DiscP3, DiscP4=@DiscP4, DiscP5=@DiscP5, namaBrg=@KetNamaBrg
 where NoBukti=@nobukti and Urut=@Urut
 if @@error<>0  goto jikasalah
end
else if @Choice='D'
begin
  delete dbInvoiceDet where NoBukti=@nobukti and (Urut=@Urut or NoBeli=@NoBeli)
  if @@error<>0  goto jikasalah
  if not exists(select 'True' from dbInvoiceDet where NoBukti=@nobukti)
  begin
     delete dbInvoice where NoBukti=@nobukti 
     if @@error<>0  goto jikasalah
  end
end

Commit Tran
Return
JikaSalah: Rollback Tran
           Return












GO

-- Procedure: sp_TransInvoiceRPJ
-- Created: 2014-09-24 14:14:05.843 | Modified: 2014-09-24 14:14:05.843
-- =====================================================



CREATE Procedure [dbo].[sp_TransInvoiceRPJ]
@Choice varchar(1),
@Nobukti varchar(30),
@NoUrut varchar(5),
@Tanggal datetime,
@Kodecustsupp varchar(15),
@NoInvoice varchar(50),
@Disc float,
@Kodevls varchar(15),
@Kurs numeric(18,4),
@PPn tinyint,
@TipeBayar tinyint,
@Hari int,
@Iduser varchar(15),
@Urut int,
@kodebrg varchar(25),
@NoRPJ varchar(30),
@urutRPJ int,
@Sat_1 varchar(5),
@Qnt numeric(18,2),
@Qnt1 numeric(18,2),
@qnt2 numeric(18,2),
@Nosat tinyint,
@Isi numeric(18,2),
@Harga numeric(18,4),
@DiscP numeric(18,2),
@DiscRp numeric(18,4),
@DiscTot  numeric(18,4),
@Keterangan varchar(8000),
@Flagmenu tinyint,
@FlagTipe Tinyint,
@Discp2 NUmeric(18,2),
@Discp3 NUmeric(18,2),
@Discp4 NUmeric(18,2),
@Discp5 NUmeric(18,2),
@TipePPN tinyint,
@KodeSls int,
@Catatan varchar(4000)

as

begin Tran
if @Choice='I'
begin
  Select @urut=MAX(Urut) from DBINVOICERPJDet where NoBukti=@Nobukti
  if @@ERROR<>0 Goto JikaSalah
  Set @urut=ISNULL(@urut,0)+1
  if not Exists(Select 'True' From DBINVOICERPJ where NoBukti=@Nobukti) 
  begin
    insert into DBINVOICERPJ (NoBukti, NoUrut, Tanggal, TglJatuhTempo, KODECUSTSUPP, NoInvoice, NORPJ, KODEVLS, KURS, 
		Disc, PPN, TIPEBAYAR, HARI, IDUser, IsFLag,Flagtipe, TipePPN, KodeSls) 
    Values(@Nobukti, @NoUrut, @Tanggal, @Tanggal+@Hari, @Kodecustsupp, @NoInvoice, @NoRPJ,@KODEVLS, @Kurs, 
		@Disc, @PPn, @TipeBayar, @Hari, @Iduser, @Flagmenu,@FlagTipe, @TipePPN, @KodeSls) 
		if @@ERROR<>0 Goto JikaSalah 
  end
  Insert into DBINVOICERPJDet(NoBukti, Urut, Kodebrg, NOSPR, UrutSPR, 
		Disc, PPn, Kurs, SAT_1, Qnt, Qnt2, Nosat, Isi, Harga, 
		DiscP, DiscRp, DISCTOT, Keterangan,Discp2,Discp3,Discp4,Discp5)
  Values(@Nobukti, @Urut, @kodebrg, @NoRPJ, @urutRPJ, 
		@Disc, @PPn, @Kurs, @Sat_1, @Qnt, @qnt2, @Nosat, @Isi, @Harga, 
		@DiscP, @DiscRp, @DiscTot, @Keterangan,@Discp2,@Discp3,@Discp4,@Discp5)
	if @@ERROR<>0 Goto JikaSalah
end
else if @Choice='U'
begin
  update DBINVOICERPJDet set Kodebrg=@kodebrg, NOSPR=@NoRPJ, UrutSPR=@urutRPJ, Disc=0, PPn=@PPn, 
                             Kurs=@Kurs, SAT_1=@Sat_1, qnt=@qnt, Qnt2=@qnt2, Nosat=@Nosat, 
                             Isi=@Isi, Harga=@Harga, DiscP=@DiscP, DiscRp=@DiscRp, DISCTOT=@DiscTot, Keterangan=@Keterangan
                             ,Discp2=@Discp2,Discp3=@Discp3,Discp4=@Discp4,Discp5=@Discp5
  where NoBukti=@Nobukti and Urut=@urut
  if @@ERROR<>0 Goto JikaSalah

end
else if @Choice='D'
begin
  Delete DBINVOICERPJDet where NoBukti=@Nobukti and Urut=@urut
  if @@ERROR<>0 Goto JikaSalah
  if not Exists(Select 'True' From DBINVOICERPJDet where NoBukti=@Nobukti) 
  begin
     Delete DBINVOICERPJ where NoBukti=@Nobukti
     if @@ERROR<>0 Goto JikaSalah 
  end
end



Commit Tran
Return
JikaSalah: Rollback Tran
           Return







GO

-- Procedure: sp_TransSPBRJUAL
-- Created: 2014-09-24 11:20:58.197 | Modified: 2014-11-19 15:38:38.317
-- =====================================================

CREATE  Procedure [dbo].[sp_TransSPBRJUAL]
@Choice varchar(1),
@NOBUKTI varchar(30),
@NoUrut varchar(7),
@TANGGAL datetime,
@NoRPJ varchar(30),
@KODECUSTSUPP varchar(15),
@NoPolKend varchar(50),
@Container varchar(50),
@NoContainer varchar(50),
@NoSeal varchar (500),
@Catatan varchar(4000),
@URUT int,
@UrutRPJ int,
@KODEBRG varchar(25),
@QNT numeric(18,2),
@QNT1 numeric(18,2),
@QNT2 numeric(18,2),
@SAT_1 varchar(5),
@NoSat tinyint,
@ISI numeric(18,2),
@NetW numeric(18,2),
@GrossW numeric(18,2), 
@IDUser varchar(30),
@IsEmpty tinyint,
@Namabrg varchar(200),
@Sopir varchar(100),
@Flagmenu tinyint,
@kodegdg varchar(15),
@FlagTipe tinyint,
@TipePPN tinyint,
@NOSO varchar(30),
@NoBatch varchar(50)
As
Begin tran
   if @Choice='I'
   begin
  	   select @Urut=isnull(max(urut),0)+1 from dbSPBRJUALDet Where NoBukti=@NoBukti
  	   if @IsEmpty=0 
  	   begin
    	   insert into dbSPBRJUAL (NoBukti, NoUrut, Tanggal, NoRPJ, KodeCustSupp, NoPolKend, 
    		    Container, NoContainer, NoSeal,Catatan, IDUser, Sopir, IsFlag,Flagtipe, TipePPN, NoSO)
		   values (@NoBukti, @NoUrut, @Tanggal, @NoRPJ, @KodeCustSupp, @NoPolKend, 
    		    @Container, @NoContainer, @NoSeal, @Catatan, @IDUser, @Sopir, @Flagmenu,@FlagTipe, @TipePPn, @NOSO)
		   if @@error<>0  goto jikasalah
  	   end
     	
  	   insert into dbSPBRJUALDet (NoBukti, Urut, NoINV, UrutINV, KodeBrg, QNT, QNT1, QNT2, SAT_1, NOSAT, ISI, NetW, GrossW, Namabrg, KodeGdg,Nobatch)
	   values (@NoBukti, @Urut, @NoRPJ, @UrutRPJ, @KodeBrg,  @QNT, @QNT1, @QNT2, @SAT_1, @NOSAT, @ISI, @NetW, @GrossW, @Namabrg, @kodegdg,@NoBatch)
	   if @@error<>0  goto jikasalah
   end
   if @Choice='U'
   begin
  	   update dbSPBRJUALDET set KodeBrg=@KodeBrg, QNT=@QNT, QNT2=@QNT2, SAT_1=@SAT_1, NOSAT=@NOSAT, ISI=@ISI, Namabrg=@Namabrg,
  					   NetW=@NetW, GrossW=@GrossW, KodeGdg=@kodegdg
  	   where NoBukti=@NoBukti and Urut=@Urut
	   if @@error<>0  goto jikasalah
   end
   if @Choice='D'
   begin
  	   delete dbSPBRJUALDET where NoBukti=@NoBukti and Urut=@Urut 
	   if @@error<>0  goto jikasalah
  	   if not exists (select NoBukti from dbSPBRJUALDET where NoBukti=@NoBukti)
  	   begin
    	   delete dbSPBRJUAL where NoBukti=@NoBukti
             if @@error<>0  goto jikasalah
  	   end
   end

Commit tran
Return
JikaSalah: Rollback tran
           Return






GO

-- Procedure: Sp_Trucking
-- Created: 2011-08-19 08:47:46.997 | Modified: 2011-08-19 10:15:02.223
-- =====================================================


CREATE  Procedure [dbo].[Sp_Trucking]
@Choice varchar(1),
@NoBukti varchar (30),
@NoUrut varchar (7),
@Tanggal datetime,
@FaxNo_ varchar (100),
@To_ varchar (100),
@Attn_ varchar (100),
@CC_ varchar (100),
@NoInvoice varchar (30),
@Notes varchar (7500),
@Catatan varchar (7500),
@IDUser varchar (30),
@Urut int,
@NoSHIP varchar (30),
@StuffingDate datetime,
@Party20 numeric (18,2),
@Party40 numeric (18,2),
@Party40HC numeric (18,2),
@Vessel varchar (1000),
@BookingService varchar (1000),
@PoD varchar (1000),
@ClosingCargo Datetime,
@IsEmpty tinyint,
@Party20OT numeric (18,2),
@Party40OT numeric (18,2)
As
Begin tran
if @Choice='I'
begin
  	select @Urut=isnull(max(urut),0)+1 from dbTruckingDet Where NoBukti=@NoBukti
  	if @IsEmpty=0 
  	begin
  		insert into dbTrucking (NoBukti, NoUrut, Tanggal, FaxNo_, To_, Attn_, CC_, NoSHIP, Notes, Catatan, IDUser)
		values (@NoBukti, @NoUrut, @Tanggal, @FaxNo_, @To_, @Attn_, @CC_, @NoSHIP, @Notes, @Catatan, @IDUser)
		if @@error<>0  goto jikasalah
  	end
  	insert into dbTruckingDet (NoBukti, Urut, NoSHIP, StuffingDate, Party20, Party40, Party40HC, Vessel, BookingService, PoD, ClosingCargo,Party20OT,Party40OT)
	values (@NoBukti, @Urut, @NoSHIP, @StuffingDate, @Party20, @Party40, @Party40HC, @Vessel, @BookingService, @PoD, @ClosingCargo,@Party20OT,@Party40OT)
	if @@error<>0  goto jikasalah
end
if @Choice='U'
begin
  	update dbTruckingDet set NoSHIP=@NoSHIP, StuffingDate=@StuffingDate, Party20=@Party20, Party40=@Party40, 
  	Party40HC=@Party40HC, Vessel=@Vessel, BookingService=@BookingService, PoD=@PoD, ClosingCargo=@ClosingCargo,
  	Party20OT=@Party20OT, Party40OT=@Party40OT
  	where NoBukti=@NoBukti and Urut=@Urut
	if @@error<>0  goto jikasalah
end
if @Choice='D'
begin
  	delete dbTruckingDet where NoBukti=@NoBukti and Urut=@Urut 
	if @@error<>0  goto jikasalah
  	if not exists (select NoBukti from dbTruckingDet where NoBukti=@NoBukti)
  	begin
    	delete dbTrucking where NoBukti=@NoBukti
		if @@error<>0  goto jikasalah
  	end
end

Commit tran
Return
JikaSalah: Rollback tran
           Return


GO

-- Procedure: SP_UBAHKEMASAN
-- Created: 2014-04-21 13:52:27.180 | Modified: 2014-04-21 13:52:27.180
-- =====================================================
CREATE Procedure [dbo].[SP_UBAHKEMASAN]
@Choice Varchar(1),
@Nobukti Varchar(20),
@Tanggal Datetime,
@Note ntext,
@urut int,
@Kodebrg varchar(25),
@Kodegdg varchar(15),
@Satuan varchar(5),
@Nosat tinyint,
@Isi Numeric(18,2),
@QntDB numeric(18,2),
@QntCR numeric(18,2),
@Harga numeric(18,2),
@NoUrut varchar(7),
@FlagTipe int
As
Begin tran
if @choice='I'
begin
  select @urut=isnull(max(urut),0)+1 from DBUBAHKEMASANdet Where NoBukti=@NoBukti
  If @urut is null Set @urut=1
  if not exists(select * from DBUBAHKEMASAN Where NoBukti=@NoBukti) 
  begin
    insert into DBUBAHKEMASAN (NOBUKTI,Nourut,TANGGAL,NOTE, FlagTipe)
    values (@NOBUKTI,@Nourut, @TANGGAL,@NOTE, @FlagTipe)
   			
  end
  insert into DBUBAHKEMASANDET (NOBUKTI,URUT,KODEBRG,Kodegdg,SATUAN,NOSAT,ISI,QNTDB,QNTCR,HARGA)
  values(@NOBUKTI,@URUT,@KODEBRG,@Kodegdg,@SATUAN,@NOSAT,@ISI,@QNTDB,@QNTCR,@HARGA)
  --values('SJY/KMBJ/0413/0001',1,'AE2.B008','G001','ML',1,1,0,100,10)
end
if @choice='U'
begin
  update DBUBAHKEMASANDET set Kodebrg=@KODEBRG,Kodegdg=@Kodegdg,Satuan=@SATUAN,Nosat=@NOSAT,Isi=@ISI,QntDb=@QNTDB,QntCR=@QNTCR,Harga=@HARGA
  where nobukti=@nobukti and urut=@urut
end
if @choice='D'
begin
  delete DBUBAHKEMASANDET where nobukti=@nobukti and  urut=@urut 
  if not exists( select nobukti from DBUBAHKEMASANDET where nobukti=@nobukti)
  begin
    delete DBUBAHKEMASAN where nobukti=@nobukti
  end
end
--if @@error<>0  goto jikasalah
Commit tran
Return
JikaSalah: Rollback tran
           Return




GO

-- Procedure: Sp_UpdateBeli
-- Created: 2011-02-11 15:41:00.477 | Modified: 2013-05-13 12:47:26.373
-- =====================================================

CREATE Procedure [dbo].[Sp_UpdateBeli]
@NOBUKTI varchar(30)

As

ALTER TABLE dbBeliDet DISABLE TRIGGER All
update dbBeliDet set PPN=B.PPN, Disc=B.Disc, Kurs=B.Kurs, ByAngkut=0
from dbBeli B 
where  B.NoBukti=DBBELIDET.NoBukti and B.NoBukti=@NOBUKTI

ALTER TABLE dbBeliDet ENABLE TRIGGER All

GO

-- Procedure: sp_UpdateContractReview
-- Created: 2011-05-26 14:13:30.260 | Modified: 2011-10-18 15:01:43.673
-- =====================================================

CREATE Procedure [dbo].[sp_UpdateContractReview]
@nobukti varchar(30),
@Urut int,
@Sistem_Kemasan_isKarton bit,
@Sistem_Kemasan_isPalet bit,
@Sistem_Kemasan_isKarton_Palet bit,
@Sistem_Kemasan_isBungkus_Palet bit,
@Sistem_Kemasan_isBungkus bit,
@Sticker varchar(500),
@isi_Kemasan varchar(500),
@ketentuan_Berat_IsTeori Bit,
@ketentuan_Berat_IsTimbang Bit,
@Jenis_IsPlastik bit,
@Jenis_IsKarton bit,
@diameter_Inside_120mm bit,
@diameter_Inside_76mm bit,
@diameter_Inside_152mm bit,
@Tebal_15mm bit,
@Tebal_14mm_76mm bit,
@Tebal_14mm_152mm bit,
@Tebal_lain2 bit,
@Tebal_Lain varchar(50),
@Warna_YellowA bit,
@Warna_YellowB bit,
@Warna_Lain2 bit,
@Warna_Lain varchar(50),
@Arah_Putaran_WI Bit,
@Arah_Putaran_WO Bit,
@Jum_Sambungan varchar(50),
@Maks_D varchar(50),
@Spek_Lain varchar(8000),
@Jum_Ukuran_Cont  varchar(50),
@Jum_Kemasan  varchar(50),
@Ship_Mark varchar(50),
@note  varchar(8000)
As
begin tran
update dbContractReviewDet set Sistem_Kemasan_IsBungkus=@Sistem_Kemasan_isBungkus,
                               Sistem_Kemasan_IsBungkus_Palet=@Sistem_Kemasan_isBungkus_Palet,
                               Sistem_Kemasan_IsKarton=@Sistem_Kemasan_isKarton,
                               Sistem_Kemasan_IsKarton_Palet=@Sistem_Kemasan_isKarton_Palet,
                               Sistem_Kemasan_IsPalet=@Sistem_Kemasan_isPalet,
                               Isi_Kemasan=@isi_Kemasan,Sticker=@Sticker,
                               Ketentuan_Berat_IsTeori=@ketentuan_Berat_IsTeori,
                               Ketentuan_Berat_IsTimbang=@ketentuan_Berat_IsTimbang,
                               Jenis_isKarton=@Jenis_IsKarton,Jenis_isPlastik=@Jenis_IsPlastik,
                               Diameter_Inside_120mm=@diameter_Inside_120mm,
                               Diameter_Inside_152mm=@diameter_Inside_152mm,
                               Diameter_Inside_76mm=@diameter_Inside_76mm,
                               Tebal_14mm_152mm=@Tebal_14mm_152mm,
                               Tebal_14mm_76mm=@Tebal_14mm_76mm,
                               Tebal_15mm=@Tebal_15mm,
                               Tebal_lain2=@Tebal_lain2,Tebal_Lain=@Tebal_Lain,
                               Warna_Lain=@Warna_Lain,Warna_Lain2=@Warna_Lain2,
                               Warna_YellowA=@Warna_YellowA, Warna_YellowB=@Warna_YellowB,
                               Arah_Putaran_WI=@Arah_Putaran_WI,Arah_Putaran_WO=@Arah_Putaran_WO,
                               Jum_Sambungan=@Jum_Sambungan,Maks_D=@Maks_D,Spek_Lain=@Spek_Lain,
                               Jum_Ukuran_Cont=@Jum_Ukuran_Cont,Jum_Kemasan=@Jum_Kemasan,
                               Ship_Mark=@Ship_Mark,Note=@note                                
where NoEnq=@nobukti and UrutEnq=@Urut
--if @@ERROR<>0 Goto JikaSalah
commit tran
return
JikaSalah: Rollback Tran
           Return

GO

-- Procedure: Sp_UpdateInvoicePL
-- Created: 2013-01-26 09:01:23.167 | Modified: 2013-01-26 09:01:23.167
-- =====================================================

Create Procedure [dbo].[Sp_UpdateInvoicePL]
@NOBUKTI varchar(30)

As

ALTER TABLE dbinvoicePLDet DISABLE TRIGGER All

update dbInvoicePLDet set PPN=B.PPN, Disc=B.Disc, Kurs=B.Kurs
from	dbInvoicePLDet A
left outer join dbInvoicePL B on B.NoBukti=A.NoBukti
left outer join
	(
	Select 	X.NoBukti, Y.Urut, Y.KodeBrg,
		case when isnull(Z.TotSubTotal,0)=0 then 0 else round((Y.SubTotal)/Z.TotSubTotal,2) end Beban
	From dbInvoicePL X
	Left Outer join dbInvoicePLDet Y on Y.NoBukti=X.NoBukti
	Left Outer Join vwRpDetInvoicePL Z on Z.NoBukti=X.NoBukti
	where	X.NoBukti=@NoBukti
	) C on C.NoBukti=A.NoBukti and C.Urut=A.Urut
where A.NoBukti=@NOBUKTI

ALTER TABLE dbInvoicePLDet ENABLE TRIGGER All

GO

-- Procedure: Sp_UpdateIsi2Brg
-- Created: 2011-06-15 09:14:58.910 | Modified: 2011-06-16 14:47:51.900
-- =====================================================

CREATE Procedure [dbo].[Sp_UpdateIsi2Brg]
@Kodebrg varchar(25),
@Qnt numeric(18,2),
@Qnt2 numeric(18,2)
as
begin tran
update DBBARANG set Isi2=isnull(@Qnt,0)/Case when isnull(@Qnt2,0)<>0 then @Qnt2 else 1 end
where KODEBRG=@Kodebrg and konversi=1
commit tran
Return
JikaSalah: Rollback Tran
           Return         

GO

-- Procedure: sp_updateMenu
-- Created: 2010-12-10 15:05:13.630 | Modified: 2011-11-22 13:47:41.750
-- =====================================================

CREATE PROCEDURE [dbo].[sp_updateMenu] 
@userid varchar(10)
AS
	insert into dbflmenu(userid,L1,HASACCESS,isTambah,isHapus,iskoreksi,IsCetak,isExport,TIPE)
	select @userid,L1,0,0,0,0,0,0,TIPE
	from dbflmenu
	where userid='SA' and l1 not in (select l1 from dbflmenu where userid=@userid)


GO

-- Procedure: sp_updateMenuReport
-- Created: 2010-12-10 15:07:52.227 | Modified: 2011-11-22 13:47:18.627
-- =====================================================

CREATE PROCEDURE [dbo].[sp_updateMenuReport] 
@userid varchar(10)
AS
	insert into dbflmenureport (userid,L1,Access)
	select @userid,L1,0
	from dbflmenureport
	where userid='SA' and l1 not in (select l1 from dbflmenureport where userid=@userid)


GO

-- Procedure: sp_UpdateNilaiBeli
-- Created: 2011-03-23 13:30:53.613 | Modified: 2011-03-23 13:30:53.613
-- =====================================================



CREATE Procedure [dbo].[sp_UpdateNilaiBeli]
@NoBukti varchar(30)
as
update DBBELI 
set		NILAIPOT=B.TotDiskon, NILAIDPP=B.TotDPP, NILAIPPN=B.TotPPN, NILAINET=B.TotNet,
		NILAIPOTRp=B.TotDiskonRp, NILAIDPPRp=B.TotDPPRp, NILAIPPNRp=B.TotPPNRp, NILAINETRp=B.TotNetRp
from DBBELI A
left outer join vwRpDetBeli B on B.NoBukti=A.NOBUKTI
where A.NOBUKTI=@NoBukti



GO

-- Procedure: Sp_UpdatePO
-- Created: 2013-02-22 13:02:09.980 | Modified: 2013-02-22 13:02:13.350
-- =====================================================

CREATE Procedure [dbo].[Sp_UpdatePO]
@NOBUKTI varchar(20)

As

ALTER TABLE DBPODet DISABLE TRIGGER All

update DBPODet set PPN=B.PPN, Disc=B.Disc, Kurs=B.Kurs, BYANGKUT=isnull(C.Beban,0)
from	DBPODet A
left outer join DBPO B on B.NoBukti=A.NoBukti
left outer join
	(
	Select 	X.NoBukti, Y.Urut, Y.KodeBrg,
		case when isnull(Z.TotSubTotal,0)=0 then 0 else round((Y.SubTotal*X.Handling)/Z.TotSubTotal,2) end Beban
	From DBPO X
	Left Outer join DBPODet Y on Y.NoBukti=X.NoBukti
	Left Outer Join vwRpDetSO Z on Z.NoBukti=X.NoBukti
	where	X.NoBukti=@NoBukti
	) C on C.NoBukti=A.NoBukti and C.Urut=A.Urut
where A.NoBukti=@NOBUKTI

-- agar total biaya angkut di detail sama dengan di header
declare @UrutMax int, @TotByANgkut numeric(18,2), @TotByAngkut_ numeric(18,2)
select @UrutMax=max(Urut) from DBPODet where NoBukti=@NoBukti

select @TotByAngkut=isnull((select Handling from DBPO where NoBukti=@NoBukti),0)
select @TotByAngkut_=isnull((select sum(BYANGKUT) from DBPODet where NoBukti=@NoBukti and Urut<>@UrutMax),0)

if @TotByAngkut<>0
begin
	update DBPODet set BYAngkut=@TotByAngkut-@TotByAngkut_ where NoBukti=@NoBukti and Urut=@UrutMax
end




ALTER TABLE DBPODet ENABLE TRIGGER All

GO

-- Procedure: Sp_UpdateRBeli
-- Created: 2013-02-25 14:19:55.327 | Modified: 2013-02-25 14:19:55.327
-- =====================================================


CREATE Procedure [dbo].[Sp_UpdateRBeli]
@NOBUKTI varchar(30)

As

ALTER TABLE dbRBeliDet DISABLE TRIGGER All

update dbRBeliDet set PPN=B.PPN, Disc=B.Disc, Kurs=B.Kurs, ByAngkut=isnull(C.Beban,0)
from	dbRBeliDet A
left outer join dbRBeli B on B.NoBukti=A.NoBukti
left outer join
	(
	Select 	X.NoBukti, Y.Urut, Y.KodeBrg,
		0.00 Beban
	From dbRBeli X
	Left Outer join dbRBeliDet Y on Y.NoBukti=X.NoBukti
	Left Outer Join vwRpDetRBeli Z on Z.NoBukti=X.NoBukti
	where	X.NoBukti=@NoBukti
	) C on C.NoBukti=A.NoBukti and C.Urut=A.Urut
where A.NoBukti=@NOBUKTI

ALTER TABLE dbRBeliDet ENABLE TRIGGER All


GO

-- Procedure: Sp_UpdateSO
-- Created: 2012-12-20 15:08:33.250 | Modified: 2012-12-20 15:08:33.250
-- =====================================================
Create Procedure [dbo].[Sp_UpdateSO]
@NOBUKTI varchar(20)

As

ALTER TABLE dbSODet DISABLE TRIGGER All

update dbSODet set PPN=B.PPN, Disc=B.Disc, Kurs=B.Kurs, BYANGKUT=isnull(C.Beban,0)
from	dbSODet A
left outer join dbSO B on B.NoBukti=A.NoBukti
left outer join
	(
	Select 	X.NoBukti, Y.Urut, Y.KodeBrg,
		case when isnull(Z.TotSubTotal,0)=0 then 0 else round((Y.SubTotal*X.Handling)/Z.TotSubTotal,2) end Beban
	From dbSO X
	Left Outer join dbSODet Y on Y.NoBukti=X.NoBukti
	Left Outer Join vwRpDetSO Z on Z.NoBukti=X.NoBukti
	where	X.NoBukti=@NoBukti
	) C on C.NoBukti=A.NoBukti and C.Urut=A.Urut
where A.NoBukti=@NOBUKTI

-- agar total biaya angkut di detail sama dengan di header
declare @UrutMax int, @TotByANgkut numeric(18,2), @TotByAngkut_ numeric(18,2)
select @UrutMax=max(Urut) from dbSODet where NoBukti=@NoBukti

select @TotByAngkut=isnull((select Handling from dbSO where NoBukti=@NoBukti),0)
select @TotByAngkut_=isnull((select sum(BYANGKUT) from dbSODet where NoBukti=@NoBukti and Urut<>@UrutMax),0)

if @TotByAngkut<>0
begin
	update dbSODet set BYAngkut=@TotByAngkut-@TotByAngkut_ where NoBukti=@NoBukti and Urut=@UrutMax
end




ALTER TABLE dbSODet ENABLE TRIGGER All
GO

-- Procedure: sp_upgraddiagrams
-- Created: 2010-12-03 09:27:10.697 | Modified: 2010-12-03 09:27:10.697
-- =====================================================

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END
	
GO

-- Procedure: SP_VALAS
-- Created: 2010-12-13 11:27:10.753 | Modified: 2010-12-13 11:27:10.753
-- =====================================================

CREATE PROCEDURE [dbo].[SP_VALAS]
@Choice char(1),
@KodeVls Varchar(15)=null,
@NamaVls Varchar(40)=Null,
@Kurs Numeric(18,2)=null,
@Simbol varchar(5),
@OldKode varchar(15)=null
AS
begin tran
if @choice='I'
begin
  insert into dbValas (KodeVls, NamaVls, Kurs, Simbol )
  values (@KodeVls, @NamaVls, @Kurs, @Simbol)
end
if @choice='U'
begin
  update dbValas set kodeVls=@kodeVls, NamaVls=@NamaVls, Kurs=@Kurs, Simbol=@Simbol
  where KodeVls=@OldKode
end
if @choice='D'
begin
  delete dbValas where (KodeVls=@OldKode and KodeVls<>'IDR')	
end
if @@error <> 0 goto jikasalah
commit tran
return
jikasalah:
	rollback tran
	raiserror('Proses Input Data Gagal',16,1)
	return

GO

-- Procedure: sp_ViewReportBukuTambahan
-- Created: 2011-03-24 15:30:25.970 | Modified: 2011-06-21 13:47:23.050
-- =====================================================
CREATE PROCEDURE [dbo].[sp_ViewReportBukuTambahan]
@awal varchar(25),
@akhir varchar(25),
@tglawal datetime,
@tglakhir datetime,
@devisi varchar(15),
@IdUser varchar(15)
AS
declare @mtgl datetime
select @mtgl=cast(month(@tglawal) as varchar(2))+'/01/'+cast(year(@tglawal) as varchar(4))
Set @Devisi=case when @devisi in ('-','') then '%' else @Devisi end

 select b.keterangan as Nama, a.noAcc as perkiraan, '' as transaksi, '' as namaacc, 
 max(tanggal)as tanggal, ' Saldo Awal' as NoBukti, '' as keterangan,
           ''as lawan, 0 as saldoawal, 0 as debet, 0 as kredit,
 sum((case when a.transaksi='D' then Debet-kredit
           when a.transaksi='K' then Kredit-Debet 
           else Saldoawal end)) as saldoakhir, max(a.urut) as urut,
 0 as debetd, 0 as kreditd,
 sum((case when a.transaksi='D' then Debetd-kreditd
           when a.transaksi='K' then KreditD-Debetd 
           else Saldoawald end)) as saldoakhird, '' NoUrut
from dbtempbkbesar a,dbperkiraan b
where a.noacc=b.perkiraan and a.noacc>=@awal and a.noacc<=@akhir and tanggal<@tglawal and bulan=month(@tglawal) and
           tahun=year(@tglawal) and (a.devisi Like @devisi)
	and a.noacc in (select perkiraan from dbAksesPerkiraan where userid=@IdUser) 
group by a.noacc,b.keterangan
union
select b.keterangan as Nama, a.noacc as perkiraan, a.transaksi, b.keterangan as namaacc, a.tanggal, a.nobukti, 
a.keterangan,
  (case when a.perkiraan=a.NoACC then a.Lawan
		       when a.lawan=a.NoACC then a.Perkiraan
		  end) lawan, a.saldoawal,
          a.debet, a.kredit,
 (case when a.transaksi='D' then Debet-kredit
       when a.transaksi='K' then kredit-Debet 
       else Saldoawal end) as saldoakhir,a.urut,
          a.debetd, a.kreditd,
 (case when a.transaksi='D' then Debetd-kreditd
       when a.transaksi='K' then kreditD-Debetd 
       else Saldoawald end) as saldoakhird, substring(a.NoBukti,10,5) NoUrut
from dbtempbkbesar a,dbPerkiraan b
where a.noacc=b.perkiraan and a.noacc>=@awal and a.noacc<=@akhir and a.tanggal>=@tglawal and tanggal<=@tglakhir  and (a.devisi Like @devisi)
	and a.noacc in (select perkiraan from dbAksesPerkiraan where userid=@IdUser) 
order by a.noacc,a.tanggal,NoUrut,a.nobukti,a.urut



GO

-- Procedure: sp_vwCustJT
-- Created: 2013-03-09 10:58:57.400 | Modified: 2013-03-09 10:58:57.400
-- =====================================================
CREATE PROCEDURE [dbo].[sp_vwCustJT]
@KodeCustSupp char(15)='',
@urut TinyInt
AS
Begin
if @urut>1 
Begin
select NoFaktur,Urut from(
select 0 Urut,a.NoFaktur from vwHutPiutBelumlunas a
Left Outer Join vwHutPiut b on a.KodeCustSupp=b.KodeCustSupp and a.NoFaktur=b.NoFaktur
where (b.Tanggal Between GETDATE()-365 and (GETDATE())or b.JatuhTempo<GETDATE() )and a.KodeCustSupp=@KodeCustSupp
Group by a.NoFaktur
HAVING (SUM(Case when b.Tipe='PT' then Debet-Kredit
            else 0
            end)<> 0)
Union all
Select 1 Urut,b.NoFaktur from vwHutPiut a 
Left Outer Join (select NoFaktur,KodeCustSupp from vwHutPiut where TipeTrans='L' and Tipe='PT' and Tanggal>JatuhTempo)b On a.NoFaktur=b.NoFaktur  
where Tanggal Between GETDATE()-365 and (GETDATE()) and b.KodeCustSupp=@KodeCustSupp
Group by b.NoFaktur 
HAVING (SUM(Case when Tipe='PT' then Debet-Kredit
            else 0
            end) = 0)
Union all
Select '1'Urut,b.NoFaktur from vwHutPiut a 
Left Outer Join (select NoFaktur,KodeCustSupp from vwHutPiut where TipeTrans='L' and Tipe='PT' and Tanggal<=JatuhTempo)b On a.NoFaktur=b.NoFaktur  
where Tanggal Between GETDATE()-365 and (GETDATE()) and b.KodeCustSupp=@KodeCustSupp
Group by b.NoFaktur
HAVING (SUM(Case when Tipe='PT' then Debet-Kredit
            else 0
            end) = 0))a
group by NoFaktur,Urut
       
order by Urut,NoFaktur 

end
else
Begin
select NoFaktur,Urut from(
select 0 Urut,a.NoFaktur from vwHutPiutBelumlunas a
Left Outer Join vwHutPiut b on a.KodeCustSupp=b.KodeCustSupp and a.NoFaktur=b.NoFaktur
where (b.Tanggal Between GETDATE()-365 and (GETDATE())or b.JatuhTempo<GETDATE() )and a.KodeCustSupp=@KodeCustSupp
Group by a.NoFaktur
HAVING (SUM(Case when b.Tipe='PT' then Debet-Kredit
            else 0
            end)<> 0)
Union all
Select 1 Urut,b.NoFaktur from vwHutPiut a 
Left Outer Join (select NoFaktur,KodeCustSupp from vwHutPiut where TipeTrans='L' and Tipe='PT' and Tanggal>JatuhTempo)b On a.NoFaktur=b.NoFaktur  
where Tanggal Between GETDATE()-365 and (GETDATE()) and b.KodeCustSupp=@KodeCustSupp
Group by b.NoFaktur 
HAVING (SUM(Case when Tipe='PT' then Debet-Kredit
            else 0
            end) = 0)
Union all
Select '1'Urut,b.NoFaktur from vwHutPiut a 
Left Outer Join (select NoFaktur,KodeCustSupp from vwHutPiut where TipeTrans='L' and Tipe='PT' and Tanggal<=JatuhTempo)b On a.NoFaktur=b.NoFaktur  
where Tanggal Between GETDATE()-365 and (GETDATE()) and b.KodeCustSupp=@KodeCustSupp
Group by b.NoFaktur
HAVING (SUM(Case when Tipe='PT' then Debet-Kredit
            else 0
            end) = 0))a
where Urut=@urut   
group by NoFaktur,Urut
       
order by Urut,NoFaktur 
end    
end



GO

-- Procedure: sp_vwPiutangJT
-- Created: 2013-03-11 08:00:22.677 | Modified: 2015-03-09 14:57:03.230
-- =====================================================


CREATE PROCEDURE [dbo].[sp_vwPiutangJT] 
@KodeCustSupp varchar(15)
As
Begin
Select NoFaktur,(sum(Debet)-sum(Kredit)) as Sisa,JatuhTempo 
from [DBHUTPIUT]  
where KodeCustSupp=@KodeCustSupp and JatuhTempo<=getdate()
Group by NoFaktur,JatuhTempo 
Having (sum(Debet)-sum(Kredit))<>0
end




GO

-- Procedure: sp_vwPlafon
-- Created: 2013-03-09 11:00:33.700 | Modified: 2013-03-09 11:00:33.700
-- =====================================================



CREATE PROCEDURE [dbo].[sp_vwPlafon] 
@KodeCustSupp varchar(15)
As
Begin
select 	PLAFON from DBCUSTSUPP where  KodeCustSupp =@KodeCustSupp 
end





GO

-- Procedure: sp_vwSisaPiutang
-- Created: 2013-03-09 10:59:58.653 | Modified: 2013-03-09 10:59:58.653
-- =====================================================
CREATE PROCEDURE [dbo].[sp_vwSisaPiutang] 
@tanggal datetime,
@KodeCustSupp varchar(15)
As
Begin
select 	b.PLAFON,b.PLAFON-(sum(a.Debet)-sum(a.Kredit)) as sisaP,sum(a.Debet)-sum(a.Kredit) as sisa,
		sum(a.DebetD)-sum(a.KreditD) as sisaD  
 	from vwHutpiut a
 	left outer join DBCUSTSUPP b on(a.KodeCustSupp=b.KodeCustSupp)
 	where  a.tanggal<=@tanggal	and a.KodeCustSupp =@KodeCustSupp 
 	Group By b.PLAFON	
 	HAVING (SUM(Case when a.Tipe='PT' then Debet-Kredit
            else 0
            end)<> 0)
end







GO

